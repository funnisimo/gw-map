!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("gw-utils")):"function"==typeof define&&define.amd?define(["exports","gw-utils"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).GWM={},t.GWU)}(this,(function(t,e){"use strict";function i(t){if(t&&t.__esModule)return t;var e=Object.create(null);return t&&Object.keys(t).forEach((function(i){if("default"!==i){var s=Object.getOwnPropertyDescriptor(t,i);Object.defineProperty(e,i,s.get?s:{enumerable:!0,get:function(){return t[i]}})}})),e.default=t,e}var s,r=i(e);!function(t){t[t.ALL_LAYERS=-1]="ALL_LAYERS",t[t.GROUND=0]="GROUND",t[t.SURFACE=1]="SURFACE",t[t.ITEM=2]="ITEM",t[t.ACTOR=3]="ACTOR",t[t.LIQUID=4]="LIQUID",t[t.GAS=5]="GAS",t[t.FX=6]="FX",t[t.UI=7]="UI"}(s||(s={}));const l=r.flag.fl;var a;!function(t){t[t.L_DESTROYED=l(1)]="L_DESTROYED",t[t.L_SECRETLY_PASSABLE=l(2)]="L_SECRETLY_PASSABLE",t[t.L_BLOCKS_MOVE=l(3)]="L_BLOCKS_MOVE",t[t.L_BLOCKS_VISION=l(4)]="L_BLOCKS_VISION",t[t.L_BLOCKS_SURFACE=l(6)]="L_BLOCKS_SURFACE",t[t.L_BLOCKS_LIQUID=l(8)]="L_BLOCKS_LIQUID",t[t.L_BLOCKS_GAS=l(7)]="L_BLOCKS_GAS",t[t.L_BLOCKS_ITEMS=l(5)]="L_BLOCKS_ITEMS",t[t.L_BLOCKS_ACTORS=l(11)]="L_BLOCKS_ACTORS",t[t.L_BLOCKS_EFFECTS=l(9)]="L_BLOCKS_EFFECTS",t[t.L_BLOCKS_DIAGONAL=l(10)]="L_BLOCKS_DIAGONAL",t[t.L_INTERRUPT_WHEN_SEEN=l(12)]="L_INTERRUPT_WHEN_SEEN",t[t.L_LIST_IN_SIDEBAR=l(13)]="L_LIST_IN_SIDEBAR",t[t.L_VISUALLY_DISTINCT=l(14)]="L_VISUALLY_DISTINCT",t[t.L_BRIGHT_MEMORY=l(15)]="L_BRIGHT_MEMORY",t[t.L_INVERT_WHEN_HIGHLIGHTED=l(16)]="L_INVERT_WHEN_HIGHLIGHTED",t[t.L_BLOCKED_BY_STAIRS=t.L_BLOCKS_ITEMS|t.L_BLOCKS_SURFACE|t.L_BLOCKS_GAS|t.L_BLOCKS_LIQUID|t.L_BLOCKS_EFFECTS|t.L_BLOCKS_ACTORS]="L_BLOCKED_BY_STAIRS",t[t.L_BLOCKS_SCENT=t.L_BLOCKS_MOVE|t.L_BLOCKS_VISION]="L_BLOCKS_SCENT",t[t.L_DIVIDES_LEVEL=t.L_BLOCKS_MOVE]="L_DIVIDES_LEVEL",t[t.L_WAYPOINT_BLOCKER=t.L_BLOCKS_MOVE]="L_WAYPOINT_BLOCKER",t[t.L_WALL_FLAGS=t.L_BLOCKS_MOVE|t.L_BLOCKS_VISION|t.L_BLOCKS_LIQUID|t.L_BLOCKS_GAS|t.L_BLOCKS_EFFECTS|t.L_BLOCKS_DIAGONAL]="L_WALL_FLAGS",t[t.L_BLOCKS_EVERYTHING=t.L_WALL_FLAGS|t.L_BLOCKS_ITEMS|t.L_BLOCKS_ACTORS|t.L_BLOCKS_SURFACE]="L_BLOCKS_EVERYTHING"}(a||(a={}));const n=r.flag.fl;var h,c;!function(t){t[t.IS_PLAYER=n(0)]="IS_PLAYER"}(h||(h={})),c||(c={});const o=r.flag.fl;var _;!function(t){t[t.T_BRIDGE=o(0)]="T_BRIDGE",t[t.T_AUTO_DESCENT=o(1)]="T_AUTO_DESCENT",t[t.T_LAVA=o(2)]="T_LAVA",t[t.T_DEEP_WATER=o(3)]="T_DEEP_WATER",t[t.T_IS_FLAMMABLE=o(5)]="T_IS_FLAMMABLE",t[t.T_SPONTANEOUSLY_IGNITES=o(6)]="T_SPONTANEOUSLY_IGNITES",t[t.T_IS_FIRE=o(7)]="T_IS_FIRE",t[t.T_EXTINGUISHES_FIRE=o(8)]="T_EXTINGUISHES_FIRE",t[t.T_IS_SECRET=o(9)]="T_IS_SECRET",t[t.T_IS_TRAP=o(10)]="T_IS_TRAP",t[t.T_SACRED=o(11)]="T_SACRED",t[t.T_UP_STAIRS=o(12)]="T_UP_STAIRS",t[t.T_DOWN_STAIRS=o(13)]="T_DOWN_STAIRS",t[t.T_PORTAL=o(14)]="T_PORTAL",t[t.T_IS_DOOR=o(15)]="T_IS_DOOR",t[t.T_ALLOWS_SUBMERGING=o(16)]="T_ALLOWS_SUBMERGING",t[t.T_ENTANGLES=o(17)]="T_ENTANGLES",t[t.T_REFLECTS=o(18)]="T_REFLECTS",t[t.T_STAND_IN_TILE=o(19)]="T_STAND_IN_TILE",t[t.T_CONNECTS_LEVEL=o(20)]="T_CONNECTS_LEVEL",t[t.T_BLOCKS_OTHER_LAYERS=o(21)]="T_BLOCKS_OTHER_LAYERS",t[t.T_HAS_STAIRS=t.T_UP_STAIRS|t.T_DOWN_STAIRS|t.T_PORTAL]="T_HAS_STAIRS",t[t.T_OBSTRUCTS_SCENT=t.T_AUTO_DESCENT|t.T_LAVA|t.T_DEEP_WATER|t.T_SPONTANEOUSLY_IGNITES|t.T_HAS_STAIRS]="T_OBSTRUCTS_SCENT",t[t.T_PATHING_BLOCKER=t.T_AUTO_DESCENT|t.T_IS_TRAP|t.T_LAVA|t.T_DEEP_WATER|t.T_IS_FIRE|t.T_SPONTANEOUSLY_IGNITES|t.T_ENTANGLES]="T_PATHING_BLOCKER",t[t.T_LAKE_PATHING_BLOCKER=t.T_AUTO_DESCENT|t.T_LAVA|t.T_DEEP_WATER|t.T_SPONTANEOUSLY_IGNITES]="T_LAKE_PATHING_BLOCKER",t[t.T_WAYPOINT_BLOCKER=t.T_AUTO_DESCENT|t.T_IS_TRAP|t.T_LAVA|t.T_DEEP_WATER|t.T_SPONTANEOUSLY_IGNITES]="T_WAYPOINT_BLOCKER",t[t.T_DIVIDES_LEVEL=t.T_AUTO_DESCENT|t.T_IS_TRAP|t.T_LAVA|t.T_DEEP_WATER]="T_DIVIDES_LEVEL",t[t.T_MOVES_ITEMS=t.T_DEEP_WATER|t.T_LAVA]="T_MOVES_ITEMS",t[t.T_CAN_BE_BRIDGED=t.T_AUTO_DESCENT|t.T_LAVA|t.T_DEEP_WATER]="T_CAN_BE_BRIDGED",t[t.T_IS_DEEP_LIQUID=t.T_LAVA|t.T_AUTO_DESCENT|t.T_DEEP_WATER]="T_IS_DEEP_LIQUID"}(_||(_={}));const E=r.flag.fl;var f;!function(t){t[t.TM_IS_WIRED=E(9)]="TM_IS_WIRED",t[t.TM_IS_CIRCUIT_BREAKER=E(10)]="TM_IS_CIRCUIT_BREAKER",t[t.TM_VANISHES_UPON_PROMOTION=E(15)]="TM_VANISHES_UPON_PROMOTION",t[t.TM_EXPLOSIVE_PROMOTE=E(21)]="TM_EXPLOSIVE_PROMOTE",t[t.TM_SWAP_ENCHANTS_ACTIVATION=E(25)]="TM_SWAP_ENCHANTS_ACTIVATION"}(f||(f={}));const u=r.flag.fl;var T;!function(t){t[t.SEARCHED_FROM_HERE=u(0)]="SEARCHED_FROM_HERE",t[t.PRESSURE_PLATE_DEPRESSED=u(1)]="PRESSURE_PLATE_DEPRESSED",t[t.KNOWN_TO_BE_TRAP_FREE=u(2)]="KNOWN_TO_BE_TRAP_FREE",t[t.CAUGHT_FIRE_THIS_TURN=u(3)]="CAUGHT_FIRE_THIS_TURN",t[t.EVENT_FIRED_THIS_TURN=u(4)]="EVENT_FIRED_THIS_TURN",t[t.EVENT_PROTECTED=u(5)]="EVENT_PROTECTED",t[t.IS_IN_LOOP=u(6)]="IS_IN_LOOP",t[t.IS_CHOKEPOINT=u(7)]="IS_CHOKEPOINT",t[t.IS_GATE_SITE=u(8)]="IS_GATE_SITE",t[t.IS_IN_ROOM_MACHINE=u(9)]="IS_IN_ROOM_MACHINE",t[t.IS_IN_AREA_MACHINE=u(10)]="IS_IN_AREA_MACHINE",t[t.IMPREGNABLE=u(12)]="IMPREGNABLE",t[t.NEEDS_REDRAW=u(14)]="NEEDS_REDRAW",t[t.CELL_CHANGED=u(15)]="CELL_CHANGED",t[t.HAS_SURFACE=u(16)]="HAS_SURFACE",t[t.HAS_LIQUID=u(17)]="HAS_LIQUID",t[t.HAS_GAS=u(18)]="HAS_GAS",t[t.HAS_PLAYER=u(19)]="HAS_PLAYER",t[t.HAS_ACTOR=u(20)]="HAS_ACTOR",t[t.HAS_DORMANT_MONSTER=u(21)]="HAS_DORMANT_MONSTER",t[t.HAS_ITEM=u(22)]="HAS_ITEM",t[t.IS_IN_PATH=u(23)]="IS_IN_PATH",t[t.IS_CURSOR=u(24)]="IS_CURSOR",t[t.STABLE_MEMORY=u(25)]="STABLE_MEMORY",t[t.IS_WIRED=u(26)]="IS_WIRED",t[t.IS_CIRCUIT_BREAKER=u(27)]="IS_CIRCUIT_BREAKER",t[t.IS_POWERED=u(28)]="IS_POWERED",t[t.COLORS_DANCE=u(30)]="COLORS_DANCE",t[t.IS_IN_MACHINE=t.IS_IN_ROOM_MACHINE|t.IS_IN_AREA_MACHINE]="IS_IN_MACHINE",t[t.PERMANENT_CELL_FLAGS=t.HAS_ITEM|t.HAS_DORMANT_MONSTER|t.STABLE_MEMORY|t.SEARCHED_FROM_HERE|t.PRESSURE_PLATE_DEPRESSED|t.KNOWN_TO_BE_TRAP_FREE|t.IS_IN_LOOP|t.IS_CHOKEPOINT|t.IS_GATE_SITE|t.IS_IN_MACHINE|t.IMPREGNABLE]="PERMANENT_CELL_FLAGS",t[t.HAS_ANY_ACTOR=t.HAS_PLAYER|t.HAS_ACTOR]="HAS_ANY_ACTOR",t[t.HAS_ANY_OBJECT=t.HAS_ITEM|t.HAS_ANY_ACTOR]="HAS_ANY_OBJECT",t[t.CELL_DEFAULT=t.NEEDS_REDRAW|t.CELL_CHANGED]="CELL_DEFAULT"}(T||(T={}));const g=r.flag.fl;var S;!function(t){t[t.MAP_CHANGED=g(0)]="MAP_CHANGED",t[t.MAP_ALWAYS_LIT=g(3)]="MAP_ALWAYS_LIT",t[t.MAP_SAW_WELCOME=g(4)]="MAP_SAW_WELCOME",t[t.MAP_NO_LIQUID=g(5)]="MAP_NO_LIQUID",t[t.MAP_NO_GAS=g(6)]="MAP_NO_GAS",t[t.MAP_CALC_FOV=g(7)]="MAP_CALC_FOV",t[t.MAP_FOV_CHANGED=g(8)]="MAP_FOV_CHANGED",t[t.MAP_DANCES=g(9)]="MAP_DANCES",t[t.MAP_DEFAULT=0]="MAP_DEFAULT"}(S||(S={}));var A={__proto__:null,get Depth(){return s},get Entity(){return a},get Actor(){return h},get Item(){return c},get Tile(){return _},get TileMech(){return f},get Cell(){return T},get Map(){return S}};class L{constructor(t,e,i){this.x=t,this.y=e,this.disposable=i}matches(t,e){return this.x===t&&this.y===e}}class I{constructor(t){this.tags=[],this.name=t.name,this.flavor=t.flavor||this.name,this.description=t.description||this.flavor,this.sprite=r.sprite.make(t),t.tags&&("string"==typeof t.tags?this.tags=t.tags.split(/[,|]/).map((t=>t.trim())):this.tags=t.tags.slice())}forbidsCell(t,e){return!1}getName(t){return this.name}getDescription(t){return this.description}getFlavor(t){return this.flavor}getVerb(t,e){return e}}class d{constructor(t){this.key=null,this.depth=1,this.light=null,this.flags={entity:0},this.next=null,this.x=-1,this.y=-1,this.kind=t}get sprite(){return this.kind.sprite}get isDestroyed(){return this.hasEntityFlag(a.L_DESTROYED)}destroy(){this.flags.entity|=a.L_DESTROYED}hasEntityFlag(t){return!!(this.flags.entity&t)}hasAllEntityFlags(t){return(this.flags.entity&t)===t}hasTag(t){return this.kind.tags.includes(t)}blocksMove(){return this.hasEntityFlag(a.L_BLOCKS_MOVE)}blocksVision(){return this.hasEntityFlag(a.L_BLOCKS_VISION)}blocksPathing(){return this.hasEntityFlag(a.L_BLOCKS_MOVE)}blocksEffects(){return this.hasEntityFlag(a.L_BLOCKS_EFFECTS)}forbidsCell(t){return this.kind.forbidsCell(this,t)}getName(){return this.kind.getName(this)}getDescription(){return this.kind.getDescription(this)}getFlavor(){return this.kind.getFlavor(this)}getVerb(t){return this.kind.getVerb(this,t)}}var R={__proto__:null,KeyInfo:L,makeKeyInfo:function(t,e,i){return new L(t,e,i)},EntityKind:I,Entity:d};class p extends d{constructor(t){super(t),this.next=null,this.flags=this.flags||{},this.flags.actor=0,this.depth=s.ACTOR}hasActorFlag(t){return!!(this.flags.actor&t)}hasAllActorFlags(t){return(this.flags.actor&t)===t}actorFlags(){return this.flags.actor}isPlayer(){return this.hasActorFlag(h.IS_PLAYER)}isVisible(){return!0}}var O={__proto__:null,ActorKind:class extends I{constructor(t){super(t)}},Actor:p};class m extends I{constructor(t){super(t)}forbidsCell(t,e){return!1}}const C={};function y(t){return t instanceof m?t:C[t]}function N(t){const e=Object.assign({},t);return new m(e)}function D(t={}){const e={tags:[],forbidTags:[]};"string"==typeof t&&(t={tags:t}),"string"==typeof t.tags?t.tags.split(/[,|]/).map((t=>t.trim())).forEach((t=>{t.startsWith("!")?e.forbidTags.push(t.substring(1)):e.tags.push(t)})):Array.isArray(t.tags)&&(e.tags=t.tags.slice()),"string"==typeof t.forbidTags?e.forbidTags=t.forbidTags.split(/[,|]/).map((t=>t.trim())):Array.isArray(t.forbidTags)&&(e.forbidTags=t.forbidTags.slice());const i=Object.values(C).filter((t=>!(e.tags.length&&!r.utils.arraysIntersect(e.tags,t.tags))&&(!e.forbidTags||!r.utils.arraysIntersect(e.forbidTags,t.tags))));return r.random.item(i)||null}class F extends d{constructor(t){super(t),this.quantity=1,this.next=null,this.flags=this.flags||{},this.flags.item=0,this.depth=s.ITEM,this.kind=t}itemFlags(){return this.flags.item}hasItemFlag(t){return!!(this.flags.item&t)}hasAllItemFlags(t){return(this.flags.item&t)===t}}var M={__proto__:null,ItemKind:m,kinds:C,install:function(t,e){if(e instanceof m)return C[t]=e,e;const i=N(e);return C[t]=i,i},get:y,makeKind:N,randomKind:D,Item:F,make:function(t){const e=y(t);if(!e)throw new Error("Failed to find item kind - "+t);return new F(e)},makeRandom:function(t){const e=D(t);if(!e)throw new Error("Failed to find item kind matching - "+JSON.stringify(t));return new F(e)},from:function(t){let e;if("string"==typeof t){if(e=y(t),!e)throw new Error("Failed to find item kind - "+t)}else e=t instanceof m?t:N(t);return new F(e)}};const P=r.flag.fl;var w;function b(t){var e;if(!t)throw new Error("opts required to make effect.");if("string"==typeof t)throw new Error("Cannot make effect from string: "+t);"function"==typeof t&&(t={fn:t});const i={flags:r.flag.from(w,t.flags),chance:null!==(e=t.chance)&&void 0!==e?e:0,next:null,id:t.id||"n/a"};return t.next&&("string"==typeof t.next?i.next=t.next:i.next=b(t.next)),Object.values(H).forEach((e=>e.make(t,i))),i}function v(t){if(!t)throw new Error("Cannot make effect from null | undefined");if("string"==typeof t){const e=B[t];if(e)return e;throw new Error("Unknown effect - "+t)}return b(t)}function U(t){t.flags&=~w.E_FIRED}!function(t){t[t.E_NEXT_ALWAYS=P(0)]="E_NEXT_ALWAYS",t[t.E_NEXT_EVERYWHERE=P(1)]="E_NEXT_EVERYWHERE",t[t.E_FIRED=P(2)]="E_FIRED",t[t.E_NO_MARK_FIRED=P(3)]="E_NO_MARK_FIRED",t[t.E_PROTECTED=P(4)]="E_PROTECTED",t[t.E_TREAT_AS_BLOCKING=P(5)]="E_TREAT_AS_BLOCKING",t[t.E_PERMIT_BLOCKING=P(6)]="E_PERMIT_BLOCKING",t[t.E_ABORT_IF_BLOCKS_MAP=P(7)]="E_ABORT_IF_BLOCKS_MAP",t[t.E_BLOCKED_BY_ITEMS=P(8)]="E_BLOCKED_BY_ITEMS",t[t.E_BLOCKED_BY_ACTORS=P(9)]="E_BLOCKED_BY_ACTORS",t[t.E_BLOCKED_BY_OTHER_LAYERS=P(10)]="E_BLOCKED_BY_OTHER_LAYERS",t[t.E_SUPERPRIORITY=P(11)]="E_SUPERPRIORITY",t[t.E_SPREAD_CIRCLE=P(13)]="E_SPREAD_CIRCLE",t[t.E_SPREAD_LINE=P(14)]="E_SPREAD_LINE",t[t.E_EVACUATE_CREATURES=P(15)]="E_EVACUATE_CREATURES",t[t.E_EVACUATE_ITEMS=P(16)]="E_EVACUATE_ITEMS",t[t.E_BUILD_IN_WALLS=P(17)]="E_BUILD_IN_WALLS",t[t.E_MUST_TOUCH_WALLS=P(18)]="E_MUST_TOUCH_WALLS",t[t.E_NO_TOUCH_WALLS=P(19)]="E_NO_TOUCH_WALLS",t[t.E_CLEAR_GROUND=P(21)]="E_CLEAR_GROUND",t[t.E_CLEAR_SURFACE=P(22)]="E_CLEAR_SURFACE",t[t.E_CLEAR_LIQUID=P(23)]="E_CLEAR_LIQUID",t[t.E_CLEAR_GAS=P(24)]="E_CLEAR_GAS",t[t.E_CLEAR_TILE=P(25)]="E_CLEAR_TILE",t[t.E_CLEAR_CELL=t.E_CLEAR_GROUND|t.E_CLEAR_SURFACE|t.E_CLEAR_LIQUID|t.E_CLEAR_GAS]="E_CLEAR_CELL",t[t.E_ONLY_IF_EMPTY=t.E_BLOCKED_BY_ITEMS|t.E_BLOCKED_BY_ACTORS]="E_ONLY_IF_EMPTY",t[t.E_ACTIVATE_DORMANT_MONSTER=P(27)]="E_ACTIVATE_DORMANT_MONSTER",t[t.E_AGGRAVATES_MONSTERS=P(28)]="E_AGGRAVATES_MONSTERS",t[t.E_RESURRECT_ALLY=P(29)]="E_RESURRECT_ALLY"}(w||(w={}));const B={};function k(t,e){const i=b(e);return B[t]=i,i.id=t,i}const H={};function K(t,e){H[t]=e}async function Y(t,e,i,s,l={}){if(!t)return!1;if("string"==typeof t){const e=t;if(!(t=v(e)))throw new Error("Failed to find effect: "+e)}const a=l;if(!a.force&&t.chance&&!r.random.chance(t.chance,1e4))return!1;const n=a.grid=r.grid.alloc(e.width,e.height);let h=!0;const c=Object.values(H);for(let r of c)await r.fire(t,e,i,s,a)&&(h=!0);if(!h||!e.isVisible(i,s)||t.flags&w.E_NO_MARK_FIRED||(t.flags|=w.E_FIRED),t.next&&(h||t.flags&w.E_NEXT_ALWAYS)&&!r.data.gameHasEnded){const r="string"==typeof t.next?v(t.next):t.next;t.flags&w.E_NEXT_EVERYWHERE?await n.forEachAsync((async(t,i,s)=>{t&&await Y(r,e,i,s,a)})):await Y(r,e,i,s,a)}return r.grid.free(n),h}function G(t,e,i,s,l={}){if(!t)return!1;if("string"==typeof t){const e=t;if(!(t=v(e)))throw new Error("Failed to find effect: "+e)}const a=l;if(!a.force&&t.chance&&!r.random.chance(t.chance,1e4))return!1;const n=a.grid=r.grid.alloc(e.width,e.height);let h=!0;const c=Object.values(H);for(let r of c)r.fireSync(t,e,i,s,a)&&(h=!0);if(!h||!e.isVisible(i,s)||t.flags&w.E_NO_MARK_FIRED||(t.flags|=w.E_FIRED),t.next&&(h||t.flags&w.E_NEXT_ALWAYS)&&!r.data.gameHasEnded){const r="string"==typeof t.next?v(t.next):t.next;t.flags&w.E_NEXT_EVERYWHERE?n.forEach((async(t,i,s)=>{t&&G(r,e,i,s,a)})):G(r,e,i,s,a)}return r.grid.free(n),h}class V{make(t,e){if(!t.message)return!0;if("string"!=typeof t.message)throw new Error("Emit must be configured with name of event to emit");return e.message=t.message,!0}async fire(t,e,i,s,l){if(!t.message)return!1;const a=!!(t.flags&w.E_FIRED);return!(!t.message||!t.message.length||a||!e.isVisible(i,s))&&(r.message.addAt(i,s,t.message,l),!0)}fireSync(t,e,i,s,r){if(!t.message)return!1;throw new Error('Cannot use "message" effects in build steps.')}}K("message",new V);class W{make(t,e){if(!t.emit)return!0;if("string"!=typeof t.emit)throw new Error('emit effects must be string name to emit: { emit: "EVENT" }');return e.emit=t.emit,!0}async fire(t,e,i,s,l){return!!t.emit&&await r.events.emit(t.emit,i,s,l)}fireSync(t,e,i,s,r){if(!t.emit)return!1;throw new Error('Cannot use "emit" effects in build steps.')}}K("emit",new W);class x{make(t,e){if(!t.fn)return!0;if("function"!=typeof t.fn)throw new Error("fn effects must be functions.");return e.fn=t.fn,!0}async fire(t,e,i,s,r){return!!t.fn&&await t.fn(t,e,i,s,r)}fireSync(t,e,i,s,r){if(t.fn){const l=t.fn(t,e,i,s,r);if(!0===l||!1===l)return l;throw new Error("Cannot use async function effects in build steps.")}return!1}}K("fn",new x);class X{make(t,e){return!t.activateMachine||(e.activateMachine=!0,!0)}async fire(t,e,i,s,r){if(t.activateMachine){const t=e.cell(i,s).machineId;return!!t&&await e.activateMachine(t,i,s,r)}return!1}fireSync(t,e,i,s,r){if(t.activateMachine){const t=e.cell(i,s).machineId;return!!t&&e.activateMachineSync(t,i,s,r)}return!1}}K("activateMachine",new X);var j={__proto__:null,get Flags(){return w},reset:U,resetAll:function(){Object.values(B).forEach((t=>U(t)))},effects:B,install:k,installAll:function(t){Object.entries(t).forEach((([t,e])=>{k(t,e)}))},handlers:H,installHandler:K,make:b,from:v,fire:Y,fireSync:G,MessageEffect:V,EmitEffect:W,FnEffect:x,ActivateMachineEffect:X};class Q{constructor(t){var e,i,s,l;this.index=-1,this.dissipate=2e3,this.effects={},this.priority=50,this.depth=0,this.light=null,this.groundTile=null,this.id=t.id||"n/a",this.dissipate=null!==(e=t.dissipate)&&void 0!==e?e:this.dissipate,this.priority=null!==(i=t.priority)&&void 0!==i?i:this.priority,this.depth=null!==(s=t.depth)&&void 0!==s?s:this.depth,this.light=t.light||null,this.groundTile=t.groundTile||null,this.sprite=r.sprite.make(t),this.name=t.name||"tile",this.description=t.description||this.name,this.flavor=t.flavor||this.name,this.article=null!==(l=t.article)&&void 0!==l?l:null,this.flags=t.flags||{entity:0,tile:0,tileMech:0},t.effects&&Object.assign(this.effects,t.effects),this.hasEffect("fire")&&(this.flags.tile|=_.T_IS_FLAMMABLE)}hasEntityFlag(t){return!!(this.flags.entity&t)}hasTileFlag(t){return!!(this.flags.tile&t)}hasTileMechFlag(t){return!!(this.flags.tileMech&t)}hasAllEntityFlags(t){return(this.flags.entity&t)===t}hasAllTileFlags(t){return(this.flags.tile&t)===t}hasAllTileMechFlags(t){return(this.flags.tileMech&t)===t}blocksVision(){return!!(this.flags.entity&a.L_BLOCKS_VISION)}blocksMove(){return!!(this.flags.entity&a.L_BLOCKS_MOVE)}blocksPathing(){return this.blocksMove()||this.hasTileFlag(_.T_PATHING_BLOCKER)}blocksEffects(){return!!(this.flags.entity&a.L_BLOCKS_EFFECTS)}hasEffect(t){return t in this.effects}getName(t){let e={};if(!0===t||!1===t||"string"==typeof t?e.article=t:t&&(e=t),!e.article&&!e.color)return this.name;let i=this.name;if(e.color){let t=e.color;!0===e.color&&(t=this.sprite.fg||"white"),"string"!=typeof t&&(t=r.color.from(t).toString()),i=`Ω${t}Ω${this.name}∆`}if(e.article){i=("string"==typeof e.article?e.article:this.article||"a")+" "+i}return i}getDescription(){return this.description||this.getName()}getFlavor(){return this.flavor||this.getName()}}function q(t){var e,i,l,n,h,c;let o={effects:{},flags:{},sprite:{},priority:50};if(t.extends&&(o=z[t.extends],!o))throw new Error("Failed to find base tile: "+t.extends);let E=o.priority;if("string"==typeof t.priority){let e=t.priority.replace(/ /g,""),i=e.search(/[+-]/);if(0==i)E=o.priority+Number.parseInt(e);else if(-1==i)if(0==e.search(/[a-zA-Z]/)){const t=z[e];if(!t)throw new Error("Failed to find tile for priority - "+e+".");E=t.priority}else E=Number.parseInt(e);else{const t=e.substring(0,i),s=Number.parseInt(e.substring(i)),r=z[t];if(!r)throw new Error("Failed to find tile for priority - "+t+".");E=r.priority+s}}else void 0!==t.priority&&(E=t.priority);const u={};Object.assign(u,o.effects),t.effects&&Object.entries(t.effects).forEach((([t,e])=>{null!==e?u[t]="string"!=typeof e?b(e):e:delete u[t]}));const T={entity:r.flag.from(a,o.flags.entity,t.flags),tile:r.flag.from(_,o.flags.tile,t.flags),tileMech:r.flag.from(f,o.flags.tileMech,t.flags)};let g=o.depth||0;t.depth&&(g="string"==typeof t.depth?s[t.depth]:t.depth);let S=o.light;t.light?S=r.light.make(t.light):null===t.light&&(S=null);const A={id:t.id,flags:T,dissipate:null!==(e=t.dissipate)&&void 0!==e?e:o.dissipate,effects:u,priority:E,depth:g,light:S,groundTile:t.groundTile||null,ch:null!==(i=t.ch)&&void 0!==i?i:o.sprite.ch,fg:null!==(l=t.fg)&&void 0!==l?l:o.sprite.fg,bg:null!==(n=t.bg)&&void 0!==n?n:o.sprite.bg,opacity:null!==(h=t.opacity)&&void 0!==h?h:o.sprite.opacity,name:t.name||o.name,description:t.description||o.description,flavor:t.flavor||o.flavor,article:null!==(c=t.article)&&void 0!==c?c:o.article};return new Q(A)}const z={},J=[];function $(t){return t instanceof Q?t:"string"==typeof t?z[t]||null:J[t]||null}function Z(t,...e){let i=e[0];2==e.length&&(i=e[1],i.extends=e[0]),i.id=t;const s=q(i);return s.index=J.length,J.push(s),z[t]=s,s}Z("NULL",{ch:"∅",fg:"white",bg:"black",flags:"L_BLOCKS_MOVE",name:"eerie nothingness",article:"an",priority:0}),Z("FLOOR",{ch:"·",fg:[30,30,30,20,0,0,0],bg:[2,2,10,0,2,2,0],priority:10,article:"the"}),Z("DOOR",{ch:"+",fg:[100,40,40],bg:[30,60,60],priority:30,flags:"T_IS_DOOR, L_BLOCKS_EFFECTS, L_BLOCKS_ITEMS, L_BLOCKS_VISION, L_VISUALLY_DISTINCT",article:"a",effects:{enter:{tile:"DOOR_OPEN"},open:{tile:"DOOR_OPEN_ALWAYS"}}}),Z("DOOR_OPEN","DOOR",{ch:"'",fg:[100,40,40],bg:[30,60,60],priority:40,flags:"!L_BLOCKS_ITEMS, !L_BLOCKS_VISION",name:"open door",article:"an",effects:{tick:{chance:1e4,tile:"DOOR",flags:"E_SUPERPRIORITY, E_ONLY_IF_EMPTY"},enter:null,open:null,close:{tile:"DOOR",flags:"E_SUPERPRIORITY, E_ONLY_IF_EMPTY"}}}),Z("DOOR_OPEN_ALWAYS","DOOR_OPEN",{effects:{tick:null,close:{tile:"DOOR",flags:"E_SUPERPRIORITY, E_ONLY_IF_EMPTY"}}}),Z("UP_STAIRS",{ch:"<",fg:[100,50,50],bg:[40,20,20],priority:200,flags:"T_UP_STAIRS, L_BLOCKED_BY_STAIRS, L_VISUALLY_DISTINCT, L_LIST_IN_SIDEBAR",name:"upward staircase",article:"an",effects:{player:{emit:"UP_STAIRS"}}}),Z("DOWN_STAIRS",{ch:">",fg:[100,50,50],bg:[40,20,20],priority:200,flags:"T_DOWN_STAIRS, L_BLOCKED_BY_STAIRS, L_VISUALLY_DISTINCT, L_LIST_IN_SIDEBAR",name:"downward staircase",article:"a",effects:{player:{emit:"DOWN_STAIRS"}}}),Z("WALL",{ch:"#",fg:[7,7,7,0,3,3,3],bg:[40,40,40,10,10,0,5],priority:100,flags:"L_WALL_FLAGS",article:"a",name:"stone wall",description:"A wall made from rough cut stone.",flavor:"a rough stone wall"}),Z("IMPREGNABLE",{ch:"#",fg:[7,7,7,0,3,3,3],bg:[40,40,40,10,10,0,5],priority:100,flags:"L_WALL_FLAGS, IMPREGNABLE",article:"a",name:"impregnable wall",description:"A wall made from very hard stone.",flavor:"an impregnable wall"}),Z("LAKE",{ch:"~",fg:[5,8,20,10,0,4,15,!0],bg:[10,15,41,6,5,5,5,!0],priority:50,flags:"T_DEEP_WATER",name:"deep water",article:"the"}),Z("SHALLOW",{ch:"·",fg:[5,8,10,10,0,4,15,!0],bg:[10,30,30,6,0,10,10,!0],priority:20,name:"shallow water",article:"the",depth:"SURFACE"}),Z("BRIDGE",{ch:"=",fg:[100,40,40],priority:40,depth:"SURFACE",flags:"T_BRIDGE, L_VISUALLY_DISTINCT",article:"a",groundTile:"LAKE"});const tt={Tile:_,TileMech:f};var et={__proto__:null,flags:tt,Tile:Q,make:q,tiles:z,all:J,get:$,install:Z,installAll:function(t){Object.entries(t).forEach((([t,e])=>{Z(t,e)}))}};class it{constructor(t,e="layer"){this.map=t,this.depth=-1,this.properties={},this.name=e}copy(t){}setTile(t,e,i){return!1}clearTile(t,e){return!1}addActor(t,e,i){return!1}forceActor(t,e,i){return!1}removeActor(t){return!1}addItem(t,e,i){return!1}forceItem(t,e,i){return!1}removeItem(t){return!1}tick(t){return!1}}class st extends it{constructor(t,e="tile"){super(t,e)}setTile(t,e,i,r={}){const l=this.map.cell(t,e),a=l.depthTile(i.depth)||z.NULL;if(!r.superpriority&&a.priority>i.priority)return!1;if(l.blocksLayer(i.depth))return!1;if(r.blockedByItems&&l.hasItem())return!1;if(r.blockedByActors&&l.hasActor())return!1;if(r.blockedByOtherLayers&&l.highestPriority()>i.priority)return!1;if(i.depth>s.GROUND&&i.groundTile){const r=l.depthTile(s.GROUND);r&&r!==z.NULL||this.setTile(t,e,$(i.groundTile))}return!!l.setTile(i)&&(r.machine&&(l.machineId=r.machine),a.light!==i.light&&(this.map.light.glowLightChanged=!0),i.hasTileFlag(_.T_IS_FIRE)&&l.setCellFlag(T.CAUGHT_FIRE_THIS_TURN),!0)}clearTile(t,e){return this.map.cell(t,e).clearDepth(this.depth)}async tick(t){for(let t=0;t<this.map.width;++t)for(let e=0;e<this.map.height;++e){const i=this.map.cell(t,e);!i.hasCellFlag(T.HAS_ANY_ACTOR|T.HAS_ITEM)&&i.hasCellFlag(T.PRESSURE_PLATE_DEPRESSED)&&i.clearCellFlag(T.PRESSURE_PLATE_DEPRESSED),i.hasEffect("noKey")&&!this.map.hasKey(t,e)&&await i.activate("noKey",this.map,t,e)}return!0}putAppearance(t,e,i){const s=this.map.cell(e,i).depthTile(this.depth);s&&s!==z.NULL&&t.drawSprite(s.sprite)}}class rt extends it{constructor(t,e="actor"){super(t,e)}async addActor(t,e,i,s){const l=i;if(l.isDestroyed)return!1;const a=this.map.cell(t,e);return!l.forbidsCell(a)&&(!!r.list.push(a,"actor",i)&&(i.isPlayer()&&a.setCellFlag(T.HAS_PLAYER),i.x=t,i.y=e,i.key&&i.key.matches(t,e)&&a.hasEffect("key")&&await a.activate("key",this.map,t,e),!0))}forceActor(t,e,i,s){if(i.isDestroyed)return!1;const l=this.map.cell(t,e);return!!r.list.push(l,"actor",i)&&(i.isPlayer()&&l.setCellFlag(T.HAS_PLAYER),i.x=t,i.y=e,!0)}async removeActor(t){const e=t.x,i=t.y,s=this.map.cell(e,i);return!!r.list.remove(s,"actor",t)&&(t.isPlayer()&&s.clearCellFlag(T.HAS_PLAYER),t.key&&t.key.matches(e,i)&&s.hasEffect("nokey")&&await s.activate("key",this.map,e,i),!0)}putAppearance(t,e,i){const s=this.map.cell(e,i);s.actor&&t.drawSprite(s.actor.sprite)}}class lt extends it{constructor(t,e="item"){super(t,e)}async addItem(t,e,i,s){const l=i;if(l.isDestroyed)return!1;const a=this.map.cell(t,e);return!l.forbidsCell(a)&&(i.key&&i.key.matches(t,e)&&a.hasEffect("key")&&(await a.activate("key",this.map,t,e),i.key.disposable)?(i.destroy(),!0):!!r.list.push(a,"item",i)&&(i.x=t,i.y=e,i.depth=this.depth,!0))}forceItem(t,e,i,s){const l=this.map.cell(t,e);return!!r.list.push(l,"item",i)&&(i.x=t,i.y=e,i.depth=this.depth,!0)}async removeItem(t){const e=t.x,i=t.y,s=this.map.cell(e,i);return!!r.list.remove(s,"item",t)&&(t.key&&t.key.matches(e,i)&&s.hasEffect("nokey")&&await s.activate("key",this.map,e,i),!0)}putAppearance(t,e,i){const s=this.map.cell(e,i);s.item&&t.drawSprite(s.item.sprite)}}class at extends st{constructor(t,e="gas"){super(t,e),this.needsUpdate=!1,this.volume=r.grid.alloc(t.width,t.height,0)}setTile(t,e,i,s={}){if(!s.volume)return!1;return this.map.cell(t,e).depthTile(i.depth)===i?(this.volume[t][e]+=s.volume,!0):!!super.setTile(t,e,i,s)&&(this.volume[t][e]=s.volume,this.needsUpdate=!0,!0)}clearTile(t,e){return!!this.map.cell(t,e).clearDepth(this.depth)&&(this.volume[t][e]=0,!0)}copy(t){this.volume.copy(t.volume)}async tick(t){if(!this.needsUpdate)return!1;this.needsUpdate=!1;const e=this.volume;return this.volume=r.grid.alloc(this.map.width,this.map.height),this.dissipate(e),this.spread(e),r.grid.free(e),!0}dissipate(t){t.update(((t,e,i)=>{if(!t)return 0;const s=this.map.cell(e,i).depthTile(this.depth);if(s&&s.dissipate){let e=Math.max(.5,t*s.dissipate/1e4);t=Math.max(0,t-e)}return t?this.needsUpdate=!0:this.clearTile(e,i),t}))}calcOpacity(t){return Math.floor(10*Math.min(t,10))}updateCellVolume(t,e,i){let s=0,r=0,l=0;const n=this.map.cell(t,e);let h=n.depthTile(this.depth),c=h;if(n.hasEntityFlag(a.L_BLOCKS_GAS))return this.volume[t][e]=0,void(i[t][e]&&this.clearTile(t,e));for(let h=Math.max(0,t-1);h<Math.min(t+2,i.width);++h)for(let t=Math.max(0,e-1);t<Math.min(e+2,i.height);++t){const e=i[h][t];n.hasEntityFlag(a.L_BLOCKS_GAS)||(++r,e>l&&(l=e,c=this.map.cell(h,t).depthTile(this.depth))),s+=e}const o=Math.floor(10*s/r)/10;this.volume[t][e]=o,o>0&&c&&(h&&h===c||n.setTile(c)),o>0&&(n.needsRedraw=!0)}spread(t){for(let e=0;e<t.width;++e)for(let i=0;i<t.height;++i)this.updateCellVolume(e,i,t)}putAppearance(t,e,i){const s=this.volume[e][i];if(!s)return;const r=this.map.cell(e,i).depthTile(this.depth);if(r){const e=this.calcOpacity(s);t.drawSprite(r.sprite,e)}}}const nt=s,ht=a,ct=_,ot=f,_t=T;class Et extends st{constructor(t,e="tile"){super(t,e)}async tick(t){for(let t=0;t<this.map.width;++t)for(let e=0;e<this.map.height;++e){this.map.cell(t,e).clearCellFlag(_t.CAUGHT_FIRE_THIS_TURN)}for(let t=0;t<this.map.width;++t)for(let e=0;e<this.map.height;++e){const i=this.map.cell(t,e);if(i.hasTileFlag(ct.T_IS_FIRE)&&!(i.flags.cell&_t.CAUGHT_FIRE_THIS_TURN)){await this.exposeToFire(t,e,!1);for(let i=0;i<4;++i){const s=r.utils.DIRS[i];await this.exposeToFire(t+s[0],e+s[1])}}}return!0}async exposeToFire(t,e,i=!1){let s=0,l=0,a=0,n=!1,h=!1;const c=this.map.cell(t,e);if(!c.hasTileFlag(ct.T_IS_FLAMMABLE))return!1;if(c.eachTile((t=>{t.hasTileFlag(ct.T_EXTINGUISHES_FIRE)&&t.priority>l&&(l=t.priority)})),c.eachTile((t=>{if(t.flags.tile&ct.T_IS_FLAMMABLE&&(t.depth===nt.GAS||t.priority>=l)){const e=v(t.effects.fire);e&&e.chance>s&&(s=e.chance)}})),i||s&&r.random.chance(s,1e4)){n=!0,c.hasTileMechFlag(ot.TM_EXPLOSIVE_PROMOTE)&&(r.utils.eachNeighbor(t,e,((t,e)=>{const i=this.map.cell(t,e);(i.hasEntityFlag(ht.L_BLOCKS_GAS)||i.hasTileFlag(ct.T_IS_FIRE)||i.hasTileMechFlag(ot.TM_EXPLOSIVE_PROMOTE))&&++a})),a>=8&&(h=!0));let i="fire";h&&c.hasEffect("explode")&&(i="explode"),await c.activate(i,this.map,t,e,{force:!0}),c.needsRedraw=!0}return n}}var ft={__proto__:null,MapLayer:it,TileLayer:st,ActorLayer:rt,ItemLayer:lt,GasLayer:at,FireLayer:Et};class ut{constructor(t){this.cell=t}eachItem(t){let e=this.cell._item;for(;e;)t(e),e=e.next}eachActor(t){let e=this.cell._actor;for(;e;)t(e),e=e.next}forEach(t){this.eachItem(t),this.eachActor(t)}some(t){let e=this.cell._item;for(;e;){if(t(e))return!0;e=e.next}for(e=this.cell._actor;e;){if(t(e))return!0;e=e.next}return!1}reduce(t,e){let i=this.cell._item;for(;i;)e=void 0===e?i:t(e,i),i=i.next;for(i=this.cell._actor;i;)e=void 0===e?i:t(e,i),i=i.next;return e}}class Tt{constructor(t){if(this.chokeCount=0,this.machineId=0,this.keyId=0,this._actor=null,this._item=null,this._objects=new ut(this),this.flags={cell:0},this.tiles=[z.NULL],t){const e=$(t);this.setTile(e)}}copy(t){Object.assign(this.flags,t.flags),this.chokeCount=t.chokeCount,this.tiles=t.tiles.slice(),this._actor=t._actor,this._item=t._item,this.keyId=t.keyId,this.machineId=t.machineId}hasCellFlag(t){return!!(this.flags.cell&t)}setCellFlag(t){this.flags.cell|=t}clearCellFlag(t){this.flags.cell&=~t}hasEntityFlag(t){return this.tiles.some((e=>e&&e.flags.entity&t))||this._objects.some((e=>!!(e.flags.entity&t)))}hasAllEntityFlags(t){return(this.entityFlags()&t)==t}hasTileFlag(t){return this.tiles.some((e=>e&&e.flags.tile&t))}hasAllTileFlags(t){return(this.tileFlags()&t)==t}hasTileMechFlag(t){return this.tiles.some((e=>e&&e.flags.tileMech&t))}hasAllTileMechFlags(t){return(this.tileMechFlags()&t)==t}cellFlags(){return this.flags.cell}entityFlags(){return this.tiles.reduce(((t,e)=>t|(e?e.flags.entity:0)),0)|this._objects.reduce(((t,e)=>t|e.flags.entity),0)}tileFlags(){return this.tiles.reduce(((t,e)=>t|(e?e.flags.tile:0)),0)}tileMechFlags(){return this.tiles.reduce(((t,e)=>t|(e?e.flags.tileMech:0)),0)}itemFlags(){let t=0;return this._objects.eachItem((e=>{t|=e.flags.item})),t}actorFlags(){let t=0;return this._objects.eachActor((e=>{t|=e.flags.actor})),t}get needsRedraw(){return!!(this.flags.cell&T.NEEDS_REDRAW)}set needsRedraw(t){t?this.flags.cell|=T.NEEDS_REDRAW:this.flags.cell&=~T.NEEDS_REDRAW}depthPriority(t){const e=this.tiles[t];return e?e.priority:z.NULL.priority}highestPriority(){return this.tiles.reduce(((t,e)=>Math.max(t,e?e.priority:0)),z.NULL.priority)}depthTile(t){return this.tiles[t]||null}hasTile(t){return t?(t instanceof Q||(t=$(t)),this.tiles.includes(t)):this.tiles.some((t=>t))}hasDepthTile(t){const e=this.tiles[t];return!!e&&e!==z.NULL}highestPriorityTile(){return this.tiles.reduce(((t,e)=>e&&e.priority>=t.priority?e:t),z.NULL)}get tile(){return this.highestPriorityTile()}eachTile(t){this.tiles.forEach((e=>e&&t(e)))}tileWithObjectFlag(t){return this.tiles.find((e=>e&&e.flags.entity&t))||null}tileWithFlag(t){return this.tiles.find((e=>e&&e.flags.tile&t))||null}tileWithMechFlag(t){return this.tiles.find((e=>e&&e.flags.tileMech&t))||null}blocksVision(){return this.tiles.some((t=>t&&t.blocksVision()))||this._objects.some((t=>t.blocksVision()))}blocksPathing(){return this.tiles.some((t=>t&&t.blocksPathing()))||this._objects.some((t=>t.blocksPathing()))}blocksMove(){return this.tiles.some((t=>t&&t.blocksMove()))||this._objects.some((t=>t.blocksMove()))}blocksEffects(){return this.tiles.some((t=>t&&t.blocksEffects()))||this._objects.some((t=>t.blocksEffects()))}blocksLayer(t){return this.tiles.some((e=>e&&!!(e.flags.tile&tt.Tile.T_BLOCKS_OTHER_LAYERS)&&e.depth!=t))}isEmpty(){return this.tiles.every((t=>!t||t===z.NULL))&&null==this._actor&&null==this._item}isPassable(){return!this.blocksMove()}isWall(){return this.hasAllEntityFlags(a.L_WALL_FLAGS)}isStairs(){return this.hasTileFlag(_.T_HAS_STAIRS)}setTile(t){return!!(t instanceof Q||(t=$(t)))&&(this.tiles[t.depth]=t,this.needsRedraw=!0,!0)}clear(){this.tiles=[z.NULL],this.needsRedraw=!0,this.flags.cell=0,this.chokeCount=0,this._actor=null,this._item=null}clearDepth(t){return 0==t?(this.tiles[0]=z.NULL,this.needsRedraw=!0,!0):null!==this.tiles[t]&&(this.tiles[t]=null,this.needsRedraw=!0,!0)}clearDepthsWithFlags(t,e=0){for(let i=0;i<this.tiles.length;++i){const s=this.tiles[i];s&&(s.hasTileFlag(t)&&(e&&!s.hasTileMechFlag(e)||this.clearDepth(i)))}}eachGlowLight(t){this.tiles.forEach((e=>{e&&e.light&&t(e.light)}))}async activate(t,e,i,s,r={}){r.cell=this;let l=!1;if(void 0!==r.depth){const a=r.tile=this.depthTile(r.depth);if(a&&a.effects){const n=a.effects[t];l=await this._fire(n,e,i,s,r)}}else for(r.tile of this.tiles){if(!r.tile||!r.tile.effects)continue;const a=r.tile.effects[t];if(await this._fire(a,e,i,s,r)){l=!0;break}}return l}activateSync(t,e,i,s,r={}){r.cell=this;let l=!1;if(void 0!==r.depth){const a=r.tile=this.depthTile(r.depth);if(a&&a.effects){const n=a.effects[t];l=this._fireSync(n,e,i,s,r)}}else for(r.tile of this.tiles){if(!r.tile||!r.tile.effects)continue;const a=r.tile.effects[t];if(this._fireSync(a,e,i,s,r)){l=!0;break}}return l}async _fire(t,e,i,s,r){"string"==typeof t&&(t=B[t]);let l=!1;return t&&(l=await Y(t,e,i,s,r)),l}_fireSync(t,e,i,s,r){"string"==typeof t&&(t=B[t]);let l=!1;return t&&(l=G(t,e,i,s,r)),l}hasEffect(t){for(let e of this.tiles)if(e&&e.hasEffect(t))return!0;return!1}hasItem(){return this.hasCellFlag(T.HAS_ITEM)}get item(){return this._item}set item(t){this._item=t,t?this.setCellFlag(T.HAS_ITEM):this.clearCellFlag(T.HAS_ITEM),this.needsRedraw=!0}hasActor(){return this.hasCellFlag(T.HAS_ACTOR)}hasPlayer(){return this.hasCellFlag(T.HAS_PLAYER)}get actor(){return this._actor}set actor(t){this._actor=t,t?this.setCellFlag(T.HAS_ACTOR):this.clearCellFlag(T.HAS_ACTOR),this.needsRedraw=!0}getDescription(){return this.highestPriorityTile().description}getFlavor(){return this.highestPriorityTile().flavor}getName(t={}){return this.highestPriorityTile().getName(t)}dump(){var t,e,i,s;return(null===(e=null===(t=this._actor)||void 0===t?void 0:t.sprite)||void 0===e?void 0:e.ch)?this._actor.sprite.ch:(null===(s=null===(i=this._item)||void 0===i?void 0:i.sprite)||void 0===s?void 0:s.ch)?this._item.sprite.ch:this.highestPriorityTile().sprite.ch||" "}}class gt{constructor(){this.chokeCount=0,this.machineId=0,this.keyId=0,this.flags={cell:0,item:0,actor:0,tile:0,tileMech:0,object:0},this.blocks={vision:!1,effects:!1,move:!1,pathing:!1},this._tile=z.NULL,this._item=null,this._actor=null,this._hasKey=!1,this.snapshot=new r.sprite.Mixer}clear(){this.snapshot.blackOut(),this._item=null,this._actor=null,this._tile=z.NULL,this.flags.cell=0,this.flags.object=0,this.flags.tile=0,this.flags.tileMech=0,this.blocks.effects=!1,this.blocks.move=!1,this.blocks.pathing=!1,this.blocks.vision=!1,this.machineId=0,this.chokeCount=0}store(t){this._item=null,t.hasItem()&&(this._item=t.item),this._actor=null,t.hasActor()&&(this._actor=t.actor),this._tile=t.tile,this.flags.cell=t.cellFlags(),this.flags.tile=t.tileFlags(),this.flags.tileMech=t.tileMechFlags(),this.flags.object=t.entityFlags(),this.flags.item=t.itemFlags(),this.flags.actor=t.actorFlags(),this.blocks.effects=t.blocksEffects(),this.blocks.move=t.blocksMove(),this.blocks.pathing=t.blocksPathing(),this.blocks.vision=t.blocksVision(),this.chokeCount=t.chokeCount,this.machineId=t.machineId}getSnapshot(t){t.copy(this.snapshot)}putSnapshot(t){this.snapshot.copy(t)}hasCellFlag(t){return!!(this.flags.cell&t)}hasTileFlag(t){return!!(this.flags.tile&t)}hasAllTileFlags(t){return(this.flags.tile&t)==t}hasEntityFlag(t){return!!(this.flags.object&t)}hasAllEntityFlags(t){return(this.flags.object&t)==t}hasTileMechFlag(t){return!!(this.flags.tileMech&t)}cellFlags(){return this.flags.cell}entityFlags(){return this.flags.object}tileFlags(){return this.flags.tile}tileMechFlags(){return this.flags.tileMech}itemFlags(){return this.flags.item}actorFlags(){return this.flags.actor}blocksVision(){return this.blocks.vision}blocksPathing(){return this.blocks.pathing}blocksMove(){return this.blocks.move}blocksEffects(){return this.blocks.effects}isWall(){return this.blocksVision()&&this.blocksMove()}isStairs(){return this.hasTileFlag(_.T_HAS_STAIRS)}get tile(){return this._tile}hasTile(t){return t instanceof Q||(t=$(t)),this._tile===t}hasItem(){return!!this._item}get item(){return this._item}hasActor(){return!!this._actor}hasPlayer(){return!!(this.flags.cell&T.HAS_PLAYER)}get actor(){return this._actor}getDescription(){throw new Error("Method not implemented.")}getFlavor(){throw new Error("Method not implemented.")}getName(t){throw new Error("Method not implemented.")}}class St{constructor(t,e,i={}){this.width=t,this.height=e,this.flags={map:0},this.layers=[],this.cells=r.grid.make(t,e,(()=>new Tt)),this.memory=r.grid.make(t,e,(()=>new gt)),this.light=new r.light.LightSystem(this,i),this.fov=new r.fov.FovSystem(this,i),this.properties={},this.initLayers()}cellInfo(t,e,i=!1){return i?this.memory[t][e]:this.cell(t,e)}initLayers(){this.addLayer(s.GROUND,new st(this,"ground")),this.addLayer(s.SURFACE,new Et(this,"surface")),this.addLayer(s.GAS,new at(this,"gas")),this.addLayer(s.ITEM,new lt(this,"item")),this.addLayer(s.ACTOR,new rt(this,"actor"))}addLayer(t,e){"number"!=typeof t&&(t=s[t]),e.depth=t,this.layers[t]=e}removeLayer(t){if("number"!=typeof t&&(t=s[t]),!t)throw new Error("Cannot remove layer with depth=0.");delete this.layers[t]}getLayer(t){return"number"!=typeof t&&(t=s[t]),this.layers[t]||null}hasXY(t,e){return this.cells.hasXY(t,e)}isBoundaryXY(t,e){return 0==t||0==e||t==this.width-1||e==this.height-1}cell(t,e){return this.cells[t][e]}get(t,e){return this.cells.get(t,e)}eachCell(t){this.cells.forEach(((e,i,s)=>t(e,i,s,this)))}drawInto(t,e={}){const i=t instanceof r.canvas.Canvas?t.buffer:t;"boolean"==typeof e&&(e={force:e});const s=new r.sprite.Mixer;for(let t=0;t<i.width;++t)for(let e=0;e<i.height;++e)this.getAppearanceAt(t,e,s),i.drawSprite(t,e,s)}itemAt(t,e){return this.cell(t,e).item}eachItem(t){this.cells.forEach((e=>{r.list.forEach(e.item,t)}))}async addItem(t,e,i){if(!this.hasXY(t,e))return!1;for(let s of this.layers)if(s&&await s.addItem(t,e,i))return!0;return!1}forceItem(t,e,i){if(!this.hasXY(t,e))return!1;for(let s of this.layers)if(s&&s.forceItem(t,e,i))return!0;return!1}async removeItem(t){return this.layers[t.depth].removeItem(t)}async moveItem(t,e,i){if(!this.hasXY(t,e))return!1;const s=this.layers[i.depth];return!!await s.removeItem(i)&&this.addItem(t,e,i)}hasPlayer(t,e){return this.cell(t,e).hasPlayer()}actorAt(t,e){return this.cell(t,e).actor}eachActor(t){this.cells.forEach((e=>{r.list.forEach(e.actor,t)}))}async addActor(t,e,i){if(!this.hasXY(t,e))return!1;for(let s of this.layers)if(s&&await s.addActor(t,e,i))return!0;return!1}forceActor(t,e,i){if(!this.hasXY(t,e))return!1;for(let s of this.layers)if(s&&s.forceActor(t,e,i))return!0;return!1}async removeActor(t){return this.layers[t.depth].removeActor(t)}async moveActor(t,e,i){if(!this.hasXY(t,e))return!1;const s=this.layers[i.depth];return!!await s.removeActor(i)&&this.addActor(t,e,i)}isVisible(t,e){return this.fov.isAnyKindOfVisible(t,e)}hasKey(t,e){if(!this.hasXY(t,e))return!1;return this.cells[t][e]._objects.some((i=>!!i.key&&i.key.matches(t,e)))}count(t){return this.cells.count(((e,i,s)=>t(e,i,s,this)))}dump(t,e=console.log){this.cells.dump(t||(t=>t.dump()),e)}hasMapFlag(t){return!!(this.flags.map&t)}setMapFlag(t){this.flags.map|=t}clearMapFlag(t){this.flags.map&=~t}setCellFlag(t,e,i){this.cell(t,e).setCellFlag(i)}clearCellFlag(t,e,i){this.cell(t,e).clearCellFlag(i)}fill(t,e){let i,s;for(t=$(t),e=$(e||t),i=0;i<this.width;++i)for(s=0;s<this.height;++s){const r=this.cell(i,s);r.clear(),r.setTile(this.isBoundaryXY(i,s)?e:t)}}hasTile(t,e,i,s=!1){return this.cellInfo(t,e,s).hasTile(i)}setTile(t,e,i,s){if(!(i instanceof Q||(i=$(i))))return!1;!0===s&&(s={superpriority:!0});const r=i.depth||0,l=this.layers[r]||this.layers[0];return l instanceof st&&l.setTile(t,e,i,s)}async tick(t){let e=await this.fireAll("tick");for(let i of this.layers)i&&await i.tick(t)&&(e=!0);return e}copy(t){if(this.constructor!==t.constructor)throw new Error("Maps must be same type to copy.");if(this.width!==t.width||this.height!==t.height)throw new Error("Maps must be same size to copy");this.cells.forEach(((e,i,s)=>{e.copy(t.cells[i][s])})),this.layers.forEach(((e,i)=>{e.copy(t.layers[i])})),this.flags.map=t.flags.map,this.light.setAmbient(t.light.getAmbient())}clone(){const t=new this.constructor(this.width,this.height);return t.copy(this),t}async fire(t,e,i,s={}){return this.cell(e,i).activate(t,this,e,i,s)}fireSync(t,e,i,s={}){return this.cell(e,i).activateSync(t,this,e,i,s)}async fireAll(t,e={}){const i=r.grid.alloc(this.width,this.height);return this.cells.forEach(((e,s,l)=>{e.clearCellFlag(T.EVENT_FIRED_THIS_TURN|T.EVENT_PROTECTED),e.eachTile((n=>{const h=n.effects[t];if(!h)return;const c=v(h);if(!c)return;let o=0;c.chance<0?(o=0,r.utils.eachNeighbor(s,l,((t,i)=>{const s=this.cell(t,i);s.hasEntityFlag(a.L_BLOCKS_EFFECTS)||s.depthTile(n.depth)==e.depthTile(n.depth)||s.hasCellFlag(T.CAUGHT_FIRE_THIS_TURN)||(o+=-1*c.chance)}),!0)):o=c.chance||1e4,!e.hasCellFlag(T.CAUGHT_FIRE_THIS_TURN)&&r.random.chance(o,1e4)&&(i[s][l]|=r.flag.fl(n.depth))}))})),e.force=!0,await i.forEachAsync((async(e,i,l)=>{if(!e)return;const a=this.cell(i,l);if(!a.hasCellFlag(T.EVENT_FIRED_THIS_TURN))for(let n=0;n<=s.GAS;++n)e&r.flag.fl(n)&&await a.activate(t,this,i,l,{force:!0,depth:n})})),r.grid.free(i),!1}fireAllSync(t,e={}){const i=r.grid.alloc(this.width,this.height);return this.cells.forEach(((e,s,l)=>{e.clearCellFlag(T.EVENT_FIRED_THIS_TURN|T.EVENT_PROTECTED),e.eachTile((n=>{const h=n.effects[t];if(!h)return;const c=v(h);if(!c)return;let o=0;c.chance<0?(o=0,r.utils.eachNeighbor(s,l,((t,i)=>{const s=this.cell(t,i);s.hasEntityFlag(a.L_BLOCKS_EFFECTS)||s.depthTile(n.depth)==e.depthTile(n.depth)||s.hasCellFlag(T.CAUGHT_FIRE_THIS_TURN)||(o+=-1*c.chance)}),!0)):o=c.chance||1e4,!e.hasCellFlag(T.CAUGHT_FIRE_THIS_TURN)&&r.random.chance(o,1e4)&&(i[s][l]|=r.flag.fl(n.depth))}))})),e.force=!0,i.forEach(((e,i,l)=>{if(!e)return;const a=this.cell(i,l);if(!a.hasCellFlag(T.EVENT_FIRED_THIS_TURN))for(let n=0;n<=s.GAS;++n)e&r.flag.fl(n)&&a.activate(t,this,i,l,{force:!0,depth:n})})),r.grid.free(i),!1}async activateMachine(t,e,i,s={}){let r=!1;s.originX=e,s.originY=i;for(let e=0;e<this.width;++e)for(let i=0;i<this.height;++i){const l=this.cells[e][i];l.machineId===t&&(l.hasEffect("machine")&&(r=await l.activate("machine",this,e,i,s)||r))}return r}activateMachineSync(t,e,i,s={}){let r=!1;s.originX=e,s.originY=i;for(let e=0;e<this.width;++e)for(let i=0;i<this.height;++i){const l=this.cells[e][i];l.machineId===t&&(l.hasEffect("machine")&&(r=l.activateSync("machine",this,e,i,s)||r))}return r}getAppearanceAt(t,e,i){i.blackOut();const s=this.cell(t,e),l=this.fov.isAnyKindOfVisible(t,e);if(s.needsRedraw&&l?(this.layers.forEach((s=>s.putAppearance(i,t,e))),i.dances?s.setCellFlag(T.COLORS_DANCE):s.clearCellFlag(T.COLORS_DANCE),i.bake(),this.memory[t][e].putSnapshot(i),s.needsRedraw=!1):this.memory[t][e].getSnapshot(i),l){const s=this.light.getLight(t,e);i.multiply(s)}else this.fov.isRevealed(t,e)?i.scale(50):i.blackOut();s.hasEntityFlag(a.L_VISUALLY_DISTINCT)&&r.color.separate(i.fg,i.bg)}hasActor(t,e){return this.cell(t,e).hasActor()}eachGlowLight(t){this.cells.forEach(((e,i,s)=>{e.eachGlowLight((e=>t(i,s,e)))}))}eachDynamicLight(t){}eachViewport(t){}lightingChanged(){return this.light.changed}hasVisibleLight(t,e){return!this.light.isDark(t,e)}blocksVision(t,e){return this.cell(t,e).blocksVision()}onCellRevealed(t,e){}redrawCell(t,e,i){i&&this.clearMemory(t,e),this.cells[t][e].needsRedraw=!0}clearMemory(t,e){this.memory[t][e].clear()}storeMemory(t,e){const i=this.cell(t,e);this.memory[t][e].store(i)}}function At(t,e,i={},s){"string"==typeof i&&(i={tile:i}),s&&(i.boundary=s),!0===i.tile&&(i.tile="FLOOR"),!0===i.boundary&&(i.boundary="WALL");const r=new St(t,e,i);return i.tile&&r.fill(i.tile,i.boundary),r.light.update(),r}function Lt(t,e){const i=r.grid.alloc(t.width,t.height),s=r.grid.alloc(t.width,t.height);for(let e=0;e<t.width;e++)for(let s=0;s<t.height;s++){const r=t.cell(e,s);!r.blocksPathing()&&!r.blocksMove()||r.hasEntityFlag(a.L_SECRETLY_PASSABLE)?i[e][s]=1:i[e][s]=0}let l;for(let e=1;e<i.width-1;e++)for(let s=1;s<i.height-1;s++)if(t.cell(e,s).flags.cell&=~T.IS_CHOKEPOINT,i[e][s]&&!(t.cell(e,s).flags.cell&T.IS_IN_LOOP)){l=0;for(let a=0;a<8;a++){const n=e+r.utils.CLOCK_DIRS[(a+7)%8][0],h=s+r.utils.CLOCK_DIRS[(a+7)%8][1],c=e+r.utils.CLOCK_DIRS[a][0],o=s+r.utils.CLOCK_DIRS[a][1];if((t.hasXY(c,o)&&i[c][o])!=(t.hasXY(n,h)&&i[n][h])&&++l>2){(i[e-1][s]||i[e+1][s])&&(i[e][s-1]||i[e][s+1])||(t.cell(e,s).flags.cell|=T.IS_CHOKEPOINT);break}}}if(e){for(let e=0;e<t.width;e++)for(let i=0;i<t.height;i++)t.cell(e,i).chokeCount=3e4;for(let e=0;e<t.width;e++)for(let l=0;l<t.height;l++){const a=t.cell(e,l);if(i[e][l]&&a.flags.cell&T.IS_CHOKEPOINT)for(let n=0;n<4;n++){const h=e+r.utils.DIRS[n][0],c=l+r.utils.DIRS[n][1];if(t.hasXY(h,c)&&i[h][c]&&!(t.cell(h,c).flags.cell&T.IS_CHOKEPOINT)){s.fill(0),i[e][l]=0;let r=It(t,s,i,h,c);if(i[e][l]=1,r>=4){for(let e=0;e<s.width;e++)for(let i=0;i<s.height;i++)s[e][i]&&r<t.cell(e,i).chokeCount&&(t.cell(e,i).chokeCount=r,t.cell(e,i).flags.cell&=~T.IS_GATE_SITE);r<a.chokeCount&&(a.chokeCount=r,a.flags.cell|=T.IS_GATE_SITE)}}}}}r.grid.free(i),r.grid.free(s)}function It(t,e,i,s,l){let a=2==i[s][l]?5e3:1;t.cell(s,l).flags.cell&T.IS_IN_AREA_MACHINE&&(a=1e4),e[s][l]=1;for(let n=0;n<4;n++){const h=s+r.utils.DIRS[n][0],c=l+r.utils.DIRS[n][1];t.hasXY(h,c)&&i[h][c]&&!e[h][c]&&(a+=It(t,e,i,h,c))}return Math.min(a,1e4)}function dt(t){t.eachCell(Rt),t.eachCell(pt),mt(t)}function Rt(t,e,i,s){!t.blocksPathing()&&!t.blocksMove()||t.hasEntityFlag(a.L_SECRETLY_PASSABLE)?t.flags.cell|=T.IS_IN_LOOP:t.flags.cell&=~T.IS_IN_LOOP}function pt(t,e,i,s){let l,a,n,h,c,o,_,E;if(!(t&&t.flags.cell&T.IS_IN_LOOP))return!1;for(c=0;c<8;c++){if(a=e+r.utils.CLOCK_DIRS[c][0],n=i+r.utils.CLOCK_DIRS[c][1],!s.hasXY(a,n))continue;const t=s.get(a,n);if(!(t&&t.flags.cell&T.IS_IN_LOOP))break}if(8==c)return!1;for(o=_=E=0,l=!1,h=c;h<c+8;h++){if(a=e+r.utils.CLOCK_DIRS[h%8][0],n=i+r.utils.CLOCK_DIRS[h%8][1],!s.hasXY(a,n))continue;const t=s.get(a,n);if(t&&t.flags.cell&T.IS_IN_LOOP){if(E++,!l){if(o>0)return!1;o++,l=!0}}else l&&(E>_&&(_=E),E=0,l=!1)}if(l&&E>_&&(_=E),1==o&&_<=4){for(t.flags.cell&=~T.IS_IN_LOOP,h=0;h<8;h++){const t=e+r.utils.CLOCK_DIRS[h][0],l=i+r.utils.CLOCK_DIRS[h][1];if(s.hasXY(t,l)){pt(s.cell(t,l),t,l,s)}}return!0}return!1}function Ot(t,e){for(let i=0;i<t.width;++i)for(let s=0;s<t.height;++s){if(t.cell(i,s).flags.cell&T.IS_IN_LOOP)e[i][s]=1;else if(i>0&&s>0){const r=t.cell(i,s-1),l=t.cell(i-1,s);r.flags.cell&T.IS_IN_LOOP&&l.flags.cell&T.IS_IN_LOOP&&(e[i][s]=1)}}}function mt(t){const e=r.grid.alloc(t.width,t.height);let i;Ot(t,e);for(let s=0;s<e.width;s++)for(let l=0;l<e.height;l++){if(t.cell(s,l).flags.cell&T.IS_IN_LOOP){i=!1;for(let a=0;a<8;a++){let n=s+r.utils.CLOCK_DIRS[a][0],h=l+r.utils.CLOCK_DIRS[a][1];if(t.hasXY(n,h)&&!e[n][h]&&!(t.cell(n,h).flags.cell&T.IS_IN_LOOP)){i=!0;break}}i||(e[s][l]=1,t.cell(s,l).flags.cell&=~T.IS_IN_LOOP)}}r.grid.free(e)}class Ct{make(t,e){var i,s,l,a,n,h,c;if(!t.tile)return!0;let o=t.tile;if("string"==typeof o){const t=o.split(/[,|]/).map((t=>t.trim()));o={tile:t[0],grow:Number.parseInt(t[1]||"0"),decrement:Number.parseInt(t[2]||"0")}}const _={grow:null!==(s=null!==(i=o.grow)&&void 0!==i?i:o.spread)&&void 0!==s?s:0,decrement:null!==(l=o.decrement)&&void 0!==l?l:0,flags:r.flag.from(w,o.flags),volume:null!==(a=o.volume)&&void 0!==a?a:0,next:null!==(n=o.next)&&void 0!==n?n:null},E=null!==(h=o.tile)&&void 0!==h?h:o.id;if("string"!=typeof E)throw new Error("Invalid tile spawn config: "+E);if(_.tile=E,!_.tile)throw new Error("Must have tile.");const f=null!==(c=o.matchTile)&&void 0!==c?c:o.match;if("string"==typeof f)_.matchTile=f;else if(f)throw new Error("Invalid tile spawn match tile: "+o.matchTile);return e.tile=_,!0}async fire(t,e,i,s,r){let l=!1;return this.fireSync(t,e,i,s,r)&&(l=!0),l}fireSync(t,e,i,s,r){if(!t.tile)return!1;const l=t.tile.tile,a=z[l]||null;if(!a)throw new Error("Failed to find tile for effect: "+l);const n=!!(t.flags&w.E_ABORT_IF_BLOCKS_MAP),h=!(!n||t.flags&w.E_PERMIT_BLOCKING||!(a.blocksPathing()||t.flags&w.E_TREAT_AS_BLOCKING));let c=!1;if(c=Dt(t,e,i,s,r),!c)return!1;if(n&&h&&this.mapDisruptedBy(e,t.grid))return!1;t.flags&w.E_EVACUATE_CREATURES&&Mt(e,r.grid)&&(c=!0),t.flags&w.E_EVACUATE_ITEMS&&Pt(e,r.grid)&&(c=!0),t.flags&w.E_CLEAR_CELL&&Ft(e,r.grid,t.flags)&&(c=!0);return yt(t.flags,r.grid,e,a,t.tile.volume,r.machine)}mapDisruptedBy(t,e,i=0,s=0){const l=r.grid.alloc(t.width,t.height);let a=!1;r.utils.forRect(t.width,t.height,((r,n)=>{const h=r+i,c=n+s;e.get(h,c)?t.cellInfo(r,n).isStairs()&&(a=!0):t.cellInfo(r,n).blocksMove()||(l[r][n]=1)}));let n=!0;for(let t=0;t<l.width&&!a;++t)for(let e=0;e<l.height&&!a;++e)1==l[t][e]&&(n?(l.floodFill(t,e,1,2),n=!1):a=!0);return r.grid.free(l),a}}function yt(t,e,i,s,r=0,l){let a,n,h;h=!1;const c=!!(t&w.E_BLOCKED_BY_OTHER_LAYERS),o=!!(t&w.E_SUPERPRIORITY),_=!!(t&w.E_BLOCKED_BY_ACTORS),E=!!(t&w.E_BLOCKED_BY_ITEMS);for(r=r||0,a=0;a<e.width;a++)for(n=0;n<e.height;n++){if(!e[a][n])continue;e[a][n]=0;const f=i.cell(a,n);f.hasTile(s)||i.setTile(a,n,s,{volume:r,superpriority:o,blockedByOtherLayers:c,blockedByActors:_,blockedByItems:E,machine:l})&&(e[a][n]=1,f.flags.cell|=T.EVENT_FIRED_THIS_TURN,t&w.E_PROTECTED&&(f.flags.cell|=T.EVENT_PROTECTED),h=!0)}return h&&i.setMapFlag(S.MAP_CHANGED),h}function Nt(t,e,i,s,l){if(!e.hasXY(i,s))return!1;const a=e.cell(i,s);if(a.hasCellFlag(T.EVENT_PROTECTED))return!1;if(a.blocksEffects()&&!t.tile.matchTile&&!l)return!1;if(t.flags&w.E_BUILD_IN_WALLS){if(!e.cellInfo(i,s).isWall())return!1}else if(t.flags&w.E_MUST_TOUCH_WALLS){let t=!1;if(r.utils.eachNeighbor(i,s,((i,s)=>{e.cellInfo(i,s).isWall()&&(t=!0)}),!0),!t)return!1}else if(t.flags&w.E_NO_TOUCH_WALLS){let t=!0;if(e.cellInfo(i,s).isWall())return!1;if(r.utils.eachNeighbor(i,s,((i,s)=>{e.cellInfo(i,s).isWall()&&(t=!1)}),!0),!t)return!1}return!(t.tile.matchTile&&!l&&!a.hasTile(t.tile.matchTile))}function Dt(t,e,i,s,l){let a,n,h,c,o,_,E;const f=t.tile;let u=f.grow||0,T=f.decrement||0;const g=l.grid;if(g.fill(0),!Nt(t,e,i,s,!0))return!1;g[i][s]=c=1;let S=1;if(u)for(E=!0,u>=100&&(T=T||100),T<=0&&(T=u);E&&u>0;){for(E=!1,c++,a=0;a<e.width;a++)for(n=0;n<e.height;n++)if(g[a][n]==c-1)for(h=0;h<4;h++)o=a+r.utils.DIRS[h][0],_=n+r.utils.DIRS[h][1],g.hasXY(o,_)&&!g[o][_]&&r.random.chance(u)&&Nt(t,e,o,_,!1)&&(g[o][_]=c,E=!0,++S);u-=T}return S>0}function Ft(t,e,i=0){let r=!1;const l=(i&w.E_CLEAR_CELL)===w.E_CLEAR_CELL;return e.forEach(((e,a,n)=>{if(!e)return;const h=t.cell(a,n);l?h.clear():(i&w.E_CLEAR_GAS&&h.clearDepth(s.GAS),i&w.E_CLEAR_LIQUID&&h.clearDepth(s.LIQUID),i&w.E_CLEAR_SURFACE&&h.clearDepth(s.SURFACE),i&w.E_CLEAR_GROUND&&h.clearDepth(s.GROUND)),r=!0})),r}function Mt(t,e){let i=0,s=0,l=!1;for(i=0;i<t.width;i++)for(s=0;s<t.height;s++){if(!e[i][s])continue;const a=t.cell(i,s);a.hasActor()&&r.list.forEach(a.actor,(a=>{if(!(a instanceof p))return;const n=a,h=r.random.matchingLocNear(i,s,((i,s)=>{if(!t.hasXY(i,s))return!1;if(e[i][s])return!1;const r=t.cell(i,s);return!n.forbidsCell(r)}));h&&h[0]>=0&&h[1]>=0&&(t.moveActor(h[0],h[1],n),l=!0)}))}return l}function Pt(t,e){let i=!1;return e.forEach(((s,l,a)=>{if(!s)return;const n=t.cell(l,a);n.hasItem()&&r.list.forEach(n.item,(s=>{if(!(s instanceof F))return;const n=s,h=r.random.matchingLocNear(l,a,((i,s)=>{if(!t.hasXY(i,s))return!1;if(e[i][s])return!1;const r=t.cell(i,s);return!n.forbidsCell(r)}));h&&h[0]>=0&&h[1]>=0&&(t.moveItem(h[0],h[1],n),i=!0)}))})),i}K("tile",new Ct);K("clear",new class{make(t,e){if(!t.clear)return!0;let i=t.clear,r=0;if("string"==typeof i&&(i=i.split(/[,|]/).map((t=>t.trim()))),!0===i)r=s.ALL_LAYERS;else if("number"==typeof i)r=i;else{if(!Array.isArray(i))throw new Error("clear effect must have number or string config.");r=i.reduce(((t,e)=>{if("number"==typeof e)return t|e;return t|(s[e]||0)}),0)}return e.clear=r,r>0}fire(t,e,i,s,r){return this.fireSync(t,e,i,s,r)}fireSync(t,e,i,s,r){if(!t.clear)return!1;if(!e)return!1;return e.cell(i,s).clearDepth(t.clear)}});var wt={__proto__:null,Cell:Tt,Map:St,make:At,from:function(t,e,i={}){let s,r=0,l=0;return"string"==typeof t&&(t=t.split("\n")),!function(t){return Array.isArray(t)&&"string"==typeof t[0]}(t)?(r=t.height,l=t.width,s=At(l,r,i),t.forEach(((t,i,r)=>{const l=e[t]||"FLOOR";s.setTile(i,r,l)}))):(r=t.length,l=t.reduce(((t,e)=>Math.max(t,e.length)),0),s=At(l,r,i),t.forEach(((t,i)=>{for(let r=0;r<l;++r){const l=t[r]||".",a=e[l]||"FLOOR";s.setTile(r,i,a)}}))),s.light.update(),s},analyze:function(t,e=!0){dt(t),Lt(t,e)},updateChokepoints:Lt,floodFillCount:It,updateLoopiness:dt,resetLoopiness:Rt,checkLoopiness:pt,fillInnerLoopGrid:Ot,cleanLoopiness:mt,SpawnEffect:Ct,spawnTiles:yt,computeSpawnMap:Dt,clearCells:Ft,evacuateCreatures:Mt,evacuateItems:Pt,CellMemory:gt};t.actor=O,t.effect=j,t.entity=R,t.flags=A,t.item=M,t.layer=ft,t.map=wt,t.tile=et,Object.defineProperty(t,"__esModule",{value:!0})}));
//# sourceMappingURL=gw-map.min.js.map
