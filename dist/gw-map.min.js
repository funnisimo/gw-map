!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("gw-utils")):"function"==typeof define&&define.amd?define(["exports","gw-utils"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).GWM={},e.GWU)}(this,(function(e,t){"use strict";function i(e){if(e&&e.__esModule)return e;var t=Object.create(null);return e&&Object.keys(e).forEach((function(i){if("default"!==i){var s=Object.getOwnPropertyDescriptor(e,i);Object.defineProperty(t,i,s.get?s:{enumerable:!0,get:function(){return e[i]}})}})),t.default=e,Object.freeze(t)}var s,r=i(t);!function(e){e[e.ALL_LAYERS=-1]="ALL_LAYERS",e[e.GROUND=0]="GROUND",e[e.SURFACE=1]="SURFACE",e[e.ITEM=2]="ITEM",e[e.ACTOR=3]="ACTOR",e[e.LIQUID=4]="LIQUID",e[e.GAS=5]="GAS",e[e.FX=6]="FX",e[e.UI=7]="UI"}(s||(s={}));const l=r.flag.fl;var a;!function(e){e[e.L_DESTROYED=l(1)]="L_DESTROYED",e[e.L_SECRETLY_PASSABLE=l(2)]="L_SECRETLY_PASSABLE",e[e.L_BLOCKS_MOVE=l(3)]="L_BLOCKS_MOVE",e[e.L_BLOCKS_VISION=l(4)]="L_BLOCKS_VISION",e[e.L_BLOCKS_SURFACE=l(6)]="L_BLOCKS_SURFACE",e[e.L_BLOCKS_LIQUID=l(8)]="L_BLOCKS_LIQUID",e[e.L_BLOCKS_GAS=l(7)]="L_BLOCKS_GAS",e[e.L_BLOCKS_ITEMS=l(5)]="L_BLOCKS_ITEMS",e[e.L_BLOCKS_ACTORS=l(11)]="L_BLOCKS_ACTORS",e[e.L_BLOCKS_EFFECTS=l(9)]="L_BLOCKS_EFFECTS",e[e.L_BLOCKS_DIAGONAL=l(10)]="L_BLOCKS_DIAGONAL",e[e.L_INTERRUPT_WHEN_SEEN=l(12)]="L_INTERRUPT_WHEN_SEEN",e[e.L_LIST_IN_SIDEBAR=l(13)]="L_LIST_IN_SIDEBAR",e[e.L_VISUALLY_DISTINCT=l(14)]="L_VISUALLY_DISTINCT",e[e.L_BRIGHT_MEMORY=l(15)]="L_BRIGHT_MEMORY",e[e.L_INVERT_WHEN_HIGHLIGHTED=l(16)]="L_INVERT_WHEN_HIGHLIGHTED",e[e.L_BLOCKED_BY_STAIRS=e.L_BLOCKS_ITEMS|e.L_BLOCKS_SURFACE|e.L_BLOCKS_GAS|e.L_BLOCKS_LIQUID|e.L_BLOCKS_EFFECTS|e.L_BLOCKS_ACTORS]="L_BLOCKED_BY_STAIRS",e[e.L_BLOCKS_SCENT=e.L_BLOCKS_MOVE|e.L_BLOCKS_VISION]="L_BLOCKS_SCENT",e[e.L_DIVIDES_LEVEL=e.L_BLOCKS_MOVE]="L_DIVIDES_LEVEL",e[e.L_WAYPOINT_BLOCKER=e.L_BLOCKS_MOVE]="L_WAYPOINT_BLOCKER",e[e.L_WALL_FLAGS=e.L_BLOCKS_MOVE|e.L_BLOCKS_VISION|e.L_BLOCKS_LIQUID|e.L_BLOCKS_GAS|e.L_BLOCKS_EFFECTS|e.L_BLOCKS_DIAGONAL]="L_WALL_FLAGS",e[e.L_BLOCKS_EVERYTHING=e.L_WALL_FLAGS|e.L_BLOCKS_ITEMS|e.L_BLOCKS_ACTORS|e.L_BLOCKS_SURFACE]="L_BLOCKS_EVERYTHING"}(a||(a={}));const n=r.flag.fl;var o,h;!function(e){e[e.IS_PLAYER=n(0)]="IS_PLAYER"}(o||(o={})),h||(h={});const c=r.flag.fl;var _;!function(e){e[e.T_BRIDGE=c(0)]="T_BRIDGE",e[e.T_AUTO_DESCENT=c(1)]="T_AUTO_DESCENT",e[e.T_LAVA=c(2)]="T_LAVA",e[e.T_DEEP_WATER=c(3)]="T_DEEP_WATER",e[e.T_IS_FLAMMABLE=c(5)]="T_IS_FLAMMABLE",e[e.T_SPONTANEOUSLY_IGNITES=c(6)]="T_SPONTANEOUSLY_IGNITES",e[e.T_IS_FIRE=c(7)]="T_IS_FIRE",e[e.T_EXTINGUISHES_FIRE=c(8)]="T_EXTINGUISHES_FIRE",e[e.T_IS_SECRET=c(9)]="T_IS_SECRET",e[e.T_IS_TRAP=c(10)]="T_IS_TRAP",e[e.T_SACRED=c(11)]="T_SACRED",e[e.T_UP_STAIRS=c(12)]="T_UP_STAIRS",e[e.T_DOWN_STAIRS=c(13)]="T_DOWN_STAIRS",e[e.T_PORTAL=c(14)]="T_PORTAL",e[e.T_IS_DOOR=c(15)]="T_IS_DOOR",e[e.T_ALLOWS_SUBMERGING=c(16)]="T_ALLOWS_SUBMERGING",e[e.T_ENTANGLES=c(17)]="T_ENTANGLES",e[e.T_REFLECTS=c(18)]="T_REFLECTS",e[e.T_STAND_IN_TILE=c(19)]="T_STAND_IN_TILE",e[e.T_CONNECTS_LEVEL=c(20)]="T_CONNECTS_LEVEL",e[e.T_BLOCKS_OTHER_LAYERS=c(21)]="T_BLOCKS_OTHER_LAYERS",e[e.T_HAS_STAIRS=e.T_UP_STAIRS|e.T_DOWN_STAIRS|e.T_PORTAL]="T_HAS_STAIRS",e[e.T_OBSTRUCTS_SCENT=e.T_AUTO_DESCENT|e.T_LAVA|e.T_DEEP_WATER|e.T_SPONTANEOUSLY_IGNITES|e.T_HAS_STAIRS]="T_OBSTRUCTS_SCENT",e[e.T_PATHING_BLOCKER=e.T_AUTO_DESCENT|e.T_IS_TRAP|e.T_LAVA|e.T_DEEP_WATER|e.T_IS_FIRE|e.T_SPONTANEOUSLY_IGNITES|e.T_ENTANGLES]="T_PATHING_BLOCKER",e[e.T_LAKE_PATHING_BLOCKER=e.T_AUTO_DESCENT|e.T_LAVA|e.T_DEEP_WATER|e.T_SPONTANEOUSLY_IGNITES]="T_LAKE_PATHING_BLOCKER",e[e.T_WAYPOINT_BLOCKER=e.T_AUTO_DESCENT|e.T_IS_TRAP|e.T_LAVA|e.T_DEEP_WATER|e.T_SPONTANEOUSLY_IGNITES]="T_WAYPOINT_BLOCKER",e[e.T_DIVIDES_LEVEL=e.T_AUTO_DESCENT|e.T_IS_TRAP|e.T_LAVA|e.T_DEEP_WATER]="T_DIVIDES_LEVEL",e[e.T_MOVES_ITEMS=e.T_DEEP_WATER|e.T_LAVA]="T_MOVES_ITEMS",e[e.T_CAN_BE_BRIDGED=e.T_AUTO_DESCENT|e.T_LAVA|e.T_DEEP_WATER]="T_CAN_BE_BRIDGED",e[e.T_IS_DEEP_LIQUID=e.T_LAVA|e.T_AUTO_DESCENT|e.T_DEEP_WATER]="T_IS_DEEP_LIQUID"}(_||(_={}));const f=r.flag.fl;var E;!function(e){e[e.TM_IS_WIRED=f(9)]="TM_IS_WIRED",e[e.TM_IS_CIRCUIT_BREAKER=f(10)]="TM_IS_CIRCUIT_BREAKER",e[e.TM_VANISHES_UPON_PROMOTION=f(15)]="TM_VANISHES_UPON_PROMOTION",e[e.TM_EXPLOSIVE_PROMOTE=f(21)]="TM_EXPLOSIVE_PROMOTE",e[e.TM_SWAP_ENCHANTS_ACTIVATION=f(25)]="TM_SWAP_ENCHANTS_ACTIVATION"}(E||(E={}));const g=r.flag.fl;var u;!function(e){e[e.SEARCHED_FROM_HERE=g(0)]="SEARCHED_FROM_HERE",e[e.PRESSURE_PLATE_DEPRESSED=g(1)]="PRESSURE_PLATE_DEPRESSED",e[e.KNOWN_TO_BE_TRAP_FREE=g(2)]="KNOWN_TO_BE_TRAP_FREE",e[e.CAUGHT_FIRE_THIS_TURN=g(3)]="CAUGHT_FIRE_THIS_TURN",e[e.EVENT_FIRED_THIS_TURN=g(4)]="EVENT_FIRED_THIS_TURN",e[e.EVENT_PROTECTED=g(5)]="EVENT_PROTECTED",e[e.IS_IN_LOOP=g(6)]="IS_IN_LOOP",e[e.IS_CHOKEPOINT=g(7)]="IS_CHOKEPOINT",e[e.IS_GATE_SITE=g(8)]="IS_GATE_SITE",e[e.IS_IN_ROOM_MACHINE=g(9)]="IS_IN_ROOM_MACHINE",e[e.IS_IN_AREA_MACHINE=g(10)]="IS_IN_AREA_MACHINE",e[e.IMPREGNABLE=g(11)]="IMPREGNABLE",e[e.NEEDS_REDRAW=g(13)]="NEEDS_REDRAW",e[e.STABLE_MEMORY=g(14)]="STABLE_MEMORY",e[e.STABLE_SNAPSHOT=g(15)]="STABLE_SNAPSHOT",e[e.HAS_SURFACE=g(16)]="HAS_SURFACE",e[e.HAS_LIQUID=g(17)]="HAS_LIQUID",e[e.HAS_GAS=g(18)]="HAS_GAS",e[e.HAS_PLAYER=g(19)]="HAS_PLAYER",e[e.HAS_ACTOR=g(20)]="HAS_ACTOR",e[e.HAS_DORMANT_MONSTER=g(21)]="HAS_DORMANT_MONSTER",e[e.HAS_ITEM=g(22)]="HAS_ITEM",e[e.IS_IN_PATH=g(23)]="IS_IN_PATH",e[e.IS_CURSOR=g(24)]="IS_CURSOR",e[e.IS_WIRED=g(26)]="IS_WIRED",e[e.IS_CIRCUIT_BREAKER=g(27)]="IS_CIRCUIT_BREAKER",e[e.IS_POWERED=g(28)]="IS_POWERED",e[e.COLORS_DANCE=g(30)]="COLORS_DANCE",e[e.CHANGED=e.NEEDS_REDRAW]="CHANGED",e[e.IS_IN_MACHINE=e.IS_IN_ROOM_MACHINE|e.IS_IN_AREA_MACHINE]="IS_IN_MACHINE",e[e.PERMANENT_CELL_FLAGS=e.HAS_ITEM|e.HAS_DORMANT_MONSTER|e.STABLE_MEMORY|e.SEARCHED_FROM_HERE|e.PRESSURE_PLATE_DEPRESSED|e.KNOWN_TO_BE_TRAP_FREE|e.IS_IN_LOOP|e.IS_CHOKEPOINT|e.IS_GATE_SITE|e.IS_IN_MACHINE|e.IMPREGNABLE]="PERMANENT_CELL_FLAGS",e[e.HAS_ANY_ACTOR=e.HAS_PLAYER|e.HAS_ACTOR]="HAS_ANY_ACTOR",e[e.HAS_ANY_OBJECT=e.HAS_ITEM|e.HAS_ANY_ACTOR]="HAS_ANY_OBJECT",e[e.CELL_DEFAULT=e.NEEDS_REDRAW]="CELL_DEFAULT"}(u||(u={}));const T=r.flag.fl;var S;!function(e){e[e.MAP_CHANGED=T(0)]="MAP_CHANGED",e[e.MAP_ALWAYS_LIT=T(3)]="MAP_ALWAYS_LIT",e[e.MAP_SAW_WELCOME=T(4)]="MAP_SAW_WELCOME",e[e.MAP_NO_LIQUID=T(5)]="MAP_NO_LIQUID",e[e.MAP_NO_GAS=T(6)]="MAP_NO_GAS",e[e.MAP_CALC_FOV=T(7)]="MAP_CALC_FOV",e[e.MAP_FOV_CHANGED=T(8)]="MAP_FOV_CHANGED",e[e.MAP_DANCES=T(9)]="MAP_DANCES",e[e.MAP_SIDEBAR_TILES_CHANGED=T(10)]="MAP_SIDEBAR_TILES_CHANGED",e[e.MAP_DEFAULT=0]="MAP_DEFAULT"}(S||(S={}));const A=r.flag.fl;var d;!function(e){e[e.E_NEXT_ALWAYS=A(0)]="E_NEXT_ALWAYS",e[e.E_NEXT_EVERYWHERE=A(1)]="E_NEXT_EVERYWHERE",e[e.E_FIRED=A(2)]="E_FIRED",e[e.E_NO_MARK_FIRED=A(3)]="E_NO_MARK_FIRED",e[e.E_PROTECTED=A(4)]="E_PROTECTED",e[e.E_TREAT_AS_BLOCKING=A(5)]="E_TREAT_AS_BLOCKING",e[e.E_PERMIT_BLOCKING=A(6)]="E_PERMIT_BLOCKING",e[e.E_ABORT_IF_BLOCKS_MAP=A(7)]="E_ABORT_IF_BLOCKS_MAP",e[e.E_BLOCKED_BY_ITEMS=A(8)]="E_BLOCKED_BY_ITEMS",e[e.E_BLOCKED_BY_ACTORS=A(9)]="E_BLOCKED_BY_ACTORS",e[e.E_BLOCKED_BY_OTHER_LAYERS=A(10)]="E_BLOCKED_BY_OTHER_LAYERS",e[e.E_SUPERPRIORITY=A(11)]="E_SUPERPRIORITY",e[e.E_SPREAD_CIRCLE=A(13)]="E_SPREAD_CIRCLE",e[e.E_SPREAD_LINE=A(14)]="E_SPREAD_LINE",e[e.E_EVACUATE_CREATURES=A(15)]="E_EVACUATE_CREATURES",e[e.E_EVACUATE_ITEMS=A(16)]="E_EVACUATE_ITEMS",e[e.E_BUILD_IN_WALLS=A(17)]="E_BUILD_IN_WALLS",e[e.E_MUST_TOUCH_WALLS=A(18)]="E_MUST_TOUCH_WALLS",e[e.E_NO_TOUCH_WALLS=A(19)]="E_NO_TOUCH_WALLS",e[e.E_CLEAR_GROUND=A(21)]="E_CLEAR_GROUND",e[e.E_CLEAR_SURFACE=A(22)]="E_CLEAR_SURFACE",e[e.E_CLEAR_LIQUID=A(23)]="E_CLEAR_LIQUID",e[e.E_CLEAR_GAS=A(24)]="E_CLEAR_GAS",e[e.E_CLEAR_TILE=A(25)]="E_CLEAR_TILE",e[e.E_CLEAR_CELL=e.E_CLEAR_GROUND|e.E_CLEAR_SURFACE|e.E_CLEAR_LIQUID|e.E_CLEAR_GAS]="E_CLEAR_CELL",e[e.E_ONLY_IF_EMPTY=e.E_BLOCKED_BY_ITEMS|e.E_BLOCKED_BY_ACTORS]="E_ONLY_IF_EMPTY",e[e.E_ACTIVATE_DORMANT_MONSTER=A(27)]="E_ACTIVATE_DORMANT_MONSTER",e[e.E_AGGRAVATES_MONSTERS=A(28)]="E_AGGRAVATES_MONSTERS",e[e.E_RESURRECT_ALLY=A(29)]="E_RESURRECT_ALLY"}(d||(d={}));const L=r.flag.fl;var p;!function(e){e[e.HORDE_DIES_ON_LEADER_DEATH=L(0)]="HORDE_DIES_ON_LEADER_DEATH",e[e.HORDE_IS_SUMMONED=L(1)]="HORDE_IS_SUMMONED",e[e.HORDE_SUMMONED_AT_DISTANCE=L(2)]="HORDE_SUMMONED_AT_DISTANCE",e[e.HORDE_NO_PERIODIC_SPAWN=L(4)]="HORDE_NO_PERIODIC_SPAWN",e[e.HORDE_ALLIED_WITH_PLAYER=L(5)]="HORDE_ALLIED_WITH_PLAYER",e[e.HORDE_NEVER_OOD=L(15)]="HORDE_NEVER_OOD"}(p||(p={}));var m=Object.freeze({__proto__:null,get Depth(){return s},get Entity(){return a},get Actor(){return o},get Item(){return h},get Tile(){return _},get TileMech(){return E},get Cell(){return u},get Map(){return S},get Effect(){return d},get Horde(){return p}});class I{constructor(e,t,i){this.x=e,this.y=t,this.disposable=i}matches(e,t){return this.x===e&&this.y===t}}class O{constructor(e){this.map=null,this.key=null,this.machineHome=0,this.lastSeen=null,this.depth=1,this.light=null,this.flags={entity:0},this.next=null,this.x=-1,this.y=-1,this.kind=e}get sprite(){return this.kind.sprite}get isDestroyed(){return this.hasEntityFlag(a.L_DESTROYED)}canBeSeen(){return this.kind.canBeSeen(this)}destroy(){this.flags.entity|=a.L_DESTROYED}hasEntityFlag(e){return!!(this.flags.entity&e)}hasAllEntityFlags(e){return(this.flags.entity&e)===e}hasTag(e){return this.kind.tags.includes(e)}blocksMove(){return this.hasEntityFlag(a.L_BLOCKS_MOVE)}blocksVision(){return this.hasEntityFlag(a.L_BLOCKS_VISION)}blocksPathing(){return this.hasEntityFlag(a.L_BLOCKS_MOVE)}blocksEffects(){return this.hasEntityFlag(a.L_BLOCKS_EFFECTS)}forbidsCell(e){return this.kind.forbidsCell(e,this)}avoidsCell(e){return this.kind.avoidsCell(e,this)}getName(e){return this.kind.getName(this,e)}getDescription(e){return this.kind.getDescription(this,e)}getFlavor(e){return this.kind.getFlavor(this,e)}getVerb(e){return this.kind.getVerb(this,e)}}class R{constructor(e){this.tags=[],this.requiredTileTags=[],this.id=e.id||e.name,this.name=e.name,this.flavor=e.flavor||this.name,this.description=e.description||this.flavor,this.sprite=r.sprite.make(e),e.tags&&("string"==typeof e.tags?this.tags=e.tags.split(/[,|]/).map((e=>e.trim())):this.tags=e.tags.slice()),e.requiredTileTags&&("string"==typeof e.requiredTileTags?this.requiredTileTags=e.requiredTileTags.split(/[,|]/).map((e=>e.trim())):this.requiredTileTags=e.requiredTileTags.slice().map((e=>e.trim())))}make(e){const t=new O(this);return this.init(t,e),t}init(e,t={}){t.machineHome&&(e.machineHome=t.machineHome)}canBeSeen(e){return!0}forbidsCell(e,t){return!(!this.requiredTileTags.length||e.hasAllTileTags(this.requiredTileTags))}avoidsCell(e,t){return!(!this.requiredTileTags.length||e.hasAnyTileTag(this.requiredTileTags))}getName(e,t){return this.name}getDescription(e,t){return this.description}getFlavor(e,t){return this.flavor}getVerb(e,t){return t}}var y=Object.freeze({__proto__:null,KeyInfo:I,makeKeyInfo:function(e,t,i){return new I(e,t,i)},EntityKind:R,Entity:O});class C extends O{constructor(e){super(e),this.next=null,this.leader=null,this.items=null,this.flags.actor=0,this.depth=s.ACTOR,this.kind=e}hasActorFlag(e){return!!(this.flags.actor&e)}hasAllActorFlags(e){return(this.flags.actor&e)===e}actorFlags(){return this.flags.actor}isPlayer(){return this.hasActorFlag(o.IS_PLAYER)}async pickupItem(e,t){return this.kind.pickupItem(this,e,t)}async dropItem(e,t){return this.kind.dropItem(this,e,t)}}class N extends R{constructor(e){super(e)}make(e){const t=new C(this);return this.init(t,e),t}init(e,t={}){super.init(e,t)}forbidsCell(e,t){return!!super.forbidsCell(e,t)||!!e.blocksMove()}avoidsCell(e,t){return!!super.avoidsCell(e,t)||(!!e.blocksMove()||!!e.blocksPathing())}getFlavor(e,t){const i=e.isPlayer()?"yourself":this.flavor;return t&&t.action?i+" standing":i}async pickupItem(e,t,i){return!!r.list.push(e,"items",t)}async dropItem(e,t,i){return!!r.list.remove(e,"items",t)}}function D(e,t){const i=F(e);if(!i)throw new Error("Failed to find item kind - "+e);return i.make(t)}const M={};function F(e){return e instanceof N?e:M[e]}function v(e){const t=Object.assign({},e);return new N(t)}function P(e={}){const t={tags:[],forbidTags:[]};"string"==typeof e&&(e={tags:e}),"string"==typeof e.tags?e.tags.split(/[,|&]/).map((e=>e.trim())).forEach((e=>{e.startsWith("!")?t.forbidTags.push(e.substring(1).trim()):t.tags.push(e)})):Array.isArray(e.tags)&&(t.tags=e.tags.slice()),"string"==typeof e.forbidTags?t.forbidTags=e.forbidTags.split(/[,|&]/).map((e=>e.trim())):Array.isArray(e.forbidTags)&&(t.forbidTags=e.forbidTags.slice());const i=Object.values(M).filter((e=>!(t.tags.length&&!r.arraysIntersect(t.tags,e.tags))&&(!t.forbidTags||!r.arraysIntersect(t.forbidTags,e.tags))));return(e.rng||r.rng.random).item(i)||null}var w=Object.freeze({__proto__:null,ActorKind:N,Actor:C,make:D,makeRandom:function(e,t){const i=P(e);if(!i)throw new Error("Failed to find item kind matching - "+JSON.stringify(e));return i.make(t)},from:function(e,t){let i;if("string"==typeof e){if(i=F(e),!i)throw new Error("Failed to find item kind - "+e)}else i=e instanceof N?e:v(e);return i.make(t)},kinds:M,install:function(e,t){if(t instanceof N)return M[e]=t,t;const i=v(t);return i.id=e,M[e]=i,i},get:F,makeKind:v,randomKind:P});class b extends O{constructor(e){super(e),this.quantity=1,this.next=null,this.flags.item=0,this.depth=s.ITEM,this.kind=e}itemFlags(){return this.flags.item}hasItemFlag(e){return!!(this.flags.item&e)}hasAllItemFlags(e){return(this.flags.item&e)===e}}class B extends R{constructor(e){super(e)}make(e){const t=new b(this);return this.init(t,e),t}init(e,t={}){super.init(e,t)}}const H={};function k(e){return e instanceof B?e:H[e]}function U(e){const t=Object.assign({},e);return new B(t)}function K(e={}){const t={tags:[],forbidTags:[]};"string"==typeof e&&(e={tags:e}),"string"==typeof e.tags?e.tags.split(/[,|&]/).map((e=>e.trim())).forEach((e=>{e.startsWith("!")?t.forbidTags.push(e.substring(1).trim()):t.tags.push(e)})):Array.isArray(e.tags)&&(t.tags=e.tags.slice()),"string"==typeof e.forbidTags?t.forbidTags=e.forbidTags.split(/[,|&]/).map((e=>e.trim())):Array.isArray(e.forbidTags)&&(t.forbidTags=e.forbidTags.slice());const i=Object.values(H).filter((e=>!(t.tags.length&&!r.arraysIntersect(t.tags,e.tags))&&(!t.forbidTags||!r.arraysIntersect(t.forbidTags,e.tags))));return(e.rng||r.rng.random).item(i)||null}var V=Object.freeze({__proto__:null,ItemKind:B,Item:b,make:function(e,t){const i=k(e);if(!i)throw new Error("Failed to find item kind - "+e);return i.make(t)},makeRandom:function(e,t){const i=K(e);if(!i)throw new Error("Failed to find item kind matching - "+JSON.stringify(e));return i.make(t)},from:function(e,t){let i;if("string"==typeof e){if(i=k(e),!i)throw new Error("Failed to find item kind - "+e)}else i=e instanceof B?e:U(e);return i.make(t)},kinds:H,install:function(e,t){if(t instanceof B)return H[e]=t,t;const i=U(t);return i.id=e,H[e]=i,i},get:k,makeKind:U,randomKind:K});class Y{make(e,t){return!0}fire(e,t,i,s,r){return!1}}const G={};function x(e,t){G[e]=t}function W(e){var t;if(!e)throw new Error("opts required to make effect.");if("string"==typeof e)throw new Error("Cannot make effect from string: "+e);"function"==typeof e&&(e={fn:e});const i={flags:r.flag.from(d,e.flags),chance:null!==(t=e.chance)&&void 0!==t?t:0,next:null,id:e.id||"n/a"};return e.next&&("string"==typeof e.next?i.next=e.next:i.next=W(e.next)),Object.values(G).forEach((t=>t.make(e,i))),i}function X(e){if(!e)throw new Error("Cannot make effect from null | undefined");if("string"==typeof e){const t=q[e];if(t)return t;throw new Error("Unknown effect - "+e)}return W(e)}function j(e){e.flags&=~d.E_FIRED}const q={};function Q(e,t){const i=W(t);return q[e]=i,i.id=e,i}class z{constructor(e){var t,i,s,l;this.index=-1,this.dissipate=2e3,this.effects={},this.priority=50,this.depth=0,this.light=null,this.groundTile=null,this.tags=[],this.id=e.id||"n/a",this.dissipate=null!==(t=e.dissipate)&&void 0!==t?t:this.dissipate,this.priority=null!==(i=e.priority)&&void 0!==i?i:this.priority,this.depth=null!==(s=e.depth)&&void 0!==s?s:this.depth,this.light=e.light||null,this.groundTile=e.groundTile||null,this.sprite=r.sprite.make(e),this.name=e.name||"tile",this.description=e.description||this.name,this.flavor=e.flavor||this.name,this.article=null!==(l=e.article)&&void 0!==l?l:null,this.flags=e.flags||{entity:0,tile:0,tileMech:0},e.effects&&Object.assign(this.effects,e.effects),this.hasEffect("fire")&&(this.flags.tile|=_.T_IS_FLAMMABLE),e.tags&&("string"==typeof e.tags?e.tags.split(/[,|]/).map((e=>e.trim())).forEach((e=>{this.tags.push(e)})):this.tags=e.tags.slice().map((e=>e.trim())))}hasTag(e){return this.tags.includes(e)}hasAnyTag(e){return r.arraysIntersect(this.tags,e)}hasAllTags(e){return e.every((e=>this.tags.includes(e)))}hasEntityFlag(e){return!!(this.flags.entity&e)}hasTileFlag(e){return!!(this.flags.tile&e)}hasTileMechFlag(e){return!!(this.flags.tileMech&e)}hasAllEntityFlags(e){return(this.flags.entity&e)===e}hasAllTileFlags(e){return(this.flags.tile&e)===e}hasAllTileMechFlags(e){return(this.flags.tileMech&e)===e}blocksVision(){return!!(this.flags.entity&a.L_BLOCKS_VISION)}blocksMove(){return!!(this.flags.entity&a.L_BLOCKS_MOVE)}blocksPathing(){return this.blocksMove()||this.hasTileFlag(_.T_PATHING_BLOCKER)}blocksEffects(){return!!(this.flags.entity&a.L_BLOCKS_EFFECTS)}hasEffect(e){return e in this.effects}getName(e){let t={};if("boolean"==typeof e||"string"==typeof e?t.article=e:e&&(t=e),!t.article&&!t.color)return this.name;let i=this.name;if(t.color){let e=t.color;!0===t.color&&(e=this.sprite.fg||"white"),"string"!=typeof e&&(e=r.color.from(e).toString()),i=`Ω${e}Ω${this.name}∆`}if(t.article){i=("string"==typeof t.article?t.article:this.article||"a")+" "+i}return i}getDescription(e){return this.description||this.getName(e)}getFlavor(e){return this.flavor||this.getName(e)}}function J(e){var t,i,l,n,o,h;let c={effects:{},flags:{},sprite:{},priority:50};if(e.extends&&(c=$[e.extends],!c))throw new Error("Failed to find base tile: "+e.extends);let f=c.priority;if("string"==typeof e.priority){let t=e.priority.replace(/ /g,""),i=t.search(/[+-]/);if(0==i)f=c.priority+Number.parseInt(t);else if(-1==i)if(0==t.search(/[a-zA-Z]/)){const e=$[t];if(!e)throw new Error("Failed to find tile for priority - "+t+".");f=e.priority}else f=Number.parseInt(t);else{const e=t.substring(0,i),s=Number.parseInt(t.substring(i)),r=$[e];if(!r)throw new Error("Failed to find tile for priority - "+e+".");f=r.priority+s}}else void 0!==e.priority&&(f=e.priority);const g={};Object.assign(g,c.effects),e.effects&&Object.entries(e.effects).forEach((([e,t])=>{null!==t?g[e]="string"!=typeof t?W(t):t:delete g[e]}));const u={entity:r.flag.from(a,c.flags.entity,e.flags),tile:r.flag.from(_,c.flags.tile,e.flags),tileMech:r.flag.from(E,c.flags.tileMech,e.flags)};let T=c.depth||0;e.depth&&(T="string"==typeof e.depth?s[e.depth]:e.depth);let S=c.light;e.light?S=r.light.make(e.light):null===e.light&&(S=null);const A={id:e.id,flags:u,dissipate:null!==(t=e.dissipate)&&void 0!==t?t:c.dissipate,effects:g,priority:f,depth:T,light:S,groundTile:e.groundTile||null,ch:null!==(i=e.ch)&&void 0!==i?i:c.sprite.ch,fg:null!==(l=e.fg)&&void 0!==l?l:c.sprite.fg,bg:null!==(n=e.bg)&&void 0!==n?n:c.sprite.bg,opacity:null!==(o=e.opacity)&&void 0!==o?o:c.sprite.opacity,name:e.name||c.name,description:e.description||c.description,flavor:e.flavor||c.flavor,article:null!==(h=e.article)&&void 0!==h?h:c.article,tags:e.tags||null};return new z(A)}const $={},Z=[];function ee(e){return e instanceof z?e:"string"==typeof e?$[e]||null:Z[e]||null}function te(e,...t){let i=t[0];2==t.length&&(i=t[1],i.extends=t[0]),i.id=e;const s=J(i);return s.index=Z.length,Z.push(s),$[e]=s,s}te("NULL",{ch:"∅",fg:"white",bg:"black",flags:"L_BLOCKS_MOVE",name:"eerie nothingness",article:"an",priority:0}),te("FLOOR",{ch:"·",fg:[30,30,30,20,0,0,0],bg:[2,2,10,0,2,2,0],priority:10,article:"the",flavor:"the stone floor"}),te("DOOR",{ch:"+",fg:[100,40,40],bg:[30,60,60],priority:30,flags:"T_IS_DOOR, L_BLOCKS_EFFECTS, L_BLOCKS_ITEMS, L_BLOCKS_VISION, L_VISUALLY_DISTINCT",article:"a",effects:{enter:{tile:"DOOR_OPEN"},open:{tile:"DOOR_OPEN_ALWAYS"}},flavor:"a closed door"}),te("DOOR_OPEN","DOOR",{ch:"'",fg:[100,40,40],bg:[30,60,60],priority:40,flags:"!L_BLOCKS_ITEMS, !L_BLOCKS_VISION",name:"open door",article:"an",effects:{tick:{chance:1e4,tile:"DOOR",flags:"E_SUPERPRIORITY, E_ONLY_IF_EMPTY"},enter:null,open:null,close:{tile:"DOOR",flags:"E_SUPERPRIORITY, E_ONLY_IF_EMPTY"}},flavor:"an open door"}),te("DOOR_OPEN_ALWAYS","DOOR_OPEN",{effects:{tick:null,close:{tile:"DOOR",flags:"E_SUPERPRIORITY, E_ONLY_IF_EMPTY"}},flavor:"an open door"}),te("UP_STAIRS",{ch:"<",fg:[100,50,50],bg:[40,20,20],priority:200,flags:"T_UP_STAIRS, L_BLOCKED_BY_STAIRS, L_VISUALLY_DISTINCT, L_LIST_IN_SIDEBAR",name:"upward staircase",article:"an",effects:{player:{emit:"UP_STAIRS"}},flavor:"stairs leading upwards"}),te("DOWN_STAIRS",{ch:">",fg:[100,50,50],bg:[40,20,20],priority:200,flags:"T_DOWN_STAIRS, L_BLOCKED_BY_STAIRS, L_VISUALLY_DISTINCT, L_LIST_IN_SIDEBAR",name:"downward staircase",article:"a",effects:{player:{emit:"DOWN_STAIRS"}},flavor:"downward leading stairs"}),te("WALL",{ch:"#",fg:[7,7,7,0,3,3,3],bg:[40,40,40,10,10,0,5],priority:100,flags:"L_WALL_FLAGS",article:"a",name:"stone wall",description:"A wall made from rough cut stone.",flavor:"a rough stone wall"}),te("IMPREGNABLE",{ch:"#",fg:[7,7,7,0,3,3,3],bg:[40,40,40,10,10,0,5],priority:100,flags:"L_WALL_FLAGS, IMPREGNABLE",article:"a",name:"impregnable wall",description:"A wall made from very hard stone.",flavor:"a very hard wall"}),te("LAKE",{ch:"~",fg:[5,8,20,10,0,4,15,!0],bg:[10,15,41,6,5,5,5,!0],priority:50,flags:"T_DEEP_WATER",name:"deep water",article:"the",flavor:"some deep water"}),te("SHALLOW",{ch:"·",fg:[5,8,10,10,0,4,15,!0],bg:[10,30,30,6,0,10,10,!0],priority:20,name:"shallow water",article:"the",depth:"SURFACE",flavor:"some shallow water"}),te("BRIDGE",{ch:"=",fg:[100,40,40],priority:40,depth:"SURFACE",flags:"T_BRIDGE, L_VISUALLY_DISTINCT",article:"a",groundTile:"LAKE",flavor:"a bridge"});const ie={Tile:_,TileMech:E};var se=Object.freeze({__proto__:null,flags:ie,Tile:z,make:J,tiles:$,all:Z,get:ee,install:te,installAll:function(e){Object.entries(e).forEach((([e,t])=>{te(e,t)}))}});class re{constructor(e,t="layer"){this.changed=!1,this.map=e,this.depth=-1,this.properties={},this.name=t}copy(e){}clear(){}setTile(e,t,i){return!1}clearTile(e,t){return!1}addActor(e,t,i){return!1}forceActor(e,t,i){return!1}removeActor(e){return!1}addItem(e,t,i){return!1}forceItem(e,t,i){return!1}removeItem(e){return!1}tick(e){return!1}}class le extends re{constructor(e,t="tile"){super(e,t)}setTile(e,t,i,r={}){const l=this.map.cell(e,t),n=l.depthTile(i.depth)||$.NULL;if(!r.superpriority&&n.priority>i.priority)return!1;if(l.blocksLayer(i.depth))return!1;if(r.blockedByItems&&l.hasItem())return!1;if(r.blockedByActors&&l.hasActor())return!1;if(r.blockedByOtherLayers&&l.highestPriority()>i.priority)return!1;if(i.depth>s.GROUND&&i.groundTile){const r=l.depthTile(s.GROUND);r&&r!==$.NULL||this.setTile(e,t,ee(i.groundTile))}return!!l.setTile(i)&&(i.hasEntityFlag(a.L_BLOCKS_SURFACE)&&l.clearDepth(s.SURFACE),r.machine&&(l.machineId=r.machine),n.light!==i.light&&(this.map.light.glowLightChanged=!0),n.hasEntityFlag(a.L_LIST_IN_SIDEBAR)!==i.hasEntityFlag(a.L_LIST_IN_SIDEBAR)&&this.map.setMapFlag(S.MAP_SIDEBAR_TILES_CHANGED),this.map.fov.isAnyKindOfVisible(e,t)&&l.clearCellFlag(u.STABLE_MEMORY|u.STABLE_SNAPSHOT),i.hasTileFlag(_.T_IS_FIRE)&&l.setCellFlag(u.CAUGHT_FIRE_THIS_TURN),!0)}clearTile(e,t){return this.map.cell(e,t).clearDepth(this.depth)}async tick(e){for(let e=0;e<this.map.width;++e)for(let t=0;t<this.map.height;++t){const i=this.map.cell(e,t);!i.hasCellFlag(u.HAS_ANY_ACTOR|u.HAS_ITEM)&&i.hasCellFlag(u.PRESSURE_PLATE_DEPRESSED)&&i.clearCellFlag(u.PRESSURE_PLATE_DEPRESSED),i.hasEffect("noKey")&&!this.map.hasKey(e,t)&&await i.fire("noKey",this.map,e,t)}return!0}putAppearance(e,t,i){const s=this.map.cell(t,i).depthTile(this.depth);s&&e.drawSprite(s.sprite)}}class ae extends re{constructor(e,t="actor"){super(e,t)}async addActor(e,t,i,s){const l=i;if(l.isDestroyed)return!1;const a=this.map.cell(e,t);return!l.forbidsCell(a)&&(!!r.list.push(a,"actor",i)&&(i.isPlayer()&&a.setCellFlag(u.HAS_PLAYER),i.x=e,i.y=t,i.map=this.map,i.key&&i.key.matches(e,t)&&a.hasEffect("key")&&await a.fire("key",this.map,e,t),a.needsRedraw=!0,this.map.fov.isAnyKindOfVisible(e,t)&&a.clearCellFlag(u.STABLE_MEMORY|u.STABLE_SNAPSHOT),!0))}forceActor(e,t,i,s){if(i.isDestroyed)return!1;if(this.map.hasXY(i.x,i.y)){this.map.cell(i.x,i.y).removeActor(i)}const l=this.map.cell(e,t);return!!r.list.push(l,"actor",i)&&(i.isPlayer()&&l.setCellFlag(u.HAS_PLAYER),i.x=e,i.y=t,i.map=this.map,l.needsRedraw=!0,this.map.fov.isAnyKindOfVisible(e,t)&&l.clearCellFlag(u.STABLE_MEMORY|u.STABLE_SNAPSHOT),!0)}async removeActor(e){const t=e.x,i=e.y,s=this.map.cell(t,i);return!!r.list.remove(s,"actor",e)&&(e.isPlayer()&&s.clearCellFlag(u.HAS_PLAYER),e.key&&e.key.matches(t,i)&&s.hasEffect("nokey")&&await s.fire("nokey",this.map,t,i),s.needsRedraw=!0,this.map.fov.isAnyKindOfVisible(t,i)&&s.clearCellFlag(u.STABLE_MEMORY|u.STABLE_SNAPSHOT),!0)}putAppearance(e,t,i){const s=this.map.cell(t,i);s.actor&&e.drawSprite(s.actor.sprite)}}class ne extends re{constructor(e,t="item"){super(e,t)}async addItem(e,t,i,s){const l=i;if(l.isDestroyed)return!1;const a=this.map.cell(e,t);return!l.forbidsCell(a)&&(i.key&&i.key.matches(e,t)&&a.hasEffect("key")&&(await a.fire("key",this.map,e,t),i.key.disposable)?(i.destroy(),!0):!!r.list.push(a,"item",i)&&(i.x=e,i.y=t,i.depth=this.depth,i.map=this.map,a.hasEffect("addItem")&&await a.fire("addItem",this.map,e,t,{item:l}),a.needsRedraw=!0,this.map.fov.isAnyKindOfVisible(e,t)&&a.clearCellFlag(u.STABLE_MEMORY|u.STABLE_SNAPSHOT),!0))}forceItem(e,t,i,s){if(!this.map.hasXY(e,t))return!1;if(this.map.hasXY(i.x,i.y)){const e=this.map.cell(i.x,i.y);r.list.remove(e,"item",i),i.x=-1,i.y=-1}const l=this.map.cell(e,t);return!!r.list.push(l,"item",i)&&(i.x=e,i.y=t,i.depth=this.depth,i.map=this.map,l.needsRedraw=!0,this.map.fov.isAnyKindOfVisible(e,t)&&l.clearCellFlag(u.STABLE_MEMORY|u.STABLE_SNAPSHOT),!0)}async removeItem(e){const t=e.x,i=e.y,s=this.map.cell(t,i);return!!r.list.remove(s,"item",e)&&(e.key&&e.key.matches(t,i)&&s.hasEffect("nokey")?await s.fire("nokey",this.map,t,i):s.hasEffect("removeItem")&&await s.fire("removeItem",this.map,t,i),s.needsRedraw=!0,this.map.fov.isAnyKindOfVisible(t,i)&&s.clearCellFlag(u.STABLE_MEMORY|u.STABLE_SNAPSHOT),!0)}putAppearance(e,t,i){const s=this.map.cell(t,i);s.item&&e.drawSprite(s.item.sprite)}}class oe extends le{constructor(e,t="gas"){super(e,t),this.volume=r.grid.alloc(e.width,e.height,0)}clear(){this.volume.fill(0)}setTile(e,t,i,s={}){if(!s.volume)return!1;return this.map.cell(e,t).depthTile(i.depth)===i?(this.volume[e][t]+=s.volume,!0):!!super.setTile(e,t,i,s)&&(this.volume[e][t]=s.volume,this.changed=!0,!0)}clearTile(e,t){return!!this.map.cell(e,t).clearDepth(this.depth)&&(this.volume[e][t]=0,!0)}copy(e){this.volume.copy(e.volume),this.changed=e.changed}async tick(e){if(!this.changed)return!1;this.changed=!1;const t=this.volume;return this.volume=r.grid.alloc(this.map.width,this.map.height),this.dissipate(t),this.spread(t),r.grid.free(t),!0}dissipate(e){e.update(((e,t,i)=>{if(!e)return 0;const s=this.map.cell(t,i).depthTile(this.depth);if(s&&s.dissipate){let t=Math.max(.5,e*s.dissipate/1e4);e=Math.max(0,e-t)}return e?this.changed=!0:this.clearTile(t,i),e}))}calcOpacity(e){return Math.floor(10*Math.min(e,10))}updateCellVolume(e,t,i){let s=0,r=0,l=0;const n=this.map.cell(e,t);let o=n.depthTile(this.depth),h=o;if(n.hasEntityFlag(a.L_BLOCKS_GAS))return this.volume[e][t]=0,void(i[e][t]&&this.clearTile(e,t));for(let o=Math.max(0,e-1);o<Math.min(e+2,i.width);++o)for(let e=Math.max(0,t-1);e<Math.min(t+2,i.height);++e){const t=i[o][e];n.hasEntityFlag(a.L_BLOCKS_GAS)||(++r,t>l&&(l=t,h=this.map.cell(o,e).depthTile(this.depth))),s+=t}const c=Math.floor(10*s/r)/10;this.volume[e][t]=c,c>0&&h&&(o&&o===h||n.setTile(h)),c>0&&(n.needsRedraw=!0)}spread(e){for(let t=0;t<e.width;++t)for(let i=0;i<e.height;++i)this.updateCellVolume(t,i,e)}putAppearance(e,t,i){const s=this.volume[t][i];if(!s)return;const r=this.map.cell(t,i).depthTile(this.depth);if(r){const t=this.calcOpacity(s);e.drawSprite(r.sprite,t)}}}async function he(e,t,i,s,l={}){if(!e)return!1;if("string"==typeof e){const t=e;if(!(e=X(t)))throw new Error("Failed to find effect: "+t)}const a=l;if(!a.force&&e.chance&&!t.rng.chance(e.chance,1e4))return!1;const n=a.grid=r.grid.alloc(t.width,t.height);let o=!1;const h=Object.values(G);for(let r of h)await r.fire(e,t,i,s,a)&&(o=!0);if(e.next&&(o||e.flags&d.E_NEXT_ALWAYS)&&!r.data.gameHasEnded){const r="string"==typeof e.next?X(e.next):e.next;e.flags&d.E_NEXT_EVERYWHERE?await n.forEachAsync((async(e,i,s)=>{e&&(o=await he(r,t,i,s,a)||o)})):o=await he(r,t,i,s,a)||o}return!o||!t.isVisible(i,s)||e.flags&d.E_NO_MARK_FIRED||(e.flags|=d.E_FIRED),r.grid.free(n),o}class ce extends Y{constructor(){super()}make(e,t){if(!e.emit)return!0;if("string"!=typeof e.emit)throw new Error('emit effects must be string name to emit: { emit: "EVENT" }');return t.emit=e.emit,!0}async fire(e,t,i,s,l){return!!e.emit&&(await r.events.emit(e.emit,i,s,l),!0)}}x("emit",new ce);class _e extends Y{constructor(){super()}make(e,t){if(!e.fn)return!0;if("function"!=typeof e.fn)throw new Error("fn effects must be functions.");return t.fn=e.fn,!0}async fire(e,t,i,s,r){return!!e.fn&&await e.fn(e,t,i,s,r)}}x("fn",new _e);class fe extends Y{constructor(){super()}make(e,t){if(!e.message)return!0;if("string"!=typeof e.message)throw new Error("Emit must be configured with name of event to emit");return t.message=e.message,!0}async fire(e,t,i,s,l){if(!e.message)return!1;const a=!!(e.flags&d.E_FIRED);return!(!e.message||!e.message.length||a||!t.isVisible(i,s))&&(r.message.addAt(i,s,e.message,l),!0)}}x("message",new fe);class Ee extends Y{constructor(){super()}make(e,t){return!e.activateMachine||(t.activateMachine=!0,!0)}async fire(e,t,i,s,r){if(e.activateMachine){const e=t.cell(i,s).machineId;return!!e&&await t.activateMachine(e,i,s,r)}return!1}}x("activateMachine",new Ee);class ge extends Y{constructor(){super()}make(e,t){return!e.effect||(t.effect=e.effect,!0)}async fire(e,t,i,s,r){return!!e.effect&&await he(e.effect,t,i,s,r)}}x("effect",new ge);class ue extends Y{constructor(){super()}make(e,t){var i,s,l,a,n,o,h;if(!e.tile)return!0;let c=e.tile;if("string"==typeof c){const e=c.split(/[,|]/).map((e=>e.trim()));c={tile:e[0],grow:Number.parseInt(e[1]||"0"),decrement:Number.parseInt(e[2]||"0")}}const _={grow:null!==(s=null!==(i=c.grow)&&void 0!==i?i:c.spread)&&void 0!==s?s:0,decrement:null!==(l=c.decrement)&&void 0!==l?l:0,flags:r.flag.from(d,c.flags),volume:null!==(a=c.volume)&&void 0!==a?a:0,next:null!==(n=c.next)&&void 0!==n?n:null},f=null!==(o=c.tile)&&void 0!==o?o:c.id;if("string"!=typeof f)throw new Error("Invalid tile spawn config: "+f);if(_.tile=f,!_.tile)throw new Error("Must have tile.");const E=null!==(h=c.matchTile)&&void 0!==h?h:c.match;if("string"==typeof E)_.matchTile=E;else if(E)throw new Error("Invalid tile spawn match tile: "+c.matchTile);return t.tile=_,!0}fire(e,t,i,s,r){if(!e.tile)return!1;const l=e.tile.tile,a=$[l]||null;if(!a)throw new Error("Failed to find tile for effect: "+l);const n=!!(e.flags&d.E_ABORT_IF_BLOCKS_MAP),o=!(!n||e.flags&d.E_PERMIT_BLOCKING||!(a.blocksPathing()||e.flags&d.E_TREAT_AS_BLOCKING));let h=!1;if(h=Ae(e,t,i,s,r),!h)return!1;if(n&&o&&this.mapDisruptedBy(t,r.grid))return!1;e.flags&d.E_EVACUATE_CREATURES&&Le(t,r.grid)&&(h=!0),e.flags&d.E_EVACUATE_ITEMS&&pe(t,r.grid)&&(h=!0),e.flags&d.E_CLEAR_CELL&&de(t,r.grid,e.flags)&&(h=!0);return Te(e.flags,r.grid,t,a,e.tile.volume,r.machine)}mapDisruptedBy(e,t,i=0,s=0){const l=r.grid.alloc(e.width,e.height);let a=!1;r.xy.forRect(e.width,e.height,((r,n)=>{const o=r+i,h=n+s;t.get(o,h)?e.cell(r,n).isStairs()&&(a=!0):e.cell(r,n).blocksMove()||(l[r][n]=1)}));let n=!0;for(let e=0;e<l.width&&!a;++e)for(let t=0;t<l.height&&!a;++t)1==l[e][t]&&(n?(l.floodFill(e,t,1,2),n=!1):a=!0);return r.grid.free(l),a}}function Te(e,t,i,s,r=0,l){let a,n,o;o=!1;const h=!!(e&d.E_BLOCKED_BY_OTHER_LAYERS),c=!!(e&d.E_SUPERPRIORITY),_=!!(e&d.E_BLOCKED_BY_ACTORS),f=!!(e&d.E_BLOCKED_BY_ITEMS);for(r=r||0,a=0;a<t.width;a++)for(n=0;n<t.height;n++){if(!t[a][n])continue;t[a][n]=0;const E=i.cell(a,n);E.hasTile(s)||i.setTile(a,n,s,{volume:r,superpriority:c,blockedByOtherLayers:h,blockedByActors:_,blockedByItems:f,machine:l})&&(t[a][n]=1,E.flags.cell|=u.EVENT_FIRED_THIS_TURN,e&d.E_PROTECTED&&(E.flags.cell|=u.EVENT_PROTECTED),o=!0)}return o&&i.setMapFlag(S.MAP_CHANGED),o}function Se(e,t,i,s,l){if(!t.hasXY(i,s))return!1;const a=t.cell(i,s);if(a.hasCellFlag(u.EVENT_PROTECTED))return!1;if(a.blocksEffects()&&!e.tile.matchTile&&!l)return!1;if(e.flags&d.E_BUILD_IN_WALLS){if(!t.cell(i,s).isWall())return!1}else if(e.flags&d.E_MUST_TOUCH_WALLS){let e=!1;if(r.xy.eachNeighbor(i,s,((i,s)=>{t.cell(i,s).isWall()&&(e=!0)}),!0),!e)return!1}else if(e.flags&d.E_NO_TOUCH_WALLS){let e=!0;if(t.cell(i,s).isWall())return!1;if(r.xy.eachNeighbor(i,s,((i,s)=>{t.cell(i,s).isWall()&&(e=!1)}),!0),!e)return!1}return!(e.tile.matchTile&&!l&&!a.hasTile(e.tile.matchTile))}function Ae(e,t,i,s,l){let a,n,o,h,c,_,f;const E=e.tile;let g=E.grow||0,u=E.decrement||0;const T=l.grid;if(T.fill(0),!Se(e,t,i,s,!0))return!1;T[i][s]=h=1;let S=1;if(g)for(f=!0,g>=100&&(u=u||100),u<=0&&(u=g);f&&g>0;){for(f=!1,h++,a=0;a<t.width;a++)for(n=0;n<t.height;n++)if(T[a][n]==h-1)for(o=0;o<4;o++)c=a+r.xy.DIRS[o][0],_=n+r.xy.DIRS[o][1],T.hasXY(c,_)&&!T[c][_]&&t.rng.chance(g)&&Se(e,t,c,_,!1)&&(T[c][_]=h,f=!0,++S);g-=u}return S>0}function de(e,t,i=0){let r=!1;const l=(i&d.E_CLEAR_CELL)===d.E_CLEAR_CELL;return t.forEach(((t,a,n)=>{if(!t)return;const o=e.cell(a,n);l?o.clear():(i&d.E_CLEAR_GAS&&o.clearDepth(s.GAS),i&d.E_CLEAR_LIQUID&&o.clearDepth(s.LIQUID),i&d.E_CLEAR_SURFACE&&o.clearDepth(s.SURFACE),i&d.E_CLEAR_GROUND&&o.clearDepth(s.GROUND)),r=!0})),r}function Le(e,t){let i=0,s=0,l=!1;for(i=0;i<e.width;i++)for(s=0;s<e.height;s++){if(!t[i][s])continue;const a=e.cell(i,s);a.hasActor()&&r.list.forEach(a.actor,(r=>{if(!(r instanceof C))return;const a=r,n=e.rng.matchingLocNear(i,s,((i,s)=>{if(!e.hasXY(i,s))return!1;if(t[i][s])return!1;const r=e.cell(i,s);return!a.forbidsCell(r)}));n&&n[0]>=0&&n[1]>=0&&(e.forceActor(n[0],n[1],a),l=!0)}))}return l}function pe(e,t){let i=!1;return t.forEach(((s,l,a)=>{if(!s)return;const n=e.cell(l,a);n.hasItem()&&r.list.forEach(n.item,(s=>{if(!(s instanceof b))return;const r=s,n=e.rng.matchingLocNear(l,a,((i,s)=>{if(!e.hasXY(i,s))return!1;if(t[i][s])return!1;const l=e.cell(i,s);return!r.forbidsCell(l)}));n&&n[0]>=0&&n[1]>=0&&(e.forceItem(n[0],n[1],r),i=!0)}))})),i}x("tile",new ue);x("clear",new class extends Y{constructor(){super()}make(e,t){if(!e.clear)return!0;let i=e.clear,r=0;if("string"==typeof i&&(i=i.split(/[,|]/).map((e=>e.trim()))),!0===i)r=s.ALL_LAYERS;else if("number"==typeof i)r=i;else{if(!Array.isArray(i))throw new Error("clear effect must have number or string config.");r=i.reduce(((e,t)=>{if("number"==typeof t)return e|t;return e|(s[t]||0)}),0)}return t.clear=r,r>0}async fire(e,t,i,s,r){return this.fireSync(e,t,i,s,r)}fireSync(e,t,i,s,r){if(!e.clear)return!1;if(!t)return!1;return t.cell(i,s).clearDepth(e.clear)}});var me=Object.freeze({__proto__:null,Handler:Y,handlers:G,installHandler:x,make:W,from:X,reset:j,resetAll:function(){Object.values(q).forEach((e=>j(e)))},effects:q,install:Q,installAll:function(e){Object.entries(e).forEach((([e,t])=>{Q(e,t)}))},fire:he,EmitEffect:ce,FnEffect:_e,MessageEffect:fe,ActivateMachineEffect:Ee,EffectEffect:ge,SpawnEffect:ue,spawnTiles:Te,computeSpawnMap:Ae,clearCells:de,evacuateCreatures:Le,evacuateItems:pe});const Ie=s,Oe=a,Re=_,ye=E,Ce=u;class Ne extends le{constructor(e,t="tile"){super(e,t)}async tick(e){for(let e=0;e<this.map.width;++e)for(let t=0;t<this.map.height;++t){this.map.cell(e,t).clearCellFlag(Ce.CAUGHT_FIRE_THIS_TURN)}for(let e=0;e<this.map.width;++e)for(let t=0;t<this.map.height;++t){const i=this.map.cell(e,t);if(i.hasTileFlag(Re.T_IS_FIRE)&&!(i.flags.cell&Ce.CAUGHT_FIRE_THIS_TURN)){await this.exposeToFire(e,t,!1);for(let i=0;i<4;++i){const s=r.xy.DIRS[i];await this.exposeToFire(e+s[0],t+s[1])}}}return!0}async exposeToFire(e,t,i=!1){let s=0,l=0,a=0,n=!1,o=!1;const h=this.map.cell(e,t);if(!h.hasTileFlag(Re.T_IS_FLAMMABLE))return!1;if(h.eachTile((e=>{e.hasTileFlag(Re.T_EXTINGUISHES_FIRE)&&e.priority>l&&(l=e.priority)})),h.eachTile((e=>{if(e.flags.tile&Re.T_IS_FLAMMABLE&&(e.depth===Ie.GAS||e.priority>=l)){const t=X(e.effects.fire);t&&t.chance>s&&(s=t.chance)}})),i||s&&this.map.rng.chance(s,1e4)){n=!0,h.hasTileMechFlag(ye.TM_EXPLOSIVE_PROMOTE)&&(r.xy.eachNeighbor(e,t,((e,t)=>{const i=this.map.cell(e,t);(i.hasEntityFlag(Oe.L_BLOCKS_GAS)||i.hasTileFlag(Re.T_IS_FIRE)||i.hasTileMechFlag(ye.TM_EXPLOSIVE_PROMOTE))&&++a})),a>=8&&(o=!0));let i="fire";o&&h.hasEffect("explode")&&(i="explode"),await h.fire(i,this.map,e,t,{force:!0}),h.needsRedraw=!0}return n}}var De=Object.freeze({__proto__:null,MapLayer:re,TileLayer:le,ActorLayer:ae,ItemLayer:ne,GasLayer:oe,FireLayer:Ne});class Me{constructor(e){this.cell=e}eachItem(e){let t=this.cell._item;for(;t;)e(t),t=t.next}eachActor(e){let t=this.cell._actor;for(;t;)e(t),t=t.next}forEach(e){this.eachItem(e),this.eachActor(e)}some(e){let t=this.cell._item;for(;t;){if(e(t))return!0;t=t.next}for(t=this.cell._actor;t;){if(e(t))return!0;t=t.next}return!1}reduce(e,t){let i=this.cell._item;for(;i;)t=void 0===t?i:e(t,i),i=i.next;for(i=this.cell._actor;i;)t=void 0===t?i:e(t,i),i=i.next;return t}}class Fe{constructor(e,t,i,s){if(this.chokeCount=0,this.machineId=0,this._actor=null,this._item=null,this.x=-1,this.y=-1,this._entities=new Me(this),this.flags={cell:u.NEEDS_REDRAW},this.tiles=[$.NULL],this.map=e,this.x=t,this.y=i,s){const e=ee(s);this.setTile(e)}}copy(e){Object.assign(this.flags,e.flags),this.chokeCount=e.chokeCount,this.tiles.length=e.tiles.length;for(let t=0;t<this.tiles.length;++t)this.tiles[t]=e.tiles[t];this.machineId=e.machineId,this._actor=e._actor,this._item=e._item,this.map=e.map,this.x=e.x,this.y=e.y}hasCellFlag(e){return!!(this.flags.cell&e)}setCellFlag(e){this.flags.cell|=e}clearCellFlag(e){this.flags.cell&=~e}hasEntityFlag(e,t=!1){return!!this.tiles.some((t=>t&&t.flags.entity&e))||t&&this._entities.some((t=>!!(t.flags.entity&e)))}hasAllEntityFlags(e){return(this.entityFlags()&e)==e}hasTileFlag(e){return this.tiles.some((t=>t&&t.flags.tile&e))}hasAllTileFlags(e){return(this.tileFlags()&e)==e}hasTileMechFlag(e){return this.tiles.some((t=>t&&t.flags.tileMech&e))}hasAllTileMechFlags(e){return(this.tileMechFlags()&e)==e}hasTileTag(e){return this.tiles.some((t=>t&&t.hasTag(e)))}hasAllTileTags(e){return this.tiles.some((t=>t&&t.hasAllTags(e)))}hasAnyTileTag(e){return this.tiles.some((t=>t&&t.hasAnyTag(e)))}cellFlags(){return this.flags.cell}entityFlags(e=!1){let t=this.tiles.reduce(((e,t)=>e|(t?t.flags.entity:0)),0);return e&&(t|=this._entities.reduce(((e,t)=>e|t.flags.entity),0)),t}tileFlags(){return this.tiles.reduce(((e,t)=>e|(t?t.flags.tile:0)),0)}tileMechFlags(){return this.tiles.reduce(((e,t)=>e|(t?t.flags.tileMech:0)),0)}itemFlags(){let e=0;return this._entities.eachItem((t=>{e|=t.flags.item})),e}actorFlags(){let e=0;return this._entities.eachActor((t=>{e|=t.flags.actor})),e}get needsRedraw(){return!!(this.flags.cell&u.NEEDS_REDRAW)}set needsRedraw(e){e?this.flags.cell|=u.NEEDS_REDRAW:this.flags.cell&=~u.NEEDS_REDRAW}get changed(){return!!(this.flags.cell&u.CHANGED)}depthPriority(e){const t=this.tiles[e];return t?t.priority:$.NULL.priority}highestPriority(){return this.tiles.reduce(((e,t)=>Math.max(e,t?t.priority:0)),$.NULL.priority)}depthTile(e){return this.tiles[e]||null}hasTile(e){return e?(e instanceof z||(e=ee(e)),this.tiles.includes(e)):this.tiles.some((e=>e))}hasDepthTile(e){const t=this.tiles[e];return!!t&&t!==$.NULL}highestPriorityTile(){return this.tiles.reduce(((e,t)=>t&&t.priority>=e.priority?t:e),$.NULL)}get tile(){return this.highestPriorityTile()}eachTile(e){this.tiles.forEach((t=>t&&e(t)))}tileWithObjectFlag(e){return this.tiles.find((t=>t&&t.flags.entity&e))||null}tileWithFlag(e){return this.tiles.find((t=>t&&t.flags.tile&e))||null}tileWithMechFlag(e){return this.tiles.find((t=>t&&t.flags.tileMech&e))||null}blocksVision(e=!1){return!!this.tiles.some((e=>e&&e.blocksVision()))||e&&this._entities.some((e=>e.blocksVision()))}blocksPathing(e=!1){return!!this.tiles.some((e=>e&&e.blocksPathing()))||e&&this._entities.some((e=>e.blocksPathing()))}blocksMove(e=!1){return!!this.tiles.some((e=>e&&e.blocksMove()))||e&&this._entities.some((e=>e.blocksMove()))}blocksEffects(e=!1){return!!this.tiles.some((e=>e&&e.blocksEffects()))||e&&this._entities.some((e=>e.blocksEffects()))}blocksLayer(e){return this.tiles.some((t=>t&&!!(t.flags.tile&ie.Tile.T_BLOCKS_OTHER_LAYERS)&&t.depth!=e))}isEmpty(){return this.tiles.every((e=>!e||e===$.NULL))&&null==this._actor&&null==this._item}isPassable(){return!this.blocksMove()}isWall(){return this.hasAllEntityFlags(a.L_WALL_FLAGS)}isStairs(){return this.hasTileFlag(_.T_HAS_STAIRS)}isFloor(){return!this.hasEntityFlag(a.L_BLOCKS_EVERYTHING)&&!this.hasTileFlag(_.T_PATHING_BLOCKER)}isGateSite(){return this.hasCellFlag(u.IS_GATE_SITE)}isSecretlyPassable(){return this.hasEntityFlag(a.L_SECRETLY_PASSABLE)}setTile(e){if(!(e instanceof z||(e=ee(e))))return!1;return(this.tiles[e.depth]||$.NULL)!==e&&(this.tiles[e.depth]=e,this.needsRedraw=!0,!0)}clearTiles(e){this.tiles[0]=$.NULL;for(let e=1;e<this.tiles.length;++e)this.tiles[e]=null;e&&this.setTile(e)}clear(e){this.tiles=[$.NULL],this.flags.cell=0,this.needsRedraw=!0,this.chokeCount=0,this.machineId=0,this._actor=null,this._item=null,e&&this.setTile(e)}clearDepth(e){return 0==e?(this.tiles[0]=$.NULL,this.needsRedraw=!0,!0):null!==this.tiles[e]&&(this.tiles[e]=null,this.needsRedraw=!0,!0)}clearDepthsWithFlags(e,t=0){for(let i=0;i<this.tiles.length;++i){const s=this.tiles[i];s&&(s.hasTileFlag(e)&&(t&&!s.hasTileMechFlag(t)||this.clearDepth(i)))}}eachGlowLight(e){this.tiles.forEach((t=>{t&&t.light&&e(t.light)}))}async fire(e,t,i,s,r={}){r.cell=this;let l=!1;if(void 0!==r.depth){const a=r.tile=this.depthTile(r.depth);if(a&&a.effects){const n=a.effects[e];l=await this._activate(n,t,i,s,r)}}else for(r.tile of this.tiles){if(!r.tile||!r.tile.effects)continue;const a=r.tile.effects[e];if(await this._activate(a,t,i,s,r)){l=!0;break}}return l}async _activate(e,t,i,s,r){"string"==typeof e&&(e=q[e]);let l=!1;return e&&(l=await he(e,t,i,s,r)),l}hasEffect(e){for(let t of this.tiles)if(t&&t.hasEffect(e))return!0;return!1}hasItem(){return this.hasCellFlag(u.HAS_ITEM)}get item(){return this._item}set item(e){this._item=e,e?this.setCellFlag(u.HAS_ITEM):this.clearCellFlag(u.HAS_ITEM),this.needsRedraw=!0}removeItem(e){return r.list.remove(this,"item",e)}hasActor(){return this.hasCellFlag(u.HAS_ACTOR)}hasPlayer(){return this.hasCellFlag(u.HAS_PLAYER)}get actor(){return this._actor}set actor(e){this._actor=e,e?this.setCellFlag(u.HAS_ACTOR):this.clearCellFlag(u.HAS_ACTOR|u.HAS_PLAYER),this.needsRedraw=!0}removeActor(e){return r.list.remove(this,"actor",e)}getDescription(){return this.highestPriorityTile().description}getFlavor(){return this.highestPriorityTile().flavor}getName(e={}){return this.highestPriorityTile().getName(e)}dump(){var e,t,i,s;return(null===(t=null===(e=this._actor)||void 0===e?void 0:e.sprite)||void 0===t?void 0:t.ch)?this._actor.sprite.ch:(null===(s=null===(i=this._item)||void 0===i?void 0:i.sprite)||void 0===s?void 0:s.ch)?this._item.sprite.ch:this.highestPriorityTile().sprite.ch||" "}}class ve extends Fe{constructor(e,t,i){super(e,t,i),this.snapshot=new r.sprite.Mixer,this.snapshot.copy($.NULL.sprite)}clear(){super.clear(),this.snapshot.blackOut()}store(e){this.copy(e),e.actor&&(e.actor.lastSeen=e),e.item&&(e.item.lastSeen=e)}getSnapshot(e){e.copy(this.snapshot)}putSnapshot(e){this.snapshot.copy(e)}}class Pe{constructor(e,t,i={}){this.machineCount=0,this._seed=0,this.rng=r.rng.random,this.width=e,this.height=t,this.flags={map:0},this.layers=[],this.cells=r.grid.make(e,t,((e,t)=>new Fe(this,e,t))),this._memory=r.grid.make(e,t,((e,t)=>new ve(this,e,t))),i.seed&&(this._seed=i.seed,this.rng=r.rng.make(i.seed)),this.light=new r.light.LightSystem(this,i),this.fov=new r.fov.FovSystem(this,i),this.properties={},this.initLayers()}get seed(){return this._seed}set seed(e){this._seed=e,this.rng=r.rng.make(e)}memory(e,t){return this._memory[e][t]}knowledge(e,t){return this.fov.isAnyKindOfVisible(e,t)?this.cells[e][t]:this._memory[e][t]}initLayers(){this.addLayer(s.GROUND,new le(this,"ground")),this.addLayer(s.SURFACE,new Ne(this,"surface")),this.addLayer(s.GAS,new oe(this,"gas")),this.addLayer(s.ITEM,new ne(this,"item")),this.addLayer(s.ACTOR,new ae(this,"actor"))}addLayer(e,t){"number"!=typeof e&&(e=s[e]),t.depth=e,this.layers[e]=t}removeLayer(e){if("number"!=typeof e&&(e=s[e]),!e)throw new Error("Cannot remove layer with depth=0.");delete this.layers[e]}getLayer(e){return"number"!=typeof e&&(e=s[e]),this.layers[e]||null}hasXY(e,t){return this.cells.hasXY(e,t)}isBoundaryXY(e,t){return 0==e||0==t||e==this.width-1||t==this.height-1}cell(e,t){return this.cells[e][t]}get(e,t){return this.cells.get(e,t)}eachCell(e){this.cells.forEach(((t,i,s)=>e(t,i,s,this)))}drawInto(e,t={}){const i=e instanceof r.canvas.Canvas?e.buffer:e;"boolean"==typeof t&&(t={force:t});const s=new r.sprite.Mixer;for(let e=0;e<i.width;++e)for(let t=0;t<i.height;++t)this.getAppearanceAt(e,t,s),i.drawSprite(e,t,s)}hasItem(e,t){return this.cells[e][t].hasItem()}itemAt(e,t){return this.cell(e,t).item}eachItem(e){this.cells.forEach((t=>{r.list.forEach(t.item,e)}))}async addItem(e,t,i){if(!this.hasXY(e,t))return!1;for(let s of this.layers)if(s&&await s.addItem(e,t,i))return!0;return!1}forceItem(e,t,i){if(!this.hasXY(e,t))return!1;for(let s of this.layers)if(s&&s.forceItem(e,t,i))return!0;return!1}async removeItem(e){return this.layers[e.depth].removeItem(e)}async moveItem(e,t){"number"==typeof t&&(t=r.xy.DIRS[t]);const i=e.x,s=e.y,l=i+t[0],a=s+t[1];if(!this.hasXY(l,a))return!1;const n=this.layers[e.depth];if(!await n.removeItem(e))return!1;if(!await this.addItem(l,a,e))return n.forceItem(e.x,e.y,e),!1;const o=this.fov.isAnyKindOfVisible(i,s),h=this.fov.isAnyKindOfVisible(l,a);if(h&&!o)e.lastSeen&&(this._memory[e.lastSeen.x][e.lastSeen.y].removeItem(e),this.clearCellFlag(e.lastSeen.x,e.lastSeen.y,u.STABLE_SNAPSHOT),e.lastSeen=null);else if(o&&!h){this._memory[l][a].item=e,this.clearCellFlag(l,a,u.STABLE_SNAPSHOT),e.lastSeen=this.cell(l,a)}return!0}hasPlayer(e,t){return this.cell(e,t).hasPlayer()}actorAt(e,t){return this.cell(e,t).actor}eachActor(e){this.cells.forEach((t=>{r.list.forEach(t.actor,e)}))}async addActor(e,t,i){if(!this.hasXY(e,t))return!1;for(let s of this.layers)if(s&&await s.addActor(e,t,i))return!0;return!1}forceActor(e,t,i){if(!this.hasXY(e,t))return!1;for(let s of this.layers)if(s&&s.forceActor(e,t,i))return!0;return!1}async removeActor(e){return this.layers[e.depth].removeActor(e)}async moveActor(e,t){"number"==typeof t&&(t=r.xy.DIRS[t]);const i=e.x,s=e.y,l=i+t[0],a=s+t[1];if(!this.hasXY(l,a))return!1;const n=this.layers[e.depth];if(!await n.removeActor(e))return!1;if(!await n.addActor(l,a,e))return n.forceActor(e.x,e.y,e),!1;const o=this.fov.isAnyKindOfVisible(i,s),h=this.fov.isAnyKindOfVisible(l,a);if(h&&!o)e.lastSeen&&(this._memory[e.lastSeen.x][e.lastSeen.y].removeActor(e),this.clearCellFlag(e.lastSeen.x,e.lastSeen.y,u.STABLE_SNAPSHOT),e.lastSeen=null);else if(o&&!h){this._memory[l][a].actor=e,this.clearCellFlag(l,a,u.STABLE_SNAPSHOT),e.lastSeen=this.cell(l,a)}return!0}isVisible(e,t){return this.fov.isAnyKindOfVisible(e,t)}hasKey(e,t){if(!this.hasXY(e,t))return!1;return this.cells[e][t]._entities.some((i=>!!i.key&&i.key.matches(e,t)))}count(e){return this.cells.count(((t,i,s)=>e(t,i,s,this)))}dump(e,t=console.log){const i=new r.sprite.Mixer;this.cells.dump(e||((e,t,s)=>(this.getAppearanceAt(t,s,i),i.ch<0?" ":i.ch)),t)}hasMapFlag(e){return!!(this.flags.map&e)}setMapFlag(e){this.flags.map|=e}clearMapFlag(e){this.flags.map&=~e}setCellFlag(e,t,i){this.cells[e][t].setCellFlag(i)}clearCellFlag(e,t,i){this.cells[e][t].clearCellFlag(i)}clear(){this.light.glowLightChanged=!0,this.fov.needsUpdate=!0,this.layers.forEach((e=>e.clear()))}clearCell(e,t,i){this.cells[e][t].clear(i)}fill(e,t){let i,s;for(e=ee(e),t=ee(t||e),i=0;i<this.width;++i)for(s=0;s<this.height;++s){this.cells[i][s].clear(this.isBoundaryXY(i,s)?t:e)}}hasTile(e,t,i,s=!1){return s?this.memory(e,t).hasTile(i):this.cell(e,t).hasTile(i)}forceTile(e,t,i){return this.setTile(e,t,i,{superpriority:!0})}setTile(e,t,i,s){if(!(i instanceof z||(i=ee(i))))return!1;!0===s&&(s={superpriority:!0});const r=i.depth||0,l=this.layers[r]||this.layers[0];return l instanceof le&&l.setTile(e,t,i,s)}clearTiles(e,t,i){this.cells[e][t].clearTiles(i)}async tick(e){let t=await this.fireAll("tick");for(let i of this.layers)i&&await i.tick(e)&&(t=!0);return t}copy(e){if(this.constructor!==e.constructor)throw new Error("Maps must be same type to copy.");if(this.width!==e.width||this.height!==e.height)throw new Error("Maps must be same size to copy");this.cells.forEach(((t,i,s)=>{t.copy(e.cells[i][s])})),this.layers.forEach(((t,i)=>{t.copy(e.layers[i])})),this.flags.map=e.flags.map,this.fov.needsUpdate=!0,this.light.copy(e.light),this.rng=e.rng,this.machineCount=e.machineCount,this._seed=e._seed,this.properties=Object.assign({},e.properties)}clone(){const e=new this.constructor(this.width,this.height);return e.copy(this),e}async fire(e,t,i,s={}){return this.cells[t][i].fire(e,this,t,i,s)}async fireAll(e,t={}){const i=r.grid.alloc(this.width,this.height);return this.cells.forEach(((t,s,l)=>{t.clearCellFlag(u.EVENT_FIRED_THIS_TURN|u.EVENT_PROTECTED),t.eachTile((n=>{const o=n.effects[e];if(!o)return;const h=X(o);if(!h)return;let c=0;h.chance<0?(c=0,r.xy.eachNeighbor(s,l,((e,i)=>{const s=this.cell(e,i);s.hasEntityFlag(a.L_BLOCKS_EFFECTS)||s.depthTile(n.depth)==t.depthTile(n.depth)||s.hasCellFlag(u.CAUGHT_FIRE_THIS_TURN)||(c+=-1*h.chance)}),!0)):c=h.chance||1e4,!t.hasCellFlag(u.CAUGHT_FIRE_THIS_TURN)&&this.rng.chance(c,1e4)&&(i[s][l]|=r.flag.fl(n.depth))}))})),t.force=!0,await i.forEachAsync((async(t,i,l)=>{if(!t)return;const a=this.cells[i][l];if(!a.hasCellFlag(u.EVENT_FIRED_THIS_TURN))for(let n=0;n<=s.GAS;++n)t&r.flag.fl(n)&&await a.fire(e,this,i,l,{force:!0,depth:n})})),r.grid.free(i),!1}async activateMachine(e,t,i,s={}){let r=!1;s.originX=t,s.originY=i;for(let t=0;t<this.width;++t)for(let i=0;i<this.height;++i){const l=this.cells[t][i];l.machineId===e&&(l.hasEffect("machine")&&(r=await l.fire("machine",this,t,i,s)||r))}return r}getAppearanceAt(e,t,i){i.blackOut();const s=this.cells[e][t],l=this.fov.isAnyKindOfVisible(e,t);if(!s.hasCellFlag(u.STABLE_SNAPSHOT)||s.needsRedraw&&l?(this.layers.forEach((s=>s.putAppearance(i,e,t))),i.dances?s.setCellFlag(u.COLORS_DANCE):s.clearCellFlag(u.COLORS_DANCE),i.bake(),this._memory[e][t].putSnapshot(i),s.needsRedraw=!1,s.setCellFlag(u.STABLE_SNAPSHOT)):this._memory[e][t].getSnapshot(i),l){const s=this.light.getLight(e,t);i.multiply(s)}else this.fov.isRevealed(e,t)?i.scale(50):i.blackOut();s.hasEntityFlag(a.L_VISUALLY_DISTINCT)&&r.color.separate(i.fg,i.bg)}hasActor(e,t){return this.cells[e][t].hasActor()}eachGlowLight(e){this.cells.forEach(((t,i,s)=>{t.eachGlowLight((t=>e(i,s,t)))}))}eachDynamicLight(e){}eachViewport(e){}lightingChanged(){return this.light.changed}hasVisibleLight(e,t){return!this.light.isDark(e,t)}blocksVision(e,t){return this.cells[e][t].blocksVision()}onCellRevealed(e,t){}redrawCell(e,t,i){i&&this.clearMemory(e,t),this.cells[e][t].needsRedraw=!0}clearMemory(e,t){this._memory[e][t].clear()}storeMemory(e,t,i=!1){const s=this.cells[e][t],r=this._memory[e][t];if(r.store(s),s.setCellFlag(u.STABLE_MEMORY),i||!s.hasCellFlag(u.STABLE_SNAPSHOT)){const i=r.snapshot;i.blackOut(),this.layers.forEach((s=>s.putAppearance(i,e,t))),i.bake(),s.setCellFlag(u.STABLE_SNAPSHOT)}}}function we(e,t,i={},s){"string"==typeof i&&(i={tile:i}),s&&(i.boundary=s),!0===i.tile&&(i.tile="FLOOR"),!0===i.boundary&&(i.boundary="WALL");const r=new Pe(e,t,i);return i.tile&&(r.fill(i.tile,i.boundary),r.light.update()),r}function be(e,t){const i=r.grid.alloc(e.width,e.height),s=r.grid.alloc(e.width,e.height);for(let t=0;t<e.width;t++)for(let s=0;s<e.height;s++){const r=e.cell(t,s);!r.blocksPathing()&&!r.blocksMove()||r.hasEntityFlag(a.L_SECRETLY_PASSABLE)?i[t][s]=1:i[t][s]=0}let l;for(let t=1;t<i.width-1;t++)for(let s=1;s<i.height-1;s++)if(e.cell(t,s).flags.cell&=~u.IS_CHOKEPOINT,i[t][s]&&!(e.cell(t,s).flags.cell&u.IS_IN_LOOP)){l=0;for(let a=0;a<8;a++){const n=t+r.xy.CLOCK_DIRS[(a+7)%8][0],o=s+r.xy.CLOCK_DIRS[(a+7)%8][1],h=t+r.xy.CLOCK_DIRS[a][0],c=s+r.xy.CLOCK_DIRS[a][1];if((e.hasXY(h,c)&&i[h][c])!=(e.hasXY(n,o)&&i[n][o])&&++l>2){(i[t-1][s]||i[t+1][s])&&(i[t][s-1]||i[t][s+1])||(e.cell(t,s).flags.cell|=u.IS_CHOKEPOINT);break}}}if(t){for(let t=0;t<e.width;t++)for(let i=0;i<e.height;i++)e.cell(t,i).chokeCount=3e4;for(let t=0;t<e.width;t++)for(let l=0;l<e.height;l++){const a=e.cell(t,l);if(i[t][l]&&a.flags.cell&u.IS_CHOKEPOINT)for(let n=0;n<4;n++){const o=t+r.xy.DIRS[n][0],h=l+r.xy.DIRS[n][1];if(e.hasXY(o,h)&&i[o][h]&&!(e.cell(o,h).flags.cell&u.IS_CHOKEPOINT)){s.fill(0),i[t][l]=0;let r=Be(e,s,i,o,h);if(i[t][l]=1,r>=4){for(let t=0;t<s.width;t++)for(let i=0;i<s.height;i++)s[t][i]&&r<e.cell(t,i).chokeCount&&(e.cell(t,i).chokeCount=r,e.cell(t,i).flags.cell&=~u.IS_GATE_SITE);r<a.chokeCount&&(a.chokeCount=r,a.flags.cell|=u.IS_GATE_SITE)}}}}}r.grid.free(i),r.grid.free(s)}function Be(e,t,i,s,l){function a(t,s){let r=2==i[t][s]?5e3:1;return e.cell(t,s).flags.cell&u.IS_IN_AREA_MACHINE&&(r=1e4),r}let n=0;const o=[[s,l]],h=[];for(;o.length;){const s=o.pop();h.push(s);const l=s[0],c=s[1];if(!t[l][c]){t[l][c]=1,n+=a(l,c);for(let s=0;s<4;s++){const a=l+r.xy.DIRS[s][0],n=c+r.xy.DIRS[s][1];if(e.hasXY(a,n)&&i[a][n]&&!t[a][n]){const e=h.pop()||[-1,-1];e[0]=a,e[1]=n,o.push(e)}}}}return Math.min(n,1e4)}function He(e){e.eachCell(ke),Ue(e),Ve(e)}function ke(e,t,i,s){!e.blocksPathing()&&!e.blocksMove()||e.hasEntityFlag(a.L_SECRETLY_PASSABLE)?e.flags.cell|=u.IS_IN_LOOP:e.flags.cell&=~u.IS_IN_LOOP}function Ue(e){let t,i,s,l,a,n,o,h;const c=r.grid.alloc(e.width,e.height,1);let _=!0;for(;_;)_=!1,c.forEach(((f,E,g)=>{if(!f)return;const T=e.cell(E,g);if(c[E][g]=0,T.hasCellFlag(u.IS_IN_LOOP)){for(a=0;a<8;a++){if(i=E+r.xy.CLOCK_DIRS[a][0],s=g+r.xy.CLOCK_DIRS[a][1],!e.hasXY(i,s))continue;if(!e.cell(i,s).hasCellFlag(u.IS_IN_LOOP))break}if(8!=a){for(n=o=h=0,t=!1,l=a;l<a+8;l++){if(i=E+r.xy.CLOCK_DIRS[l%8][0],s=g+r.xy.CLOCK_DIRS[l%8][1],!e.hasXY(i,s))continue;if(e.cell(i,s).hasCellFlag(u.IS_IN_LOOP)){if(h++,!t&&(n++,t=!0,n>1))break}else t&&(h>o&&(o=h),h=0,t=!1)}if(t&&h>o&&(o=h),1==n&&o<=4)for(T.clearCellFlag(u.IS_IN_LOOP),l=0;l<8;l++)i=E+r.xy.CLOCK_DIRS[l][0],s=g+r.xy.CLOCK_DIRS[l][1],e.hasXY(i,s)&&e.cell(i,s).hasCellFlag(u.IS_IN_LOOP)&&(c[i][s]=1,_=!0)}}}))}function Ke(e,t){for(let i=0;i<e.width;++i)for(let s=0;s<e.height;++s){if(e.cell(i,s).flags.cell&u.IS_IN_LOOP)t[i][s]=1;else if(i>0&&s>0){const r=e.cell(i,s-1),l=e.cell(i-1,s);r.flags.cell&u.IS_IN_LOOP&&l.flags.cell&u.IS_IN_LOOP&&(t[i][s]=1)}}}function Ve(e){const t=r.grid.alloc(e.width,e.height);let i;Ke(e,t);for(let s=0;s<t.width;s++)for(let l=0;l<t.height;l++){if(e.cell(s,l).flags.cell&u.IS_IN_LOOP){i=!1;for(let a=0;a<8;a++){let n=s+r.xy.CLOCK_DIRS[a][0],o=l+r.xy.CLOCK_DIRS[a][1];if(e.hasXY(n,o)&&!t[n][o]&&!(e.cell(n,o).flags.cell&u.IS_IN_LOOP)){i=!0;break}}i||(t[s][l]=1,e.cell(s,l).flags.cell&=~u.IS_IN_LOOP)}}r.grid.free(t)}class Ye{constructor(e){this.map=new Pe(e.width,e.height),this.version=0}}function Ge(e,t,i){return r.xy.arcCount(t,i,((t,i)=>e.cell(t,i).isPassable()))>1}var xe=Object.freeze({__proto__:null,Cell:Fe,Map:Pe,make:we,from:function(e,t,i={}){let s,r=0,l=0;return"string"==typeof e&&(e=e.split("\n")),!function(e){return Array.isArray(e)&&"string"==typeof e[0]}(e)?(r=e.height,l=e.width,s=we(l,r,i),e.forEach(((e,i,r)=>{const l=t[e]||"FLOOR";s.setTile(i,r,l)}))):(r=e.length,l=e.reduce(((e,t)=>Math.max(e,t.length)),0),s=we(l,r,i),e.forEach(((e,i)=>{for(let r=0;r<l;++r){const l=e[r]||".",a=t[l]||"FLOOR";s.setTile(r,i,a)}}))),s.light.update(),s},analyze:function(e,t=!0){He(e),be(e,t)},updateChokepoints:be,floodFillCount:Be,updateLoopiness:He,resetLoopiness:ke,checkLoopiness:Ue,fillInnerLoopGrid:Ke,cleanLoopiness:Ve,CellMemory:ve,Snapshot:Ye,SnapshotManager:class{constructor(e){this.version=0,this.layerVersion=[],this.lightVersion=0,this.fovVersion=0,this.free=[],this.map=e,this.cellVersion=r.grid.make(e.width,e.height),this.layerVersion=e.layers.map((()=>1))}takeNew(){++this.version;const e=this.free.length?this.free.pop():new Ye(this.map);return e.map.flags.map=this.map.flags.map,this.cellVersion.update(((t,i,s)=>{const r=this.map.cell(i,s);if(r.changed&&(t=this.version),t!==e.version){e.map.cell(i,s).copy(r)}return t})),this.map.light.changed&&(this.lightVersion=this.version,this.map.light.changed=!1),e.version!==this.lightVersion&&e.map.light.copy(this.map.light),this.map.fov.changed&&(this.fovVersion=this.version,this.map.fov.changed=!1),e.version!==this.fovVersion&&e.map.fov.copy(this.map.fov),this.map.layers.forEach(((t,i)=>{const s=e.map.layers[i];t.changed&&(this.layerVersion[i]=this.version),this.layerVersion[i]!==e.version&&s.copy(t)})),e.version=this.version,e}revertMapTo(e){this.cellVersion.update(((t,i,s)=>{if(t<e.version)return t;const r=this.map.cell(i,s);if(t>e.version||r.changed){const t=e.map.cell(i,s);return r.copy(t),e.version}return t})),(e.version<this.lightVersion||this.map.light.changed)&&(this.map.light.copy(e.map.light),this.lightVersion=e.version),(e.version<this.fovVersion||this.map.fov.changed)&&(this.map.fov.copy(e.map.fov),this.fovVersion=e.version),this.layerVersion.forEach(((t,i)=>{if(t<e.version)return;const s=this.map.layers[i];if(t>e.version||s.changed){const t=e.map.layers[i];s.copy(t),this.layerVersion[i]=e.version}})),this.version=e.version}release(e){this.free.push(e)}},isHallway:Ge});function We(e,t,i){const s=e.cell(t,i);return s.blocksMove()?r.path.OBSTRUCTION:s.blocksPathing()?r.path.FORBIDDEN:s.hasActor()?10:1}function Xe(e,t){t.update(((t,i,s)=>We(e,i,s)))}var je=Object.freeze({__proto__:null,getCellPathCost:We,fillCostMap:Xe,getPathBetween:function(e,t,i,s,l,a={}){const n=r.grid.alloc(e.width,e.height),o=r.grid.alloc(e.width,e.height);Xe(e,o),r.path.calculateDistances(n,t,i,o,a.eightWays,r.xy.straightDistanceBetween(t,i,s,l)+1);const h=r.path.getPath(n,s,l,((t,i)=>e.cell(t,i).blocksMove()),a.eightWays);return r.grid.free(o),r.grid.free(n),h}});class qe{constructor(e){this.tags=[],this.members={},this.flags={horde:0},e.tags&&("string"==typeof e.tags?this.tags=e.tags.split(/[,|]/).map((e=>e.trim())):this.tags=e.tags.slice()),this.leader=e.leader,e.members&&Object.entries(e.members).forEach((([e,t])=>{this.members[e]=r.range.make(t)})),this.frequency=r.frequency.make(e.frequency||100),this.flags.horde=r.flag.from(p,e.flags)}async spawn(e,t=-1,i=-1,s={}){var r,l;"boolean"==typeof s&&(s={canBeVisible:s}),s.canBeVisible=null!==(r=s.canBeVisible)&&void 0!==r?r:!e.fov.isEnabled,s.rng=s.rng||e.rng,s.machine=null!==(l=s.machine)&&void 0!==l?l:0;const a=await this._spawnLeader(e,t,i,s);return a?(await this._spawnMembers(a,e,s),a):null}async _spawnLeader(e,t,i,s){const r=F(this.leader);if(!r)throw new Error("Failed to find leader kind = "+this.leader);if(t>=0&&i>=0&&r.avoidsCell(e.cell(t,i)))return null;const l=D(r,{machineHome:s.machine});if(!l)throw new Error("Failed to make horde leader - "+this.leader);return(t<0||i<0)&&([t,i]=this._pickLeaderLoc(l,e,s)||[-1,-1],t<0||i<0)?null:await this._addLeader(l,e,t,i,s)?l:null}async _addLeader(e,t,i,s,r){return t.addActor(i,s,e)}async _addMember(e,t,i,s,r,l){return e.leader=r,t.addActor(i,s,e)}async _spawnMembers(e,t,i){const s=Object.entries(this.members);if(0==s.length)return 0;return await Promise.all(s.map((async([s,r])=>{const l=r.value(i.rng);for(let r=0;r<l;++r)await this._spawnMember(s,t,e,i)}))),0}async _spawnMember(e,t,i,s){const r=F(e);if(!r)throw new Error("Failed to find member kind = "+e);const l=D(r,{machineHome:s.machine});if(!l)throw new Error("Failed to make horde member - "+e);const[a,n]=this._pickMemberLoc(l,t,i,s)||[-1,-1];return a<0||n<0?null:await this._addMember(l,t,a,n,i,s)?l:null}_pickLeaderLoc(e,t,i){return i.rng.matchingLoc(t.width,t.height,((s,r)=>{const l=t.cell(s,r);return!l.hasActor()&&(!(!i.canBeVisible&&t.fov.isAnyKindOfVisible(s,r))&&(!e.avoidsCell(l)&&!Ge(t,s,r)))}))}_pickMemberLoc(e,t,i,s){return s.rng.matchingLocNear(i.x,i.y,((i,s)=>{if(!t.hasXY(i,s))return!1;const r=t.cell(i,s);return!r.hasActor()&&(!e.avoidsCell(r)&&!Ge(t,i,s))}))}}const Qe={};function ze(e,t){return"string"==typeof t&&(t={leader:t}),t instanceof qe||(t=new qe(t)),Qe[e]=t,t}var Je=Object.freeze({__proto__:null,Horde:qe,hordes:Qe,install:ze,installAll:function(e){Object.entries(e).forEach((([e,t])=>{ze(e,t)}))},from:function(e){return e instanceof qe?e:"string"==typeof e?Qe[e]:new qe(e)},random:function(e={}){const t={tags:[],forbidTags:[],flags:0,forbidFlags:0,depth:0};"string"==typeof e&&(e={tags:e});const i=e.rng||r.rng.random;if("string"==typeof e.tags?e.tags.split(/[,|&]/).map((e=>e.trim())).forEach((e=>{e.startsWith("!")?t.forbidTags.push(e.substring(1).trim()):t.tags.push(e)})):Array.isArray(e.tags)&&(t.tags=e.tags.slice()),"string"==typeof e.forbidTags?t.forbidTags=e.forbidTags.split(/[,|&]/).map((e=>e.trim())):Array.isArray(e.forbidTags)&&(t.forbidTags=e.forbidTags.slice()),e.flags&&"string"==typeof e.flags&&e.flags.split(/[,|]/).map((e=>e.trim())).forEach((e=>{if(e.startsWith("!")){const i=e.substring(1);t.forbidFlags|=p[i]}else t.flags|=p[e]})),e.forbidFlags&&(t.forbidFlags=r.flag.from(p,e.forbidFlags)),e.depth&&(t.depth=e.depth),t.depth&&e.oodChance){for(;i.chance(e.oodChance);)t.depth+=1;t.forbidFlags|=p.HORDE_NEVER_OOD}const s=Object.values(Qe).filter((e=>!(t.tags.length&&!r.arraysIntersect(t.tags,e.tags))&&((!t.forbidTags||!r.arraysIntersect(t.forbidTags,e.tags))&&(!(t.flags&&!(e.flags.horde&t.flags))&&!(t.forbidFlags&&e.flags.horde&t.forbidFlags)))));if(t.depth)return i.item(s)||null;const l=t.depth,a=s.map((e=>e.frequency(l))),n=i.weighted(a);return n<0?null:s[n]}});e.actor=w,e.effect=me,e.entity=y,e.flags=m,e.horde=Je,e.item=V,e.layer=De,e.map=xe,e.path=je,e.tile=se,Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=gw-map.min.js.map
