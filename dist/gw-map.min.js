!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("gw-utils")):"function"==typeof define&&define.amd?define(["exports","gw-utils"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).GWM={},t.GWU)}(this,(function(t,e){"use strict";function i(t){if(t&&t.__esModule)return t;var e=Object.create(null);return t&&Object.keys(t).forEach((function(i){if("default"!==i){var s=Object.getOwnPropertyDescriptor(t,i);Object.defineProperty(e,i,s.get?s:{enumerable:!0,get:function(){return t[i]}})}})),e.default=t,Object.freeze(e)}var s,r=i(e);!function(t){t[t.ALL_LAYERS=-1]="ALL_LAYERS",t[t.GROUND=0]="GROUND",t[t.SURFACE=1]="SURFACE",t[t.ITEM=2]="ITEM",t[t.ACTOR=3]="ACTOR",t[t.LIQUID=4]="LIQUID",t[t.GAS=5]="GAS",t[t.FX=6]="FX",t[t.UI=7]="UI"}(s||(s={}));const a=r.flag.fl;var n;!function(t){t[t.L_DESTROYED=a(1)]="L_DESTROYED",t[t.L_SECRETLY_PASSABLE=a(2)]="L_SECRETLY_PASSABLE",t[t.L_BLOCKS_MOVE=a(3)]="L_BLOCKS_MOVE",t[t.L_BLOCKS_VISION=a(4)]="L_BLOCKS_VISION",t[t.L_BLOCKS_SURFACE=a(6)]="L_BLOCKS_SURFACE",t[t.L_BLOCKS_LIQUID=a(8)]="L_BLOCKS_LIQUID",t[t.L_BLOCKS_GAS=a(7)]="L_BLOCKS_GAS",t[t.L_BLOCKS_ITEMS=a(5)]="L_BLOCKS_ITEMS",t[t.L_BLOCKS_ACTORS=a(11)]="L_BLOCKS_ACTORS",t[t.L_BLOCKS_EFFECTS=a(9)]="L_BLOCKS_EFFECTS",t[t.L_BLOCKS_DIAGONAL=a(10)]="L_BLOCKS_DIAGONAL",t[t.L_INTERRUPT_WHEN_SEEN=a(12)]="L_INTERRUPT_WHEN_SEEN",t[t.L_NO_SIDEBAR=a(13)]="L_NO_SIDEBAR",t[t.L_VISUALLY_DISTINCT=a(14)]="L_VISUALLY_DISTINCT",t[t.L_BRIGHT_MEMORY=a(15)]="L_BRIGHT_MEMORY",t[t.L_INVERT_WHEN_HIGHLIGHTED=a(16)]="L_INVERT_WHEN_HIGHLIGHTED",t[t.L_ON_MAP=a(17)]="L_ON_MAP",t[t.L_IN_SIDEBAR=a(18)]="L_IN_SIDEBAR",t[t.L_FORMAL_NAME=a(20)]="L_FORMAL_NAME",t[t.L_ALWAYS_PLURAL=a(21)]="L_ALWAYS_PLURAL",t[t.DEFAULT_ACTOR=0]="DEFAULT_ACTOR",t[t.DEFAULT_ITEM=0]="DEFAULT_ITEM",t[t.L_BLOCKED_BY_STAIRS=t.L_BLOCKS_ITEMS|t.L_BLOCKS_SURFACE|t.L_BLOCKS_GAS|t.L_BLOCKS_LIQUID|t.L_BLOCKS_EFFECTS|t.L_BLOCKS_ACTORS]="L_BLOCKED_BY_STAIRS",t[t.L_BLOCKS_SCENT=t.L_BLOCKS_MOVE|t.L_BLOCKS_VISION]="L_BLOCKS_SCENT",t[t.L_DIVIDES_LEVEL=t.L_BLOCKS_MOVE]="L_DIVIDES_LEVEL",t[t.L_WAYPOINT_BLOCKER=t.L_BLOCKS_MOVE]="L_WAYPOINT_BLOCKER",t[t.L_WALL_FLAGS=t.L_BLOCKS_MOVE|t.L_BLOCKS_VISION|t.L_BLOCKS_LIQUID|t.L_BLOCKS_GAS|t.L_BLOCKS_EFFECTS|t.L_BLOCKS_DIAGONAL]="L_WALL_FLAGS",t[t.L_BLOCKS_EVERYTHING=t.L_WALL_FLAGS|t.L_BLOCKS_ITEMS|t.L_BLOCKS_ACTORS|t.L_BLOCKS_SURFACE]="L_BLOCKS_EVERYTHING"}(n||(n={}));const h=r.flag.fl;var o,l;!function(t){t[t.IS_PLAYER=h(0)]="IS_PLAYER",t[t.HAS_MEMORY=h(1)]="HAS_MEMORY",t[t.USES_FOV=h(2)]="USES_FOV",t[t.STABLE_COST_MAP=h(3)]="STABLE_COST_MAP",t[t.IS_VISIBLE=h(4)]="IS_VISIBLE",t[t.WAS_VISIBLE=h(5)]="WAS_VISIBLE",t[t.DEFAULT=0]="DEFAULT"}(o||(o={})),function(t){t[t.DEFAULT=0]="DEFAULT"}(l||(l={}));const c=r.flag.fl;var d;!function(t){t[t.T_BRIDGE=c(0)]="T_BRIDGE",t[t.T_AUTO_DESCENT=c(1)]="T_AUTO_DESCENT",t[t.T_LAVA=c(2)]="T_LAVA",t[t.T_DEEP_WATER=c(3)]="T_DEEP_WATER",t[t.T_SHALLOW_WATER=c(4)]="T_SHALLOW_WATER",t[t.T_IS_FLAMMABLE=c(5)]="T_IS_FLAMMABLE",t[t.T_SPONTANEOUSLY_IGNITES=c(6)]="T_SPONTANEOUSLY_IGNITES",t[t.T_IS_FIRE=c(7)]="T_IS_FIRE",t[t.T_EXTINGUISHES_FIRE=c(8)]="T_EXTINGUISHES_FIRE",t[t.T_IS_SECRET=c(9)]="T_IS_SECRET",t[t.T_IS_TRAP=c(10)]="T_IS_TRAP",t[t.T_SACRED=c(11)]="T_SACRED",t[t.T_UP_STAIRS=c(12)]="T_UP_STAIRS",t[t.T_DOWN_STAIRS=c(13)]="T_DOWN_STAIRS",t[t.T_PORTAL=c(14)]="T_PORTAL",t[t.T_IS_DOOR=c(15)]="T_IS_DOOR",t[t.T_ALLOWS_SUBMERGING=c(16)]="T_ALLOWS_SUBMERGING",t[t.T_ENTANGLES=c(17)]="T_ENTANGLES",t[t.T_REFLECTS=c(18)]="T_REFLECTS",t[t.T_STAND_IN_TILE=c(19)]="T_STAND_IN_TILE",t[t.T_CONNECTS_LEVEL=c(20)]="T_CONNECTS_LEVEL",t[t.T_BLOCKS_OTHER_LAYERS=c(21)]="T_BLOCKS_OTHER_LAYERS",t[t.T_LIST_IN_SIDEBAR=c(22)]="T_LIST_IN_SIDEBAR",t[t.T_HAS_STAIRS=t.T_UP_STAIRS|t.T_DOWN_STAIRS|t.T_PORTAL]="T_HAS_STAIRS",t[t.T_OBSTRUCTS_SCENT=t.T_AUTO_DESCENT|t.T_LAVA|t.T_DEEP_WATER|t.T_SPONTANEOUSLY_IGNITES|t.T_HAS_STAIRS]="T_OBSTRUCTS_SCENT",t[t.T_PATHING_BLOCKER=t.T_AUTO_DESCENT|t.T_IS_TRAP|t.T_LAVA|t.T_DEEP_WATER|t.T_IS_FIRE|t.T_SPONTANEOUSLY_IGNITES|t.T_ENTANGLES]="T_PATHING_BLOCKER",t[t.T_LAKE_PATHING_BLOCKER=t.T_AUTO_DESCENT|t.T_LAVA|t.T_DEEP_WATER|t.T_SPONTANEOUSLY_IGNITES]="T_LAKE_PATHING_BLOCKER",t[t.T_WAYPOINT_BLOCKER=t.T_AUTO_DESCENT|t.T_IS_TRAP|t.T_LAVA|t.T_DEEP_WATER|t.T_SPONTANEOUSLY_IGNITES]="T_WAYPOINT_BLOCKER",t[t.T_DIVIDES_LEVEL=t.T_AUTO_DESCENT|t.T_IS_TRAP|t.T_LAVA|t.T_DEEP_WATER]="T_DIVIDES_LEVEL",t[t.T_MOVES_ITEMS=t.T_DEEP_WATER|t.T_LAVA]="T_MOVES_ITEMS",t[t.T_CAN_BE_BRIDGED=t.T_AUTO_DESCENT|t.T_LAVA|t.T_DEEP_WATER]="T_CAN_BE_BRIDGED",t[t.T_IS_DEEP_LIQUID=t.T_LAVA|t.T_AUTO_DESCENT|t.T_DEEP_WATER]="T_IS_DEEP_LIQUID",t[t.T_ANY_LIQUID=t.T_IS_DEEP_LIQUID|t.T_SHALLOW_WATER]="T_ANY_LIQUID"}(d||(d={}));const u=r.flag.fl;var _;!function(t){t[t.TM_IS_WIRED=u(9)]="TM_IS_WIRED",t[t.TM_IS_CIRCUIT_BREAKER=u(10)]="TM_IS_CIRCUIT_BREAKER",t[t.TM_VANISHES_UPON_PROMOTION=u(15)]="TM_VANISHES_UPON_PROMOTION",t[t.TM_EXPLOSIVE_PROMOTE=u(21)]="TM_EXPLOSIVE_PROMOTE",t[t.TM_SWAP_ENCHANTS_ACTIVATION=u(25)]="TM_SWAP_ENCHANTS_ACTIVATION"}(_||(_={}));const g=r.flag.fl;var f;!function(t){t[t.PRESSURE_PLATE_DEPRESSED=g(0)]="PRESSURE_PLATE_DEPRESSED",t[t.SEARCHED_FROM_HERE=g(1)]="SEARCHED_FROM_HERE",t[t.KNOWN_TO_BE_SAFE=g(2)]="KNOWN_TO_BE_SAFE",t[t.CAUGHT_FIRE_THIS_TURN=g(3)]="CAUGHT_FIRE_THIS_TURN",t[t.EVENT_FIRED_THIS_TURN=g(4)]="EVENT_FIRED_THIS_TURN",t[t.EVENT_PROTECTED=g(5)]="EVENT_PROTECTED",t[t.IS_IN_LOOP=g(6)]="IS_IN_LOOP",t[t.IS_CHOKEPOINT=g(7)]="IS_CHOKEPOINT",t[t.IS_GATE_SITE=g(8)]="IS_GATE_SITE",t[t.IS_IN_ROOM_MACHINE=g(9)]="IS_IN_ROOM_MACHINE",t[t.IS_IN_AREA_MACHINE=g(10)]="IS_IN_AREA_MACHINE",t[t.IMPREGNABLE=g(11)]="IMPREGNABLE",t[t.NEEDS_REDRAW=g(13)]="NEEDS_REDRAW",t[t.STABLE_MEMORY=g(14)]="STABLE_MEMORY",t[t.STABLE_SNAPSHOT=g(15)]="STABLE_SNAPSHOT",t[t.HAS_PLAYER=g(16)]="HAS_PLAYER",t[t.HAS_ACTOR=g(17)]="HAS_ACTOR",t[t.HAS_DORMANT_MONSTER=g(18)]="HAS_DORMANT_MONSTER",t[t.HAS_ITEM=g(19)]="HAS_ITEM",t[t.HAS_FX=g(20)]="HAS_FX",t[t.HAS_TICK_EFFECT=g(22)]="HAS_TICK_EFFECT",t[t.IS_CURSOR=g(23)]="IS_CURSOR",t[t.IS_HIGHLIGHTED=g(24)]="IS_HIGHLIGHTED",t[t.IS_WIRED=g(26)]="IS_WIRED",t[t.IS_CIRCUIT_BREAKER=g(27)]="IS_CIRCUIT_BREAKER",t[t.IS_POWERED=g(28)]="IS_POWERED",t[t.COLORS_DANCE=g(30)]="COLORS_DANCE",t[t.CHANGED=t.NEEDS_REDRAW]="CHANGED",t[t.IS_IN_MACHINE=t.IS_IN_ROOM_MACHINE|t.IS_IN_AREA_MACHINE]="IS_IN_MACHINE",t[t.PERMANENT_CELL_FLAGS=t.HAS_ITEM|t.HAS_DORMANT_MONSTER|t.STABLE_MEMORY|t.SEARCHED_FROM_HERE|t.PRESSURE_PLATE_DEPRESSED|t.KNOWN_TO_BE_SAFE|t.IS_IN_LOOP|t.IS_CHOKEPOINT|t.IS_GATE_SITE|t.IS_IN_MACHINE|t.IMPREGNABLE]="PERMANENT_CELL_FLAGS",t[t.HAS_ANY_ACTOR=t.HAS_PLAYER|t.HAS_ACTOR]="HAS_ANY_ACTOR",t[t.HAS_ANY_OBJECT=t.HAS_ITEM|t.HAS_ANY_ACTOR]="HAS_ANY_OBJECT",t[t.CELL_DEFAULT=t.NEEDS_REDRAW]="CELL_DEFAULT"}(f||(f={}));const p=r.flag.fl;var E;!function(t){t[t.MAP_CHANGED=p(0)]="MAP_CHANGED",t[t.MAP_NEEDS_REDRAW=p(1)]="MAP_NEEDS_REDRAW",t[t.MAP_ALWAYS_LIT=p(3)]="MAP_ALWAYS_LIT",t[t.MAP_SAW_WELCOME=p(4)]="MAP_SAW_WELCOME",t[t.MAP_HAS_LIQUID=p(5)]="MAP_HAS_LIQUID",t[t.MAP_HAS_GAS=p(6)]="MAP_HAS_GAS",t[t.MAP_HAS_FIRE=p(7)]="MAP_HAS_FIRE",t[t.MAP_CALC_FOV=p(10)]="MAP_CALC_FOV",t[t.MAP_FOV_CHANGED=p(11)]="MAP_FOV_CHANGED",t[t.MAP_DANCES=p(12)]="MAP_DANCES",t[t.MAP_SIDEBAR_TILES_CHANGED=p(13)]="MAP_SIDEBAR_TILES_CHANGED",t[t.MAP_SIDEBAR_CHANGED=p(14)]="MAP_SIDEBAR_CHANGED",t[t.MAP_DEFAULT=0]="MAP_DEFAULT"}(E||(E={}));const m=r.flag.fl;var A;!function(t){t[t.E_NEXT_ALWAYS=m(0)]="E_NEXT_ALWAYS",t[t.E_NEXT_EVERYWHERE=m(1)]="E_NEXT_EVERYWHERE",t[t.E_FIRED=m(2)]="E_FIRED",t[t.E_NO_MARK_FIRED=m(3)]="E_NO_MARK_FIRED",t[t.E_PROTECTED=m(4)]="E_PROTECTED",t[t.E_TREAT_AS_BLOCKING=m(5)]="E_TREAT_AS_BLOCKING",t[t.E_PERMIT_BLOCKING=m(6)]="E_PERMIT_BLOCKING",t[t.E_ABORT_IF_BLOCKS_MAP=m(7)]="E_ABORT_IF_BLOCKS_MAP",t[t.E_BLOCKED_BY_ITEMS=m(8)]="E_BLOCKED_BY_ITEMS",t[t.E_BLOCKED_BY_ACTORS=m(9)]="E_BLOCKED_BY_ACTORS",t[t.E_BLOCKED_BY_OTHER_LAYERS=m(10)]="E_BLOCKED_BY_OTHER_LAYERS",t[t.E_SUPERPRIORITY=m(11)]="E_SUPERPRIORITY",t[t.E_IGNORE_FOV=m(12)]="E_IGNORE_FOV",t[t.E_EVACUATE_CREATURES=m(15)]="E_EVACUATE_CREATURES",t[t.E_EVACUATE_ITEMS=m(16)]="E_EVACUATE_ITEMS",t[t.E_BUILD_IN_WALLS=m(17)]="E_BUILD_IN_WALLS",t[t.E_MUST_TOUCH_WALLS=m(18)]="E_MUST_TOUCH_WALLS",t[t.E_NO_TOUCH_WALLS=m(19)]="E_NO_TOUCH_WALLS",t[t.E_CLEAR_GROUND=m(21)]="E_CLEAR_GROUND",t[t.E_CLEAR_SURFACE=m(22)]="E_CLEAR_SURFACE",t[t.E_CLEAR_LIQUID=m(23)]="E_CLEAR_LIQUID",t[t.E_CLEAR_GAS=m(24)]="E_CLEAR_GAS",t[t.E_CLEAR_TILE=m(25)]="E_CLEAR_TILE",t[t.E_CLEAR_CELL=t.E_CLEAR_GROUND|t.E_CLEAR_SURFACE|t.E_CLEAR_LIQUID|t.E_CLEAR_GAS]="E_CLEAR_CELL",t[t.E_ONLY_IF_EMPTY=t.E_BLOCKED_BY_ITEMS|t.E_BLOCKED_BY_ACTORS]="E_ONLY_IF_EMPTY",t[t.E_ACTIVATE_DORMANT_MONSTER=m(27)]="E_ACTIVATE_DORMANT_MONSTER",t[t.E_AGGRAVATES_MONSTERS=m(28)]="E_AGGRAVATES_MONSTERS",t[t.E_RESURRECT_ALLY=m(29)]="E_RESURRECT_ALLY"}(A||(A={}));const T=r.flag.fl;var y;!function(t){t[t.HORDE_DIES_ON_LEADER_DEATH=T(0)]="HORDE_DIES_ON_LEADER_DEATH",t[t.HORDE_IS_SUMMONED=T(1)]="HORDE_IS_SUMMONED",t[t.HORDE_SUMMONED_AT_DISTANCE=T(2)]="HORDE_SUMMONED_AT_DISTANCE",t[t.HORDE_NO_PERIODIC_SPAWN=T(4)]="HORDE_NO_PERIODIC_SPAWN",t[t.HORDE_ALLIED_WITH_PLAYER=T(5)]="HORDE_ALLIED_WITH_PLAYER",t[t.HORDE_NEVER_OOD=T(15)]="HORDE_NEVER_OOD"}(y||(y={}));var S=Object.freeze({__proto__:null,get Depth(){return s},get Entity(){return n},get Actor(){return o},get Item(){return l},get Tile(){return d},get TileMech(){return _},get Cell(){return f},get Map(){return E},get Effect(){return A},get Horde(){return y}});class I{constructor(t,e,i){this.x=t,this.y=e,this.disposable=i}matches(t,e){return this.x===t&&this.y===e}}class L{constructor(t){this.actor=null,this.item=null,this.x=0,this.y=0,this.target=null,this.dir=null,this.aware=!1,this.identified=!1,this.machine=0,this.try=!1,this.force=!1,this.good=!1,this.seen=!1,this.quiet=!1,this.ok=!1,this.failed=!1,this.done=!1,this.logged=!1,this.visible=!1,this.data={},this.map=t.map,this.actor=t.actor||null,this.item=t.item||null,this.target=t.target||null,!this.map&&this.actor&&(this.map=this.actor.map),!this.map&&this.item&&(this.map=this.item.map),this.game=t.game,!this.game&&this.map&&(this.game=this.map.game),void 0!==t.x?(this.x=t.x,this.y=t.y):this.actor?(this.x=this.actor.x,this.y=this.actor.y):this.item&&(this.x=this.item.x,this.y=this.item.y),this.originX=this.x,this.originY=this.y,this.key=!!t.key,t.force&&(this.force=!0),t.aware&&(this.aware=!0),t.machine&&(this.machine=t.machine)}isSuccess(){return this.ok}isFailed(){return this.failed}didSomething(){this.ok=!0}didNothing(){}fail(){this.failed=!0,this.done=!0}isDone(){return this.done}stop(){this.done=!0}reset(){this.done=!1,this.failed=!1,this.ok=!1}}class O{constructor(t){this._handlers={},this.onUnhandled=null,this._ctx=t}copy(t){Object.entries(t._handlers).forEach((([t,e])=>{e&&(this._handlers[t]=Array.isArray(e)?e.slice():e)}))}has(t){const e=this._handlers[t];return!!e&&e.some((t=>t&&!!t.fn))}on(t,e){if(Array.isArray(t)){const i=t.map((t=>this.on(t,e)));return()=>{i.forEach((t=>t()))}}if(Array.isArray(e)){const i=e.map((e=>this.on(t,e)));return()=>{i.forEach((t=>t()))}}let i=this._handlers[t];i||(i=this._handlers[t]=[]);const s={fn:e};return i.unshift(s),()=>{const e=this._handlers[t];Array.isArray(e)&&r.arrayNullify(e,s)}}load(t){Object.entries(t).forEach((([t,e])=>{this.on(t,e)}))}once(t,e){if(Array.isArray(t)){const i=t.map((t=>this.once(t,e)));return()=>{i.forEach((t=>t()))}}if(Array.isArray(e)){const i=e.map((e=>this.on(t,e)));return()=>{i.forEach((t=>t()))}}let i=this._handlers[t];i||(i=this._handlers[t]=[]);const s={fn:e,once:!0};return i.unshift(s),()=>{const e=this._handlers[t];Array.isArray(e)&&r.arrayNullify(e,s)}}off(t,e){if(Array.isArray(t))return void t.forEach((t=>this.off(t,e)));const i=this._handlers[t];if(i)if(e){const t=i.findIndex((t=>t&&t.fn===e));t>-1&&(i[t]=null)}else for(let t=0;t<i.length;++t)i[t]=null}trigger(t,e){if(!e)throw new Error("Need Action parameter.");if(Array.isArray(t)){let i=!1;for(let s of t)if(i=this.trigger(s,e)||i,e.isDone())return i;return i}const i=this._handlers[t];if(!i||0==i.length)return this._unhandled(t,e);for(let t=0;t<i.length;++t){const s=i[t];if(s&&(s.fn&&s.fn.call(this._ctx,e),s.once&&(i[t]=null)),e.isDone())break}return this._handlers[t]=i.filter((t=>t)),!0}_unhandled(t,e){return!!this.onUnhandled&&(this.onUnhandled(t,e),!0)}clear(){this._handlers={},this.onUnhandled=null}restart(){Object.keys(this._handlers).forEach((t=>{this._handlers[t]=this._handlers[t].filter((t=>t&&!t.once))}))}}const b=new O;function w(t,e){e.seen=!1,b.on(t,e)}function R(t,e={}){return e instanceof L||(e=new L(e)),e.actor&&!e.actor.canDoAction(t)||e.item&&!e.item.canDoAction(t)?e.fail():(e.map.trigger(t,e),void(e.isDone()||e.item&&(e.item.trigger(t,e),e.isDone())||(e.actor&&e.actor.trigger(t,e),e.isDone()||(e.game.trigger(t,e),e.isDone()||b.trigger(t,e)))))}function C(t,e){throw new Error("Unhandled action - "+t)}b.onUnhandled=C;var v=Object.freeze({__proto__:null,Action:L,Actions:O,install:w,doAction:R,defaultAction:C});let F=0;class D{constructor(t){this._map=null,this.key=null,this.machineHome=0,this.changed=!0,this.actions=new O(this),this._actions={},this.depth=1,this.light=null,this.flags={entity:0},this.next=null,this.x=-1,this.y=-1,this.kind=t,this.id=""+ ++F}get map(){return this._map}isPlural(){return this.hasEntityFlag(n.L_ALWAYS_PLURAL)}isOnMap(){return!!this._map}addToMap(t,e,i){return this.x=e,this.y=i,this.setEntityFlag(n.L_ON_MAP),this._map!==t&&(this._map=t,this.kind.addToMap(this,t),!0)}removeFromMap(){this.clearEntityFlag(n.L_ON_MAP),this.kind.removeFromMap(this)}get sprite(){return this.kind.sprite}get isDestroyed(){return this.hasEntityFlag(n.L_DESTROYED)}isAt(t,e){return this.x===t&&this.y===e}clone(){const t=new this.constructor(this.kind);return t.copy(this),t}copy(t){this.depth=t.depth,this.light=t.light,Object.assign(this.flags,t.flags),this.next=t.next,this.x=t.x,this.y=t.y,this.kind=t.kind,this.id=t.id}canBeSeen(){return this.kind.canBeSeen(this)}destroy(){this.flags.entity|=n.L_DESTROYED}hasEntityFlag(t){return!!(this.flags.entity&t)}hasAllEntityFlags(t){return(this.flags.entity&t)===t}setEntityFlag(t){this.flags.entity|=t}clearEntityFlag(t){this.flags.entity&=~t}hasTag(t){return this.kind.tags.includes(t)}blocksMove(){return this.hasEntityFlag(n.L_BLOCKS_MOVE)}blocksVision(){return this.hasEntityFlag(n.L_BLOCKS_VISION)}blocksPathing(){return this.hasEntityFlag(n.L_BLOCKS_MOVE)}blocksEffects(){return this.hasEntityFlag(n.L_BLOCKS_EFFECTS)}isKey(t,e){return this.key&&this.key.matches(t,e)}forbidsCell(t){return this.kind.forbidsCell(t,this)}avoidsCell(t){return this.kind.avoidsCell(t,this)}getName(t){return this.kind.getName(this,t)}getDescription(t){return this.kind.getDescription(this,t)}getFlavor(t){return this.kind.getFlavor(this,t)}getVerb(t){return this.kind.getVerb(this,t)}drawSidebar(t,e){return this.kind.drawSidebar(this,t,e)}drawInto(t,e){t.drawSprite(this.sprite)}canDoAction(t){const e=this._actions[t];return void 0!==e?e:this.kind.canDoAction(t)}hasAction(t){return this.actions.has(t)||this.kind.actions.has(t)}on(t,e){this.actions.on(t,e)}once(t,e){this.actions.once(t,e)}off(t,e){this.actions.off(t,e)}trigger(t,e={}){e instanceof L||(e=new L(e)),e.isDone()||(this.actions.trigger(t,e),e.isDone()||this.kind.trigger(t,e))}toString(){return`${this.kind.id}-${this.id} @ ${this.x},${this.y}`}}D.default={sidebarFg:"purple"};class M{constructor(t){this.tags=[],this.requireTileFlags=0,this.forbidTileFlags=0,this.avoidTileFlags=0,this.requireTileTags=[],this.forbidTileTags=[],this.avoidTileTags=[],this.actions=new O(this),this._actions={},this.id=t.id||t.name,this.name=t.name,this.flavor=t.flavor||this.name,this.description=t.description||this.flavor,this.sprite=r.sprite.make(t.sprite?t.sprite:t),t.tags&&("string"==typeof t.tags?this.tags=t.tags.split(/[,|]/).map((t=>t.trim())):this.tags=t.tags.slice()),t.requireTileFlags&&(this.requireTileFlags=r.flag.from(d,t.requireTileFlags)),t.avoidTileFlags&&(this.avoidTileFlags=r.flag.from(d,t.avoidTileFlags)),t.forbidTileFlags&&(this.forbidTileFlags=r.flag.from(d,t.forbidTileFlags)),t.requireTileTags&&("string"==typeof t.requireTileTags&&(t.requireTileTags=t.requireTileTags.split(/[,|]/g)),this.requireTileTags=t.requireTileTags.map((t=>t.trim()))),t.avoidTileTags&&("string"==typeof t.avoidTileTags&&(t.avoidTileTags=t.avoidTileTags.split(/[,|]/g)),this.avoidTileTags=t.avoidTileTags.map((t=>t.trim()))),t.forbidTileTags&&("string"==typeof t.forbidTileTags&&(t.forbidTileTags=t.forbidTileTags.split(/[,|]/g)),this.forbidTileTags=t.forbidTileTags.map((t=>t.trim()))),t.drawSidebar&&(this.drawSidebar=t.drawSidebar),this.sidebarFg=r.color.from(t.sidebarFg||D.default.sidebarFg),t.actions&&Object.entries(t.actions).forEach((([t,e])=>this.on(t,e)))}make(t){const e=new D(this);return this.init(e,t),e}init(t,e={}){e.machineHome&&(t.machineHome=e.machineHome)}addToMap(t,e){}removeFromMap(t){}canBeSeen(t){return!0}forbidsCell(t,e){return!(!this.requireTileFlags||t.hasAllTileFlags(this.requireTileFlags)||t.hasTileFlag(d.T_BRIDGE))||(!(!this.forbidTileFlags||!t.hasTileFlag(this.forbidTileFlags)||t.hasTileFlag(d.T_BRIDGE))||(!(!this.requireTileTags.length||t.hasAllTileTags(this.requireTileTags)||t.hasTileFlag(d.T_BRIDGE))||!(!this.forbidTileTags.length||!t.hasAnyTileTag(this.forbidTileTags)||t.hasTileFlag(d.T_BRIDGE))))}avoidsCell(t,e){return!!this.forbidsCell(t,e)||(!(!this.avoidTileFlags||!t.hasTileFlag(this.avoidTileFlags)||t.hasTileFlag(d.T_BRIDGE))||!(!this.avoidTileTags.length||!t.hasAnyTileTag(this.avoidTileTags)||t.hasTileFlag(d.T_BRIDGE)))}getName(t,e){return this.name}getDescription(t,e){return this.description}getFlavor(t,e){return this.flavor}getVerb(t,e){return e}drawSidebar(t,e,i){if(!t.map)return 0;if(t.isDestroyed)return 0;const s=new r.sprite.Mixer;return t.map.getAppearanceAt(t.x,t.y,s),e.drawSprite(i.x+1,i.y,s),e.wrapText(i.x+3,i.y,i.width-3,t.getName(),this.sidebarFg),1}canDoAction(t){const e=this._actions[t];return void 0===e||e}on(t,e){Array.isArray(t)?t.forEach((t=>this.on(t,e))):!0===e?this._actions[t]=!0:!1===e?this._actions[t]=!1:(this.actions.on(t,e),this._actions[t]=!0)}off(t){Array.isArray(t)?t.forEach((t=>this.off(t))):this._actions[t]=!1}trigger(t,e={}){e instanceof L||(e=new L(e)),e.isDone()||this.actions.trigger(t,e)}}function N(t,e={}){return new M(t).make(e)}class x{constructor(){this._set={},this._time={},this._count={},this._done={},this._value={},this.changed=null}clear(t){return this.clearTime(t),this.clearCount(t),this.setOff(t),this._update(t)}get(t){return this._value[t]||!1}has(t){return this._value[t]||!1}_addDone(t,e){e&&(this._done[t]||(this._done[t]=e))}setCount(t,e,i){return this._count[t]=Math.max(e,this._count[t]||0),this._addDone(t,i),this._update(t)}increment(t,e=1,i){"function"==typeof e&&(i=e,e=1);return this._count[t]=(this._count[t]||0)+e,this._addDone(t,i),this._update(t)}decrement(t,e=1){return this._count[t]=Math.max(0,(this._count[t]||0)-e),this._update(t)}clearCount(t){return this._count[t]=0,this._update(t)}setOn(t,e){return this._set[t]=!0,this._addDone(t,e),this._update(t)}setOff(t){return this._set[t]=!1,this._update(t)}setTime(t,e,i){e=r.range.make(e).value();const s=this._time[t]||0;return this._time[t]=Math.max(e,s),this._addDone(t,i),this._update(t)}addTime(t,e=1,i){"function"==typeof e&&(i=e,e=1);return e=r.range.make(e).value(),this._time[t]=(this._time[t]||0)+e,this._addDone(t,i),this._update(t)}removeTime(t,e=1){return e=r.range.make(e).value(),this._time[t]=Math.max(0,(this._time[t]||0)-e),this._update(t)}clearTime(t){return this._time[t]=0,this._update(t)}decayAllTimes(t=1){const e=this,i={};let s=!1;for(let r in e._time)this.removeTime(r,t)&&(s=!0,i[r]=!1);return!!s&&i}_update(t){const e=this,i=this._value;let s=i[t],r=i[t]=e._set[t]||e._time[t]>0||e._count[t]>0||!1;const a=this._done[t];return!r&&a&&(a(this,t),e._done[t]=null),(s&&!r||!(s||!r))&&(this.changed&&this.changed(this,t),!0)}}class P{constructor(t={}){this._max={},this._rate={},this._value={},this.init(t)}get(t){return this._value[t]||0}getPct(t){const e=this.max(t);return e?Math.round(100*this.get(t)/e):0}max(t){return this._max[t]||0}regen(t){return this._rate[t]||null}init(t){for(let e in t)this.set(e,t[e])}set(t,e,i){if("number"!=typeof e){e=r.range.make(e).value()}this._value[t]=e,this._max[t]=i||e}gain(t,e,i=!1){"number"!=typeof e&&(e=r.range.value(e));let s=this._value[t]+e;i||(s=Math.min(s,this._max[t])),this._value[t]=s}drain(t,e){"number"!=typeof e&&(e=r.range.value(e)),this._value[t]=Math.max(0,this._value[t]-e)}raiseMax(t,e,i=!0){"number"!=typeof e&&(e=r.range.value(e)),this._max[t]+=e,i&&this.gain(t,e)}reduceMax(t,e,i=!1){"number"!=typeof e&&(e=r.range.value(e)),this._max[t]=Math.max(0,this._max[t]-e),i&&this.drain(t,e)}setRegen(t,e,i=1){const s=this._rate[t]=this._rate[t]||{elapsed:0};s.turns=e,s.count=i}regenAll(){for(let t in this._max){const e=this._rate[t];e.elapsed+=1,e.elapsed>=e.turns&&(this.gain(t,e.count),e.elapsed-=e.turns)}}restore(t,e){void 0===e&&(e=this._max[t]),this._value[t]=e}adjust(t,e,i){const s=(i=r.range.from(i)).value(),a=this.get(t);if("inc"===e)this.gain(t,i);else if("dec"===e)this.drain(t,i);else if("set"===e)this.set(t,i);else if("min"===e){const e=i.value();this.get(t)<e&&this.set(t,e)}else{if("max"!==e)throw new Error("Invalid stat adjust type: "+e);this.get(t)>s&&this.set(t,s)}return a!==this.get(t)}}class k extends D{constructor(t){super(t),this.ai={},this._action="idle",this._turnTime=0,this.leader=null,this.items=null,this.visionDistance=99,this.data={},this._costMap=null,this._goalMap=null,this._mapToMe=null,this.next=null,this.flags.actor=0,this.depth=s.ACTOR,this.kind=t,this.stats=new P,this.status=new x}setData(t,e){this.data[t]=e,this.changed=!0}copy(t){super.copy(t),this.leader=t.leader,this.items=t.items,this.visionDistance=t.visionDistance}destroy(){this.setEntityFlag(n.L_DESTROYED),this._costMap&&(r.grid.free(this._costMap),this._costMap=null),this._goalMap&&(r.grid.free(this._goalMap),this._goalMap=null),this._mapToMe&&(r.grid.free(this._mapToMe),this._mapToMe=null)}hasActorFlag(t){return!!(this.flags.actor&t)}hasAllActorFlags(t){return(this.flags.actor&t)===t}actorFlags(){return this.flags.actor}setActorFlag(t){this.flags.actor|=t}clearActorFlag(t){this.flags.actor&=~t}isPlayer(){return this.hasActorFlag(o.IS_PLAYER)}isDead(){return this.hasEntityFlag(n.L_DESTROYED)}getBumpActions(){return this.kind.bump}becameVisible(){return this.hasActorFlag(o.IS_VISIBLE)&&!this.hasActorFlag(o.WAS_VISIBLE)}canSee(t,e){return t instanceof D?this.canSee(t.x,t.y)&&this.kind.isAbleToSee(this,t):!!this.map&&(this.isPlayer()?this.map.fov.isDirectlyVisible(t,e):!(r.xy.distanceBetween(this.x,this.y,t,e)>this.visionDistance)&&r.xy.forLineBetween(this.x,this.y,t,e,((t,e)=>{if(this.map.cell(t,e).blocksVision())return!1})))}canSeeOrSense(t,e){return t instanceof D?this.canSeeOrSense(t.x,t.y)&&(this.kind.isAbleToSee(this,t)||this.kind.isAbleToSense(this,t)):this.map&&this.isPlayer()?this.map.fov.isAnyKindOfVisible(t,e):this.canSee(t,e)}isAbleToSee(t){return this.kind.isAbleToSee(this,t)}isAbleToSense(t){return this.kind.isAbleToSense(this,t)}setAction(t){if(!this.canDoAction(t))throw new Error("Actor cannot do action - "+t);this._action=t}clearAction(){this._action="idle"}act(t){let e=!1;return t.player.canSee(this)?(this.setActorFlag(o.IS_VISIBLE),e=!0):this.clearActorFlag(o.IS_VISIBLE),this.becameVisible()&&t.player.interrupt(this),R(this._action,{game:t,actor:this,map:this.map}),e||t.player.canSee(this),this._turnTime}moveSpeed(){return this.kind.moveSpeed}startTurn(){this._turnTime=0,this.hasActorFlag(o.IS_VISIBLE)?this.setActorFlag(o.WAS_VISIBLE):this.clearActorFlag(o.WAS_VISIBLE);const t=this.map;t&&t.fov.isAnyKindOfVisible(this.x,this.y)?this.setActorFlag(o.IS_VISIBLE):this.clearActorFlag(o.IS_VISIBLE)}endTurn(t=100){this.hasActorFlag(o.IS_VISIBLE)?this.setActorFlag(o.WAS_VISIBLE):this.clearActorFlag(o.WAS_VISIBLE);const e=this.map;e&&e.fov.isAnyKindOfVisible(this.x,this.y)?(this.setActorFlag(o.IS_VISIBLE),this.hasEntityFlag(n.L_NO_SIDEBAR)||this.hasEntityFlag(n.L_IN_SIDEBAR)||e.setMapFlag(E.MAP_SIDEBAR_CHANGED)):(this.clearActorFlag(o.IS_VISIBLE),e&&!this.hasEntityFlag(n.L_NO_SIDEBAR)&&this.hasEntityFlag(n.L_IN_SIDEBAR)&&e.setMapFlag(E.MAP_SIDEBAR_CHANGED)),this._turnTime=Math.max(this._turnTime,Math.floor(t*this.moveSpeed()/100))}willAttack(t){return!0}canPass(t){return!1}avoidsItem(t){return!1}canAddItem(t){return!1}addItem(t){}pickupItem(t,e){return this.kind.pickupItem(this,t,e)}dropItem(t,e){return this.kind.dropItem(this,t,e)}addToMap(t,e,i){const s=super.addToMap(t,e,i);return s&&this.clearActorFlag(o.STABLE_COST_MAP),s}removeFromMap(){super.removeFromMap(),this._costMap&&(r.grid.free(this._costMap),this._costMap=null),this._goalMap&&(r.grid.free(this._goalMap),this._goalMap=null),this._mapToMe&&(r.grid.free(this._mapToMe),this._mapToMe=null)}costMap(){if(!this.map)throw new Error("Actor must have map to calculate costMap.");const t=!this.hasActorFlag(o.STABLE_COST_MAP);if(t&&this._costMap&&(r.grid.free(this._costMap),this._costMap=null),this._costMap){if(!t)return this._costMap}else this._costMap=r.grid.alloc(this.map.width,this.map.height);const e=this.kind,i=this.map;return this._costMap.update(((t,s,r)=>{const a=i.cell(s,r);return e.cellCost(a,this)})),this.setActorFlag(o.STABLE_COST_MAP),this._costMap}get goalMap(){return this._goalMap}hasGoal(){return!!this._goalMap}setGoal(t,e){const i=this._map;if(!i)throw new Error("No map to set goal with!");this._goalMap||(this._goalMap=r.grid.alloc(i.width,i.height));const s=this._goalMap;return r.path.calculateDistances(s,t,e,this.costMap()),this._goalMap}clearGoal(){this._goalMap&&(r.grid.free(this._goalMap),this._goalMap=null)}mapToMe(){if(!this.map)throw new Error("No map!");return this._mapToMe||(this._mapToMe=r.grid.alloc(this.map.width,this.map.height)),this._mapToMe.x===this.x&&this._mapToMe.y===this.y||r.path.calculateDistances(this._mapToMe,this.x,this.y,this.costMap()),this._mapToMe}}k.default={sidebarFg:"purple"};const B={};function H(t,e){B[t.toLowerCase()]=e}function U(t,e){if(!t)return r.NOOP;if("string"==typeof t){if(!t.length)throw new Error("Cannot create effect from empty string.");if(!e){const i=t.split(":");t=i.shift().toLowerCase(),e=i}const i=B[t];if(!i)throw new Error("Failed to find effect - "+t);return i(e||{})}let i;if(Array.isArray(t))i=t.map((t=>U(t))).filter((t=>null!==t));else{if("function"==typeof t)return t;i=Object.entries(t).map((([t,e])=>U(t,e))).filter((t=>null!==t))}return 1===i.length?i[0]:t=>{const e=t.x,s=t.y;for(let r of i)if(t.x=e,t.y=s,r&&r(t),t.isDone())return}}function G(t){if(!t)return[];if(Array.isArray(t))return t.map((t=>U(t))).filter((t=>null!==t));if("string"==typeof t){if(!t.length)throw new Error("Cannot create effect from empty string.");const e=t.split(":");t=e.shift().toLowerCase();const i=B[t];return i?[i(e)]:[]}if("function"==typeof t)return[t];return Object.entries(t).map((([t,e])=>U(t,e))).filter((t=>null!==t))}const Y={};function V(t,e){const i=U(e);if(!i)throw new Error("Failed to make effect.");return Y[t]=i,i}var K=Object.freeze({__proto__:null,handlers:B,installHandler:H,make:U,makeArray:G,trigger:function(t,e,i,s,r){const a=Object.assign({map:e,x:i,y:s},r),n=new L(a),h=B[t];h&&h(n)},installed:Y,install:V,installAll:function(t){Object.entries(t).forEach((([t,e])=>{V(t,e)}))},resetAll:function(){Object.values(Y).forEach((t=>t.seen=!1))}});class W{constructor(t){var e,i,s,a;this.index=-1,this.dissipate=2e3,this.actions=new O(this),this.priority=50,this.depth=0,this.light=null,this.groundTile=null,this.tags=[],this.id=t.id||"n/a",this.dissipate=null!==(e=t.dissipate)&&void 0!==e?e:this.dissipate,this.priority=null!==(i=t.priority)&&void 0!==i?i:this.priority,this.depth=null!==(s=t.depth)&&void 0!==s?s:this.depth,this.light=t.light||null,this.groundTile=t.groundTile||null,this.sprite=r.sprite.make(t),this.name=t.name||"tile",this.description=t.description||this.name,this.flavor=t.flavor||this.name,this.article=null!==(a=t.article)&&void 0!==a?a:null,this.flags=t.flags||{entity:0,tile:0,tileMech:0},t.actions&&Object.entries(t.actions).forEach((([t,e])=>{this.on(t,e)})),t.tags&&("string"==typeof t.tags?t.tags.split(/[,|]/).map((t=>t.trim())).forEach((t=>{this.tags.push(t)})):this.tags=t.tags.slice().map((t=>t.trim())))}hasTag(t){return this.tags.includes(t)}hasAnyTag(t){return r.arraysIntersect(this.tags,t)}hasAllTags(t){return t.every((t=>this.tags.includes(t)))}hasEntityFlag(t){return!!(this.flags.entity&t)}hasTileFlag(t){return!!(this.flags.tile&t)}hasTileMechFlag(t){return!!(this.flags.tileMech&t)}hasAllEntityFlags(t){return(this.flags.entity&t)===t}hasAllTileFlags(t){return(this.flags.tile&t)===t}hasAllTileMechFlags(t){return(this.flags.tileMech&t)===t}blocksVision(){return!!(this.flags.entity&n.L_BLOCKS_VISION)}blocksMove(){return!!(this.flags.entity&n.L_BLOCKS_MOVE)}blocksPathing(){return this.blocksMove()||this.hasTileFlag(d.T_PATHING_BLOCKER)}blocksEffects(){return!!(this.flags.entity&n.L_BLOCKS_EFFECTS)}hasAction(t){return this.actions.has(t)}on(t,e){if(!e)return this.actions.off(t),void("fire"===t&&(this.flags.tile&=~d.T_IS_FLAMMABLE));if("string"==typeof e){const t=U(e);if(null===t)throw new Error("Failed to make effect: "+e);e=t}Array.isArray(e)?e.reverse().forEach((e=>this.on(t,e))):"object"==typeof e?Object.entries(e).reverse().forEach((([e,i])=>{const s=U(e,i);s&&this.on(t,s)})):(this.actions.on(t,e),"fire"===t&&(this.flags.tile|=d.T_IS_FLAMMABLE))}trigger(t,e={}){if(e instanceof L||(e=new L(e)),!e.map)throw new Error("Need action with a map.");this.actions.trigger(t,e)}isNull(){return this===$}isPassable(){return!this.blocksMove()}isWall(){return this.hasAllEntityFlags(n.L_WALL_FLAGS)}isDoor(){return this.hasTileFlag(d.T_IS_DOOR)}isStairs(){return this.hasTileFlag(d.T_HAS_STAIRS)}isFloor(){return!this.hasEntityFlag(n.L_BLOCKS_EVERYTHING)&&!this.hasTileFlag(d.T_PATHING_BLOCKER)}isDiggable(){return this.isNull()||this.isWall()}getName(t){let e={};if("boolean"==typeof t||"string"==typeof t?e.article=t:t&&(e=t),!e.article&&!e.color)return this.name;let i=this.name;if(e.color){let t=e.color;!0===e.color&&(t=this.sprite.fg||"white"),"string"!=typeof t&&(t=r.color.from(t).toString()),i=`Ω${t}Ω${this.name}∆`}if(e.article){i=("string"==typeof e.article?e.article:this.article||"a")+" "+i}return i}getDescription(t){return this.description||this.getName(t)}getFlavor(t){return this.flavor||this.getName(t)}}function j(t){var e,i,a,h,o,l;let c={flags:{},sprite:{},priority:50};if(t.extends&&(c=X[t.extends],!c))throw new Error("Failed to find base tile: "+t.extends);let u=c.priority;if("string"==typeof t.priority){let e=t.priority.replace(/ /g,""),i=e.search(/[+-]/);if(0==i)u=c.priority+Number.parseInt(e);else if(-1==i)if(0==e.search(/[a-zA-Z]/)){const t=X[e];if(!t)throw new Error("Failed to find tile for priority - "+e+".");u=t.priority}else u=Number.parseInt(e);else{const t=e.substring(0,i),s=Number.parseInt(e.substring(i)),r=X[t];if(!r)throw new Error("Failed to find tile for priority - "+t+".");u=r.priority+s}}else void 0!==t.priority&&(u=t.priority);const g={entity:r.flag.from(n,c.flags.entity,t.flags),tile:r.flag.from(d,c.flags.tile,t.flags),tileMech:r.flag.from(_,c.flags.tileMech,t.flags)};let f=c.depth||0;t.depth&&(f="string"==typeof t.depth?s[t.depth]:t.depth);let p=c.light;t.light?p=r.light.make(t.light):null===t.light&&(p=null);const E={id:t.id,flags:g,dissipate:null!==(e=t.dissipate)&&void 0!==e?e:c.dissipate,priority:u,depth:f,light:p,groundTile:t.groundTile||null,ch:null!==(i=t.ch)&&void 0!==i?i:c.sprite.ch,fg:null!==(a=t.fg)&&void 0!==a?a:c.sprite.fg,bg:null!==(h=t.bg)&&void 0!==h?h:c.sprite.bg,opacity:null!==(o=t.opacity)&&void 0!==o?o:c.sprite.opacity,name:t.name||c.name,description:t.description||c.description,flavor:t.flavor||c.flavor,article:null!==(l=t.article)&&void 0!==l?l:c.article,tags:t.tags||null},m=new W(E);return c&&c.actions&&m.actions.copy(c.actions),t.actions&&Object.entries(t.actions).forEach((([t,e])=>{m.on(t,e)})),m}const X={},q=[];function Q(t){if(t instanceof W)return t;if("string"==typeof t){const e=X[t];if(e)return e;throw new Error("Failed to find tile with id - "+t)}const e=q[t];if(e)return e;throw new Error("Failed to find tile with index - "+t)}function z(t,...e){let i=e[0];2==e.length&&(i=e[1],i.extends=e[0]),i.id=t;const s=j(i);return s.index=q.length,q.push(s),X[t]=s,s}const $=z("NULL",{ch:"∅",fg:"white",bg:"black",flags:"L_BLOCKS_MOVE",name:"eerie nothingness",article:"an",priority:0}),J={Tile:d,TileMech:_};var Z=Object.freeze({__proto__:null,flags:J,Tile:W,make:j,tiles:X,all:q,get:Q,install:z,installAll:function(t){Object.entries(t).forEach((([t,e])=>{z(t,e)}))},NULL:$});r.color.install("cellStatusName","light_blue");const tt={tiles:[$],item:null,actor:null,flags:{cell:0,entity:$.flags.entity,tile:$.flags.tile,tileMech:$.flags.tileMech}};class et{constructor(t,e,i,s){if(this.chokeCount=0,this.machineId=0,this.x=-1,this.y=-1,this.memory=null,this.volume=0,this.flags={cell:f.NEEDS_REDRAW},this.tiles=[X.NULL],this.map=t,this.x=e,this.y=i,this.snapshot=r.sprite.makeMixer(),s){const t=Q(s);this.setTile(t)}this.memory=tt}getSnapshot(t){t.copy(this.snapshot)}putSnapshot(t){this.snapshot.copy(t)}get hasStableSnapshot(){return this.hasCellFlag(f.STABLE_SNAPSHOT)}get hasStableMemory(){return this.hasCellFlag(f.STABLE_MEMORY)}storeMemory(){var t;if(this.setCellFlag(f.STABLE_MEMORY),this.memory={flags:{cell:this.flags.cell,entity:this.tiles.reduce(((t,e)=>t|((null==e?void 0:e.flags.entity)||0)),0),tile:this.tiles.reduce(((t,e)=>t|((null==e?void 0:e.flags.tile)||0)),0),tileMech:this.tiles.reduce(((t,e)=>t|((null==e?void 0:e.flags.tileMech)||0)),0)},tiles:this.tiles.slice(),item:(null===(t=this.item)||void 0===t?void 0:t.clone())||null,actor:null},this.hasItem()){const t=this.item;t&&(this.memory.flags.entity|=t.flags.entity)}if(this.hasActor()){const t=this.actor;t&&(this.memory.flags.entity|=t.flags.entity),this.clearCellFlag(f.STABLE_SNAPSHOT)}}clearMemory(){this.clearCellFlag(f.STABLE_SNAPSHOT|f.STABLE_MEMORY),this.memory=null,this.needsRedraw=!0}copy(t){Object.assign(this.flags,t.flags),this.chokeCount=t.chokeCount,this.tiles.length=t.tiles.length;for(let e=0;e<this.tiles.length;++e)this.tiles[e]=t.tiles[e];this.machineId=t.machineId,this.memory=t.memory,this.volume=t.volume,this.map=t.map,this.x=t.x,this.y=t.y,t.getSnapshot(this.snapshot)}hasCellFlag(t){return!!(this.flags.cell&t)}setCellFlag(t){this.flags.cell|=t}clearCellFlag(t){this.flags.cell&=~t}hasEntityFlag(t,e=!1){var i,s;return!!this.tiles.some((e=>e&&e.flags.entity&t))||!!e&&(!(!this.hasItem()||!(null===(i=this.item)||void 0===i?void 0:i.hasEntityFlag(t)))||!(!this.hasActor()||!(null===(s=this.actor)||void 0===s?void 0:s.hasEntityFlag(t))))}hasAllEntityFlags(t,e=!1){return(this.entityFlags(e)&t)==t}hasTileFlag(t){return this.tiles.some((e=>e&&e.flags.tile&t))}hasAllTileFlags(t){return(this.tileFlags()&t)==t}hasTileMechFlag(t){return this.tiles.some((e=>e&&e.flags.tileMech&t))}hasAllTileMechFlags(t){return(this.tileMechFlags()&t)==t}hasTileTag(t){return this.tiles.some((e=>e&&e.hasTag(t)))}hasAllTileTags(t){return this.tiles.some((e=>e&&e.hasAllTags(t)))}hasAnyTileTag(t){return this.tiles.some((e=>e&&e.hasAnyTag(t)))}cellFlags(){return this.flags.cell}entityFlags(t=!1){var e,i;let s=this.tiles.reduce(((t,e)=>t|(e?e.flags.entity:0)),0);return t&&(this.hasItem()&&(s|=(null===(e=this.item)||void 0===e?void 0:e.flags.entity)||0),this.hasActor()&&(s|=(null===(i=this.actor)||void 0===i?void 0:i.flags.entity)||0)),s}tileFlags(){return this.tiles.reduce(((t,e)=>t|(e?e.flags.tile:0)),0)}tileMechFlags(){return this.tiles.reduce(((t,e)=>t|(e?e.flags.tileMech:0)),0)}get needsRedraw(){return!!(this.flags.cell&f.NEEDS_REDRAW)}set needsRedraw(t){t?this.memory||(this.flags.cell|=f.NEEDS_REDRAW,this.flags.cell&=~f.STABLE_SNAPSHOT,this.map.needsRedraw=!0):this.flags.cell&=~f.NEEDS_REDRAW}get changed(){return!!(this.flags.cell&f.CHANGED)}depthPriority(t){const e=this.tiles[t];return e?e.priority:X.NULL.priority}highestPriority(){return this.tiles.reduce(((t,e)=>Math.max(t,e?e.priority:0)),X.NULL.priority)}depthTile(t){return this.tiles[t]||null}hasTile(t){return t?(t instanceof W||(t=Q(t)),this.tiles.includes(t)):this.tiles.some((t=>t))}hasDepthTile(t){const e=this.tiles[t];return!!e&&e!==X.NULL}highestPriorityTile(){return this.tiles.reduce(((t,e)=>e&&e.priority>=t.priority?e:t),X.NULL)}get tile(){return this.highestPriorityTile()}eachTile(t){this.tiles.forEach((e=>e&&t(e)))}tileWithObjectFlag(t){return this.tiles.find((e=>e&&e.flags.entity&t))||null}tileWithFlag(t){return this.tiles.find((e=>e&&e.flags.tile&t))||null}tileWithMechFlag(t){return this.tiles.find((e=>e&&e.flags.tileMech&t))||null}blocksVision(){return this.tiles.some((t=>t&&t.blocksVision()))}blocksPathing(){return this.tiles.some((t=>t&&t.blocksPathing()))&&!this.tiles.some((t=>t&&t.hasTileFlag(d.T_BRIDGE)))}blocksMove(){return this.tiles.some((t=>t&&t.blocksMove()))}blocksEffects(){return this.tiles.some((t=>t&&t.blocksEffects()))}blocksLayer(t){return this.tiles.some((e=>e&&!!(e.flags.tile&J.Tile.T_BLOCKS_OTHER_LAYERS)&&e.depth!=t))}isNull(){return this.tiles.every((t=>!t||t===X.NULL))}isPassable(){return!this.blocksMove()}isWall(){return this.hasAllEntityFlags(n.L_WALL_FLAGS)}isDoor(){return this.hasTileFlag(d.T_IS_DOOR)}isStairs(){return this.hasTileFlag(d.T_HAS_STAIRS)}isFloor(){return!this.hasEntityFlag(n.L_BLOCKS_EVERYTHING)&&!this.hasTileFlag(d.T_PATHING_BLOCKER)}isGateSite(){return this.hasCellFlag(f.IS_GATE_SITE)}isSecretlyPassable(){return this.hasEntityFlag(n.L_SECRETLY_PASSABLE)}hasLiquid(){return this.hasTileFlag(d.T_ANY_LIQUID)}setTile(t,e={}){if(!(t instanceof W||(t=Q(t))))return!1;const i=this.tiles[t.depth]||X.NULL;if(i===t)return e.volume&&(this.volume+=e.volume),!1;if(!e.superpriority&&i.priority>t.priority)return!1;if(this.blocksLayer(t.depth))return!1;if(e.blockedByItems&&this.hasItem())return!1;if(e.blockedByActors&&this.hasActor())return!1;if(e.blockedByOtherLayers&&this.highestPriority()>t.priority)return!1;if(t.depth>s.GROUND&&t.groundTile){const i=this.depthTile(s.GROUND),r=Q(t.groundTile);if(i!==r&&!this.setTile(r,e))return!1}return this.tiles[t.depth]=t,this.needsRedraw=!0,t.hasEntityFlag(n.L_BLOCKS_SURFACE)&&this.clearDepth(s.SURFACE),e.machine&&(this.machineId=e.machine),i.light!==t.light&&(this.map.light.glowLightChanged=!0),i.hasTileFlag(d.T_LIST_IN_SIDEBAR)!==t.hasTileFlag(d.T_LIST_IN_SIDEBAR)&&this.map.setMapFlag(E.MAP_SIDEBAR_TILES_CHANGED),t.hasTileFlag(d.T_IS_FIRE)&&this.setCellFlag(f.CAUGHT_FIRE_THIS_TURN),t.hasTileFlag(d.T_IS_FIRE)&&this.map.setMapFlag(E.MAP_HAS_FIRE),this.volume=e.volume||0,t.depth===s.GAS&&this.map.setMapFlag(E.MAP_HAS_GAS),t.depth===s.LIQUID&&this.map.setMapFlag(E.MAP_HAS_LIQUID),!0}clearTiles(t){this.tiles[0]=X.NULL;for(let t=1;t<this.tiles.length;++t)this.tiles[t]=null;t&&this.setTile(t),this.needsRedraw=!0}clear(t){this.tiles=[X.NULL],this.flags.cell=0,this.needsRedraw=!0,this.chokeCount=0,this.machineId=0,this.volume=0,t&&this.setTile(t),this.snapshot.blackOut()}clearDepth(t){return 0==t?(this.tiles[0]=X.NULL,this.needsRedraw=!0,!0):null!==this.tiles[t]&&(this.tiles[t]=null,this.needsRedraw=!0,t===s.GAS&&(this.volume=0),!0)}clearDepthsWithFlags(t,e=0){for(let i=0;i<this.tiles.length;++i){const s=this.tiles[i];s&&(s.hasTileFlag(t)&&(e&&!s.hasTileMechFlag(e)||this.clearDepth(i)))}}eachGlowLight(t){this.tiles.forEach((e=>{e&&e.light&&t(e.light)}))}tileWithAction(t){return this.tiles.find((e=>null==e?void 0:e.hasAction(t)))||null}trigger(t,e={}){e instanceof L||(e=new L(e)),e.x=this.x,e.y=this.y,e.map=this.map,this.tiles.forEach((i=>i&&i.trigger(t,e)))}hasAction(t){for(let e of this.tiles)if(e&&e.hasAction(t))return!0;return!1}hasItem(){return this.hasCellFlag(f.HAS_ITEM)}get item(){return this.map.itemAt(this.x,this.y)}canAddItem(t){return!0}canRemoveItem(t){return!0}_addItem(t){return this.setCellFlag(f.HAS_ITEM),this.needsRedraw=!0,!0}_removeItem(t){let e=!1,i=-1;return this.map.items.forEach(((s,r)=>{s===t?i=r:s.x===this.x&&s.y===this.y&&(e=!0)})),e||this.clearCellFlag(f.HAS_ITEM),!(i<0)&&(this.needsRedraw=!0,!0)}hasActor(){return this.hasCellFlag(f.HAS_ACTOR)}hasPlayer(){return this.hasCellFlag(f.HAS_PLAYER)}get actor(){return this.map.actorAt(this.x,this.y)}canAddActor(t){return!this.hasActor()}canRemoveActor(t){return!0}_addActor(t){return this.setCellFlag(f.HAS_ACTOR),t.isPlayer()&&this.setCellFlag(f.HAS_PLAYER),this.needsRedraw=!0,!0}_removeActor(t){let e=!1,i=-1;return this.map.actors.forEach(((s,r)=>{s===t?i=r:s.x===this.x&&s.y===this.y&&(e=!0)})),e||this.clearCellFlag(f.HAS_ACTOR|f.HAS_PLAYER),!(i<0)&&(this.needsRedraw=!0,!0)}hasFx(){return!!(this.flags.cell&f.HAS_FX)}get fx(){return this.map.fxAt(this.x,this.y)}_addFx(t){this.setCellFlag(f.HAS_FX),this.needsRedraw=!0}_removeFx(t){this.fx||this.clearCellFlag(f.HAS_FX),this.needsRedraw=!0}getDescription(){return this.highestPriorityTile().description}getFlavor(){return this.highestPriorityTile().flavor}getName(t={}){return this.highestPriorityTile().getName(t)}dump(){if(this.hasActor()){const t=this.map.actorAt(this.x,this.y);if(t&&t.sprite.ch)return t.sprite.ch}if(this.hasItem()){const t=this.map.itemAt(this.x,this.y);if(t&&t.sprite.ch)return t.sprite.ch}return this.hasTileFlag(d.T_BRIDGE)?"=":this.highestPriorityTile().sprite.ch||" "}drawSidebar(t,e){const i=new r.sprite.Mixer;return this.map.getAppearanceAt(this.x,this.y,i),t.drawSprite(e.x+1,e.y,i),t.wrapText(e.x+3,e.y,e.width-3,this.getName(),"cellStatusName"),1}toString(){return`Cell @ ${this.x},${this.y}`}}class it extends D{constructor(t){super(t),this.quantity=1,this.next=null,this.flags.item=0,this.depth=s.ITEM,this.kind=t}isPlural(){return this.quantity>1||super.isPlural()}copy(t){super.copy(t),this.quantity=t.quantity}itemFlags(){return this.flags.item}hasItemFlag(t){return!!(this.flags.item&t)}hasAllItemFlags(t){return(this.flags.item&t)===t}getBumpActions(){return this.kind.bump}}function st(t,e,i){const s=i[0]||"actor",r=this.get(e,s);return r&&r instanceof k?r.isPlayer()?"you":"the "+r.getName():r||t}function rt(t,e,i){const s=i[0]?this.get(e,i[0]):e.item||e.cell||e.target||e.actor;if(s){if(s instanceof et)return s.getFlavor();if(s instanceof k)return s.isPlayer()?"you":"the "+s.getName();if(s instanceof it)return"the "+s.getName()}return t}function at(t,e,i){const s=i[0]?this.get(e,i[0]):e.item||e.cell||e.target||e.actor;if(s){if(s instanceof et)return s.getFlavor();if(s instanceof k){if(s.isPlayer())return"you";if(s.hasEntityFlag(n.L_FORMAL_NAME))return s.getName()}if("getName"in s){const t=s.getName(),e=r.text.firstChar(t);return(/[aeiouy]/i.exec(e)?"an ":"a ")+t}}return t}function nt(t,e,i){const s=i[0]||"verb",a=i[1]?this.get(e,i[1]):e.actor||e.target||e.item||e.cell;let n=!1;return a&&(a instanceof et?n=!1:(a instanceof k||a instanceof it)&&(n=a.isPlural())),n?r.text.toPluralVerb(s):r.text.toSingularVerb(s)}it.default={sidebarFg:"gold"},r.text.addHelper("you",st),r.text.addHelper("the",rt),r.text.addHelper("a",at),r.text.addHelper("an",at),r.text.addHelper("verb",nt);var ht=Object.freeze({__proto__:null,KeyInfo:I,makeKeyInfo:function(t,e,i){return new I(t,e,i)},EntityKind:M,make:N,Entity:D,messageYou:st,messageThe:rt,messageA:at,messageVerb:nt});class ot{constructor(t=[]){this._msgs=[],t.forEach((t=>this.add(t)))}add(t){return this._msgs.push(t),this}get(t,e=!0){const i=r.clamp(Math.floor(t*this._msgs.length),0,this._msgs.length-1),s=this._msgs[i];return this._format(s,e)}_format(t,e=!0){return t.replace(/\[(\w+)\|?(\w*)\]/g,e?"$1":"$2")}}const lt={};const ct={};function dt(t,e){ct[t]=e}function ut(t){return"string"==typeof t&&(t={fn:t}),"function"==typeof t&&(t={fn:t}),"string"==typeof t.fn&&(t.fn=ct[t.fn]),t.fn||(t.fn=ct.default),t}function _t(t){const e=t.map,i=t.actor;if(!i)throw new Error("Actor required.");let s=i.goalMap;if(!s){const e=i.costMap(),a=r.random.matchingLoc(e.width,e.height,((t,i)=>e[t][i]>0&&e[t][i]!==r.path.NO_PATH));if(!a||a[0]<0||a[1]<0)return console.log("No wander location found!"),t.didNothing();s=i.setGoal(a[0],a[1])}const a=r.path.nextStep(s,i.x,i.y,((t,s)=>{if(!e.hasActor(t,s))return!1;const r=e.actorAt(t,s);return r?!i.canPass(r):(console.log(`Cell @ ${t},${s} has actor flag, but no actor.`),e.cell(t,s).clearCellFlag(f.HAS_ACTOR),!1)}));return a?!a||0==a[0]&&0==a[1]?t.didNothing():(t.dir=a,R("moveDir",t)):(i.clearGoal(),t.didNothing())}function gt(t){const e=t.actor;if(!e)throw new Error("Actor required.");if(e.isDead())return t.didNothing();const i=t.game.player;if(e.canSee(i)&&e.willAttack(i)){const s=100-e.stats.getPct("health"),a=e.stats.get("morale"),n=100;if(e.ai.lastSawPlayer=[i.x,i.y],e.clearGoal(),console.log("SAW YOU!",e.id,i.x,i.y),s>a)return void(At(t)&&Tt(t));if(yt(t)&&At(t)&&ft(t))return void(r.random.chance(n)?pt(t):Tt(t));if(St(t)&&At(t),At(t))return void Tt(t);if(yt(t)&&ft(t))return void pt(t);St(t),0}else if(e.ai.lastSawPlayer){if(!e.hasGoal()){const t=e.ai.lastSawPlayer;e.setGoal(t[0],t[1])}if(console.log("CHASING YOU!",e.id,e.goalMap.x,e.goalMap.y),It(t),t.isSuccess())return;e.ai.lastSawPlayer=null,e.clearGoal()}if(i.scent&&(t.dir=i.scent.nextDir(e.x,e.y),t.dir&&(console.log("tracking scent",e.id,t.dir),R("moveDir",t),t.isDone())))return;const s=r.object.firstOpt("wander",e.ai,e.kind.ai,!1);if(s)if(e.goalMap||"number"!=typeof s||r.random.chance(s)){if(_t(t),t.isSuccess())return}else if(R("idle",t),t.isSuccess())return;return R("standStill",t)}function ft(t){const e=t.map,i=t.actor;if(!i)throw new Error("Actor required.");const s=t.target;if(!s)throw new Error("No target.");let a=s.x,n=s.y;const h=r.grid.alloc(e.width,e.height),o=i.costMap();r.path.calculateDistances(h,a,n,o);let l=h[i.x][i.y],c=0;return r.xy.eachNeighbor(i.x,i.y,((t,e)=>{h[t][e]<l&&++c}),!1),r.grid.free(h),c>0}function pt(t){const e=t.map,i=t.actor;if(!i)throw new Error("Actor required.");const s=t.target;if(!s)throw new Error("No target.");let a=s.x,n=s.y;const h=r.grid.alloc(e.width,e.height),o=i.costMap();r.path.calculateDistances(h,a,n,o);const l=r.path.nextStep(h,i.x,i.y,((i,s)=>{const r=e.cell(i,s);return!r||(!(!r.hasActor()||r.actor===t.target)||!!r.blocksMove())}));return r.grid.free(h),!l||0==l[0]&&0==l[1]?R("standStill",t):(t.dir=l,R("moveDir",t))}function Et(t){return!1}function mt(t){const e=t.actor;if(!e)throw new Error("Need actor.");return e.endTurn(),t.didSomething()}function At(t){const e=t.actor,i=t.target;return!(!e||!i)&&r.xy.distanceFromTo(e,i)<=1}function Tt(t){const e=t.actor,i=t.target;if(!e||!i)throw new Error("Actor and Target required to attack.");return console.log("attack!",e.id,i.id),R("attack",t)}function yt(t){const e=t.actor,i=t.target;return!e||!i||r.xy.distanceFromTo(e,i)>1}function St(t){const e=t.actor,i=t.target;return!e||!i||r.xy.distanceFromTo(e,i)<1}function It(t){const e=t.actor;if(!e)throw new Error("Need actor.");if(!e.hasGoal())return t.didNothing();const i=r.path.nextStep(e.goalMap,e.x,e.y,((t,i)=>e.map.hasActor(t,i)));return i?(t.dir=i,R("moveDir",t)):(e.clearGoal(),t.didNothing())}dt("typical",gt),dt("default",gt);var Lt=Object.freeze({__proto__:null,fillSafetyMap:function(t,e,i){const s=r.grid.alloc(e.costMap());r.path.calculateDistances(t,i.x,i.y,s,!0),t.update((t=>-1*t)),e.map.actors.forEach((t=>{t.willAttack(e)&&(s[t.x][t.y]=r.path.FORBIDDEN)})),e.map.eachCell(((e,i,s)=>{e.hasCellFlag(f.IS_IN_LOOP)&&(t[i][s]-=r.path.AVOIDED)})),r.path.rescan(t,s,!0),t.update((t=>t<=-3e4?3e4:t)),r.grid.free(s)},ais:ct,install:dt,make:ut,typical:gt,canMoveToward:ft,moveToward:pt,canMoveAwayFrom:Et,moveAwayFrom:mt,canRunAwayFrom:function(t){return!1},runAwayFrom:function(t){if(!t.actor)throw new Error("Need actor.");return t.actor.endTurn(),t.didSomething()},canAttack:At,attack:Tt,tooFarFrom:yt,tooCloseTo:St,moveTowardGoal:It,wander:_t});class Ot extends M{constructor(t){super(t),this.flags={actor:o.DEFAULT,entity:n.DEFAULT_ACTOR},this.vision={},this.bump=["attack"],this.moveSpeed=100,t.flags&&(this.flags.actor=r.flag.from(o,this.flags.actor,t.flags),this.flags.entity=r.flag.from(n,this.flags.entity,t.flags)),t.vision&&(this.vision.normal=t.vision),this.stats=Object.assign({health:1,morale:100},t.stats),t.moveSpeed&&(this.moveSpeed=t.moveSpeed),this.ai=ut(t.ai||"default"),t.bump&&("string"==typeof t.bump&&(t.bump=t.bump.split(/[|,]/g).map((t=>t.trim()))),"function"==typeof t.bump&&(t.bump=[t.bump]),Array.isArray(t.bump)&&(this.bump=t.bump.slice())),t.waterOnly?(this.forbidTileFlags=this.forbidTileFlags&~d.T_IS_DEEP_LIQUID,this.avoidTileFlags=this.avoidTileFlags&~d.T_IS_DEEP_LIQUID,this.requireTileFlags|=d.T_IS_DEEP_LIQUID):t.lavaOnly?(this.forbidTileFlags=this.forbidTileFlags&~d.T_LAVA,this.avoidTileFlags=this.avoidTileFlags&~d.T_LAVA,this.requireTileFlags|=d.T_LAVA):(t.swim?this.avoidTileFlags|=d.T_IS_DEEP_LIQUID:this.forbidTileFlags|=d.T_IS_DEEP_LIQUID,t.fly&&(this.forbidTileFlags=this.forbidTileFlags&~d.T_LAVA,this.avoidTileFlags=this.avoidTileFlags&~d.T_LAVA,this.requireTileFlags=this.requireTileFlags&~d.T_LAVA,this.forbidTileFlags=this.forbidTileFlags&~d.T_IS_DEEP_LIQUID,this.avoidTileFlags=this.avoidTileFlags&~d.T_IS_DEEP_LIQUID,this.requireTileFlags=this.requireTileFlags&~d.T_IS_DEEP_LIQUID)),this.sidebarFg=r.color.from(t.sidebarFg||k.default.sidebarFg)}make(t){const e=new k(this);return this.init(e,t),e}init(t,e={}){super.init(t,e),Object.assign(t.flags,this.flags),this.vision.normal&&(t.visionDistance=this.vision.normal),t.stats.init(this.stats)}addToMap(t,e){super.addToMap(t,e)}removeFromMap(t){super.removeFromMap(t)}hasActorFlag(t){return!!(this.flags.actor&t)}canSeeEntity(t,e){return!0}isAbleToSee(t,e){return!0}isAbleToSense(t,e){return!0}forbidsCell(t,e){return!!super.forbidsCell(t,e)||!!t.blocksMove()}avoidsCell(t,e){return!!super.avoidsCell(t,e)||!!t.blocksPathing()}getFlavor(t,e){const i=t.isPlayer()?"yourself":this.flavor;return e&&e.action?i+" standing":i}pickupItem(t,e,i){return!!r.list.push(t,"items",e)}dropItem(t,e,i){return!!r.list.remove(t,"items",e)}cellCost(t,e){return this.forbidsCell(t,e)?t.hasEntityFlag(n.L_BLOCKS_DIAGONAL)?r.path.OBSTRUCTION:r.path.FORBIDDEN:this.avoidsCell(t,e)?r.path.AVOIDED:r.path.OK}drawSidebar(t,e,i){let s=super.drawSidebar(t,e,i);return t.map.hasTileFlag(t.x,t.y,d.T_DEEP_WATER)&&!t.map.hasTileFlag(t.x,t.y,d.T_BRIDGE)&&e.drawText(i.x+3,i.y+s++,"Swimming","#66F"),s}}function bt(t,e){let i;if("string"==typeof t){if(i=Rt(t),!i)throw new Error("Failed to find item kind - "+t)}else i=t instanceof Ot?t:Ct(t);return i.make(e)}const wt={};function Rt(t){return t instanceof Ot?t:wt[t]}function Ct(t){const e=Object.assign({},t);return new Ot(e)}function vt(t={}){const e={tags:[],forbidTags:[]};"string"==typeof t&&(t={tags:t}),"string"==typeof t.tags?t.tags.split(/[,|&]/).map((t=>t.trim())).forEach((t=>{t.startsWith("!")?e.forbidTags.push(t.substring(1).trim()):e.tags.push(t)})):Array.isArray(t.tags)&&(e.tags=t.tags.slice()),"string"==typeof t.forbidTags?e.forbidTags=t.forbidTags.split(/[,|&]/).map((t=>t.trim())):Array.isArray(t.forbidTags)&&(e.forbidTags=t.forbidTags.slice());const i=Object.values(wt).filter((t=>!(e.tags.length&&!r.arraysIntersect(e.tags,t.tags))&&(!e.forbidTags||!r.arraysIntersect(e.forbidTags,t.tags))));return(t.rng||r.rng.random).item(i)||null}var Ft=Object.freeze({__proto__:null,PainMessages:ot,painMessages:lt,installPain:function(t,e){Array.isArray(e)&&(e=new ot(e)),lt[t]=e},getPain:function(t){const e=lt[t];if(!e)throw new Error("No such pain message index: "+t);return e},Stats:P,Status:x,ActorKind:Ot,Actor:k,make:bt,makeRandom:function(t,e){const i=vt(t);if(!i)throw new Error("Failed to find item kind matching - "+JSON.stringify(t));return i.make(e)},kinds:wt,install:function(t,e){if(e instanceof Ot)return wt[t]=e,e;const i=Ct(e);return i.id=t,wt[t]=i,i},get:Rt,makeKind:Ct,randomKind:vt});class Dt extends M{constructor(t){super(t),this.flags={item:l.DEFAULT,entity:n.DEFAULT_ACTOR},this.bump=[],t.flags&&(this.flags.item=r.flag.from(l,this.flags.item,t.flags),this.flags.entity=r.flag.from(n,this.flags.entity,t.flags)),t.bump&&("string"!=typeof t.bump&&"function"!=typeof t.bump||(t.bump=[t.bump]),Array.isArray(t.bump)&&(this.bump=t.bump.slice())),this.avoidTileFlags|=d.T_DEEP_WATER,this.forbidTileFlags|=d.T_LAVA|d.T_AUTO_DESCENT,this.sidebarFg=r.color.from(t.sidebarFg||it.default.sidebarFg)}make(t){const e=new it(this);return this.init(e,t),e}init(t,e={}){super.init(t,e),Object.assign(t.flags,this.flags),t.quantity=e.quantity||1}avoidsCell(t,e){return!(!t.isDoor()&&!t.isStairs())||super.avoidsCell(t,e)}}const Mt={};function Nt(t){return t instanceof Dt?t:Mt[t]}function xt(t){const e=Object.assign({},t);return new Dt(e)}function Pt(t={}){const e={tags:[],forbidTags:[]};"string"==typeof t&&(t={tags:t}),"string"==typeof t.tags?t.tags.split(/[,|&]/).map((t=>t.trim())).forEach((t=>{t.startsWith("!")?e.forbidTags.push(t.substring(1).trim()):e.tags.push(t)})):Array.isArray(t.tags)&&(e.tags=t.tags.slice()),"string"==typeof t.forbidTags?e.forbidTags=t.forbidTags.split(/[,|&]/).map((t=>t.trim())):Array.isArray(t.forbidTags)&&(e.forbidTags=t.forbidTags.slice());const i=Object.values(Mt).filter((t=>!(e.tags.length&&!r.arraysIntersect(e.tags,t.tags))&&(!e.forbidTags||!r.arraysIntersect(e.forbidTags,t.tags))));return(t.rng||r.rng.random).item(i)||null}var kt=Object.freeze({__proto__:null,ItemKind:Dt,Item:it,make:function(t,e){let i;if("string"==typeof t){if(i=Nt(t),!i)throw new Error("Failed to find item kind - "+t)}else i=t instanceof Dt?t:xt(t);return i.make(e)},makeRandom:function(t,e){const i=Pt(t);if(!i)throw new Error("Failed to find item kind matching - "+JSON.stringify(t));return i.make(e)},kinds:Mt,install:function(t,e){if(e instanceof Dt)return Mt[t]=e,e.id=t,e;const i=xt(e);return i.id=t,Mt[t]=i,i},get:Nt,makeKind:xt,randomKind:Pt});function Bt(t){t.actor&&(t.actor.endTurn(),t.didSomething())}function Ht(t,e,i,s,a=100,n=1){"string"==typeof s&&(s=r.sprite.from(s));const h=N({name:"FX",sprite:s});t.addFx(e,i,h);return r.tween.make({visible:!0}).to({visible:!1}).repeat(n).repeatDelay(a).duration(a).onUpdate((s=>{s.visible?t.addFx(e,i,h):t.removeFx(h)}))}function Ut(t,e,i,s){return i=i||"hit",s=s||200,Ht(t,e.x,e.y,i,s,1)}function Gt(t,e,i,s,a=100){const n=N({name:"FX",sprite:s="string"==typeof s?r.sprite.from(s).clone():r.sprite.make(s)});t.addFx(e,i,n);return r.tween.make({opacity:0}).to({opacity:100}).repeat(2).yoyo(!0).duration(Math.floor(a/2)).onUpdate((s=>{n.sprite.opacity=s.opacity,t.cell(e,i).needsRedraw=!0})).onFinish((()=>{t.removeFx(n)}))}function Yt(t,e,i,s,a={}){"string"==typeof s&&(s=r.sprite.from(s));const h=N({name:"FX",sprite:s}),o={x:r.xy.x(e),y:r.xy.y(e)};t.addFx(o.x,o.y,h);let l=a.duration||Math.ceil(r.xy.maxAxisFromTo(e,i)/(a.speed||8)*16);r.xy.isLoc(i)&&(i={x:i[0],y:i[1]});const c=r.tween.make(o).to(i).duration(l).onUpdate((e=>{const i={x:h.x,y:h.y},s=r.xy.forLineBetween(i.x,i.y,e.x,e.y,((e,s)=>{if(a.stepFn){if(a.stepFn(e,s))return a.stopBeforeWalls||(i.x=e,i.y=s),!1}else if(t.hasEntityFlag(e,s,n.L_BLOCKS_MOVE))return a.stopBeforeWalls||(i.x=e,i.y=s),!1;i.x=e,i.y=s}));t.moveFx(h,i.x,i.y),s||c.stop()})).onFinish((()=>(t.removeFx(h),h)));return c}function Vt(t,e,i,s,r,a){const n=Math.abs(r-e),h=Math.abs(a-i);if(0==n&&0==h&&!s)return!1;switch(t){case"+":return 0==n||0==h;case"x":case"X":return n==h;case"*":return 0==n||0==h||n==h;default:return!0}}w("standStill",Bt),r.sprite.install("bump","white",50),r.sprite.install("hit","red",50),r.sprite.install("miss","green",50);var Kt=Object.freeze({__proto__:null,flashSprite:Ht,hit:Ut,miss:function(t,e,i,s){return i=i||"miss",s=s||200,Ht(t,e.x,e.y,i,s,1)},fadeInOut:Gt,moveSprite:Yt,bolt:function(t,e,i,s,r={}){return Yt(t,e,i,s,r)},projectile:function(t,e,i,s,a={}){if("string"==typeof s&&(s=r.sprite.from(s)),s.ch&&4==s.ch.length){const t=r.xy.dirFromTo(e,i);let a=0;t[0]&&t[1]?(a=2,t[0]!=t[1]&&(a=3)):t[0]&&(a=1);const n=s.ch[a];s=r.sprite.make(n,s.fg,s.bg)}else if(s.ch&&1!==s.ch.length)throw new Error('projectile requires 4 chars - vert,horiz,diag-left,diag-right (e.g: "|-\\/")');return Yt(t,e,i,s,a)},beam:function(t,e,i,s,a={}){a.fade=a.fade||100,void 0===a.stopAtWalls&&(a.stopAtWalls=!0);const h=[];r.xy.forLineFromTo(e,i,((e,i)=>!!t.hasXY(e,i)&&((!a.stepFn||!a.stepFn(e,i))&&((a.stopAtWalls||a.stopBeforeWalls)&&t.hasEntityFlag(e,i,n.L_BLOCKS_MOVE)?(a.stopBeforeWalls||h.push([e,i]),!1):(h.push([e,i]),!0)))));const o=a.duration||Math.ceil(h.length/(a.speed||8)*16);let l=-1;const c=r.tween.make({index:0}).to({index:h.length-1}).duration(o).onUpdate((e=>{for(;l<e.index;){++l;const e=h[l]||[-1,-1];c.addChild(Gt(t,e[0],e[1],s,a.fade))}}));return c},explosion:function(t,e,i,s,a,h={}){!function(t){t.speed=t.speed||2,t.fade=t.fade||100,t.shape=t.shape||"o",void 0===t.center&&(t.center=!0)}(h),"string"==typeof a&&(a=r.sprite.from(a));const o=r.grid.alloc(t.width,t.height);new r.fov.FOV({isBlocked:(e,i)=>t.hasEntityFlag(e,i,n.L_BLOCKS_MOVE),hasXY:(e,i)=>t.hasXY(e,i)}).calculate(e,i,s,((t,e)=>{o[t][e]=1}));const l=h.duration||s/h.speed*32,c=r.tween.make({r:0}).to({r:s}).duration(l).onUpdate((s=>{const n=Math.max(0,e-s.r),l=Math.max(0,i-s.r),d=Math.min(t.width-1,e+s.r),u=Math.min(t.height-1,i+s.r);for(let _=n;_<=d;++_)for(let n=l;n<=u;++n)o[_][n]&&r.xy.distanceBetween(e,i,_,n)<=s.r&&(o[_][n]=0,Vt(h.shape,e,i,h.center,_,n)&&c.addChild(Gt(t,_,n,a,h.fade)))})).onFinish((()=>{r.grid.free(o)}));return c}});function Wt(t){const e=t.target,i=t.actor;if(!i)throw new Error("Actor is required for bump.");if(e){const s=e.getBumpActions();for(let r of s)if("string"==typeof r){if(r.startsWith("@")){if(!i.isPlayer())continue;r=r.substring(1)}else if(r.startsWith("=")){if(i.kind!==e.kind)continue;r=r.substring(1)}if(r.startsWith("$")){const i=r.substring(1);if(!e.canDoAction(i))throw new Error("Invalid bump choice - "+r);if(e.trigger(i,t),t.isDone())return}else if(R(r,t),t.isDone())return}else if(r(t),t.isDone())return}t.item}function jt(t){const e=t.dir;if(!e)throw new Error("moveDir called with no direction!");const i=t.actor,s=t.map;if(!i)throw new Error("moveDir requires actor!");const a=i.x+e[0],n=i.y+e[1],h=s.cell(i.x,i.y),o=s.cell(a,n);if(i.forbidsCell(o))return t.try?t.didNothing():(i.isPlayer()&&(Ut(s,o,"hit",100),r.message.addAt(o.x,o.y,"{{you}} {{verb bump~}} into {{a cell}}.",{actor:i,cell:o})),i.clearGoal(),i.endTurn(),t.didSomething());if(o.blocksMove())return t.try?t.didNothing():(Ut(s,o,"hit",100),i.clearGoal(),i.endTurn(),t.didSomething());if(!h.canRemoveActor(i))return t.try?t.didNothing():(i.endTurn(),t.didSomething());if(o.hasActor()||o.hasItem())return t.try?t.didNothing():(t.target=o.actor,t.item=o.item,Wt(t));if(!o.canAddActor(i))return t.try?t.didNothing():(i.endTurn(),t.didSomething());if(!s.moveActor(i,a,n))return Bt(t);let l=100;return o.hasTileFlag(d.T_DEEP_WATER)&&(l=150),i.endTurn(l),t.didSomething()}function Xt(t){const e=t.actor;if(!e)throw new Error("Action requires an actor.");if(r.random.chance(50))return e.endTurn(),t.didSomething();const i=r.random.number(4);return t.dir=r.xy.DIRS[i],jt(t)}function qt(t){const e=t.map;if(!e)throw new Error("Map is required!");const i=t.actor;if(!i)throw new Error("Actor is required.");const s=e.itemAt(t.x,t.y);return s?i.avoidsItem(s)?t.didNothing():!1===s.canDoAction("pickup")?(t.quiet||r.message.addAt(i.x,i.y,"{{you}} cannot pickup {{the item}}.",{actor:i,item:s}),t.didNothing()):i.canAddItem(s)&&e.removeItem(s)?(i.addItem(s),t.quiet||r.message.addAt(i.x,i.y,"{{you}} {{verb pick[s]}} up {{an item}}.",{actor:i,item:s}),i.endTurn(),void t.didSomething()):t.didNothing():(t.quiet||r.message.addAt(t.x,t.y,"Nothing to pickup."),t.didNothing())}function Qt(t){const e=t.map,i=t.actor;if(!i)throw new Error("Actor is required.");const s=t.x,a=t.y;return e.hasTileFlag(s,a,d.T_UP_STAIRS)?(r.message.addAt(s,a,"{{you}} {{verb climb[s]}}.",{actor:i}),t.game.startNewMap({up:!0}),i.endTurn(),t.didSomething()):(r.message.addAt(s,a,"Nothing to climb."),i.endTurn(50),t.didSomething())}w("bump",Wt),w("moveDir",jt),w("idle",Xt),w("pickup",qt),w("climb",Qt);var zt=Object.freeze({__proto__:null,standStill:Bt,moveDir:jt,idle:Xt,pickup:qt,climb:Qt,bump:Wt});function $t(t){return"function"==typeof t?t:e=>{for(let i of t)if(i(e),e.isDone())return}}function Jt(){return Zt.bind(void 0)}function Zt(t){const e=t.map,i=e.cell(t.x,t.y).machineId;if(!i)return t.didNothing();t.originX=t.x,t.originY=t.y;for(let s=0;s<e.width;++s)for(let r=0;r<e.height;++r){const a=e.cell(s,r);a.machineId===i&&a.trigger("machine",t)}}function te(t){if(Array.isArray(t)&&(t=t[0]),"object"==typeof t&&(t=t.chance),"string"==typeof t&&(t=t.endsWith("%")?100*Number.parseFloat(t):Number.parseInt(t||"10000")),"number"!=typeof t)throw new Error("Chance effect config must be number or string that can be a number.");return ee.bind(void 0,t)}function ee(t,e){if(!e.map.rng.chance(t,1e4))return e.stop()}function ie(t){let e=0;if(t)if("number"==typeof t)e=t;else{if("string"!=typeof t)throw new Error("Invalid config for clear effect: "+JSON.stringify(t));e=t.split(/[,|]/g).reduce(((t,e)=>{if("number"==typeof e)return t|e;return t|(s[e]||0)}),0)}else e=s.ALL_LAYERS;return se.bind(void 0,e)}function se(t,e){if(!t)return e.didNothing();e.map.cell(e.x,e.y).clearDepth(t)?e.didSomething():e.didNothing()}function re(t){if(Array.isArray(t)&&(t=t[0]),"string"!=typeof t)throw new Error("Invalid EMIT handler config - "+t);return ae.bind(void 0,t)}function ae(t,e){e.actor&&e.actor.trigger(t,e),e.isDone()||(e.item&&e.item.trigger(t,e),e.isDone()||(e.map.trigger(t,e),e.isDone()||e.game.trigger(t,e)))}function ne(t){if(Array.isArray(t)&&(t=t[0]),t&&"string"!=typeof t&&(t=t.id),!t||!t.length)throw new Error("Feature effect needs ID");return he.bind(void 0,t)}function he(t,e){const i=Y[t];if(!i)throw new Error("Failed to find feature: "+t);return i(e)}function oe(t){if(Array.isArray(t)&&(t=t[0]),"string"!=typeof t)throw new Error("Need message for message effect.");const e={msg:t};return le.bind(void 0,e)}function le(t,e){const i=e.seen,s=t.msg;return s&&s.length&&e.aware&&!i?(r.message.addAt(e.x,e.y,s,e),e.didSomething()):e.didNothing()}function ce(t){if(!t)throw new Error("Invalid Nourish config.");let e={};if("string"==typeof t&&(t=t.split(":").map((t=>t.trim()))),Array.isArray(t))e.type=t[0]||"inc",e.amount=r.range.make(t[1]||1);else{if(!t.type&&!t.amount)throw new Error("Invalid Nourish config: "+JSON.stringify(t));e.type=t.type||"inc",e.amount=r.range.make(t.amount||1)}return de.bind(void 0,e)}function de(t,e){if(!t.amount)return e.didNothing();const i=e.map.actorAt(e.x,e.y);if(!i)return e.didNothing();const s=i.stats,a=s.get("food");if(!s.adjust("food",t.type,t.amount))return e.didNothing();const n=s.get("food");return n<a&&n/s.max("food")<.1&&r.message.addAt(i.x,i.y,de.default.pukeMsg,{actor:i}),e.didSomething()}function ue(...t){let e={};if(!t.length)throw new Error("Must have config to create spread.");if(1===t.length&&("string"==typeof t[0]?t=t[0].split(":").map((t=>t.trim())):Array.isArray(t[0])?t=t[0]:(Object.assign(e,t[0]),t=[e])),t.length>=3)Object.assign(e,t[3]||{}),e.grow=Number.parseInt(t[0]),e.decrement=Number.parseInt(t[1]),e.actions=t[2];else if(2===t.length)throw new Error("Must have actions to run for spread.");"number"!=typeof e.grow&&(e.grow=Number.parseInt(e.grow||0)),"number"!=typeof e.decrement&&(e.decrement=Number.parseInt(e.decrement||100)),e.flags=r.flag.from(A,e.flags||0),e.matchTile=e.matchTile||"";const i=G(e.actions);if(!i)throw new Error("Failed to make action for spread.");e.actions=i;const s=_e.bind(e);return s.config=e,s}function _e(t){const e=!!(this.flags&A.E_ABORT_IF_BLOCKS_MAP),i=t.map,s=r.grid.alloc(i.width,i.height);if(!pe(this,t,s))return r.grid.free(s),t.didNothing();if(e&&ge(i,s))return r.grid.free(s),t.didNothing();this.flags&A.E_EVACUATE_CREATURES&&me(i,s)&&t.didSomething(),this.flags&A.E_EVACUATE_ITEMS&&Ae(i,s)&&t.didSomething(),this.flags&A.E_CLEAR_CELL&&Ee(i,s,this.flags)&&t.didSomething(),s.update((t=>t?1:0));let a=t.isSuccess();this.actions.forEach(((e,i)=>{s.forEach(((r,n,h)=>{r===i+1&&(t.reset(),t.x=n,t.y=h,e(t),t.isSuccess()&&(a=!0,s[n][h]+=1))}))})),a&&t.didSomething(),r.grid.free(s)}function ge(t,e,i=0,s=0){const a=r.grid.alloc(t.width,t.height);let n=!1;r.xy.forRect(t.width,t.height,((r,h)=>{const o=r+i,l=h+s;e.get(o,l)?t.cell(r,h).isStairs()&&(n=!0):t.cell(r,h).blocksMove()||(a[r][h]=1)}));let h=!0;for(let t=0;t<a.width&&!n;++t)for(let e=0;e<a.height&&!n;++e)1==a[t][e]&&(h?(a.floodFill(t,e,1,2),h=!1):n=!0);return r.grid.free(a),n}function fe(t,e,i,s,a){if(!e.hasXY(i,s))return!1;const n=e.cell(i,s);if(n.hasCellFlag(f.EVENT_PROTECTED))return!1;if(n.blocksEffects()&&!t.matchTile&&!a)return!1;if(t.flags&A.E_BUILD_IN_WALLS){if(!e.cell(i,s).isWall())return!1}else if(t.flags&A.E_MUST_TOUCH_WALLS){let t=!1;if(r.xy.eachNeighbor(i,s,((i,s)=>{e.cell(i,s).isWall()&&(t=!0)}),!0),!t)return!1}else if(t.flags&A.E_NO_TOUCH_WALLS){let t=!0;if(e.cell(i,s).isWall())return!1;if(r.xy.eachNeighbor(i,s,((i,s)=>{e.cell(i,s).isWall()&&(t=!1)}),!0),!t)return!1}return!(t.matchTile&&!a&&!n.hasTile(t.matchTile))}function pe(t,e,i){let s,a,n,h,o,l,c;const d=e.map;let u=t.grow||0,_=t.decrement||0;if(i.fill(0),!fe(t,d,e.x,e.y,!0))return!1;i[e.x][e.y]=h=1;let g=1;if(u)for(c=!0,u>=100&&(_=_||100),_<=0&&(_=u);c&&u>0;){for(c=!1,h++,s=0;s<d.width;s++)for(a=0;a<d.height;a++)if(i[s][a]==h-1)for(n=0;n<4;n++)o=s+r.xy.DIRS[n][0],l=a+r.xy.DIRS[n][1],i.hasXY(o,l)&&!i[o][l]&&d.rng.chance(u)&&fe(t,d,o,l,!1)&&(i[o][l]=h,c=!0,++g);u-=_}return g>0}function Ee(t,e,i=0){let r=!1;const a=(i&A.E_CLEAR_CELL)===A.E_CLEAR_CELL;return e.forEach(((e,n,h)=>{if(!e)return;const o=t.cell(n,h);a?o.clear():(i&A.E_CLEAR_GAS&&o.clearDepth(s.GAS),i&A.E_CLEAR_LIQUID&&o.clearDepth(s.LIQUID),i&A.E_CLEAR_SURFACE&&o.clearDepth(s.SURFACE),i&A.E_CLEAR_GROUND&&o.clearDepth(s.GROUND)),r=!0})),r}function me(t,e){let i=!1;return t.eachActor((s=>{if(!e[s.x][s.y])return;const r=t.rng.matchingLocNear(s.x,s.y,((i,r)=>{if(!t.hasXY(i,r))return!1;if(e[i][r])return!1;const a=t.cell(i,r);return!s.forbidsCell(a)}));r&&r[0]>=0&&r[1]>=0&&(t.removeActor(s),t.addActor(r[0],r[1],s),i=!0)})),i}function Ae(t,e){let i=!1;return t.eachItem((s=>{if(!e[s.x][s.y])return;const r=t.rng.matchingLocNear(s.x,s.y,((i,r)=>{if(!t.hasXY(i,r))return!1;if(e[i][r])return!1;const a=t.cell(i,r);return!s.forbidsCell(a)}));r&&r[0]>=0&&r[1]>=0&&(t.removeItem(s),t.addItem(r[0],r[1],s),i=!0)})),i}function Te(t){if(!t)throw new Error("Invalid Stat config.");const e={};if("string"==typeof t&&(t=t.split(":").map((t=>t.trim()))),Array.isArray(t))e.stat=t[0],e.type=t[1]||"inc",e.amount=r.range.make(t[2]||1);else{if(!t.type&&!t.amount)throw new Error("Invalid stat effect configuration: "+JSON.stringify(t));e.stat=t.stat,e.type=t.type||"inc",e.amount=r.range.make(e.amount||1)}return ye.bind(void 0,e)}function ye(t,e){if(!t.amount)return e.didNothing();const i=e.actor||e.map.actorAt(e.x,e.y);if(!i)return e.didNothing();return i.stats.adjust(t.stat,t.type,t.amount)?e.didSomething():e.didNothing()}function Se(t){if(!t)throw new Error("Tile effect needs configuration.");if("string"==typeof t)t={id:t};else if(Array.isArray(t))t={id:t[0]};else if(!t.id)throw new Error("Tile effect needs configuration with id.");const e=t;return e.id.includes("!")&&(e.superpriority=!0),e.id.includes("~")&&(e.blockedByActors=!0,e.blockedByItems=!0),e.id.includes("+")&&(e.protected=!0),e.id=e.id.replace(/[!~+]*/g,""),Ie.bind(void 0,e)}function Ie(t,e){const i=e.map;t.machine=e.machine||0,i.setTile(e.x,e.y,t.id,t)&&(t.protected&&i.setCellFlag(e.x,e.y,f.EVENT_PROTECTED),e.didSomething())}H("fn",$t),H("activateMachine",Jt),H("chance",te),H("clear",ie),H("emit",re),H("feature",ne),H("effect",ne),H("id",ne),H("msg",oe),de.default={pukeMsg:"%you vomit."},H("nourish",ce),H("spread",ue),H("stat",Te),H("tile",Se);var Le=Object.freeze({__proto__:null,fn:$t,activateMachine:Jt,activateMachineAction:Zt,chance:te,chanceAction:ee,clear:ie,clearAction:se,emit:re,emitAction:ae,feature:ne,featureAction:he,msg:oe,messageAction:le,nourish:ce,nourishAction:de,spread:ue,spreadAction:_e,mapDisruptedBy:ge,computeSpawnMap:pe,clearCells:Ee,evacuateCreatures:me,evacuateItems:Ae,stat:Te,statAction:ye,tile:Se,tileAction:Ie});class Oe{constructor(t,e="layer"){this.changed=!1,this.map=t,this.depth=-1,this.properties={},this.name=e}copy(t){}clear(){}setTile(t,e,i,s){return!1}clearTile(t,e){return!1}addActor(t,e,i){return!1}forceActor(t,e,i){return!1}removeActor(t){return!1}addItem(t,e,i){return!1}forceItem(t,e,i){return!1}removeItem(t){return!1}tick(t){return!1}}function be(t,e,i,r){let a=0,h=0,o=0;const l=t.cell(e,i);let c=l.depthTile(s.GAS),d=c;if(l.hasEntityFlag(n.L_BLOCKS_GAS))return r[e][i]=0,void(l.volume=0);for(let c=Math.max(0,e-1);c<Math.min(e+2,r.width);++c)for(let e=Math.max(0,i-1);e<Math.min(i+2,r.height);++e){const i=r[c][e];l.hasEntityFlag(n.L_BLOCKS_GAS)||(++h,i>o&&(o=i,d=t.cell(c,e).depthTile(s.GAS))),a+=i}const u=Math.floor(10*a/h)/10;u>0&&d&&(c&&c===d?l.volume=u:l.setTile(d,{volume:u})),u>0&&(l.needsRedraw=!0)}const we=n,Re=d,Ce=_,ve=f;function Fe(t,e,i,s=!1){let a=0,n=0,h=0,o=!1;const l=t.cell(e,i);if(!l.hasTileFlag(Re.T_IS_FLAMMABLE))return!1;if(l.eachTile((t=>{t.hasTileFlag(Re.T_EXTINGUISHES_FIRE)&&t.priority>n&&(n=t.priority),t.flags.tile&Re.T_IS_FLAMMABLE&&t.priority>a&&(a=t.priority)})),n>=a&&!s)return!1;l.hasTileMechFlag(Ce.TM_EXPLOSIVE_PROMOTE)&&(r.xy.eachNeighbor(e,i,((e,i)=>{const s=t.cell(e,i);(s.hasEntityFlag(we.L_BLOCKS_GAS)||s.hasTileFlag(Re.T_IS_FIRE)||s.hasTileMechFlag(Ce.TM_EXPLOSIVE_PROMOTE))&&++h})),h>=8&&(o=!0));let c="fire";return o&&l.hasAction("explode")&&(c="explode"),l.trigger(c,{force:!0}),!0}var De=Object.freeze({__proto__:null,MapLayer:Oe,TileLayer:class extends Oe{constructor(t,e="tile"){super(t,e)}setTile(t,e,i,s){return this.map.cell(t,e).setTile(i,s)}clearTile(t,e){return this.map.cell(t,e).clearDepth(this.depth)}tick(t){return!0}},gas:function t(e){const i=[];e.data.gas=!0,i.push(e.on("tick",(()=>{!function(t){if(!t.hasMapFlag(E.MAP_HAS_GAS))return;const e=r.grid.alloc(t.width,t.height);(function(t,e){t.cells.forEach(((t,i,r)=>{if(t.volume){let a=t.volume;const n=t.depthTile(s.GAS);if(n&&n.dissipate){let t=Math.max(.5,a*n.dissipate/1e4);a=Math.max(0,a-t)}a?t.volume=a:t.clearDepth(s.GAS),e[i][r]=a}else e[i][r]=0}))})(t,e),function(t,e){for(let i=0;i<e.width;++i)for(let s=0;s<e.height;++s)be(t,i,s,e)}(t,e),r.grid.free(e)}(e)}))),i.push(e.on("copy",(t=>{t.data.gas||i.forEach((t=>t()))}))),i.push(e.on("assign",(e=>{e.data.gas||t(e)})))},fire:function t(e){e.data.fire=!0;const i=[];i.push(e.on("tick",(()=>{!function(t){if(!t.hasMapFlag(E.MAP_HAS_FIRE))return;t.clearMapFlag(E.MAP_HAS_FIRE);for(let e=0;e<t.width;++e)for(let i=0;i<t.height;++i){t.cell(e,i).clearCellFlag(ve.CAUGHT_FIRE_THIS_TURN)}for(let e=0;e<t.width;++e)for(let i=0;i<t.height;++i){const s=t.cell(e,i);if(s.hasTileFlag(Re.T_IS_FIRE)&&!(s.flags.cell&ve.CAUGHT_FIRE_THIS_TURN)){Fe(t,e,i,!1);for(let s=0;s<4;++s){const a=r.xy.DIRS[s];Fe(t,e+a[0],i+a[1])}}}t.someCell((t=>t.hasTileFlag(d.T_IS_FIRE)))&&t.setMapFlag(E.MAP_HAS_FIRE)}(e)}))),i.push(e.on("assign",(e=>{e.data.fire||t(e)}))),i.push(e.on("copy",(t=>{t.data.fire||i.forEach((t=>t()))})))}});const Me=r.color.install("highlight",[100,100,0]);class Ne{constructor(){this.scent=!1}drawInto(t,e,i={}){const s=i.offsetX||0,a=i.offsetY||0;e.clearMapFlag(E.MAP_DANCES);const n=new r.sprite.Mixer;for(let i=0;i<t.width;++i)for(let r=0;r<t.height;++r)if(e.hasXY(i+s,r+a)){const h=e.cell(i+s,r+a);this.drawCell(n,e,h,e.fov),t.draw(i,r,n.ch||" ",n.fg,n.bg)}}drawCell(t,e,i,s){t.blackOut();const a=!i.hasCellFlag(f.STABLE_SNAPSHOT);i.needsRedraw||a?(this.getAppearance(t,e,i),i.putSnapshot(t),i.needsRedraw=!1,i.setCellFlag(f.STABLE_SNAPSHOT)):(i.getSnapshot(t),i.hasCellFlag(f.COLORS_DANCE)&&e.setMapFlag(E.MAP_DANCES)),this.applyLight(t,i,s);let h=!1;if(h=i.memory?!!(i.memory.flags.entity&n.L_VISUALLY_DISTINCT):i.hasEntityFlag(n.L_VISUALLY_DISTINCT,!0),i.hasCellFlag(f.IS_CURSOR)?(t.bg=Me,t.fg=t.bg.inverse(),h=!0):i.hasCellFlag(f.IS_HIGHLIGHTED)&&(t.bg=Me.mix(t.bg,35),t.fg=t.bg.inverse(),h=!0),this.scent&&e.player){const s=r.clamp(5*e.player.scent.get(i.x,i.y),0,50);if(s){const e=r.color.colors.red;t.mix(e,0,s)}}return h&&([t.fg,t.bg]=r.color.separate(t.fg,t.bg)),!0}getAppearance(t,e,i){let a=i.tiles,n=null,h=null;i.memory?(a=i.memory.tiles,h=i.memory.item):(n=i.hasActor()?i.actor:null,h=i.hasItem()?i.item:null);const o=a[s.GROUND],l=a[s.SURFACE],c=a[s.LIQUID],d=a[s.GAS];if(t.drawSprite(o.sprite),l&&t.drawSprite(l.sprite),c&&t.drawSprite(c.sprite),h&&h.drawInto(t),n&&n.drawInto(t),d){const e=r.rng.cosmetic.number(50)+25;t.drawSprite(d.sprite,e)}if(i.hasFx()){const s=e.fxAt(i.x,i.y);s&&t.drawSprite(s.sprite)}t.dances?(i.setCellFlag(f.COLORS_DANCE),e.setMapFlag(E.MAP_DANCES)):i.clearCellFlag(f.COLORS_DANCE),t.bake(!0)}applyLight(t,e,i){const s=!i||i.isAnyKindOfVisible(e.x,e.y),r=!i||i.isRevealed(e.x,e.y),a=e.map.light.getLight(e.x,e.y);t.multiply(a),i&&i.isCursor(e.x,e.y)?t.invert():s||e.hasEntityFlag(n.L_BRIGHT_MEMORY)||(r?t.scale(70):t.blackOut())}}class xe{constructor(t,e,i={}){this.locations={},this.rng=r.rng.random,this.id=0,this.actors=[],this.items=[],this.fx=[],this.player=null,this._tweens=new r.app.Tweens,this.events=new r.app.Events(this),this.flags={map:0},this.data={seed:0,machineCount:0},i.id&&(this.data.id=i.id),this.drawer=i.drawer||new Ne,this.cells=r.grid.make(t,e,((t,e)=>new et(this,t,e))),i.seed&&(this.data.seed=i.seed,this.rng=r.rng.make(i.seed)),this.light=new r.light.LightSystem(this,i),void 0===i.fov?i.alwaysVisible=!0:!1===i.fov&&(i.visible=!0),i.callback=this.onFovChange.bind(this),this.fov=new r.fov.FovSystem(this,i),i.player&&this.setPlayer(i.player),i.actions&&this.events.load(i.actions)}get seed(){return this.data.seed}set seed(t){this.data.seed=t,this.rng=r.rng.make(t)}get width(){return this.cells.width}get height(){return this.cells.height}hasXY(t,e){return this.cells.hasXY(t,e)}isBoundaryXY(t,e){return 0==t||0==e||t==this.width-1||e==this.height-1}cell(t,e){return this.cells[t][e]}get(t,e){return this.cells.get(t,e)}eachCell(t){this.cells.forEach(((e,i,s)=>t(e,i,s,this)))}someCell(t){return this.cells.some(((e,i,s)=>t(e,i,s,this)))}hasItem(t,e){return this.cell(t,e).hasItem()}itemAt(t,e){return this.items.find((i=>i.isAt(t,e)))||null}eachItem(t){this.items.forEach(t)}addItem(t,e,i,s=!1){if(!this.hasXY(t,e))return!1;const r=this.cell(t,e);if(r._addItem(i)){return this.items.indexOf(i)<0&&this.items.push(i),i.addToMap(this,t,e),s&&this._fireAddItemEffects(i,r),!0}return!1}_fireAddItemEffects(t,e){t.key&&t.key.matches(e.x,e.y)&&e.hasAction("key")?e.trigger("key",{map:this,key:!0,item:t}):e.hasAction("place")&&e.trigger("place",{map:this,item:t})}addItemNear(t,e,i,s=!1){const r=this.rng.matchingLocNear(t,e,((t,e)=>{if(!this.hasXY(t,e))return!1;const s=this.cell(t,e);return!s.hasItem()&&(!s.blocksMove()&&!i.avoidsCell(s))}));return!(!r||r[0]<0)&&this.addItem(r[0],r[1],i,s)}removeItem(t,e=!1){const i=this.cell(t.x,t.y);return!!i._removeItem(t)&&(e&&this._fireRemoveItemEffects(t,i),r.arrayDelete(this.items,t),t.removeFromMap(),!0)}_fireRemoveItemEffects(t,e){t.isKey(e.x,e.y)&&e.hasAction("no_key")?e.trigger("no_key",{map:this,key:!0,item:t}):e.hasAction("remove")&&e.trigger("remove",{map:this,key:!0,item:t})}moveItem(t,e,i,s=!1){if(t.map!==this)throw new Error("Actor not on this map!");const r=this.cell(t.x,t.y),a=this.cell(e,i);return r._removeItem(t),a._addItem(t)&&(s&&(this._fireRemoveItemEffects(t,r),this._fireAddItemEffects(t,a)),t.addToMap(this,e,i)),!0}hasPlayer(t,e){return this.cell(t,e).hasPlayer()}setPlayer(t){this.player=t}actorAt(t,e){return this.actors.find((i=>i.isAt(t,e)))||null}eachActor(t){this.actors.forEach(t)}addActor(t,e,i,s=!1){if(!this.hasXY(t,e))return!1;const r=this.cell(t,e);if(!r.canAddActor(i))return!1;if(r._addActor(i)){const a=this.actors.indexOf(i);return a<0&&this.actors.push(i),i.addToMap(this,t,e),s&&this._fireAddActorEffects(i,r),a<0&&this.trigger("enter",{map:this,actor:i}),!0}return!1}_fireAddActorEffects(t,e){t.isKey(e.x,e.y)&&e.hasAction("key")?e.trigger("key",{map:this,key:!0,actor:t}):t.isPlayer()&&e.hasAction("player-enter")?e.trigger("player-enter",{map:this,actor:t}):e.hasAction("enter")&&e.trigger("enter",{map:this,actor:t})}addActorNear(t,e,i,s=!1){const r=this.rng.matchingLocNear(t,e,((t,e)=>{if(!this.hasXY(t,e))return!1;const s=this.cell(t,e);return!s.hasActor()&&(!s.blocksMove()&&!i.avoidsCell(s))}));return!(!r||r[0]<0)&&this.addActor(r[0],r[1],i,s)}removeActor(t,e=!1){const i=this.cell(t.x,t.y);return!!i.canRemoveActor(t)&&(!!i._removeActor(t)&&(e&&this._fireRemoveActorEffects(t,i),t.removeFromMap(),r.arrayDelete(this.actors,t),this.trigger("exit",{map:this,actor:t}),!0))}_fireRemoveActorEffects(t,e){t.isKey(t.x,t.y)&&e.hasAction("no_key")?e.trigger("no_key",{map:this,key:!0,actor:t}):t.isPlayer()&&e.hasAction("player-exit")?e.trigger("player-exit",{map:this,actor:t}):e.hasAction("exit")&&e.trigger("exit",{map:this,actor:t})}moveActor(t,e,i,s=!1){if(t.map!==this)throw new Error("Actor not on this map!");const r=this.cell(t.x,t.y),a=this.cell(e,i);return r._removeActor(t),a._addActor(t)&&(t.addToMap(this,e,i),s&&(this._fireRemoveActorEffects(t,r),this._fireAddActorEffects(t,a))),!0}fxAt(t,e){return this.fx.find((i=>i.isAt(t,e)))||null}eachFx(t){this.fx.forEach(t)}addFx(t,e,i){const s=this.get(t,e);return!!s&&(i.x=t,i.y=e,s._addFx(i),this.fx.push(i),!0)}moveFx(t,e,i){const s=this.get(t.x,t.y),r=this.get(e,i);return!!r&&(s._removeFx(t),t.x=e,t.y=i,r._addFx(t),!0)}removeFx(t){const e=this.get(t.x,t.y);return r.arrayDelete(this.fx,t),e&&e._removeFx(t),!0}hasKey(t,e){const i=this.actorAt(t,e);if(i&&i.isKey(t,e))return!0;const s=this.itemAt(t,e);return!(!s||!s.isKey(t,e))}count(t){return this.cells.count(((e,i,s)=>t(e,i,s,this)))}dump(t,e=console.log){this.cells.dump(t||(t=>t.dump()),e)}hasMapFlag(t){return!!(this.flags.map&t)}setMapFlag(t){this.flags.map|=t}clearMapFlag(t){this.flags.map&=~t}get needsRedraw(){return this.hasMapFlag(E.MAP_NEEDS_REDRAW)}set needsRedraw(t){t?this.setMapFlag(E.MAP_NEEDS_REDRAW):this.clearMapFlag(E.MAP_NEEDS_REDRAW)}hasCellFlag(t,e,i){return this.cell(t,e).hasCellFlag(i)}setCellFlag(t,e,i){this.cell(t,e).setCellFlag(i)}clearCellFlag(t,e,i){this.cell(t,e).clearCellFlag(i)}hasEntityFlag(t,e,i){return this.cell(t,e).hasEntityFlag(i)}hasTileFlag(t,e,i){return this.cell(t,e).hasTileFlag(i)}highlightPath(t,e=!0){if(this.clearPath(),t.forEach((t=>{this.setCellFlag(t[0],t[1],f.IS_HIGHLIGHTED)})),e&&t[0]){const e=t[0];this.setCellFlag(e[0],e[1],f.IS_CURSOR)}this.needsRedraw=!0}highlightCell(t,e,i=!1){this.setCellFlag(t,e,i?f.IS_CURSOR:f.IS_HIGHLIGHTED),this.needsRedraw=!0}clearPath(){this.cells.forEach((t=>t.clearCellFlag(f.IS_CURSOR|f.IS_HIGHLIGHTED))),this.needsRedraw=!0}showCursor(t,e){this.clearCursor(),this.cell(t,e).setCellFlag(f.IS_CURSOR),this.needsRedraw=!0}clearCursor(){this.cells.forEach((t=>t.clearCellFlag(f.IS_CURSOR))),this.needsRedraw=!0}clear(){this.light.glowLightChanged=!0,this.cells.forEach((t=>{t.clear(),this.events.trigger("changed",t)}))}clearCell(t,e,i){const s=this.cell(t,e);s.clear(i),this.events.trigger("changed",s)}fill(t,e){let i,s;for(t=Q(t),e=Q(e||t),i=0;i<this.width;++i)for(s=0;s<this.height;++s){const r=this.cells[i][s];r.clear(this.isBoundaryXY(i,s)?e:t),this.events.trigger("changed",r)}}hasTile(t,e,i){return this.cell(t,e).hasTile(i)}forceTile(t,e,i){return this.setTile(t,e,i,{superpriority:!0})}setTile(t,e,i,s){if(!(i instanceof W)){const t=i;if(!(i=Q(t)))throw new Error("Failed to find tile: "+t)}!0===s&&(s={superpriority:!0});const r=this.cell(t,e);return!!r.setTile(i,s)&&(this.events.trigger("changed",r,s),!0)}tick(t){let e=this._tweens.length>0;return this._tweens.update(t),this.triggerAll("tick")&&(e=!0),this.events.trigger("tick",t),e}copy(t){if(this.constructor!==t.constructor)throw new Error("Maps must be same type to copy.");if(this.width!==t.width||this.height!==t.height)throw new Error("Maps must be same size to copy");this.cells.forEach(((e,i,s)=>{e.copy(t.cell(i,s))})),this.actors=t.actors.slice(),this.items=t.items.slice(),this.flags.map=t.flags.map,this.light.copy(t.light),this.rng=t.rng,this.data=Object.assign({},t.data),t.events.trigger("assign",this),this.events.trigger("copy",t)}clone(){const t=new this.constructor(this.width,this.height);return t.copy(this),t}hasAction(t){return this.events.has(t)}on(t,e){return this.events.on(t,e)}once(t,e){return this.events.once(t,e)}off(t,e){this.events.off(t,e)}trigger(t,e={}){if(e instanceof L||(e=new L(e)),this.events.trigger(t,e),!e.isDone()&&void 0!==e.x&&void 0!==e.y){this.cell(e.x,e.y).trigger(t,e)}}triggerAll(t,e={}){e instanceof L||(e=new L(e));let i=!1;const a=r.grid.alloc(this.width,this.height);return e.map=this,this.cells.forEach(((e,i,s)=>{e.clearCellFlag(f.EVENT_FIRED_THIS_TURN|f.EVENT_PROTECTED),e.eachTile((n=>{if(!n.hasAction(t))return;let h=0;h=1e4,!e.hasCellFlag(f.CAUGHT_FIRE_THIS_TURN)&&this.rng.chance(1e4,1e4)&&(a[i][s]|=r.flag.fl(n.depth))}))})),e.force=!0,a.forEach(((a,n,h)=>{if(!a)return;const o=this.cell(n,h);if(!o.hasCellFlag(f.EVENT_FIRED_THIS_TURN))for(let n=0;n<=s.GAS;++n)a&r.flag.fl(n)&&(o.trigger(t,e),e.isSuccess()&&(i=!0),e.reset())})),r.grid.free(a),i}drawInto(t,e){this.drawer.drawInto(t,this,e)}getAppearanceAt(t,e,i){const s=this.cell(t,e);return this.drawer.drawCell(i,this,s)}hasActor(t,e){return this.cell(t,e).hasActor()}eachGlowLight(t){this.cells.forEach(((e,i,s)=>{e.eachGlowLight((e=>t(i,s,e)))}))}eachDynamicLight(t){}eachViewport(t){this.player&&t(this.player.x,this.player.y,this.player.visionDistance,r.fov.FovFlags.PLAYER)}lightingChanged(){return this.light.changed}hasVisibleLight(t,e){return!this.light.isDark(t,e)}blocksVision(t,e){return this.cell(t,e).blocksVision()}storeMemory(t,e){const i=this.cell(t,e);i.storeMemory(),i.hasActor()&&i.actor.hasEntityFlag(n.L_IN_SIDEBAR)&&this.setMapFlag(E.MAP_SIDEBAR_CHANGED)}makeVisible(t,e){const i=this.cell(t,e);i.clearMemory(),i.hasTileFlag(d.T_LIST_IN_SIDEBAR)?this.setMapFlag(E.MAP_SIDEBAR_TILES_CHANGED|E.MAP_SIDEBAR_CHANGED):(i.hasActor()&&!i.actor.hasEntityFlag(n.L_IN_SIDEBAR)||i.hasItem()&&!i.item.hasEntityFlag(n.L_IN_SIDEBAR))&&this.setMapFlag(E.MAP_SIDEBAR_CHANGED)}onFovChange(t,e,i){i?this.makeVisible(t,e):this.storeMemory(t,e)}addAnimation(t){this._tweens.add(t)}removeAnimation(t){this._tweens.remove(t)}}function Pe(t,e){const i=r.grid.alloc(t.width,t.height),s=r.grid.alloc(t.width,t.height);for(let e=0;e<t.width;e++)for(let s=0;s<t.height;s++){const r=t.cell(e,s);!r.blocksPathing()&&!r.blocksMove()||r.hasEntityFlag(n.L_SECRETLY_PASSABLE)?i[e][s]=1:i[e][s]=0}let a;for(let e=1;e<i.width-1;e++)for(let s=1;s<i.height-1;s++)if(t.cell(e,s).flags.cell&=~f.IS_CHOKEPOINT,i[e][s]&&!(t.cell(e,s).flags.cell&f.IS_IN_LOOP)){a=0;for(let n=0;n<8;n++){const h=e+r.xy.CLOCK_DIRS[(n+7)%8][0],o=s+r.xy.CLOCK_DIRS[(n+7)%8][1],l=e+r.xy.CLOCK_DIRS[n][0],c=s+r.xy.CLOCK_DIRS[n][1];if((t.hasXY(l,c)&&i[l][c])!=(t.hasXY(h,o)&&i[h][o])&&++a>2){(i[e-1][s]||i[e+1][s])&&(i[e][s-1]||i[e][s+1])||(t.cell(e,s).flags.cell|=f.IS_CHOKEPOINT);break}}}if(e){for(let e=0;e<t.width;e++)for(let i=0;i<t.height;i++)t.cell(e,i).chokeCount=3e4;for(let e=0;e<t.width;e++)for(let a=0;a<t.height;a++){const n=t.cell(e,a);if(i[e][a]&&n.flags.cell&f.IS_CHOKEPOINT)for(let h=0;h<4;h++){const o=e+r.xy.DIRS[h][0],l=a+r.xy.DIRS[h][1];if(t.hasXY(o,l)&&i[o][l]&&!(t.cell(o,l).flags.cell&f.IS_CHOKEPOINT)){s.fill(0),i[e][a]=0;let r=ke(t,s,i,o,l);if(i[e][a]=1,r>=4){for(let e=0;e<s.width;e++)for(let i=0;i<s.height;i++)s[e][i]&&r<t.cell(e,i).chokeCount&&(t.cell(e,i).chokeCount=r,t.cell(e,i).flags.cell&=~f.IS_GATE_SITE);r<n.chokeCount&&(n.chokeCount=r,n.flags.cell|=f.IS_GATE_SITE)}}}}}r.grid.free(i),r.grid.free(s)}function ke(t,e,i,s,a){function n(e,s){let r=2==i[e][s]?5e3:1;return t.cell(e,s).flags.cell&f.IS_IN_AREA_MACHINE&&(r=1e4),r}let h=0;const o=[[s,a]],l=[];for(;o.length;){const s=o.pop();l.push(s);const a=s[0],c=s[1];if(!e[a][c]){e[a][c]=1,h+=n(a,c);for(let s=0;s<4;s++){const n=a+r.xy.DIRS[s][0],h=c+r.xy.DIRS[s][1];if(t.hasXY(n,h)&&i[n][h]&&!e[n][h]){const t=l.pop()||[-1,-1];t[0]=n,t[1]=h,o.push(t)}}}}return Math.min(h,1e4)}function Be(t){t.eachCell(He),Ue(t),Ye(t)}function He(t,e,i,s){!t.blocksPathing()&&!t.blocksMove()||t.hasEntityFlag(n.L_SECRETLY_PASSABLE)?t.flags.cell|=f.IS_IN_LOOP:t.flags.cell&=~f.IS_IN_LOOP}function Ue(t){let e,i,s,a,n,h,o,l;const c=r.grid.alloc(t.width,t.height,1);let d=!0;for(;d;)d=!1,c.forEach(((u,_,g)=>{if(!u)return;const p=t.cell(_,g);if(c[_][g]=0,p.hasCellFlag(f.IS_IN_LOOP)){for(n=0;n<8;n++){if(i=_+r.xy.CLOCK_DIRS[n][0],s=g+r.xy.CLOCK_DIRS[n][1],!t.hasXY(i,s))continue;if(!t.cell(i,s).hasCellFlag(f.IS_IN_LOOP))break}if(8!=n){for(h=o=l=0,e=!1,a=n;a<n+8;a++){if(i=_+r.xy.CLOCK_DIRS[a%8][0],s=g+r.xy.CLOCK_DIRS[a%8][1],!t.hasXY(i,s))continue;if(t.cell(i,s).hasCellFlag(f.IS_IN_LOOP)){if(l++,!e&&(h++,e=!0,h>1))break}else e&&(l>o&&(o=l),l=0,e=!1)}if(e&&l>o&&(o=l),1==h&&o<=4)for(p.clearCellFlag(f.IS_IN_LOOP),a=0;a<8;a++)i=_+r.xy.CLOCK_DIRS[a][0],s=g+r.xy.CLOCK_DIRS[a][1],t.hasXY(i,s)&&t.cell(i,s).hasCellFlag(f.IS_IN_LOOP)&&(c[i][s]=1,d=!0)}}}))}function Ge(t,e){for(let i=0;i<t.width;++i)for(let s=0;s<t.height;++s){if(t.cell(i,s).flags.cell&f.IS_IN_LOOP)e[i][s]=1;else if(i>0&&s>0){const r=t.cell(i,s-1),a=t.cell(i-1,s);r.flags.cell&f.IS_IN_LOOP&&a.flags.cell&f.IS_IN_LOOP&&(e[i][s]=1)}}}function Ye(t){const e=r.grid.alloc(t.width,t.height);let i;Ge(t,e);for(let s=0;s<e.width;s++)for(let a=0;a<e.height;a++){if(t.cell(s,a).flags.cell&f.IS_IN_LOOP){i=!1;for(let n=0;n<8;n++){let h=s+r.xy.CLOCK_DIRS[n][0],o=a+r.xy.CLOCK_DIRS[n][1];if(t.hasXY(h,o)&&!e[h][o]&&!(t.cell(h,o).flags.cell&f.IS_IN_LOOP)){i=!0;break}}i||(e[s][a]=1,t.cell(s,a).flags.cell&=~f.IS_IN_LOOP)}}r.grid.free(e)}class Ve{constructor(t){this.map=new xe(t.width,t.height),this.version=0}}function Ke(t,e,i){return r.xy.arcCount(e,i,((e,i)=>t.cell(e,i).isPassable()))>1}function We(t,e,i){const s=t.cell(e,i);return s.blocksMove()?r.path.OBSTRUCTION:s.blocksPathing()?r.path.FORBIDDEN:s.hasActor()?10:1}function je(t,e){e.update(((e,i,s)=>We(t,i,s)))}function Xe(t,e,i={},s){"string"==typeof i&&(i={tile:i}),s&&(i.boundary=s),!0===i.tile&&(i.tile="FLOOR"),!0===i.boundary&&(i.boundary="WALL");const r=new xe(t,e,i);return void 0===i.tile&&(i.tile="FLOOR"),void 0===i.boundary&&(i.boundary="WALL"),i.tile&&(r.fill(i.tile,i.boundary),r.light.update()),r}var qe=Object.freeze({__proto__:null,NEVER_SEEN:tt,Cell:et,Map:xe,analyze:function(t,e=!0){Be(t),Pe(t,e)},updateChokepoints:Pe,floodFillCount:ke,updateLoopiness:Be,resetLoopiness:He,checkLoopiness:Ue,fillInnerLoopGrid:Ge,cleanLoopiness:Ye,Snapshot:Ve,SnapshotManager:class{constructor(t){this.version=0,this.lightVersion=0,this.free=[],this.map=t,this.cellVersion=r.grid.make(t.width,t.height)}takeNew(){++this.version;const t=this.free.length?this.free.pop():new Ve(this.map);return t.map.flags.map=this.map.flags.map,this.cellVersion.update(((e,i,s)=>{const r=this.map.cell(i,s);if(r.changed&&(e=this.version),e!==t.version){t.map.cell(i,s).copy(r)}return e})),this.map.light.changed&&(this.lightVersion=this.version,this.map.light.changed=!1),t.version!==this.lightVersion&&t.map.light.copy(this.map.light),t.version=this.version,t}revertMapTo(t){this.cellVersion.update(((e,i,s)=>{if(e<t.version)return e;const r=this.map.cell(i,s);if(e>t.version||r.changed){const e=t.map.cell(i,s);return r.copy(e),t.version}return e})),(t.version<this.lightVersion||this.map.light.changed)&&(this.map.light.copy(t.map.light),this.lightVersion=t.version),this.version=t.version}release(t){this.free.push(t)}},isHallway:Ke,replaceTile:function(t,e,i){let s=0;return t.eachCell((t=>{t.hasTile(e)&&t.setTile(i)&&++s})),s},getCellPathCost:We,fillCostMap:je,getPathBetween:function(t,e,i,s,a,n={}){const h=r.grid.alloc(t.width,t.height),o=r.grid.alloc(t.width,t.height);je(t,o),r.path.calculateDistances(h,s,a,o,n.eightWays,r.xy.straightDistanceBetween(e,i,s,a)+1);const l=r.path.getPath(h,e,i,((e,i)=>t.cell(e,i).blocksMove()),n.eightWays);return l&&l.push([s,a]),r.grid.free(o),r.grid.free(h),l},make:Xe,from:function(t,e,i={}){let s,r=0,a=0;return"string"==typeof t&&(t=t.split("\n")),!function(t){return Array.isArray(t)&&"string"==typeof t[0]}(t)?(r=t.height,a=t.width,s=Xe(a,r,i),t.forEach(((t,i,r)=>{const a=e[t]||"FLOOR";s.setTile(i,r,a)}))):(r=t.length,a=t.reduce(((t,e)=>Math.max(t,e.length)),0),s=Xe(a,r,i),t.forEach(((t,i)=>{for(let r=0;r<a;++r){const a=t[r]||".",n=e[a]||"FLOOR";s.setTile(r,i,n)}}))),s.light.update(),s}});class Qe{constructor(t){this.tags=[],this.members={},this.flags={horde:0},t.tags&&("string"==typeof t.tags?this.tags=t.tags.split(/[,|]/).map((t=>t.trim())):this.tags=t.tags.slice()),this.leader=t.leader,t.members&&Object.entries(t.members).forEach((([t,e])=>{this.members[t]=r.range.make(e)})),this.frequency=r.frequency.make(t.frequency||100),this.flags.horde=r.flag.from(y,t.flags)}spawn(t,e=-1,i=-1,s={}){var a;s.canSpawn=s.canSpawn||r.TRUE,s.rng=s.rng||t.rng,s.machine=null!==(a=s.machine)&&void 0!==a?a:0;const n=this._spawnLeader(t,e,i,s);return n?(this._spawnMembers(n,t,s),n):null}_spawnLeader(t,e,i,s){const r=Rt(this.leader);if(!r)throw new Error("Failed to find leader kind = "+this.leader);if(e>=0&&i>=0&&r.avoidsCell(t.cell(e,i)))return null;const a=bt(r,{machineHome:s.machine});if(!a)throw new Error("Failed to make horde leader - "+this.leader);return(e<0||i<0)&&([e,i]=this._pickLeaderLoc(a,t,s)||[-1,-1],e<0||i<0)?null:this._addLeader(a,t,e,i,s)?a:null}_addLeader(t,e,i,s,r){return e.addActor(i,s,t)}_addMember(t,e,i,s,r,a){return t.leader=r,e.addActor(i,s,t)}_spawnMembers(t,e,i){const s=Object.entries(this.members);if(0==s.length)return 0;return s.forEach((([s,r])=>{const a=r.value(i.rng);for(let r=0;r<a;++r)this._spawnMember(s,e,t,i)})),0}_spawnMember(t,e,i,s){const r=Rt(t);if(!r)throw new Error("Failed to find member kind = "+t);const a=bt(r,{machineHome:s.machine});if(!a)throw new Error("Failed to make horde member - "+t);const[n,h]=this._pickMemberLoc(a,e,i,s)||[-1,-1];return n<0||h<0?null:this._addMember(a,e,n,h,i,s)?a:null}_pickLeaderLoc(t,e,i){return i.rng.matchingLoc(e.width,e.height,((s,r)=>{const a=e.cell(s,r);return!a.hasActor()&&(!!i.canSpawn(s,r)&&(!t.avoidsCell(a)&&!Ke(e,s,r)))}))}_pickMemberLoc(t,e,i,s){return s.rng.matchingLocNear(i.x,i.y,((i,s)=>{if(!e.hasXY(i,s))return!1;const r=e.cell(i,s);return!r.hasActor()&&(!t.avoidsCell(r)&&!Ke(e,i,s))}))}}const ze={};function $e(t,e){return"string"==typeof e&&(e={leader:e}),e instanceof Qe||(e=new Qe(e)),ze[t]=e,e}var Je=Object.freeze({__proto__:null,Horde:Qe,hordes:ze,install:$e,installAll:function(t){Object.entries(t).forEach((([t,e])=>{$e(t,e)}))},from:function(t){return t instanceof Qe?t:"string"==typeof t?ze[t]:new Qe(t)},random:function(t={}){const e={tags:[],forbidTags:[],flags:0,forbidFlags:0,depth:0};"string"==typeof t&&(t={tags:t});const i=t.rng||r.rng.random;if("string"==typeof t.tags?t.tags.split(/[,|&]/).map((t=>t.trim())).forEach((t=>{t.startsWith("!")?e.forbidTags.push(t.substring(1).trim()):e.tags.push(t)})):Array.isArray(t.tags)&&(e.tags=t.tags.slice()),"string"==typeof t.forbidTags?e.forbidTags=t.forbidTags.split(/[,|&]/).map((t=>t.trim())):Array.isArray(t.forbidTags)&&(e.forbidTags=t.forbidTags.slice()),t.flags&&"string"==typeof t.flags&&t.flags.split(/[,|]/).map((t=>t.trim())).forEach((t=>{if(t.startsWith("!")){const i=t.substring(1);e.forbidFlags|=y[i]}else e.flags|=y[t]})),t.forbidFlags&&(e.forbidFlags=r.flag.from(y,t.forbidFlags)),t.depth&&(e.depth=t.depth),e.depth&&t.oodChance){for(;i.chance(t.oodChance);)e.depth+=1;e.forbidFlags|=y.HORDE_NEVER_OOD}const s=Object.values(ze).filter((t=>!(e.tags.length&&!r.arraysIntersect(e.tags,t.tags))&&((!e.forbidTags||!r.arraysIntersect(e.forbidTags,t.tags))&&(!(e.flags&&!(t.flags.horde&e.flags))&&!(e.forbidFlags&&t.flags.horde&e.forbidFlags)))));if(e.depth)return i.item(s)||null;const a=e.depth,n=s.map((t=>t.frequency(a))),h=i.weighted(n);return h<0?null:s[h]}});var Ze=Object.freeze({__proto__:null,empty:{}}),ti=Object.freeze({__proto__:null,BasicDrawer:Ne});class ei{constructor(t){this._base={},this._max={},this._bonus={},this._sustain={},this._value={},this.changed=null,this.init(t)}init(t){for(let e in ii){const i="number"==typeof t?t:ii[e];this.set(e,i)}if("number"!=typeof t)for(let e in t)this.set(e,t[e])}forEach(t){Object.keys(ii).forEach((e=>t(this.get(e))))}get(t){return this._value[t]||0}set(t,e=0){return this._value[t]=e,this._base[t]=e,this._max[t]=e,this._bonus[t]=[],e}base(t){return this._base[t]||0}max(t){return this._max[t]||0}sustain(t){return this._sustain[t]||!1}gain(t,e,i=!0){if(e<0&&this._sustain[t])return 0;this._base[t]+=e,i&&this._base[t]>this._max[t]&&(this._max[t]=this._base[t]);let s=this.get(t);return this._calcValue(t)-s}drain(t,e,i=!1){e<0&&(e=-e);const s=this.gain(t,-e,!1);return s&&i&&(this._max[t]=this._base[t]),s}restore(t){this._base[t]=this._max[t];let e=this.get(t);return this._calcValue(t)-e}addBonus(t,e){return this._addBonus(t,{bonus:e})}_addBonus(t,e){"number"==typeof e&&(e={bonus:e}),void 0===this._value[t]&&this.set(t,0),this._bonus[t].push(e);let i=this.get(t);return this._calcValue(t)-i}clearBonus(t,e){return this._clearBonus(t,{bonus:e})}_clearBonus(t,e){"number"==typeof e&&(e={bonus:e});let i=this._bonus[t]||[],s=JSON.stringify(e),r=i.findIndex((t=>JSON.stringify(t)==s));if(r>-1){i.splice(r,1);let e=this.get(t);return this._calcValue(t)-e}return 0}_calcValue(t){let e={};this._bonus[t].forEach((t=>this._applyAdjustment(e,t))),this._sustain[t]=e.sustain||!1;let i=this._base[t]||0;return void 0!==e.fixed?i=e.fixed:(i+=e.bonus||0,void 0!==e.min&&(i=Math.max(e.min,i)),void 0!==e.max&&(i=Math.min(e.max,i))),this._value[t]=i}adjust(t,e){let i;return"number"==typeof e&&(e={bonus:e}),e.base?i=this.gain(t,e.base):e.restore?(i=this.restore(t),0==i&&(i=void 0)):i=this._addBonus(t,e),this.changed&&void 0!==i&&this.changed(this,t),i}clearAdjustment(t,e){let i;return"number"==typeof e&&(e={bonus:e}),e.base?i=this.drain(t,e.base,!0):e.restore||(i=this._clearBonus(t,e)),this.changed&&void 0!==i&&this.changed(this,t),i}_applyAdjustment(t,e){e.bonus&&(t.bonus=(t.bonus||0)+e.bonus),void 0!==e.fixed&&(t.fixed=Math.max(t.fixed||0,e.fixed)),void 0!==e.min&&(t.min=Math.max(t.min||0,e.min)),void 0!==e.max&&(t.max=Math.max(t.max||0,e.max)),void 0!==e.sustain&&(t.sustain=e.sustain)}}const ii={};class si{constructor(t){this.name=t}get has(){return this._bool("_has")}get level(){return this._int("_level")}get disadvantage(){return this._bool("_disadvantage")}get advantage(){return this._bool("_advantage")}get fixed(){return this._int("_fixed")}get bonus(){const t=this._int("_bonus")||0;return this._parent?t+this._parent.bonus:t}get succeed(){return this._bool("_succeed")}get fail(){return this._bool("_fail")}set(t){!1===t?(this._has=!1,this._level=0):(this._has=!0,this._level=!0===t?0:t)}_value(t){return void 0!==this[t]?this[t]:this._parent?this._parent._value(t):void 0}_bool(t){return!!this._value(t)}_int(t){return this._value(t)}adjust(t){Object.entries(t).forEach((([t,e])=>{if(t="_"+t,void 0!==e){if("_fixed"===t){if("number"!=typeof e)throw new Error("fixed skill adjustment must be a number.");e=Math.max(e,this._fixed||0)}else if("_bonus"===t){if("number"!=typeof e)throw new Error("fixed skill adjustment must be a number.");e+=this._bonus||0}this[t]=e}}))}clear(t){Object.keys(t).forEach((t=>{void 0!==this[t="_"+t]&&(this[t]=void 0)}))}}class ri{constructor(t={}){this._skills={},Object.entries(t).forEach((([t,e])=>{this.set(t,e)}))}set(t,e){const i=this.get(t);return i.set(e),i}get(t){let e=this._skills[t];if(e)return e;e=this._skills[t]=new si(t);const i=t.lastIndexOf(".");return i>0?e._parent=this.get(t.substring(0,i)):e.set(!1),e}adjust(t,e){"number"==typeof e&&(e={bonus:e});let i=this.get(t);return i.adjust(e),i}}class ai{constructor(t){this._player=t}get(t,e){return this._data?this._data[t][e]:0}clear(){this._player.map&&(this._data&&r.grid.free(this._data),this._data=r.grid.alloc(this._player.map.width,this._player.map.height))}update(){if(!this._player.map)return;const t=this._player.data.scent||10;this._data[this._player.x][this._player.y]=t;const e=r.grid.alloc(this._data.width,this._data.height),i=this._player.map;this._data.forEach(((t,s,a)=>{const n=i.cell(s,a);if(n.blocksMove())return;let h=t;r.xy.eachNeighbor(s,a,((t,e)=>{if(!this._data.hasXY(t,e))return;const i=this._data[t][e];i>h&&(h=i)}),!0);const o=n.hasLiquid()?3:1;e[s][a]=Math.max(0,h-o)})),r.grid.free(this._data),this._data=e}nextDir(t,e){const i=this._data[t][e]||0;if(!i)return null;let s=i,a=[];if(r.xy.eachNeighbor(t,e,((t,e)=>{if(!this._data.hasXY(t,e))return;const i=this._data[t][e];i==s?a.push([t,e]):i>s&&(a=[[t,e]],s=i)}),!1),!a.length)return null;const n=r.random.item(a);return n[0]=n[0]-t,n[1]=n[1]-e,n}}class ni extends k{constructor(t){super(t),this.scent=new ai(this)}interrupt(t){this.hasGoal()&&(this.clearGoal(),r.message.addAt(this.x,this.y,"{{you}} {{verb see~}} {{a other}}.",{actor:this,verb:"see",other:t}))}endTurn(t=100){this.map&&(this.map.fov.update()&&this.clearActorFlag(o.STABLE_COST_MAP),this.scent.update()),super.endTurn(t)}addToMap(t,e,i){return!!super.addToMap(t,e,i)&&(this.scent.clear(),!0)}setGoal(t,e){const i=this._map;if(!i)throw new Error("No map to set goal with!");this._goalMap||(this._goalMap=r.grid.alloc(i.width,i.height));const s=this._goalMap,a=this.mapToMe();if(a[t][e]<0||a[t][e]>=r.path.NO_PATH||!i.fov.isRevealed(t,e)){let s=r.path.getClosestValidLocation(a,t,e,((t,e)=>!i.fov.isRevealed(t,e)));s=s||[this.x,this.y],t=s[0],e=s[1]}return r.path.calculateDistances(s,t,e,this.costMap()),this._goalMap}nextGoalStep(){const t=this.map;if(!t)return null;const e=this.goalMap;return r.path.nextStep(e,this.x,this.y,((e,i)=>t.hasActor(e,i)&&t.actorAt(e,i)!==this))}pathTo(...t){let e=t[0],i=t[1];1===t.length&&(e=t[0].x,i=t[0].y);const s=this.map;if(!s)return null;const a=this.mapToMe();if(a[e][i]<0||a[e][i]>=r.path.NO_PATH||!s.fov.isRevealed(e,i)){const t=r.path.getClosestValidLocation(a,e,i,((t,e)=>!s.fov.isRevealed(t,e)));if(!t)return null;e=t[0],i=t[1]}return r.path.getPath(a,e,i,((t,e)=>!s.fov.isRevealed(t,e)),!0)}}ni.default={ch:"@",fg:"white",name:"You",swim:!0,sidebarFg:"purple"};class hi extends Ot{constructor(t={}){super((t.sprite||(t.ch=t.ch||ni.default.ch,t.fg=t.fg||ni.default.fg),t.name||(t.name=ni.default.name),void 0===t.swim&&(t.swim=ni.default.swim),t)),this.flags.actor|=o.IS_PLAYER,this.flags.entity|=n.L_ALWAYS_PLURAL,this.attributes=new ei(t.attributes||{}),this.skills=new ri(t.skills||{})}make(t){const e=new ni(this);return this.init(e,t),e}cellCost(t,e){return t.map.fov.isRevealed(t.x,t.y)?super.cellCost(t,e):r.path.FORBIDDEN}}function oi(t){const e=Object.assign({},t);return new hi(e)}var li=Object.freeze({__proto__:null,Attributes:ei,attributes:ii,installAttribute:function(t){"string"!=typeof t?(Object.keys(ii).forEach((t=>{delete ii[t]})),Object.assign(ii,t)):ii[t]=0},makeAttributes:function(t){return new ei(t)},Skills:ri,PlayerKind:hi,Player:ni,make:function(t,e){let i;if("string"==typeof t){if(i=Rt(t),!i)throw new Error("Failed to find item kind - "+t);if(!(i instanceof hi))throw new Error("Not a player kind.")}else i=t instanceof hi?t:oi(t);return i.make(e)},install:function(t,e){if(e instanceof hi)return wt[t]=e,e;const i=oi(e);return i.id=t,wt[t]=i,i},get:function(t){if(t instanceof hi)return t;const e=wt[t];if(e&&!(e instanceof hi))throw new Error("No a player kind.");return e},makeKind:oi});class ci extends r.widget.Widget{constructor(t){super((t.tag=t.tag||"viewport",t)),this.offsetX=0,this.offsetY=0,this._subject=null,this.player=null,this.bounds=new r.xy.Bounds(t.x,t.y,t.width,t.height),this.bg=r.color.from(t.bg||"black"),this.attr("snap",t.snap||!1),this.attr("center",t.center||!1),this.attr("lockX",t.lock||t.lockX||!1),this.attr("lockY",t.lock||t.lockY||!1),this.filter=t.filter||null,this.scent=t.scent||!1}get subject(){return this._subject}set subject(t){this.attr("center",!!t),t&&(this.offsetX=t.x-this.halfWidth(),this.offsetY=t.y-this.halfHeight()),this._subject=t,this.player=t&&t instanceof ni?t:null}set lock(t){this.attr("lockX",t),this.attr("lockY",t)}get lockX(){return this._attrBool("lockX")}set lockX(t){this.attr("lockX",t)}get lockY(){return this._attrBool("lockY")}set lockY(t){this.attr("lockY",t)}toMapX(t){return t+this.offsetX-this.bounds.x}toMapY(t){return t+this.offsetY-this.bounds.y}toInnerX(t){return t-this.bounds.x}toInnerY(t){return t-this.bounds.y}halfWidth(){return Math.floor(this.bounds.width/2)}halfHeight(){return Math.floor(this.bounds.height/2)}centerOn(t,e,i){this.attr("center",!0),this.subject={x:e,y:i,map:t}}showMap(t,e=0,i=0){this.subject={x:e,y:i,map:t},this.offsetX=e,this.offsetY=i,this.attr("center",!1),this.attr("snap",!1)}updateOffset(){if(!this._subject)return this.offsetX=0,void(this.offsetY=0);const t=this._subject,e=t.map,i=e;if(t&&e.hasXY(t.x,t.y))if(this._attrBool("snap")){let e=this.offsetX,s=this.offsetX+this.bounds.width,r=this.offsetY,a=this.offsetY+this.bounds.height;(t.x<e||t.x>s)&&(e=this.offsetX=t.x-this.halfWidth(),s=e+this.bounds.width),(t.y<r||t.y>a)&&(r=this.offsetY=t.y-this.halfHeight(),a=r+this.bounds.height);const n=Math.floor(this.bounds.width/5),h=Math.floor(this.bounds.height/5),o=Math.floor(this.bounds.width/3);e+n>=t.x?this.offsetX=Math.max(0,t.x+o-this.bounds.width):s-n<=t.x&&(this.offsetX=Math.min(t.x-o,i.width-this.bounds.width));const l=Math.floor(this.bounds.height/3);r+h>=t.y?this.offsetY=Math.max(0,t.y+l-this.bounds.height):a-h<=t.y&&(this.offsetY=Math.min(t.y-l,i.height-this.bounds.height))}else this._attrBool("center")?(this.offsetX=t.x-this.halfWidth(),this.offsetY=t.y-this.halfHeight()):(this.offsetX=t.x,this.offsetY=t.y);this.lockX&&e&&(this.offsetX=r.clamp(this.offsetX,0,e.width-this.bounds.width)),this.lockY&&e&&(this.offsetY=r.clamp(this.offsetY,0,e.height-this.bounds.height))}_draw(t){if(!this._subject)return;const e=this._subject.map;if(!e||!e.needsRedraw)return;const i=e.fov;if(t.blackOutRect(this.bounds.x,this.bounds.y,this.bounds.width,this.bounds.height,this.bg),!this._subject)return;this.updateOffset();e.drawer.scent=this.scent;const s=new r.sprite.Mixer;for(let r=0;r<this.bounds.width;++r)for(let a=0;a<this.bounds.height;++a){const n=r+this.offsetX,h=a+this.offsetY;if(e.hasXY(n,h)){const t=e.cell(n,h);e.drawer.drawCell(s,e,t,i)}else s.draw(" ",this.bg,this.bg);this.filter&&this.filter(s,n,h,e),t.drawSprite(r+this.bounds.x,a+this.bounds.y,s)}}update(t){if(super.update(t),!this._subject)return;const e=this._subject.map;e&&e.hasMapFlag(E.MAP_DANCES)&&r.cosmetic.chance(10)&&(e.eachCell((t=>{t.hasCellFlag(f.COLORS_DANCE)&&e.fov.isAnyKindOfVisible(t.x,t.y)&&r.cosmetic.chance(2)&&(t.needsRedraw=!0)})),e.needsRedraw=!0)}_mousemove(t){if(super._mousemove(t),!this.bounds.contains(t.x,t.y))return void this.clearPath();if(!this.player)return;this.player.map&&this.showPath(this.toInnerX(t.x),this.toInnerY(t.y))}_click(t){super._click(t),this.player&&(this.player.hasGoal()?this.player.clearGoal():this.player.setGoal(this.toInnerX(t.x),this.toInnerY(t.y)))}clearPath(){if(!this.player)return;const t=this.player.map;t&&t.clearPath()}showPath(t,e){if(!this.player)return!1;const i=this.player.map;if(!i)return!1;const s=this.player.pathTo(t,e);return s?i.highlightPath(s,!0):i.clearPath(),i.highlightCell(t,e),!0}}r.app.defaultStyle.add("msgs",{bg:"darkest_gray",fg:"white"}),r.app.defaultStyle.add("archive",{bg:"darkest_gray",fg:"white"});class di extends r.widget.Widget{constructor(t){if(super((t.tag=t.tag||"msgs",t)),!this.bounds.height)throw new Error("Must provde a height for messages widget.");this.cache=new r.message.MessageCache({width:this.bounds.width,length:t.archive||40,match:()=>{this.needsDraw=!0}}),this.on("click",(()=>{this.showArchive()}))}clear(){this.cache.clear(),this.needsDraw=!0}confirmAll(){this.cache.confirmAll(),this.needsDraw=!0}draw(t){const e=this.bounds.y<10,i=this._used.bg,s=this._used.fg;return t.fillRect(this.bounds.x,this.bounds.y,this.bounds.width,this.bounds.height," ",i,i),this.cache.forEach(((r,a,n)=>{if(n>=this.bounds.height)return;const h=(e?this.bounds.height-n-1:n)+this.bounds.y;t.drawText(this.bounds.x,h,r,s),a&&i&&t.mix(i,50,this.bounds.x,h,this.bounds.width,1)})),!0}showArchive(){if(this.cache.length<=this.bounds.height)return;if(!this.scene)return;this.scene.app.scenes.run("msg-archive",this)}}const ui={create(){},start(t){new _i({scene:this,source:t,id:"ARCHIVE"})},stop(){this.children.forEach((t=>t.destroy())),this.children=[]},destroy(){}};r.app.installScene("msg-archive",ui);class _i extends r.widget.Widget{constructor(t){super({scene:t.scene,id:t.id||"ARCHIVE",tag:t.tag||"archive",x:0,y:0,tabStop:!0}),this.mode="forward",this._timeout=null,this._needsDraw=!0,this.source=t.source,this.isOnTop=this.source.bounds.y<10,this.bounds.height=this.isOnTop?this.scene.height-this.source.bounds.y:this.source.bounds.bottom,this.totalCount=Math.min(this.source.cache.length,this.isOnTop?this.scene.height-this.source.bounds.top:this.source.bounds.bottom),this.shown=this.source.bounds.height,this._timeout=this.scene.wait(16,(()=>this._forward())),this.source.cache.confirmAll(),this.on("keypress",(()=>this._next())),this.on("click",(()=>this._next()))}set needsDraw(t){this._needsDraw||(this._needsDraw=t),super.needsDraw=t}contains(){return!0}finish(){this.scene.stop()}_next(){this.scene&&("ack"===this.mode?(this.mode="reverse",this.scene.needsDraw=!0,this._timeout&&this._timeout(),this._timeout=this.scene.wait(16,(()=>this._reverse()))):"reverse"===this.mode?this.finish():(this.mode="ack",this.shown=this.totalCount,this._timeout&&(this._timeout(),this._timeout=null),this.scene.needsDraw=!0))}_forward(){this.scene&&(++this.shown,this._timeout=null,this.scene.needsDraw=!0,this.shown<this.totalCount?this._timeout=this.scene.wait(16,(()=>this._forward())):(this.mode="ack",this.shown=this.totalCount))}_reverse(){this.scene&&(--this.shown,this._timeout=null,this.shown<=this.source.bounds.height?this.finish():(this.scene.needsDraw=!0,this._timeout=this.scene.wait(16,(()=>this._reverse()))))}_draw(t){let e=0;if(!this._needsDraw)return;this._needsDraw=!1;const i=this.isOnTop,s=t,a=r.color.from(this._used.fg),n=i?this.shown-1:this.bounds.bottom-this.shown,h=i?0:this.bounds.bottom-1,o=i?-1:1;if(s.fillRect(this.source.bounds.x,Math.min(n,h),this.bounds.width,this.shown," ",this._used.bg,this._used.bg),this.source.cache.forEach(((t,r,l)=>{const c=n+l*o;if(i){if(c<h)return}else if(c>h)return;e=Math.floor(50*l/this.shown);const d=a.mix(this._used.bg,e);s.drawText(this.source.bounds.x,c,t,d,this._used.bg)})),"ack"===this.mode){const t=this.isOnTop?0:s.height-1,e=this.source.bounds.x>8?this.source.bounds.x-8:Math.min(this.source.bounds.x+this.bounds.width,s.width-8);s.wrapText(e,t,8,"--DONE--",this._used.bg,this._used.fg)}}}r.color.install("flavorText",50,40,90),r.color.install("flavorPrompt",100,90,20);class gi extends r.widget.Text{constructor(t){super((t.tag=t.tag||"flavor",t)),this._needsDraw=!0,this.overflow=t.overflow||!1}showText(t){return this.text(t),this.removeClass("prompt"),this.needsDraw=!0,this}clear(){return this.text(""),this.removeClass("prompt"),this.needsDraw=!0,this}showPrompt(t){return this.text(t),this.addClass("prompt"),this.needsDraw=!0,this}getFlavorText(t,e,i,a){const n=t.cell(e,i);let h,o="";const l=!a||a.isAnyKindOfVisible(e,i),c=!a||a.isDirectlyVisible(e,i),u=!!a&&a.isRevealed(e,i),_=!!a&&a.isMagicMapped(e,i);let g;if(c)g="You see";else if(l)g="You sense";else if(u)g="You remember seeing";else{if(!_)return"";g="You expect to see"}const f=n.hasActor()?t.actorAt(e,i):null,p=n.hasItem()?t.itemAt(e,i):null,E=n.hasTileFlag(d.T_STAND_IN_TILE);let m=!1;f?(o=f.getFlavor({color:!1,article:!0,action:!0}),m=!0):p&&(o=p.getFlavor({color:!1,article:!0}),m=!0);let A=E?" in ":" on ";const T=n.depthTile(s.GROUND)||$,y=n.depthTile(s.SURFACE),S=n.depthTile(s.LIQUID);let I="";if(y){m&&(m=!1,o+=" on "),y.hasTileFlag(d.T_BRIDGE)&&(A=" over "),I=y.getFlavor()+A}let L="";S&&(L=S.getFlavor()+" covering ",m&&(m=!1,o+=" in ")),m&&(m=!1,o+=" on ");let O=T.getFlavor({article:!0});return h=r.text.apply("{{intro}} {{text}}.",{intro:g,text:o+I+L+O}),h}_draw(t){this._needsDraw&&(this._needsDraw=!1,super._draw(t))}}r.color.install("blueBar",15,10,50),r.color.install("redBar",45,10,15),r.color.install("purpleBar",50,0,50),r.color.install("greenBar",10,50,10);class fi{constructor(){this.dist=0,this.priority=0,this.sidebarY=-1}draw(t,e){return 0}}class pi extends fi{constructor(t){super(),this.actor=t}get x(){return this.actor.x}get y(){return this.actor.y}get changed(){return this.actor.changed}draw(t,e){return this.actor.drawSidebar(t,e)}}class Ei extends fi{constructor(t){super(),this.item=t}get x(){return this.item.x}get y(){return this.item.y}get changed(){return this.item.changed}draw(t,e){return this.item.drawSidebar(t,e)}}class mi extends fi{constructor(t){super(),this.changed=!0,this.cell=t}get x(){return this.cell.x}get y(){return this.cell.y}draw(t,e){return this.cell.drawSidebar(t,e)}}class Ai extends r.widget.Widget{constructor(t){super((t.tag=t.tag||"sidebar",t)),this.cellCache=[],this.lastX=-1,this.lastY=-1,this.lastMap=null,this.entries=[],this.subject=null,this.highlight=null,this._needsDraw=!0}set needsDraw(t){t&&(this._needsDraw=t),super.needsDraw=t}reset(){this.lastMap=null,this.lastX=-1,this.lastY=-1,this._needsDraw=!0}entryAt(t){return this.entries.find((e=>e.sidebarY<=t.y&&-1!==e.sidebarY))||null}click(t){return!!this.bounds.contains(t.x,t.y)&&(!!this.highlight&&(!!this.subject&&(this.subject.setGoal(this.highlight.x,this.highlight.y),!0)))}mousemove(t){return this.contains(t)?(this._highlightRow(t.y),!0):(this.clearHighlight(),!1)}highlightAt(t,e){const i=this.highlight;this.highlight=null,this.entries.forEach((i=>{i.x==t&&i.y==e&&(this.highlight=i)}));const s=this.highlight!==i;return this._needsDraw||(this._needsDraw=s),s}_highlightRow(t){const e=this.highlight;this.highlight=null,this.entries.forEach((e=>{e.sidebarY<=t&&-1!==e.sidebarY&&(this.highlight=e)}));const i=this.highlight!==e;if(this.needsDraw||(this.needsDraw=i),this.highlight&&this.subject&&this.subject.map){const t=this.subject.pathTo(this.highlight.x,this.highlight.y);t?this.subject.map.highlightPath(t,!0):this.subject.map.showCursor(this.highlight.x,this.highlight.y),this.subject.map.highlightCell(this.highlight.x,this.highlight.y)}return i}clearHighlight(){const t=!!this.highlight;return this.highlight=null,this.needsDraw||(this.needsDraw=t),t}_updateCellCache(t){return!(this.lastMap&&t===this.lastMap&&!t.hasMapFlag(E.MAP_SIDEBAR_TILES_CHANGED))&&(this.lastMap=null,this.cellCache.length=0,r.xy.forRect(t.width,t.height,((e,i)=>{const s=t.cell(e,i);s.hasTileFlag(d.T_LIST_IN_SIDEBAR)&&this.cellCache.push(s)})),t.clearMapFlag(E.MAP_SIDEBAR_TILES_CHANGED),this.needsDraw=!0,!0)}_makeActorEntry(t){return new pi(t)}_makeItemEntry(t){return new Ei(t)}_makeCellEntry(t){return new mi(t)}_getPriority(t,e,i,s){return s?s.isDirectlyVisible(e,i)?1:s.isAnyKindOfVisible(e,i)?2:s.isRevealed(e,i)?t.cell(e,i).hasEntityFlag(n.L_BRIGHT_MEMORY)?3:4:-1:t.cell(e,i).hasCellFlag(f.STABLE_MEMORY)?3:1}_isDim(t){return t!==this.highlight&&(!!this.highlight||t.priority>3)}_addActorEntry(t,e,i,s,a){const h=this._getPriority(e,t.x,t.y,a);if(h<0||h>3)return!1;if(t.hasEntityFlag(n.L_NO_SIDEBAR))return!1;const o=this._makeActorEntry(t);return o.dist=r.xy.distanceBetween(i,s,t.x,t.y),o.priority=t.isPlayer()?0:h,this.entries.push(o),!0}_addItemEntry(t,e,i,s,a){const h=this._getPriority(e,t.x,t.y,a);if(h<0)return!1;if(t.hasEntityFlag(n.L_NO_SIDEBAR))return!1;const o=this._makeItemEntry(t);return o.dist=r.xy.distanceBetween(i,s,t.x,t.y),o.priority=h,this.entries.push(o),!0}_addCellEntry(t,e,i,s,a){const n=this._getPriority(e,t.x,t.y,a);if(n<0)return!1;const h=this._makeCellEntry(t);return h.dist=r.xy.distanceBetween(i,s,t.x,t.y),h.priority=n,this.entries.push(h),!0}_updateEntryCache(t,e,i,s){if(t===this.lastMap&&e===this.lastX&&i===this.lastY&&!t.hasMapFlag(E.MAP_SIDEBAR_CHANGED|E.MAP_SIDEBAR_TILES_CHANGED)){if(!this.entries.some((t=>t.changed)))return!1}t.clearMapFlag(E.MAP_SIDEBAR_CHANGED);const a=this.highlight?this.highlight.x:-1,h=this.highlight?this.highlight.y:-1;this.clearHighlight(),this.lastMap=t,this.lastX=e,this.lastY=i,this.entries.length=0;const o=r.grid.alloc(t.width,t.height);return t.eachActor((r=>{const a=r.x,h=r.y;!o[a][h]&&this._addActorEntry(r,t,e,i,s)?(o[a][h]=1,r.setEntityFlag(n.L_IN_SIDEBAR)):r.clearEntityFlag(n.L_IN_SIDEBAR)})),t.eachItem((r=>{const a=r.x,h=r.y;!o[a][h]&&this._addItemEntry(r,t,e,i,s)?(r.setEntityFlag(n.L_IN_SIDEBAR),o[a][h]=1):r.clearEntityFlag(n.L_IN_SIDEBAR)})),this.cellCache.forEach((r=>{o[r.x][r.y]||this._addCellEntry(r,t,e,i,s)&&(o[r.x][r.y]=1)})),this.entries.sort(((t,e)=>t.priority!=e.priority?t.priority-e.priority:t.dist-e.dist)),a>-1&&this.highlightAt(a,h),r.grid.free(o),!0}update(){return!!this.subject&&this.updateFor(this.subject)}updateFor(t){return!!t.map&&this.updateAt(t.map,t.x,t.y,t.map.fov)}updateAt(t,e,i,s){let r=this._updateCellCache(t);return this._updateEntryCache(t,e,i,s)&&(r=!0),r}draw(t){var e;if(!(null===(e=this.subject)||void 0===e?void 0:e.map))return!1;if(this.update()&&(this.needsDraw=!0),!this.needsDraw)return!1;this.needsDraw=!1;const i=this._used.bg||r.color.BLACK;t.fillRect(this.bounds.x,this.bounds.y,this.bounds.width,this.bounds.height," ",i,i),this.entries.forEach((t=>t.sidebarY=-1));const s=this.bounds.clone();let a;for(let e=0;e<this.entries.length&&s.height>0;++e){a=this.entries[e],a.sidebarY=s.y;let r=a.draw(t,s);this._isDim(a)?t.mix(i,50,s.x,s.y,s.width,r):this.highlight===a&&t.mix("white",20,s.x,s.y,s.width,r),r&&(++r,s.y+=r,s.height-=r)}return!0}}class Ti extends r.app.Scene{constructor(t,e){super(t,e),this.result=void 0,this.mouse=!1,this.fov=!1,this.scent=!1,this.running=!1,this.keymap={}}get viewWidth(){return this.viewport.bounds.width}get viewHeight(){return this.viewport.bounds.height}_initMenu(t){}_initSidebar(t){if("number"==typeof t.sidebar)t.sidebar={width:t.sidebar};else if(!0===t.sidebar)t.sidebar={};else if(!t.sidebar)return;const e=t.sidebar;e.width=e.width||-20;const i=t.viewport;e.width<0?(e.width*=-1,e.x=i.x+i.width-e.width,e.y=i.y,e.height=i.height,i.width-=e.width):(e.x=0,e.height=i.height,e.y=i.y,i.x=e.width,i.width-=e.width),e.scene=this,this.sidebar=new Ai(e)}_initMessages(t){if(!1===t.messages)return;!0===t.messages?t.messages={archive:-4}:"number"==typeof t.messages&&(t.messages={archive:t.messages});const e=t.messages||{archive:-4};if(e.archive=e.archive||e.y||-4,e.archive<0){const i=t.viewport;e.x=i.x,e.y=i.height+e.archive,e.width=i.width,e.height=-e.archive,i.height-=e.height}else{const i=t.viewport;e.x=i.x,e.y=i.y,e.width=i.width,e.height=e.archive,i.y+=e.archive,i.height-=e.archive}e.scene=this,this.messages=new di(e)}_initFlavor(t){if(!1===t.flavor)return;!0===t.flavor&&(t.flavor={});const e=t.flavor||{},i=t.viewport;0===(i.y||0)?(e.x=i.x||0,e.y=i.height-1,e.width=i.width,i.height-=1):(e.x=i.x,e.y=i.y,e.width=i.width,i.y+=1,i.height-=1),e.scene=this,this.flavor=new gi(e)}_initViewport(t){!0===t.viewport&&(t.viewport={});const e=t.viewport||{};e.lock=!0,e.x=e.x||0,e.y=e.y||0,e.width=e.width||this.app.width-e.x,e.height=e.height||this.app.height-e.y,this.viewport=new ci(e)}create(t){if(super.create(t),!t.makeMap||!t.makePlayer)throw new Error("Need funcitons for makeMap and makePlayer");this._makeMap=t.makeMap,this._makePlayer=t.makePlayer,this._startMap=t.startMap||r.NOOP,t.keymap&&Object.assign(this.keymap,t.keymap),t.mouse&&(this.mouse=!0),"number"==typeof t.messages&&(t.messages={archive:t.messages}),!0===t.flavor?t.flavor={}:!1===t.flavor&&delete t.flavor,!0===t.viewport&&(t.viewport={});const e=t.viewport=t.viewport||{};e.x=e.x||0,e.y=e.y||0,e.width=e.width||this.app.width-e.x,e.height=e.height||this.app.height-e.y,this._initMenu(t),t.sidebar&&this._initSidebar(t),t.messages&&this._initMessages(t),t.flavor&&this._initFlavor(t),this._initViewport(t),this.scheduler=new r.scheduler.Scheduler}start(t={}){this.messages&&this.messages.clear(),this.player=t.player||this._makePlayer.call(this),this.viewport.subject=this.player,this.sidebar&&(this.sidebar.subject=this.player);const e=t.map||0;this.startNewMap({id:e}),this.scheduler.push(this.player,0),super.start(t)}startNewMap(t={id:0}){if(this.scheduler.clear(),void 0===t.id&&(t.id=this.map.id),this.map=this._makeMap.call(this,t),this.map.setPlayer(this.player),this._startMap.call(this,this.map,this.player,t),this.player.map!==this.map){const t=this.map.locations.start||[0,0];if(!this.map.addActorNear(t[0],t[1],this.player))throw new Error("Failed to find starting spot for player!")}this.scent&&(this.map.drawer.scent=this.scent),this.map.actors.forEach((t=>{t.isPlayer()||this.scheduler.push(t,t.moveSpeed())})),this.map.fov.update()}update(t){if(super.update(t),this.tweens.length)return;let e=this.scheduler.pop();if(!e)return void this.stop();let i=99;for(;i>0&&e;)i=e.act(this),i>=0&&(this.scheduler.push(e,i),e=this.scheduler.pop()),e===this.player&&(i=0)}input(t){super.input(t),t.defaultPrevented||t.propagationStopped||(t.type===r.app.MOUSEMOVE?this.mousemove(t):t.type===r.app.CLICK?this.click(t):t.type===r.app.KEYPRESS&&this.keypress(t))}mousemove(t){if(this.viewport.contains(t)){const e=this.viewport.toInnerX(t.x),i=this.viewport.toInnerY(t.y);if(this.flavor){const t=this.flavor.getFlavorText(this.map,e,i,this.map.fov);this.flavor.showText(t)}this.sidebar&&this.sidebar.highlightAt(e,i)}}click(t){}keypress(t){if(this.map.clearPath(),this.player.hasGoal())this.player.clearGoal();else{const e=this._actionFor(this.keymap,t);e&&this.player.setAction(e)}}_actionFor(t,e){return e.dir&&t.dir?t.dir:t[e.key]||t[e.code]||t.keypress||t.default||null}}r.app.installScene("game",((t,e)=>new Ti(t,e)));var yi=Object.freeze({__proto__:null,Viewport:ci,Messages:di,ArchiveScene:ui,ArchiveWidget:_i,Flavor:gi,EntryBase:fi,ActorEntry:pi,ItemEntry:Ei,CellEntry:mi,Sidebar:Ai,Game:Ti});z("FLOOR",{ch:"·",fg:r.color.from([30,30,30]).rand(20,0,0,0),bg:r.color.from([2,2,10]).rand(0,2,2,0),priority:10,article:"the",flavor:"the stone floor"}),z("DOOR",{ch:"+",fg:[100,40,40],bg:[30,60,60],priority:30,flags:"T_IS_DOOR, L_BLOCKS_EFFECTS, L_BLOCKS_ITEMS, L_BLOCKS_VISION, L_VISUALLY_DISTINCT",article:"a",actions:{enter:"TILE:DOOR_OPEN",open:"TILE:DOOR_OPEN_ALWAYS"},flavor:"a closed door"}),z("DOOR_OPEN","DOOR",{ch:"'",fg:[100,40,40],bg:[30,60,60],priority:40,flags:"!L_BLOCKS_ITEMS, !L_BLOCKS_VISION",name:"open door",article:"an",actions:{tick:{chance:1e4,tile:"DOOR~!"},enter:null,open:null,close:"TILE:DOOR~!"},flavor:"an open door"}),z("DOOR_OPEN_ALWAYS","DOOR_OPEN",{actions:{tick:null,close:"TILE:DOOR~!"},flavor:"an open door"}),z("UP_STAIRS",{ch:">",fg:[100,50,50],bg:[40,20,20],priority:200,flags:"T_UP_STAIRS, L_BLOCKED_BY_STAIRS, L_VISUALLY_DISTINCT, T_LIST_IN_SIDEBAR",name:"upward stairs",article:"an",actions:{climb:t=>t.actor&&t.actor.isPlayer()?(t.game.startNewMap({up:!0}),t.actor.endTurn()):t.didNothing()},flavor:"stairs leading upwards"}),z("DOWN_STAIRS",{ch:"<",fg:[100,50,50],bg:[40,20,20],priority:200,flags:"T_DOWN_STAIRS, L_BLOCKED_BY_STAIRS, L_VISUALLY_DISTINCT, T_LIST_IN_SIDEBAR",name:"downward stairs",article:"a",actions:{descend:t=>t.actor&&t.actor.isPlayer()?(t.game.startNewMap({down:!0}),t.actor.endTurn()):t.didNothing()},flavor:"downward leading stairs"}),z("WALL",{ch:"#",fg:r.color.from([7,7,7]).rand(0,3,3,3),bg:r.color.from([40,40,40]).rand(10,10,0,5),priority:100,flags:"L_WALL_FLAGS",article:"a",name:"stone wall",description:"A wall made from rough cut stone.",flavor:"a rough stone wall"}),z("IMPREGNABLE",{ch:"#",fg:r.color.from([7,7,7]).rand(0,3,3,3),bg:r.color.from([40,40,40]).rand(10,10,0,5),priority:100,flags:"L_WALL_FLAGS, IMPREGNABLE",article:"a",name:"impregnable wall",description:"A wall made from very hard stone.",flavor:"a very hard wall"}),z("LAKE",{ch:"~",fg:r.color.from([25,28,60]).dance(20,0,4,15),bg:r.color.from([10,15,41]).dance(20,5,5,5),priority:50,flags:"T_DEEP_WATER",name:"deep water",article:"the",flavor:"some deep water"}),z("SHALLOW",{ch:"·",fg:r.color.from([5,8,10]).dance(10,0,4,15),bg:r.color.from([10,30,30]).dance(6,0,10,10),priority:20,name:"shallow water",article:"the",flags:"T_SHALLOW_WATER",flavor:"some shallow water"}),z("BRIDGE",{ch:"☰",fg:[80,40,40],priority:40,depth:"SURFACE",flags:"T_BRIDGE, L_VISUALLY_DISTINCT",article:"a",groundTile:"LAKE",flavor:"a bridge"}),t.action=v,t.actions=zt,t.actor=Ft,t.ai=Lt,t.draw=ti,t.effect=K,t.effects=Le,t.entity=ht,t.flags=S,t.fx=Kt,t.game=yi,t.horde=Je,t.item=kt,t.layer=De,t.map=qe,t.memory=Ze,t.player=li,t.tile=Z,Object.defineProperty(t,"__esModule",{value:!0})}));
//# sourceMappingURL=gw-map.min.js.map
