!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("gw-utils")):"function"==typeof define&&define.amd?define(["exports","gw-utils"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).GW=e.GW||{},e.GW)}(this,(function(e,t){"use strict";var l;!function(e){e[e.ALL_LAYERS=-1]="ALL_LAYERS",e[e.GROUND=0]="GROUND",e[e.LIQUID=1]="LIQUID",e[e.SURFACE=2]="SURFACE",e[e.GAS=3]="GAS",e[e.ITEM=4]="ITEM",e[e.ACTOR=5]="ACTOR",e[e.PLAYER=6]="PLAYER",e[e.FX=7]="FX",e[e.UI=8]="UI"}(l||(l={}));const i=t.flag.fl;var s,r,a,_,h,n,c;!function(e){e[e.L_SUPERPRIORITY=i(1)]="L_SUPERPRIORITY",e[e.L_SECRETLY_PASSABLE=i(2)]="L_SECRETLY_PASSABLE",e[e.L_BLOCKS_MOVE=i(3)]="L_BLOCKS_MOVE",e[e.L_BLOCKS_VISION=i(4)]="L_BLOCKS_VISION",e[e.L_BLOCKS_SURFACE=i(6)]="L_BLOCKS_SURFACE",e[e.L_BLOCKS_LIQUID=i(8)]="L_BLOCKS_LIQUID",e[e.L_BLOCKS_GAS=i(7)]="L_BLOCKS_GAS",e[e.L_BLOCKS_ITEMS=i(5)]="L_BLOCKS_ITEMS",e[e.L_BLOCKS_ACTORS=i(11)]="L_BLOCKS_ACTORS",e[e.L_BLOCKS_EFFECTS=i(9)]="L_BLOCKS_EFFECTS",e[e.L_BLOCKS_DIAGONAL=i(10)]="L_BLOCKS_DIAGONAL",e[e.L_INTERRUPT_WHEN_SEEN=i(11)]="L_INTERRUPT_WHEN_SEEN",e[e.L_LIST_IN_SIDEBAR=i(12)]="L_LIST_IN_SIDEBAR",e[e.L_VISUALLY_DISTINCT=i(13)]="L_VISUALLY_DISTINCT",e[e.L_BRIGHT_MEMORY=i(14)]="L_BRIGHT_MEMORY",e[e.L_INVERT_WHEN_HIGHLIGHTED=i(15)]="L_INVERT_WHEN_HIGHLIGHTED",e[e.L_BLOCKED_BY_STAIRS=e.L_BLOCKS_ITEMS|e.L_BLOCKS_SURFACE|e.L_BLOCKS_GAS|e.L_BLOCKS_LIQUID|e.L_BLOCKS_EFFECTS|e.L_BLOCKS_ACTORS]="L_BLOCKED_BY_STAIRS",e[e.L_BLOCKS_SCENT=e.L_BLOCKS_MOVE|e.L_BLOCKS_VISION]="L_BLOCKS_SCENT",e[e.L_DIVIDES_LEVEL=e.L_BLOCKS_MOVE]="L_DIVIDES_LEVEL",e[e.L_WAYPOINT_BLOCKER=e.L_BLOCKS_MOVE]="L_WAYPOINT_BLOCKER",e[e.L_IS_WALL=e.L_BLOCKS_MOVE|e.L_BLOCKS_VISION|e.L_BLOCKS_LIQUID|e.L_BLOCKS_GAS|e.L_BLOCKS_EFFECTS|e.L_BLOCKS_DIAGONAL]="L_IS_WALL",e[e.L_BLOCKS_EVERYTHING=e.L_IS_WALL|e.L_BLOCKS_ITEMS|e.L_BLOCKS_ACTORS|e.L_BLOCKS_SURFACE]="L_BLOCKS_EVERYTHING"}(s||(s={})),function(e){e[e.DFF_SUBSEQ_ALWAYS=i(0)]="DFF_SUBSEQ_ALWAYS",e[e.DFF_SUBSEQ_EVERYWHERE=i(1)]="DFF_SUBSEQ_EVERYWHERE",e[e.DFF_TREAT_AS_BLOCKING=i(2)]="DFF_TREAT_AS_BLOCKING",e[e.DFF_PERMIT_BLOCKING=i(3)]="DFF_PERMIT_BLOCKING",e[e.DFF_BLOCKED_BY_OTHER_LAYERS=i(4)]="DFF_BLOCKED_BY_OTHER_LAYERS",e[e.DFF_SUPERPRIORITY=i(5)]="DFF_SUPERPRIORITY",e[e.DFF_NO_REDRAW_CELL=i(6)]="DFF_NO_REDRAW_CELL",e[e.DFF_ABORT_IF_BLOCKS_MAP=i(7)]="DFF_ABORT_IF_BLOCKS_MAP",e[e.DFF_BLOCKED_BY_ITEMS=i(8)]="DFF_BLOCKED_BY_ITEMS",e[e.DFF_BLOCKED_BY_ACTORS=i(9)]="DFF_BLOCKED_BY_ACTORS",e[e.DFF_ALWAYS_FIRE=i(10)]="DFF_ALWAYS_FIRE",e[e.DFF_NO_MARK_FIRED=i(11)]="DFF_NO_MARK_FIRED",e[e.DFF_PROTECTED=i(12)]="DFF_PROTECTED",e[e.DFF_SPREAD_CIRCLE=i(13)]="DFF_SPREAD_CIRCLE",e[e.DFF_SPREAD_LINE=i(14)]="DFF_SPREAD_LINE",e[e.DFF_NULL_SURFACE=i(15)]="DFF_NULL_SURFACE",e[e.DFF_NULL_LIQUID=i(16)]="DFF_NULL_LIQUID",e[e.DFF_NULL_GAS=i(17)]="DFF_NULL_GAS",e[e.DFF_EVACUATE_CREATURES=i(18)]="DFF_EVACUATE_CREATURES",e[e.DFF_EVACUATE_ITEMS=i(19)]="DFF_EVACUATE_ITEMS",e[e.DFF_BUILD_IN_WALLS=i(20)]="DFF_BUILD_IN_WALLS",e[e.DFF_MUST_TOUCH_WALLS=i(21)]="DFF_MUST_TOUCH_WALLS",e[e.DFF_NO_TOUCH_WALLS=i(22)]="DFF_NO_TOUCH_WALLS",e[e.DFF_ACTIVATE_DORMANT_MONSTER=i(23)]="DFF_ACTIVATE_DORMANT_MONSTER",e[e.DFF_AGGRAVATES_MONSTERS=i(24)]="DFF_AGGRAVATES_MONSTERS",e[e.DFF_RESURRECT_ALLY=i(25)]="DFF_RESURRECT_ALLY",e[e.DFF_EMIT_EVENT=i(26)]="DFF_EMIT_EVENT",e[e.DFF_ONLY_IF_EMPTY=e.DFF_BLOCKED_BY_ITEMS|e.DFF_BLOCKED_BY_ACTORS]="DFF_ONLY_IF_EMPTY",e[e.DFF_NULLIFY_CELL=e.DFF_NULL_SURFACE|e.DFF_NULL_LIQUID|e.DFF_NULL_GAS]="DFF_NULLIFY_CELL"}(r||(r={})),function(e){e[e.T_BRIDGE=i(0)]="T_BRIDGE",e[e.T_AUTO_DESCENT=i(1)]="T_AUTO_DESCENT",e[e.T_LAVA=i(2)]="T_LAVA",e[e.T_DEEP_WATER=i(3)]="T_DEEP_WATER",e[e.T_IS_FLAMMABLE=i(4)]="T_IS_FLAMMABLE",e[e.T_SPONTANEOUSLY_IGNITES=i(5)]="T_SPONTANEOUSLY_IGNITES",e[e.T_IS_FIRE=i(6)]="T_IS_FIRE",e[e.T_EXTINGUISHES_FIRE=i(7)]="T_EXTINGUISHES_FIRE",e[e.T_IS_SECRET=i(8)]="T_IS_SECRET",e[e.T_IS_TRAP=i(9)]="T_IS_TRAP",e[e.T_SACRED=i(10)]="T_SACRED",e[e.T_UP_STAIRS=i(11)]="T_UP_STAIRS",e[e.T_DOWN_STAIRS=i(12)]="T_DOWN_STAIRS",e[e.T_PORTAL=i(13)]="T_PORTAL",e[e.T_IS_DOOR=i(14)]="T_IS_DOOR",e[e.T_ALLOWS_SUBMERGING=i(15)]="T_ALLOWS_SUBMERGING",e[e.T_ENTANGLES=i(16)]="T_ENTANGLES",e[e.T_REFLECTS=i(17)]="T_REFLECTS",e[e.T_STAND_IN_TILE=i(18)]="T_STAND_IN_TILE",e[e.T_CONNECTS_LEVEL=i(19)]="T_CONNECTS_LEVEL",e[e.T_HAS_STAIRS=e.T_UP_STAIRS|e.T_DOWN_STAIRS|e.T_PORTAL]="T_HAS_STAIRS",e[e.T_OBSTRUCTS_SCENT=e.T_AUTO_DESCENT|e.T_LAVA|e.T_DEEP_WATER|e.T_SPONTANEOUSLY_IGNITES|e.T_HAS_STAIRS]="T_OBSTRUCTS_SCENT",e[e.T_PATHING_BLOCKER=e.T_AUTO_DESCENT|e.T_IS_TRAP|e.T_LAVA|e.T_DEEP_WATER|e.T_IS_FIRE|e.T_SPONTANEOUSLY_IGNITES|e.T_ENTANGLES]="T_PATHING_BLOCKER",e[e.T_DIVIDES_LEVEL=e.T_AUTO_DESCENT|e.T_IS_TRAP|e.T_LAVA|e.T_DEEP_WATER]="T_DIVIDES_LEVEL",e[e.T_LAKE_PATHING_BLOCKER=e.T_AUTO_DESCENT|e.T_LAVA|e.T_DEEP_WATER|e.T_SPONTANEOUSLY_IGNITES]="T_LAKE_PATHING_BLOCKER",e[e.T_WAYPOINT_BLOCKER=e.T_AUTO_DESCENT|e.T_IS_TRAP|e.T_LAVA|e.T_DEEP_WATER|e.T_SPONTANEOUSLY_IGNITES]="T_WAYPOINT_BLOCKER",e[e.T_MOVES_ITEMS=e.T_DEEP_WATER|e.T_LAVA]="T_MOVES_ITEMS",e[e.T_CAN_BE_BRIDGED=e.T_AUTO_DESCENT|e.T_LAVA|e.T_DEEP_WATER]="T_CAN_BE_BRIDGED",e[e.T_IS_DEEP_LIQUID=e.T_LAVA|e.T_AUTO_DESCENT|e.T_DEEP_WATER]="T_IS_DEEP_LIQUID"}(a||(a={})),function(e){e[e.TM_IS_WIRED=i(9)]="TM_IS_WIRED",e[e.TM_IS_CIRCUIT_BREAKER=i(10)]="TM_IS_CIRCUIT_BREAKER",e[e.TM_VANISHES_UPON_PROMOTION=i(15)]="TM_VANISHES_UPON_PROMOTION",e[e.TM_EXPLOSIVE_PROMOTE=i(21)]="TM_EXPLOSIVE_PROMOTE",e[e.TM_SWAP_ENCHANTS_ACTIVATION=i(25)]="TM_SWAP_ENCHANTS_ACTIVATION"}(_||(_={})),function(e){e[e.VISIBLE=i(0)]="VISIBLE",e[e.WAS_VISIBLE=i(1)]="WAS_VISIBLE",e[e.CLAIRVOYANT_VISIBLE=i(2)]="CLAIRVOYANT_VISIBLE",e[e.WAS_CLAIRVOYANT_VISIBLE=i(3)]="WAS_CLAIRVOYANT_VISIBLE",e[e.TELEPATHIC_VISIBLE=i(4)]="TELEPATHIC_VISIBLE",e[e.WAS_TELEPATHIC_VISIBLE=i(5)]="WAS_TELEPATHIC_VISIBLE",e[e.ITEM_DETECTED=i(6)]="ITEM_DETECTED",e[e.WAS_ITEM_DETECTED=i(7)]="WAS_ITEM_DETECTED",e[e.MONSTER_DETECTED=i(8)]="MONSTER_DETECTED",e[e.WAS_MONSTER_DETECTED=i(9)]="WAS_MONSTER_DETECTED",e[e.REVEALED=i(10)]="REVEALED",e[e.MAGIC_MAPPED=i(11)]="MAGIC_MAPPED",e[e.IN_FOV=i(12)]="IN_FOV",e[e.WAS_IN_FOV=i(13)]="WAS_IN_FOV",e[e.NEEDS_REDRAW=i(14)]="NEEDS_REDRAW",e[e.CELL_CHANGED=i(15)]="CELL_CHANGED",e[e.HAS_SURFACE=i(16)]="HAS_SURFACE",e[e.HAS_LIQUID=i(17)]="HAS_LIQUID",e[e.HAS_GAS=i(18)]="HAS_GAS",e[e.HAS_PLAYER=i(19)]="HAS_PLAYER",e[e.HAS_ACTOR=i(20)]="HAS_ACTOR",e[e.HAS_DORMANT_MONSTER=i(21)]="HAS_DORMANT_MONSTER",e[e.HAS_ITEM=i(22)]="HAS_ITEM",e[e.IS_IN_PATH=i(23)]="IS_IN_PATH",e[e.IS_CURSOR=i(24)]="IS_CURSOR",e[e.STABLE_MEMORY=i(25)]="STABLE_MEMORY",e[e.LIGHT_CHANGED=i(26)]="LIGHT_CHANGED",e[e.CELL_LIT=i(27)]="CELL_LIT",e[e.IS_IN_SHADOW=i(28)]="IS_IN_SHADOW",e[e.CELL_DARK=i(29)]="CELL_DARK",e[e.COLORS_DANCE=i(30)]="COLORS_DANCE",e[e.PERMANENT_CELL_FLAGS=e.REVEALED|e.MAGIC_MAPPED|e.ITEM_DETECTED|e.HAS_ITEM|e.HAS_DORMANT_MONSTER|e.STABLE_MEMORY]="PERMANENT_CELL_FLAGS",e[e.ANY_KIND_OF_VISIBLE=e.VISIBLE|e.CLAIRVOYANT_VISIBLE|e.TELEPATHIC_VISIBLE]="ANY_KIND_OF_VISIBLE",e[e.HAS_ANY_ACTOR=e.HAS_PLAYER|e.HAS_ACTOR]="HAS_ANY_ACTOR",e[e.IS_WAS_ANY_KIND_OF_VISIBLE=e.VISIBLE|e.WAS_VISIBLE|e.CLAIRVOYANT_VISIBLE|e.WAS_CLAIRVOYANT_VISIBLE|e.TELEPATHIC_VISIBLE|e.WAS_TELEPATHIC_VISIBLE]="IS_WAS_ANY_KIND_OF_VISIBLE",e[e.WAS_ANY_KIND_OF_VISIBLE=e.WAS_VISIBLE|e.WAS_CLAIRVOYANT_VISIBLE|e.WAS_TELEPATHIC_VISIBLE]="WAS_ANY_KIND_OF_VISIBLE",e[e.CELL_DEFAULT=e.VISIBLE|e.IN_FOV|e.NEEDS_REDRAW|e.CELL_CHANGED]="CELL_DEFAULT"}(h||(h={})),function(e){e[e.SEARCHED_FROM_HERE=i(0)]="SEARCHED_FROM_HERE",e[e.PRESSURE_PLATE_DEPRESSED=i(1)]="PRESSURE_PLATE_DEPRESSED",e[e.KNOWN_TO_BE_TRAP_FREE=i(2)]="KNOWN_TO_BE_TRAP_FREE",e[e.CAUGHT_FIRE_THIS_TURN=i(4)]="CAUGHT_FIRE_THIS_TURN",e[e.EVENT_FIRED_THIS_TURN=i(5)]="EVENT_FIRED_THIS_TURN",e[e.EVENT_PROTECTED=i(6)]="EVENT_PROTECTED",e[e.IS_IN_LOOP=i(10)]="IS_IN_LOOP",e[e.IS_CHOKEPOINT=i(11)]="IS_CHOKEPOINT",e[e.IS_GATE_SITE=i(12)]="IS_GATE_SITE",e[e.IS_IN_ROOM_MACHINE=i(13)]="IS_IN_ROOM_MACHINE",e[e.IS_IN_AREA_MACHINE=i(14)]="IS_IN_AREA_MACHINE",e[e.IS_POWERED=i(15)]="IS_POWERED",e[e.IMPREGNABLE=i(20)]="IMPREGNABLE",e[e.DARKENED=i(19)]="DARKENED",e[e.IS_IN_MACHINE=e.IS_IN_ROOM_MACHINE|e.IS_IN_AREA_MACHINE]="IS_IN_MACHINE",e[e.PERMANENT_MECH_FLAGS=e.SEARCHED_FROM_HERE|e.PRESSURE_PLATE_DEPRESSED|e.KNOWN_TO_BE_TRAP_FREE|e.IS_IN_LOOP|e.IS_CHOKEPOINT|e.IS_GATE_SITE|e.IS_IN_MACHINE|e.IMPREGNABLE]="PERMANENT_MECH_FLAGS"}(n||(n={})),function(e){e[e.MAP_CHANGED=i(0)]="MAP_CHANGED",e[e.MAP_STABLE_GLOW_LIGHTS=i(1)]="MAP_STABLE_GLOW_LIGHTS",e[e.MAP_STABLE_LIGHTS=i(2)]="MAP_STABLE_LIGHTS",e[e.MAP_ALWAYS_LIT=i(3)]="MAP_ALWAYS_LIT",e[e.MAP_SAW_WELCOME=i(4)]="MAP_SAW_WELCOME",e[e.MAP_NO_LIQUID=i(5)]="MAP_NO_LIQUID",e[e.MAP_NO_GAS=i(6)]="MAP_NO_GAS",e[e.MAP_CALC_FOV=i(7)]="MAP_CALC_FOV",e[e.MAP_FOV_CHANGED=i(8)]="MAP_FOV_CHANGED",e[e.MAP_DANCES=i(9)]="MAP_DANCES",e[e.MAP_DEFAULT=e.MAP_STABLE_LIGHTS|e.MAP_STABLE_GLOW_LIGHTS]="MAP_DEFAULT"}(c||(c={}));const o=t.config.light={INTENSITY_DARK:20},E=t.color.make();class f{constructor(e,l,i,s=!1){this.fadeTo=0,this.passThroughActors=!1,this.id=null,this.color=t.color.from(e)||null,this.radius=t.range.make(l||1),this.fadeTo=i||0,this.passThroughActors=s}copy(e){this.color=e.color,this.radius.copy(e.radius),this.fadeTo=e.fadeTo,this.passThroughActors=e.passThroughActors}get intensity(){return L(this.color)}paint(e,l,i,r=!1,a=!1){if(!e)return!1;let _,n,c=this.radius.value(),f=Math.ceil(c);E.copy(this.color).bake();const g=!a&&!r&&L(E)>o.INTENSITY_DARK,A=this.fadeTo,I=t.grid.alloc(e.width,e.height,0);e.calcFov(I,l,i,f,this.passThroughActors?0:h.HAS_ANY_ACTOR,s.L_BLOCKS_VISION);let S=!1;if(I.forCircle(l,i,f,((s,r,a)=>{if(!s)return;const o=e.cell(r,a);for(n=Math.floor(100-(100-A)*(t.utils.distanceBetween(l,i,r,a)/c)),_=0;_<3;_++)o.light[_]+=Math.floor(E[_]*n/100);g&&(o.flags.cell&=~h.IS_IN_SHADOW),o.flags.cell&(h.IN_FOV|h.ANY_KIND_OF_VISIBLE)&&(S=!0)})),g){e.cell(l,i).flags.cell&=~h.IS_IN_SHADOW}return t.grid.free(I),S}}function L(e){return Math.max(e[0],e[1],e[2])}function g(...e){if(1==e.length){const l=e[0];if("string"==typeof l){const e=A[l];if(e)return e;const[i,s,r,a]=l.split(/[,|]/).map((e=>e.trim()));return new f(t.color.from(i),t.range.from(s||1),Number.parseInt(r||"0"),!!a&&"false"!==a)}if(Array.isArray(l)){const[e,t,i,s]=l;return new f(e,t,i,s)}if(l&&l.color)return new f(t.color.from(l.color),t.range.from(l.radius),Number.parseInt(l.fadeTo||"0"),l.pass);throw new Error("Unknown Light config - "+l)}{const[t,l,i,s]=e;return new f(t,l,i,s)}}t.make.light=g;const A={};function I(...e){1!=e.length&&t.utils.ERROR("Unknown Light config: "+JSON.stringify(e));const l=e[0];if(l instanceof f)return l;if("string"==typeof l){const e=A[l];if(e)return e}return g(l)}function S(e,...t){let l;return l=1==t.length?g(t[0]):g(t[0],t[1],t[2],t[3]),A[e]=l,l&&(l.id=e),l}function T(e){let t;e.eachCell((e=>{for(t=0;t<3;t++)e.oldLight[t]=e.light[t],e.lightChanged=!1}))}function u(e){let t;const l=e.ambientLight?e.ambientLight:[0,0,0];e.eachCell(((e,i,s)=>{for(t=0;t<3;t++)e.light[t]=l[t];e.flags.cell|=h.IS_IN_SHADOW}))}function O(e){let t;e.eachCell((e=>{for(t=0;t<3;t++)e.glowLight[t]=e.light[t]}))}function C(e){let t;e.eachCell((e=>{for(t=0;t<3;t++)e.light[t]=e.glowLight[t]}))}function R(e){if(!e.anyLightChanged)return!1;T(e),u(e),e.staticLightChanged?(e.eachStaticLight(((t,l,i)=>{t&&t.paint(e,l,i)})),O(e),e.staticLightChanged=!1):C(e),e.eachDynamicLight(((t,l,i)=>{t.paint(e,l,i)})),function(e){e.eachCell(((e,t,l)=>{e.flags.cell&=~(h.CELL_LIT|h.CELL_DARK),e.light.some(((t,l)=>t!==e.oldLight[l]))&&(e.lightChanged=!0),e.isDark()?e.flags.cell|=h.CELL_DARK:e.flags.cell&h.IS_IN_SHADOW||(e.flags.cell|=h.CELL_LIT)}))}(e);const l=t.data.player;if(l){const t=A.PLAYERS_LIGHT;t&&t.radius&&t.paint(e,l.x,l.y,!0,!0)}return e.anyLightChanged=!1,!0}var N={__proto__:null,config:o,Light:f,intensity:L,make:g,lights:A,from:I,install:S,installAll:function(e={}){Object.entries(e).forEach((([e,t])=>{S(e,t)}))},recordOldLights:T,zeroOutLights:u,recordGlowLights:O,restoreGlowLights:C,updateLighting:R,playerInDarkness:function(e,t,l){return e.cell(t.x,t.y).isDark(l)}};class d{constructor(e){this.priority=50,this.layer=0,this.light=null,this.flags={layer:0},this.sprite=t.make.sprite(e.sprite||e),this.light=e.light?g(e.light):null,this.priority=t.utils.first(e.priority,50),this.layer=(e.layer&&"number"!=typeof e.layer?l[e.layer]:e.layer)||0,this.flags.layer=t.flag.from(s,e.layerFlags,e.flags,0)}hasLayerFlag(e){return(this.flags.layer&e)>0}}function D(e){return new d(e)}t.make.layer=D;var y={__proto__:null,get Flags(){return s},get Layer(){return l},Entity:d,make:D};class F extends d{constructor(e){super((()=>{if(!e.Extends)return e;if("string"==typeof e.Extends&&(e.Extends=M[e.Extends],!e.Extends))throw new Error("Unknown tile base - "+e.Extends);const l=e.Extends;return e.ch=t.utils.first(e.ch,l.sprite.ch,-1),e.fg=t.utils.first(e.fg,l.sprite.fg,-1),e.bg=t.utils.first(e.bg,l.sprite.bg,-1),e.layer=t.utils.first(e.layer,l.layer),e.priority=t.utils.first(e.priority,l.priority),e.opacity=t.utils.first(e.opacity,l.sprite.opacity),e.light=t.utils.first(e.light,l.light),e})()),this.flags={layer:0,tile:0,tileMech:0},this.effects={},this.flavor=null,this.desc=null,this.article=null,this.dissipate=2e3,this.defaultGround=null,this.index=-1;let l=e.Extends;l&&(t.utils.assignOmitting(["sprite","depth","priority","effects","flags","light"],this,l),l.effects&&Object.assign(this.effects,l.effects),Object.assign(this.flags,l.flags)),t.utils.assignOmitting(["Extends","extends","flags","layerFlags","sprite","effects","ch","fg","bg","opacity","light","layer","priority","flags","ground","light"],this,e),this.name=e.name||(l?l.name:e.id),this.id=e.id,e.ground&&(this.defaultGround=e.ground),this.flags.tile=t.flag.from(a,this.flags.tile,e.flags),this.flags.layer=t.flag.from(s,this.flags.layer,e.layerFlags||e.flags),this.flags.tileMech=t.flag.from(_,this.flags.tileMech,e.flags),e.effects&&Object.entries(e.effects).forEach((([e,l])=>{if(l){if("string"==typeof l){if(t.effect.effects[l])return void(this.effects[e]=t.effect.effects[l]);l={tile:l}}const i=t.effect.make(l);this.effects[e]=i}else delete this.effects[e]}))}hasAllFlags(e){return(this.flags.tile&e)===e}hasAllLayerFlags(e){return(this.flags.layer&e)===e}hasAllMechFlags(e){return(this.flags.tileMech&e)===e}blocksPathing(){return this.flags.layer&s.L_BLOCKS_MOVE||this.flags.tile&a.T_PATHING_BLOCKER}hasEffect(e){return!!this.effects[e]}getName(e){let l={};if(!0===e||!1===e||"string"==typeof e?l.article=e:e&&(l=e),!l.article&&!l.color)return this.name;let i=this.name;if(l.color){let e=l.color;!0===l.color&&(e=this.sprite.fg||"white"),"string"!=typeof e&&(e=t.color.from(e).toString()),i=`Ω${e}Ω${this.name}∆`}if(l.article){i=("string"==typeof l.article?l.article:this.article||"a")+" "+i}return i}getDescription(e={}){return this.getName(e)}}function m(e){return new F(e)}t.make.tile=m;const M={},p=[];function P(...e){let l=e[0],i=e[1],s=e[2];1==arguments.length?(s=e[0],i=s.Extends||null,l=s.id):2==arguments.length&&(s=i),"string"==typeof i&&(s.Extends=M[i]||t.utils.ERROR("Unknown base tile: "+i)),s.id=l;const r=m(s);return M[l]=r,r.index=p.length,p.push(r),r}var V={__proto__:null,get Flags(){return a},get MechFlags(){return _},Tile:F,make:m,tiles:M,allTiles:p,install:P,installAll:function(e){Object.entries(e).forEach((([e,t])=>{t.id=e,P(e,t)}))}};t.color.install("cursorColor",25,100,150),t.config.cursorPathIntensity=50;class B{constructor(){this.mixer=new t.sprite.Mixer,this.item=null,this.itemQuantity=0,this.actor=null,this.tile=null,this.flags={cell:0,cellMech:0,layer:0,tile:0,tileMech:0}}clear(){this.mixer.nullify(),this.item=null,this.itemQuantity=0,this.actor=null,this.tile=null,this.flags.cell=0,this.flags.cellMech=0,this.flags.layer=0,this.flags.tile=0,this.flags.tileMech=0}copy(e){const t=this.mixer;Object.assign(this,e),this.mixer=t,this.mixer.copy(e.mixer)}}class U{constructor(){this._tiles=[],this.layers=null,this._actor=null,this._item=null,this.data={},this.flags={cell:h.CELL_DEFAULT,cellMech:0},this.gasVolume=0,this.liquidVolume=0,this.machineNumber=0,this.memory=new B,this.light=[100,100,100],this.oldLight=[100,100,100],this.glowLight=[100,100,100],this.chokeCount=0}copy(e){t.utils.copyObject(this,e)}nullify(){for(let e=0;e<this._tiles.length;++e)this._tiles[e]=null;this.layers=null,this._actor=null,this._item=null,this.data={},this.flags.cell=h.CELL_DEFAULT,this.flags.cellMech=0,this.gasVolume=0,this.liquidVolume=0,this.machineNumber=0,this.memory.clear(),this.light=[100,100,100],this.oldLight=[100,100,100],this.glowLight=[100,100,100],this.chokeCount=0}clear(e="FLOOR"){this.nullify(),"string"==typeof e&&(e=M[e]),e&&(this._tiles[0]=e)}clearLayers(e,t="FLOOR"){return[l.GAS,l.LIQUID,l.SURFACE,l.GROUND].reduce(((l,i)=>i&e&&this.clearLayer(i,t)||l),!1)}get ground(){var e;return(null===(e=this._tiles[l.GROUND])||void 0===e?void 0:e.id)||null}get liquid(){var e;return(null===(e=this._tiles[l.LIQUID])||void 0===e?void 0:e.id)||null}get surface(){var e;return(null===(e=this._tiles[l.SURFACE])||void 0===e?void 0:e.id)||null}get gas(){var e;return(null===(e=this._tiles[l.GAS])||void 0===e?void 0:e.id)||null}get groundTile(){return this._tiles[l.GROUND]||M.NULL}get liquidTile(){return this._tiles[l.LIQUID]||M.NULL}get surfaceTile(){return this._tiles[l.SURFACE]||M.NULL}get gasTile(){return this._tiles[l.GAS]||M.NULL}dump(){if(this.actor)return this.actor.sprite.ch;if(this.item)return this.item.sprite.ch;for(let e=this._tiles.length-1;e>=0;--e){if(!this._tiles[e])continue;const t=this._tiles[e]||M.NULL;if(t.sprite.ch)return t.sprite.ch}return M.NULL.sprite.ch}get changed(){return(this.flags.cell&h.CELL_CHANGED)>0}set changed(e){e?this.flags.cell|=h.CELL_CHANGED:this.flags.cell&=~h.CELL_CHANGED}isVisible(){return!!(this.flags.cell&h.VISIBLE)}isAnyKindOfVisible(){return!!(this.flags.cell&h.ANY_KIND_OF_VISIBLE)}isOrWasAnyKindOfVisible(){return this.flags.cell&h.IS_WAS_ANY_KIND_OF_VISIBLE}isRevealed(e=!1){const t=h.REVEALED|h.VISIBLE|(e?h.MAGIC_MAPPED:0);return(this.flags.cell&t)>0}listInSidebar(){return this.hasLayerFlag(s.L_LIST_IN_SIDEBAR,!0)}get needsRedraw(){return(this.flags.cell&h.NEEDS_REDRAW)>0}set needsRedraw(e){e?this.flags.cell|=h.NEEDS_REDRAW:this.flags.cell&=~h.NEEDS_REDRAW}hasVisibleLight(){return L(this.light)>t.config.light.INTENSITY_DARK}isDark(e){const l=e?L(e):t.config.light.INTENSITY_DARK;return L(this.light)<=l}get lightChanged(){return(this.flags.cell&h.LIGHT_CHANGED)>0}set lightChanged(e){e?this.flags.cell|=h.LIGHT_CHANGED|h.NEEDS_REDRAW:this.flags.cell&=~h.LIGHT_CHANGED}tile(e=l.GROUND){return this._tiles[e]||M.NULL}tileId(e=l.GROUND){var t;return(null===(t=this._tiles[e])||void 0===t?void 0:t.id)||null}volume(e=l.GAS){return e===l.GAS?this.gasVolume:e===l.LIQUID?this.liquidVolume:0}setVolume(e,t=0){e===l.GAS?this.gasVolume=t:e===l.LIQUID&&(this.liquidVolume=t)}*tiles(){for(let e of this._tiles)e&&(yield e)}layerFlags(e=!1){if(e&&!this.isVisible())return this.memory.flags.layer;let t=0;for(let e of this.tiles())t|=e.flags.layer;return t}tileFlags(e=!1){if(e&&!this.isVisible())return this.memory.flags.tile;let t=0;for(let e of this.tiles())t|=e.flags.tile;return t}tileMechFlags(e=!1){if(e&&!this.isVisible())return this.memory.flags.tileMech;let t=0;for(let e of this.tiles())t|=e.flags.tileMech;return t}hasLayerFlag(e,t=!1){if(e&this.layerFlags(t))return!0;let l=this.actor,i=this.item;return t&&(l=this.memory.actor,i=this.memory.item),!!(l&&l.layerFlags()&e)||!!(i&&i.layerFlags()&e)}hasAllLayerFlags(e,t=!1){let l=this.layerFlags(t),i=this.actor,s=this.item;return t&&(i=this.memory.actor,s=this.memory.item),i&&(l|=i.layerFlags()),s&&(l|=s.layerFlags()),(e&l)===e}hasTileFlag(e,t=!1){return!!(e&this.tileFlags(t))}hasAllTileFlags(e,t=!1){return(e&this.tileFlags(t))===e}hasTileMechFlag(e,t=!1){return!!(e&this.tileMechFlags(t))}hasAllTileMechFlags(e,t=!1){return(e&this.tileMechFlags(t))===e}setFlags(e=0,t=0){this.flags.cell|=e,this.flags.cellMech|=t}clearFlags(e=0,t=0){this.flags.cell&=~e,this.flags.cellMech&=~t}hasFlag(e,t=!1){return(e&(t&&!this.isAnyKindOfVisible()?this.memory.flags.cell:this.flags.cell))>0}hasMechFlag(e,t=!1){return(e&(t&&!this.isAnyKindOfVisible()?this.memory.flags.cellMech:this.flags.cellMech))>0}hasTile(e){let t;return t="string"==typeof e?e:e.id,this._tiles.some((e=>e&&e.id===t))}topmostTile(e=!1){let t=M.NULL,i=-1e4;for(let s=l.GROUND;s<=(e?l.LIQUID:l.GAS);++s){const e=this._tiles[s];e&&(e.priority>i&&(t=e,i=e.priority))}return t}tileWithLayerFlag(e){for(let t of this.tiles())if(t.flags.layer&e)return t;return null}tileWithFlag(e){for(let t of this.tiles())if(t.flags.tile&e)return t;return null}tileWithMechFlag(e){for(let t of this.tiles())if(t.flags.tileMech&e)return t;return null}tileDesc(){return this.topmostTile().desc}tileFlavor(){return this.topmostTile().flavor}getName(e={}){return this.topmostTile().getName(e)}isNull(){return null===this.ground}isClear(){return null===this.liquid&&null===this.gas&&null===this.surface}isEmpty(){return!(this._actor||this._item)}isMoveableNow(e=!1){return 0==((e&&!this.isAnyKindOfVisible()?this.memory.flags.layer:this.layerFlags(!1))&s.L_BLOCKS_MOVE)}isWalkableNow(e=!1){const t=e&&!this.isAnyKindOfVisible();if((t?this.memory.flags.layer:this.layerFlags(!1))&s.L_BLOCKS_MOVE)return!1;const l=t?this.memory.flags.tile:this.tileFlags();return!(l&a.T_IS_DEEP_LIQUID)||(l&a.T_BRIDGE)>0}canBeWalked(e=!1){if(this.isWalkableNow(e))return!0;return((e&&!this.isAnyKindOfVisible()?this.memory.flags.layer:this.layerFlags(!1))&s.L_SECRETLY_PASSABLE)>0}isWall(e=!1){return((e&&!this.isAnyKindOfVisible()?this.memory.flags.layer:this.layerFlags())&s.L_IS_WALL)===s.L_IS_WALL}isObstruction(e=!1){return!!((e&&!this.isAnyKindOfVisible()?this.memory.flags.layer:this.layerFlags())&s.L_BLOCKS_DIAGONAL)}isDoorway(e=!1){let t=e&&!this.isAnyKindOfVisible()?this.memory.flags.layer:this.layerFlags();return(t&s.L_BLOCKS_VISION)>0&&0==(t&s.L_BLOCKS_MOVE)}isSecretDoorway(e=!1){if(e)return!1;return(this.layerFlags(e)&s.L_SECRETLY_PASSABLE)>0}blocksPathing(e=!1){const t=e&&!this.isAnyKindOfVisible();if(!this.isWalkableNow(e))return!0;return!!((t?this.memory.flags.tile:this.tileFlags())&a.T_PATHING_BLOCKER)}blocksVision(){return!!(this.layerFlags()&s.L_BLOCKS_VISION)}blocksEffects(){return!!(this.layerFlags()&s.L_BLOCKS_EFFECTS)}isLiquid(e=!1){return!!((e&&!this.isAnyKindOfVisible()?this.memory.flags.tile:this.tileFlags())&a.T_IS_DEEP_LIQUID)}hasGas(e=!1){return!!((e&&!this.isAnyKindOfVisible()?this.memory.flags.cell:this.flags.cell)&h.HAS_GAS)}hasKey(){return!1}markRevealed(){return this.flags.cell&=~h.STABLE_MEMORY,!(this.flags.cell&h.REVEALED)&&(this.flags.cell|=h.REVEALED,!this.isWall())}obstructsLayer(e){return e===l.SURFACE&&this.hasLayerFlag(s.L_BLOCKS_SURFACE)}setTile(e=null,i=0,r){let _;if(r=r||t.data.map,null===e?(_=M.NULL,e=null):"string"==typeof e?_=M[e]:e instanceof F&&(_=e,e=_.id),!_)return t.utils.ERROR("Unknown tile - "+e);_.layer>0&&!this._tiles[0]&&this.setTile(_.defaultGround||M.FLOOR,0,r);const o=this._tiles[_.layer]||M.NULL,E=o===M.NULL?null:o.id;o.blocksPathing()!=_.blocksPathing()&&(t.data.staleLoopMap=!0),_.flags.tile&a.T_IS_FIRE&&!(o.flags.tile&a.T_IS_FIRE)&&(this.flags.cellMech|=n.CAUGHT_FIRE_THIS_TURN);const f=_.flags.layer&s.L_BLOCKS_VISION,L=o.flags.layer&s.L_BLOCKS_VISION;r&&this.isAnyKindOfVisible()&&f!=L&&r.setFlag(c.MAP_FOV_CHANGED),null!==E&&this.removeLayer(o),this._tiles[_.layer]=null===e?null:_,null!==e&&this.addLayer(_);let g=0;return _.layer==l.LIQUID?(g=h.HAS_LIQUID,this.liquidVolume=i+(e==E?this.liquidVolume:0),r&&r.clearFlag(c.MAP_NO_LIQUID)):_.layer==l.GAS?(g=h.HAS_GAS,this.gasVolume=i+(e==E?this.gasVolume:0),r&&r.clearFlag(c.MAP_NO_GAS)):_.layer===l.SURFACE&&(g=h.HAS_SURFACE),e?this.flags.cell|=g:this.flags.cell&=~g,this.flags.cell|=h.CELL_CHANGED|h.NEEDS_REDRAW,r&&o.light!==_.light&&r.clearFlag(c.MAP_STABLE_GLOW_LIGHTS|c.MAP_STABLE_LIGHTS),!0}clearLayer(e,t="FLOOR"){"string"==typeof e&&(e=l[e]);const i=this._tiles[e];let s=!1;e===l.GROUND&&"string"==typeof t&&(t=M[t]||M.FLOOR),i&&(this.flags.cell|=h.CELL_CHANGED,this.removeLayer(i),s=i&&(e!==l.GROUND||i!==t)),this._tiles[e]=null;let r=0;return e==l.LIQUID?(r=h.HAS_LIQUID,this.liquidVolume=0):e==l.GAS?(r=h.HAS_GAS,this.gasVolume=0):e==l.SURFACE?r=h.HAS_SURFACE:e==l.GROUND&&(this._tiles[l.GROUND]=t),this.flags.cell&=~r,s}clearLayersExcept(e=l.GROUND,t){const i=t?M[t]:this.groundTile;for(let t=0;t<this._tiles.length;t++)t!=e&&t!=l.GAS&&(t===l.GROUND?i!==this.groundTile&&this.setTile(i):this.clearLayer(t));this.flags.cell|=h.CELL_CHANGED}clearLayersWithFlags(e,t=0){for(let l=0;l<this._tiles.length;++l){const i=this._tiles[l];i&&(e&&t?i.flags.tile&e&&i.flags.tileMech&t&&this.clearLayer(l):e?i.flags.tile&e&&this.clearLayer(l):t&&i.flags.tileMech&t&&this.clearLayer(l))}}async activate(e,l,i,s,r={}){r.cell=this;let a=!1;if(void 0!==r.layer){const _=this.tile(r.layer);if(_&&_.effects){const h=_.effects[e];let n;n="string"==typeof h?t.effect.effects[h]:h,n&&(r.tile=_,a=await t.effect.fire(n,l,i,s,r))}}else for(let _ of this.tiles()){if(!_.effects)continue;const h=_.effects[e];let n;if(n="string"==typeof h?t.effect.effects[h]:h,n&&(r.tile=_,a=await t.effect.fire(n,l,i,s,r)||a,a))break}return a}hasEffect(e){for(let t of this.tiles())if(t.hasEffect(e))return!0;return!1}get item(){return this._item}set item(e){this.item&&this.removeLayer(this.item),this._item=e,e?(this.flags.cell|=h.HAS_ITEM,this.addLayer(e,l.ITEM)):this.flags.cell&=~h.HAS_ITEM}get actor(){return this._actor}set actor(e){this.actor&&this.removeLayer(this.actor),this._actor=e,e?(this.flags.cell|=e.isPlayer()?h.HAS_PLAYER:h.HAS_ACTOR,this.addLayer(e,l.ACTOR)):this.flags.cell&=~h.HAS_ANY_ACTOR}addLayer(e,t){var i;if(!e)return;this.flags.cell|=h.CELL_CHANGED;let s=this.layers;if(t=null!==(i=null!=t?t:e.layer)&&void 0!==i?i:l.GROUND,!s||s.layer>t||s.layer==t&&s.obj.priority>e.priority)return void(this.layers={obj:e,layer:t,next:s});for(;s.next&&(s.next.layer<t||s.next.layer==t&&s.next.obj.priority<=e.priority);)s=s.next;const r={layer:t,obj:e,next:s.next};s.next=r}removeLayer(e){if(!e)return!1;if(!this.layers)return!1;if(this.flags.cell|=h.CELL_CHANGED,this.layers&&this.layers.obj===e)return this.layers=this.layers.next,!0;let t=this.layers,l=this.layers.next;for(;l;){if(l.obj===e)return t.next=l.next,!0;t=l,l=l.next}return!1}storeMemory(){const e=this.memory;e.flags.tile=this.tileFlags(),e.flags.tileMech=this.tileMechFlags(),e.flags.layer=this.layerFlags(),e.flags.cell=this.flags.cell,e.flags.cellMech=this.flags.cellMech,e.tile=this.topmostTile(),this.item&&this.isRevealed()?(e.item=this.item,e.itemQuantity=this.item.quantity):(e.item=null,e.itemQuantity=0),e.actor=null,this.actor&&this.isAnyKindOfVisible()&&(e.actor=this.actor),H(this,e.mixer)}}function G(e){const t=new U;return e&&t.setTile(e),t}function H(e,i){const r=e.memory.mixer;r.blackOut();let a=e.layerFlags()&s.L_VISUALLY_DISTINCT,_=e.layers;for(;_;){const i=_.obj;let s=i.sprite.opacity||100;_.layer==l.LIQUID?s=t.utils.clamp(34*e.liquidVolume,20,100):_.layer==l.GAS&&(s=t.utils.clamp(34*e.gasVolume,20,100)),(e.isAnyKindOfVisible()||_.layer<l.ACTOR)&&r.drawSprite(i.sprite,s),_=_.next}return r.fg.multiply(e.light),r.bg.multiply(e.light),r.bake(!e.isAnyKindOfVisible()),a&&t.color.separate(r.fg,r.bg),r.dances?e.flags.cell|=h.COLORS_DANCE:e.flags.cell&=~h.COLORS_DANCE,i.drawSprite(r),!0}t.make.cell=G;var b={__proto__:null,get Flags(){return h},get MechFlags(){return n},CellMemory:B,Cell:U,make:G,getAppearance:H};function K(e){e.flags.cell&=~(h.WAS_ANY_KIND_OF_VISIBLE|h.IN_FOV),e.flags.cell&h.VISIBLE&&(e.flags.cell&=~h.VISIBLE,e.flags.cell|=h.WAS_VISIBLE),e.flags.cell&h.CLAIRVOYANT_VISIBLE&&(e.flags.cell&=~h.CLAIRVOYANT_VISIBLE,e.flags.cell|=h.WAS_CLAIRVOYANT_VISIBLE),e.flags.cell&h.TELEPATHIC_VISIBLE&&(e.flags.cell&=~h.TELEPATHIC_VISIBLE,e.flags.cell|=h.WAS_TELEPATHIC_VISIBLE)}function w(e,l,i,r){e.flags.cell&h.IN_FOV&&r.hasVisibleLight(l,i)&&!(e.flags.cellMech&n.DARKENED)&&(e.flags.cell|=h.VISIBLE),function(e,l,i,r){const a=e.flags.cell&h.VISIBLE,_=e.flags.cell&h.WAS_VISIBLE;if(a&&_)e.lightChanged&&r.redrawCell(e);else if(a&&!_){if(!(e.flags.cell&h.REVEALED)&&t.data.automationActive){if(e.item){const l=e.item;l.hasLayerFlag(s.L_INTERRUPT_WHEN_SEEN)&&t.message.add("§you§ §see§ ΩitemMessageColorΩ§item§∆.",{item:l,actor:t.data.player})}if(!(e.flags.cell&h.MAGIC_MAPPED)&&e.hasLayerFlag(s.L_INTERRUPT_WHEN_SEEN)){const l=e.tileWithLayerFlag(s.L_INTERRUPT_WHEN_SEEN);l&&t.message.add("§you§ §see§ ΩbackgroundMessageColorΩ§item§∆.",{actor:t.data.player,item:l.name})}}r.markRevealed(l,i),r.redrawCell(e)}else!a&&_&&(e.storeMemory(),r.redrawCell(e));return a}(e,l,i,r)||function(e,t,l,i){const s=e.flags.cell&h.CLAIRVOYANT_VISIBLE,r=e.flags.cell&h.WAS_CLAIRVOYANT_VISIBLE;return s&&r?e.lightChanged&&i.redrawCell(e):!s&&r?(e.storeMemory(),i.redrawCell(e)):!r&&s&&(e.flags.cell&=~h.STABLE_MEMORY,i.redrawCell(e)),s}(e,0,0,r)||function(e,l,i,s){const r=e.flags.cell&h.TELEPATHIC_VISIBLE,_=e.flags.cell&h.WAS_TELEPATHIC_VISIBLE;return r&&_?e.lightChanged&&s.redrawCell(e):!r&&_?(e.storeMemory(),s.redrawCell(e)):!_&&r&&(e.flags.cell&h.REVEALED||e.hasTileFlag(a.T_PATHING_BLOCKER)||t.data.xpxpThisTurn++,e.flags.cell&=~h.STABLE_MEMORY,s.redrawCell(e)),r}(e,0,0,r)||function(e,t,l,i){const s=e.flags.cell&h.MONSTER_DETECTED,r=e.flags.cell&h.WAS_MONSTER_DETECTED;s&&r?e.lightChanged&&i.redrawCell(e):(!s&&r||!r&&s)&&(e.flags.cell&=~h.STABLE_MEMORY,i.redrawCell(e),e.storeMemory())}(e,0,0,r)}function Y(e){e.flags.map&c.MAP_CALC_FOV?e.clearFlags(0,h.IS_WAS_ANY_KIND_OF_VISIBLE):e.setFlags(0,h.REVEALED|h.VISIBLE)}var W={__proto__:null,initMap:Y,update:function(e,l,i,s){if(!(e.flags.map&c.MAP_CALC_FOV&&e.fov))return!1;if(l==e.fov.x&&i==e.fov.y&&!(e.flags.map&c.MAP_FOV_CHANGED))return!1;e.flags.map&=~c.MAP_FOV_CHANGED,e.fov.x=l,e.fov.y=i,e.forEach(K);const r=t.grid.alloc(e.width,e.height,0);return e.calcFov(r,l,i,s),r.forEach(((t,l,i)=>{t&&e.setCellFlags(l,i,h.IN_FOV)})),t.grid.free(r),e.setCellFlags(l,i,h.IN_FOV|h.VISIBLE),e.forEach(w),!0}};const v=t.effect.Flags;async function k(e,i){const r=t.grid.alloc(e.width,e.height);e.forEach(((l,a,_)=>{l.clearFlags(0,n.EVENT_FIRED_THIS_TURN|n.EVENT_PROTECTED);for(let h of l.tiles()){const c=h.effects[i];if(!c)continue;const o=t.effect.from(c);if(!o)continue;let E=0;o.chance<0?(E=0,e.eachNeighbor(a,_,((e,t,i)=>{e.hasLayerFlag(s.L_BLOCKS_EFFECTS)||e.tileId(h.layer)==l.tileId(h.layer)||e.flags.cellMech&n.CAUGHT_FIRE_THIS_TURN||(E+=-1*o.chance)}),!0)):E=o.chance||1e4,l.flags.cellMech&n.CAUGHT_FIRE_THIS_TURN||!t.random.chance(E,1e4)||(r[a][_]|=t.flag.fl(h.layer))}})),await r.forEachAsync((async(s,r,a)=>{if(!s)return;const _=e.cell(r,a);if(!(_.flags.cellMech&n.EVENT_FIRED_THIS_TURN))for(let h=0;h<=l.GAS;++h)s&t.flag.fl(h)&&await _.activate(i,e,r,a,{force:!0,layer:h})})),t.grid.free(r)}function x(e,t,l,i,s){const r=t;if(!r.hasXY(l,i))return!1;const a=r.cell(l,i);if(a.flags.cellMech&n.EVENT_PROTECTED)return!1;if(a.blocksEffects()&&!e.tile.matchTile&&!s)return!1;if(e.flags&v.E_BUILD_IN_WALLS){if(!a.isWall())return!1}else if(e.flags&v.E_MUST_TOUCH_WALLS){let e=!1;if(r.eachNeighbor(l,i,(t=>{t.isWall()&&(e=!0)}),!0),!e)return!1}else if(e.flags&v.E_NO_TOUCH_WALLS){let e=!0;if(a.isWall())return!1;if(r.eachNeighbor(l,i,(t=>{t.isWall()&&(e=!1)}),!0),!e)return!1}return!(e.tile.matchTile&&!s&&!a.hasTile(e.tile.matchTile))}t.effect.installType("tile",new class{make(e,l){var i,s,r,a,_,h,n;if(!e.tile)return!0;let c=e.tile;if("string"==typeof c){const e=c.split(/[,|]/).map((e=>e.trim()));c={tile:e[0],grow:Number.parseInt(e[1]||"0"),decrement:Number.parseInt(e[2]||"0")}}const o={grow:null!==(s=null!==(i=c.grow)&&void 0!==i?i:c.spread)&&void 0!==s?s:0,decrement:null!==(r=c.decrement)&&void 0!==r?r:0,flags:t.flag.from(t.effect.Flags,c.flags),volume:null!==(a=c.volume)&&void 0!==a?a:0,next:null!==(_=c.next)&&void 0!==_?_:null},E=null!==(h=c.tile)&&void 0!==h?h:c.id;if("string"!=typeof E)throw new Error("Invalid tile spawn config: "+E);if(o.tile=E,!o.tile)throw new Error("Must have tile.");const f=null!==(n=c.matchTile)&&void 0!==n?n:c.match;if("string"==typeof f)o.matchTile=f;else if(f)throw new Error("Invalid tile spawn match tile: "+c.matchTile);return l.tile=o,!0}async fire(e,i,s,r,a){if(!e.tile)return!1;const _=e.tile.tile,h=M[_]||null;if(!h)throw new Error("Failed to find tile for effect: "+_);const c=!!(e.flags&v.E_ABORT_IF_BLOCKS_MAP),o=!(!c||e.flags&v.E_PERMIT_BLOCKING||!(h.blocksPathing()||e.flags&v.E_TREAT_AS_BLOCKING));let E=!1;const f=i;if(E=function(e,l,i,s,r){let a,_,h,n,c,o,E;const f=e.tile;let L=f.grow||0,g=f.decrement||0;const A=r.grid;if(A.fill(0),!x(e,l,i,s,!0))return!1;A[i][s]=n=1;let I=1;if(L)for(E=!0,L>=100&&(g=g||100),g<=0&&(g=L);E&&L>0;){for(E=!1,n++,a=0;a<l.width;a++)for(_=0;_<l.height;_++)if(A[a][_]==n-1)for(h=0;h<4;h++)c=a+t.utils.DIRS[h][0],o=_+t.utils.DIRS[h][1],A.hasXY(c,o)&&!A[c][o]&&t.random.chance(L)&&x(e,l,c,o,!1)&&(A[c][o]=n,E=!0,++I);L-=g}return I>0}(e,f,s,r,a),!E)return!1;if(c&&o&&f.gridDisruptsWalkability(e.grid))return!1;e.flags&v.E_EVACUATE_CREATURES&&function(e,t){let l,i,s=!1;for(l=0;l<e.width;l++)for(i=0;i<e.height;i++){if(!t[l][i])continue;const r=e.cell(l,i);if(!r.actor)continue;const a=r.actor,_=e.matchingLocNear(l,i,(e=>!a.forbidsCell(e)),{hallways:!0,blockingMap:t});_&&_[0]>=0&&_[1]>=0&&(e.moveActor(_[0],_[1],a),s=!0)}return s}(f,a.grid)&&(E=!0),e.flags&v.E_EVACUATE_ITEMS&&function(e,t){let l=!1;return t.forEach(((i,s,r)=>{if(!i)return;const a=e.cell(s,r);if(!a.item)return;const _=a.item,h=e.matchingLocNear(s,r,(e=>!_.forbidsCell(e)),{hallways:!0,blockingMap:t});h&&h[0]>=0&&h[1]>=0&&(e.removeItem(_),e.addItem(h[0],h[1],_),l=!0)})),l}(f,a.grid)&&(E=!0),e.flags&v.E_CLEAR_CELL&&function(e,t,i=0){let s=!1;const r=(i&v.E_CLEAR_CELL)===v.E_CLEAR_CELL;return t.forEach(((t,a,_)=>{if(!t)return;const h=e.cell(a,_);r?h.clear():(i&v.E_CLEAR_GAS&&h.clearLayer(l.GAS),i&v.E_CLEAR_LIQUID&&h.clearLayer(l.LIQUID),i&v.E_CLEAR_SURFACE&&h.clearLayer(l.SURFACE),i&v.E_CLEAR_GROUND&&h.clearLayer(l.GROUND)),s=!0})),s}(f,a.grid,e.flags)&&(E=!0);return function(e,t,i,s,r=0){let a,_,h;h=!1;const c=e&v.E_BLOCKED_BY_OTHER_LAYERS,o=e&v.E_SUPERPRIORITY;for(r=r||0,a=0;a<t.width;a++)for(_=0;_<t.height;_++){if(!t[a][_])continue;t[a][_]=0;const E=i.cell(a,_);E.tile(s.layer)===s?s.layer==l.GAS?(t[a][_]=1,E.gasVolume+=r):s.layer==l.LIQUID&&(t[a][_]=1,E.liquidVolume+=r):!(o||E.tile(s.layer).priority<s.priority)||E.obstructsLayer(s.layer)||E.item&&e&v.E_BLOCKED_BY_ITEMS||E.actor&&e&v.E_BLOCKED_BY_ACTORS||c&&!(E.topmostTile().priority<s.priority)||i.setTile(a,_,s,r)&&(t[a][_]=1,E.flags.cellMech|=n.EVENT_FIRED_THIS_TURN,e&v.E_PROTECTED&&(E.flags.cellMech|=n.EVENT_PROTECTED),h=!0)}h&&(i.changed=!0);return h}(e.flags,a.grid,f,h,e.tile.volume)&&(E=!0),E}});function Q(e,l){const i=t.grid.alloc(e.width,e.height),r=t.grid.alloc(e.width,e.height);for(let t=0;t<e.width;t++)for(let l=0;l<e.height;l++){const r=e.cell(t,l);!r.hasTileFlag(a.T_PATHING_BLOCKER)&&!r.hasLayerFlag(s.L_BLOCKS_MOVE)||r.hasLayerFlag(s.L_SECRETLY_PASSABLE)?i[t][l]=1:i[t][l]=0}let _;for(let l=1;l<i.width-1;l++)for(let s=1;s<i.height-1;s++)if(e.cells[l][s].flags.cellMech&=~n.IS_CHOKEPOINT,i[l][s]&&!(e.cells[l][s].flags.cellMech&n.IS_IN_LOOP)){_=0;for(let r=0;r<8;r++){const a=l+t.utils.CLOCK_DIRS[(r+7)%8][0],h=s+t.utils.CLOCK_DIRS[(r+7)%8][1],c=l+t.utils.CLOCK_DIRS[r][0],o=s+t.utils.CLOCK_DIRS[r][1];if((e.hasXY(c,o)&&i[c][o])!=(e.hasXY(a,h)&&i[a][h])&&++_>2){(i[l-1][s]||i[l+1][s])&&(i[l][s-1]||i[l][s+1])||(e.cells[l][s].flags.cellMech|=n.IS_CHOKEPOINT);break}}}if(l){for(let t=0;t<e.width;t++)for(let l=0;l<e.height;l++)e.cells[t][l].chokeCount=3e4,e.cells[t][l].flags.cellMech&n.IS_IN_ROOM_MACHINE&&(i[t][l]=0);for(let l=0;l<e.width;l++)for(let s=0;s<e.height;s++){const a=e.cells[l][s];if(i[l][s]&&a.flags.cellMech&n.IS_CHOKEPOINT)for(let _=0;_<4;_++){const h=l+t.utils.DIRS[_][0],c=s+t.utils.DIRS[_][1];if(e.hasXY(h,c)&&i[h][c]&&!(e.cells[h][c].flags.cellMech&n.IS_CHOKEPOINT)){r.fill(0),i[l][s]=0;let t=X(e,r,i,h,c);if(i[l][s]=1,t>=4){for(let l=0;l<r.width;l++)for(let i=0;i<r.height;i++)r[l][i]&&t<e.cells[l][i].chokeCount&&(e.cells[l][i].chokeCount=t,e.cells[l][i].flags.cellMech&=~n.IS_GATE_SITE);t<a.chokeCount&&(a.chokeCount=t,a.flags.cellMech|=n.IS_GATE_SITE)}}}}}t.grid.free(i),t.grid.free(r)}function X(e,l,i,s,r){let a=2==i[s][r]?5e3:1;e.cells[s][r].flags.cellMech&n.IS_IN_AREA_MACHINE&&(a=1e4),l[s][r]=1;for(let _=0;_<4;_++){const h=s+t.utils.DIRS[_][0],n=r+t.utils.DIRS[_][1];e.hasXY(h,n)&&i[h][n]&&!l[h][n]&&(a+=X(e,l,i,h,n))}return Math.min(a,1e4)}function q(e){e.forEach(j),e.forEach(z),J(e)}function j(e,t,l,i){!e.hasTileFlag(a.T_PATHING_BLOCKER)&&!e.hasLayerFlag(s.L_BLOCKS_MOVE)||e.hasLayerFlag(s.L_SECRETLY_PASSABLE)?e.flags.cellMech|=n.IS_IN_LOOP:e.flags.cellMech&=~n.IS_IN_LOOP}function z(e,l,i,s){let r,a,_,h,c,o,E,f;if(!(e&&e.flags.cellMech&n.IS_IN_LOOP))return!1;for(c=0;c<8;c++){if(a=l+t.utils.CLOCK_DIRS[c][0],_=i+t.utils.CLOCK_DIRS[c][1],!s.hasXY(a,_))continue;const e=s.get(a,_);if(!(e&&e.flags.cellMech&n.IS_IN_LOOP))break}if(8==c)return!1;for(o=E=f=0,r=!1,h=c;h<c+8;h++){if(a=l+t.utils.CLOCK_DIRS[h%8][0],_=i+t.utils.CLOCK_DIRS[h%8][1],!s.hasXY(a,_))continue;const e=s.get(a,_);if(e&&e.flags.cellMech&n.IS_IN_LOOP){if(f++,!r){if(o>0)return!1;o++,r=!0}}else r&&(f>E&&(E=f),f=0,r=!1)}if(r&&f>E&&(E=f),1==o&&E<=4){for(e.flags.cellMech&=~n.IS_IN_LOOP,h=0;h<8;h++){const e=l+t.utils.CLOCK_DIRS[h][0],r=i+t.utils.CLOCK_DIRS[h][1];if(s.hasXY(e,r)){z(s.cell(e,r),e,r,s)}}return!0}return!1}function $(e,t){for(let l=0;l<e.width;++l)for(let i=0;i<e.height;++i){if(e.cells[l][i].flags.cellMech&n.IS_IN_LOOP)t[l][i]=1;else if(l>0&&i>0){const s=e.cells[l][i-1],r=e.cells[l-1][i];s.flags.cellMech&n.IS_IN_LOOP&&r.flags.cellMech&n.IS_IN_LOOP&&(t[l][i]=1)}}}function J(e){const l=t.grid.alloc(e.width,e.height);let i;$(e,l);for(let s=0;s<l.width;s++)for(let r=0;r<l.height;r++){if(e.cell(s,r).flags.cellMech&n.IS_IN_LOOP){i=!1;for(let a=0;a<8;a++){let _=s+t.utils.CLOCK_DIRS[a][0],h=r+t.utils.CLOCK_DIRS[a][1];if(e.hasXY(_,h)&&!l[_][h]&&!(e.cells[_][h].flags.cellMech&n.IS_IN_LOOP)){i=!0;break}}i||(l[s][r]=1,e.cells[s][r].flags.cellMech&=~n.IS_IN_LOOP)}}t.grid.free(l)}t.effect.installType("clear",new class{make(e,t){if(!e.clear)return!0;let i=e.clear,s=0;if("string"==typeof i&&(i=i.split(/[,|]/).map((e=>e.trim()))),!0===i)s=l.ALL_LAYERS;else if("number"==typeof i)s=i;else{if(!Array.isArray(i))throw new Error("clear effect must have number or string config.");s=i.reduce(((e,t)=>{if("number"==typeof t)return e|t;return e|(l[t]||0)}),0)}return t.clear=s,s>0}fire(e,t,l,i,s){if(!e.clear)return!1;return!!t&&t.clearCellLayers(l,i,e.clear)}}),t.utils.setDefaults(t.config,{"map.deepestLevel":99});class Z{constructor(e,l,i={}){this.locations={},this.config={},this._actors=null,this._items=null,this.flags={map:0},this.lights=null,this.fov=null,this.effects={},this._width=e,this._height=l,this.cells=t.grid.make(e,l,(()=>new U)),this.locations=i.locations||{},this.config=Object.assign({},i),this.config.tick=this.config.tick||100,this._actors=null,this._items=null,this.flags.map=t.flag.from(c,c.MAP_DEFAULT,i.flags);const s=i.ambient||i.ambientLight||i.light||"white";this.ambientLight=t.color.make(s),(i.ambient||i.ambientLight||i.light)&&(this.ambientLightChanged=!0),this.lights=null,this.id=i.id,i.fov&&(this.flags.map|=c.MAP_CALC_FOV,this.fov={x:-1,y:-1}),i.updateLiquid&&"function"==typeof i.updateLiquid&&(this.updateLiquid=i.updateLiquid.bind(this)),i.updateGas&&"function"==typeof i.updateGas&&(this.updateGas=i.updateGas.bind(this)),R(this),Y(this),(i.visible||i.revealed||!this.fov)&&this.revealAll(),!i.visible&&this.fov||this.makeVisible(),this.changed=!1}get width(){return this._width}get height(){return this._height}async start(){}clear(e="FLOOR"){this.cells.forEach((t=>t.clear(e))),this.changed=!0}dump(e){this.cells.dump(e||(e=>e.dump()))}cell(e,t){return this.cells[e][t]}get(e,t){return this.cells.get(e,t)}eachCell(e){this.cells.forEach(((t,l,i)=>e(t,l,i,this)))}forEach(e){this.cells.forEach(((t,l,i)=>e(t,l,i,this)))}async forEachAsync(e){return this.cells.forEachAsync(((t,l,i)=>e(t,l,i,this)))}forRect(e,t,l,i,s){this.cells.forRect(e,t,l,i,((e,t,l)=>s(e,t,l,this)))}eachNeighbor(e,t,l,i=!1){this.cells.eachNeighbor(e,t,((e,t,i)=>l(e,t,i,this)),i)}eachNeighborAsync(e,t,l,i=!1){return this.cells.eachNeighborAsync(e,t,((e,t,i)=>l(e,t,i,this)),i)}randomEach(e){this.cells.randomEach(((t,l,i)=>e(t,l,i,this)))}count(e){let t=0;return this.forEach(((l,i,s,r)=>{e(l,i,s,r)&&++t})),t}hasXY(e,t){return this.cells.hasXY(e,t)}isBoundaryXY(e,t){return this.cells.isBoundaryXY(e,t)}get changed(){return(this.flags.map&c.MAP_CHANGED)>0}set changed(e){!0===e?this.flags.map|=c.MAP_CHANGED:!1===e&&(this.flags.map&=~c.MAP_CHANGED)}hasCellFlag(e,t,l){return this.cell(e,t).flags.cell&l}hasCellMechFlag(e,t,l){return this.cell(e,t).flags.cellMech&l}hasLayerFlag(e,t,l){return this.cell(e,t).hasLayerFlag(l)}hasTileFlag(e,t,l,i=!1){return this.cell(e,t).hasTileFlag(l,i)}hasTileMechFlag(e,t,l,i=!1){return this.cell(e,t).hasTileMechFlag(l,i)}redrawCell(e){e.needsRedraw=!0,this.flags.map|=c.MAP_CHANGED}redrawXY(e,t){const l=this.cell(e,t);this.redrawCell(l)}redrawAll(){this.forEach((e=>{e.needsRedraw=!0})),this.changed=!0}drawInto(e,l={}){R(this);const i=e instanceof t.canvas.Canvas?e.buffer:e;"boolean"==typeof l&&(l={force:l});const s=new t.sprite.Mixer;for(let e=0;e<i.width;++e)for(let t=0;t<i.height;++t){const r=this.cell(e,t);if(r.needsRedraw||l.force){te(this,e,t,s);const l="number"==typeof s.ch?s.ch:i.toGlyph(s.ch);i.draw(e,t,l,s.fg.toInt(),s.bg.toInt()),r.needsRedraw=!1}}}revealAll(){this.forEach((e=>{e.markRevealed(),e.storeMemory()}))}markRevealed(e,t){this.cell(e,t).markRevealed()}makeVisible(e=!0){e?this.setFlags(0,h.VISIBLE):this.clearFlags(0,h.ANY_KIND_OF_VISIBLE)}isVisible(e,t){return this.cell(e,t).isVisible()}isAnyKindOfVisible(e,t){return this.cell(e,t).isAnyKindOfVisible()}isOrWasAnyKindOfVisible(e,t){return this.cell(e,t).isOrWasAnyKindOfVisible()}isRevealed(e,t){return this.cell(e,t).isRevealed()}get anyLightChanged(){return 0==(this.flags.map&c.MAP_STABLE_LIGHTS)}set anyLightChanged(e){e?this.flags.map&=~c.MAP_STABLE_LIGHTS:this.flags.map|=c.MAP_STABLE_LIGHTS}get ambientLightChanged(){return this.staticLightChanged}set ambientLightChanged(e){this.staticLightChanged=e}get staticLightChanged(){return 0==(this.flags.map&c.MAP_STABLE_GLOW_LIGHTS)}set staticLightChanged(e){e?this.flags.map&=~(c.MAP_STABLE_GLOW_LIGHTS|c.MAP_STABLE_LIGHTS):this.flags.map|=c.MAP_STABLE_GLOW_LIGHTS}setFlag(e){this.flags.map|=e,this.changed=!0}setFlags(e=0,t=0,l=0){e&&(this.flags.map|=e),(t||l)&&this.forEach((e=>e.setFlags(t,l))),this.changed=!0}clearFlag(e){this.flags.map&=~e,this.changed=!0}clearFlags(e=0,t=0,l=0){e&&(this.flags.map&=~e),(t||l)&&this.forEach((e=>e.clearFlags(t,l))),this.changed=!0}setCellFlags(e,t,l=0,i=0){this.cell(e,t).setFlags(l,i),this.flags.map|=c.MAP_CHANGED}clearCellFlags(e,t,l=0,i=0){this.cell(e,t).clearFlags(l,i),this.changed=!0}hasTile(e,t,l){return this.cells[e][t].hasTile(l)}layerFlags(e,t,l=!1){return this.cells[e][t].layerFlags(l)}tileFlags(e,t,l=!1){return this.cells[e][t].tileFlags(l)}tileMechFlags(e,t,l=!1){return this.cells[e][t].tileMechFlags(l)}tileWithLayerFlag(e,t,l=0){return this.cells[e][t].tileWithLayerFlag(l)}tileWithFlag(e,t,l=0){return this.cells[e][t].tileWithFlag(l)}tileWithMechFlag(e,t,l=0){return this.cells[e][t].tileWithMechFlag(l)}isClear(e,t){return this.cells[e][t].isClear()}isEmpty(e,t){return this.cells[e][t].isEmpty()}isObstruction(e,t,l=!1){return this.cells[e][t].isObstruction(l)}isDoorway(e,t,l=!1){return this.cells[e][t].isDoorway(l)}isSecretDoorway(e,t,l=!1){return this.cells[e][t].isSecretDoorway(l)}isLiquid(e,t,l=!1){return this.cells[e][t].isLiquid(l)}hasGas(e,t,l=!1){return this.cells[e][t].hasGas(l)}blocksPathing(e,t,l=!1){return this.cells[e][t].blocksPathing(l)}blocksVision(e,t){return this.cells[e][t].blocksVision()}isMoveableNow(e,t,l=!1){return this.cells[e][t].isMoveableNow(l)}isWalkableNow(e,t,l=!1){return this.cells[e][t].isWalkableNow(l)}canBeWalked(e,t,l=!1){return this.cells[e][t].canBeWalked(l)}topmostTile(e,t,l=!1){return this.cells[e][t].topmostTile(l)}tileFlavor(e,t){return this.cells[e][t].tileFlavor()}setTile(e,t,l,i=0){return this.cell(e,t).setTile(l,i,this)}nullifyCell(e,t){this.cell(e,t).nullify()}clearCell(e,t){this.cell(e,t).clear()}clearCellLayers(e,t,l=-1){return this.cell(e,t).clearLayers(l)}clearCellLayersWithFlags(e,t,l,i=0){this.cell(e,t).clearLayersWithFlags(l,i)}fill(e,t){let l,i;for(void 0===t&&(t=e),l=0;l<this.width;++l)for(i=0;i<this.height;++i)this.isBoundaryXY(l,i)?this.setTile(l,i,t):this.setTile(l,i,e)}neighborCount(e,t,l,i=!1){let s=0;return this.eachNeighbor(e,t,((...e)=>{l(...e)&&++s}),i),s}walkableArcCount(e,t){return this.hasXY(e,t)?this.cells.arcCount(e,t,(e=>e.isWalkableNow())):-1}diagonalBlocked(e,t,l,i,s=!1){return e!=l&&t!=i&&(!!this.isObstruction(e,i,s)||!!this.isObstruction(l,t,s))}fillCostGrid(e,l){l=l||(e=>e.isWalkableNow()?1:t.path.OBSTRUCTION),this.cells.forEach(((i,s,r)=>{i.isNull()?e[s][r]=t.path.OBSTRUCTION:e[s][r]=l(i,s,r,this)}))}matchingNeighbor(e,l,i,s=!1){return t.utils.matchingNeighbor(e,l,((e,t)=>!!this.hasXY(e,t)&&i(this.cell(e,t),e,t,this)),s)}matchingLocNear(e,l,...i){let s,r,a,_=i[0],h=i[1]||{};const n=i[0];"string"==typeof n&&(_=e=>e.hasTile(n)),"function"!=typeof _&&(h=_||h,_=h.match||t.utils.TRUE);const c=!1!==h.hallways,o=h.blockingMap||null,E=!1===h.liquids,f=h.deterministic||!1;let L=[],g=10*(this.width+this.height);for(a=0;a<Math.max(this.width,this.height)&&!L.length;a++)for(s=e-a;s<=e+a;s++)for(r=l-a;r<=l+a;r++){if(!this.hasXY(s,r))continue;const i=this.cell(s,r),h=Math.floor(10*t.utils.distanceBetween(e,l,s,r));Math.floor(h)!=10*a||o&&o[s][r]||!_(i,s,r,this)||E&&i.liquid||!(c||this.walkableArcCount(s,r)<2)||(h<g?(L=[[s,r]],g=h):h==g&&L.push([s,r]))}if(0==L.length)return[-1,-1];let A=0;return A=f?Math.floor(L.length/2):t.random.number(L.length),L[A]}randomMatchingLoc(e={}){let l,i,s;"function"==typeof e&&(e={match:e});const r=t.random.sequence(this.width*this.height),a=e.hallways||!1,_=e.blockingMap||null,h=!1===e.liquids,n=e.match||t.utils.TRUE,c=e.forbidCellFlags||0,o=e.forbidLayerFlags||0,E=e.forbidTileFlags||0,f=e.forbidTileMechFlags||0,L=e.tile||null;let g=!1,A=0;for(;!g&&A<r.length;){const e=r[A];l=e%this.width,i=Math.floor(e/this.width),s=this.cell(l,i),_&&_[l][i]||L&&!s.hasTile(L)||h&&s.liquid||c&&s.flags.cell&c||E&&s.hasTileFlag(E)||o&&s.hasLayerFlag(o)||f&&s.hasTileMechFlag(f)||!(a||this.walkableArcCount(l,i)<2)||!n(s,l,i,this)||(g=!0),++A}return g?[l,i]:[-1,-1]}hasVisibleLight(e,t){return this.cell(e,t).hasVisibleLight()}addStaticLight(e,t,l){const i={x:e,y:t,light:I(l),next:this.lights};return this.lights=i,this.staticLightChanged=!0,i}removeStaticLight(e,t,l){let i=this.lights;if(!i)return;function s(i){return i.x==e&&i.y==t&&(!l||l===i.light)}for(this.staticLightChanged=!0;i&&s(i);)i=this.lights=i.next;if(!i)return;let r=i.next;for(;r;)s(r)?i.next=r.next:i=r,r=r.next}eachStaticLight(e){t.utils.eachChain(this.lights,(t=>e(t.light,t.x,t.y))),this.eachCell(((t,l,i)=>{for(let s of t.tiles())s.light&&e(s.light,l,i)}))}eachDynamicLight(e){t.utils.eachChain(this._actors,(t=>{t.light&&e(t.light,t.x,t.y)}))}addFx(e,t,l){if(!this.hasXY(e,t))return!1;const i=this.cell(e,t);return i.addLayer(l),l.x=e,l.y=t,this.redrawCell(i),!0}moveFx(e,t,l){if(!this.hasXY(e,t))return!1;const i=this.cell(e,t),s=this.cell(l.x,l.y);return s.removeLayer(l),this.redrawCell(s),i.addLayer(l),this.redrawCell(i),l.x=e,l.y=t,!0}removeFx(e){const t=this.cell(e.x,e.y);return t.removeLayer(e),this.redrawCell(t),this.flags.map|=c.MAP_CHANGED,!0}*actors(){let e=this._actors;for(;e;){const t=e.next;yield e,e=t}}actorAt(e,t){if(!this.hasXY(e,t))return null;return this.cell(e,t).actor}addActor(e,l,i){if(!this.hasXY(e,l))return!1;const s=this.cell(e,l);if(s.actor)return!1;s.actor=i,i.next=this._actors,this._actors=i;const r=i===t.data.player?h.HAS_PLAYER:h.HAS_ACTOR;return s.flags.cell|=r,i.light&&(this.anyLightChanged=!0),(i.isPlayer()||s.isAnyKindOfVisible()&&i.blocksVision())&&(this.flags.map|=c.MAP_FOV_CHANGED),i.x=e,i.y=l,this.redrawCell(s),!0}addActorNear(e,t,l){const i=this.matchingLocNear(e,t,(e=>!l.avoidsCell(e)));return!(!i||i[0]<0)&&this.addActor(i[0],i[1],l)}moveActor(e,t,l){if(!this.hasXY(e,t))return!1;if(this.removeActor(l),l.rememberedInCell){this.cell(e,t).isAnyKindOfVisible()!==l.rememberedInCell.isAnyKindOfVisible()&&l.rememberedInCell.storeMemory()}return this.addActor(e,t,l)?(l.light&&(this.anyLightChanged=!0),!0):(this.addActor(l.x,l.y,l),!1)}removeActor(e){if(!this.hasXY(e.x,e.y))return!1;const l=this.cell(e.x,e.y);return l.actor===e&&(l.actor=null,t.utils.removeFromChain(this,"_actors",e),e.light&&(this.anyLightChanged=!0),(e.isPlayer()||l.isAnyKindOfVisible()&&e.blocksVision())&&(this.flags.map|=c.MAP_FOV_CHANGED),this.redrawCell(l),!0)}deleteActorAt(e,t){const l=this.actorAt(e,t);return!!l&&(this.removeActor(l),l.delete(),!0)}*items(){let e=this._items;for(;e;){const t=e.next;yield e,e=t}}itemAt(e,t){return this.cell(e,t).item}addItem(e,l,i){if(!this.hasXY(e,l))return!1;const s=this.cell(e,l);return!s.item&&(i.x=e,i.y=l,s.item=i,i.next=this._items,this._items=i,i.light&&(this.anyLightChanged=!0),this.redrawCell(s),(i.isDetected()||t.config.D_ITEM_OMNISCIENCE)&&(s.flags.cell|=h.ITEM_DETECTED),!0)}removeItem(e){const l=e.x,i=e.y;if(!this.hasXY(l,i))return!1;const s=this.cell(l,i);return s.item===e&&(s.item=null,t.utils.removeFromChain(this,"_items",e),e.light&&(this.anyLightChanged=!0),s.flags.cell&=~(h.HAS_ITEM|h.ITEM_DETECTED),this.redrawCell(s),!0)}gridDisruptsWalkability(e,l={}){const i=t.grid.alloc(this.width,this.height);let s=!1;const r=l.gridOffsetX||0,_=l.gridOffsetY||0,h=l.bounds||null;this.cells.forEach(((t,l,n)=>{if(h&&!h.contains(l,n))return;const c=l+r,o=n+_;if(!t.isNull())if(t.hasTileFlag(a.T_HAS_STAIRS))e.get(c,o)?s=!0:i[l][n]=1;else if(t.canBeWalked()){if(e.get(c,o))return;i[l][n]=1}}));let n=!0;for(let e=0;e<i.width&&!s;++e)for(let t=0;t<i.height&&!s;++t)1==i[e][t]&&(n?(i.floodFill(e,t,1,2),n=!1):s=!0);return t.grid.free(i),s}calcFov(e,l,i,r,a=0,_=s.L_BLOCKS_VISION){r=r||this.width+this.height,e.fill(0);const h=this;return new t.fov.FOV({isBlocked:(t,l)=>!(e.hasXY(t,l)&&!h.hasCellFlag(t,l,a)&&!h.hasLayerFlag(t,l,_)),calcRadius:(e,t)=>Math.sqrt(e**2+t**2),setVisible(t,l){e[t][l]=1},hasXY:(t,l)=>e.hasXY(t,l)}).calculate(l,i,r)}losFromTo(e,l){if(t.utils.equalsXY(e,l))return!0;const i=t.utils.getLine(e.x,e.y,l.x,l.y);return!!i.length&&!i.some((e=>this.blocksVision(e[0],e[1])))}storeMemory(e,t){this.cell(e,t).storeMemory()}storeMemories(){let e,t;for(e=0;e<this.width;++e)for(t=0;t<this.height;++t){const l=this.cell(e,t);l.flags.cell&h.ANY_KIND_OF_VISIBLE&&l.storeMemory()}}async activateCell(e,t,l){const i=this.cell(e,t);return await i.activate(l,this,e,t,{cell:i})}async activateAll(e){return k(this,e)}async tick(){if(await k(this,"tick"),await this.forEachAsync((async(e,t,l)=>{e.flags.cellMech&=~n.CAUGHT_FIRE_THIS_TURN,!(e.flags.cell&(h.HAS_ANY_ACTOR|h.HAS_ITEM))&&e.flags.cellMech&n.PRESSURE_PLATE_DEPRESSED&&(e.flags.cellMech&=~n.PRESSURE_PLATE_DEPRESSED),e.hasEffect("noKey")&&!e.hasKey()&&await e.activate("noKey",this,t,l)})),await this.forEachAsync((async(e,t,l)=>{!e.hasTileFlag(a.T_IS_FIRE)||e.flags.cellMech&n.CAUGHT_FIRE_THIS_TURN||(await this.exposeToFire(t,l,!1),await this.eachNeighborAsync(t,l,((e,t,l)=>this.exposeToFire(t,l)),!0))})),!(this.flags.map&c.MAP_NO_LIQUID)){const e=t.grid.alloc(this.width,this.height),i=ie(this,l.LIQUID,e);i===le.CALC&&this.updateLiquid(e),i!=le.NONE?(se(this,l.LIQUID,e),this.flags.map&=~c.MAP_NO_LIQUID):this.flags.map|=c.MAP_NO_LIQUID,this.changed=!0,t.grid.free(e)}if(!(this.flags.map&c.MAP_NO_GAS)){const e=t.grid.alloc(this.width,this.height),i=ie(this,l.GAS,e);i===le.CALC&&this.updateGas(e),i!=le.NONE?(se(this,l.GAS,e),this.flags.map&=~c.MAP_NO_GAS):this.flags.map|=c.MAP_NO_GAS,this.changed=!0,t.grid.free(e)}}async exposeToFire(e,i,r=!1){let h=0,n=0,c=0,o=!1,E=!1;const f=this.cell(e,i);if(!f.hasTileFlag(a.T_IS_FLAMMABLE))return!1;for(let e of f.tiles())e.flags.tile&a.T_EXTINGUISHES_FIRE&&e.priority>n&&(n=e.priority);for(let e of f.tiles())if(e.flags.tile&a.T_IS_FLAMMABLE&&(e.layer===l.GAS||e.priority>=n)){const l=t.effect.from(e.effects.fire);l&&l.chance>h&&(h=l.chance)}if(r||h&&t.random.chance(h,1e4)){o=!0,f.hasTileMechFlag(_.TM_EXPLOSIVE_PROMOTE)&&(this.eachNeighbor(e,i,(e=>{(e.hasLayerFlag(s.L_BLOCKS_GAS)||e.hasTileFlag(a.T_IS_FIRE)||e.hasTileMechFlag(_.TM_EXPLOSIVE_PROMOTE))&&++c})),c>=8&&(E=!0));let t="fire";E&&f.hasEffect("explode")&&(t="explode");for(let e of f.tiles())e.flags.tile&a.T_IS_FLAMMABLE&&(e.layer===l.GAS?f.gasVolume=0:e.layer===l.LIQUID&&(f.liquidVolume=0));await f.activate(t,this,e,i,{force:!0}),this.redrawCell(f)}return o}updateLiquid(e){this.randomEach(((t,l,i)=>{if(t.hasLayerFlag(s.L_BLOCKS_LIQUID))return;let r=0,a=-1,_=-1,h=t.liquidTile,n=e[l][i];if(e.eachNeighbor(l,i,((e,t,l)=>{e<=n||e<=r||(r=e,a=t,_=l,h=this.cell(t,l).liquidTile)})),r>1){this.setTile(l,i,h,0);const t=Math.floor((r-n)/9)+1;e[l][i]+=t,e[a][_]-=t}}))}updateGas(e){const l=t.random.sequence(4).map((e=>t.utils.DIRS[e])),i=t.grid.alloc(this.width,this.height);e.forEach(((t,s,r)=>{if(!t)return;let a=t;if(t>1){let _=1;e.eachNeighbor(s,r,(()=>{++_}),!0);let h=Math.floor(t/_),n=t-h*_;i[s][r]+=h,n>0&&(i[s][r]+=1,n-=1);for(let e=0;e<l.length;++e){const t=l[e],_=s+t[0],c=r+t[1];i.hasXY(_,c)&&(a=h,n>0&&(--n,++a),i[_][c]+=a)}}else i[s][r]+=t})),e.copy(i),t.grid.free(i)}resetCellEvents(){this.forEach((e=>e.flags.cellMech&=~(n.EVENT_FIRED_THIS_TURN|n.EVENT_PROTECTED)))}}function ee(e,l,i={},s){"string"==typeof i&&(i={tile:i},s&&(i.wall=s));const r=new Z(e,l,i);let a=i.tile||i.floor||i.floorTile;!0===a&&(a="FLOOR");let _=i.boundary||i.wall||i.wallTile;return!0===_&&(_="WALL"),a&&r.fill(a,_),t.data.map||(t.data.map=r),r}function te(e,l,i,r){if(r.blackOut(),!e.hasXY(l,i))return;const a=e.cell(l,i);a.isAnyKindOfVisible()&&a.flags.cell&(h.CELL_CHANGED|h.NEEDS_REDRAW)?H(a,r):r.drawSprite(a.memory.mixer),a.isVisible()||(a.isRevealed()?a.isAnyKindOfVisible()||(r.bg.mix(t.colors.black,30),r.fg.mix(t.colors.black,30)):a.isAnyKindOfVisible()||r.blackOut());let _=!1;if(a.flags.cell&(h.IS_CURSOR|h.IS_IN_PATH)){const e=a.flags.cell&h.IS_CURSOR?t.colors.cursor:t.colors.path;a.hasLayerFlag(s.L_INVERT_WHEN_HIGHLIGHTED)?t.color.swap(r.fg,r.bg):r.bg.mix(e,t.config.cursorPathIntensity||20),_=!0}_&&t.color.separate(r.fg,r.bg),r.dances&&(e.flags.map|=c.MAP_DANCES)}var le;function ie(e,l,i){let s=!1,r=!1;return e.forEach(((a,_,h)=>{let n=a.volume(l);const c=a.tile(l);n&&c.dissipate&&(c.dissipate>1e4?(n-=Math.floor(c.dissipate/1e4),t.random.chance(c.dissipate%1e4,1e4)&&(n-=1)):t.random.chance(c.dissipate,1e4)&&(n-=1)),n>0?(i[_][h]=n,s=!0,n>1&&(r=!0)):c!==M.NULL&&(a.clearLayer(l),e.redrawCell(a))})),r?le.CALC:s?le.UPDATE:le.NONE}function se(e,t,l){l.forEach(((l,i,s)=>{const r=e.cell(i,s),a=r.volume(t),_=r.tile(t);if(l>0){if(a!==l||!_){let h=a,n=_;e.eachNeighbor(i,s,(e=>{e.volume(t)>h&&(h=e.volume(t),n=e.tile(t))})),n!==_&&r.setTile(n,0,e),r.setVolume(t,l),e.redrawCell(r)}}else(a||_!==M.NULL)&&(r.clearLayer(t),e.redrawCell(r))}))}t.make.map=ee,t.colors.cursor||t.color.install("cursor",t.colors.yellow),t.colors.path||t.color.install("path",t.colors.gold),function(e){e[e.NONE=0]="NONE",e[e.UPDATE=1]="UPDATE",e[e.CALC=2]="CALC"}(le||(le={}));var re={__proto__:null,get Flags(){return c},Map:Z,make:ee,from:function(e,t,l={}){let i,s=0,r=0;return"string"==typeof e&&(e=e.split("\n")),!function(e){return Array.isArray(e)&&"string"==typeof e[0]}(e)?(s=e.height,r=e.width,i=ee(r,s,l),e.forEach(((e,l,s)=>{const r=t[e]||"FLOOR";i.setTile(l,s,r)}))):(s=e.length,r=e.reduce(((e,t)=>Math.max(e,t.length)),0),i=ee(r,s,l),e.forEach(((e,l)=>{for(let s=0;s<r;++s){const r=e[s]||".",a=t[r]||"FLOOR";i.setTile(s,l,a)}}))),(l.visible||l.revealed)&&(i.makeVisible(),i.revealAll()),l.revealed&&!l.visible&&i.makeVisible(!1),i},getCellAppearance:te,addText:function(e,t,i,s,r,a,_){for(let h of s){const s=D({ch:h,fg:r,bg:a,layer:_||l.GROUND,priority:200});e.cell(t++,i).addLayer(s)}},analyze:function(e,t=!0){q(e),Q(e,t)},updateChokepoints:Q,floodFillCount:X,updateLoopiness:q,resetLoopiness:j,checkLoopiness:z,fillInnerLoopGrid:$,cleanLoopiness:J};P("NULL",{ch:"∅",fg:"white",bg:"black",flags:"L_BLOCKS_MOVE",name:"eerie nothingness",article:"an",priority:0}),P("FLOOR",{ch:"·",fg:[30,30,30,20,0,0,0],bg:[2,2,10,0,2,2,0],priority:10,article:"the"}),P("DOOR",{ch:"+",fg:[100,40,40],bg:[30,60,60],priority:30,flags:"T_IS_DOOR, L_BLOCKS_EFFECTS, L_BLOCKS_ITEMS, L_BLOCKS_VISION, L_VISUALLY_DISTINCT",article:"a",effects:{enter:{tile:"DOOR_OPEN"},open:{tile:"DOOR_OPEN_ALWAYS"}}}),P("DOOR_OPEN","DOOR",{ch:"'",fg:[100,40,40],bg:[30,60,60],priority:40,flags:"!L_BLOCKS_ITEMS, !L_BLOCKS_VISION",name:"open door",article:"an",effects:{tick:{chance:1e4,tile:"DOOR",flags:"E_SUPERPRIORITY, E_ONLY_IF_EMPTY"},enter:null,open:null,close:{tile:"DOOR",flags:"E_SUPERPRIORITY, E_ONLY_IF_EMPTY"}}}),P("DOOR_OPEN_ALWAYS","DOOR_OPEN",{effects:{tick:null,close:{tile:"DOOR",flags:"E_SUPERPRIORITY, E_ONLY_IF_EMPTY"}}}),P("UP_STAIRS",{ch:"<",fg:[100,50,50],bg:[40,20,20],priority:200,flags:"T_UP_STAIRS, L_BLOCKED_BY_STAIRS, L_VISUALLY_DISTINCT, L_LIST_IN_SIDEBAR",name:"upward staircase",article:"an",effects:{player:{emit:"UP_STAIRS"}}}),P("DOWN_STAIRS",{ch:">",fg:[100,50,50],bg:[40,20,20],priority:200,flags:"T_DOWN_STAIRS, L_BLOCKED_BY_STAIRS, L_VISUALLY_DISTINCT, L_LIST_IN_SIDEBAR",name:"downward staircase",article:"a",effects:{player:{emit:"DOWN_STAIRS"}}}),P("WALL",{ch:"#",fg:[7,7,7,0,3,3,3],bg:[40,40,40,10,10,0,5],priority:100,flags:"L_BLOCKS_EVERYTHING",article:"a",name:"stone wall",desc:"A wall made from rough cut stone.",flavor:"a rough stone wall"}),P("IMPREGNABLE",{ch:"#",fg:[7,7,7,0,3,3,3],bg:[40,40,40,10,10,0,5],priority:100,flags:"L_BLOCKS_EVERYTHING, IMPREGNABLE",article:"a",name:"impregnable wall",desc:"A wall made from very hard stone.",flavor:"an impregnable wall"}),P("LAKE",{ch:"~",fg:[5,8,20,10,0,4,15,!0],bg:[10,15,41,6,5,5,5,!0],priority:50,flags:"T_DEEP_WATER",name:"deep water",article:"the"}),P("SHALLOW",{ch:"·",fg:[5,8,10,10,0,4,15,!0],bg:[10,30,30,6,0,10,10,!0],priority:20,name:"shallow water",article:"the"}),P("BRIDGE",{ch:"=",fg:[100,40,40],priority:40,layer:"SURFACE",flags:"T_BRIDGE, L_VISUALLY_DISTINCT",article:"a",ground:"LAKE"}),e.cell=b,e.entity=y,e.light=N,e.lights=A,e.map=re,e.tile=V,e.tiles=M,e.visibility=W,Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=gw-map.min.js.map
