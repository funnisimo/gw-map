!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("gw-utils")):"function"==typeof define&&define.amd?define(["exports","gw-utils"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).GWM={},t.GWU)}(this,(function(t,e){"use strict";function i(t){if(t&&t.__esModule)return t;var e=Object.create(null);return t&&Object.keys(t).forEach((function(i){if("default"!==i){var s=Object.getOwnPropertyDescriptor(t,i);Object.defineProperty(e,i,s.get?s:{enumerable:!0,get:function(){return t[i]}})}})),e.default=t,Object.freeze(e)}var s,r=i(e);!function(t){t[t.ALL_LAYERS=-1]="ALL_LAYERS",t[t.GROUND=0]="GROUND",t[t.SURFACE=1]="SURFACE",t[t.ITEM=2]="ITEM",t[t.ACTOR=3]="ACTOR",t[t.LIQUID=4]="LIQUID",t[t.GAS=5]="GAS",t[t.FX=6]="FX",t[t.UI=7]="UI"}(s||(s={}));const a=r.flag.fl;var n;!function(t){t[t.L_DESTROYED=a(1)]="L_DESTROYED",t[t.L_SECRETLY_PASSABLE=a(2)]="L_SECRETLY_PASSABLE",t[t.L_BLOCKS_MOVE=a(3)]="L_BLOCKS_MOVE",t[t.L_BLOCKS_VISION=a(4)]="L_BLOCKS_VISION",t[t.L_BLOCKS_SURFACE=a(6)]="L_BLOCKS_SURFACE",t[t.L_BLOCKS_LIQUID=a(8)]="L_BLOCKS_LIQUID",t[t.L_BLOCKS_GAS=a(7)]="L_BLOCKS_GAS",t[t.L_BLOCKS_ITEMS=a(5)]="L_BLOCKS_ITEMS",t[t.L_BLOCKS_ACTORS=a(11)]="L_BLOCKS_ACTORS",t[t.L_BLOCKS_EFFECTS=a(9)]="L_BLOCKS_EFFECTS",t[t.L_BLOCKS_DIAGONAL=a(10)]="L_BLOCKS_DIAGONAL",t[t.L_INTERRUPT_WHEN_SEEN=a(12)]="L_INTERRUPT_WHEN_SEEN",t[t.L_LIST_IN_SIDEBAR=a(13)]="L_LIST_IN_SIDEBAR",t[t.L_VISUALLY_DISTINCT=a(14)]="L_VISUALLY_DISTINCT",t[t.L_BRIGHT_MEMORY=a(15)]="L_BRIGHT_MEMORY",t[t.L_INVERT_WHEN_HIGHLIGHTED=a(16)]="L_INVERT_WHEN_HIGHLIGHTED",t[t.L_ON_MAP=a(17)]="L_ON_MAP",t[t.DEFAULT_ACTOR=t.L_LIST_IN_SIDEBAR]="DEFAULT_ACTOR",t[t.DEFAULT_ITEM=t.L_LIST_IN_SIDEBAR]="DEFAULT_ITEM",t[t.L_BLOCKED_BY_STAIRS=t.L_BLOCKS_ITEMS|t.L_BLOCKS_SURFACE|t.L_BLOCKS_GAS|t.L_BLOCKS_LIQUID|t.L_BLOCKS_EFFECTS|t.L_BLOCKS_ACTORS]="L_BLOCKED_BY_STAIRS",t[t.L_BLOCKS_SCENT=t.L_BLOCKS_MOVE|t.L_BLOCKS_VISION]="L_BLOCKS_SCENT",t[t.L_DIVIDES_LEVEL=t.L_BLOCKS_MOVE]="L_DIVIDES_LEVEL",t[t.L_WAYPOINT_BLOCKER=t.L_BLOCKS_MOVE]="L_WAYPOINT_BLOCKER",t[t.L_WALL_FLAGS=t.L_BLOCKS_MOVE|t.L_BLOCKS_VISION|t.L_BLOCKS_LIQUID|t.L_BLOCKS_GAS|t.L_BLOCKS_EFFECTS|t.L_BLOCKS_DIAGONAL]="L_WALL_FLAGS",t[t.L_BLOCKS_EVERYTHING=t.L_WALL_FLAGS|t.L_BLOCKS_ITEMS|t.L_BLOCKS_ACTORS|t.L_BLOCKS_SURFACE]="L_BLOCKS_EVERYTHING"}(n||(n={}));const o=r.flag.fl;var l,h;!function(t){t[t.IS_PLAYER=o(0)]="IS_PLAYER",t[t.HAS_MEMORY=o(1)]="HAS_MEMORY",t[t.USES_FOV=o(2)]="USES_FOV",t[t.STALE_COST_MAP=o(3)]="STALE_COST_MAP",t[t.DEFAULT=0]="DEFAULT"}(l||(l={})),function(t){t[t.DEFAULT=0]="DEFAULT"}(h||(h={}));const c=r.flag.fl;var f;!function(t){t[t.T_BRIDGE=c(0)]="T_BRIDGE",t[t.T_AUTO_DESCENT=c(1)]="T_AUTO_DESCENT",t[t.T_LAVA=c(2)]="T_LAVA",t[t.T_DEEP_WATER=c(3)]="T_DEEP_WATER",t[t.T_SHALLOW_WATER=c(4)]="T_SHALLOW_WATER",t[t.T_IS_FLAMMABLE=c(5)]="T_IS_FLAMMABLE",t[t.T_SPONTANEOUSLY_IGNITES=c(6)]="T_SPONTANEOUSLY_IGNITES",t[t.T_IS_FIRE=c(7)]="T_IS_FIRE",t[t.T_EXTINGUISHES_FIRE=c(8)]="T_EXTINGUISHES_FIRE",t[t.T_IS_SECRET=c(9)]="T_IS_SECRET",t[t.T_IS_TRAP=c(10)]="T_IS_TRAP",t[t.T_SACRED=c(11)]="T_SACRED",t[t.T_UP_STAIRS=c(12)]="T_UP_STAIRS",t[t.T_DOWN_STAIRS=c(13)]="T_DOWN_STAIRS",t[t.T_PORTAL=c(14)]="T_PORTAL",t[t.T_IS_DOOR=c(15)]="T_IS_DOOR",t[t.T_ALLOWS_SUBMERGING=c(16)]="T_ALLOWS_SUBMERGING",t[t.T_ENTANGLES=c(17)]="T_ENTANGLES",t[t.T_REFLECTS=c(18)]="T_REFLECTS",t[t.T_STAND_IN_TILE=c(19)]="T_STAND_IN_TILE",t[t.T_CONNECTS_LEVEL=c(20)]="T_CONNECTS_LEVEL",t[t.T_BLOCKS_OTHER_LAYERS=c(21)]="T_BLOCKS_OTHER_LAYERS",t[t.T_HAS_STAIRS=t.T_UP_STAIRS|t.T_DOWN_STAIRS|t.T_PORTAL]="T_HAS_STAIRS",t[t.T_OBSTRUCTS_SCENT=t.T_AUTO_DESCENT|t.T_LAVA|t.T_DEEP_WATER|t.T_SPONTANEOUSLY_IGNITES|t.T_HAS_STAIRS]="T_OBSTRUCTS_SCENT",t[t.T_PATHING_BLOCKER=t.T_AUTO_DESCENT|t.T_IS_TRAP|t.T_LAVA|t.T_DEEP_WATER|t.T_IS_FIRE|t.T_SPONTANEOUSLY_IGNITES|t.T_ENTANGLES]="T_PATHING_BLOCKER",t[t.T_LAKE_PATHING_BLOCKER=t.T_AUTO_DESCENT|t.T_LAVA|t.T_DEEP_WATER|t.T_SPONTANEOUSLY_IGNITES]="T_LAKE_PATHING_BLOCKER",t[t.T_WAYPOINT_BLOCKER=t.T_AUTO_DESCENT|t.T_IS_TRAP|t.T_LAVA|t.T_DEEP_WATER|t.T_SPONTANEOUSLY_IGNITES]="T_WAYPOINT_BLOCKER",t[t.T_DIVIDES_LEVEL=t.T_AUTO_DESCENT|t.T_IS_TRAP|t.T_LAVA|t.T_DEEP_WATER]="T_DIVIDES_LEVEL",t[t.T_MOVES_ITEMS=t.T_DEEP_WATER|t.T_LAVA]="T_MOVES_ITEMS",t[t.T_CAN_BE_BRIDGED=t.T_AUTO_DESCENT|t.T_LAVA|t.T_DEEP_WATER]="T_CAN_BE_BRIDGED",t[t.T_IS_DEEP_LIQUID=t.T_LAVA|t.T_AUTO_DESCENT|t.T_DEEP_WATER]="T_IS_DEEP_LIQUID",t[t.T_ANY_LIQUID=t.T_IS_DEEP_LIQUID|t.T_SHALLOW_WATER]="T_ANY_LIQUID"}(f||(f={}));const _=r.flag.fl;var u;!function(t){t[t.TM_IS_WIRED=_(9)]="TM_IS_WIRED",t[t.TM_IS_CIRCUIT_BREAKER=_(10)]="TM_IS_CIRCUIT_BREAKER",t[t.TM_VANISHES_UPON_PROMOTION=_(15)]="TM_VANISHES_UPON_PROMOTION",t[t.TM_EXPLOSIVE_PROMOTE=_(21)]="TM_EXPLOSIVE_PROMOTE",t[t.TM_SWAP_ENCHANTS_ACTIVATION=_(25)]="TM_SWAP_ENCHANTS_ACTIVATION"}(u||(u={}));const d=r.flag.fl;var g;!function(t){t[t.PRESSURE_PLATE_DEPRESSED=d(0)]="PRESSURE_PLATE_DEPRESSED",t[t.SEARCHED_FROM_HERE=d(1)]="SEARCHED_FROM_HERE",t[t.KNOWN_TO_BE_SAFE=d(2)]="KNOWN_TO_BE_SAFE",t[t.CAUGHT_FIRE_THIS_TURN=d(3)]="CAUGHT_FIRE_THIS_TURN",t[t.EVENT_FIRED_THIS_TURN=d(4)]="EVENT_FIRED_THIS_TURN",t[t.EVENT_PROTECTED=d(5)]="EVENT_PROTECTED",t[t.IS_IN_LOOP=d(6)]="IS_IN_LOOP",t[t.IS_CHOKEPOINT=d(7)]="IS_CHOKEPOINT",t[t.IS_GATE_SITE=d(8)]="IS_GATE_SITE",t[t.IS_IN_ROOM_MACHINE=d(9)]="IS_IN_ROOM_MACHINE",t[t.IS_IN_AREA_MACHINE=d(10)]="IS_IN_AREA_MACHINE",t[t.IMPREGNABLE=d(11)]="IMPREGNABLE",t[t.NEEDS_REDRAW=d(13)]="NEEDS_REDRAW",t[t.STABLE_MEMORY=d(14)]="STABLE_MEMORY",t[t.STABLE_SNAPSHOT=d(15)]="STABLE_SNAPSHOT",t[t.HAS_PLAYER=d(16)]="HAS_PLAYER",t[t.HAS_ACTOR=d(17)]="HAS_ACTOR",t[t.HAS_DORMANT_MONSTER=d(18)]="HAS_DORMANT_MONSTER",t[t.HAS_ITEM=d(19)]="HAS_ITEM",t[t.HAS_FX=d(20)]="HAS_FX",t[t.HAS_TICK_EFFECT=d(22)]="HAS_TICK_EFFECT",t[t.IS_WIRED=d(26)]="IS_WIRED",t[t.IS_CIRCUIT_BREAKER=d(27)]="IS_CIRCUIT_BREAKER",t[t.IS_POWERED=d(28)]="IS_POWERED",t[t.COLORS_DANCE=d(30)]="COLORS_DANCE",t[t.CHANGED=t.NEEDS_REDRAW]="CHANGED",t[t.IS_IN_MACHINE=t.IS_IN_ROOM_MACHINE|t.IS_IN_AREA_MACHINE]="IS_IN_MACHINE",t[t.PERMANENT_CELL_FLAGS=t.HAS_ITEM|t.HAS_DORMANT_MONSTER|t.STABLE_MEMORY|t.SEARCHED_FROM_HERE|t.PRESSURE_PLATE_DEPRESSED|t.KNOWN_TO_BE_SAFE|t.IS_IN_LOOP|t.IS_CHOKEPOINT|t.IS_GATE_SITE|t.IS_IN_MACHINE|t.IMPREGNABLE]="PERMANENT_CELL_FLAGS",t[t.HAS_ANY_ACTOR=t.HAS_PLAYER|t.HAS_ACTOR]="HAS_ANY_ACTOR",t[t.HAS_ANY_OBJECT=t.HAS_ITEM|t.HAS_ANY_ACTOR]="HAS_ANY_OBJECT",t[t.CELL_DEFAULT=t.NEEDS_REDRAW]="CELL_DEFAULT"}(g||(g={}));const E=r.flag.fl;var m;!function(t){t[t.MAP_CHANGED=E(0)]="MAP_CHANGED",t[t.MAP_NEEDS_REDRAW=E(1)]="MAP_NEEDS_REDRAW",t[t.MAP_ALWAYS_LIT=E(3)]="MAP_ALWAYS_LIT",t[t.MAP_SAW_WELCOME=E(4)]="MAP_SAW_WELCOME",t[t.MAP_NO_LIQUID=E(5)]="MAP_NO_LIQUID",t[t.MAP_NO_GAS=E(6)]="MAP_NO_GAS",t[t.MAP_CALC_FOV=E(7)]="MAP_CALC_FOV",t[t.MAP_FOV_CHANGED=E(8)]="MAP_FOV_CHANGED",t[t.MAP_DANCES=E(9)]="MAP_DANCES",t[t.MAP_SIDEBAR_TILES_CHANGED=E(10)]="MAP_SIDEBAR_TILES_CHANGED",t[t.MAP_DEFAULT=0]="MAP_DEFAULT"}(m||(m={}));const p=r.flag.fl;var A;!function(t){t[t.E_NEXT_ALWAYS=p(0)]="E_NEXT_ALWAYS",t[t.E_NEXT_EVERYWHERE=p(1)]="E_NEXT_EVERYWHERE",t[t.E_FIRED=p(2)]="E_FIRED",t[t.E_NO_MARK_FIRED=p(3)]="E_NO_MARK_FIRED",t[t.E_PROTECTED=p(4)]="E_PROTECTED",t[t.E_TREAT_AS_BLOCKING=p(5)]="E_TREAT_AS_BLOCKING",t[t.E_PERMIT_BLOCKING=p(6)]="E_PERMIT_BLOCKING",t[t.E_ABORT_IF_BLOCKS_MAP=p(7)]="E_ABORT_IF_BLOCKS_MAP",t[t.E_BLOCKED_BY_ITEMS=p(8)]="E_BLOCKED_BY_ITEMS",t[t.E_BLOCKED_BY_ACTORS=p(9)]="E_BLOCKED_BY_ACTORS",t[t.E_BLOCKED_BY_OTHER_LAYERS=p(10)]="E_BLOCKED_BY_OTHER_LAYERS",t[t.E_SUPERPRIORITY=p(11)]="E_SUPERPRIORITY",t[t.E_IGNORE_FOV=p(12)]="E_IGNORE_FOV",t[t.E_EVACUATE_CREATURES=p(15)]="E_EVACUATE_CREATURES",t[t.E_EVACUATE_ITEMS=p(16)]="E_EVACUATE_ITEMS",t[t.E_BUILD_IN_WALLS=p(17)]="E_BUILD_IN_WALLS",t[t.E_MUST_TOUCH_WALLS=p(18)]="E_MUST_TOUCH_WALLS",t[t.E_NO_TOUCH_WALLS=p(19)]="E_NO_TOUCH_WALLS",t[t.E_CLEAR_GROUND=p(21)]="E_CLEAR_GROUND",t[t.E_CLEAR_SURFACE=p(22)]="E_CLEAR_SURFACE",t[t.E_CLEAR_LIQUID=p(23)]="E_CLEAR_LIQUID",t[t.E_CLEAR_GAS=p(24)]="E_CLEAR_GAS",t[t.E_CLEAR_TILE=p(25)]="E_CLEAR_TILE",t[t.E_CLEAR_CELL=t.E_CLEAR_GROUND|t.E_CLEAR_SURFACE|t.E_CLEAR_LIQUID|t.E_CLEAR_GAS]="E_CLEAR_CELL",t[t.E_ONLY_IF_EMPTY=t.E_BLOCKED_BY_ITEMS|t.E_BLOCKED_BY_ACTORS]="E_ONLY_IF_EMPTY",t[t.E_ACTIVATE_DORMANT_MONSTER=p(27)]="E_ACTIVATE_DORMANT_MONSTER",t[t.E_AGGRAVATES_MONSTERS=p(28)]="E_AGGRAVATES_MONSTERS",t[t.E_RESURRECT_ALLY=p(29)]="E_RESURRECT_ALLY"}(A||(A={}));const T=r.flag.fl;var S;!function(t){t[t.HORDE_DIES_ON_LEADER_DEATH=T(0)]="HORDE_DIES_ON_LEADER_DEATH",t[t.HORDE_IS_SUMMONED=T(1)]="HORDE_IS_SUMMONED",t[t.HORDE_SUMMONED_AT_DISTANCE=T(2)]="HORDE_SUMMONED_AT_DISTANCE",t[t.HORDE_NO_PERIODIC_SPAWN=T(4)]="HORDE_NO_PERIODIC_SPAWN",t[t.HORDE_ALLIED_WITH_PLAYER=T(5)]="HORDE_ALLIED_WITH_PLAYER",t[t.HORDE_NEVER_OOD=T(15)]="HORDE_NEVER_OOD"}(S||(S={}));var y=Object.freeze({__proto__:null,get Depth(){return s},get Entity(){return n},get Actor(){return l},get Item(){return h},get Tile(){return f},get TileMech(){return u},get Cell(){return g},get Map(){return m},get Effect(){return A},get Horde(){return S}});class L{constructor(t,e,i){this.x=t,this.y=e,this.disposable=i}matches(t,e){return this.x===t&&this.y===e}}let I=0;class O{constructor(t){this._map=null,this.key=null,this.machineHome=0,this.depth=1,this.light=null,this.flags={entity:0},this.next=null,this.x=-1,this.y=-1,this.kind=t,this.id=""+ ++I}get map(){return this._map}addToMap(t,e,i){return this.x=e,this.y=i,this.setEntityFlag(n.L_ON_MAP),this._map!==t&&(this._map=t,this.kind.addToMap(this,t),!0)}removeFromMap(){this.clearEntityFlag(n.L_ON_MAP),this.kind.removeFromMap(this)}get sprite(){return this.kind.sprite}get isDestroyed(){return this.hasEntityFlag(n.L_DESTROYED)}isAt(t,e){return this.x===t&&this.y===e}clone(){const t=new this.constructor(this.kind);return t.copy(this),t}copy(t){this.depth=t.depth,this.light=t.light,Object.assign(this.flags,t.flags),this.next=t.next,this.x=t.x,this.y=t.y,this.kind=t.kind,this.id=t.id}canBeSeen(){return this.kind.canBeSeen(this)}destroy(){this.flags.entity|=n.L_DESTROYED}hasEntityFlag(t){return!!(this.flags.entity&t)}hasAllEntityFlags(t){return(this.flags.entity&t)===t}setEntityFlag(t){this.flags.entity|=t}clearEntityFlag(t){this.flags.entity&=~t}hasTag(t){return this.kind.tags.includes(t)}blocksMove(){return this.hasEntityFlag(n.L_BLOCKS_MOVE)}blocksVision(){return this.hasEntityFlag(n.L_BLOCKS_VISION)}blocksPathing(){return this.hasEntityFlag(n.L_BLOCKS_MOVE)}blocksEffects(){return this.hasEntityFlag(n.L_BLOCKS_EFFECTS)}isKey(t,e){return this.key&&this.key.matches(t,e)}forbidsCell(t){return this.kind.forbidsCell(t,this)}avoidsCell(t){return this.kind.avoidsCell(t,this)}getName(t){return this.kind.getName(this,t)}getDescription(t){return this.kind.getDescription(this,t)}getFlavor(t){return this.kind.getFlavor(this,t)}getVerb(t){return this.kind.getVerb(this,t)}drawStatus(t,e){return this.kind.drawStatus(this,t,e)}drawInto(t,e){t.drawSprite(this.sprite)}toString(){return`${this.constructor.name}-${this.id} @ ${this.x},${this.y}`}}class R{constructor(t){this.tags=[],this.requiredTileTags=[],this.id=t.id||t.name,this.name=t.name,this.flavor=t.flavor||this.name,this.description=t.description||this.flavor,this.sprite=r.sprite.make(t.sprite?t.sprite:t),t.tags&&("string"==typeof t.tags?this.tags=t.tags.split(/[,|]/).map((t=>t.trim())):this.tags=t.tags.slice()),t.requiredTileTags&&("string"==typeof t.requiredTileTags?this.requiredTileTags=t.requiredTileTags.split(/[,|]/).map((t=>t.trim())):this.requiredTileTags=t.requiredTileTags.slice().map((t=>t.trim())))}make(t){const e=new O(this);return this.init(e,t),e}init(t,e={}){e.machineHome&&(t.machineHome=e.machineHome)}addToMap(t,e){}removeFromMap(t){}canBeSeen(t){return!0}forbidsCell(t,e){return!(!this.requiredTileTags.length||t.hasAllTileTags(this.requiredTileTags))}avoidsCell(t,e){return!(!this.requiredTileTags.length||t.hasAnyTileTag(this.requiredTileTags))}getName(t,e){return this.name}getDescription(t,e){return this.description}getFlavor(t,e){return this.flavor}getVerb(t,e){return e}drawStatus(t,e,i){if(!t.map)return 0;if(t.isDestroyed)return 0;const s=new r.sprite.Mixer;return t.map.getAppearanceAt(t.x,t.y,s),e.drawSprite(i.x+1,i.y,s),e.wrapText(i.x+3,i.y,i.width-3,t.getName(),"purple"),1}}function C(t,e={}){return new R(t).make(e)}var v=Object.freeze({__proto__:null,KeyInfo:L,makeKeyInfo:function(t,e,i){return new L(t,e,i)},EntityKind:R,make:C,Entity:O});class N{constructor(t=[]){this._msgs=[],t.forEach((t=>this.add(t)))}add(t){return this._msgs.push(t),this}get(t,e=!0){const i=r.clamp(Math.floor(t*this._msgs.length),0,this._msgs.length-1),s=this._msgs[i];return this._format(s,e)}_format(t,e=!0){return t.replace(/\[(\w+)\|?(\w*)\]/g,e?"$1":"$2")}}const w={};class b{constructor(t={}){this._max={},this._rate={},this._value={},this.init(t)}get(t){return this._value[t]}getPct(t){return Math.round(100*this._value[t]/this._max[t])}max(t){return this._max[t]||0}regen(t){return this._rate[t]||null}init(t){for(let e in t)this.set(e,t[e])}set(t,e,i){if("number"!=typeof e){e=r.range.make(e).value()}this._value[t]=e,this._max[t]=i||e}gain(t,e,i=!1){"number"!=typeof e&&(e=r.range.value(e));let s=this._value[t]+e;i||(s=Math.min(s,this._max[t])),this._value[t]=s}drain(t,e){"number"!=typeof e&&(e=r.range.value(e)),this._value[t]=Math.max(0,this._value[t]-e)}raiseMax(t,e,i=!0){"number"!=typeof e&&(e=r.range.value(e)),this._max[t]+=e,i&&this.gain(t,e)}reduceMax(t,e,i=!1){"number"!=typeof e&&(e=r.range.value(e)),this._max[t]=Math.max(0,this._max[t]-e),i&&this.drain(t,e)}setRegen(t,e,i=1){const s=this._rate[t]=this._rate[t]||{elapsed:0};s.turns=e,s.count=i}regenAll(){for(let t in this._max){const e=this._rate[t];e.elapsed+=1,e.elapsed>=e.turns&&(this.gain(t,e.count),e.elapsed-=e.turns)}}restore(t,e){void 0===e&&(e=this._max[t]),this._value[t]=e}adjust(t,e,i){const s=(i=r.range.from(i)).value(),a=this.get(t);if("inc"===e)this.gain(t,i);else if("dec"===e)this.drain(t,i);else if("set"===e)this.set(t,i);else if("min"===e){const e=i.value();this.get(t)<e&&this.set(t,e)}else{if("max"!==e)throw new Error("Invalid stat adjust type: "+e);this.get(t)>s&&this.set(t,s)}return a!==this.get(t)}}class M{constructor(){this._set={},this._time={},this._count={},this._done={},this._value={},this.changed=null}clear(t){return this.clearTime(t),this.clearCount(t),this.setOff(t),this._update(t)}get(t){return this._value[t]||!1}has(t){return this._value[t]||!1}_addDone(t,e){e&&(this._done[t]||(this._done[t]=e))}setCount(t,e,i){return this._count[t]=Math.max(e,this._count[t]||0),this._addDone(t,i),this._update(t)}increment(t,e=1,i){"function"==typeof e&&(i=e,e=1);return this._count[t]=(this._count[t]||0)+e,this._addDone(t,i),this._update(t)}decrement(t,e=1){return this._count[t]=Math.max(0,(this._count[t]||0)-e),this._update(t)}clearCount(t){return this._count[t]=0,this._update(t)}setOn(t,e){return this._set[t]=!0,this._addDone(t,e),this._update(t)}setOff(t){return this._set[t]=!1,this._update(t)}setTime(t,e,i){e=r.range.make(e).value();const s=this._time[t]||0;return this._time[t]=Math.max(e,s),this._addDone(t,i),this._update(t)}addTime(t,e=1,i){"function"==typeof e&&(i=e,e=1);return e=r.range.make(e).value(),this._time[t]=(this._time[t]||0)+e,this._addDone(t,i),this._update(t)}removeTime(t,e=1){return e=r.range.make(e).value(),this._time[t]=Math.max(0,(this._time[t]||0)-e),this._update(t)}clearTime(t){return this._time[t]=0,this._update(t)}decayAllTimes(t=1){const e=this,i={};let s=!1;for(let r in e._time)this.removeTime(r,t)&&(s=!0,i[r]=!1);return!!s&&i}_update(t){const e=this,i=this._value;let s=i[t],r=i[t]=e._set[t]||e._time[t]>0||e._count[t]>0||!1;const a=this._done[t];return!r&&a&&(a(this,t),e._done[t]=null),(s&&!r||!(s||!r))&&(this.changed&&this.changed(this,t),!0)}}const F={};function D(t,e){F[t.toLowerCase()]=e}function x(t){return F[t.toLowerCase()]||null}class k extends O{constructor(t){super(t),this.ai=null,this.leader=null,this.items=null,this.fov=null,this.memory=null,this.visionDistance=99,this.data={},this._costMap=null,this.next=null,this.flags.actor=0,this.depth=s.ACTOR,this.kind=t,this.stats=new b,this.status=new M}copy(t){super.copy(t),this.leader=t.leader,this.items=t.items,this.fov=t.fov,this.memory=t.memory,this.visionDistance=t.visionDistance}destroy(){this.setEntityFlag(n.L_DESTROYED),this._costMap&&(r.grid.free(this._costMap),this._costMap=null)}hasActorFlag(t){return!!(this.flags.actor&t)}hasAllActorFlags(t){return(this.flags.actor&t)===t}actorFlags(){return this.flags.actor}setActorFlag(t){this.flags.actor|=t}clearActorFlag(t){this.flags.actor&=~t}isPlayer(){return this.hasActorFlag(l.IS_PLAYER)}isDead(){return this.hasEntityFlag(n.L_DESTROYED)}getAction(t){const e=this.kind.actions[t];return void 0===e||(!0===e?x(t)||!0:!1!==e&&e)}getBumpActions(){return this.kind.bump}canSee(t,e){return t instanceof O?this.canSee(t.x,t.y)&&this.kind.isAbleToSee(this,t):this.fov?this.fov.isDirectlyVisible(t,e):!!this.map&&(!(r.xy.distanceBetween(this.x,this.y,t,e)>this.visionDistance)&&r.xy.forLineBetween(this.x,this.y,t,e,((t,e)=>{if(this.map.cell(t,e).blocksVision())return!1})))}canSeeOrSense(t,e){return t instanceof O?this.canSeeOrSense(t.x,t.y)&&(this.kind.isAbleToSee(this,t)||this.kind.isAbleToSense(this,t)):this.fov?this.fov.isAnyKindOfVisible(t,e):this.canSee(t,e)}isAbleToSee(t){return this.kind.isAbleToSee(this,t)}isAbleToSense(t){return this.kind.isAbleToSense(this,t)}async act(t){if(this.ai){const e=await this.ai(t,this);if(e)return e}if(this.kind.ai){const e=await this.kind.ai(t,this);if(e)return e}return this.moveSpeed()}moveSpeed(){return this.kind.moveSpeed}startTurn(){}endTurn(t=100){return Math.floor(t*this.moveSpeed()/100)}willAttack(t){return!0}avoidsItem(t){return!1}canAddItem(t){return!1}addItem(t){}pickupItem(t,e){return this.kind.pickupItem(this,t,e)}dropItem(t,e){return this.kind.dropItem(this,t,e)}addToMap(t,e,i){const s=super.addToMap(t,e,i);return s&&this.setActorFlag(l.STALE_COST_MAP),s}removeFromMap(){super.removeFromMap(),this._costMap&&(r.grid.free(this._costMap),this._costMap=null)}costMap(){if(!this.map)throw new Error("Actor must have map to calculate costMap.");const t=this.hasActorFlag(l.STALE_COST_MAP);if(t&&this._costMap&&(r.grid.free(this._costMap),this._costMap=null),this._costMap){if(!t)return this._costMap}else this._costMap=r.grid.alloc(this.map.width,this.map.height);const e=this.kind,i=this.map;return this._costMap.update(((t,s,a)=>{const o=i.cell(s,a);return e.forbidsCell(o,this)?o.hasEntityFlag(n.L_BLOCKS_DIAGONAL)?r.path.OBSTRUCTION:r.path.FORBIDDEN:e.avoidsCell(o,this)?r.path.AVOIDED:r.path.OK})),this.clearActorFlag(l.STALE_COST_MAP),this._costMap}}const P={};function B(t,e){P[t.toLowerCase()]=e}const H={};function U(t,e){H[t]=e}function K(t){if(!t)throw new Error("opts required to make effect.");let e={};if("string"==typeof t)if(t.toLowerCase().startsWith("spread:")){const i=t.indexOf(":",8),s=t.substring(8,i);e={type:"spread:"+t.substring(i),effects:["tile:"+s]}}else e={type:"basic",effects:[t]};else"function"==typeof t?e={type:"basic",effects:[t]}:Array.isArray(t)?e={type:"basic",effects:t}:(t.effect&&(t.effects=[t.effect],delete t.effect),t.effects?(Object.assign(e,t),("string"==typeof e.effects||"function"==typeof e.effects)&&(e.effects=[t.effects])):(e.effects={},Object.entries(t).forEach((([t,i])=>{void 0!==P[t.toLowerCase()]||"function"==typeof i?e.effects[t]=i:e[t]=i}))));if(e.type=e.type||"basic","string"!=typeof e.type)throw new Error("Invalid effect type: "+JSON.stringify(e.type));const i=e.type.split(":").map((t=>t.trim())).shift(),s=H[i.toLowerCase()];if(!s)throw new Error("Invalid effect type: "+i);const r=s(e);return Array.isArray(e.effects)?e.effects.forEach((t=>{if("function"==typeof t)r.effects.push(t);else{const e=t.split(":").map((t=>t.trim()));if(1===e.length){const t=Y[e[0]];if(!t)throw new Error("Failed to find effect with id: "+e[0]);t.effects.push(t.trigger.bind(t))}else{const t=P[e[0].toLowerCase()];if(!t)throw new Error("Unknown effect: "+e[0]);e.shift(),r.effects.push(t(e))}}})):Object.entries(e.effects).forEach((([t,e])=>{const i=P[t.toLowerCase()];if(!i)throw new Error("Failed to find handler type: "+t);r.effects.push(i(e))})),e.next&&(r.next=K(e.next)),r}function V(t){if(!t)throw new Error("Cannot make effect from null | undefined");if("object"==typeof t&&"trigger"in t)return t;if("string"==typeof t){const e=Y[t];if(e)return e;throw new Error("Unknown effect - "+t)}return K(t)}const Y={};function G(t,e){const i="object"==typeof(s=e)&&"trigger"in s?e.clone():K(e);var s;return Y[t]=i,i}class W{constructor(t){var e,i,s,a;this.index=-1,this.dissipate=2e3,this.effects={},this.priority=50,this.depth=0,this.light=null,this.groundTile=null,this.tags=[],this.id=t.id||"n/a",this.dissipate=null!==(e=t.dissipate)&&void 0!==e?e:this.dissipate,this.priority=null!==(i=t.priority)&&void 0!==i?i:this.priority,this.depth=null!==(s=t.depth)&&void 0!==s?s:this.depth,this.light=t.light||null,this.groundTile=t.groundTile||null,this.sprite=r.sprite.make(t),this.name=t.name||"tile",this.description=t.description||this.name,this.flavor=t.flavor||this.name,this.article=null!==(a=t.article)&&void 0!==a?a:null,this.flags=t.flags||{entity:0,tile:0,tileMech:0},t.effects&&Object.assign(this.effects,t.effects),this.hasEffect("fire")&&(this.flags.tile|=f.T_IS_FLAMMABLE),t.tags&&("string"==typeof t.tags?t.tags.split(/[,|]/).map((t=>t.trim())).forEach((t=>{this.tags.push(t)})):this.tags=t.tags.slice().map((t=>t.trim())))}hasTag(t){return this.tags.includes(t)}hasAnyTag(t){return r.arraysIntersect(this.tags,t)}hasAllTags(t){return t.every((t=>this.tags.includes(t)))}hasEntityFlag(t){return!!(this.flags.entity&t)}hasTileFlag(t){return!!(this.flags.tile&t)}hasTileMechFlag(t){return!!(this.flags.tileMech&t)}hasAllEntityFlags(t){return(this.flags.entity&t)===t}hasAllTileFlags(t){return(this.flags.tile&t)===t}hasAllTileMechFlags(t){return(this.flags.tileMech&t)===t}blocksVision(){return!!(this.flags.entity&n.L_BLOCKS_VISION)}blocksMove(){return!!(this.flags.entity&n.L_BLOCKS_MOVE)}blocksPathing(){return this.blocksMove()||this.hasTileFlag(f.T_PATHING_BLOCKER)}blocksEffects(){return!!(this.flags.entity&n.L_BLOCKS_EFFECTS)}hasEffect(t){return t in this.effects}getName(t){let e={};if("boolean"==typeof t||"string"==typeof t?e.article=t:t&&(e=t),!e.article&&!e.color)return this.name;let i=this.name;if(e.color){let t=e.color;!0===e.color&&(t=this.sprite.fg||"white"),"string"!=typeof t&&(t=r.color.from(t).toString()),i=`Ω${t}Ω${this.name}∆`}if(e.article){i=("string"==typeof e.article?e.article:this.article||"a")+" "+i}return i}getDescription(t){return this.description||this.getName(t)}getFlavor(t){return this.flavor||this.getName(t)}}function j(t){var e,i,a,o,l,h;let c={effects:{},flags:{},sprite:{},priority:50};if(t.extends&&(c=X[t.extends],!c))throw new Error("Failed to find base tile: "+t.extends);let _=c.priority;if("string"==typeof t.priority){let e=t.priority.replace(/ /g,""),i=e.search(/[+-]/);if(0==i)_=c.priority+Number.parseInt(e);else if(-1==i)if(0==e.search(/[a-zA-Z]/)){const t=X[e];if(!t)throw new Error("Failed to find tile for priority - "+e+".");_=t.priority}else _=Number.parseInt(e);else{const t=e.substring(0,i),s=Number.parseInt(e.substring(i)),r=X[t];if(!r)throw new Error("Failed to find tile for priority - "+t+".");_=r.priority+s}}else void 0!==t.priority&&(_=t.priority);const d={};Object.assign(d,c.effects),t.effects&&Object.entries(t.effects).forEach((([t,e])=>{if(null!==e)if("string"!=typeof e||e.includes(":"))try{d[t]=K(e)}catch(i){throw new Error(`Failed to add effect to tile => ${t} : ${JSON.stringify(e)} : `+i.message)}else d[t]=e;else delete d[t]}));const g={entity:r.flag.from(n,c.flags.entity,t.flags),tile:r.flag.from(f,c.flags.tile,t.flags),tileMech:r.flag.from(u,c.flags.tileMech,t.flags)};let E=c.depth||0;t.depth&&(E="string"==typeof t.depth?s[t.depth]:t.depth);let m=c.light;t.light?m=r.light.make(t.light):null===t.light&&(m=null);const p={id:t.id,flags:g,dissipate:null!==(e=t.dissipate)&&void 0!==e?e:c.dissipate,effects:d,priority:_,depth:E,light:m,groundTile:t.groundTile||null,ch:null!==(i=t.ch)&&void 0!==i?i:c.sprite.ch,fg:null!==(a=t.fg)&&void 0!==a?a:c.sprite.fg,bg:null!==(o=t.bg)&&void 0!==o?o:c.sprite.bg,opacity:null!==(l=t.opacity)&&void 0!==l?l:c.sprite.opacity,name:t.name||c.name,description:t.description||c.description,flavor:t.flavor||c.flavor,article:null!==(h=t.article)&&void 0!==h?h:c.article,tags:t.tags||null};return new W(p)}const X={},q=[];function z(t){return t instanceof W?t:"string"==typeof t?X[t]||null:q[t]||null}function Q(t,...e){let i=e[0];2==e.length&&(i=e[1],i.extends=e[0]),i.id=t;const s=j(i);return s.index=q.length,q.push(s),X[t]=s,s}const $={Tile:f,TileMech:u};var J=Object.freeze({__proto__:null,flags:$,Tile:W,make:j,tiles:X,all:q,get:z,install:Q,installAll:function(t){Object.entries(t).forEach((([t,e])=>{Q(t,e)}))}});class Z{constructor(t){this.effects=[],this.chance=1e4,this.seen=!1,this.flags=0,this.next=null,"object"!=typeof t||Array.isArray(t)||(this.flags=r.flag.from(A,t.flags),this.chance=Number.parseInt(t.chance||"10000"))}clone(){const t=new this.constructor;return t.effects=this.effects.slice(),t.chance=this.chance,t.seen=!1,t.flags=this.flags,t.next=this.next,t}trigger(t,e={}){if(!e.force&&this.chance){if(!(e.rng||t.map.rng||r.random).chance(this.chance,1e4))return!1}let i=!1;for(let s of this.effects)s(t,e)&&(i=!0);if(this.next){const s=!!(this.flags&A.E_NEXT_ALWAYS);if(i||s)return this.next.trigger(t,e)}return i}}function tt(t){return"object"!=typeof t?new Z:new Z(t)}function et(t){return new it(t)}U("basic",tt),U("spread",et);class it extends Z{constructor(t){if(super(t),this.grow=0,this.decrement=0,this.matchTile="",t||(t={grow:0,decrement:0,flags:0}),"string"==typeof t&&(t=t.split(":").map((t=>t.trim()))),Array.isArray(t))"spread"===t[0].toLowerCase()&&t.shift(),t={grow:t[0]||"0",decrement:t[1]||"100",flags:t[2]||"0"};else if("string"==typeof t.type&&t.type.includes(":")){const e=t.type.split(":").map((t=>t.trim()));"spread"===e[0].toLowerCase()&&e.shift(),t.grow=e[0]||"0",t.decrement=e[1]||"100",t.flags=t.flags+"|"+e[2]}this.grow=Number.parseInt(t.grow||0),this.decrement=Number.parseInt(t.decrement||100),this.flags=r.flag.from(A,t.flags||0),this.matchTile=t.matchTile||""}clone(){const t=super.clone();return t.grow=this.grow,t.decrement=this.decrement,t.matchTile=this.matchTile,t}trigger(t,e={}){const i=!!(this.flags&A.E_ABORT_IF_BLOCKS_MAP);let s=!1;const a=t.map,n=r.grid.alloc(a.width,a.height);if(s=at(this,t,n),!s)return r.grid.free(n),!1;if(i&&st(a,n))return r.grid.free(n),!1;if(this.flags&A.E_EVACUATE_CREATURES&&ot(a,n)&&(s=!0),this.flags&A.E_EVACUATE_ITEMS&&lt(a,n)&&(s=!0),this.flags&A.E_CLEAR_CELL&&nt(a,n,this.flags)&&(s=!0),n.forEach(((t,i,r)=>{if(t){n[i][r]=1;for(let t of this.effects)t({map:a,x:i,y:r},e)&&(s=!0,n[i][r]=2)}})),this.next){const i=!!(this.flags&A.E_NEXT_ALWAYS);(s||i)&&(this.flags&A.E_NEXT_EVERYWHERE?n.forEach(((t,s,r)=>{t&&(2==t||i)&&this.next.trigger({map:a,x:s,y:r},e)})):this.next.trigger({map:a,x:t.x,y:t.y},e))}return r.grid.free(n),s}}function st(t,e,i=0,s=0){const a=r.grid.alloc(t.width,t.height);let n=!1;r.xy.forRect(t.width,t.height,((r,o)=>{const l=r+i,h=o+s;e.get(l,h)?t.cell(r,o).isStairs()&&(n=!0):t.cell(r,o).blocksMove()||(a[r][o]=1)}));let o=!0;for(let t=0;t<a.width&&!n;++t)for(let e=0;e<a.height&&!n;++e)1==a[t][e]&&(o?(a.floodFill(t,e,1,2),o=!1):n=!0);return r.grid.free(a),n}function rt(t,e,i,s,a){if(!e.hasXY(i,s))return!1;const n=e.cell(i,s);if(n.hasCellFlag(g.EVENT_PROTECTED))return!1;if(n.blocksEffects()&&!t.matchTile&&!a)return!1;if(t.flags&A.E_BUILD_IN_WALLS){if(!e.cell(i,s).isWall())return!1}else if(t.flags&A.E_MUST_TOUCH_WALLS){let t=!1;if(r.xy.eachNeighbor(i,s,((i,s)=>{e.cell(i,s).isWall()&&(t=!0)}),!0),!t)return!1}else if(t.flags&A.E_NO_TOUCH_WALLS){let t=!0;if(e.cell(i,s).isWall())return!1;if(r.xy.eachNeighbor(i,s,((i,s)=>{e.cell(i,s).isWall()&&(t=!1)}),!0),!t)return!1}return!(t.matchTile&&!a&&!n.hasTile(t.matchTile))}function at(t,e,i){let s,a,n,o,l,h,c;const f=e.map;let _=t.grow||0,u=t.decrement||0;if(i.fill(0),!rt(t,f,e.x,e.y,!0))return!1;i[e.x][e.y]=o=1;let d=1;if(_)for(c=!0,_>=100&&(u=u||100),u<=0&&(u=_);c&&_>0;){for(c=!1,o++,s=0;s<f.width;s++)for(a=0;a<f.height;a++)if(i[s][a]==o-1)for(n=0;n<4;n++)l=s+r.xy.DIRS[n][0],h=a+r.xy.DIRS[n][1],i.hasXY(l,h)&&!i[l][h]&&f.rng.chance(_)&&rt(t,f,l,h,!1)&&(i[l][h]=o,c=!0,++d);_-=u}return d>0}function nt(t,e,i=0){let r=!1;const a=(i&A.E_CLEAR_CELL)===A.E_CLEAR_CELL;return e.forEach(((e,n,o)=>{if(!e)return;const l=t.cell(n,o);a?l.clear():(i&A.E_CLEAR_GAS&&l.clearDepth(s.GAS),i&A.E_CLEAR_LIQUID&&l.clearDepth(s.LIQUID),i&A.E_CLEAR_SURFACE&&l.clearDepth(s.SURFACE),i&A.E_CLEAR_GROUND&&l.clearDepth(s.GROUND)),r=!0})),r}function ot(t,e){let i=!1;return t.eachActor((s=>{if(!e[s.x][s.y])return;const r=t.rng.matchingLocNear(s.x,s.y,((i,r)=>{if(!t.hasXY(i,r))return!1;if(e[i][r])return!1;const a=t.cell(i,r);return!s.forbidsCell(a)}));r&&r[0]>=0&&r[1]>=0&&(t.removeActor(s),t.addActor(r[0],r[1],s),i=!0)})),i}function lt(t,e){let i=!1;return t.eachItem((s=>{if(!e[s.x][s.y])return;const r=t.rng.matchingLocNear(s.x,s.y,((i,r)=>{if(!t.hasXY(i,r))return!1;if(e[i][r])return!1;const a=t.cell(i,r);return!s.forbidsCell(a)}));r&&r[0]>=0&&r[1]>=0&&(t.removeItem(s),t.addItem(r[0],r[1],s),i=!0)})),i}function ht(t){if(Array.isArray(t)&&(t=t[0]),"string"!=typeof t)throw new Error("Invalid EMIT handler config - "+t);return ct.bind(void 0,t)}function ct(t,e,i){return e.map.events.emit(t,e,i)}function ft(t){if(Array.isArray(t)&&(t=t[0]),"string"!=typeof t)throw new Error("Need message for message effect.");const e={msg:t};return _t.bind(void 0,e)}function _t(t,e,i){const s=i.seen,a=t.msg;return!(!(a&&a.length&&i.aware)||s)&&(r.message.addAt(e.x,e.y,a,i),!0)}function ut(){return dt.bind(void 0)}function dt(t,e){const i=t.map.cell(t.x,t.y).machineId;return!!i&&t.map.activateMachine(i,t.x,t.y,e)}function gt(t){if(!t)throw new Error("Tile effect needs configuration.");if("string"==typeof t)t={id:t};else if(Array.isArray(t))t={id:t[0]};else if(!t.id)throw new Error("Tile effect needs configuration with id.");const e=t;return e.id.includes("!")&&(e.superpriority=!0),e.id.includes("~")&&(e.blockedByActors=!0,e.blockedByItems=!0),e.id=e.id.replace(/[!~]*/g,""),Et.bind(e)}function Et(t,e){this.machine=e.machine||0;return t.map.setTile(t.x,t.y,this.id,this)}function mt(t){let e=0;if(t)if("number"==typeof t)e=t;else{if("string"!=typeof t)throw new Error("Invalid config for clear effect: "+JSON.stringify(t));e=t.split(/[,|]/g).reduce(((t,e)=>{if("number"==typeof e)return t|e;return t|(s[e]||0)}),0)}else e=s.ALL_LAYERS;return pt.bind(void 0,e)}function pt(t,e,i){if(!t)return!1;return e.map.cell(e.x,e.y).clearDepth(t)}function At(t){if(Array.isArray(t)&&(t=t[0]),t&&"string"!=typeof t&&(t=t.id),!t||!t.length)throw new Error("Feature effect needs ID");return Tt.bind(void 0,t)}function Tt(t,e,i){const s=Y[t];if(!s)throw new Error("Failed to find feature: "+t);return s.trigger(e,i)}function St(t){if(!t)throw new Error("Invalid Nourish config.");let e={};if("string"==typeof t&&(t=t.split(":").map((t=>t.trim()))),Array.isArray(t))e.type=t[0]||"inc",e.amount=r.range.make(t[1]||1);else{if(!t.type&&!t.amount)throw new Error("Invalid Nourish config: "+JSON.stringify(t));e.type=t.type||"inc",e.amount=r.range.make(t.amount||1)}return yt.bind(void 0,e)}function yt(t,e,i){if(!t.amount)return!1;const s=e.map.actorAt(e.x,e.y);if(!s)return!1;const a=s.stats,n=a.get("food");if(!a.adjust("food",t.type,t.amount))return!1;const o=a.get("food");return o<n&&o/a.max("food")<.1&&r.message.addAt(s.x,s.y,yt.default.pukeMsg,{actor:s}),!0}function Lt(t){if(!t)throw new Error("Invalid Stat config.");const e={};if("string"==typeof t&&(t=t.split(":").map((t=>t.trim()))),Array.isArray(t))e.stat=t[0],e.type=t[1]||"inc",e.amount=r.range.make(t[2]||1);else{if(!t.type&&!t.amount)throw new Error("Invalid stat effect configuration: "+JSON.stringify(t));e.stat=t.stat,e.type=t.type||"inc",e.amount=r.range.make(e.amount||1)}return It.bind(void 0,e)}function It(t,e,i){if(!t.amount)return!1;const s=e.map.actorAt(e.x,e.y);if(!s)return!1;return!!s.stats.adjust("food",t.type,t.amount)}B("emit",ht),B("msg",ft),B("activateMachine",ut),B("tile",gt),B("clear",mt),B("feature",At),B("effect",At),B("id",At),yt.default={pukeMsg:"%you vomit."},B("nourish",St),B("stat",Lt);var Ot=Object.freeze({__proto__:null,handlers:P,installHandler:B,effectTypes:H,installType:U,make:K,from:V,installedEffects:Y,install:G,installAll:function(t){Object.entries(t).forEach((([t,e])=>{G(t,e)}))},resetAll:function(){Object.values(Y).forEach((t=>t.seen=!1))},BasicEffect:Z,makeBasicEffect:tt,makeSpreadEffect:et,SpreadEffect:it,mapDisruptedBy:st,computeSpawnMap:at,clearCells:nt,evacuateCreatures:ot,evacuateItems:lt,makeEmitHandler:ht,emitEffect:ct,makeMessageHandler:ft,messageEffect:_t,makeActivateMachine:ut,activateMachine:dt,makeTileHandler:gt,tileEffect:Et,makeClearHandler:mt,clearEffect:pt,makeFeatureHandler:At,featureEffect:Tt,makeNourishEffect:St,nourishEffect:yt,makeStatEffect:Lt,statEffect:It});r.color.install("cellStatusName","light_blue");class Rt{constructor(t,e,i,s){if(this.chokeCount=0,this.machineId=0,this.x=-1,this.y=-1,this.flags={cell:g.NEEDS_REDRAW},this.tiles=[X.NULL],this.map=t,this.x=e,this.y=i,this.snapshot=r.sprite.makeMixer(),s){const t=z(s);this.setTile(t)}}getSnapshot(t){t.copy(this.snapshot)}putSnapshot(t){this.snapshot.copy(t)}get hasStableSnapshot(){return this.hasCellFlag(g.STABLE_SNAPSHOT)}get hasStableMemory(){return this.hasCellFlag(g.STABLE_MEMORY)}copy(t){Object.assign(this.flags,t.flags),this.chokeCount=t.chokeCount,this.tiles.length=t.tiles.length;for(let e=0;e<this.tiles.length;++e)this.tiles[e]=t.tiles[e];this.machineId=t.machineId,this.map=t.map,this.x=t.x,this.y=t.y,t.getSnapshot(this.snapshot)}hasCellFlag(t){return!!(this.flags.cell&t)}setCellFlag(t){this.flags.cell|=t}clearCellFlag(t){this.flags.cell&=~t}hasEntityFlag(t,e=!1){var i,s;return!!this.tiles.some((e=>e&&e.flags.entity&t))||!!e&&(!(!this.hasItem()||!(null===(i=this.item)||void 0===i?void 0:i.hasEntityFlag(t)))||!(!this.hasActor()||!(null===(s=this.actor)||void 0===s?void 0:s.hasEntityFlag(t))))}hasAllEntityFlags(t,e=!1){return(this.entityFlags(e)&t)==t}hasTileFlag(t){return this.tiles.some((e=>e&&e.flags.tile&t))}hasAllTileFlags(t){return(this.tileFlags()&t)==t}hasTileMechFlag(t){return this.tiles.some((e=>e&&e.flags.tileMech&t))}hasAllTileMechFlags(t){return(this.tileMechFlags()&t)==t}hasTileTag(t){return this.tiles.some((e=>e&&e.hasTag(t)))}hasAllTileTags(t){return this.tiles.some((e=>e&&e.hasAllTags(t)))}hasAnyTileTag(t){return this.tiles.some((e=>e&&e.hasAnyTag(t)))}cellFlags(){return this.flags.cell}entityFlags(t=!1){var e,i;let s=this.tiles.reduce(((t,e)=>t|(e?e.flags.entity:0)),0);return t&&(this.hasItem()&&(s|=(null===(e=this.item)||void 0===e?void 0:e.flags.entity)||0),this.hasActor()&&(s|=(null===(i=this.actor)||void 0===i?void 0:i.flags.entity)||0)),s}tileFlags(){return this.tiles.reduce(((t,e)=>t|(e?e.flags.tile:0)),0)}tileMechFlags(){return this.tiles.reduce(((t,e)=>t|(e?e.flags.tileMech:0)),0)}get needsRedraw(){return!!(this.flags.cell&g.NEEDS_REDRAW)}set needsRedraw(t){t?(this.flags.cell|=g.NEEDS_REDRAW,this.flags.cell&=~g.STABLE_SNAPSHOT,this.map.needsRedraw=!0):this.flags.cell&=~g.NEEDS_REDRAW}get changed(){return!!(this.flags.cell&g.CHANGED)}depthPriority(t){const e=this.tiles[t];return e?e.priority:X.NULL.priority}highestPriority(){return this.tiles.reduce(((t,e)=>Math.max(t,e?e.priority:0)),X.NULL.priority)}depthTile(t){return this.tiles[t]||null}hasTile(t){return t?(t instanceof W||(t=z(t)),this.tiles.includes(t)):this.tiles.some((t=>t))}hasDepthTile(t){const e=this.tiles[t];return!!e&&e!==X.NULL}highestPriorityTile(){return this.tiles.reduce(((t,e)=>e&&e.priority>=t.priority?e:t),X.NULL)}get tile(){return this.highestPriorityTile()}eachTile(t){this.tiles.forEach((e=>e&&t(e)))}tileWithObjectFlag(t){return this.tiles.find((e=>e&&e.flags.entity&t))||null}tileWithFlag(t){return this.tiles.find((e=>e&&e.flags.tile&t))||null}tileWithMechFlag(t){return this.tiles.find((e=>e&&e.flags.tileMech&t))||null}blocksVision(){return this.tiles.some((t=>t&&t.blocksVision()))}blocksPathing(){return this.tiles.some((t=>t&&t.blocksPathing()))}blocksMove(){return this.tiles.some((t=>t&&t.blocksMove()))}blocksEffects(){return this.tiles.some((t=>t&&t.blocksEffects()))}blocksLayer(t){return this.tiles.some((e=>e&&!!(e.flags.tile&$.Tile.T_BLOCKS_OTHER_LAYERS)&&e.depth!=t))}isNull(){return this.tiles.every((t=>!t||t===X.NULL))}isPassable(){return!this.blocksMove()}isWall(){return this.hasAllEntityFlags(n.L_WALL_FLAGS)}isStairs(){return this.hasTileFlag(f.T_HAS_STAIRS)}isFloor(){return!this.hasEntityFlag(n.L_BLOCKS_EVERYTHING)&&!this.hasTileFlag(f.T_PATHING_BLOCKER)}isGateSite(){return this.hasCellFlag(g.IS_GATE_SITE)}isSecretlyPassable(){return this.hasEntityFlag(n.L_SECRETLY_PASSABLE)}setTile(t,e={}){if(!(t instanceof W||(t=z(t))))return!1;const i=this.tiles[t.depth]||X.NULL;if(i===t)return!1;if(!e.superpriority&&i.priority>t.priority)return!1;if(this.blocksLayer(t.depth))return!1;if(e.blockedByItems&&this.hasItem())return!1;if(e.blockedByActors&&this.hasActor())return!1;if(e.blockedByOtherLayers&&this.highestPriority()>t.priority)return!1;if(t.depth>s.GROUND&&t.groundTile){const e=this.depthTile(s.GROUND);e&&e!==X.NULL||(this.tiles[0]=z(t.groundTile))}return this.tiles[t.depth]=t,this.needsRedraw=!0,t.hasEntityFlag(n.L_BLOCKS_SURFACE)&&this.clearDepth(s.SURFACE),e.machine&&(this.machineId=e.machine),i.light!==t.light&&(this.map.light.glowLightChanged=!0),i.hasEntityFlag(n.L_LIST_IN_SIDEBAR)!==t.hasEntityFlag(n.L_LIST_IN_SIDEBAR)&&this.map.setMapFlag(m.MAP_SIDEBAR_TILES_CHANGED),t.hasTileFlag(f.T_IS_FIRE)&&this.setCellFlag(g.CAUGHT_FIRE_THIS_TURN),!0}clearTiles(t){this.tiles[0]=X.NULL;for(let t=1;t<this.tiles.length;++t)this.tiles[t]=null;t&&this.setTile(t),this.needsRedraw=!0}clear(t){this.tiles=[X.NULL],this.flags.cell=0,this.needsRedraw=!0,this.chokeCount=0,this.machineId=0,t&&this.setTile(t),this.snapshot.blackOut()}clearDepth(t){return 0==t?(this.tiles[0]=X.NULL,this.needsRedraw=!0,!0):null!==this.tiles[t]&&(this.tiles[t]=null,this.needsRedraw=!0,!0)}clearDepthsWithFlags(t,e=0){for(let i=0;i<this.tiles.length;++i){const s=this.tiles[i];s&&(s.hasTileFlag(t)&&(e&&!s.hasTileMechFlag(e)||this.clearDepth(i)))}}eachGlowLight(t){this.tiles.forEach((e=>{e&&e.light&&t(e.light)}))}tileWithEffect(t){return this.tiles.find((e=>null==e?void 0:e.hasEffect(t)))||null}fireEvent(t,e={}){let i=!1;for(const s of this.tiles){if(!s||!s.effects)continue;const r=s.effects[t];if(r){this._activate(r,e)&&(i=!0)}}return i}_activate(t,e){"string"==typeof t&&(t=Y[t]);let i=!1;return t&&(i=t.trigger(this,e)),i}hasEffect(t){for(let e of this.tiles)if(e&&e.hasEffect(t))return!0;return!1}hasItem(){return this.hasCellFlag(g.HAS_ITEM)}get item(){return this.map.itemAt(this.x,this.y)}canAddItem(t){return!0}canRemoveItem(t){return!0}_addItem(t){return this.setCellFlag(g.HAS_ITEM),this.needsRedraw=!0,!0}_removeItem(t){let e=!1,i=-1;return this.map.items.forEach(((s,r)=>{s===t?i=r:s.x===this.x&&s.y===this.y&&(e=!0)})),e||this.clearCellFlag(g.HAS_ITEM),!(i<0)&&(this.needsRedraw=!0,!0)}hasActor(){return this.hasCellFlag(g.HAS_ACTOR)}hasPlayer(){return this.hasCellFlag(g.HAS_PLAYER)}get actor(){return this.map.actorAt(this.x,this.y)}canAddActor(t){return!0}canRemoveActor(t){return!0}_addActor(t){return this.setCellFlag(g.HAS_ACTOR),t.isPlayer()&&this.setCellFlag(g.HAS_PLAYER),this.needsRedraw=!0,!0}_removeActor(t){let e=!1,i=-1;return this.map.actors.forEach(((s,r)=>{s===t?i=r:s.x===this.x&&s.y===this.y&&(e=!0)})),e||this.clearCellFlag(g.HAS_ACTOR|g.HAS_PLAYER),!(i<0)&&(this.needsRedraw=!0,!0)}hasFx(){return!!(this.flags.cell&g.HAS_FX)}get fx(){return this.map.fxAt(this.x,this.y)}_addFx(t){this.setCellFlag(g.HAS_FX),this.needsRedraw=!0}_removeFx(t){this.fx||this.clearCellFlag(g.HAS_FX),this.needsRedraw=!0}getDescription(){return this.highestPriorityTile().description}getFlavor(){return this.highestPriorityTile().flavor}getName(t={}){return this.highestPriorityTile().getName(t)}dump(){if(this.hasActor()){const t=this.map.actorAt(this.x,this.y);if(t&&t.sprite.ch)return t.sprite.ch}if(this.hasItem()){const t=this.map.itemAt(this.x,this.y);if(t&&t.sprite.ch)return t.sprite.ch}return this.hasTileFlag(f.T_BRIDGE)?"=":this.highestPriorityTile().sprite.ch||" "}drawStatus(t,e){return t.wrapText(e.x+1,e.y,e.width-1,this.getName(),"cellStatusName")}toString(){return`Cell @ ${this.x},${this.y}`}}class Ct{constructor(t,e="layer"){this.changed=!1,this.map=t,this.depth=-1,this.properties={},this.name=e}copy(t){}clear(){}setTile(t,e,i,s){return!1}clearTile(t,e){return!1}addActor(t,e,i){return!1}forceActor(t,e,i){return!1}removeActor(t){return!1}addItem(t,e,i){return!1}forceItem(t,e,i){return!1}removeItem(t){return!1}tick(t){return!1}}class vt extends Ct{constructor(t,e="tile"){super(t,e)}setTile(t,e,i,s){return this.map.cell(t,e).setTile(i,s)}clearTile(t,e){return this.map.cell(t,e).clearDepth(this.depth)}tick(t){return!0}}class Nt extends vt{constructor(t,e="gas"){super(t,e),this.volume=r.grid.alloc(t.width,t.height,0)}clear(){this.volume.fill(0)}setTile(t,e,i,s={}){if(!s.volume)return!1;return this.map.cell(t,e).depthTile(i.depth)===i?(this.volume[t][e]+=s.volume,!0):!!super.setTile(t,e,i,s)&&(this.volume[t][e]=s.volume,this.changed=!0,!0)}clearTile(t,e){return!!this.map.cell(t,e).clearDepth(this.depth)&&(this.volume[t][e]=0,!0)}copy(t){this.volume.copy(t.volume),this.changed=t.changed}tick(t){if(!this.changed)return!1;this.changed=!1;const e=this.volume;return this.volume=r.grid.alloc(this.map.width,this.map.height),this.dissipate(e),this.spread(e),r.grid.free(e),!0}dissipate(t){t.update(((t,e,i)=>{if(!t)return 0;const s=this.map.cell(e,i).depthTile(this.depth);if(s&&s.dissipate){let e=Math.max(.5,t*s.dissipate/1e4);t=Math.max(0,t-e)}return t?this.changed=!0:this.clearTile(e,i),t}))}calcOpacity(t){return Math.floor(10*Math.min(t,10))}updateCellVolume(t,e,i){let s=0,r=0,a=0;const o=this.map.cell(t,e);let l=o.depthTile(this.depth),h=l;if(o.hasEntityFlag(n.L_BLOCKS_GAS))return this.volume[t][e]=0,void(i[t][e]&&this.clearTile(t,e));for(let l=Math.max(0,t-1);l<Math.min(t+2,i.width);++l)for(let t=Math.max(0,e-1);t<Math.min(e+2,i.height);++t){const e=i[l][t];o.hasEntityFlag(n.L_BLOCKS_GAS)||(++r,e>a&&(a=e,h=this.map.cell(l,t).depthTile(this.depth))),s+=e}const c=Math.floor(10*s/r)/10;this.volume[t][e]=c,c>0&&h&&(l&&l===h||o.setTile(h)),c>0&&(o.needsRedraw=!0)}spread(t){for(let e=0;e<t.width;++e)for(let i=0;i<t.height;++i)this.updateCellVolume(e,i,t)}}const wt=s,bt=n,Mt=f,Ft=u,Dt=g;class xt extends vt{constructor(t,e="tile"){super(t,e)}tick(t){for(let t=0;t<this.map.width;++t)for(let e=0;e<this.map.height;++e){this.map.cell(t,e).clearCellFlag(Dt.CAUGHT_FIRE_THIS_TURN)}for(let t=0;t<this.map.width;++t)for(let e=0;e<this.map.height;++e){const i=this.map.cell(t,e);if(i.hasTileFlag(Mt.T_IS_FIRE)&&!(i.flags.cell&Dt.CAUGHT_FIRE_THIS_TURN)){this.exposeToFire(t,e,!1);for(let i=0;i<4;++i){const s=r.xy.DIRS[i];this.exposeToFire(t+s[0],e+s[1])}}}return!0}exposeToFire(t,e,i=!1){let s=0,a=0,n=0,o=!1,l=!1;const h=this.map.cell(t,e);if(!h.hasTileFlag(Mt.T_IS_FLAMMABLE))return!1;if(h.eachTile((t=>{t.hasTileFlag(Mt.T_EXTINGUISHES_FIRE)&&t.priority>a&&(a=t.priority)})),h.eachTile((t=>{if(t.flags.tile&Mt.T_IS_FLAMMABLE&&(t.depth===wt.GAS||t.priority>=a)){const e=V(t.effects.fire);e&&e.chance>s&&(s=e.chance)}})),i||s&&this.map.rng.chance(s,1e4)){o=!0,h.hasTileMechFlag(Ft.TM_EXPLOSIVE_PROMOTE)&&(r.xy.eachNeighbor(t,e,((t,e)=>{const i=this.map.cell(t,e);(i.hasEntityFlag(bt.L_BLOCKS_GAS)||i.hasTileFlag(Mt.T_IS_FIRE)||i.hasTileMechFlag(Ft.TM_EXPLOSIVE_PROMOTE))&&++n})),n>=8&&(l=!0));let i="fire";l&&h.hasEffect("explode")&&(i="explode"),h.fireEvent(i,{force:!0}),h.needsRedraw=!0}return o}}var kt=Object.freeze({__proto__:null,MapLayer:Ct,TileLayer:vt,GasLayer:Nt,FireLayer:xt});class Pt{isAnyKindOfVisible(t){return!0}drawInto(t,e,i={}){const s=t instanceof r.buffer.Buffer?t:t.buffer,a=i.offsetX||0,n=i.offsetY||0,o=new r.sprite.Mixer;for(let t=0;t<s.width;++t)for(let r=0;r<s.height;++r)if(e.hasXY(t+a,r+n)){const l=e.cell(t+a,r+n);this.drawCell(o,l,i.fov),s.drawSprite(t,r,o)}}drawCell(t,e,i){t.blackOut();const s=!e.hasCellFlag(g.STABLE_SNAPSHOT);return e.needsRedraw||s?(this.getAppearance(t,e),e.putSnapshot(t),e.needsRedraw=!1,e.setCellFlag(g.STABLE_SNAPSHOT)):e.getSnapshot(t),this.applyLight(t,e,i),e.hasEntityFlag(n.L_VISUALLY_DISTINCT|n.L_LIST_IN_SIDEBAR,!0)&&([t.fg,t.bg]=r.color.separate(t.fg,t.bg)),!0}getAppearance(t,e){const i=e.tiles[s.GROUND],a=e.tiles[s.SURFACE],n=e.tiles[s.LIQUID],o=e.tiles[s.GAS];if(t.drawSprite(i.sprite),a&&t.drawSprite(a.sprite),n&&t.drawSprite(n.sprite),e.hasItem()){const i=e.map.itemAt(e.x,e.y);i&&i.drawInto(t)}if(e.hasActor()){const i=e.map.actorAt(e.x,e.y);i&&i.drawInto(t)}if(o){const e=r.rng.cosmetic.number(50)+25;t.drawSprite(o.sprite,e)}if(e.hasFx()){const i=e.map.fxAt(e.x,e.y);i&&t.drawSprite(i.sprite)}t.dances?e.setCellFlag(g.COLORS_DANCE):e.clearCellFlag(g.COLORS_DANCE),t.bake()}applyLight(t,e,i){const s=!i||i.isAnyKindOfVisible(e.x,e.y),r=!i||i.isRevealed(e.x,e.y),a=e.map.light.getLight(e.x,e.y);t.multiply(a),i&&i.isCursor(e.x,e.y)?t.invert():s||(r?t.scale(50):t.blackOut())}}class Bt{constructor(t,e,i={}){this.rng=r.rng.random,this.actors=[],this.items=[],this.fx=[],this._animations=[],this.events=new r.events.EventEmitter,this.flags={map:0},this.layers=[],this.properties={seed:0,machineCount:0},i.id&&(this.properties.id=i.id),this.drawer=i.drawer||new Pt,this.cells=r.grid.make(t,e,((t,e)=>new Rt(this,t,e))),i.seed&&(this.properties.seed=i.seed,this.rng=r.rng.make(i.seed)),this.light=new r.light.LightSystem(this,i),this.initLayers()}get seed(){return this.properties.seed}set seed(t){this.properties.seed=t,this.rng=r.rng.make(t)}get width(){return this.cells.width}get height(){return this.cells.height}initLayers(){this.addLayer(s.GROUND,new vt(this,"ground")),this.addLayer(s.SURFACE,new xt(this,"surface")),this.addLayer(s.GAS,new Nt(this,"gas"))}addLayer(t,e){"number"!=typeof t&&(t=s[t]),e.depth=t,this.layers[t]=e}removeLayer(t){if("number"!=typeof t&&(t=s[t]),!t)throw new Error("Cannot remove layer with depth=0.");delete this.layers[t]}getLayer(t){return"number"!=typeof t&&(t=s[t]),this.layers[t]||null}hasXY(t,e){return this.cells.hasXY(t,e)}isBoundaryXY(t,e){return 0==t||0==e||t==this.width-1||e==this.height-1}cell(t,e){return this.cells[t][e]}_cell(t,e){return this.cells[t][e]}get(t,e){return this.cells.get(t,e)}eachCell(t){this.cells.forEach(((e,i,s)=>t(e,i,s,this)))}hasItem(t,e){return this.cell(t,e).hasItem()}itemAt(t,e){return this.items.find((i=>i.isAt(t,e)))||null}eachItem(t){this.items.forEach(t)}addItem(t,e,i,s=!1){if(!this.hasXY(t,e))return!1;const r=this._cell(t,e);if(r._addItem(i)){const a=this.items.indexOf(i);return a<0&&this.items.push(i),i.addToMap(this,t,e),s&&this._fireAddItemEffects(i,r),a<0&&this.events.emit("item",this,i,!0),!0}return!1}_fireAddItemEffects(t,e){t.key&&t.key.matches(e.x,e.y)&&e.hasEffect("key")?e.fireEvent("key",{key:t,item:t}):e.hasEffect("add_item")&&e.fireEvent("add_item",{key:t,item:t})}addItemNear(t,e,i,s=!1){const r=this.rng.matchingLocNear(t,e,((t,e)=>{if(!this.hasXY(t,e))return!1;const s=this._cell(t,e);return!s.hasItem()&&(!s.blocksMove()&&!i.avoidsCell(s))}));return!(!r||r[0]<0)&&this.addItem(r[0],r[1],i,s)}removeItem(t,e=!1){const i=this._cell(t.x,t.y);return!!i._removeItem(t)&&(e&&this._fireRemoveItemEffects(t,i),r.arrayDelete(this.items,t),t.removeFromMap(),this.events.emit("item",this,t,!1),!0)}_fireRemoveItemEffects(t,e){t.isKey(e.x,e.y)&&e.hasEffect("no_key")?e.fireEvent("no_key",{key:t,item:t}):e.hasEffect("remove_item")&&e.fireEvent("remove_item",{key:t,item:t})}moveItem(t,e,i,s=!1){if(t.map!==this)throw new Error("Actor not on this map!");const r=this._cell(t.x,t.y),a=this._cell(e,i);return r._removeItem(t),a._addItem(t)&&(s&&(this._fireRemoveItemEffects(t,r),this._fireAddItemEffects(t,a)),t.addToMap(this,e,i)),!0}hasPlayer(t,e){return this.cell(t,e).hasPlayer()}actorAt(t,e){return this.actors.find((i=>i.isAt(t,e)))||null}eachActor(t){this.actors.forEach(t)}addActor(t,e,i,s=!1){if(!this.hasXY(t,e))return!1;const r=this._cell(t,e);if(!r.canAddActor(i))return!1;if(r._addActor(i)){const a=this.actors.indexOf(i);return a<0&&this.actors.push(i),i.addToMap(this,t,e),s&&this._fireAddActorEffects(i,r),a<0&&this.events.emit("actor",this,i,!0),!0}return!1}_fireAddActorEffects(t,e){t.isKey(e.x,e.y)&&e.hasEffect("key")?e.fireEvent("key",{key:t,actor:t}):t.isPlayer()&&e.hasEffect("add_player")?e.fireEvent("add_player",{player:t,actor:t}):e.hasEffect("add_actor")&&e.fireEvent("add_actor",{actor:t})}addActorNear(t,e,i,s=!1){const r=this.rng.matchingLocNear(t,e,((t,e)=>{if(!this.hasXY(t,e))return!1;const s=this.cell(t,e);return!s.hasActor()&&(!s.blocksMove()&&!i.avoidsCell(s))}));return!(!r||r[0]<0)&&this.addActor(r[0],r[1],i,s)}removeActor(t,e=!1){const i=this._cell(t.x,t.y);return!!i.canRemoveActor(t)&&(!!i._removeActor(t)&&(e&&this._fireRemoveActorEffects(t,i),t.removeFromMap(),r.arrayDelete(this.actors,t),this.events.emit("actor",this,t,!1),!0))}_fireRemoveActorEffects(t,e){t.isKey(t.x,t.y)&&e.hasEffect("no_key")?e.fireEvent("no_key",{key:t,actor:t}):t.isPlayer()&&e.hasEffect("remove_player")?e.fireEvent("remove_player",{actor:t,player:t}):e.hasEffect("remove_actor")&&e.fireEvent("remove_actor",{actor:t})}moveActor(t,e,i,s=!1){if(t.map!==this)throw new Error("Actor not on this map!");const r=this._cell(t.x,t.y),a=this._cell(e,i);return r._removeActor(t),a._addActor(t)&&(t.addToMap(this,e,i),s&&(this._fireRemoveActorEffects(t,r),this._fireAddActorEffects(t,a))),!0}fxAt(t,e){return this.fx.find((i=>i.isAt(t,e)))||null}eachFx(t){this.fx.forEach(t)}addFx(t,e,i){const s=this.get(t,e);return!!s&&(i.x=t,i.y=e,s._addFx(i),this.fx.push(i),this.events.emit("fx",this,i,!0),!0)}moveFx(t,e,i){const s=this.get(t.x,t.y),r=this.get(e,i);return!!r&&(s._removeFx(t),t.x=e,t.y=i,r._addFx(t),!0)}removeFx(t){const e=this.get(t.x,t.y);return r.arrayDelete(this.fx,t),e&&e._removeFx(t),this.events.emit("fx",this,t,!1),!0}hasKey(t,e){const i=this.actorAt(t,e);if(i&&i.isKey(t,e))return!0;const s=this.itemAt(t,e);return!(!s||!s.isKey(t,e))}count(t){return this.cells.count(((e,i,s)=>t(e,i,s,this)))}dump(t,e=console.log){this.cells.dump(t||(t=>t.dump()),e)}hasMapFlag(t){return!!(this.flags.map&t)}setMapFlag(t){this.flags.map|=t}clearMapFlag(t){this.flags.map&=~t}get needsRedraw(){return this.hasMapFlag(m.MAP_NEEDS_REDRAW)}set needsRedraw(t){t?this.setMapFlag(m.MAP_NEEDS_REDRAW):this.clearMapFlag(m.MAP_NEEDS_REDRAW)}hasCellFlag(t,e,i){return this.cell(t,e).hasCellFlag(i)}setCellFlag(t,e,i){this.cell(t,e).setCellFlag(i)}clearCellFlag(t,e,i){this.cell(t,e).clearCellFlag(i)}hasEntityFlag(t,e,i){return this.cell(t,e).hasEntityFlag(i)}hasTileFlag(t,e,i){return this.cell(t,e).hasTileFlag(i)}clear(){this.light.glowLightChanged=!0,this.layers.forEach((t=>t.clear()))}clearCell(t,e,i){this.cell(t,e).clear(i)}fill(t,e){let i,s;for(t=z(t),e=z(e||t),i=0;i<this.width;++i)for(s=0;s<this.height;++s){this.cells[i][s].clear(this.isBoundaryXY(i,s)?e:t)}}hasTile(t,e,i){return this.cell(t,e).hasTile(i)}forceTile(t,e,i){return this.setTile(t,e,i,{superpriority:!0})}setTile(t,e,i,s){if(!(i instanceof W)){const t=i;if(!(i=z(t)))throw new Error("Failed to find tile: "+t)}!0===s&&(s={superpriority:!0});const r=i.depth||0,a=this.layers[r]||this.layers[0];return a instanceof vt&&a.setTile(t,e,i,s)}clearTiles(t,e,i){this.cell(t,e).clearTiles(i)}tick(t){let e=!1;this._animations.forEach((i=>{e=i.tick(t)||e})),this._animations=this._animations.filter((t=>t.isRunning())),e=this.fireAll("tick")||e;for(let i of this.layers)i&&i.tick(t)&&(e=!0);return e}copy(t){if(this.constructor!==t.constructor)throw new Error("Maps must be same type to copy.");if(this.width!==t.width||this.height!==t.height)throw new Error("Maps must be same size to copy");this.cells.forEach(((e,i,s)=>{e.copy(t.cell(i,s))})),this.layers.forEach(((e,i)=>{e.copy(t.layers[i])})),this.actors=t.actors.slice(),this.items=t.items.slice(),this.flags.map=t.flags.map,this.light.copy(t.light),this.rng=t.rng,this.properties=Object.assign({},t.properties)}clone(){const t=new this.constructor(this.width,this.height);return t.copy(this),t}fire(t,e,i,s={}){return this.cell(e,i).fireEvent(t,s)}fireAll(t,e={}){const i=r.grid.alloc(this.width,this.height);return this.cells.forEach(((e,s,a)=>{e.clearCellFlag(g.EVENT_FIRED_THIS_TURN|g.EVENT_PROTECTED),e.eachTile((o=>{const l=o.effects[t];if(!l)return;const h=V(l);if(!h)return;let c=0;h.chance<0?(c=0,r.xy.eachNeighbor(s,a,((t,i)=>{const s=this.cell(t,i);s.hasEntityFlag(n.L_BLOCKS_EFFECTS)||s.depthTile(o.depth)==e.depthTile(o.depth)||s.hasCellFlag(g.CAUGHT_FIRE_THIS_TURN)||(c+=-1*h.chance)}),!0)):c=h.chance||1e4,!e.hasCellFlag(g.CAUGHT_FIRE_THIS_TURN)&&this.rng.chance(c,1e4)&&(i[s][a]|=r.flag.fl(o.depth))}))})),e.force=!0,i.forEach(((e,i,a)=>{if(!e)return;const n=this.cell(i,a);if(!n.hasCellFlag(g.EVENT_FIRED_THIS_TURN))for(let i=0;i<=s.GAS;++i)e&r.flag.fl(i)&&n.fireEvent(t,{force:!0})})),r.grid.free(i),!1}activateMachine(t,e,i,s={}){let r=!1;s.originX=e,s.originY=i;for(let e=0;e<this.width;++e)for(let i=0;i<this.height;++i){const a=this.cell(e,i);a.machineId===t&&(a.hasEffect("machine")&&(r=a.fireEvent("machine",s)||r))}return r}drawInto(t,e){this.drawer.drawInto(t,this,e)}getAppearanceAt(t,e,i){const s=this.cell(t,e);return this.drawer.drawCell(i,s)}hasActor(t,e){return this.cell(t,e).hasActor()}eachGlowLight(t){this.cells.forEach(((e,i,s)=>{e.eachGlowLight((e=>t(i,s,e)))}))}eachDynamicLight(t){}eachViewport(t){}lightingChanged(){return this.light.changed}hasVisibleLight(t,e){return!this.light.isDark(t,e)}blocksVision(t,e){return this.cell(t,e).blocksVision()}addAnimation(t){this._animations.push(t)}removeAnimation(t){r.arrayDelete(this._animations,t)}}function Ht(t,e,i={},s){"string"==typeof i&&(i={tile:i}),s&&(i.boundary=s),!0===i.tile&&(i.tile="FLOOR"),!0===i.boundary&&(i.boundary="WALL");const r=new Bt(t,e,i);return i.tile&&(r.fill(i.tile,i.boundary),r.light.update()),r}class Ut extends Bt{constructor(t){super(t.width,t.height),this.source=t,this.cells.forEach((t=>t.setCellFlag(g.STABLE_MEMORY)))}cell(t,e){let i=this.cells[t][e];return i.hasCellFlag(g.STABLE_MEMORY)||(i=this.source.cell(t,e)),i}memory(t,e){return this.cells[t][e]}isMemory(t,e){return this.cells[t][e].hasCellFlag(g.STABLE_MEMORY)}setTile(){throw new Error("Cannot set tiles on memory.")}addItem(){throw new Error("Cannot add Items to memory!")}removeItem(){throw new Error("Cannot remove Items from memory!")}eachItem(t){this.source.eachItem((e=>{if(!this.isMemory(e.x,e.y)){t(e);const i=this.items.find((t=>t.id==e.id));if(i){this.cell(i.x,i.y).clearCellFlag(g.HAS_ITEM|g.STABLE_SNAPSHOT),r.arrayDelete(this.items,i)}}})),this.items.forEach(t)}addActor(){throw new Error("Cannot add Actors to memory!")}removeActor(){throw new Error("Cannot remove Actors from memory!")}eachActor(t){this.source.eachActor((e=>{if(!this.isMemory(e.x,e.y)){t(e);const i=this.actors.find((t=>t.id==e.id));if(i){this.cell(i.x,i.y).clearCellFlag(g.HAS_ACTOR|g.STABLE_SNAPSHOT),r.arrayDelete(this.actors,i)}}})),this.actors.forEach(t)}storeMemory(t,e){const i=this.cells[t][e],s=i.hasEntityFlag(n.L_LIST_IN_SIDEBAR,!0);i.hasItem()&&(this.items=this.items.filter((i=>i.x!==t||i.y!==e))),i.hasActor()&&(this.actors=this.actors.filter((i=>i.x!==t||i.y!==e)));const r=this.source.cell(t,e);i.copy(r),i.setCellFlag(g.STABLE_MEMORY),i.map=this;let a=i.hasEntityFlag(n.L_LIST_IN_SIDEBAR);if(r.hasItem()){const i=this.source.itemAt(t,e);if(i){const t=i.clone();t._map=this,this.items.push(t),t.hasEntityFlag(n.L_LIST_IN_SIDEBAR)&&(a=!0)}}if(r.hasActor()){const i=this.source.actorAt(t,e);if(i){const t=i.clone();t._map=this,this.actors.push(t),t.hasEntityFlag(n.L_LIST_IN_SIDEBAR)&&(a=!0)}}s!=a&&this.setMapFlag(m.MAP_SIDEBAR_TILES_CHANGED),this.light.setLight(t,e,this.source.light.getLight(t,e))}forget(t,e){const i=this.memory(t,e),s=i.hasEntityFlag(n.L_LIST_IN_SIDEBAR,!0);i.hasItem()&&(this.items=this.items.filter((i=>i.x!==t||i.y!==e))),i.hasActor()&&(this.actors=this.actors.filter((i=>i.x!==t||i.y!==e))),i.clearCellFlag(g.STABLE_MEMORY),s!=this.source.cell(t,e).hasEntityFlag(n.L_LIST_IN_SIDEBAR,!0)&&this.setMapFlag(m.MAP_SIDEBAR_TILES_CHANGED)}onFovChange(t,e,i){i?this.forget(t,e):this.storeMemory(t,e)}}const Kt={};function Vt(t,e,i){let s=Kt[t.id];s||(Kt[t.id]=s={}),s[e.properties.id]=i}function Yt(t,e){let i=Kt[t.id];if(i){const t=i[e.properties.id];if(t)return t}return new Ut(e)}var Gt=Object.freeze({__proto__:null,Memory:Ut,store:Vt,get:Yt});const Wt={};function jt(t,e){Wt[t]=e}class Xt{constructor(t,e,i){if(this.item=null,this.count=0,this.game=t,this.actor=e,this.target=i||null,this.distanceMap=r.grid.alloc(t.map.width,t.map.height),i){const t=e.costMap();r.path.calculateDistances(this.distanceMap,i.x,i.y,t)}}start(){return++this.count,this}done(t){return--this.count,0==this.count&&r.grid.free(this.distanceMap),t}}async function qt(t,e){if(e.isDead())return-1;if(!e.map)return-1;const i=t.player;if(!i.canSee(e.x,e.y))return zt(t,e);const s=100-e.stats.getPct("health"),r=e.stats.get("morale"),a=new Xt(t,e,i).start();let n=0;return s>r||(n=await zt(t,e)),a.done(n)}async function zt(t,e,i){return e.moveSpeed()}jt("typical",qt),jt("default",qt);var Qt=Object.freeze({__proto__:null,fillSafetyMap:function(t,e,i){const s=r.grid.alloc(e.costMap());r.path.calculateDistances(t,i.x,i.y,s,!0),t.update((t=>-1*t)),e.map.actors.forEach((t=>{t.willAttack(e)&&(s[t.x][t.y]=r.path.FORBIDDEN)})),e.map.eachCell(((e,i,s)=>{e.hasCellFlag(g.IS_IN_LOOP)&&(t[i][s]-=r.path.AVOIDED)})),r.path.rescan(t,s,!0),t.update((t=>t<=-3e4?3e4:t)),r.grid.free(s)},ais:Wt,install:jt,AICtx:Xt,typical:qt,canMoveToward:function(t,e,i,s){const a=(s=(s||new Xt(t,e,i)).start()).distanceMap;let n=a[e.x][e.y],o=0;return r.xy.eachNeighbor(e.x,e.y,((t,e)=>{a[t][e]<n&&++o}),!1),s.done(o>0)},moveToward:async function(t,e,i,s){s=(s||new Xt(t,e,i)).start();const a=t.map,n=r.path.nextStep(s.distanceMap,e.x,e.y,((t,e)=>{const s=a.cell(t,e);return!s||(!(!s.hasActor()||s.actor===i)||!!s.blocksMove())}));let o=0;if(!n||0==n[0]&&0==n[1])return o=await zt(t,e),s.done(o);const l=x("moveDir");if(!l)throw new Error("No moveDir action found for Actors!");return o=await l(t,e,{dir:n}),s.done(o)},canMoveAwayFrom:function(t,e,i,s){const a=(s=(s||new Xt(t,e,i)).start()).distanceMap;let n=a[e.x][e.y],o=0;return r.xy.eachNeighbor(e.x,e.y,((t,e)=>{a[t][e]>=r.path.NO_PATH||a[t][e]>n&&++o}),!1),s.done(o>0)},moveAwayFrom:async function(t,e,i,s){return e.moveSpeed()},canRunAwayFrom:function(t,e,i,s){return!1},runAwayFrom:async function(t,e,i,s){return e.moveSpeed()},canAttack:function(t,e,i,s){return!1},attack:async function(t,e,i,s){return e.moveSpeed()},tooFarFrom:function(t,e,i,s){return!1},tooCloseTo:function(t,e,i,s){return!1},standStill:zt});class $t extends R{constructor(t){super(t),this.flags={actor:l.DEFAULT,entity:n.DEFAULT_ACTOR},this.vision={},this.actions={},this.bump=[],this.moveSpeed=100,this.ai=null,t.flags&&(this.flags.actor=r.flag.from(l,this.flags.actor,t.flags),this.flags.entity=r.flag.from(n,this.flags.entity,t.flags)),t.vision&&(this.vision.normal=t.vision),this.stats=t.stats||{},t.actions&&Object.assign(this.actions,t.actions),t.moveSpeed&&(this.moveSpeed=t.moveSpeed),t.ai&&("string"==typeof t.ai&&(t.ai=Wt[t.ai]),"function"==typeof t.ai?this.ai=t.ai:t.ai=Wt.default),t.bump&&("string"==typeof t.bump&&(t.bump=t.bump.split(/[|,]/g).map((t=>t.trim()))),"function"==typeof t.bump&&(t.bump=[t.bump]),Array.isArray(t.bump)&&(this.bump=t.bump.slice()))}make(t){const e=new k(this);return this.init(e,t),e}init(t,e={}){super.init(t,e),Object.assign(t.flags,this.flags),e.fov&&(t.fov=e.fov),e.memory&&(t.memory=e.memory),this.vision.normal&&(t.visionDistance=this.vision.normal),t.stats.init(this.stats)}addToMap(t,e){super.addToMap(t,e),this.hasActorFlag(l.HAS_MEMORY)&&(t.memory=Yt(t,e)),this.hasActorFlag(l.USES_FOV)&&(t.fov=new r.fov.FovSystem(e),t.fov.follow=t,t.memory&&(t.fov.callback=t.memory))}removeFromMap(t){super.removeFromMap(t),t._map&&t.memory&&Vt(t,t._map,t.memory)}hasActorFlag(t){return!!(this.flags.actor&t)}canSeeEntity(t,e){return!0}isAbleToSee(t,e){return!0}isAbleToSense(t,e){return!0}forbidsCell(t,e){return!!super.forbidsCell(t,e)||!!t.blocksMove()}avoidsCell(t,e){return!!super.avoidsCell(t,e)||(!!t.blocksMove()||!!t.blocksPathing())}getFlavor(t,e){const i=t.isPlayer()?"yourself":this.flavor;return e&&e.action?i+" standing":i}pickupItem(t,e,i){return!!r.list.push(t,"items",e)}dropItem(t,e,i){return!!r.list.remove(t,"items",e)}}function Jt(t,e){const i=te(t);if(!i)throw new Error("Failed to find item kind - "+t);return i.make(e)}const Zt={};function te(t){return t instanceof $t?t:Zt[t]}function ee(t){const e=Object.assign({},t);return new $t(e)}function ie(t={}){const e={tags:[],forbidTags:[]};"string"==typeof t&&(t={tags:t}),"string"==typeof t.tags?t.tags.split(/[,|&]/).map((t=>t.trim())).forEach((t=>{t.startsWith("!")?e.forbidTags.push(t.substring(1).trim()):e.tags.push(t)})):Array.isArray(t.tags)&&(e.tags=t.tags.slice()),"string"==typeof t.forbidTags?e.forbidTags=t.forbidTags.split(/[,|&]/).map((t=>t.trim())):Array.isArray(t.forbidTags)&&(e.forbidTags=t.forbidTags.slice());const i=Object.values(Zt).filter((t=>!(e.tags.length&&!r.arraysIntersect(e.tags,t.tags))&&(!e.forbidTags||!r.arraysIntersect(e.forbidTags,t.tags))));return(t.rng||r.rng.random).item(i)||null}async function se(t,e,i={}){const s=i.actor;if(s){const r=s.getBumpActions();for(let a of r)if("string"==typeof a)if(a.startsWith("$")){const r=a.substring(1);let n=s.getAction(r);if(!1===n)throw new Error("Cannot have bump action for self action that actor cannot do: "+a);if(!0===n){const t=x(r);if(!t)throw new Error("Cannot have bump self action for unknown action: "+r);n=t}const o=Object.assign({},i,{actor:e}),l=await n(t,s,o);if(l)return l}else{const s=e.getAction(a);if(!0===s){const t=x(a);if(!t)throw new Error("Cannot find action for bump: "+a);a=t}else{if(!1===s)throw new Error("Cannot configure actor with bump action they cannot do: "+a);a=s}const r=await a(t,e,i);if(r)return r}else{const s=await a(t,e,i);if(s)return s}}return i.item,0}async function re(t,e,i){return e.moveSpeed()}async function ae(t,e,i,s,a=100,n=1,o){"string"==typeof s&&(s=r.sprite.from(s));const l=C({name:"FX",sprite:s});t.addFx(e,i,l);const h=r.tween.make({visible:!0}).to({visible:!1}).repeat(n).repeatDelay(a).duration(a).onUpdate((s=>{s.visible?t.addFx(e,i,l):t.removeFx(l)}));return(o=o||r.io.loop).addAnimation(h),h.start()}async function ne(t,e,i,s,r){i=i||"hit",s=s||200,await ae(t,e.x,e.y,i,s,1,r)}async function oe(t,e,i,s,a=100,n){const o=C({name:"FX",sprite:s="string"==typeof s?r.sprite.from(s).clone():r.sprite.make(s)});t.addFx(e,i,o);const l=r.tween.make({opacity:0}).to({opacity:100}).repeat(2).yoyo(!0).duration(Math.floor(a/2)).onUpdate((s=>{o.sprite.opacity=s.opacity,t.cell(e,i).needsRedraw=!0})).onFinish((()=>{t.removeFx(o)}));return(n=n||r.io.loop).addAnimation(l),l.start()}async function le(t,e,i,s,a={}){"string"==typeof s&&(s=r.sprite.from(s));const o=C({name:"FX",sprite:s}),l={x:r.xy.x(e),y:r.xy.y(e)};t.addFx(l.x,l.y,o);let h=a.duration||Math.ceil(r.xy.maxAxisFromTo(e,i)/(a.speed||8)*16);r.xy.isLoc(i)&&(i={x:i[0],y:i[1]});const c=r.tween.make(l).to(i).duration(h).onUpdate((e=>{const i={x:o.x,y:o.y},s=r.xy.forLineBetween(i.x,i.y,e.x,e.y,((e,s)=>{if(a.stepFn){if(a.stepFn(e,s))return a.stopBeforeWalls||(i.x=e,i.y=s),!1}else if(t.hasEntityFlag(e,s,n.L_BLOCKS_MOVE))return a.stopBeforeWalls||(i.x=e,i.y=s),!1;i.x=e,i.y=s}));t.moveFx(o,i.x,i.y),s||c.stop()})).onFinish((()=>(t.removeFx(o),o)));return(a.animator||t).addAnimation(c),c.start()}function he(t,e,i,s,r,a){const n=Math.abs(r-e),o=Math.abs(a-i);if(0==n&&0==o&&!s)return!1;switch(t){case"+":return 0==n||0==o;case"x":case"X":return n==o;case"*":return 0==n||0==o||n==o;default:return!0}}D("bump",se),D("standStill",re),D("idle",re),r.sprite.install("bump","white",50),r.sprite.install("hit","red",50),r.sprite.install("miss","green",50);var ce=Object.freeze({__proto__:null,flashSprite:ae,hit:ne,miss:async function(t,e,i,s,r){i=i||"miss",s=s||200,await ae(t,e.x,e.y,i,s,1,r)},fadeInOut:oe,moveSprite:le,bolt:function(t,e,i,s,r={}){return le(t,e,i,s,r)},projectile:async function(t,e,i,s,a={}){if("string"==typeof s&&(s=r.sprite.from(s)),s.ch&&4==s.ch.length){const t=r.xy.dirFromTo(e,i);let a=0;t[0]&&t[1]?(a=2,t[0]!=t[1]&&(a=3)):t[0]&&(a=1);const n=s.ch[a];s=r.sprite.make(n,s.fg,s.bg)}else if(s.ch&&1!==s.ch.length)throw new Error('projectile requires 4 chars - vert,horiz,diag-left,diag-right (e.g: "|-\\/")');return le(t,e,i,s,a)},beam:function(t,e,i,s,a={}){a.fade=a.fade||100,void 0===a.stopAtWalls&&(a.stopAtWalls=!0);const o=[];r.xy.forLineFromTo(e,i,((e,i)=>!!t.hasXY(e,i)&&((!a.stepFn||!a.stepFn(e,i))&&((a.stopAtWalls||a.stopBeforeWalls)&&t.hasEntityFlag(e,i,n.L_BLOCKS_MOVE)?(a.stopBeforeWalls||o.push([e,i]),!1):(o.push([e,i]),!0)))));const l=a.duration||Math.ceil(o.length/(a.speed||8)*16),h=a.animator||t,c=[];let f=-1;const _=r.tween.make({index:0}).to({index:o.length-1}).duration(l).onUpdate((e=>{for(;f<e.index;){++f;const e=o[f]||[-1,-1];c.push(oe(t,e[0],e[1],s,a.fade,h))}})).onFinish((async()=>{await Promise.all(c);const t=o[o.length-1];return{x:t[0],y:t[1]}}));return h.addAnimation(_),_.start()},explosion:function(t,e,i,s,a,o={}){!function(t){t.speed=t.speed||2,t.fade=t.fade||100,t.shape=t.shape||"o",void 0===t.center&&(t.center=!0)}(o),o.animator=o.animator||t,"string"==typeof a&&(a=r.sprite.from(a));const l=r.grid.alloc(t.width,t.height);new r.fov.FOV({isBlocked:(e,i)=>t.hasEntityFlag(e,i,n.L_BLOCKS_MOVE),hasXY:(e,i)=>t.hasXY(e,i)}).calculate(e,i,s,((t,e)=>{l[t][e]=1}));const h=o.duration||s/o.speed*32,c=[],f=r.tween.make({r:0}).to({r:s}).duration(h).onUpdate((s=>{const n=Math.max(0,e-s.r),h=Math.max(0,i-s.r),f=Math.min(t.width-1,e+s.r),_=Math.min(t.height-1,i+s.r);for(let u=n;u<=f;++u)for(let n=h;n<=_;++n)l[u][n]&&r.xy.distanceBetween(e,i,u,n)<=s.r&&(l[u][n]=0,he(o.shape,e,i,o.center,u,n)&&c.push(oe(t,u,n,a,o.fade,o.animator)))})).onFinish((async(t,e)=>(r.grid.free(l),await Promise.all(c),e)));return o.animator.addAnimation(f),f.start()}});async function fe(t,e,i={}){const s=i.dir;if(!s)throw new Error("moveDir called with no direction!");const r=e.x+s[0],a=e.y+s[1],n=t.map,o=n.cell(e.x,e.y),l=n.cell(r,a);let h=0;if(l.blocksMove())return ne(n,l,"hit",100),e.moveSpeed();if(!o.canRemoveActor(e))return e.moveSpeed();if(l.hasActor()||l.hasItem()){const i={actor:l.actor,item:l.item};if(h=await se(t,e,i),h)return h}return l.canAddActor(e)?n.moveActor(e,r,a)?(h=e.moveSpeed(),h):(h=await re(0,e),h):e.moveSpeed()}D("moveDir",fe);var _e=Object.freeze({__proto__:null,bump:se,moveDir:fe,standStill:re}),ue=Object.freeze({__proto__:null,actions:_e,PainMessages:N,painMessages:w,installPain:function(t,e){Array.isArray(e)&&(e=new N(e)),w[t]=e},getPain:function(t){const e=w[t];if(!e)throw new Error("No such pain message index: "+t);return e},Stats:b,Status:M,ActorKind:$t,Actor:k,make:Jt,makeRandom:function(t,e){const i=ie(t);if(!i)throw new Error("Failed to find item kind matching - "+JSON.stringify(t));return i.make(e)},from:function(t,e){let i;if("string"==typeof t){if(i=te(t),!i)throw new Error("Failed to find item kind - "+t)}else i=t instanceof $t?t:ee(t);return i.make(e)},kinds:Zt,install:function(t,e){if(e instanceof $t)return Zt[t]=e,e;const i=ee(e);return i.id=t,Zt[t]=i,i},get:te,makeKind:ee,randomKind:ie,installedActions:F,installAction:D,getAction:x});class de extends O{constructor(t){super(t),this.quantity=1,this.next=null,this.flags.item=0,this.depth=s.ITEM,this.kind=t}copy(t){super.copy(t),this.quantity=t.quantity}itemFlags(){return this.flags.item}hasItemFlag(t){return!!(this.flags.item&t)}hasAllItemFlags(t){return(this.flags.item&t)===t}getAction(t){return this.kind.actions[t]}getBumpActions(){return this.kind.bump}}class ge extends R{constructor(t){super(t),this.flags={item:h.DEFAULT,entity:n.DEFAULT_ACTOR},this.actions={},this.bump=[],t.flags&&(this.flags.item=r.flag.from(h,this.flags.item,t.flags),this.flags.entity=r.flag.from(n,this.flags.entity,t.flags)),t.actions&&Object.entries(t.actions).forEach((([t,e])=>{this.actions[t]=e})),t.bump&&("string"!=typeof t.bump&&"function"!=typeof t.bump||(t.bump=[t.bump]),Array.isArray(t.bump)&&(this.bump=t.bump.slice()))}make(t){const e=new de(this);return this.init(e,t),e}init(t,e={}){super.init(t,e),Object.assign(t.flags,this.flags),t.quantity=e.quantity||1}}const Ee={};function me(t){return t instanceof ge?t:Ee[t]}function pe(t){const e=Object.assign({},t);return new ge(e)}function Ae(t={}){const e={tags:[],forbidTags:[]};"string"==typeof t&&(t={tags:t}),"string"==typeof t.tags?t.tags.split(/[,|&]/).map((t=>t.trim())).forEach((t=>{t.startsWith("!")?e.forbidTags.push(t.substring(1).trim()):e.tags.push(t)})):Array.isArray(t.tags)&&(e.tags=t.tags.slice()),"string"==typeof t.forbidTags?e.forbidTags=t.forbidTags.split(/[,|&]/).map((t=>t.trim())):Array.isArray(t.forbidTags)&&(e.forbidTags=t.forbidTags.slice());const i=Object.values(Ee).filter((t=>!(e.tags.length&&!r.arraysIntersect(e.tags,t.tags))&&(!e.forbidTags||!r.arraysIntersect(e.forbidTags,t.tags))));return(t.rng||r.rng.random).item(i)||null}var Te=Object.freeze({__proto__:null,ItemKind:ge,Item:de,make:function(t,e){const i=me(t);if(!i)throw new Error("Failed to find item kind - "+t);return i.make(e)},makeRandom:function(t,e){const i=Ae(t);if(!i)throw new Error("Failed to find item kind matching - "+JSON.stringify(t));return i.make(e)},from:function(t,e){let i;if("string"==typeof t){if(i=me(t),!i)throw new Error("Failed to find item kind - "+t)}else i=t instanceof ge?t:pe(t);return i.make(e)},kinds:Ee,install:function(t,e){if(e instanceof ge)return Ee[t]=e,e;const i=pe(e);return i.id=t,Ee[t]=i,i},get:me,makeKind:pe,randomKind:Ae});function Se(t,e){const i=r.grid.alloc(t.width,t.height),s=r.grid.alloc(t.width,t.height);for(let e=0;e<t.width;e++)for(let s=0;s<t.height;s++){const r=t.cell(e,s);!r.blocksPathing()&&!r.blocksMove()||r.hasEntityFlag(n.L_SECRETLY_PASSABLE)?i[e][s]=1:i[e][s]=0}let a;for(let e=1;e<i.width-1;e++)for(let s=1;s<i.height-1;s++)if(t.cell(e,s).flags.cell&=~g.IS_CHOKEPOINT,i[e][s]&&!(t.cell(e,s).flags.cell&g.IS_IN_LOOP)){a=0;for(let n=0;n<8;n++){const o=e+r.xy.CLOCK_DIRS[(n+7)%8][0],l=s+r.xy.CLOCK_DIRS[(n+7)%8][1],h=e+r.xy.CLOCK_DIRS[n][0],c=s+r.xy.CLOCK_DIRS[n][1];if((t.hasXY(h,c)&&i[h][c])!=(t.hasXY(o,l)&&i[o][l])&&++a>2){(i[e-1][s]||i[e+1][s])&&(i[e][s-1]||i[e][s+1])||(t.cell(e,s).flags.cell|=g.IS_CHOKEPOINT);break}}}if(e){for(let e=0;e<t.width;e++)for(let i=0;i<t.height;i++)t.cell(e,i).chokeCount=3e4;for(let e=0;e<t.width;e++)for(let a=0;a<t.height;a++){const n=t.cell(e,a);if(i[e][a]&&n.flags.cell&g.IS_CHOKEPOINT)for(let o=0;o<4;o++){const l=e+r.xy.DIRS[o][0],h=a+r.xy.DIRS[o][1];if(t.hasXY(l,h)&&i[l][h]&&!(t.cell(l,h).flags.cell&g.IS_CHOKEPOINT)){s.fill(0),i[e][a]=0;let r=ye(t,s,i,l,h);if(i[e][a]=1,r>=4){for(let e=0;e<s.width;e++)for(let i=0;i<s.height;i++)s[e][i]&&r<t.cell(e,i).chokeCount&&(t.cell(e,i).chokeCount=r,t.cell(e,i).flags.cell&=~g.IS_GATE_SITE);r<n.chokeCount&&(n.chokeCount=r,n.flags.cell|=g.IS_GATE_SITE)}}}}}r.grid.free(i),r.grid.free(s)}function ye(t,e,i,s,a){function n(e,s){let r=2==i[e][s]?5e3:1;return t.cell(e,s).flags.cell&g.IS_IN_AREA_MACHINE&&(r=1e4),r}let o=0;const l=[[s,a]],h=[];for(;l.length;){const s=l.pop();h.push(s);const a=s[0],c=s[1];if(!e[a][c]){e[a][c]=1,o+=n(a,c);for(let s=0;s<4;s++){const n=a+r.xy.DIRS[s][0],o=c+r.xy.DIRS[s][1];if(t.hasXY(n,o)&&i[n][o]&&!e[n][o]){const t=h.pop()||[-1,-1];t[0]=n,t[1]=o,l.push(t)}}}}return Math.min(o,1e4)}function Le(t){t.eachCell(Ie),Oe(t),Ce(t)}function Ie(t,e,i,s){!t.blocksPathing()&&!t.blocksMove()||t.hasEntityFlag(n.L_SECRETLY_PASSABLE)?t.flags.cell|=g.IS_IN_LOOP:t.flags.cell&=~g.IS_IN_LOOP}function Oe(t){let e,i,s,a,n,o,l,h;const c=r.grid.alloc(t.width,t.height,1);let f=!0;for(;f;)f=!1,c.forEach(((_,u,d)=>{if(!_)return;const E=t.cell(u,d);if(c[u][d]=0,E.hasCellFlag(g.IS_IN_LOOP)){for(n=0;n<8;n++){if(i=u+r.xy.CLOCK_DIRS[n][0],s=d+r.xy.CLOCK_DIRS[n][1],!t.hasXY(i,s))continue;if(!t.cell(i,s).hasCellFlag(g.IS_IN_LOOP))break}if(8!=n){for(o=l=h=0,e=!1,a=n;a<n+8;a++){if(i=u+r.xy.CLOCK_DIRS[a%8][0],s=d+r.xy.CLOCK_DIRS[a%8][1],!t.hasXY(i,s))continue;if(t.cell(i,s).hasCellFlag(g.IS_IN_LOOP)){if(h++,!e&&(o++,e=!0,o>1))break}else e&&(h>l&&(l=h),h=0,e=!1)}if(e&&h>l&&(l=h),1==o&&l<=4)for(E.clearCellFlag(g.IS_IN_LOOP),a=0;a<8;a++)i=u+r.xy.CLOCK_DIRS[a][0],s=d+r.xy.CLOCK_DIRS[a][1],t.hasXY(i,s)&&t.cell(i,s).hasCellFlag(g.IS_IN_LOOP)&&(c[i][s]=1,f=!0)}}}))}function Re(t,e){for(let i=0;i<t.width;++i)for(let s=0;s<t.height;++s){if(t.cell(i,s).flags.cell&g.IS_IN_LOOP)e[i][s]=1;else if(i>0&&s>0){const r=t.cell(i,s-1),a=t.cell(i-1,s);r.flags.cell&g.IS_IN_LOOP&&a.flags.cell&g.IS_IN_LOOP&&(e[i][s]=1)}}}function Ce(t){const e=r.grid.alloc(t.width,t.height);let i;Re(t,e);for(let s=0;s<e.width;s++)for(let a=0;a<e.height;a++){if(t.cell(s,a).flags.cell&g.IS_IN_LOOP){i=!1;for(let n=0;n<8;n++){let o=s+r.xy.CLOCK_DIRS[n][0],l=a+r.xy.CLOCK_DIRS[n][1];if(t.hasXY(o,l)&&!e[o][l]&&!(t.cell(o,l).flags.cell&g.IS_IN_LOOP)){i=!0;break}}i||(e[s][a]=1,t.cell(s,a).flags.cell&=~g.IS_IN_LOOP)}}r.grid.free(e)}class ve{constructor(t){this.map=new Bt(t.width,t.height),this.version=0}}function Ne(t,e,i){return r.xy.arcCount(e,i,((e,i)=>t.cell(e,i).isPassable()))>1}var we=Object.freeze({__proto__:null,Cell:Rt,Map:Bt,make:Ht,from:function(t,e,i={}){let s,r=0,a=0;return"string"==typeof t&&(t=t.split("\n")),!function(t){return Array.isArray(t)&&"string"==typeof t[0]}(t)?(r=t.height,a=t.width,s=Ht(a,r,i),t.forEach(((t,i,r)=>{const a=e[t]||"FLOOR";s.setTile(i,r,a)}))):(r=t.length,a=t.reduce(((t,e)=>Math.max(t,e.length)),0),s=Ht(a,r,i),t.forEach(((t,i)=>{for(let r=0;r<a;++r){const a=t[r]||".",n=e[a]||"FLOOR";s.setTile(r,i,n)}}))),s.light.update(),s},analyze:function(t,e=!0){Le(t),Se(t,e)},updateChokepoints:Se,floodFillCount:ye,updateLoopiness:Le,resetLoopiness:Ie,checkLoopiness:Oe,fillInnerLoopGrid:Re,cleanLoopiness:Ce,Snapshot:ve,SnapshotManager:class{constructor(t){this.version=0,this.layerVersion=[],this.lightVersion=0,this.free=[],this.map=t,this.cellVersion=r.grid.make(t.width,t.height),this.layerVersion=t.layers.map((()=>1))}takeNew(){++this.version;const t=this.free.length?this.free.pop():new ve(this.map);return t.map.flags.map=this.map.flags.map,this.cellVersion.update(((e,i,s)=>{const r=this.map.cell(i,s);if(r.changed&&(e=this.version),e!==t.version){t.map.cell(i,s).copy(r)}return e})),this.map.light.changed&&(this.lightVersion=this.version,this.map.light.changed=!1),t.version!==this.lightVersion&&t.map.light.copy(this.map.light),this.map.layers.forEach(((e,i)=>{const s=t.map.layers[i];e.changed&&(this.layerVersion[i]=this.version),this.layerVersion[i]!==t.version&&s.copy(e)})),t.version=this.version,t}revertMapTo(t){this.cellVersion.update(((e,i,s)=>{if(e<t.version)return e;const r=this.map.cell(i,s);if(e>t.version||r.changed){const e=t.map.cell(i,s);return r.copy(e),t.version}return e})),(t.version<this.lightVersion||this.map.light.changed)&&(this.map.light.copy(t.map.light),this.lightVersion=t.version),this.layerVersion.forEach(((e,i)=>{if(e<t.version)return;const s=this.map.layers[i];if(e>t.version||s.changed){const e=t.map.layers[i];s.copy(e),this.layerVersion[i]=t.version}})),this.version=t.version}release(t){this.free.push(t)}},isHallway:Ne});function be(t,e,i){const s=t.cell(e,i);return s.blocksMove()?r.path.OBSTRUCTION:s.blocksPathing()?r.path.FORBIDDEN:s.hasActor()?10:1}function Me(t,e){e.update(((e,i,s)=>be(t,i,s)))}var Fe=Object.freeze({__proto__:null,getCellPathCost:be,fillCostMap:Me,getPathBetween:function(t,e,i,s,a,n={}){const o=r.grid.alloc(t.width,t.height),l=r.grid.alloc(t.width,t.height);Me(t,l),r.path.calculateDistances(o,e,i,l,n.eightWays,r.xy.straightDistanceBetween(e,i,s,a)+1);const h=r.path.getPath(o,s,a,((e,i)=>t.cell(e,i).blocksMove()),n.eightWays);return r.grid.free(l),r.grid.free(o),h}});class De{constructor(t){this.tags=[],this.members={},this.flags={horde:0},t.tags&&("string"==typeof t.tags?this.tags=t.tags.split(/[,|]/).map((t=>t.trim())):this.tags=t.tags.slice()),this.leader=t.leader,t.members&&Object.entries(t.members).forEach((([t,e])=>{this.members[t]=r.range.make(e)})),this.frequency=r.frequency.make(t.frequency||100),this.flags.horde=r.flag.from(S,t.flags)}spawn(t,e=-1,i=-1,s={}){var a;s.canSpawn=s.canSpawn||r.TRUE,s.rng=s.rng||t.rng,s.machine=null!==(a=s.machine)&&void 0!==a?a:0;const n=this._spawnLeader(t,e,i,s);return n?(this._spawnMembers(n,t,s),n):null}_spawnLeader(t,e,i,s){const r=te(this.leader);if(!r)throw new Error("Failed to find leader kind = "+this.leader);if(e>=0&&i>=0&&r.avoidsCell(t.cell(e,i)))return null;const a=Jt(r,{machineHome:s.machine});if(!a)throw new Error("Failed to make horde leader - "+this.leader);return(e<0||i<0)&&([e,i]=this._pickLeaderLoc(a,t,s)||[-1,-1],e<0||i<0)?null:this._addLeader(a,t,e,i,s)?a:null}_addLeader(t,e,i,s,r){return e.addActor(i,s,t)}_addMember(t,e,i,s,r,a){return t.leader=r,e.addActor(i,s,t)}_spawnMembers(t,e,i){const s=Object.entries(this.members);if(0==s.length)return 0;return s.forEach((([s,r])=>{const a=r.value(i.rng);for(let r=0;r<a;++r)this._spawnMember(s,e,t,i)})),0}_spawnMember(t,e,i,s){const r=te(t);if(!r)throw new Error("Failed to find member kind = "+t);const a=Jt(r,{machineHome:s.machine});if(!a)throw new Error("Failed to make horde member - "+t);const[n,o]=this._pickMemberLoc(a,e,i,s)||[-1,-1];return n<0||o<0?null:this._addMember(a,e,n,o,i,s)?a:null}_pickLeaderLoc(t,e,i){return i.rng.matchingLoc(e.width,e.height,((s,r)=>{const a=e.cell(s,r);return!a.hasActor()&&(!!i.canSpawn(s,r)&&(!t.avoidsCell(a)&&!Ne(e,s,r)))}))}_pickMemberLoc(t,e,i,s){return s.rng.matchingLocNear(i.x,i.y,((i,s)=>{if(!e.hasXY(i,s))return!1;const r=e.cell(i,s);return!r.hasActor()&&(!t.avoidsCell(r)&&!Ne(e,i,s))}))}}const xe={};function ke(t,e){return"string"==typeof e&&(e={leader:e}),e instanceof De||(e=new De(e)),xe[t]=e,e}var Pe=Object.freeze({__proto__:null,Horde:De,hordes:xe,install:ke,installAll:function(t){Object.entries(t).forEach((([t,e])=>{ke(t,e)}))},from:function(t){return t instanceof De?t:"string"==typeof t?xe[t]:new De(t)},random:function(t={}){const e={tags:[],forbidTags:[],flags:0,forbidFlags:0,depth:0};"string"==typeof t&&(t={tags:t});const i=t.rng||r.rng.random;if("string"==typeof t.tags?t.tags.split(/[,|&]/).map((t=>t.trim())).forEach((t=>{t.startsWith("!")?e.forbidTags.push(t.substring(1).trim()):e.tags.push(t)})):Array.isArray(t.tags)&&(e.tags=t.tags.slice()),"string"==typeof t.forbidTags?e.forbidTags=t.forbidTags.split(/[,|&]/).map((t=>t.trim())):Array.isArray(t.forbidTags)&&(e.forbidTags=t.forbidTags.slice()),t.flags&&"string"==typeof t.flags&&t.flags.split(/[,|]/).map((t=>t.trim())).forEach((t=>{if(t.startsWith("!")){const i=t.substring(1);e.forbidFlags|=S[i]}else e.flags|=S[t]})),t.forbidFlags&&(e.forbidFlags=r.flag.from(S,t.forbidFlags)),t.depth&&(e.depth=t.depth),e.depth&&t.oodChance){for(;i.chance(t.oodChance);)e.depth+=1;e.forbidFlags|=S.HORDE_NEVER_OOD}const s=Object.values(xe).filter((t=>!(e.tags.length&&!r.arraysIntersect(e.tags,t.tags))&&((!e.forbidTags||!r.arraysIntersect(e.forbidTags,t.tags))&&(!(e.flags&&!(t.flags.horde&e.flags))&&!(e.forbidFlags&&t.flags.horde&e.forbidFlags)))));if(e.depth)return i.item(s)||null;const a=e.depth,n=s.map((t=>t.frequency(a))),o=i.weighted(n);return o<0?null:s[o]}});const Be={};function He(t,e){Be[t]=e}function Ue(t){return Be[t]}async function Ke(t,e){const i=e.dir;return t.map&&i?fe(this,t,e):-1}async function Ve(t,e){if(!t.map)return-1;const i=t.getAction("pickup");if(!1===i)return r.message.addAt(t.x,t.y,"You cannot pickup items."),t.endTurn();if("function"==typeof i){const e=await i(this,t);if(e)return e}const s=t.map.itemAt(t.x,t.y);if(!s)return r.message.addAt(t.x,t.y,"Nothing to pickup."),0;if(t.avoidsItem(s))return 0;const a=s.getAction("pickup");if(!1===a)return r.message.addAt(t.x,t.y,"You cannot pickup %{the.item}.",{item:s}),0;if("function"==typeof a){const e=await a(this,t,s);if(e)return e}return t.canAddItem(s)&&t.map.removeItem(s)?(t.addItem(s),t.endTurn()):0}He("moveDir",Ke),He("pickup",Ve);var Ye=Object.freeze({__proto__:null,actions:Be,install:He,get:Ue,moveDir:Ke,pickup:Ve}),Ge=Object.freeze({__proto__:null,BasicDrawer:Pt});class We{constructor(t){this._base={},this._max={},this._bonus={},this._sustain={},this._value={},this.changed=null,this.init(t)}init(t){for(let e in je){const i="number"==typeof t?t:je[e];this.set(e,i)}if("number"!=typeof t)for(let e in t)this.set(e,t[e])}forEach(t){Object.keys(je).forEach((e=>t(this.get(e))))}get(t){return this._value[t]||0}set(t,e=0){return this._value[t]=e,this._base[t]=e,this._max[t]=e,this._bonus[t]=[],e}base(t){return this._base[t]||0}max(t){return this._max[t]||0}sustain(t){return this._sustain[t]||!1}gain(t,e,i=!0){if(e<0&&this._sustain[t])return 0;this._base[t]+=e,i&&this._base[t]>this._max[t]&&(this._max[t]=this._base[t]);let s=this.get(t);return this._calcValue(t)-s}drain(t,e,i=!1){e<0&&(e=-e);const s=this.gain(t,-e,!1);return s&&i&&(this._max[t]=this._base[t]),s}restore(t){this._base[t]=this._max[t];let e=this.get(t);return this._calcValue(t)-e}addBonus(t,e){return this._addBonus(t,{bonus:e})}_addBonus(t,e){"number"==typeof e&&(e={bonus:e}),void 0===this._value[t]&&this.set(t,0),this._bonus[t].push(e);let i=this.get(t);return this._calcValue(t)-i}clearBonus(t,e){return this._clearBonus(t,{bonus:e})}_clearBonus(t,e){"number"==typeof e&&(e={bonus:e});let i=this._bonus[t]||[],s=JSON.stringify(e),r=i.findIndex((t=>JSON.stringify(t)==s));if(r>-1){i.splice(r,1);let e=this.get(t);return this._calcValue(t)-e}return 0}_calcValue(t){let e={};this._bonus[t].forEach((t=>this._applyAdjustment(e,t))),this._sustain[t]=e.sustain||!1;let i=this._base[t]||0;return void 0!==e.fixed?i=e.fixed:(i+=e.bonus||0,void 0!==e.min&&(i=Math.max(e.min,i)),void 0!==e.max&&(i=Math.min(e.max,i))),this._value[t]=i}adjust(t,e){let i;return"number"==typeof e&&(e={bonus:e}),e.base?i=this.gain(t,e.base):e.restore?(i=this.restore(t),0==i&&(i=void 0)):i=this._addBonus(t,e),this.changed&&void 0!==i&&this.changed(this,t),i}clearAdjustment(t,e){let i;return"number"==typeof e&&(e={bonus:e}),e.base?i=this.drain(t,e.base,!0):e.restore||(i=this._clearBonus(t,e)),this.changed&&void 0!==i&&this.changed(this,t),i}_applyAdjustment(t,e){e.bonus&&(t.bonus=(t.bonus||0)+e.bonus),void 0!==e.fixed&&(t.fixed=Math.max(t.fixed||0,e.fixed)),void 0!==e.min&&(t.min=Math.max(t.min||0,e.min)),void 0!==e.max&&(t.max=Math.max(t.max||0,e.max)),void 0!==e.sustain&&(t.sustain=e.sustain)}}const je={};class Xe{constructor(t){this.name=t}get has(){return this._bool("_has")}get level(){return this._int("_level")}get disadvantage(){return this._bool("_disadvantage")}get advantage(){return this._bool("_advantage")}get fixed(){return this._int("_fixed")}get bonus(){const t=this._int("_bonus")||0;return this._parent?t+this._parent.bonus:t}get succeed(){return this._bool("_succeed")}get fail(){return this._bool("_fail")}set(t){!1===t?(this._has=!1,this._level=0):(this._has=!0,this._level=!0===t?0:t)}_value(t){return void 0!==this[t]?this[t]:this._parent?this._parent._value(t):void 0}_bool(t){return!!this._value(t)}_int(t){return this._value(t)}adjust(t){Object.entries(t).forEach((([t,e])=>{if(t="_"+t,void 0!==e){if("_fixed"===t){if("number"!=typeof e)throw new Error("fixed skill adjustment must be a number.");e=Math.max(e,this._fixed||0)}else if("_bonus"===t){if("number"!=typeof e)throw new Error("fixed skill adjustment must be a number.");e+=this._bonus||0}this[t]=e}}))}clear(t){Object.keys(t).forEach((t=>{void 0!==this[t="_"+t]&&(this[t]=void 0)}))}}class qe{constructor(t={}){this._skills={},Object.entries(t).forEach((([t,e])=>{this.set(t,e)}))}set(t,e){const i=this.get(t);return i.set(e),i}get(t){let e=this._skills[t];if(e)return e;e=this._skills[t]=new Xe(t);const i=t.lastIndexOf(".");return i>0?e._parent=this.get(t.substring(0,i)):e.set(!1),e}adjust(t,e){"number"==typeof e&&(e={bonus:e});let i=this.get(t);return i.adjust(e),i}}class ze extends k{constructor(t){super(t)}}ze.default={ch:"@",fg:"white",name:"You"};class Qe extends $t{constructor(t={}){super((t.sprite||(t.ch=t.ch||ze.default.ch,t.fg=t.fg||ze.default.fg),t.name||(t.name=ze.default.name),t)),this.flags.actor|=l.IS_PLAYER,this.attributes=new We(t.attributes||{}),this.skills=new qe(t.skills||{})}make(t){const e=new ze(this);return this.init(e,t),e}}function $e(t){const e=Object.assign({},t);return new Qe(e)}var Je=Object.freeze({__proto__:null,Attributes:We,attributes:je,installAttribute:function(t){"string"!=typeof t?(Object.keys(je).forEach((t=>{delete je[t]})),Object.assign(je,t)):je[t]=0},makeAttributes:function(t){return new We(t)},Skills:qe,PlayerKind:Qe,Player:ze,make:function(t,e){const i=te(t);if(!i)throw new Error("Failed to find item kind - "+t);return i.make(e)},from:function(t,e){let i;if("string"==typeof t){if(i=te(t),!i)throw new Error("Failed to find item kind - "+t);if(!(i instanceof Qe))throw new Error("Not a player kind.")}else i=t instanceof Qe?t:$e(t);return i.make(e)},install:function(t,e){if(e instanceof Qe)return Zt[t]=e,e;const i=$e(e);return i.id=t,Zt[t]=i,i},get:function(t){if(t instanceof Qe)return t;const e=Zt[t];if(e&&!(e instanceof Qe))throw new Error("No a player kind.");return e},makeKind:$e});var Ze=Object.freeze({__proto__:null,Game:class{constructor(t){this.running=!1,this.keymap={},this.ui=t.ui||new r.ui.UI(t),this._makeMap=t.makeMap,this._makePlayer=t.makePlayer,this._startMap=t.startMap,t.keymap&&Object.assign(this.keymap,t.keymap)}async start(){for(this.layer=new r.ui.Layer(this.ui),this.buffer=this.layer.buffer,this.io=this.layer.io,this.running=!0,this.scheduler=new r.scheduler.Scheduler,this.player=this._makePlayer(),this.map=this._makeMap(0),this._startMap(this.map,this.player),this.map.actors.forEach((t=>{this.scheduler.push(t,t.moveSpeed())})),this.draw();this.running;)await this.animate(),await this.runTurn()}draw(){this.map&&this.map.needsRedraw&&(this.map.drawInto(this.buffer),this.buffer.render())}finish(){this.running=!1,this.layer.finish()}async runTurn(){const t=this.scheduler.pop();if(!t)return void this.finish();let e=0;for(;0===e;)t===this.player?e=await this.playerTurn(t):"act"in t?e=await t.act(this):"tick"in t&&(e=await t.tick()),this.draw();e>=0&&this.scheduler.push(t,e)}async animate(){if(!this.layer.io._tweens.length)return;const t=setInterval((()=>{const t=r.io.makeTickEvent(16);this.layer.io.enqueue(t)}),16);for(;this.layer.io._tweens.length;){const t=await this.layer.io.nextTick();t&&t.dt&&(this.layer.io._tweens.forEach((e=>e&&e.tick(t.dt))),this.layer.io._tweens=this.layer.io._tweens.filter((t=>t&&t.isRunning()))),this.draw()}clearInterval(t)}async playerTurn(t){let e=0;const i=setInterval((()=>{const t=r.io.makeTickEvent(16);this.layer.io.enqueue(t)}),16);for(;!e&&this.running;){const i=await this.layer.io.nextEvent(-1);if(i)if(i.type===r.io.KEYPRESS){const s=r.io.handlerFor(i,this.keymap);if(s)if("string"==typeof s){const r=Ue(s);r&&(e=await r.call(this,t,i))}else"function"==typeof s&&(e=await s.call(this,t,i))}else i.type===r.io.TICK&&this.layer.tick(i)}return clearInterval(i),e}}});Q("NULL",{ch:"∅",fg:"white",bg:"black",flags:"L_BLOCKS_MOVE",name:"eerie nothingness",article:"an",priority:0}),Q("FLOOR",{ch:"·",fg:r.color.from([30,30,30]).rand(20,0,0,0),bg:r.color.from([2,2,10]).rand(0,2,2,0),priority:10,article:"the",flavor:"the stone floor"}),Q("DOOR",{ch:"+",fg:[100,40,40],bg:[30,60,60],priority:30,flags:"T_IS_DOOR, L_BLOCKS_EFFECTS, L_BLOCKS_ITEMS, L_BLOCKS_VISION, L_VISUALLY_DISTINCT",article:"a",effects:{enter:"TILE:DOOR_OPEN",open:"TILE:DOOR_OPEN_ALWAYS"},flavor:"a closed door"}),Q("DOOR_OPEN","DOOR",{ch:"'",fg:[100,40,40],bg:[30,60,60],priority:40,flags:"!L_BLOCKS_ITEMS, !L_BLOCKS_VISION",name:"open door",article:"an",effects:{tick:{chance:1e4,effects:"TILE:DOOR~!"},enter:null,open:null,close:"TILE:DOOR~!"},flavor:"an open door"}),Q("DOOR_OPEN_ALWAYS","DOOR_OPEN",{effects:{tick:null,close:"TILE:DOOR~!"},flavor:"an open door"}),Q("UP_STAIRS",{ch:"<",fg:[100,50,50],bg:[40,20,20],priority:200,flags:"T_UP_STAIRS, L_BLOCKED_BY_STAIRS, L_VISUALLY_DISTINCT, L_LIST_IN_SIDEBAR",name:"upward staircase",article:"an",effects:{player:"EMIT:UP_STAIRS"},flavor:"stairs leading upwards"}),Q("DOWN_STAIRS",{ch:">",fg:[100,50,50],bg:[40,20,20],priority:200,flags:"T_DOWN_STAIRS, L_BLOCKED_BY_STAIRS, L_VISUALLY_DISTINCT, L_LIST_IN_SIDEBAR",name:"downward staircase",article:"a",effects:{player:"EMIT:DOWN_STAIRS"},flavor:"downward leading stairs"}),Q("WALL",{ch:"#",fg:r.color.from([7,7,7]).rand(0,3,3,3),bg:r.color.from([40,40,40]).rand(10,10,0,5),priority:100,flags:"L_WALL_FLAGS",article:"a",name:"stone wall",description:"A wall made from rough cut stone.",flavor:"a rough stone wall"}),Q("IMPREGNABLE",{ch:"#",fg:r.color.from([7,7,7]).rand(0,3,3,3),bg:r.color.from([40,40,40]).rand(10,10,0,5),priority:100,flags:"L_WALL_FLAGS, IMPREGNABLE",article:"a",name:"impregnable wall",description:"A wall made from very hard stone.",flavor:"a very hard wall"}),Q("LAKE",{ch:"~",fg:r.color.from([5,8,20]).dance(10,0,4,15),bg:r.color.from([10,15,41]).dance(6,5,5,5),priority:50,flags:"T_DEEP_WATER",name:"deep water",article:"the",flavor:"some deep water"}),Q("SHALLOW",{ch:"·",fg:r.color.from([5,8,10]).dance(10,0,4,15),bg:r.color.from([10,30,30]).dance(6,0,10,10),priority:20,name:"shallow water",article:"the",flags:"T_SHALLOW_WATER",flavor:"some shallow water"}),Q("BRIDGE",{ch:"☰",fg:[100,40,40],priority:40,depth:"SURFACE",flags:"T_BRIDGE, L_VISUALLY_DISTINCT",article:"a",groundTile:"LAKE",flavor:"a bridge"}),t.action=Ye,t.actor=ue,t.ai=Qt,t.draw=Ge,t.effect=Ot,t.entity=v,t.flags=y,t.fx=ce,t.game=Ze,t.horde=Pe,t.item=Te,t.layer=kt,t.map=we,t.memory=Gt,t.path=Fe,t.player=Je,t.tile=J,Object.defineProperty(t,"__esModule",{value:!0})}));
//# sourceMappingURL=gw-map.min.js.map
