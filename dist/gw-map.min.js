!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("gw-utils")):"function"==typeof define&&define.amd?define(["exports","gw-utils"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).GWM={},t.GWU)}(this,(function(t,e){"use strict";function i(t){if(t&&t.__esModule)return t;var e=Object.create(null);return t&&Object.keys(t).forEach((function(i){if("default"!==i){var s=Object.getOwnPropertyDescriptor(t,i);Object.defineProperty(e,i,s.get?s:{enumerable:!0,get:function(){return t[i]}})}})),e.default=t,Object.freeze(e)}var s,r=i(e);!function(t){t[t.ALL_LAYERS=-1]="ALL_LAYERS",t[t.GROUND=0]="GROUND",t[t.SURFACE=1]="SURFACE",t[t.ITEM=2]="ITEM",t[t.ACTOR=3]="ACTOR",t[t.LIQUID=4]="LIQUID",t[t.GAS=5]="GAS",t[t.FX=6]="FX",t[t.UI=7]="UI"}(s||(s={}));const l=r.flag.fl;var a;!function(t){t[t.L_DESTROYED=l(1)]="L_DESTROYED",t[t.L_SECRETLY_PASSABLE=l(2)]="L_SECRETLY_PASSABLE",t[t.L_BLOCKS_MOVE=l(3)]="L_BLOCKS_MOVE",t[t.L_BLOCKS_VISION=l(4)]="L_BLOCKS_VISION",t[t.L_BLOCKS_SURFACE=l(6)]="L_BLOCKS_SURFACE",t[t.L_BLOCKS_LIQUID=l(8)]="L_BLOCKS_LIQUID",t[t.L_BLOCKS_GAS=l(7)]="L_BLOCKS_GAS",t[t.L_BLOCKS_ITEMS=l(5)]="L_BLOCKS_ITEMS",t[t.L_BLOCKS_ACTORS=l(11)]="L_BLOCKS_ACTORS",t[t.L_BLOCKS_EFFECTS=l(9)]="L_BLOCKS_EFFECTS",t[t.L_BLOCKS_DIAGONAL=l(10)]="L_BLOCKS_DIAGONAL",t[t.L_INTERRUPT_WHEN_SEEN=l(12)]="L_INTERRUPT_WHEN_SEEN",t[t.L_LIST_IN_SIDEBAR=l(13)]="L_LIST_IN_SIDEBAR",t[t.L_VISUALLY_DISTINCT=l(14)]="L_VISUALLY_DISTINCT",t[t.L_BRIGHT_MEMORY=l(15)]="L_BRIGHT_MEMORY",t[t.L_INVERT_WHEN_HIGHLIGHTED=l(16)]="L_INVERT_WHEN_HIGHLIGHTED",t[t.L_ON_MAP=l(17)]="L_ON_MAP",t[t.L_BLOCKED_BY_STAIRS=t.L_BLOCKS_ITEMS|t.L_BLOCKS_SURFACE|t.L_BLOCKS_GAS|t.L_BLOCKS_LIQUID|t.L_BLOCKS_EFFECTS|t.L_BLOCKS_ACTORS]="L_BLOCKED_BY_STAIRS",t[t.L_BLOCKS_SCENT=t.L_BLOCKS_MOVE|t.L_BLOCKS_VISION]="L_BLOCKS_SCENT",t[t.L_DIVIDES_LEVEL=t.L_BLOCKS_MOVE]="L_DIVIDES_LEVEL",t[t.L_WAYPOINT_BLOCKER=t.L_BLOCKS_MOVE]="L_WAYPOINT_BLOCKER",t[t.L_WALL_FLAGS=t.L_BLOCKS_MOVE|t.L_BLOCKS_VISION|t.L_BLOCKS_LIQUID|t.L_BLOCKS_GAS|t.L_BLOCKS_EFFECTS|t.L_BLOCKS_DIAGONAL]="L_WALL_FLAGS",t[t.L_BLOCKS_EVERYTHING=t.L_WALL_FLAGS|t.L_BLOCKS_ITEMS|t.L_BLOCKS_ACTORS|t.L_BLOCKS_SURFACE]="L_BLOCKS_EVERYTHING"}(a||(a={}));const n=r.flag.fl;var h,o;!function(t){t[t.IS_PLAYER=n(0)]="IS_PLAYER",t[t.HAS_MEMORY=n(1)]="HAS_MEMORY",t[t.USES_FOV=n(2)]="USES_FOV"}(h||(h={})),o||(o={});const c=r.flag.fl;var _;!function(t){t[t.T_BRIDGE=c(0)]="T_BRIDGE",t[t.T_AUTO_DESCENT=c(1)]="T_AUTO_DESCENT",t[t.T_LAVA=c(2)]="T_LAVA",t[t.T_DEEP_WATER=c(3)]="T_DEEP_WATER",t[t.T_IS_FLAMMABLE=c(5)]="T_IS_FLAMMABLE",t[t.T_SPONTANEOUSLY_IGNITES=c(6)]="T_SPONTANEOUSLY_IGNITES",t[t.T_IS_FIRE=c(7)]="T_IS_FIRE",t[t.T_EXTINGUISHES_FIRE=c(8)]="T_EXTINGUISHES_FIRE",t[t.T_IS_SECRET=c(9)]="T_IS_SECRET",t[t.T_IS_TRAP=c(10)]="T_IS_TRAP",t[t.T_SACRED=c(11)]="T_SACRED",t[t.T_UP_STAIRS=c(12)]="T_UP_STAIRS",t[t.T_DOWN_STAIRS=c(13)]="T_DOWN_STAIRS",t[t.T_PORTAL=c(14)]="T_PORTAL",t[t.T_IS_DOOR=c(15)]="T_IS_DOOR",t[t.T_ALLOWS_SUBMERGING=c(16)]="T_ALLOWS_SUBMERGING",t[t.T_ENTANGLES=c(17)]="T_ENTANGLES",t[t.T_REFLECTS=c(18)]="T_REFLECTS",t[t.T_STAND_IN_TILE=c(19)]="T_STAND_IN_TILE",t[t.T_CONNECTS_LEVEL=c(20)]="T_CONNECTS_LEVEL",t[t.T_BLOCKS_OTHER_LAYERS=c(21)]="T_BLOCKS_OTHER_LAYERS",t[t.T_HAS_STAIRS=t.T_UP_STAIRS|t.T_DOWN_STAIRS|t.T_PORTAL]="T_HAS_STAIRS",t[t.T_OBSTRUCTS_SCENT=t.T_AUTO_DESCENT|t.T_LAVA|t.T_DEEP_WATER|t.T_SPONTANEOUSLY_IGNITES|t.T_HAS_STAIRS]="T_OBSTRUCTS_SCENT",t[t.T_PATHING_BLOCKER=t.T_AUTO_DESCENT|t.T_IS_TRAP|t.T_LAVA|t.T_DEEP_WATER|t.T_IS_FIRE|t.T_SPONTANEOUSLY_IGNITES|t.T_ENTANGLES]="T_PATHING_BLOCKER",t[t.T_LAKE_PATHING_BLOCKER=t.T_AUTO_DESCENT|t.T_LAVA|t.T_DEEP_WATER|t.T_SPONTANEOUSLY_IGNITES]="T_LAKE_PATHING_BLOCKER",t[t.T_WAYPOINT_BLOCKER=t.T_AUTO_DESCENT|t.T_IS_TRAP|t.T_LAVA|t.T_DEEP_WATER|t.T_SPONTANEOUSLY_IGNITES]="T_WAYPOINT_BLOCKER",t[t.T_DIVIDES_LEVEL=t.T_AUTO_DESCENT|t.T_IS_TRAP|t.T_LAVA|t.T_DEEP_WATER]="T_DIVIDES_LEVEL",t[t.T_MOVES_ITEMS=t.T_DEEP_WATER|t.T_LAVA]="T_MOVES_ITEMS",t[t.T_CAN_BE_BRIDGED=t.T_AUTO_DESCENT|t.T_LAVA|t.T_DEEP_WATER]="T_CAN_BE_BRIDGED",t[t.T_IS_DEEP_LIQUID=t.T_LAVA|t.T_AUTO_DESCENT|t.T_DEEP_WATER]="T_IS_DEEP_LIQUID"}(_||(_={}));const f=r.flag.fl;var E;!function(t){t[t.TM_IS_WIRED=f(9)]="TM_IS_WIRED",t[t.TM_IS_CIRCUIT_BREAKER=f(10)]="TM_IS_CIRCUIT_BREAKER",t[t.TM_VANISHES_UPON_PROMOTION=f(15)]="TM_VANISHES_UPON_PROMOTION",t[t.TM_EXPLOSIVE_PROMOTE=f(21)]="TM_EXPLOSIVE_PROMOTE",t[t.TM_SWAP_ENCHANTS_ACTIVATION=f(25)]="TM_SWAP_ENCHANTS_ACTIVATION"}(E||(E={}));const g=r.flag.fl;var u;!function(t){t[t.PRESSURE_PLATE_DEPRESSED=g(0)]="PRESSURE_PLATE_DEPRESSED",t[t.SEARCHED_FROM_HERE=g(1)]="SEARCHED_FROM_HERE",t[t.KNOWN_TO_BE_SAFE=g(2)]="KNOWN_TO_BE_SAFE",t[t.CAUGHT_FIRE_THIS_TURN=g(3)]="CAUGHT_FIRE_THIS_TURN",t[t.EVENT_FIRED_THIS_TURN=g(4)]="EVENT_FIRED_THIS_TURN",t[t.EVENT_PROTECTED=g(5)]="EVENT_PROTECTED",t[t.IS_IN_LOOP=g(6)]="IS_IN_LOOP",t[t.IS_CHOKEPOINT=g(7)]="IS_CHOKEPOINT",t[t.IS_GATE_SITE=g(8)]="IS_GATE_SITE",t[t.IS_IN_ROOM_MACHINE=g(9)]="IS_IN_ROOM_MACHINE",t[t.IS_IN_AREA_MACHINE=g(10)]="IS_IN_AREA_MACHINE",t[t.IMPREGNABLE=g(11)]="IMPREGNABLE",t[t.NEEDS_REDRAW=g(13)]="NEEDS_REDRAW",t[t.STABLE_MEMORY=g(14)]="STABLE_MEMORY",t[t.STABLE_SNAPSHOT=g(15)]="STABLE_SNAPSHOT",t[t.HAS_PLAYER=g(16)]="HAS_PLAYER",t[t.HAS_ACTOR=g(27)]="HAS_ACTOR",t[t.HAS_DORMANT_MONSTER=g(18)]="HAS_DORMANT_MONSTER",t[t.HAS_ITEM=g(19)]="HAS_ITEM",t[t.IS_IN_PATH=g(20)]="IS_IN_PATH",t[t.IS_CURSOR=g(21)]="IS_CURSOR",t[t.HAS_TICK_EFFECT=g(22)]="HAS_TICK_EFFECT",t[t.IS_WIRED=g(26)]="IS_WIRED",t[t.IS_CIRCUIT_BREAKER=g(27)]="IS_CIRCUIT_BREAKER",t[t.IS_POWERED=g(28)]="IS_POWERED",t[t.COLORS_DANCE=g(30)]="COLORS_DANCE",t[t.CHANGED=t.NEEDS_REDRAW]="CHANGED",t[t.IS_IN_MACHINE=t.IS_IN_ROOM_MACHINE|t.IS_IN_AREA_MACHINE]="IS_IN_MACHINE",t[t.PERMANENT_CELL_FLAGS=t.HAS_ITEM|t.HAS_DORMANT_MONSTER|t.STABLE_MEMORY|t.SEARCHED_FROM_HERE|t.PRESSURE_PLATE_DEPRESSED|t.KNOWN_TO_BE_SAFE|t.IS_IN_LOOP|t.IS_CHOKEPOINT|t.IS_GATE_SITE|t.IS_IN_MACHINE|t.IMPREGNABLE]="PERMANENT_CELL_FLAGS",t[t.HAS_ANY_ACTOR=t.HAS_PLAYER|t.HAS_ACTOR]="HAS_ANY_ACTOR",t[t.HAS_ANY_OBJECT=t.HAS_ITEM|t.HAS_ANY_ACTOR]="HAS_ANY_OBJECT",t[t.CELL_DEFAULT=t.NEEDS_REDRAW]="CELL_DEFAULT"}(u||(u={}));const T=r.flag.fl;var d;!function(t){t[t.MAP_CHANGED=T(0)]="MAP_CHANGED",t[t.MAP_ALWAYS_LIT=T(3)]="MAP_ALWAYS_LIT",t[t.MAP_SAW_WELCOME=T(4)]="MAP_SAW_WELCOME",t[t.MAP_NO_LIQUID=T(5)]="MAP_NO_LIQUID",t[t.MAP_NO_GAS=T(6)]="MAP_NO_GAS",t[t.MAP_CALC_FOV=T(7)]="MAP_CALC_FOV",t[t.MAP_FOV_CHANGED=T(8)]="MAP_FOV_CHANGED",t[t.MAP_DANCES=T(9)]="MAP_DANCES",t[t.MAP_SIDEBAR_TILES_CHANGED=T(10)]="MAP_SIDEBAR_TILES_CHANGED",t[t.MAP_DEFAULT=0]="MAP_DEFAULT"}(d||(d={}));const S=r.flag.fl;var A;!function(t){t[t.E_NEXT_ALWAYS=S(0)]="E_NEXT_ALWAYS",t[t.E_NEXT_EVERYWHERE=S(1)]="E_NEXT_EVERYWHERE",t[t.E_FIRED=S(2)]="E_FIRED",t[t.E_NO_MARK_FIRED=S(3)]="E_NO_MARK_FIRED",t[t.E_PROTECTED=S(4)]="E_PROTECTED",t[t.E_TREAT_AS_BLOCKING=S(5)]="E_TREAT_AS_BLOCKING",t[t.E_PERMIT_BLOCKING=S(6)]="E_PERMIT_BLOCKING",t[t.E_ABORT_IF_BLOCKS_MAP=S(7)]="E_ABORT_IF_BLOCKS_MAP",t[t.E_BLOCKED_BY_ITEMS=S(8)]="E_BLOCKED_BY_ITEMS",t[t.E_BLOCKED_BY_ACTORS=S(9)]="E_BLOCKED_BY_ACTORS",t[t.E_BLOCKED_BY_OTHER_LAYERS=S(10)]="E_BLOCKED_BY_OTHER_LAYERS",t[t.E_SUPERPRIORITY=S(11)]="E_SUPERPRIORITY",t[t.E_SPREAD_CIRCLE=S(13)]="E_SPREAD_CIRCLE",t[t.E_SPREAD_LINE=S(14)]="E_SPREAD_LINE",t[t.E_EVACUATE_CREATURES=S(15)]="E_EVACUATE_CREATURES",t[t.E_EVACUATE_ITEMS=S(16)]="E_EVACUATE_ITEMS",t[t.E_BUILD_IN_WALLS=S(17)]="E_BUILD_IN_WALLS",t[t.E_MUST_TOUCH_WALLS=S(18)]="E_MUST_TOUCH_WALLS",t[t.E_NO_TOUCH_WALLS=S(19)]="E_NO_TOUCH_WALLS",t[t.E_CLEAR_GROUND=S(21)]="E_CLEAR_GROUND",t[t.E_CLEAR_SURFACE=S(22)]="E_CLEAR_SURFACE",t[t.E_CLEAR_LIQUID=S(23)]="E_CLEAR_LIQUID",t[t.E_CLEAR_GAS=S(24)]="E_CLEAR_GAS",t[t.E_CLEAR_TILE=S(25)]="E_CLEAR_TILE",t[t.E_CLEAR_CELL=t.E_CLEAR_GROUND|t.E_CLEAR_SURFACE|t.E_CLEAR_LIQUID|t.E_CLEAR_GAS]="E_CLEAR_CELL",t[t.E_ONLY_IF_EMPTY=t.E_BLOCKED_BY_ITEMS|t.E_BLOCKED_BY_ACTORS]="E_ONLY_IF_EMPTY",t[t.E_ACTIVATE_DORMANT_MONSTER=S(27)]="E_ACTIVATE_DORMANT_MONSTER",t[t.E_AGGRAVATES_MONSTERS=S(28)]="E_AGGRAVATES_MONSTERS",t[t.E_RESURRECT_ALLY=S(29)]="E_RESURRECT_ALLY"}(A||(A={}));const L=r.flag.fl;var p;!function(t){t[t.HORDE_DIES_ON_LEADER_DEATH=L(0)]="HORDE_DIES_ON_LEADER_DEATH",t[t.HORDE_IS_SUMMONED=L(1)]="HORDE_IS_SUMMONED",t[t.HORDE_SUMMONED_AT_DISTANCE=L(2)]="HORDE_SUMMONED_AT_DISTANCE",t[t.HORDE_NO_PERIODIC_SPAWN=L(4)]="HORDE_NO_PERIODIC_SPAWN",t[t.HORDE_ALLIED_WITH_PLAYER=L(5)]="HORDE_ALLIED_WITH_PLAYER",t[t.HORDE_NEVER_OOD=L(15)]="HORDE_NEVER_OOD"}(p||(p={}));var m=Object.freeze({__proto__:null,get Depth(){return s},get Entity(){return a},get Actor(){return h},get Item(){return o},get Tile(){return _},get TileMech(){return E},get Cell(){return u},get Map(){return d},get Effect(){return A},get Horde(){return p}});class I{constructor(t,e,i){this.x=t,this.y=e,this.disposable=i}matches(t,e){return this.x===t&&this.y===e}}let O=0;class y{constructor(t){this._map=null,this.key=null,this.machineHome=0,this.depth=1,this.light=null,this.flags={entity:0},this.next=null,this.x=-1,this.y=-1,this.kind=t,this.id=""+ ++O}get map(){return this._map}addToMap(t,e,i){if(this.hasEntityFlag(a.L_ON_MAP))throw new Error("Entity is currently on a map!");return this.x=e,this.y=i,this.setEntityFlag(a.L_ON_MAP),this._map!==t&&(this._map=t,this.kind.addToMap(this,t),!0)}removeFromMap(){this.clearEntityFlag(a.L_ON_MAP),this.kind.removeFromMap(this)}get sprite(){return this.kind.sprite}get isDestroyed(){return this.hasEntityFlag(a.L_DESTROYED)}isAt(t,e){return this.x===t&&this.y===e}clone(){const t=new this.constructor(this.kind);return t.copy(this),t}copy(t){this.depth=t.depth,this.light=t.light,Object.assign(this.flags,t.flags),this.next=t.next,this.x=t.x,this.y=t.y,this.kind=t.kind,this.id=t.id}canBeSeen(){return this.kind.canBeSeen(this)}destroy(){this.flags.entity|=a.L_DESTROYED}hasEntityFlag(t){return!!(this.flags.entity&t)}hasAllEntityFlags(t){return(this.flags.entity&t)===t}setEntityFlag(t){this.flags.entity|=t}clearEntityFlag(t){this.flags.entity&=~t}hasTag(t){return this.kind.tags.includes(t)}blocksMove(){return this.hasEntityFlag(a.L_BLOCKS_MOVE)}blocksVision(){return this.hasEntityFlag(a.L_BLOCKS_VISION)}blocksPathing(){return this.hasEntityFlag(a.L_BLOCKS_MOVE)}blocksEffects(){return this.hasEntityFlag(a.L_BLOCKS_EFFECTS)}isKey(t,e){return this.key&&this.key.matches(t,e)}forbidsCell(t){return this.kind.forbidsCell(t,this)}avoidsCell(t){return this.kind.avoidsCell(t,this)}getName(t){return this.kind.getName(this,t)}getDescription(t){return this.kind.getDescription(this,t)}getFlavor(t){return this.kind.getFlavor(this,t)}getVerb(t){return this.kind.getVerb(this,t)}drawStatus(t){this.kind.drawStatus(this,t)}drawInto(t,e){t.drawSprite(this.sprite)}toString(){return`${this.constructor.name}-${this.id} @ ${this.x},${this.y}`}}class R{constructor(t){this.tags=[],this.requiredTileTags=[],this.id=t.id||t.name,this.name=t.name,this.flavor=t.flavor||this.name,this.description=t.description||this.flavor,this.sprite=r.sprite.make(t),t.tags&&("string"==typeof t.tags?this.tags=t.tags.split(/[,|]/).map((t=>t.trim())):this.tags=t.tags.slice()),t.requiredTileTags&&("string"==typeof t.requiredTileTags?this.requiredTileTags=t.requiredTileTags.split(/[,|]/).map((t=>t.trim())):this.requiredTileTags=t.requiredTileTags.slice().map((t=>t.trim())))}make(t){const e=new y(this);return this.init(e,t),e}init(t,e={}){e.machineHome&&(t.machineHome=e.machineHome)}addToMap(t,e){}removeFromMap(t){}canBeSeen(t){return!0}forbidsCell(t,e){return!(!this.requiredTileTags.length||t.hasAllTileTags(this.requiredTileTags))}avoidsCell(t,e){return!(!this.requiredTileTags.length||t.hasAnyTileTag(this.requiredTileTags))}getName(t,e){return this.name}getDescription(t,e){return this.description}getFlavor(t,e){return this.flavor}getVerb(t,e){return e}drawStatus(t,e){t.map&&(t.isDestroyed||(t.map.getAppearanceAt(t.x,t.y,e.mixer),e.drawTitle(e.mixer,t.getName())))}}var C=Object.freeze({__proto__:null,KeyInfo:I,makeKeyInfo:function(t,e,i){return new I(t,e,i)},EntityKind:R,Entity:y});class N extends y{constructor(t){super(t),this.next=null,this.leader=null,this.items=null,this.fov=null,this.memory=null,this.visionDistance=99,this.flags.actor=0,this.depth=s.ACTOR,this.kind=t}copy(t){super.copy(t),this.leader=t.leader,this.items=t.items,this.fov=t.fov,this.memory=t.memory,this.visionDistance=t.visionDistance}hasActorFlag(t){return!!(this.flags.actor&t)}hasAllActorFlags(t){return(this.flags.actor&t)===t}actorFlags(){return this.flags.actor}isPlayer(){return this.hasActorFlag(h.IS_PLAYER)}canSee(t,e){return t instanceof y?this.canSee(t.x,t.y)&&this.kind.isAbleToSee(this,t):this.fov?this.fov.isDirectlyVisible(t,e):!!this.map&&r.xy.forLineBetween(this.x,this.y,t,e,((t,e)=>r.xy.distanceBetween(this.x,this.y,t,e)<=this.visionDistance&&!this.map.cell(t,e).blocksVision()))}canSeeOrSense(t,e){return t instanceof y?this.canSeeOrSense(t.x,t.y)&&(this.kind.isAbleToSee(this,t)||this.kind.isAbleToSense(this,t)):this.fov?this.fov.isAnyKindOfVisible(t,e):this.canSee(t,e)}isAbleToSee(t){return this.kind.isAbleToSee(this,t)}isAbleToSense(t){return this.kind.isAbleToSense(this,t)}async pickupItem(t,e){return this.kind.pickupItem(this,t,e)}async dropItem(t,e){return this.kind.dropItem(this,t,e)}}class D{make(t,e){return!0}fire(t,e,i,s,r){return!1}}const F={};function M(t,e){F[t]=e}function w(t){var e;if(!t)throw new Error("opts required to make effect.");if("string"==typeof t)throw new Error("Cannot make effect from string: "+t);"function"==typeof t&&(t={fn:t});const i={flags:r.flag.from(A,t.flags),chance:null!==(e=t.chance)&&void 0!==e?e:0,next:null,id:t.id||"n/a"};return t.next&&("string"==typeof t.next?i.next=t.next:i.next=w(t.next)),Object.values(F).forEach((e=>e.make(t,i))),i}function v(t){if(!t)throw new Error("Cannot make effect from null | undefined");if("string"==typeof t){const e=b[t];if(e)return e;throw new Error("Unknown effect - "+t)}return w(t)}function P(t){t.flags&=~A.E_FIRED}const b={};function B(t,e){const i=w(e);return b[t]=i,i.id=t,i}class k{constructor(t){var e,i,s,l;this.index=-1,this.dissipate=2e3,this.effects={},this.priority=50,this.depth=0,this.light=null,this.groundTile=null,this.tags=[],this.id=t.id||"n/a",this.dissipate=null!==(e=t.dissipate)&&void 0!==e?e:this.dissipate,this.priority=null!==(i=t.priority)&&void 0!==i?i:this.priority,this.depth=null!==(s=t.depth)&&void 0!==s?s:this.depth,this.light=t.light||null,this.groundTile=t.groundTile||null,this.sprite=r.sprite.make(t),this.name=t.name||"tile",this.description=t.description||this.name,this.flavor=t.flavor||this.name,this.article=null!==(l=t.article)&&void 0!==l?l:null,this.flags=t.flags||{entity:0,tile:0,tileMech:0},t.effects&&Object.assign(this.effects,t.effects),this.hasEffect("fire")&&(this.flags.tile|=_.T_IS_FLAMMABLE),t.tags&&("string"==typeof t.tags?t.tags.split(/[,|]/).map((t=>t.trim())).forEach((t=>{this.tags.push(t)})):this.tags=t.tags.slice().map((t=>t.trim())))}hasTag(t){return this.tags.includes(t)}hasAnyTag(t){return r.arraysIntersect(this.tags,t)}hasAllTags(t){return t.every((t=>this.tags.includes(t)))}hasEntityFlag(t){return!!(this.flags.entity&t)}hasTileFlag(t){return!!(this.flags.tile&t)}hasTileMechFlag(t){return!!(this.flags.tileMech&t)}hasAllEntityFlags(t){return(this.flags.entity&t)===t}hasAllTileFlags(t){return(this.flags.tile&t)===t}hasAllTileMechFlags(t){return(this.flags.tileMech&t)===t}blocksVision(){return!!(this.flags.entity&a.L_BLOCKS_VISION)}blocksMove(){return!!(this.flags.entity&a.L_BLOCKS_MOVE)}blocksPathing(){return this.blocksMove()||this.hasTileFlag(_.T_PATHING_BLOCKER)}blocksEffects(){return!!(this.flags.entity&a.L_BLOCKS_EFFECTS)}hasEffect(t){return t in this.effects}getName(t){let e={};if("boolean"==typeof t||"string"==typeof t?e.article=t:t&&(e=t),!e.article&&!e.color)return this.name;let i=this.name;if(e.color){let t=e.color;!0===e.color&&(t=this.sprite.fg||"white"),"string"!=typeof t&&(t=r.color.from(t).toString()),i=`Ω${t}Ω${this.name}∆`}if(e.article){i=("string"==typeof e.article?e.article:this.article||"a")+" "+i}return i}getDescription(t){return this.description||this.getName(t)}getFlavor(t){return this.flavor||this.getName(t)}}function H(t){var e,i,l,n,h,o;let c={effects:{},flags:{},sprite:{},priority:50};if(t.extends&&(c=U[t.extends],!c))throw new Error("Failed to find base tile: "+t.extends);let f=c.priority;if("string"==typeof t.priority){let e=t.priority.replace(/ /g,""),i=e.search(/[+-]/);if(0==i)f=c.priority+Number.parseInt(e);else if(-1==i)if(0==e.search(/[a-zA-Z]/)){const t=U[e];if(!t)throw new Error("Failed to find tile for priority - "+e+".");f=t.priority}else f=Number.parseInt(e);else{const t=e.substring(0,i),s=Number.parseInt(e.substring(i)),r=U[t];if(!r)throw new Error("Failed to find tile for priority - "+t+".");f=r.priority+s}}else void 0!==t.priority&&(f=t.priority);const g={};Object.assign(g,c.effects),t.effects&&Object.entries(t.effects).forEach((([t,e])=>{null!==e?g[t]="string"!=typeof e?w(e):e:delete g[t]}));const u={entity:r.flag.from(a,c.flags.entity,t.flags),tile:r.flag.from(_,c.flags.tile,t.flags),tileMech:r.flag.from(E,c.flags.tileMech,t.flags)};let T=c.depth||0;t.depth&&(T="string"==typeof t.depth?s[t.depth]:t.depth);let d=c.light;t.light?d=r.light.make(t.light):null===t.light&&(d=null);const S={id:t.id,flags:u,dissipate:null!==(e=t.dissipate)&&void 0!==e?e:c.dissipate,effects:g,priority:f,depth:T,light:d,groundTile:t.groundTile||null,ch:null!==(i=t.ch)&&void 0!==i?i:c.sprite.ch,fg:null!==(l=t.fg)&&void 0!==l?l:c.sprite.fg,bg:null!==(n=t.bg)&&void 0!==n?n:c.sprite.bg,opacity:null!==(h=t.opacity)&&void 0!==h?h:c.sprite.opacity,name:t.name||c.name,description:t.description||c.description,flavor:t.flavor||c.flavor,article:null!==(o=t.article)&&void 0!==o?o:c.article,tags:t.tags||null};return new k(S)}const U={},K=[];function x(t){return t instanceof k?t:"string"==typeof t?U[t]||null:K[t]||null}function Y(t,...e){let i=e[0];2==e.length&&(i=e[1],i.extends=e[0]),i.id=t;const s=H(i);return s.index=K.length,K.push(s),U[t]=s,s}Y("NULL",{ch:"∅",fg:"white",bg:"black",flags:"L_BLOCKS_MOVE",name:"eerie nothingness",article:"an",priority:0}),Y("FLOOR",{ch:"·",fg:[30,30,30,20,0,0,0],bg:[2,2,10,0,2,2,0],priority:10,article:"the",flavor:"the stone floor"}),Y("DOOR",{ch:"+",fg:[100,40,40],bg:[30,60,60],priority:30,flags:"T_IS_DOOR, L_BLOCKS_EFFECTS, L_BLOCKS_ITEMS, L_BLOCKS_VISION, L_VISUALLY_DISTINCT",article:"a",effects:{enter:{tile:"DOOR_OPEN"},open:{tile:"DOOR_OPEN_ALWAYS"}},flavor:"a closed door"}),Y("DOOR_OPEN","DOOR",{ch:"'",fg:[100,40,40],bg:[30,60,60],priority:40,flags:"!L_BLOCKS_ITEMS, !L_BLOCKS_VISION",name:"open door",article:"an",effects:{tick:{chance:1e4,tile:"DOOR",flags:"E_SUPERPRIORITY, E_ONLY_IF_EMPTY"},enter:null,open:null,close:{tile:"DOOR",flags:"E_SUPERPRIORITY, E_ONLY_IF_EMPTY"}},flavor:"an open door"}),Y("DOOR_OPEN_ALWAYS","DOOR_OPEN",{effects:{tick:null,close:{tile:"DOOR",flags:"E_SUPERPRIORITY, E_ONLY_IF_EMPTY"}},flavor:"an open door"}),Y("UP_STAIRS",{ch:"<",fg:[100,50,50],bg:[40,20,20],priority:200,flags:"T_UP_STAIRS, L_BLOCKED_BY_STAIRS, L_VISUALLY_DISTINCT, L_LIST_IN_SIDEBAR",name:"upward staircase",article:"an",effects:{player:{emit:"UP_STAIRS"}},flavor:"stairs leading upwards"}),Y("DOWN_STAIRS",{ch:">",fg:[100,50,50],bg:[40,20,20],priority:200,flags:"T_DOWN_STAIRS, L_BLOCKED_BY_STAIRS, L_VISUALLY_DISTINCT, L_LIST_IN_SIDEBAR",name:"downward staircase",article:"a",effects:{player:{emit:"DOWN_STAIRS"}},flavor:"downward leading stairs"}),Y("WALL",{ch:"#",fg:[7,7,7,0,3,3,3],bg:[40,40,40,10,10,0,5],priority:100,flags:"L_WALL_FLAGS",article:"a",name:"stone wall",description:"A wall made from rough cut stone.",flavor:"a rough stone wall"}),Y("IMPREGNABLE",{ch:"#",fg:[7,7,7,0,3,3,3],bg:[40,40,40,10,10,0,5],priority:100,flags:"L_WALL_FLAGS, IMPREGNABLE",article:"a",name:"impregnable wall",description:"A wall made from very hard stone.",flavor:"a very hard wall"}),Y("LAKE",{ch:"~",fg:[5,8,20,10,0,4,15,!0],bg:[10,15,41,6,5,5,5,!0],priority:50,flags:"T_DEEP_WATER",name:"deep water",article:"the",flavor:"some deep water"}),Y("SHALLOW",{ch:"·",fg:[5,8,10,10,0,4,15,!0],bg:[10,30,30,6,0,10,10,!0],priority:20,name:"shallow water",article:"the",depth:"SURFACE",flavor:"some shallow water"}),Y("BRIDGE",{ch:"=",fg:[100,40,40],priority:40,depth:"SURFACE",flags:"T_BRIDGE, L_VISUALLY_DISTINCT",article:"a",groundTile:"LAKE",flavor:"a bridge"});const G={Tile:_,TileMech:E};var V=Object.freeze({__proto__:null,flags:G,Tile:k,make:H,tiles:U,all:K,get:x,install:Y,installAll:function(t){Object.entries(t).forEach((([t,e])=>{Y(t,e)}))}});async function W(t,e,i,s,l={}){if(!t)return!1;if("string"==typeof t){const e=t;if(!(t=v(e)))throw new Error("Failed to find effect: "+e)}const a=l;if(!a.force&&t.chance&&!e.rng.chance(t.chance,1e4))return!1;const n=a.grid=r.grid.alloc(e.width,e.height);let h=!1;const o=Object.values(F);for(let r of o)await r.fire(t,e,i,s,a)&&(h=!0);if(t.next&&(h||t.flags&A.E_NEXT_ALWAYS)&&!r.data.gameHasEnded){const r="string"==typeof t.next?v(t.next):t.next;t.flags&A.E_NEXT_EVERYWHERE?await n.forEachAsync((async(t,i,s)=>{t&&(h=await W(r,e,i,s,a)||h)})):h=await W(r,e,i,s,a)||h}return!h||t.flags&A.E_NO_MARK_FIRED||(t.flags|=A.E_FIRED),r.grid.free(n),h}class j extends D{constructor(){super()}make(t,e){if(!t.emit)return!0;if("string"!=typeof t.emit)throw new Error('emit effects must be string name to emit: { emit: "EVENT" }');return e.emit=t.emit,!0}async fire(t,e,i,s,l){return!!t.emit&&(await r.events.emit(t.emit,i,s,l),!0)}}M("emit",new j);class X extends D{constructor(){super()}make(t,e){if(!t.fn)return!0;if("function"!=typeof t.fn)throw new Error("fn effects must be functions.");return e.fn=t.fn,!0}async fire(t,e,i,s,r){return!!t.fn&&await t.fn(t,e,i,s,r)}}M("fn",new X);class q extends D{constructor(){super()}make(t,e){if(!t.message)return!0;if("string"!=typeof t.message)throw new Error("Emit must be configured with name of event to emit");return e.message=t.message,!0}async fire(t,e,i,s,l){if(!t.message)return!1;const a=!!(t.flags&A.E_FIRED);return!(!t.message||!t.message.length||a)&&(r.message.addAt(i,s,t.message,l),!0)}}M("message",new q);class z extends D{constructor(){super()}make(t,e){return!t.activateMachine||(e.activateMachine=!0,!0)}async fire(t,e,i,s,r){if(t.activateMachine){const t=e.cell(i,s).machineId;return!!t&&await e.activateMachine(t,i,s,r)}return!1}}M("activateMachine",new z);class Q extends D{constructor(){super()}make(t,e){return!t.effect||(e.effect=t.effect,!0)}async fire(t,e,i,s,r){return!!t.effect&&await W(t.effect,e,i,s,r)}}M("effect",new Q);class $ extends D{constructor(){super()}make(t,e){var i,s,l,a,n,h,o;if(!t.tile)return!0;let c=t.tile;if("string"==typeof c){const t=c.split(/[,|]/).map((t=>t.trim()));c={tile:t[0],grow:Number.parseInt(t[1]||"0"),decrement:Number.parseInt(t[2]||"0")}}const _={grow:null!==(s=null!==(i=c.grow)&&void 0!==i?i:c.spread)&&void 0!==s?s:0,decrement:null!==(l=c.decrement)&&void 0!==l?l:0,flags:r.flag.from(A,c.flags),volume:null!==(a=c.volume)&&void 0!==a?a:0,next:null!==(n=c.next)&&void 0!==n?n:null},f=null!==(h=c.tile)&&void 0!==h?h:c.id;if("string"!=typeof f)throw new Error("Invalid tile spawn config: "+f);if(_.tile=f,!_.tile)throw new Error("Must have tile.");const E=null!==(o=c.matchTile)&&void 0!==o?o:c.match;if("string"==typeof E)_.matchTile=E;else if(E)throw new Error("Invalid tile spawn match tile: "+c.matchTile);return e.tile=_,!0}fire(t,e,i,s,r){if(!t.tile)return!1;const l=t.tile.tile,a=U[l]||null;if(!a)throw new Error("Failed to find tile for effect: "+l);const n=!!(t.flags&A.E_ABORT_IF_BLOCKS_MAP),h=!(!n||t.flags&A.E_PERMIT_BLOCKING||!(a.blocksPathing()||t.flags&A.E_TREAT_AS_BLOCKING));let o=!1;if(o=tt(t,e,i,s,r),!o)return!1;if(n&&h&&this.mapDisruptedBy(e,r.grid))return!1;t.flags&A.E_EVACUATE_CREATURES&&it(e,r.grid)&&(o=!0),t.flags&A.E_EVACUATE_ITEMS&&st(e,r.grid)&&(o=!0),t.flags&A.E_CLEAR_CELL&&et(e,r.grid,t.flags)&&(o=!0);return J(t.flags,r.grid,e,a,t.tile.volume,r.machine)}mapDisruptedBy(t,e,i=0,s=0){const l=r.grid.alloc(t.width,t.height);let a=!1;r.xy.forRect(t.width,t.height,((r,n)=>{const h=r+i,o=n+s;e.get(h,o)?t.cell(r,n).isStairs()&&(a=!0):t.cell(r,n).blocksMove()||(l[r][n]=1)}));let n=!0;for(let t=0;t<l.width&&!a;++t)for(let e=0;e<l.height&&!a;++e)1==l[t][e]&&(n?(l.floodFill(t,e,1,2),n=!1):a=!0);return r.grid.free(l),a}}function J(t,e,i,s,r=0,l){let a,n,h;h=!1;const o=!!(t&A.E_BLOCKED_BY_OTHER_LAYERS),c=!!(t&A.E_SUPERPRIORITY),_=!!(t&A.E_BLOCKED_BY_ACTORS),f=!!(t&A.E_BLOCKED_BY_ITEMS);for(r=r||0,a=0;a<e.width;a++)for(n=0;n<e.height;n++){if(!e[a][n])continue;e[a][n]=0;const E=i.cell(a,n);E.hasTile(s)||i.setTile(a,n,s,{volume:r,superpriority:c,blockedByOtherLayers:o,blockedByActors:_,blockedByItems:f,machine:l})&&(e[a][n]=1,E.flags.cell|=u.EVENT_FIRED_THIS_TURN,t&A.E_PROTECTED&&(E.flags.cell|=u.EVENT_PROTECTED),h=!0)}return h&&i.setMapFlag(d.MAP_CHANGED),h}function Z(t,e,i,s,l){if(!e.hasXY(i,s))return!1;const a=e.cell(i,s);if(a.hasCellFlag(u.EVENT_PROTECTED))return!1;if(a.blocksEffects()&&!t.tile.matchTile&&!l)return!1;if(t.flags&A.E_BUILD_IN_WALLS){if(!e.cell(i,s).isWall())return!1}else if(t.flags&A.E_MUST_TOUCH_WALLS){let t=!1;if(r.xy.eachNeighbor(i,s,((i,s)=>{e.cell(i,s).isWall()&&(t=!0)}),!0),!t)return!1}else if(t.flags&A.E_NO_TOUCH_WALLS){let t=!0;if(e.cell(i,s).isWall())return!1;if(r.xy.eachNeighbor(i,s,((i,s)=>{e.cell(i,s).isWall()&&(t=!1)}),!0),!t)return!1}return!(t.tile.matchTile&&!l&&!a.hasTile(t.tile.matchTile))}function tt(t,e,i,s,l){let a,n,h,o,c,_,f;const E=t.tile;let g=E.grow||0,u=E.decrement||0;const T=l.grid;if(T.fill(0),!Z(t,e,i,s,!0))return!1;T[i][s]=o=1;let d=1;if(g)for(f=!0,g>=100&&(u=u||100),u<=0&&(u=g);f&&g>0;){for(f=!1,o++,a=0;a<e.width;a++)for(n=0;n<e.height;n++)if(T[a][n]==o-1)for(h=0;h<4;h++)c=a+r.xy.DIRS[h][0],_=n+r.xy.DIRS[h][1],T.hasXY(c,_)&&!T[c][_]&&e.rng.chance(g)&&Z(t,e,c,_,!1)&&(T[c][_]=o,f=!0,++d);g-=u}return d>0}function et(t,e,i=0){let r=!1;const l=(i&A.E_CLEAR_CELL)===A.E_CLEAR_CELL;return e.forEach(((e,a,n)=>{if(!e)return;const h=t.cell(a,n);l?h.clear():(i&A.E_CLEAR_GAS&&h.clearDepth(s.GAS),i&A.E_CLEAR_LIQUID&&h.clearDepth(s.LIQUID),i&A.E_CLEAR_SURFACE&&h.clearDepth(s.SURFACE),i&A.E_CLEAR_GROUND&&h.clearDepth(s.GROUND)),r=!0})),r}function it(t,e){let i=!1;return t.eachActor((s=>{if(!e[s.x][s.y])return;const r=t.rng.matchingLocNear(s.x,s.y,((i,r)=>{if(!t.hasXY(i,r))return!1;if(e[i][r])return!1;const l=t.cell(i,r);return!s.forbidsCell(l)}));r&&r[0]>=0&&r[1]>=0&&(t.removeActor(s),t.addActor(r[0],r[1],s),i=!0)})),i}function st(t,e){let i=!1;return t.eachItem((s=>{if(!e[s.x][s.y])return;const r=t.rng.matchingLocNear(s.x,s.y,((i,r)=>{if(!t.hasXY(i,r))return!1;if(e[i][r])return!1;const l=t.cell(i,r);return!s.forbidsCell(l)}));r&&r[0]>=0&&r[1]>=0&&(t.removeItem(s),t.addItem(r[0],r[1],s),i=!0)})),i}M("tile",new $);M("clear",new class extends D{constructor(){super()}make(t,e){if(!t.clear)return!0;let i=t.clear,r=0;if("string"==typeof i&&(i=i.split(/[,|]/).map((t=>t.trim()))),!0===i)r=s.ALL_LAYERS;else if("number"==typeof i)r=i;else{if(!Array.isArray(i))throw new Error("clear effect must have number or string config.");r=i.reduce(((t,e)=>{if("number"==typeof e)return t|e;return t|(s[e]||0)}),0)}return e.clear=r,r>0}async fire(t,e,i,s,r){return this.fireSync(t,e,i,s,r)}fireSync(t,e,i,s,r){if(!t.clear)return!1;if(!e)return!1;return e.cell(i,s).clearDepth(t.clear)}});var rt=Object.freeze({__proto__:null,Handler:D,handlers:F,installHandler:M,make:w,from:v,reset:P,resetAll:function(){Object.values(b).forEach((t=>P(t)))},effects:b,install:B,installAll:function(t){Object.entries(t).forEach((([t,e])=>{B(t,e)}))},fire:W,EmitEffect:j,FnEffect:X,MessageEffect:q,ActivateMachineEffect:z,EffectEffect:Q,SpawnEffect:$,spawnTiles:J,computeSpawnMap:tt,clearCells:et,evacuateCreatures:it,evacuateItems:st});class lt{constructor(t,e,i,s){if(this.chokeCount=0,this.machineId=0,this.x=-1,this.y=-1,this.toFire=[],this.flags={cell:u.NEEDS_REDRAW},this.tiles=[U.NULL],this.map=t,this.x=e,this.y=i,this.snapshot=r.sprite.makeMixer(),s){const t=x(s);this.setTile(t)}}getSnapshot(t){t.copy(this.snapshot)}putSnapshot(t){this.snapshot.copy(t)}get hasStableSnapshot(){return this.hasCellFlag(u.STABLE_SNAPSHOT)}get hasStableMemory(){return this.hasCellFlag(u.STABLE_MEMORY)}copy(t){Object.assign(this.flags,t.flags),this.chokeCount=t.chokeCount,this.tiles.length=t.tiles.length;for(let e=0;e<this.tiles.length;++e)this.tiles[e]=t.tiles[e];this.machineId=t.machineId,this.map=t.map,this.x=t.x,this.y=t.y,t.getSnapshot(this.snapshot)}hasCellFlag(t){return!!(this.flags.cell&t)}setCellFlag(t){this.flags.cell|=t}clearCellFlag(t){this.flags.cell&=~t}hasEntityFlag(t,e=!1){var i,s;return!!this.tiles.some((e=>e&&e.flags.entity&t))||!!e&&(!(!this.hasItem()||!(null===(i=this.item)||void 0===i?void 0:i.hasEntityFlag(t)))||!(!this.hasActor()||!(null===(s=this.actor)||void 0===s?void 0:s.hasEntityFlag(t))))}hasAllEntityFlags(t,e=!1){return(this.entityFlags(e)&t)==t}hasTileFlag(t){return this.tiles.some((e=>e&&e.flags.tile&t))}hasAllTileFlags(t){return(this.tileFlags()&t)==t}hasTileMechFlag(t){return this.tiles.some((e=>e&&e.flags.tileMech&t))}hasAllTileMechFlags(t){return(this.tileMechFlags()&t)==t}hasTileTag(t){return this.tiles.some((e=>e&&e.hasTag(t)))}hasAllTileTags(t){return this.tiles.some((e=>e&&e.hasAllTags(t)))}hasAnyTileTag(t){return this.tiles.some((e=>e&&e.hasAnyTag(t)))}cellFlags(){return this.flags.cell}entityFlags(t=!1){var e,i;let s=this.tiles.reduce(((t,e)=>t|(e?e.flags.entity:0)),0);return t&&(this.hasItem()&&(s|=(null===(e=this.item)||void 0===e?void 0:e.flags.entity)||0),this.hasActor()&&(s|=(null===(i=this.actor)||void 0===i?void 0:i.flags.entity)||0)),s}tileFlags(){return this.tiles.reduce(((t,e)=>t|(e?e.flags.tile:0)),0)}tileMechFlags(){return this.tiles.reduce(((t,e)=>t|(e?e.flags.tileMech:0)),0)}get needsRedraw(){return!!(this.flags.cell&u.NEEDS_REDRAW)}set needsRedraw(t){t?this.flags.cell|=u.NEEDS_REDRAW:this.flags.cell&=~u.NEEDS_REDRAW}get changed(){return!!(this.flags.cell&u.CHANGED)}depthPriority(t){const e=this.tiles[t];return e?e.priority:U.NULL.priority}highestPriority(){return this.tiles.reduce(((t,e)=>Math.max(t,e?e.priority:0)),U.NULL.priority)}depthTile(t){return this.tiles[t]||null}hasTile(t){return t?(t instanceof k||(t=x(t)),this.tiles.includes(t)):this.tiles.some((t=>t))}hasDepthTile(t){const e=this.tiles[t];return!!e&&e!==U.NULL}highestPriorityTile(){return this.tiles.reduce(((t,e)=>e&&e.priority>=t.priority?e:t),U.NULL)}get tile(){return this.highestPriorityTile()}eachTile(t){this.tiles.forEach((e=>e&&t(e)))}tileWithObjectFlag(t){return this.tiles.find((e=>e&&e.flags.entity&t))||null}tileWithFlag(t){return this.tiles.find((e=>e&&e.flags.tile&t))||null}tileWithMechFlag(t){return this.tiles.find((e=>e&&e.flags.tileMech&t))||null}blocksVision(){return this.tiles.some((t=>t&&t.blocksVision()))}blocksPathing(){return this.tiles.some((t=>t&&t.blocksPathing()))}blocksMove(){return this.tiles.some((t=>t&&t.blocksMove()))}blocksEffects(){return this.tiles.some((t=>t&&t.blocksEffects()))}blocksLayer(t){return this.tiles.some((e=>e&&!!(e.flags.tile&G.Tile.T_BLOCKS_OTHER_LAYERS)&&e.depth!=t))}isNull(){return this.tiles.every((t=>!t||t===U.NULL))}isPassable(){return!this.blocksMove()}isWall(){return this.hasAllEntityFlags(a.L_WALL_FLAGS)}isStairs(){return this.hasTileFlag(_.T_HAS_STAIRS)}isFloor(){return!this.hasEntityFlag(a.L_BLOCKS_EVERYTHING)&&!this.hasTileFlag(_.T_PATHING_BLOCKER)}isGateSite(){return this.hasCellFlag(u.IS_GATE_SITE)}isSecretlyPassable(){return this.hasEntityFlag(a.L_SECRETLY_PASSABLE)}setTile(t,e={}){if(!(t instanceof k||(t=x(t))))return!1;const i=this.tiles[t.depth]||U.NULL;if(i===t)return!1;if(!e.superpriority&&i.priority>t.priority)return!1;if(this.blocksLayer(t.depth))return!1;if(e.blockedByItems&&this.hasItem())return!1;if(e.blockedByActors&&this.hasActor())return!1;if(e.blockedByOtherLayers&&this.highestPriority()>t.priority)return!1;if(t.depth>s.GROUND&&t.groundTile){const e=this.depthTile(s.GROUND);e&&e!==U.NULL||(this.tiles[0]=x(t.groundTile))}return this.tiles[t.depth]=t,this.needsRedraw=!0,t.hasEntityFlag(a.L_BLOCKS_SURFACE)&&this.clearDepth(s.SURFACE),e.machine&&(this.machineId=e.machine),i.light!==t.light&&(this.map.light.glowLightChanged=!0),i.hasEntityFlag(a.L_LIST_IN_SIDEBAR)!==t.hasEntityFlag(a.L_LIST_IN_SIDEBAR)&&this.map.setMapFlag(d.MAP_SIDEBAR_TILES_CHANGED),t.hasTileFlag(_.T_IS_FIRE)&&this.setCellFlag(u.CAUGHT_FIRE_THIS_TURN),!0}clearTiles(t){this.tiles[0]=U.NULL;for(let t=1;t<this.tiles.length;++t)this.tiles[t]=null;t&&this.setTile(t),this.needsRedraw=!0}clear(t){this.tiles=[U.NULL],this.flags.cell=0,this.needsRedraw=!0,this.chokeCount=0,this.machineId=0,t&&this.setTile(t),this.snapshot.blackOut()}clearDepth(t){return 0==t?(this.tiles[0]=U.NULL,this.needsRedraw=!0,!0):null!==this.tiles[t]&&(this.tiles[t]=null,this.needsRedraw=!0,!0)}clearDepthsWithFlags(t,e=0){for(let i=0;i<this.tiles.length;++i){const s=this.tiles[i];s&&(s.hasTileFlag(t)&&(e&&!s.hasTileMechFlag(e)||this.clearDepth(i)))}}eachGlowLight(t){this.tiles.forEach((e=>{e&&e.light&&t(e.light)}))}needsToFire(){return this.toFire.length>0}willFire(t){return!!this.toFire.find((e=>e.event===t))}clearEvents(){this.toFire.length=0}tileWithEffect(t){return this.tiles.find((e=>null==e?void 0:e.hasEffect(t)))||null}async fireAll(){let t,e=!1;for(t of this.toFire)e=await this.fireEvent(t.event,t)||e;return this.toFire.length=0,e}async fireEvent(t,e={}){e.cell=this;let i=!1;for(e.tile of this.tiles){if(!e.tile||!e.tile.effects)continue;const s=e.tile.effects[t];s&&await this._activate(s,e)&&(i=!0)}return i}async _activate(t,e){"string"==typeof t&&(t=b[t]);let i=!1;return t&&(i=await W(t,this.map,this.x,this.y,e)),i}hasEffect(t){for(let e of this.tiles)if(e&&e.hasEffect(t))return!0;return!1}hasItem(){return this.hasCellFlag(u.HAS_ITEM)}get item(){return this.map.itemAt(this.x,this.y)}addItem(t,e=!1){if(this.setCellFlag(u.HAS_ITEM),t.addToMap(this.map,this.x,this.y),this.map.items.push(t),this.needsRedraw=!0,this.clearCellFlag(u.STABLE_SNAPSHOT),e)if(t.key&&t.key.matches(this.x,this.y)&&this.hasEffect("key")){const e=this.tileWithEffect("key");this.toFire.push({event:"key",key:t,item:t,tile:e,cell:this})}else if(this.hasEffect("add_item")){const e=this.tileWithEffect("add_item");this.toFire.push({event:"add_item",item:t,tile:e,cell:this})}}removeItem(t,e=!1){let i=!1,s=-1;if(this.map.items.forEach(((e,r)=>{e===t?s=r:e.x===this.x&&e.y===this.y&&(i=!0)})),i||this.clearCellFlag(u.HAS_ITEM),s<0)return!1;if(this.map.items.splice(s,1),t.removeFromMap(),this.needsRedraw=!0,this.clearCellFlag(u.STABLE_SNAPSHOT),e)if(t.isKey(this.x,this.y)&&this.hasEffect("no_key")){const e=this.tileWithEffect("no_key");this.toFire.push({event:"no_key",key:t,item:t,tile:e,cell:this})}else if(this.hasEffect("remove_item")){const e=this.tileWithEffect("remove_item");this.toFire.push({event:"remove_item",item:t,tile:e,cell:this})}return!0}hasActor(){return this.hasCellFlag(u.HAS_ACTOR)}hasPlayer(){return this.hasCellFlag(u.HAS_PLAYER)}get actor(){return this.map.actorAt(this.x,this.y)}addActor(t,e=!1){if(this.setCellFlag(u.HAS_ACTOR),t.isPlayer()&&this.setCellFlag(u.HAS_PLAYER),t.addToMap(this.map,this.x,this.y),this.map.actors.push(t),this.needsRedraw=!0,this.clearCellFlag(u.STABLE_SNAPSHOT),e)if(t.isKey(this.x,this.y)&&this.hasEffect("key")){const e=this.tileWithEffect("key");this.toFire.push({event:"key",key:t,actor:t,tile:e,cell:this})}else if(t.isPlayer()&&this.hasEffect("add_player")){const e=this.tileWithEffect("add_player");this.toFire.push({event:"add_player",actor:t,player:t,tile:e,cell:this})}else if(this.hasEffect("add_actor")){const e=this.tileWithEffect("add_actor");this.toFire.push({event:"add_actor",actor:t,tile:e,cell:this})}}removeActor(t,e=!1){let i=!1,s=-1;if(this.map.actors.forEach(((e,r)=>{e===t?s=r:e.x===this.x&&e.y===this.y&&(i=!0)})),i||this.clearCellFlag(u.HAS_ACTOR|u.HAS_PLAYER),s<0)return!1;if(t.removeFromMap(),this.map.actors.splice(s,1),this.needsRedraw=!0,this.clearCellFlag(u.STABLE_SNAPSHOT),e)if(t.isKey(this.x,this.y)&&this.hasEffect("no_key")){const e=this.tileWithEffect("no_key");this.toFire.push({event:"no_key",key:t,actor:t,tile:e,cell:this})}else if(t.isPlayer()&&this.hasEffect("remove_player")){const e=this.tileWithEffect("remove_player");this.toFire.push({event:"remove_player",actor:t,player:t,tile:e,cell:this})}else if(this.hasEffect("remove_actor")){const e=this.tileWithEffect("remove_actor");this.toFire.push({event:"remove_actor",actor:t,tile:e,cell:this})}return!0}getDescription(){return this.highestPriorityTile().description}getFlavor(){return this.highestPriorityTile().flavor}getName(t={}){return this.highestPriorityTile().getName(t)}dump(){if(this.hasActor()){const t=this.map.actorAt(this.x,this.y);if(t&&t.sprite.ch)return t.sprite.ch}if(this.hasItem()){const t=this.map.itemAt(this.x,this.y);if(t&&t.sprite.ch)return t.sprite.ch}return this.highestPriorityTile().sprite.ch||" "}drawStatus(t){this.map&&(this.map.getAppearanceAt(this.x,this.y,t.mixer),t.drawTitle(t.mixer,this.getName()))}toString(){return`Cell @ ${this.x},${this.y}`}}class at{constructor(t,e="layer"){this.changed=!1,this.map=t,this.depth=-1,this.properties={},this.name=e}copy(t){}clear(){}setTile(t,e,i,s){return!1}clearTile(t,e){return!1}addActor(t,e,i){return!1}forceActor(t,e,i){return!1}removeActor(t){return!1}addItem(t,e,i){return!1}forceItem(t,e,i){return!1}removeItem(t){return!1}tick(t){return!1}}class nt extends at{constructor(t,e="tile"){super(t,e)}setTile(t,e,i,s){return this.map.cell(t,e).setTile(i,s)}clearTile(t,e){return this.map.cell(t,e).clearDepth(this.depth)}async tick(t){return!0}}class ht extends at{constructor(t,e="actor"){super(t,e)}}class ot extends at{constructor(t,e="item"){super(t,e)}}class ct extends nt{constructor(t,e="gas"){super(t,e),this.volume=r.grid.alloc(t.width,t.height,0)}clear(){this.volume.fill(0)}setTile(t,e,i,s={}){if(!s.volume)return!1;return this.map.cell(t,e).depthTile(i.depth)===i?(this.volume[t][e]+=s.volume,!0):!!super.setTile(t,e,i,s)&&(this.volume[t][e]=s.volume,this.changed=!0,!0)}clearTile(t,e){return!!this.map.cell(t,e).clearDepth(this.depth)&&(this.volume[t][e]=0,!0)}copy(t){this.volume.copy(t.volume),this.changed=t.changed}async tick(t){if(!this.changed)return!1;this.changed=!1;const e=this.volume;return this.volume=r.grid.alloc(this.map.width,this.map.height),this.dissipate(e),this.spread(e),r.grid.free(e),!0}dissipate(t){t.update(((t,e,i)=>{if(!t)return 0;const s=this.map.cell(e,i).depthTile(this.depth);if(s&&s.dissipate){let e=Math.max(.5,t*s.dissipate/1e4);t=Math.max(0,t-e)}return t?this.changed=!0:this.clearTile(e,i),t}))}calcOpacity(t){return Math.floor(10*Math.min(t,10))}updateCellVolume(t,e,i){let s=0,r=0,l=0;const n=this.map.cell(t,e);let h=n.depthTile(this.depth),o=h;if(n.hasEntityFlag(a.L_BLOCKS_GAS))return this.volume[t][e]=0,void(i[t][e]&&this.clearTile(t,e));for(let h=Math.max(0,t-1);h<Math.min(t+2,i.width);++h)for(let t=Math.max(0,e-1);t<Math.min(e+2,i.height);++t){const e=i[h][t];n.hasEntityFlag(a.L_BLOCKS_GAS)||(++r,e>l&&(l=e,o=this.map.cell(h,t).depthTile(this.depth))),s+=e}const c=Math.floor(10*s/r)/10;this.volume[t][e]=c,c>0&&o&&(h&&h===o||n.setTile(o)),c>0&&(n.needsRedraw=!0)}spread(t){for(let e=0;e<t.width;++e)for(let i=0;i<t.height;++i)this.updateCellVolume(e,i,t)}}const _t=s,ft=a,Et=_,gt=E,ut=u;class Tt extends nt{constructor(t,e="tile"){super(t,e)}async tick(t){for(let t=0;t<this.map.width;++t)for(let e=0;e<this.map.height;++e){this.map.cell(t,e).clearCellFlag(ut.CAUGHT_FIRE_THIS_TURN)}for(let t=0;t<this.map.width;++t)for(let e=0;e<this.map.height;++e){const i=this.map.cell(t,e);if(i.hasTileFlag(Et.T_IS_FIRE)&&!(i.flags.cell&ut.CAUGHT_FIRE_THIS_TURN)){await this.exposeToFire(t,e,!1);for(let i=0;i<4;++i){const s=r.xy.DIRS[i];await this.exposeToFire(t+s[0],e+s[1])}}}return!0}async exposeToFire(t,e,i=!1){let s=0,l=0,a=0,n=!1,h=!1;const o=this.map.cell(t,e);if(!o.hasTileFlag(Et.T_IS_FLAMMABLE))return!1;if(o.eachTile((t=>{t.hasTileFlag(Et.T_EXTINGUISHES_FIRE)&&t.priority>l&&(l=t.priority)})),o.eachTile((t=>{if(t.flags.tile&Et.T_IS_FLAMMABLE&&(t.depth===_t.GAS||t.priority>=l)){const e=v(t.effects.fire);e&&e.chance>s&&(s=e.chance)}})),i||s&&this.map.rng.chance(s,1e4)){n=!0,o.hasTileMechFlag(gt.TM_EXPLOSIVE_PROMOTE)&&(r.xy.eachNeighbor(t,e,((t,e)=>{const i=this.map.cell(t,e);(i.hasEntityFlag(ft.L_BLOCKS_GAS)||i.hasTileFlag(Et.T_IS_FIRE)||i.hasTileMechFlag(gt.TM_EXPLOSIVE_PROMOTE))&&++a})),a>=8&&(h=!0));let i="fire";h&&o.hasEffect("explode")&&(i="explode"),await o.fireEvent(i,{force:!0}),o.needsRedraw=!0}return n}}var dt=Object.freeze({__proto__:null,MapLayer:at,TileLayer:nt,ActorLayer:ht,ItemLayer:ot,GasLayer:ct,FireLayer:Tt});class St{isAnyKindOfVisible(t){return!0}drawInto(t,e,i={}){const s=t instanceof r.canvas.DataBuffer?t:t.buffer,l=i.offsetX||0,a=i.offsetY||0,n=new r.sprite.Mixer;for(let t=0;t<s.width;++t)for(let r=0;r<s.height;++r)if(e.hasXY(t+l,r+a)){const h=e.cell(t+l,r+a);this.drawCell(n,h,i.fov),s.drawSprite(t,r,n)}}drawCell(t,e,i){t.blackOut();const s=!i||i.isAnyKindOfVisible(e.x,e.y);return!e.hasCellFlag(u.STABLE_SNAPSHOT)||e.needsRedraw&&s?(this.getAppearance(t,e),e.putSnapshot(t),e.needsRedraw=!1,e.setCellFlag(u.STABLE_SNAPSHOT)):e.getSnapshot(t),this.applyLight(t,e,i),e.hasEntityFlag(a.L_VISUALLY_DISTINCT)&&r.color.separate(t.fg,t.bg),!0}getAppearance(t,e){const i=e.tiles[s.GROUND],l=e.tiles[s.SURFACE],a=e.tiles[s.LIQUID],n=e.tiles[s.GAS],h=e.hasActor()?e.map.actorAt(e.x,e.y):null,o=e.hasItem()?e.map.itemAt(e.x,e.y):null;if(t.drawSprite(i.sprite),l&&t.drawSprite(l.sprite),a&&t.drawSprite(a.sprite),o&&o.drawInto(t),h&&h.drawInto(t),n){const e=r.rng.cosmetic.number(50)+25;t.drawSprite(n.sprite,e)}t.dances?e.setCellFlag(u.COLORS_DANCE):e.clearCellFlag(u.COLORS_DANCE),t.bake()}applyLight(t,e,i){const s=!i||i.isAnyKindOfVisible(e.x,e.y),r=!i||i.isRevealed(e.x,e.y);if(s){const i=e.map.light.getLight(e.x,e.y);t.multiply(i)}else r?t.scale(50):t.blackOut()}}class At{constructor(t,e,i={}){this.machineCount=0,this._seed=0,this.rng=r.rng.random,this.id="MAP",this.actors=[],this.items=[],this.width=t,this.height=e,this.flags={map:0},this.layers=[],i.id&&(this.id=i.id),this.drawer=i.drawer||new St,this.cells=r.grid.make(t,e,((t,e)=>new lt(this,t,e))),i.seed&&(this._seed=i.seed,this.rng=r.rng.make(i.seed)),this.light=new r.light.LightSystem(this,i),this.properties={},this.initLayers()}get seed(){return this._seed}set seed(t){this._seed=t,this.rng=r.rng.make(t)}initLayers(){this.addLayer(s.GROUND,new nt(this,"ground")),this.addLayer(s.SURFACE,new Tt(this,"surface")),this.addLayer(s.GAS,new ct(this,"gas")),this.addLayer(s.ITEM,new ot(this,"item")),this.addLayer(s.ACTOR,new ht(this,"actor"))}addLayer(t,e){"number"!=typeof t&&(t=s[t]),e.depth=t,this.layers[t]=e}removeLayer(t){if("number"!=typeof t&&(t=s[t]),!t)throw new Error("Cannot remove layer with depth=0.");delete this.layers[t]}getLayer(t){return"number"!=typeof t&&(t=s[t]),this.layers[t]||null}hasXY(t,e){return this.cells.hasXY(t,e)}isBoundaryXY(t,e){return 0==t||0==e||t==this.width-1||e==this.height-1}cell(t,e){return this.cells[t][e]}get(t,e){return this.cells.get(t,e)}eachCell(t){this.cells.forEach(((e,i,s)=>t(e,i,s,this)))}hasItem(t,e){return this.cell(t,e).hasItem()}itemAt(t,e){return this.items.find((i=>i.isAt(t,e)))||null}eachItem(t){this.items.forEach(t)}addItem(t,e,i,s=!1){if(!this.hasXY(t,e))return!1;const r=this.cell(t,e);return r.addItem(i,s),!s||r.fireAll().then((()=>!0))}removeItem(t,e=!1){const i=this.cell(t.x,t.y);return!!i.removeItem(t,e)&&(!e||i.fireAll().then((()=>!0)))}hasPlayer(t,e){return this.cell(t,e).hasPlayer()}actorAt(t,e){return this.actors.find((i=>i.isAt(t,e)))||null}eachActor(t){this.actors.forEach(t)}addActor(t,e,i,s=!1){if(!this.hasXY(t,e))return!1;const r=this.cell(t,e);return r.addActor(i,s),!s||r.fireAll().then((()=>!0))}removeActor(t,e=!1){const i=this.cell(t.x,t.y);return!!i.removeActor(t,e)&&(!e||i.fireAll().then((()=>!0)))}hasKey(t,e){const i=this.actorAt(t,e);if(i&&i.isKey(t,e))return!0;const s=this.itemAt(t,e);return!(!s||!s.isKey(t,e))}count(t){return this.cells.count(((e,i,s)=>t(e,i,s,this)))}dump(t,e=console.log){this.cells.dump(t||(t=>t.dump()),e)}hasMapFlag(t){return!!(this.flags.map&t)}setMapFlag(t){this.flags.map|=t}clearMapFlag(t){this.flags.map&=~t}setCellFlag(t,e,i){this.cell(t,e).setCellFlag(i)}clearCellFlag(t,e,i){this.cell(t,e).clearCellFlag(i)}clear(){this.light.glowLightChanged=!0,this.layers.forEach((t=>t.clear()))}clearCell(t,e,i){this.cell(t,e).clear(i)}fill(t,e){let i,s;for(t=x(t),e=x(e||t),i=0;i<this.width;++i)for(s=0;s<this.height;++s){this.cells[i][s].clear(this.isBoundaryXY(i,s)?e:t)}}hasTile(t,e,i){return this.cell(t,e).hasTile(i)}forceTile(t,e,i){return this.setTile(t,e,i,{superpriority:!0})}setTile(t,e,i,s){if(!(i instanceof k||(i=x(i))))return!1;!0===s&&(s={superpriority:!0});const r=i.depth||0,l=this.layers[r]||this.layers[0];return l instanceof nt&&l.setTile(t,e,i,s)}clearTiles(t,e,i){this.cell(t,e).clearTiles(i)}async tick(t){let e=await this.fireAll("tick");for(let i of this.layers)i&&await i.tick(t)&&(e=!0);return e}copy(t){if(this.constructor!==t.constructor)throw new Error("Maps must be same type to copy.");if(this.width!==t.width||this.height!==t.height)throw new Error("Maps must be same size to copy");this.cells.forEach(((e,i,s)=>{e.copy(t.cell(i,s))})),this.layers.forEach(((e,i)=>{e.copy(t.layers[i])})),this.actors=t.actors.slice(),this.items=t.items.slice(),this.flags.map=t.flags.map,this.light.copy(t.light),this.rng=t.rng,this.machineCount=t.machineCount,this._seed=t._seed,this.properties=Object.assign({},t.properties)}clone(){const t=new this.constructor(this.width,this.height);return t.copy(this),t}async fire(t,e,i,s={}){return this.cell(e,i).fireEvent(t,s)}async fireAll(t,e={}){const i=r.grid.alloc(this.width,this.height);return this.cells.forEach(((e,s,l)=>{e.clearCellFlag(u.EVENT_FIRED_THIS_TURN|u.EVENT_PROTECTED),e.eachTile((n=>{const h=n.effects[t];if(!h)return;const o=v(h);if(!o)return;let c=0;o.chance<0?(c=0,r.xy.eachNeighbor(s,l,((t,i)=>{const s=this.cell(t,i);s.hasEntityFlag(a.L_BLOCKS_EFFECTS)||s.depthTile(n.depth)==e.depthTile(n.depth)||s.hasCellFlag(u.CAUGHT_FIRE_THIS_TURN)||(c+=-1*o.chance)}),!0)):c=o.chance||1e4,!e.hasCellFlag(u.CAUGHT_FIRE_THIS_TURN)&&this.rng.chance(c,1e4)&&(i[s][l]|=r.flag.fl(n.depth))}))})),e.force=!0,await i.forEachAsync((async(e,i,l)=>{if(!e)return;const a=this.cell(i,l);if(!a.hasCellFlag(u.EVENT_FIRED_THIS_TURN))for(let i=0;i<=s.GAS;++i)e&r.flag.fl(i)&&await a.fireEvent(t,{force:!0,depth:i})})),r.grid.free(i),!1}async activateMachine(t,e,i,s={}){let r=!1;s.originX=e,s.originY=i;for(let e=0;e<this.width;++e)for(let i=0;i<this.height;++i){const l=this.cell(e,i);l.machineId===t&&(l.hasEffect("machine")&&(r=await l.fireEvent("machine",s)||r))}return r}drawInto(t,e){this.drawer.drawInto(t,this,e)}getAppearanceAt(t,e,i){const s=this.cell(t,e);return this.drawer.drawCell(i,s)}hasActor(t,e){return this.cell(t,e).hasActor()}eachGlowLight(t){this.cells.forEach(((e,i,s)=>{e.eachGlowLight((e=>t(i,s,e)))}))}eachDynamicLight(t){}eachViewport(t){}lightingChanged(){return this.light.changed}hasVisibleLight(t,e){return!this.light.isDark(t,e)}blocksVision(t,e){return this.cell(t,e).blocksVision()}}function Lt(t,e,i={},s){"string"==typeof i&&(i={tile:i}),s&&(i.boundary=s),!0===i.tile&&(i.tile="FLOOR"),!0===i.boundary&&(i.boundary="WALL");const r=new At(t,e,i);return i.tile&&(r.fill(i.tile,i.boundary),r.light.update()),r}class pt extends At{constructor(t){super(t.width,t.height),this.source=t,this.cells.forEach((t=>t.setCellFlag(u.STABLE_MEMORY)))}cell(t,e){let i=this.cells[t][e];return i.hasCellFlag(u.STABLE_MEMORY)||(i=this.source.cell(t,e)),i}memory(t,e){return this.cells[t][e]}isMemory(t,e){return this.cells[t][e].hasCellFlag(u.STABLE_MEMORY)}setTile(){throw new Error("Cannot set tiles on memory.")}addItem(){throw new Error("Cannot add Items to memory!")}removeItem(){throw new Error("Cannot remove Items from memory!")}eachItem(t){this.source.eachItem((e=>{if(!this.isMemory(e.x,e.y)){t(e);const i=this.items.find((t=>t.id==e.id));if(i){this.cell(i.x,i.y).clearCellFlag(u.HAS_ITEM|u.STABLE_SNAPSHOT),r.arrayDelete(this.items,i)}}})),this.items.forEach(t)}addActor(){throw new Error("Cannot add Actors to memory!")}removeActor(){throw new Error("Cannot remove Actors from memory!")}eachActor(t){this.source.eachActor((e=>{if(!this.isMemory(e.x,e.y)){t(e);const i=this.actors.find((t=>t.id==e.id));if(i){this.cell(i.x,i.y).clearCellFlag(u.HAS_ACTOR|u.STABLE_SNAPSHOT),r.arrayDelete(this.actors,i)}}})),this.actors.forEach(t)}storeMemory(t,e){const i=this.memory(t,e),s=i.hasEntityFlag(a.L_LIST_IN_SIDEBAR,!0);i.hasItem()&&(this.items=this.items.filter((i=>i.x!==t||i.y!==e))),i.hasActor()&&(this.actors=this.actors.filter((i=>i.x!==t||i.y!==e)));const r=this.source.cell(t,e);i.copy(r),i.setCellFlag(u.STABLE_MEMORY);let l=i.hasEntityFlag(a.L_LIST_IN_SIDEBAR);if(r.hasItem()){const i=this.source.itemAt(t,e);i&&(this.items.push(i.clone()),i.hasEntityFlag(a.L_LIST_IN_SIDEBAR)&&(l=!0))}if(r.hasActor()){const i=this.source.actorAt(t,e);i&&(this.actors.push(i.clone()),i.hasEntityFlag(a.L_LIST_IN_SIDEBAR)&&(l=!0))}s!=l&&this.setMapFlag(d.MAP_SIDEBAR_TILES_CHANGED),this.light.setLight(t,e,this.source.light.getLight(t,e))}forget(t,e){const i=this.memory(t,e),s=i.hasEntityFlag(a.L_LIST_IN_SIDEBAR,!0);i.hasItem()&&(this.items=this.items.filter((i=>i.x!==t||i.y!==e))),i.hasActor()&&(this.actors=this.actors.filter((i=>i.x!==t||i.y!==e))),i.clearCellFlag(u.STABLE_MEMORY),s!=this.source.cell(t,e).hasEntityFlag(a.L_LIST_IN_SIDEBAR,!0)&&this.setMapFlag(d.MAP_SIDEBAR_TILES_CHANGED)}onFovChange(t,e,i){i?this.forget(t,e):this.storeMemory(t,e)}}const mt={};function It(t,e,i){let s=mt[t.id];s||(mt[t.id]=s={}),s[e.id]=i}function Ot(t,e){let i=mt[t.id];if(i){const t=i[e.id];if(t)return t}return new pt(e)}var yt=Object.freeze({__proto__:null,Memory:pt,store:It,get:Ot});class Rt extends R{constructor(t){super(t),this.flags={actor:0},this.vision={},t.flags&&(this.flags.actor=r.flag.from(h,t.flags)),t.vision&&(this.vision.normal=t.vision)}make(t){const e=new N(this);return this.init(e,t),e}init(t,e={}){super.init(t,e),e.fov&&(t.fov=e.fov),e.memory&&(t.memory=e.memory),this.vision.normal&&(t.visionDistance=this.vision.normal)}addToMap(t,e){super.addToMap(t,e),this.hasActorFlag(h.HAS_MEMORY)&&(t.memory=Ot(t,e)),this.hasActorFlag(h.USES_FOV)&&(t.fov=new r.fov.FovSystem(e),t.fov.follow=t,t.memory&&(t.fov.onFovChange=t.memory))}removeFromMap(t){super.removeFromMap(t),t._map&&t.memory&&It(t,t._map,t.memory)}hasActorFlag(t){return!!(this.flags.actor&t)}canSeeEntity(t,e){return!0}isAbleToSee(t,e){return!0}isAbleToSense(t,e){return!0}forbidsCell(t,e){return!!super.forbidsCell(t,e)||!!t.blocksMove()}avoidsCell(t,e){return!!super.avoidsCell(t,e)||(!!t.blocksMove()||!!t.blocksPathing())}getFlavor(t,e){const i=t.isPlayer()?"yourself":this.flavor;return e&&e.action?i+" standing":i}async pickupItem(t,e,i){return!!r.list.push(t,"items",e)}async dropItem(t,e,i){return!!r.list.remove(t,"items",e)}}function Ct(t,e){const i=Dt(t);if(!i)throw new Error("Failed to find item kind - "+t);return i.make(e)}const Nt={};function Dt(t){return t instanceof Rt?t:Nt[t]}function Ft(t){const e=Object.assign({},t);return new Rt(e)}function Mt(t={}){const e={tags:[],forbidTags:[]};"string"==typeof t&&(t={tags:t}),"string"==typeof t.tags?t.tags.split(/[,|&]/).map((t=>t.trim())).forEach((t=>{t.startsWith("!")?e.forbidTags.push(t.substring(1).trim()):e.tags.push(t)})):Array.isArray(t.tags)&&(e.tags=t.tags.slice()),"string"==typeof t.forbidTags?e.forbidTags=t.forbidTags.split(/[,|&]/).map((t=>t.trim())):Array.isArray(t.forbidTags)&&(e.forbidTags=t.forbidTags.slice());const i=Object.values(Nt).filter((t=>!(e.tags.length&&!r.arraysIntersect(e.tags,t.tags))&&(!e.forbidTags||!r.arraysIntersect(e.forbidTags,t.tags))));return(t.rng||r.rng.random).item(i)||null}var wt=Object.freeze({__proto__:null,ActorKind:Rt,Actor:N,make:Ct,makeRandom:function(t,e){const i=Mt(t);if(!i)throw new Error("Failed to find item kind matching - "+JSON.stringify(t));return i.make(e)},from:function(t,e){let i;if("string"==typeof t){if(i=Dt(t),!i)throw new Error("Failed to find item kind - "+t)}else i=t instanceof Rt?t:Ft(t);return i.make(e)},kinds:Nt,install:function(t,e){if(e instanceof Rt)return Nt[t]=e,e;const i=Ft(e);return i.id=t,Nt[t]=i,i},get:Dt,makeKind:Ft,randomKind:Mt});class vt extends y{constructor(t){super(t),this.quantity=1,this.next=null,this.flags.item=0,this.depth=s.ITEM,this.kind=t}copy(t){super.copy(t),this.quantity=t.quantity}itemFlags(){return this.flags.item}hasItemFlag(t){return!!(this.flags.item&t)}hasAllItemFlags(t){return(this.flags.item&t)===t}}class Pt extends R{constructor(t){super(t)}make(t){const e=new vt(this);return this.init(e,t),e}init(t,e={}){super.init(t,e),t.quantity=e.quantity||1}}const bt={};function Bt(t){return t instanceof Pt?t:bt[t]}function kt(t){const e=Object.assign({},t);return new Pt(e)}function Ht(t={}){const e={tags:[],forbidTags:[]};"string"==typeof t&&(t={tags:t}),"string"==typeof t.tags?t.tags.split(/[,|&]/).map((t=>t.trim())).forEach((t=>{t.startsWith("!")?e.forbidTags.push(t.substring(1).trim()):e.tags.push(t)})):Array.isArray(t.tags)&&(e.tags=t.tags.slice()),"string"==typeof t.forbidTags?e.forbidTags=t.forbidTags.split(/[,|&]/).map((t=>t.trim())):Array.isArray(t.forbidTags)&&(e.forbidTags=t.forbidTags.slice());const i=Object.values(bt).filter((t=>!(e.tags.length&&!r.arraysIntersect(e.tags,t.tags))&&(!e.forbidTags||!r.arraysIntersect(e.forbidTags,t.tags))));return(t.rng||r.rng.random).item(i)||null}var Ut=Object.freeze({__proto__:null,ItemKind:Pt,Item:vt,make:function(t,e){const i=Bt(t);if(!i)throw new Error("Failed to find item kind - "+t);return i.make(e)},makeRandom:function(t,e){const i=Ht(t);if(!i)throw new Error("Failed to find item kind matching - "+JSON.stringify(t));return i.make(e)},from:function(t,e){let i;if("string"==typeof t){if(i=Bt(t),!i)throw new Error("Failed to find item kind - "+t)}else i=t instanceof Pt?t:kt(t);return i.make(e)},kinds:bt,install:function(t,e){if(e instanceof Pt)return bt[t]=e,e;const i=kt(e);return i.id=t,bt[t]=i,i},get:Bt,makeKind:kt,randomKind:Ht});function Kt(t,e){const i=r.grid.alloc(t.width,t.height),s=r.grid.alloc(t.width,t.height);for(let e=0;e<t.width;e++)for(let s=0;s<t.height;s++){const r=t.cell(e,s);!r.blocksPathing()&&!r.blocksMove()||r.hasEntityFlag(a.L_SECRETLY_PASSABLE)?i[e][s]=1:i[e][s]=0}let l;for(let e=1;e<i.width-1;e++)for(let s=1;s<i.height-1;s++)if(t.cell(e,s).flags.cell&=~u.IS_CHOKEPOINT,i[e][s]&&!(t.cell(e,s).flags.cell&u.IS_IN_LOOP)){l=0;for(let a=0;a<8;a++){const n=e+r.xy.CLOCK_DIRS[(a+7)%8][0],h=s+r.xy.CLOCK_DIRS[(a+7)%8][1],o=e+r.xy.CLOCK_DIRS[a][0],c=s+r.xy.CLOCK_DIRS[a][1];if((t.hasXY(o,c)&&i[o][c])!=(t.hasXY(n,h)&&i[n][h])&&++l>2){(i[e-1][s]||i[e+1][s])&&(i[e][s-1]||i[e][s+1])||(t.cell(e,s).flags.cell|=u.IS_CHOKEPOINT);break}}}if(e){for(let e=0;e<t.width;e++)for(let i=0;i<t.height;i++)t.cell(e,i).chokeCount=3e4;for(let e=0;e<t.width;e++)for(let l=0;l<t.height;l++){const a=t.cell(e,l);if(i[e][l]&&a.flags.cell&u.IS_CHOKEPOINT)for(let n=0;n<4;n++){const h=e+r.xy.DIRS[n][0],o=l+r.xy.DIRS[n][1];if(t.hasXY(h,o)&&i[h][o]&&!(t.cell(h,o).flags.cell&u.IS_CHOKEPOINT)){s.fill(0),i[e][l]=0;let r=xt(t,s,i,h,o);if(i[e][l]=1,r>=4){for(let e=0;e<s.width;e++)for(let i=0;i<s.height;i++)s[e][i]&&r<t.cell(e,i).chokeCount&&(t.cell(e,i).chokeCount=r,t.cell(e,i).flags.cell&=~u.IS_GATE_SITE);r<a.chokeCount&&(a.chokeCount=r,a.flags.cell|=u.IS_GATE_SITE)}}}}}r.grid.free(i),r.grid.free(s)}function xt(t,e,i,s,l){function a(e,s){let r=2==i[e][s]?5e3:1;return t.cell(e,s).flags.cell&u.IS_IN_AREA_MACHINE&&(r=1e4),r}let n=0;const h=[[s,l]],o=[];for(;h.length;){const s=h.pop();o.push(s);const l=s[0],c=s[1];if(!e[l][c]){e[l][c]=1,n+=a(l,c);for(let s=0;s<4;s++){const a=l+r.xy.DIRS[s][0],n=c+r.xy.DIRS[s][1];if(t.hasXY(a,n)&&i[a][n]&&!e[a][n]){const t=o.pop()||[-1,-1];t[0]=a,t[1]=n,h.push(t)}}}}return Math.min(n,1e4)}function Yt(t){t.eachCell(Gt),Vt(t),jt(t)}function Gt(t,e,i,s){!t.blocksPathing()&&!t.blocksMove()||t.hasEntityFlag(a.L_SECRETLY_PASSABLE)?t.flags.cell|=u.IS_IN_LOOP:t.flags.cell&=~u.IS_IN_LOOP}function Vt(t){let e,i,s,l,a,n,h,o;const c=r.grid.alloc(t.width,t.height,1);let _=!0;for(;_;)_=!1,c.forEach(((f,E,g)=>{if(!f)return;const T=t.cell(E,g);if(c[E][g]=0,T.hasCellFlag(u.IS_IN_LOOP)){for(a=0;a<8;a++){if(i=E+r.xy.CLOCK_DIRS[a][0],s=g+r.xy.CLOCK_DIRS[a][1],!t.hasXY(i,s))continue;if(!t.cell(i,s).hasCellFlag(u.IS_IN_LOOP))break}if(8!=a){for(n=h=o=0,e=!1,l=a;l<a+8;l++){if(i=E+r.xy.CLOCK_DIRS[l%8][0],s=g+r.xy.CLOCK_DIRS[l%8][1],!t.hasXY(i,s))continue;if(t.cell(i,s).hasCellFlag(u.IS_IN_LOOP)){if(o++,!e&&(n++,e=!0,n>1))break}else e&&(o>h&&(h=o),o=0,e=!1)}if(e&&o>h&&(h=o),1==n&&h<=4)for(T.clearCellFlag(u.IS_IN_LOOP),l=0;l<8;l++)i=E+r.xy.CLOCK_DIRS[l][0],s=g+r.xy.CLOCK_DIRS[l][1],t.hasXY(i,s)&&t.cell(i,s).hasCellFlag(u.IS_IN_LOOP)&&(c[i][s]=1,_=!0)}}}))}function Wt(t,e){for(let i=0;i<t.width;++i)for(let s=0;s<t.height;++s){if(t.cell(i,s).flags.cell&u.IS_IN_LOOP)e[i][s]=1;else if(i>0&&s>0){const r=t.cell(i,s-1),l=t.cell(i-1,s);r.flags.cell&u.IS_IN_LOOP&&l.flags.cell&u.IS_IN_LOOP&&(e[i][s]=1)}}}function jt(t){const e=r.grid.alloc(t.width,t.height);let i;Wt(t,e);for(let s=0;s<e.width;s++)for(let l=0;l<e.height;l++){if(t.cell(s,l).flags.cell&u.IS_IN_LOOP){i=!1;for(let a=0;a<8;a++){let n=s+r.xy.CLOCK_DIRS[a][0],h=l+r.xy.CLOCK_DIRS[a][1];if(t.hasXY(n,h)&&!e[n][h]&&!(t.cell(n,h).flags.cell&u.IS_IN_LOOP)){i=!0;break}}i||(e[s][l]=1,t.cell(s,l).flags.cell&=~u.IS_IN_LOOP)}}r.grid.free(e)}class Xt{constructor(t){this.map=new At(t.width,t.height),this.version=0}}function qt(t,e,i){return r.xy.arcCount(e,i,((e,i)=>t.cell(e,i).isPassable()))>1}var zt=Object.freeze({__proto__:null,Cell:lt,Map:At,make:Lt,from:function(t,e,i={}){let s,r=0,l=0;return"string"==typeof t&&(t=t.split("\n")),!function(t){return Array.isArray(t)&&"string"==typeof t[0]}(t)?(r=t.height,l=t.width,s=Lt(l,r,i),t.forEach(((t,i,r)=>{const l=e[t]||"FLOOR";s.setTile(i,r,l)}))):(r=t.length,l=t.reduce(((t,e)=>Math.max(t,e.length)),0),s=Lt(l,r,i),t.forEach(((t,i)=>{for(let r=0;r<l;++r){const l=t[r]||".",a=e[l]||"FLOOR";s.setTile(r,i,a)}}))),s.light.update(),s},analyze:function(t,e=!0){Yt(t),Kt(t,e)},updateChokepoints:Kt,floodFillCount:xt,updateLoopiness:Yt,resetLoopiness:Gt,checkLoopiness:Vt,fillInnerLoopGrid:Wt,cleanLoopiness:jt,Snapshot:Xt,SnapshotManager:class{constructor(t){this.version=0,this.layerVersion=[],this.lightVersion=0,this.free=[],this.map=t,this.cellVersion=r.grid.make(t.width,t.height),this.layerVersion=t.layers.map((()=>1))}takeNew(){++this.version;const t=this.free.length?this.free.pop():new Xt(this.map);return t.map.flags.map=this.map.flags.map,this.cellVersion.update(((e,i,s)=>{const r=this.map.cell(i,s);if(r.changed&&(e=this.version),e!==t.version){t.map.cell(i,s).copy(r)}return e})),this.map.light.changed&&(this.lightVersion=this.version,this.map.light.changed=!1),t.version!==this.lightVersion&&t.map.light.copy(this.map.light),this.map.layers.forEach(((e,i)=>{const s=t.map.layers[i];e.changed&&(this.layerVersion[i]=this.version),this.layerVersion[i]!==t.version&&s.copy(e)})),t.version=this.version,t}revertMapTo(t){this.cellVersion.update(((e,i,s)=>{if(e<t.version)return e;const r=this.map.cell(i,s);if(e>t.version||r.changed){const e=t.map.cell(i,s);return r.copy(e),t.version}return e})),(t.version<this.lightVersion||this.map.light.changed)&&(this.map.light.copy(t.map.light),this.lightVersion=t.version),this.layerVersion.forEach(((e,i)=>{if(e<t.version)return;const s=this.map.layers[i];if(e>t.version||s.changed){const e=t.map.layers[i];s.copy(e),this.layerVersion[i]=t.version}})),this.version=t.version}release(t){this.free.push(t)}},isHallway:qt});function Qt(t,e,i){const s=t.cell(e,i);return s.blocksMove()?r.path.OBSTRUCTION:s.blocksPathing()?r.path.FORBIDDEN:s.hasActor()?10:1}function $t(t,e){e.update(((e,i,s)=>Qt(t,i,s)))}var Jt=Object.freeze({__proto__:null,getCellPathCost:Qt,fillCostMap:$t,getPathBetween:function(t,e,i,s,l,a={}){const n=r.grid.alloc(t.width,t.height),h=r.grid.alloc(t.width,t.height);$t(t,h),r.path.calculateDistances(n,e,i,h,a.eightWays,r.xy.straightDistanceBetween(e,i,s,l)+1);const o=r.path.getPath(n,s,l,((e,i)=>t.cell(e,i).blocksMove()),a.eightWays);return r.grid.free(h),r.grid.free(n),o}});class Zt{constructor(t){this.tags=[],this.members={},this.flags={horde:0},t.tags&&("string"==typeof t.tags?this.tags=t.tags.split(/[,|]/).map((t=>t.trim())):this.tags=t.tags.slice()),this.leader=t.leader,t.members&&Object.entries(t.members).forEach((([t,e])=>{this.members[t]=r.range.make(e)})),this.frequency=r.frequency.make(t.frequency||100),this.flags.horde=r.flag.from(p,t.flags)}async spawn(t,e=-1,i=-1,s={}){var l;s.canSpawn=s.canSpawn||r.TRUE,s.rng=s.rng||t.rng,s.machine=null!==(l=s.machine)&&void 0!==l?l:0;const a=await this._spawnLeader(t,e,i,s);return a?(await this._spawnMembers(a,t,s),a):null}async _spawnLeader(t,e,i,s){const r=Dt(this.leader);if(!r)throw new Error("Failed to find leader kind = "+this.leader);if(e>=0&&i>=0&&r.avoidsCell(t.cell(e,i)))return null;const l=Ct(r,{machineHome:s.machine});if(!l)throw new Error("Failed to make horde leader - "+this.leader);return(e<0||i<0)&&([e,i]=this._pickLeaderLoc(l,t,s)||[-1,-1],e<0||i<0)?null:await this._addLeader(l,t,e,i,s)?l:null}async _addLeader(t,e,i,s,r){return e.addActor(i,s,t)}async _addMember(t,e,i,s,r,l){return t.leader=r,e.addActor(i,s,t)}async _spawnMembers(t,e,i){const s=Object.entries(this.members);if(0==s.length)return 0;return await Promise.all(s.map((async([s,r])=>{const l=r.value(i.rng);for(let r=0;r<l;++r)await this._spawnMember(s,e,t,i)}))),0}async _spawnMember(t,e,i,s){const r=Dt(t);if(!r)throw new Error("Failed to find member kind = "+t);const l=Ct(r,{machineHome:s.machine});if(!l)throw new Error("Failed to make horde member - "+t);const[a,n]=this._pickMemberLoc(l,e,i,s)||[-1,-1];return a<0||n<0?null:await this._addMember(l,e,a,n,i,s)?l:null}_pickLeaderLoc(t,e,i){return i.rng.matchingLoc(e.width,e.height,((s,r)=>{const l=e.cell(s,r);return!l.hasActor()&&(!!i.canSpawn(s,r)&&(!t.avoidsCell(l)&&!qt(e,s,r)))}))}_pickMemberLoc(t,e,i,s){return s.rng.matchingLocNear(i.x,i.y,((i,s)=>{if(!e.hasXY(i,s))return!1;const r=e.cell(i,s);return!r.hasActor()&&(!t.avoidsCell(r)&&!qt(e,i,s))}))}}const te={};function ee(t,e){return"string"==typeof e&&(e={leader:e}),e instanceof Zt||(e=new Zt(e)),te[t]=e,e}var ie=Object.freeze({__proto__:null,Horde:Zt,hordes:te,install:ee,installAll:function(t){Object.entries(t).forEach((([t,e])=>{ee(t,e)}))},from:function(t){return t instanceof Zt?t:"string"==typeof t?te[t]:new Zt(t)},random:function(t={}){const e={tags:[],forbidTags:[],flags:0,forbidFlags:0,depth:0};"string"==typeof t&&(t={tags:t});const i=t.rng||r.rng.random;if("string"==typeof t.tags?t.tags.split(/[,|&]/).map((t=>t.trim())).forEach((t=>{t.startsWith("!")?e.forbidTags.push(t.substring(1).trim()):e.tags.push(t)})):Array.isArray(t.tags)&&(e.tags=t.tags.slice()),"string"==typeof t.forbidTags?e.forbidTags=t.forbidTags.split(/[,|&]/).map((t=>t.trim())):Array.isArray(t.forbidTags)&&(e.forbidTags=t.forbidTags.slice()),t.flags&&"string"==typeof t.flags&&t.flags.split(/[,|]/).map((t=>t.trim())).forEach((t=>{if(t.startsWith("!")){const i=t.substring(1);e.forbidFlags|=p[i]}else e.flags|=p[t]})),t.forbidFlags&&(e.forbidFlags=r.flag.from(p,t.forbidFlags)),t.depth&&(e.depth=t.depth),e.depth&&t.oodChance){for(;i.chance(t.oodChance);)e.depth+=1;e.forbidFlags|=p.HORDE_NEVER_OOD}const s=Object.values(te).filter((t=>!(e.tags.length&&!r.arraysIntersect(e.tags,t.tags))&&((!e.forbidTags||!r.arraysIntersect(e.forbidTags,t.tags))&&(!(e.flags&&!(t.flags.horde&e.flags))&&!(e.forbidFlags&&t.flags.horde&e.forbidFlags)))));if(e.depth)return i.item(s)||null;const l=e.depth,a=s.map((t=>t.frequency(l))),n=i.weighted(a);return n<0?null:s[n]}}),se=Object.freeze({__proto__:null,BasicDrawer:St});t.actor=wt,t.draw=se,t.effect=rt,t.entity=C,t.flags=m,t.horde=ie,t.item=Ut,t.layer=dt,t.map=zt,t.memory=yt,t.path=Jt,t.tile=V,Object.defineProperty(t,"__esModule",{value:!0})}));
//# sourceMappingURL=gw-map.min.js.map
