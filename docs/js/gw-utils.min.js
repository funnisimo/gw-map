!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).GWU={})}(this,(function(t){"use strict";function e(){}function i(){return!0}function s(){return!1}function n(t){return t}function r(t,e,i){return t<e?e:t>i?i:t}function h(t){throw new Error(t)}function o(...t){return t.find((t=>void 0!==t))}function a(t,e){return e.every((e=>t.includes(e)))}function l(t,e){const i=t.indexOf(e);return!(i<0)&&(t.splice(i,1),!0)}function u(t,e,i,s=!0,n=!0){const r=t.length;if(r<=1)return;const h=t.indexOf(e);if(h<0)return;const o=n?1:-1;let a=s?h:n?r:-1;for(let e=s?(r+h+o)%r:h+o;e!==a;e=s?(r+e+o)%r:e+o){const s=t[e];if(i(s))return s}}function d(t,e,i,s=!0){return u(t,e,i,s,!1)}const c=[[0,-1],[1,0],[0,1],[-1,0],[1,-1],[1,1],[-1,1],[-1,-1]],f=[[0,1],[1,1],[1,0],[1,-1],[0,-1],[-1,-1],[-1,0],[-1,1]];function g(t){return t.x||t[0]||0}function _(t){return t.y||t[1]||0}class p{constructor(t=0,e=0,i=0,s=0){this.x=t,this.y=e,this.width=i,this.height=s}get left(){return this.x}set left(t){this.x=t}get right(){return this.x+this.width}set right(t){this.x=t-this.width}get top(){return this.y}set top(t){this.y=t}get bottom(){return this.y+this.height}set bottom(t){this.y=t-this.height}clone(){return new p(this.x,this.y,this.width,this.height)}contains(...t){let e=t[0],i=t[1];return"number"!=typeof e&&(i=_(e),e=g(e)),this.x<=e&&this.y<=i&&this.x+this.width>e&&this.y+this.height>i}toString(){return`[${this.x},${this.y} -> ${this.right},${this.bottom}]`}}function b(t,e,i,s=!1){const n=s?4:8;for(let s=0;s<n;++s){const n=c[s];i(t+n[0],e+n[1])}}function m(t,e,i,s){const n=Math.abs(t-i),r=Math.abs(e-s);return n+r-.6*Math.min(n,r)}function y(t,e){return m(0,0,t,e)}function w(t,e,i,s){let n=i-t,r=s-e;if(n&&r){const t=Math.abs(n),e=Math.abs(r);t>=2*e?r=0:e>=2*t&&(n=0)}return[Math.sign(n),Math.sign(r)]}const E=65536;function x(t,e,i,s,n){let r,h,o=[],a=[],l=[],u=[],d=[],c=[-1,-1],f=[-1,-1];if(t==i&&e==s)return!0;const g=[t,e],_=[i,s];for(h=0;h<=1;h++)o[h]=_[h]-g[h]<<16,o[h]<0?(o[h]*=-1,d[h]=-1):d[h]=1,l[h]=u[h]=a[h]=0,c[h]=g[h];for(r=Math.max(o[0],o[1]),o[0]=Math.floor(o[0]*E/r),o[1]=Math.floor(o[1]*E/r);;){for(h=0;h<=1;h++)f[h]=c[h],l[h]+=o[h]>>16,a[h]+=o[h]==E?0:o[h],a[h]>=Math.floor(32768)&&(l[h]++,a[h]-=E),c[h]=Math.floor(d[h]*l[h]+g[h]);const t=n(...c);if(!1===t)return!1;if(!0!==t&&c[0]===i&&c[1]===s)return!0}}function v(t,e,i,s){let n,r;for(n=t-i-1;n<t+i+1;n++)for(r=e-i-1;r<e+i+1;r++)(n-t)*(n-t)+(r-e)*(r-e)<i*i+i&&s(n,r)}function I(...t){let e=0,i=0;arguments.length>3&&(e=t.shift(),i=t.shift());const s=e+t[0],n=i+t[1],r=t[2];for(let t=e;t<s;++t)for(let e=i;e<n;++e)r(t,e)}function A(...t){let e=0,i=0;arguments.length>3&&(e=t.shift(),i=t.shift());const s=e+t[0]-1,n=i+t[1]-1,r=t[2];for(let t=e;t<=s;++t)r(t,i),r(t,n);for(let t=i;t<=n;++t)r(e,t),r(s,t)}function T(t,e,i){let s,n,r,h,o=0,a=0;for(let l=0;l<f.length;l++){s=t+f[(l+7)%8][0],n=e+f[(l+7)%8][1],r=t+f[l][0],h=e+f[l][1];const u=i(r,h);u&&++a,u!=i(s,n)&&o++}return 0==o&&a?1:Math.floor(o/2)}var S=Object.freeze({__proto__:null,DIRS:c,NO_DIRECTION:-1,UP:0,RIGHT:1,DOWN:2,LEFT:3,RIGHT_UP:4,RIGHT_DOWN:5,LEFT_DOWN:6,LEFT_UP:7,CLOCK_DIRS:f,isLoc:function(t){return Array.isArray(t)&&2==t.length&&"number"==typeof t[0]&&"number"==typeof t[1]},isXY:function(t){return t&&"number"==typeof t.x&&"number"==typeof t.y},x:g,y:_,contains:function(t,e,i){return e>=0&&i>=0&&e<t.width&&i<t.height},Bounds:p,copy:function(t,e){t.x=g(e),t.y=_(e)},addTo:function(t,e){t.x+=g(e),t.y+=_(e)},add:function(t,e){return Array.isArray(t)?[t[0]+g(e),t[1]+_(e)]:{x:t.x+g(e),y:t.y+_(e)}},equalsXY:function(t,e){return!t&&!e||!(!t||!e)&&(g(t)==g(e)&&_(t)==_(e))},lerpXY:function(t,e,i){i>1&&(i/=100),i=r(i,0,1);const s=g(e)-g(t),n=_(e)-_(t);return[g(t)+Math.floor(s*i),_(t)+Math.floor(n*i)]},eachNeighbor:b,eachNeighborAsync:async function(t,e,i,s=!1){const n=s?4:8;for(let s=0;s<n;++s){const n=c[s],r=t+n[0],h=e+n[1];await i(r,h)}},matchingNeighbor:function(t,e,i,s=!1){const n=s?4:8;for(let s=0;s<n;++s){const n=c[s],r=t+n[0],h=e+n[1];if(i(r,h))return[r,h]}return[-1,-1]},straightDistanceBetween:function(t,e,i,s){return Math.abs(t-i)+Math.abs(e-s)},maxAxisFromTo:function(t,e){const i=Math.abs(g(t)-g(e)),s=Math.abs(_(t)-_(e));return Math.max(i,s)},maxAxisBetween:function(t,e,i,s){const n=Math.abs(t-i),r=Math.abs(e-s);return Math.max(n,r)},distanceBetween:m,distanceFromTo:function(t,e){return m(g(t),_(t),g(e),_(e))},calcRadius:y,dirBetween:w,dirFromTo:function(t,e){return w(g(t),_(t),g(e),_(e))},dirIndex:function(t){const e=g(t),i=_(t);return c.findIndex((t=>t[0]==e&&t[1]==i))},isOppositeDir:function(t,e){return Math.sign(t[0])+Math.sign(e[0])==0&&Math.sign(t[1])+Math.sign(e[1])==0},isSameDir:function(t,e){return Math.sign(t[0])==Math.sign(e[0])&&Math.sign(t[1])==Math.sign(e[1])},dirSpread:function(t){const e=[t];return 0==t[0]?(e.push([1,t[1]]),e.push([-1,t[1]])):0==t[1]?(e.push([t[0],1]),e.push([t[0],-1])):(e.push([t[0],0]),e.push([0,t[1]])),e},stepFromTo:function(t,e,i){const s=g(t),n=_(t),r=[g(e)-s,_(e)-n],h=Math.abs(r[0])+Math.abs(r[1]),o=[0,0],a=[99999,99999];for(let t=0;t<=h;++t)o[0]=s+Math.floor(r[0]*t/h),o[1]=n+Math.floor(r[1]*t/h),o[0]==a[0]&&o[1]==a[1]||i(o[0],o[1]),a[0]=o[0],a[1]=o[1]},forLine:function(t,e,i,s,n){for(let r=0;r<s;++r)n(t+r*i[0],e+r*i[1])},forLineBetween:x,forLineFromTo:function(t,e,i){return x(g(t),_(t),g(e),_(e),i)},getLine:function(t,e,i,s){const n=[];return x(t,e,i,s,((t,e)=>{n.push([t,e])})),n},getLineThru:function(t,e,i,s,n,r){const h=[];return x(t,e,i,s,((t,e)=>!(t<0||e<0||t>=n||e>=r)&&(h.push([t,e]),!0))),h},forCircle:v,forRect:I,forBorder:A,arcCount:T});function C(t,e){let i=0;for(;t;){const s=t.next;e(t,i++),t=s}return i}function L(t,e,i){return i.next=t[e]||null,t[e]=i,!0}function M(t,e,i){const s=t[e];if(s===i)return t[e]=i.next||null,i.next=null,!0;if(!s)return!1;{let t=s,e=t.next;for(;e&&e!==i;)t=e,e=t.next;if(e===i)return t.next=e.next,i.next=null,!0}return!1}var k=Object.freeze({__proto__:null,length:function(t){let e=0;for(;t;)e+=1,t=t.next;return e},at:function(t,e){for(;t&&e;)t=t.next,--e;return t},includes:function(t,e){for(;t&&t!==e;)t=t.next;return t===e},forEach:C,push:L,remove:M,find:function(t,e){for(;t&&!e(t);)t=t.next;return t},insert:function(t,e,i,s){let n=t[e];if(s=s||(()=>-1),!n||s(n,i)<0)return i.next=n,t[e]=i,!0;let r=n,h=n.next;for(;h&&s(h,i)>0;)r=h,h=h.next;return i.next=h,r.next=i,!0},reduce:function(t,e,i){let s=t;if(void 0===i){if(!s)throw new TypeError("Empty list reduce without initial value not allowed.");i=s,s=s.next}for(;s;)i=e(i,s),s=s.next;return i},some:function(t,e){let i=t;for(;i;){if(e(i))return!0;i=i.next}return!1},every:function(t,e){let i=t;for(;i;){if(!e(i))return!1;i=i.next}return!0}});function O(t,e,i){const s=t[i],n=e[i];s&&s.copy&&n?s.copy(n):s&&s.clear&&!n?s.clear():s&&s.nullify&&!n?s.nullify():n&&n.clone?t[i]=n.clone():n&&Array.isArray(n)?t[i]=n.slice():s&&Array.isArray(s)?s.length=0:void 0!==n&&(t[i]=n)}function R(t,e,i=null){let s;e&&Object.keys(e).forEach((n=>{const r=n;let o=e[n];s=t;const a=n.split(".");for(;a.length>1;)n=a.shift(),void 0===s[n]?s=s[n]={}:"object"!=typeof s[n]?h("Trying to set default member on non-object config item: "+r):s=s[n];n=a.shift();let l=s[n];i&&i(s,n,l,o)||void 0===l&&(null===o?s[n]=null:Array.isArray(o)?s[n]=o.slice():s[n]=o)}))}var N=Object.freeze({__proto__:null,copyObject:function(t,e){Object.keys(t).forEach((i=>{O(t,e,i)}))},assignObject:function(t,e){Object.keys(e).forEach((i=>{O(t,e,i)}))},assignOmitting:function(t,e,i){"string"==typeof t&&(t=t.split(/[,|]/g).map((t=>t.trim()))),Object.keys(i).forEach((s=>{t.includes(s)||O(e,i,s)}))},setDefault:function(t,e,i){void 0===t[e]&&(t[e]=i)},setDefaults:R,setOptions:function(t,e){R(t,e,((t,e,i,s)=>(null===s?t[e]=null:Array.isArray(s)?t[e]=s.slice():t[e]=s,!0)))},kindDefaults:function(t,e){return R(t,e,(function(t,e,i,s){return!(e.search(/[fF]lags$/)<0)&&(i?"string"==typeof i?i=i.split(/[,|]/).map((t=>t.trim())):Array.isArray(i)||(i=[i]):i=[],"string"==typeof s?s=s.split(/[,|]/).map((t=>t.trim())):Array.isArray(s)||(s=[s]),t[e]=s.concat(i),!0)}))},pick:function(t,...e){const i={};return e.forEach((e=>{const s=t[e];void 0!==s&&(i[e]=s)})),i},clearObject:function(t){Object.keys(t).forEach((e=>t[e]=void 0))},getOpt:function(t,e,i){const s=t[e];return void 0===s?i:s},firstOpt:function(t,...e){for(let i of e){if("object"!=typeof i||Array.isArray(i))return i;if(i&&void 0!==i[t])return i[t]}}});function D(t){t=Math.abs(t||Date.now());const e=2.3283064365386963e-10;let i=0,s=0,n=0,r=0;return i=((t=t<1?1/t:t)>>>0)*e,s=(t=69069*t+1>>>0)*e,n=(t=69069*t+1>>>0)*e,r=1,function(){let t=2091639*i+r*e;return i=s,s=n,r=0|t,n=t-r,n}}const W={make:D};function P(t,e){let i,s,n;for(s=0,i=0;i<e.length;i++)s+=e[i];if(s<=0)return-1;for(n=t.range(0,s-1),i=0;i<e.length;i++){if(e[i]>n)return i;n-=e[i]}return console.warn("Lottery Draw failed.",e,e.length),0}class B{constructor(t){this._fn=W.make(t)}seed(t){t=t||Date.now(),this._fn=W.make(t)}value(){return this._fn()}float(){return this.value()}number(t=Number.MAX_SAFE_INTEGER){return t<=0?0:Math.floor(this.value()*t)}int(t=0){return this.number(t)}range(t,e){if(e<=t)return e;const i=e-t+1;return t+this.number(i)}normal(t=0,e=1){let i,s,n;do{i=2*this.value()-1,s=2*this.value()-1,n=i*i+s*s}while(n>1||0==n);return t+i*Math.sqrt(-2*Math.log(n)/n)*e}dice(t,e,i=0){let s=0,n=1;t<0&&(t=-t,n=-1),i=i||0;for(let i=0;i<t;++i)s+=this.range(1,e);return s*=n,s+i}weighted(t){return Array.isArray(t)?P(this,t):function(t,e){const i=Object.entries(e),s=P(t,i.map((([t,e])=>e)));return s<0?-1:i[s][0]}(this,t)}item(t){return Array.isArray(t)||(t=Object.values(t)),t[this.range(0,t.length-1)]}key(t){return this.item(Object.keys(t))}shuffle(t,e=0,i=0){let s,n,r;for(2==arguments.length&&(i=e,e=0),i=i||t.length,s=e=e||0;s<i;s++)n=this.range(e,i-1),s!=n&&(r=t[n],t[n]=t[s],t[s]=r);return t}sequence(t){const e=[];for(let i=0;i<t;i++)e[i]=i;return this.shuffle(e)}chance(t,e=100){return!(t<=0)&&(t>=e||this.number(e)<t)}clumped(t,e,i){if(e<=t)return t;if(i<=1)return this.range(t,e);let s,n=0,r=Math.floor((e-t)/i);for(s=0;s<(e-t)%i;s++)n+=this.range(0,r+1);for(;s<i;s++)n+=this.range(0,r);return n+t}matchingLoc(t,e,i){let s,n,r,h=0;if(h=0,I(t,e,((t,e)=>{i(t,e)&&h++})),0==h)return[-1,-1];for(r=this.range(0,h-1),s=0;s<t&&r>=0;s++)for(n=0;n<e&&r>=0;n++)if(i(s,n)){if(0==r)return[s,n];r--}return[-1,-1]}matchingLocNear(t,e,i){let s,n,r,h,o,a=[-1,-1];for(h=0,r=0;r<50&&!h;r++)for(s=t-r;s<=t+r;s++)for(n=e-r;n<=e+r;n++)s!=t-r&&s!=t+r&&n!=e-r&&n!=e+r||!i(s,n)||h++;if(0==h)return[-1,-1];for(o=1+this.number(h),r=0;r<50;r++)for(s=t-r;s<=t+r;s++)for(n=e-r;n<=e+r;n++)if((s==t-r||s==t+r||n==e-r||n==e+r)&&i(s,n)&&0==--o)return a[0]=s,a[1]=n,a;return[-1,-1]}}const V=new B,H=new B;var F=Object.freeze({__proto__:null,Alea:D,configure:function(t={}){t.make&&(W.make=t.make,V.seed(),H.seed())},Random:B,random:V,cosmetic:H,make:function(t){return new B(t)}});class j{constructor(t,e=0,i=1){Array.isArray(t)&&(i=t[2],e=t[1],t=t[0]),e<t&&([e,t]=[t,e]),this.lo=t||0,this.hi=e||this.lo,this.clumps=i||1}value(t){return(t=t||V).clumped(this.lo,this.hi,this.clumps)}max(){return this.hi}contains(t){return this.lo<=t&&this.hi>=t}copy(t){return this.lo=t.lo,this.hi=t.hi,this.clumps=t.clumps,this}toString(){return this.lo>=this.hi?""+this.lo:`${this.lo}-${this.hi}`}}function Y(t){if(!t)return new j(0,0,0);if(t instanceof j)return t;if("function"==typeof t)throw new Error("Custom range functions not supported - extend Range");if(null==t)return new j(0,0,0);if("number"==typeof t)return new j(t,t,1);if(!0===t||!1===t)throw new Error("Invalid random config: "+t);if(Array.isArray(t))return new j(t[0],t[1],t[2]);if("string"!=typeof t)throw new Error("Calculations must be strings.  Received: "+JSON.stringify(t));if(0==t.length)return new j(0,0,0);const e=/^(?:([+-]?\d*)[Dd](\d+)([+-]?\d*)|([+-]?\d+)-(\d+):?(\d+)?|([+-]?\d+)~(\d+)|([+-]?\d+)\+|([+-]?\d+))$/g;let i;for(;null!==(i=e.exec(t));){if(i[2]){let t=Number.parseInt(i[1])||1;const e=Number.parseInt(i[2]),s=Number.parseInt(i[3])||0;return new j(s+t,s+t*e,t)}if(i[4]&&i[5]){const t=Number.parseInt(i[4]),e=Number.parseInt(i[5]),s=Number.parseInt(i[6]);return new j(t,e,s)}if(i[7]&&i[8]){const t=Number.parseInt(i[7]),e=Number.parseInt(i[8]);return new j(t-2*e,t+2*e,3)}if(i[9]){const t=Number.parseInt(i[9]);return new j(t,Number.MAX_SAFE_INTEGER,1)}if(i[10]){const t=Number.parseInt(i[10]);return new j(t,t,1)}}throw new Error("Not a valid range - "+t)}const G=Y;var U=Object.freeze({__proto__:null,Range:j,make:Y,from:G,asFn:function(t){const e=Y(t);return()=>e.value()},value:function(t){return Y(t).value()}});function X(t){return 1<<t}function K(t,...e){let i=0;for(let s=0;s<e.length;++s){let n=e[s];void 0!==n&&("number"!=typeof n?("string"==typeof n&&(n=n.split(/[,|]/).map((t=>t.trim())).map((t=>{const e=Number.parseInt(t);return e>=0?e:t}))),Array.isArray(n)&&n.forEach((e=>{if("string"==typeof e){const s=(e=e.trim()).split(/[,|]/);if(s.length>1)i=K(t,i,s);else if(e.startsWith("!")){const s=t[e.substring(1)];i&=~s}else{const s=Number.parseInt(e);if(s>=0)return void(i|=s);const n=t[e];n&&(i|=n)}}else 0===e?i=0:i|=e}))):i|=n)}return i}var z=Object.freeze({__proto__:null,fl:X,toString:function(t,e){const i=Object.entries(t).reduce(((t,e)=>{const[i,s]=e;return"number"==typeof s&&(t[s]?t[s]+=" | "+i:t[s]=i),t}),[]),s=[];for(let t=0;t<32;++t){const n=1<<t;e&n&&s.push(i[n])}return s.join(" | ")},from:K,make:function(t){const e={};return Object.entries(t).forEach((([t,i])=>{e[t]=K(e,i)})),e}});const q=c;function $(t,e){if(void 0===e)return new Array(t).fill(0);let i;i="function"!=typeof e?()=>e:e;const s=new Array(t);for(let e=0;e<t;++e)s[e]=i(e);return s}function Z(t){return!1===t?" ":!0===t?"T":t<10?""+t:t<36?String.fromCharCode("a".charCodeAt(0)+t-10):t<62?String.fromCharCode("A".charCodeAt(0)+t-10-26):"string"==typeof t?t[0]:"#"}class J extends Array{constructor(t,e,i){super(t);const s=this;for(let n=0;n<t;++n)this[n]="function"==typeof i?new Array(e).fill(0).map(((t,e)=>i(n,e,s))):new Array(e).fill(i);this._width=t,this._height=e}get width(){return this._width}get height(){return this._height}get(t,e){if(this.hasXY(t,e))return this[t][e]}set(t,e,i){return!!this.hasXY(t,e)&&(this[t][e]=i,!0)}forEach(t){let e,i;for(e=0;e<this.width;e++)for(i=0;i<this.height;i++)t(this[e][i],e,i,this)}async forEachAsync(t){let e,i;for(e=0;e<this.width;e++)for(i=0;i<this.height;i++)await t(this[e][i],e,i,this)}eachNeighbor(t,e,i,s=!1){b(t,e,((t,e)=>{this.hasXY(t,e)&&i(this[t][e],t,e,this)}),s)}async eachNeighborAsync(t,e,i,s=!1){const n=s?4:8;for(let s=0;s<n;++s){const n=q[s],r=t+n[0],h=e+n[1];this.hasXY(r,h)&&await i(this[r][h],r,h,this)}}forRect(t,e,i,s,n){I(t,e,i,s,((t,e)=>{this.hasXY(t,e)&&n(this[t][e],t,e,this)}))}randomEach(t){const e=V.sequence(this.width*this.height);for(let i=0;i<e.length;++i){const s=e[i],n=s%this.width,r=Math.floor(s/this.width);if(!0===t(this[n][r],n,r,this))return!0}return!1}map(t){const e=new this.constructor(this.width,this.height);return e.copy(this),e.update(t),e}some(t){return super.some(((e,i)=>e.some(((e,s)=>t(e,i,s,this)))))}forCircle(t,e,i,s){v(t,e,i,((t,e)=>{this.hasXY(t,e)&&s(this[t][e],t,e,this)}))}hasXY(t,e){return t>=0&&e>=0&&t<this.width&&e<this.height}isBoundaryXY(t,e){return this.hasXY(t,e)&&(0==t||t==this.width-1||0==e||e==this.height-1)}calcBounds(){const t={left:this.width,top:this.height,right:0,bottom:0};return this.forEach(((e,i,s)=>{e&&(t.left>i&&(t.left=i),t.right<i&&(t.right=i),t.top>s&&(t.top=s),t.bottom<s&&(t.bottom=s))})),t}update(t){I(this.width,this.height,((e,i)=>{this[e][i]=t(this[e][i],e,i,this)}))}updateRect(t,e,i,s,n){I(t,e,i,s,((t,e)=>{this.hasXY(t,e)&&(this[t][e]=n(this[t][e],t,e,this))}))}updateCircle(t,e,i,s){v(t,e,i,((t,e)=>{this.hasXY(t,e)&&(this[t][e]=s(this[t][e],t,e,this))}))}fill(t){const e="function"==typeof t?t:()=>t;this.update(e)}fillRect(t,e,i,s,n){const r="function"==typeof n?n:()=>n;this.updateRect(t,e,i,s,r)}fillCircle(t,e,i,s){const n="function"==typeof s?s:()=>s;this.updateCircle(t,e,i,n)}replace(t,e){this.update((i=>i==t?e:i))}copy(t){this.update(((e,i,s)=>t[i][s]))}count(t){const e="function"==typeof t?t:e=>e==t;let i=0;return this.forEach(((t,s,n)=>{e(t,s,n,this)&&++i})),i}find(t){const e="function"==typeof t?t:e=>e==t;for(let t=0;t<this.width;++t)for(let i=0;i<this.height;++i){if(e(this[t][i],t,i,this))return[t,i]}return null}dump(t,e=console.log){this.dumpRect(0,0,this.width,this.height,t,e)}dumpRect(t,e,i,s,n,h=console.log){let o,a;n=n||Z,t=r(t,0,this.width-2),e=r(e,0,this.height-2);const l=r(t+i,1,this.width-1),u=r(e+s,1,this.height-1);let d=[];for(a=e;a<=u;a++){let e=(a+"]").padStart(3," ");for(o=t;o<=l;o++){o%10==0&&(e+=" ");e+=n(this[o][a],o,a)[0]}d.push(e)}h(d.join("\n"))}dumpAround(t,e,i,s,n=console.log){this.dumpRect(t-i,e-i,2*i,2*i,s,n)}closestMatchingLoc(t,e,i){let s=[-1,-1],n=100*(this.width+this.height);const r="function"==typeof i?i:t=>t==i;return this.forEach(((i,h,o)=>{if(r(i,h,o,this)){const i=Math.floor(100*m(t,e,h,o));i<n?(s[0]=h,s[1]=o,n=i):i==n&&V.chance(50)&&(s[0]=h,s[1]=o)}})),s}firstMatchingLoc(t){const e="function"==typeof t?t:e=>e==t;for(let t=0;t<this.width;++t)for(let i=0;i<this.height;++i)if(e(this[t][i],t,i,this))return[t,i];return[-1,-1]}randomMatchingLoc(t){const e="function"==typeof t?(e,i)=>t(this[e][i],e,i,this):(e,i)=>this.get(e,i)===t;return V.matchingLoc(this.width,this.height,e)}matchingLocNear(t,e,i){const s="function"==typeof i?(t,e)=>i(this[t][e],t,e,this):(t,e)=>this.get(t,e)===i;return V.matchingLocNear(t,e,s)}arcCount(t,e,i){return T(t,e,((t,e)=>this.hasXY(t,e)&&i(this[t][e],t,e,this)))}}const Q=[],tt={active:0,alloc:0,create:0,free:0};class et extends J{constructor(t,e,i=0){super(t,e,i)}static alloc(...t){let e=t[0]||0,i=t[1]||0,s=t[2]||0;if(1==t.length&&(e=t[0].width,i=t[0].height,s=t[0].get.bind(t[0])),!e||!i)throw new Error("Grid alloc requires width and height parameters.");++tt.active,++tt.alloc;let n=Q.pop();return n?(n._resize(e,i,s),n):(++tt.create,new et(e,i,s))}static free(t){if(t){if(Q.indexOf(t)>=0)return;Q.push(t),++tt.free,--tt.active}}_resize(t,e,i){const s="function"==typeof i?i:()=>i;for(;this.length<t;)this.push([]);this.length=t;let n=0,r=0;for(n=0;n<t;++n){const t=this[n];for(r=0;r<e;++r)t[r]=s(n,r,this);t.length=e}this._width=t,this._height=e,void 0!==this.x&&(this.x=void 0,this.y=void 0)}findReplaceRange(t,e,i){this.update((s=>s>=t&&s<=e?i:s))}floodFillRange(t,e,i,s,n){let r,h,o,a=1;if(n>=i&&n<=s)throw new Error("Invalid grid flood fill");const l=(t,e)=>this.hasXY(t,e)&&this[t][e]>=i&&this[t][e]<=s;if(!l(t,e))return 0;for(this[t][e]=n,r=0;r<4;r++)h=t+q[r][0],o=e+q[r][1],l(h,o)&&(a+=this.floodFillRange(h,o,i,s,n));return a}invert(){this.update((t=>t?0:1))}leastPositiveValue(){let t=Number.MAX_SAFE_INTEGER;return this.forEach((e=>{e>0&&e<t&&(t=e)})),t}randomLeastPositiveLoc(){const t=this.leastPositiveValue();return this.randomMatchingLoc(t)}valueBounds(t,e){let i,s,n=!1,r=this.width-1,h=0,o=this.height-1,a=0;for(i=0;i<this.width;i++){for(n=!1,s=0;s<this.height;s++)if(this[i][s]==t){n=!0;break}n&&(i<r&&(r=i),i>h&&(h=i))}for(s=0;s<this.height;s++){for(n=!1,i=0;i<this.width;i++)if(this[i][s]==t){n=!0;break}n&&(s<o&&(o=s),s>a&&(a=s))}return(e=e||new p(0,0,0,0)).x=r,e.y=o,e.width=h-r+1,e.height=a-o+1,e}floodFill(t,e,i,s){const n="function"==typeof i?i:t=>t==i,r="function"==typeof s?s:()=>s;let h,o,a=et.alloc(this.width,this.height);const l=[[t,e]],u=[];let d=1;for(;l.length;){const i=l.pop();if([t,e]=i,u.push(i),this.hasXY(t,e)&&!a[t][e]&&n(this[t][e],t,e,this)){this[t][e]=r(this[t][e],t,e,this),a[t][e]=1,++d;for(let i=0;i<4;i++){h=t+q[i][0],o=e+q[i][1];const s=u.pop()||[-1,-1];s[0]=h,s[1]=o,l.push(s)}}}return et.free(a),d}}const it=et.alloc.bind(et),st=et.free.bind(et);function nt(t,e,i){return void 0===i?new et(t,e,0):"number"==typeof i?new et(t,e,i):new J(t,e,i)}var rt=Object.freeze({__proto__:null,makeArray:$,Grid:J,stats:tt,NumGrid:et,alloc:it,free:st,make:nt,offsetZip:function(t,e,i,s,n){const r="function"==typeof n?n:(e,i,s,r)=>t[s][r]=n;e.forEach(((n,h,o)=>{const a=h+i,l=o+s;t.hasXY(a,l)&&n&&r(t[a][l],n,a,l,h,o,t,e)}))},intersection:function(t,e,i){i=i||t,t.update(((t,s,n)=>e[s][n]&&i[s][n]||0))},unite:function(t,e,i){i=i||t,t.update(((t,s,n)=>i[s][n]||e[s][n]))}});class ht{constructor(){this._waiting=null,this._data=[]}get length(){return this._data.length}get last(){return this._data[this._data.length-1]}get first(){return this._data[0]}enqueue(t){this._waiting?(this._waiting(t),this._waiting=null):this._data.push(t)}prepend(t){this._waiting?(this._waiting(t),this._waiting=null):this._data.unshift(t)}dequeue(){const t=this._data.shift();if(t)return Promise.resolve(t);if(this._waiting)throw new Error("Too many requesters.");return new Promise((t=>{this._waiting=t}))}}var ot=Object.freeze({__proto__:null,AsyncQueue:ht});function at(t,e,i,s){return s?((t=Math.max(0,Math.min(255,Math.round(2.550001*t))))<<16)+((e=Math.max(0,Math.min(255,Math.round(2.550001*e))))<<8)+(i=Math.max(0,Math.min(255,Math.round(2.550001*i)))):((t=Math.max(0,Math.min(15,Math.round(t/100*15))))<<8)+((e=Math.max(0,Math.min(15,Math.round(e/100*15))))<<4)+(i=Math.max(0,Math.min(15,Math.round(i/100*15))))}const lt={};class ut{constructor(t=-1,e=0,i=0,s=100){this._rand=null,this.dances=!1,t<0&&(s=0,t=0),this._data=[t,e,i,s]}rgb(){return[this.r,this.g,this.b,this.a]}get r(){return Math.round(2.550001*this._data[0])}get _r(){return this._data[0]}get _ra(){return Math.round(this._data[0]*this._data[3]/100)}get g(){return Math.round(2.550001*this._data[1])}get _g(){return this._data[1]}get _ga(){return Math.round(this._data[1]*this._data[3]/100)}get b(){return Math.round(2.550001*this._data[2])}get _b(){return this._data[2]}get _ba(){return Math.round(this._data[2]*this._data[3]/100)}get a(){return this._data[3]}get _a(){return this.a}rand(t,e=0,i=0,s=0){return this._rand=[t,e,i,s],this.dances=!1,this}dance(t,e,i,s){return this.rand(t,e,i,s),this.dances=!0,this}isNull(){return 0===this._data[3]}alpha(t){return new ut(this._data[0],this._data[1],this._data[2],r(t,0,100))}get l(){return Math.round(.5*(Math.min(this._r,this._g,this._b)+Math.max(this._r,this._g,this._b)))}get s(){return this.l>=100?0:Math.round((Math.max(this._r,this._g,this._b)-Math.min(this._r,this._g,this._b))*(100-Math.abs(2*this.l-100))/100)}get h(){let t=0,e=this.r,i=this.g,s=this.b;return t=e>=i&&i>=s?(i-s)/(e-s)*60:i>e&&e>=s?60*(2-(e-s)/(i-s)):i>=s&&s>e?60*(2+(s-e)/(i-e)):s>i&&i>e?60*(4-(i-e)/(s-e)):s>e&&e>=i?60*(4+(e-i)/(s-i)):60*(6-(s-i)/(e-i)),Math.round(t)||0}equals(t){if("string"==typeof t){if(t.startsWith("#"))return 4==t.length?this.css()===t:this.css(!0)===t;if(this.name)return this.name===t}else if("number"==typeof t)return this.toInt()===t||this.toInt(!0)===t;const e=pt(t);return this.isNull()?e.isNull():!e.isNull()&&this._data.every(((t,i)=>t==e._data[i]))}toInt(t=!1){if(this.isNull())return-1;if(!this._rand||!this.dances)return at(this._ra,this._ga,this._ba,t);const e=H.number(this._rand[0]),i=H.number(this._rand[1]),s=H.number(this._rand[2]),n=H.number(this._rand[3]);return at(Math.round((this._r+e+i)*this._a/100),Math.round((this._g+e+s)*this._a/100),Math.round((this._b+e+n)*this._a/100),t)}toLight(){return[this._ra,this._ga,this._ba]}clamp(){return this.isNull()?this:_t(this._data.map((t=>r(t,0,100))))}blend(t){const e=pt(t);if(e.isNull())return this;if(100===e.a)return e;const i=e.a/100,s=1-i,n=_t(Math.round(this._data[0]*s+e._data[0]*i),Math.round(this._data[1]*s+e._data[1]*i),Math.round(this._data[2]*s+e._data[2]*i),Math.round(e.a+this._data[3]*s));if(this._rand&&(n._rand=this._rand.map((t=>Math.round(t*s))),n.dances=this.dances),e._rand){n._rand||(n._rand=[0,0,0,0]);for(let t=0;t<4;++t)n._rand[t]+=Math.round(e._rand[t]*i);n.dances=n.dances||e.dances}return n}mix(t,e){const i=pt(t);if(i.isNull())return this;if(e>=100)return i;const s=r(e,0,100)/100,n=1-s,h=_t(Math.round(this._data[0]*n+i._data[0]*s),Math.round(this._data[1]*n+i._data[1]*s),Math.round(this._data[2]*n+i._data[2]*s),(this.isNull()?100:this._data[3])*n+i._data[3]*s);if(this._rand&&(h._rand=this._rand.slice(),h.dances=this.dances),i._rand){if(h._rand)for(let t=0;t<4;++t)h._rand[t]=Math.round(h._rand[t]*n+i._rand[t]*s);else h._rand=i._rand.map((t=>Math.round(t*s)));h.dances=h.dances||i.dances}return h}lighten(t){if(this.isNull())return this;if(t<=0)return this;const e=r(t,0,100)/100,i=1-e;return _t(Math.round(this._data[0]*i+100*e),Math.round(this._data[1]*i+100*e),Math.round(this._data[2]*i+100*e),this._a)}darken(t){if(this.isNull())return this;const e=r(t,0,100)/100,i=1-e;return _t(Math.round(this._data[0]*i+0*e),Math.round(this._data[1]*i+0*e),Math.round(this._data[2]*i+0*e),this._a)}bake(t=!1){if(this.isNull())return this;if(!this._rand)return this;if(this.dances&&!t)return this;const e=this._rand,i=H.number(e[0]),s=H.number(e[1]),n=H.number(e[2]),r=H.number(e[3]);return _t(this._r+i+s,this._g+i+n,this._b+i+r,this._a)}add(t,e=100){const i=pt(t);if(i.isNull())return this;const s=i.a/100*(e/100);return _t(Math.round(this._data[0]+i._data[0]*s),Math.round(this._data[1]+i._data[1]*s),Math.round(this._data[2]+i._data[2]*s),r(Math.round(this._a+100*s),0,100))}scale(t){if(this.isNull()||100==t)return this;const e=Math.max(0,t)/100;return _t(Math.round(this._data[0]*e),Math.round(this._data[1]*e),Math.round(this._data[2]*e),this._a)}multiply(t){if(this.isNull())return this;let e;if(Array.isArray(t)){if(t.length<3)throw new Error("requires at least r,g,b values.");e=t}else{if(t.isNull())return this;e=t._data}const i=(e[3]||100)/100;return _t(Math.round(this._ra*(e[0]/100)*i),Math.round(this._ga*(e[1]/100)*i),Math.round(this._ba*(e[2]/100)*i),100)}normalize(){if(this.isNull())return this;const t=Math.max(this._ra,this._ga,this._ba);return t<=100?this:_t(Math.round(100*this._ra/t),Math.round(100*this._ga/t),Math.round(100*this._ba/t),100)}inverse(){return new ut(100-this.r,100-this.g,100-this.b,this.a)}css(t=!1){const e=this.toInt(t);return e<0?"transparent":"#"+e.toString(16).padStart(t?6:3,"0")}toString(t=!1){return this.name?this.name:this.isNull()?"null color":this.css(t)}}function dt(t,e=!1){for(;t.length<3;)t.push(0);if(e)for(let e=0;e<3;++e)t[e]=Math.round(100*(t[e]||0)/255);return new ut(...t)}function ct(t){if(!t.startsWith("#"))throw new Error('Color CSS strings must be of form "#abc" or "#abcdef" - received: ['+t+"]");const e=Number.parseInt(t.substring(1),16);let i,s,n;return 4==t.length?(i=Math.round((e>>8)/15*100),s=Math.round(((240&e)>>4)/15*100),n=Math.round((15&e)/15*100)):(i=Math.round((e>>16)/255*100),s=Math.round(((65280&e)>>8)/255*100),n=Math.round((255&e)/255*100)),new ut(i,s,n)}function ft(t){const e=lt[t];if(!e)throw new Error("Unknown color name: "+t);return e}function gt(t,e=!1){return t<0?new ut:e||t>4095?new ut(Math.round(100*((16711680&t)>>16)/255),Math.round(100*((65280&t)>>8)/255),Math.round(100*(255&t)/255),100):new ut(Math.round(100*((3840&t)>>8)/15),Math.round(100*((240&t)>>4)/15),Math.round(100*(15&t)/15),100)}function _t(...t){let e=t[0],i=t[1];if(0==t.length)return new ut;if(t.length>2&&(e=t,i=!1),null==e)return new ut(-1);if(e instanceof ut)return e;if("string"==typeof e)return e.startsWith("#")?ct(e):ft(e);if(Array.isArray(e))return dt(e,i);if("number"==typeof e)return gt(e,i);throw new Error("Failed to make color - unknown argument: "+JSON.stringify(e))}function pt(...t){const e=t[0];return e instanceof ut?e:void 0===e?new ut(-1):"string"!=typeof e||e.startsWith("#")?_t(e,t[1]):ft(e)}function bt(t,e){if(t.isNull()||e.isNull())return[t,e];const i=t.clamp(),s=e.clamp();let n=Math.abs(i.h-s.h);if(n>180&&(n=360-n),n>45)return[i,s];if(Math.abs(i.l-s.l)>=40)return[i,s];const r=[i,s],h=i.s<=s.s?0:1,o=1-h;for(;r[o].l-r[h].l<40;)r[o]=r[o].mix(xt,5),r[h]=r[h].mix(Et,5);return r}function mt(t,...e){let i=e;1==e.length&&(i=e[0]);const s=i instanceof ut?i:_t(i);return s._const=!0,lt[t]=s,s.name=t,s}function yt(t,...e){let i;return i=1==e.length?mt(t,e[0]):mt(t,...e),mt("light_"+t,i.lighten(25)),mt("lighter_"+t,i.lighten(50)),mt("lightest_"+t,i.lighten(75)),mt("dark_"+t,i.darken(25)),mt("darker_"+t,i.darken(50)),mt("darkest_"+t,i.darken(75)),i}const wt=mt("NONE",-1),Et=mt("black",0),xt=mt("white",4095);yt("teal",[30,100,100]),yt("brown",[60,40,0]),yt("tan",[80,70,55]),yt("pink",[100,60,66]),yt("gray",[50,50,50]),yt("yellow",[100,100,0]),yt("purple",[100,0,100]),yt("green",[0,100,0]),yt("orange",[100,50,0]),yt("blue",[0,0,100]),yt("red",[100,0,0]),yt("amber",[100,75,0]),yt("flame",[100,25,0]),yt("fuchsia",[100,0,100]),yt("magenta",[100,0,75]),yt("crimson",[100,0,25]),yt("lime",[75,100,0]),yt("chartreuse",[50,100,0]),yt("sepia",[50,40,25]),yt("violet",[50,0,100]),yt("han",[25,0,100]),yt("cyan",[0,100,100]),yt("turquoise",[0,100,75]),yt("sea",[0,100,50]),yt("sky",[0,75,100]),yt("azure",[0,50,100]),yt("silver",[75,75,75]),yt("gold",[100,85,0]);var vt=Object.freeze({__proto__:null,colors:lt,Color:ut,fromArray:dt,fromCss:ct,fromName:ft,fromNumber:gt,make:_t,from:pt,separate:bt,relativeLuminance:function(t,e){return Math.round(100*((t.r-e.r)*(t.r-e.r)*.2126+(t.g-e.g)*(t.g-e.g)*.7152+(t.b-e.b)*(t.b-e.b)*.0722)/65025)},distance:function(t,e){return Math.round(100*((t.r-e.r)*(t.r-e.r)*.3333+(t.g-e.g)*(t.g-e.g)*.3333+(t.b-e.b)*(t.b-e.b)*.3333)/65025)},smoothScalar:function(t,e=255){return Math.floor(100*Math.sin(Math.PI*t/e))},install:mt,installSpread:yt,NONE:wt,BLACK:Et,WHITE:xt});class It{constructor(t){this.ch=o(null==t?void 0:t.ch,-1),this.fg=_t(null==t?void 0:t.fg),this.bg=_t(null==t?void 0:t.bg)}_changed(){return this}copy(t){return this.ch=t.ch||-1,this.fg=pt(t.fg),this.bg=pt(t.bg),this._changed()}clone(){const t=new It;return t.copy(this),t}equals(t){return this.ch==t.ch&&this.fg.equals(t.fg)&&this.bg.equals(t.bg)}get dances(){return this.fg.dances||this.bg.dances}nullify(){return this.ch=-1,this.fg=wt,this.bg=wt,this._changed()}blackOut(){return this.ch=-1,this.fg=Et,this.bg=Et,this._changed()}draw(t=-1,e=-1,i=-1){return t&&-1!==t&&(this.ch=t),-1!==e&&null!==e&&(e=pt(e),this.fg=this.fg.blend(e)),-1!==i&&null!==i&&(i=pt(i),this.bg=this.bg.blend(i)),this._changed()}drawSprite(t,e){return t===this?this:(void 0===e&&(e=t.opacity),void 0===e&&(e=100),e<=0?void 0:(t.ch&&(this.ch=t.ch),(t.fg&&-1!==t.fg||0===t.fg)&&(this.fg=this.fg.mix(t.fg,e)),(t.bg&&-1!==t.bg||0===t.bg)&&(this.bg=this.bg.mix(t.bg,e)),this._changed()))}swap(){return[this.bg,this.fg]=[this.fg,this.bg],this._changed()}invert(){return this.bg=this.bg.inverse(),this.fg=this.fg.inverse(),this._changed()}multiply(t,e=!0,i=!0){return t=pt(t),e&&(this.fg=this.fg.multiply(t)),i&&(this.bg=this.bg.multiply(t)),this._changed()}scale(t,e=!0,i=!0){return e&&(this.fg=this.fg.scale(t)),i&&(this.bg=this.bg.scale(t)),this._changed()}mix(t,e=50,i=e){return t=pt(t),e>0&&(this.fg=this.fg.mix(t,e)),i>0&&(this.bg=this.bg.mix(t,i)),this._changed()}add(t,e=100,i=e){return t=pt(t),e>0&&(this.fg=this.fg.add(t,e)),i>0&&(this.bg=this.bg.add(t,i)),this._changed()}separate(){return[this.fg,this.bg]=bt(this.fg,this.bg),this._changed()}bake(t=!1){return this.fg=this.fg.bake(t),this.bg=this.bg.bake(t),this._changed(),{ch:this.ch,fg:this.fg.toInt(),bg:this.bg.toInt()}}toString(){return`{ ch: ${this.ch}, fg: ${this.fg.toString(!0)}, bg: ${this.bg.toString(!0)} }`}}var At={colorStart:"#{",colorEnd:"}",field:"{{",fieldEnd:"}}",defaultFg:null,defaultBg:null},Tt={default:(t,e,i)=>"",debug:(t,e,i)=>void 0!==i?`${i}.!!${t}!!`:`!!${t}!!`};function St(t,e={}){const i=e.field||At.field,s=function(t,e={}){const i=[];let s=!1,n=0,r=!1,h=0;for(;h<t.length;){const e=t.charAt(h);if(s){if("}"===e){if("}"!==t.charAt(h+1))throw new Error("Templates cannot contain }");const e=t.slice(n,h);i.push(e),++h,s=!1,n=h+1}}else if("\\"===e)"{"===t.charAt(h+1)&&(++h,r=!0);else if("{"===e&&"{"===t.charAt(h+1)){for(;"{"===t.charAt(h+1);)++h;s=!0;let e=t.slice(n,h-1);r&&(e=e.replace(/\\\{/g,"{")),i.push(e),n=h+1,r=!1}++h}if(n!==t.length){let e=t.slice(n);r&&(e=e.replace(/\\\{/g,"{")),i.push(e)}return i}(t).map(((t,s)=>s%2==0?Lt(t):0==t.length?Lt(i):function(t,e={}){const i=/((\w+) )?(\w+)(\.(\w+))?(%[\+\.\-\d]*[dsf])?/.exec(t)||[],s=i[2],n=i[3],r=i[5],h=i[6];let o=function(t,e=!1){return function(i){let s=Tt[t];if(s)return s(t,i);const n=i[t];return void 0!==n?n:(s=e?Tt.debug:Tt.default,s(t,i))}}(n,e.debug);r&&r.length&&(o=function(t,e,i=!1){const s=i?Tt.debug:Tt.default;return function(i){const n=e(i);if(!n)return s(t,i,n);const r=n[t];return void 0===r?s(t,i,n):r}}(r,o,e.debug));s&&s.length&&(o=function(t,e,i=!1){const s=Tt[t]||(i?Tt.debug:Tt.default);return function(i){const n=e(i);return s(t,i,n)}}(s,o,e.debug));h&&h.length&&(o=h.endsWith("s")?function(t,e){const i=/%(-?\d*)s/.exec(t)||[],s=Number.parseInt(i[1]||"0");return function(t){let i=""+e(t);return s<0?i=i.padEnd(-s):s&&(i=i.padStart(s)),i}}(h,o):h.endsWith("d")?function(t,e){const i=/%([\+-]*)(\d*)d/.exec(t)||["","","0"];let s=Number.parseInt(i[2]||"0");const n=i[1].includes("+"),r=i[1].includes("-");return function(t){const i=Number.parseInt(e(t)||0);let h=""+i;return i>0&&n&&(h="+"+h),s&&r?h.padEnd(s):s?h.padStart(s):h}}(h,o):function(t,e){const i=/%([\+-]*)(\d*)(\.(\d+))?f/.exec(t)||["","","0"];let s=Number.parseInt(i[2]||"0");const n=i[1].includes("+"),r=i[1].includes("-"),h=Number.parseInt(i[4])||0;return function(t){const i=Number.parseFloat(e(t)||0);let o;return o=h?i.toFixed(h):""+i,i>0&&n&&(o="+"+o),s&&r?o.padEnd(s):s?o.padStart(s):o}}(h,o));return o}(t,e)));return function(t={}){return"string"==typeof t&&(t={value:t}),s.map((e=>e(t))).join("")}}function Ct(t,e={}){return St(t)(e)}function Lt(t){return()=>t}function Mt(t,i,s={}){if(null==t)return;if(!i)return;if(!(t=""+t).length)return;const n=s.eachColor||e,r=s.fg||At.defaultFg,h=s.bg||At.defaultBg,o={fg:r,bg:h};n(o);const a=Object.assign({},o);let l=0,u=!1,d=!1,c=0,f="";for(;c<t.length;){const e=t.charAt(c);if(d)"}"===e?(d=!1,u=!1,Object.assign(o,a),n(o)):(i(e,o.fg,o.bg,l,c),++l);else if(u)if(" "===e){d=!0,Object.assign(a,o);const t=f.split(":");t[0].length&&(o.fg=t[0]),t[1]&&(o.bg=t[1]),n(o),f=""}else if("}"===e){u=!1;const t=f.split(":");t[0].length&&(o.fg=t[0]),t[1]&&(o.bg=t[1]),n(o),f=""}else f+=e;else if("#"===e)"{"===t.charAt(c+1)?"}"===t.charAt(c+2)?(c+=2,o.fg=r,o.bg=h,n(o)):(u=!0,c+=1):(i(e,o.fg,o.bg,l,c),++l);else if("\\"===e){c+=1;i(t.charAt(c),o.fg,o.bg,l,c),++l}else i(e,o.fg,o.bg,l,c),++l;++c}d&&console.warn("Ended text without ending inline color!")}function kt(t){if(!t||0==t.length)return 0;let e=0,i=!1,s=!1;for(let n=0;n<t.length;++n){const r=t.charAt(n);s?"}"===r?(s=!1,i=!1):e+=1:i?" "===r?s=!0:"}"===r&&(i=!1):"#"===r?"{"===t.charAt(n+1)?(i=!0,n+=1):e+=1:"\\"===r?("#"===t.charAt(n+1)&&(n+=1),e+=1):e+=1}return e}function Ot(t,e,i=0){let s=!1,n=!1,r=i;for(;r<t.length;){let i=t.charAt(r);if(n){if("}"===i)n=!1,s=!1;else if(e(i,r))return r}else if(s)" "===i?n=!0:"}"===i&&(s=!1);else if("#"===i){if("{"===t.charAt(r+1))s=!0,r+=1;else if(e(i,r))return r}else if("\\"===i){if("#"===t.charAt(r+1)&&(r+=1,i=t.charAt(r)),e(i,r))return r}else if(e(i,r))return r;++r}return-1}function Rt(t,e,i=" "){const s=kt(t);if(s>=e)return t;const n=t.length-s;return t.padEnd(e+n,i)}function Nt(t){const e=Ot(t,(t=>" "!==t));if(e<0)return t;const i=t.charAt(e);return t.substring(0,e)+i.toUpperCase()+t.substring(e+1)}function Dt(t,e,i,s=""){const n=t.length;if(e>=n)return t;const r=t.substring(0,e);if(e+i>=n)return r;return r+s+t.substring(e+i)}function Wt(t,e,i={}){if(e<5)return t;let s=e;i.hyphenate&&(!0===i.hyphenate&&(i.hyphenate=Math.floor(e/2)),s=r(i.hyphenate,6,e+1)),i.indent=i.indent||0;const n=" ".repeat(i.indent);let h="",o=null,a=null,l=e;return e-=i.indent,function(t,e,i={}){let s="",n="",r="",h="";Mt(t,((t,i,o)=>{i===n&&o===r||(s.length&&(e(s,n,r,h),s="",h=""),n=i,r=o)," "===t?(s.length&&(e(s,n,r,h),s="",h=""),h+=" "):"\n"===t?(s.length&&(e(s,n,r,h),s="",h=""),e("\n",n,r,h),h=""):"-"===t?(s+=t,s.length>3&&(e(s,n,r,h),s="",h="")):s+=t}),i),s&&e(s,n,r,h)}(t,((t,i,r,u)=>{let d=u.length+t.length;if(d>l&&t.length>s){const s=function(t,e,i){let s=0,n=[],r=i||e;for(;s<t.length;){const i=t.length-s;if(r>=i)return n.push(t.substring(s)),n;if(r<4&&(r=e,n.push("")),i<r+e)return n.push(t.substring(s,s+r-1)),n.push(t.substring(s+r-1)),n;const h=Math.min(r-1,Math.floor(i/2)),o=t.substring(s,s+h);n.push(o),s+=h,r=e}return n}(t,e,l-u.length);for(0===s[0].length?(h+="\n",(i||r)&&(h+=`#{${i||""}${r?":"+r:""}}`),l=e,s.shift()):(h+=u,l-=u.length);s.length>1;)h+=s.shift()+"-\n",(i||r)&&(h+=`#{${i||""}${r?":"+r:""}}`),h+=n;return h+=s[0],void(l=e-s[0].length-n.length)}if("\n"===t||d>l){if(h+="\n",(i||r)&&(o="INVALID",a="INVALID"),l=e,h+=n,l-=n.length,"\n"===t)return;u=""}u.length&&(h+=u,l-=u.length),i===o&&r===a||(o=i,a=r,h+=`#{${i||""}${r?":"+r:""}}`),l-=t.length,h+=t})),h}function Pt(t,e=200,i={}){if("string"!=typeof t)return[];return Wt(t=t.trimEnd(),e,i).split("\n")}var Bt=Object.freeze({__proto__:null,configure:function(t={}){void 0!==t.fg&&(At.defaultFg=t.fg),void 0!==t.bg&&(At.defaultBg=t.bg),t.colorStart&&(At.colorStart=t.colorStart),t.colorEnd&&(At.colorEnd=t.colorEnd),t.field&&(At.field=t.field)},compile:St,apply:Ct,eachChar:Mt,wordWrap:Wt,splitIntoLines:Pt,addHelper:function(t,e){Tt[t]=e},options:At,length:kt,advanceChars:function(t,e,i){let s=0,n=!1,r=!1,h=e||0;for(;s<i;){const e=t.charAt(h);r?"}"===e?(r=!1,n=!1):s+=1:n?" "===e?r=!0:"}"===e&&(n=!1):"#"===e?"{"===t.charAt(h+1)?(n=!0,h+=1):s+=1:"\\"===e?("#"===t.charAt(h+1)&&(h+=1),s+=1):s+=1,++h}return h},findChar:Ot,firstChar:function(t){const e=Ot(t,i);return e<0?null:t.charAt(e)},padStart:function(t,e,i=" "){const s=kt(t);if(s>=e)return t;const n=t.length-s;return t.padStart(e+n,i)},padEnd:Rt,center:function(t,e,i=" "){const s=t.length,n=e-kt(t);if(n<=0)return t;const r=Math.floor(n/2);return t.padStart(s+r,i).padEnd(s+n,i)},truncate:function(t,e){let i=0,s=!1,n=!1,r=0,h=0;for(;i<e;){const e=t.charAt(r);n?"}"===e?(n=!1,s=!1,h-=1):i+=1:s?" "===e?n=!0:"}"===e&&(s=!1):"#"===e?"{"===t.charAt(r+1)?"}"===t.charAt(r+2)?(r+=2,h=0):(s=!0,r+=1,h+=1):i+=1:"\\"===e?("#"===t.charAt(r+1)&&(r+=1),i+=1):i+=1,++r}return n?t.substring(0,r)+"}"+(h>1?"#{}":""):t.substring(0,r)+(h?"#{}":"")},capitalize:Nt,removeColors:function(t){let e="",i=!1,s=!1,n=0;for(;n<t.length;){let r=t.charAt(n);s?"}"===r?(s=!1,i=!1):e+=r:i?" "===r?s=!0:"}"===r&&(i=!1):"#"===r?"{"===t.charAt(n+1)?(i=!0,n+=1):e+=r:"\\"===r?("#"===t.charAt(n+1)&&(e+=r,n+=1,r=t.charAt(n)),e+=r):e+=r,++n}return e},spliceRaw:Dt,hash:function(t){let e=0;const i=t.length;for(let s=0;s<i;s++)e=(e<<5)-e+t.charCodeAt(s),e|=0;return e}});class Vt{constructor(t,e){this.changed=!1,this._width=t,this._height=e,this._data=this._makeData()}_makeData(){return new Uint32Array(this.width*this.height)}get width(){return this._width}get height(){return this._height}hasXY(t,e){return t>=0&&e>=0&&t<this.width&&e<this.height}clone(){const t=new this.constructor(this._width,this._height);return t.copy(this),t}resize(t,e){const i=this._data;this._width=t,this._height=e,i.length<t*e?(this._data=new Uint32Array(t*e),this._data.set(i,0)):this._data=i.slice(t*e),this.changed=!0}_index(t,e){return e*this.width+t}get(t,e){if(!this.hasXY(t,e))return 0;let i=this._index(t,e);return this._data[i]||0}info(t,e){const i=this.get(t,e);return{glyph:i>>24,fg:4095&i,bg:i>>12&4095}}set(t,e,i){if(!this.hasXY(t,e))return;let s=this._index(t,e);return this._data[s]!==i&&(this._data[s]=i,!0)}toGlyph(t){return"number"==typeof t?t:t&&t.length?t.charCodeAt(0):-1}draw(t,e,i=-1,s=-1,n=-1){if(!this.hasXY(t,e))return this;const r=this.get(t,e);"number"!=typeof i&&(i=this.toGlyph(i)),i=i>=0?255&i:r>>24,"number"!=typeof s?s=pt(4095&r).blend(s).toInt():s<0?s=4095&r:s&=4095,"number"!=typeof n?n=pt(r>>12&4095).blend(n).toInt():n<0?n=r>>12&4095:n&=4095;const h=(i<<24)+(n<<12)+s;return this.set(t,e,h),h!==r&&(this.changed=!0),this}drawSprite(t,e,i){const s=null===i.ch?-1:i.ch,n=null===i.fg?-1:i.fg,r=null===i.bg?-1:i.bg;return this.draw(t,e,s,n,r)}blackOut(...t){return 0==t.length?this.fill(0,0,0):this.draw(t[0],t[1],0,0,0)}fill(t=0,e=4095,i=0){return 1==arguments.length&&(i=pt(t),t=0,e=0),this.fillRect(0,0,this.width,this.height,t,e,i)}copy(t){return this._width=t._width,this._height=t._height,this._data.set(t._data),this.changed=!0,this}drawText(t,e,i,s=4095,n=-1,r=0,h="left"){if("number"!=typeof s&&(s=pt(s)),"number"!=typeof n&&(n=pt(n)),r=Math.min(r||this.width,this.width-t),"right"==h){const e=kt(i);t+=r-e}else if("center"==h){const e=kt(i);t+=Math.floor((r-e)/2)}return Mt(i,((i,s,n,h)=>{t+h>=this.width||h>=r||this.draw(h+t,e,i,s,n)}),{fg:s,bg:n}),1}wrapText(t,e,i,s,n=4095,r=-1,h=0){"number"!=typeof n&&(n=pt(n)),"number"!=typeof r&&(r=pt(r)),s=Wt(s,i=Math.min(i,this.width-t),{indent:h});let o=0,a=t;for(Mt(s,((s,n,r)=>{if("\n"==s){for(;a<t+i;)this.draw(a++,e+o,0,0,r);return++o,void(a=t+h)}this.draw(a++,e+o,s,n,r)}),{fg:n,bg:r});a<t+i;)this.draw(a++,e+o,0,0,r);return o+1}fillRect(t,e,i,s,n=-1,r=-1,h=-1){null===n&&(n=-1),"number"!=typeof n&&(n=this.toGlyph(n)),"number"!=typeof r&&(r=pt(r)),"number"!=typeof h&&(h=pt(h));const o=Math.min(t+i,this.width),a=Math.min(e+s,this.height);for(let i=t;i<o;++i)for(let t=e;t<a;++t)this.draw(i,t,n,r,h);return this}blackOutRect(t,e,i,s,n=0){return"number"!=typeof n&&(n=pt(n)),this.fillRect(t,e,i,s,0,n,n)}highlight(t,e,i,s){if(!this.hasXY(t,e))return this;"number"!=typeof i&&(i=pt(i));const n=new It,r=this.info(t,e);return n.drawSprite(r),n.fg=n.fg.add(i,s),n.bg=n.bg.add(i,s),this.drawSprite(t,e,n),this}mix(t,e,i=0,s=0,n=0,r=0){if((t=pt(t)).isNull())return this;const h=new It;n||(n=i?1:this.width),r||(r=s?1:this.height);const o=Math.min(n+i,this.width),a=Math.min(r+s,this.height);for(let n=i;n<o;++n)for(let i=s;i<a;++i){const s=this.info(n,i);h.drawSprite(s),h.fg=h.fg.mix(t,e),h.bg=h.bg.mix(t,e),this.drawSprite(n,i,h)}return this}blend(t,e=0,i=0,s=0,n=0){if((t=pt(t)).isNull())return this;const r=new It;s||(s=e?1:this.width),n||(n=i?1:this.height);const h=Math.min(s+e,this.width),o=Math.min(n+i,this.height);for(let s=e;s<h;++s)for(let e=i;e<o;++e){const i=this.info(s,e);r.drawSprite(i),r.fg=r.fg.blend(t),r.bg=r.bg.blend(t),this.drawSprite(s,e,r)}return this}dump(){const t=[];let e="    ";for(let t=0;t<this.width;++t)t%10==0&&(e+=" "),e+=t%10;t.push(e),t.push("");for(let e=0;e<this.height;++e){let i=`${(""+e).padStart(2)}] `;for(let t=0;t<this.width;++t){t%10==0&&(i+=" ");const s=this.info(t,e).glyph;i+=String.fromCharCode(s||32)}t.push(i)}console.log(t.join("\n"))}}var Ht=Object.freeze({__proto__:null,Buffer:Vt,make:function(t,e){return new Vt(t,e)}});class Ft{constructor(t,e){this.source=null,this.target=null,this.defaultPrevented=!1,this.propagationStopped=!1,this.immediatePropagationStopped=!1,this.key="",this.code="",this.shiftKey=!1,this.ctrlKey=!1,this.altKey=!1,this.metaKey=!1,this.dir=null,this.x=-1,this.y=-1,this.clientX=-1,this.clientY=-1,this.dt=0,this.reset(t,e)}preventDefault(){this.defaultPrevented=!0}stopPropagation(){this.propagationStopped=!0}stopImmediatePropagation(){this.immediatePropagationStopped=!0}reset(t,e){this.type=t,this.target=null,this.source=null,this.defaultPrevented=!1,this.shiftKey=!1,this.ctrlKey=!1,this.altKey=!1,this.metaKey=!1,this.key="",this.code="",this.x=-1,this.y=-1,this.dir=null,this.dt=0,this.target=null,e&&Object.assign(this,e)}}let jt={};const Yt=[],Gt="keypress",Ut="mousemove",Xt="click",Kt="tick",zt="mouseup",qt="stop",$t=["ShiftLeft","ShiftRight","ControlLeft","ControlRight","AltLeft","AltRight","MetaLeft","MetaRight"];function Zt(t,e){let i;return t.dir?i=e.dir||e.keypress:t.type===Gt?i=e[t.key]||e[t.code]||e.keypress:e[t.type]&&(i=e[t.type]),i||(i=e.dispatch),i||null}async function Jt(t,e,i){let s;if(e=e||jt,t.type===qt)return Qt(t),!0;const n=Zt(t,e);return n&&(s=await n.call(i||e,t)),Qt(t),s}function Qt(t){Yt.push(t)}function te(){return ee(qt)}function ee(t,e){const i=Yt.pop()||null;return i?(i.reset(t,e),i):new Ft(t,e)}function ie(t){const e=ee(Kt);return e.dt=t,e}function se(t){let e=t.key,i=t.code.toLowerCase();t.shiftKey&&(e=e.toUpperCase(),i=i.toUpperCase()),t.ctrlKey&&(e="^"+e,i="^"+i),t.metaKey&&(e="#"+e,i="#"+i),t.altKey&&(i="/"+i);const s=Yt.pop()||new Ft(Gt);return s.shiftKey=t.shiftKey,s.ctrlKey=t.ctrlKey,s.altKey=t.altKey,s.metaKey=t.metaKey,s.type=Gt,s.defaultPrevented=!1,s.key=e,s.code=i,s.x=-1,s.y=-1,s.clientX=-1,s.clientY=-1,s.dir=ne(t.code),s.dt=0,s.target=null,s}function ne(t){const e=t.toLowerCase();return"arrowup"===e?[0,-1]:"arrowdown"===e?[0,1]:"arrowleft"===e?[-1,0]:"arrowright"===e?[1,0]:null}function re(t){return $t.includes(t.code)}function he(t,e,i){const s=Yt.pop()||new Ft(t.type);return s.shiftKey=t.shiftKey,s.ctrlKey=t.ctrlKey,s.altKey=t.altKey,s.metaKey=t.metaKey,s.type=t.type,t.buttons&&"mouseup"!==t.type&&(s.type=Xt),s.defaultPrevented=!1,s.key="",s.code="",s.x=e,s.y=i,s.clientX=t.clientX,s.clientY=t.clientY,s.dir=null,s.dt=0,s.target=null,s}class oe{constructor(t){this._running=!1,this._events=new ht,this._result=void 0,this._tweens=[],this._timers=[],this._loop=null,this.mouse={x:-1,y:-1},this.lastClick={x:-1,y:-1},t&&t.pushHandler(this)}get running(){return this._running}hasEvents(){return this._events.length}clearEvents(){for(;this._events.length;){const t=this._events._data.shift();Yt.push(t)}}enqueue(t){if(this._events.length){const e=this._events.last;if(e.type===t.type&&e.type===Ut)return e.x=t.x,e.y=t.y,void Qt(t)}if(t.type===Xt){if(this.lastClick.x==t.x&&this.lastClick.y==t.y)return void Qt(t);this.lastClick.x=t.x,this.lastClick.y=t.y}else if(t.type==zt)return this.lastClick.x=-1,this.lastClick.y=-1,void Qt(t);if(t.type===Kt){const e=this._events.first;if(e&&e.type===Kt)return e.dt+=t.dt,void Qt(t);this._events.prepend(t)}else this._events.enqueue(t)}async nextEvent(t=-1,e){e=e||i;let s=0;for(;t<0||s<t;){const i=await this._events.dequeue();if(i.type===Ut&&(this.mouse.x=i.x,this.mouse.y=i.y),i.type===Kt&&(this._tick(i.dt),t>0&&(s+=i.dt,s>t)))return null;if(e(i))return i;Qt(i)}return null}async run(t={},e=-1,i){if(this._running)throw new Error("IO Handler is already running!");for(i=i||this,this._running=!0,this.clearEvents(),t.start&&"function"==typeof t.start&&await t.start.call(i);this.running;){t.draw&&"function"==typeof t.draw&&t.draw.call(i);const s=await this.nextEvent(e);s&&await Jt(s,t,i)}return t.stop&&"function"==typeof t.stop&&await t.stop.call(i),this._result}finish(t){this.clearEvents(),this._running=!1,this._result=t,this.enqueue(te()),this._loop&&this._loop.popHandler(this)}async nextTick(t=-1){return this.nextEvent(t,(t=>t&&t.type===Kt))}async nextKeyPress(t,e){return void 0===t&&(t=-1),e=e||i,this.nextEvent(t,(function(t){return t.type===Gt&&e(t)}))}async nextKeyOrClick(t,e){return void 0===t&&(t=-1),e=e||i,this.nextEvent(t,(function(t){return(t.type===Gt||t.type===Xt)&&e(t)}))}async pause(t){const e=await this.nextKeyOrClick(t);return!!e&&e.type!==Kt}waitForAck(){return this.pause(3e5)}addAnimation(t){t.isRunning()||t.start(),this._tweens.push(t)}removeAnimation(t){l(this._tweens,t)}setTimeout(t,e){const i=this._timers.findIndex((t=>t.time<=0));return i<0?this._timers.push({action:t,time:e}):this._timers[i]={action:t,time:e},t}clearTimeout(t){const e=this._timers.find((e=>e.action===t));e&&(e.time=-1)}_tick(t){this._tweens.forEach((e=>e.tick(t))),this._tweens=this._tweens.filter((t=>t.isRunning()));for(let e of this._timers)e.time<=0||(e.time-=t,e.time<=0&&e.action());return this._tweens.length>0}}const ae=new oe;class le{constructor(){this.handlers=[],this.currentHandler=null,this._tickInterval=0}finish(){this._stopTicks(),this.handlers.length=0,this.currentHandler=null}pushHandler(t){this.handlers.includes(t)||this.handlers.push(t),this.currentHandler=t,t._loop=this,this._startTicks()}popHandler(t){l(this.handlers,t),t._loop=null,this.currentHandler=this.handlers[this.handlers.length-1]||null,this.currentHandler||this._stopTicks()}enqueue(t){this.currentHandler&&this.currentHandler.enqueue(t)}_startTicks(){this._tickInterval||(this._tickInterval=setInterval((()=>{const t=ie(16);this.enqueue(t)}),16))}_stopTicks(){clearInterval(this._tickInterval),this._tickInterval=0}onkeydown(t){if(!re(t)){if(this.currentHandler){"Escape"===t.code&&this.currentHandler.clearEvents();const e=se(t);this.enqueue(e)}t.preventDefault()}}addAnimation(t){this.currentHandler&&this.currentHandler.addAnimation(t)}removeAnimation(t){this.currentHandler&&this.currentHandler.removeAnimation(t)}}const ue=new le;function de(t){ue.pushHandler(t)}function ce(t){ue.popHandler(t)}var fe,ge=Object.freeze({__proto__:null,Event:Ft,KEYPRESS:Gt,MOUSEMOVE:Ut,CLICK:Xt,TICK:Kt,MOUSEUP:zt,STOP:qt,setKeymap:function(t){jt=t},handlerFor:Zt,dispatchEvent:Jt,makeStopEvent:te,makeCustomEvent:ee,makeTickEvent:ie,makeKeyEvent:se,keyCodeDirection:ne,ignoreKeyEvent:re,makeMouseEvent:he,Handler:oe,make:function(t=!0){const e=new oe;return t&&(!0===t&&(t=ue),ue.pushHandler(e)),e},nextEvent:async function(t){de(ae);const e=await ae.nextEvent(t);return ce(ae),e},nextTick:async function(t){de(ae);const e=await ae.nextTick(t);return ce(ae),e},nextKeyOrClick:async function(t,e){de(ae);const i=await ae.nextKeyOrClick(t,e);return ce(ae),i},nextKeyPress:async function(t,e){de(ae);const i=await ae.nextKeyPress(t,e);return ce(ae),i},pause:async function(t){de(ae);const e=await ae.pause(t);return ce(ae),e},waitForAck:async function(){de(ae);const t=await ae.waitForAck();return ce(ae),t},Loop:le,loop:ue,pushHandler:de,popHandler:ce,enqueue:function(t){ue.enqueue(t)}});!function(t){t[t.VISIBLE=X(0)]="VISIBLE",t[t.WAS_VISIBLE=X(1)]="WAS_VISIBLE",t[t.CLAIRVOYANT_VISIBLE=X(2)]="CLAIRVOYANT_VISIBLE",t[t.WAS_CLAIRVOYANT_VISIBLE=X(3)]="WAS_CLAIRVOYANT_VISIBLE",t[t.TELEPATHIC_VISIBLE=X(4)]="TELEPATHIC_VISIBLE",t[t.WAS_TELEPATHIC_VISIBLE=X(5)]="WAS_TELEPATHIC_VISIBLE",t[t.ITEM_DETECTED=X(6)]="ITEM_DETECTED",t[t.WAS_ITEM_DETECTED=X(7)]="WAS_ITEM_DETECTED",t[t.ACTOR_DETECTED=X(8)]="ACTOR_DETECTED",t[t.WAS_ACTOR_DETECTED=X(9)]="WAS_ACTOR_DETECTED",t[t.REVEALED=X(10)]="REVEALED",t[t.MAGIC_MAPPED=X(11)]="MAGIC_MAPPED",t[t.IN_FOV=X(12)]="IN_FOV",t[t.WAS_IN_FOV=X(13)]="WAS_IN_FOV",t[t.ALWAYS_VISIBLE=X(14)]="ALWAYS_VISIBLE",t[t.IS_CURSOR=X(15)]="IS_CURSOR",t[t.IS_HIGHLIGHTED=X(16)]="IS_HIGHLIGHTED",t[t.ANY_KIND_OF_VISIBLE=t.VISIBLE|t.CLAIRVOYANT_VISIBLE|t.TELEPATHIC_VISIBLE]="ANY_KIND_OF_VISIBLE",t[t.IS_WAS_ANY_KIND_OF_VISIBLE=t.VISIBLE|t.WAS_VISIBLE|t.CLAIRVOYANT_VISIBLE|t.WAS_CLAIRVOYANT_VISIBLE|t.TELEPATHIC_VISIBLE|t.WAS_TELEPATHIC_VISIBLE]="IS_WAS_ANY_KIND_OF_VISIBLE",t[t.WAS_ANY_KIND_OF_VISIBLE=t.WAS_VISIBLE|t.WAS_CLAIRVOYANT_VISIBLE|t.WAS_TELEPATHIC_VISIBLE]="WAS_ANY_KIND_OF_VISIBLE",t[t.WAS_DETECTED=t.WAS_ITEM_DETECTED|t.WAS_ACTOR_DETECTED]="WAS_DETECTED",t[t.IS_DETECTED=t.ITEM_DETECTED|t.ACTOR_DETECTED]="IS_DETECTED",t[t.PLAYER=t.IN_FOV]="PLAYER",t[t.CLAIRVOYANT=t.CLAIRVOYANT_VISIBLE]="CLAIRVOYANT",t[t.TELEPATHIC=t.TELEPATHIC_VISIBLE]="TELEPATHIC",t[t.VIEWPORT_TYPES=t.PLAYER|t.VISIBLE|t.CLAIRVOYANT|t.TELEPATHIC|t.ITEM_DETECTED|t.ACTOR_DETECTED]="VIEWPORT_TYPES"}(fe||(fe={}));class _e{constructor(t){this._setVisible=null,this._startX=-1,this._startY=-1,this._maxRadius=100,this._isBlocked=t.isBlocked,this._calcRadius=t.calcRadius||y,this._hasXY=t.hasXY||i,this._debug=t.debug||e}calculate(t,e,i,s){this._setVisible=s,this._setVisible(t,e,1),this._startX=t,this._startY=e,this._maxRadius=i+1;for(let t=4;t<8;++t){const e=c[t];this.castLight(1,1,0,0,e[0],e[1],0),this.castLight(1,1,0,e[0],0,0,e[1])}}castLight(t,e,i,s,n,r,h){if(t>=this._maxRadius)return void this._debug("CAST: row=%d, start=%d, end=%d, row >= maxRadius => cancel",t,e.toFixed(2),i.toFixed(2));if(e<i)return void this._debug("CAST: row=%d, start=%d, end=%d, start < end => cancel",t,e.toFixed(2),i.toFixed(2));this._debug("CAST: row=%d, start=%d, end=%d, x=%d,%d, y=%d,%d",t,e.toFixed(2),i.toFixed(2),s,n,r,h);let o,a,l,u,d,c=e,f=!1,g=-t,_=0;for(let p=-t;p<=0;p++){if(o=Math.floor(this._startX+p*s+g*n),a=Math.floor(this._startY+p*r+g*h),l=(p-.5)/(g+.5),u=(p+.5)/(g-.5),d=p/(g+.5),_=(p+.5)/g,!this._hasXY(o,a)){f=!0;continue}if(this._debug("- test %d,%d ... start=%d, min=%d, max=%d, end=%d, dx=%d, dy=%d",o,a,e.toFixed(2),d.toFixed(2),_.toFixed(2),i.toFixed(2),p,g),e<_){f=this._isBlocked(o,a);continue}if(i>d)break;const b=this._calcRadius(p,g);if(b<this._maxRadius){const t=1-b/this._maxRadius;this._setVisible(o,a,t),this._debug("       - visible")}if(f){if(this._isBlocked(o,a)){this._debug("       - blocked ... nextStart: %d",u.toFixed(2)),c=u;continue}f=!1}else this._isBlocked(o,a)&&t<this._maxRadius&&(this._debug("       - blocked ... start:%d, end:%d, nextStart: %d",c.toFixed(2),l.toFixed(2),u.toFixed(2)),f=!0,this.castLight(t+1,c,l,s,n,r,h),c=u)}f||this.castLight(t+1,c,i,s,n,r,h)}}var pe=Object.freeze({__proto__:null,get FovFlags(){return fe},FOV:_e,FovSystem:class{constructor(t,i={}){this.changed=!0,this._callback=e,this.follow=null,this.site=t;let s=0;const n=i.visible||i.alwaysVisible;(i.revealed||n&&!1!==i.revealed)&&(s|=fe.REVEALED),n&&(s|=fe.VISIBLE),this.flags=nt(t.width,t.height,s),i.callback&&(this.callback=i.callback),this.fov=new _e({isBlocked:(t,e)=>this.site.blocksVision(t,e),hasXY:(t,e)=>t>=0&&e>=0&&t<this.site.width&&e<this.site.height}),i.alwaysVisible&&this.makeAlwaysVisible(),(i.visible||i.alwaysVisible)&&I(t.width,t.height,((t,e)=>this._callback(t,e,!0)))}get callback(){return this._callback}set callback(t){this._callback=t?"function"==typeof t?t:t.onFovChange.bind(t):e}getFlag(t,e){return this.flags[t][e]}isVisible(t,e){return!!((this.flags.get(t,e)||0)&fe.VISIBLE)}isAnyKindOfVisible(t,e){return!!((this.flags.get(t,e)||0)&fe.ANY_KIND_OF_VISIBLE)}isClairvoyantVisible(t,e){return!!((this.flags.get(t,e)||0)&fe.CLAIRVOYANT_VISIBLE)}isTelepathicVisible(t,e){return!!((this.flags.get(t,e)||0)&fe.TELEPATHIC_VISIBLE)}isInFov(t,e){return!!((this.flags.get(t,e)||0)&fe.IN_FOV)}isDirectlyVisible(t,e){const i=fe.VISIBLE|fe.IN_FOV;return((this.flags.get(t,e)||0)&i)===i}isActorDetected(t,e){return!!((this.flags.get(t,e)||0)&fe.ACTOR_DETECTED)}isItemDetected(t,e){return!!((this.flags.get(t,e)||0)&fe.ITEM_DETECTED)}isMagicMapped(t,e){return!!((this.flags.get(t,e)||0)&fe.MAGIC_MAPPED)}isRevealed(t,e){return!!((this.flags.get(t,e)||0)&fe.REVEALED)}fovChanged(t,e){const i=this.flags.get(t,e)||0;return!!(i&fe.ANY_KIND_OF_VISIBLE)!==!!(i&fe.WAS_ANY_KIND_OF_VISIBLE)}wasAnyKindOfVisible(t,e){return!!((this.flags.get(t,e)||0)&fe.WAS_ANY_KIND_OF_VISIBLE)}makeAlwaysVisible(){this.changed=!0,this.flags.forEach(((t,e,i)=>{this.flags[e][i]|=fe.ALWAYS_VISIBLE|fe.REVEALED|fe.VISIBLE,this.callback(e,i,!0)}))}makeCellAlwaysVisible(t,e){this.changed=!0,this.flags[t][e]|=fe.ALWAYS_VISIBLE|fe.REVEALED|fe.VISIBLE,this.callback(t,e,!0)}revealAll(t=!0){const e=fe.REVEALED|(t?fe.VISIBLE:0);this.flags.update((t=>t|e)),this.flags.forEach(((t,e,i)=>{this.callback(e,i,!!(t&fe.VISIBLE))})),this.changed=!0}revealCell(t,e,i=!0){const s=fe.REVEALED|(i?fe.VISIBLE:0);this.flags[t][e]|=s,this.callback(t,e,!!(s&fe.VISIBLE)),this.changed=!0}hideCell(t,e){this.flags[t][e]&=~(fe.MAGIC_MAPPED|fe.REVEALED|fe.ALWAYS_VISIBLE),this.flags[t][e]=this.demoteCellVisibility(this.flags[t][e]),this.callback(t,e,!1),this.changed=!0}magicMapCell(t,e){this.flags[t][e]|=fe.MAGIC_MAPPED,this.changed=!0,this.callback(t,e,!0)}reset(){this.flags.fill(0),this.changed=!0,this.flags.forEach(((t,e,i)=>{this.callback(e,i,!1)}))}setCursor(t,e,i=!1){i||this.flags.update((t=>t&~fe.IS_CURSOR)),this.flags[t][e]|=fe.IS_CURSOR,this.changed=!0}clearCursor(t,e){void 0===t||void 0===e?this.flags.update((t=>t&~fe.IS_CURSOR)):this.flags[t][e]&=~fe.IS_CURSOR,this.changed=!0}isCursor(t,e){return!!(this.flags[t][e]&fe.IS_CURSOR)}setHighlight(t,e,i=!1){i||this.flags.update((t=>t&~fe.IS_HIGHLIGHTED)),this.flags[t][e]|=fe.IS_HIGHLIGHTED,this.changed=!0}clearHighlight(t,e){void 0===t||void 0===e?this.flags.update((t=>t&~fe.IS_HIGHLIGHTED)):this.flags[t][e]&=~fe.IS_HIGHLIGHTED,this.changed=!0}isHighlight(t,e){return!!(this.flags[t][e]&fe.IS_HIGHLIGHTED)}demoteCellVisibility(t){return(t&=~(fe.WAS_ANY_KIND_OF_VISIBLE|fe.WAS_IN_FOV|fe.WAS_DETECTED))&fe.IN_FOV&&(t&=~fe.IN_FOV,t|=fe.WAS_IN_FOV),t&fe.VISIBLE&&(t&=~fe.VISIBLE,t|=fe.WAS_VISIBLE),t&fe.CLAIRVOYANT_VISIBLE&&(t&=~fe.CLAIRVOYANT_VISIBLE,t|=fe.WAS_CLAIRVOYANT_VISIBLE),t&fe.TELEPATHIC_VISIBLE&&(t&=~fe.TELEPATHIC_VISIBLE,t|=fe.WAS_TELEPATHIC_VISIBLE),t&fe.ALWAYS_VISIBLE&&(t|=fe.VISIBLE),t&fe.ITEM_DETECTED&&(t&=~fe.ITEM_DETECTED,t|=fe.WAS_ITEM_DETECTED),t&fe.ACTOR_DETECTED&&(t&=~fe.ACTOR_DETECTED,t|=fe.WAS_ACTOR_DETECTED),t}updateCellVisibility(t,e,i){const s=!!(t&fe.ANY_KIND_OF_VISIBLE),n=!!(t&fe.WAS_ANY_KIND_OF_VISIBLE);return s&&n||(s&&!n?(this.flags[e][i]|=fe.REVEALED,this._callback(e,i,s),this.changed=!0):!s&&n&&(this._callback(e,i,s),this.changed=!0)),s}updateCellDetect(t,e,i){const s=!!(t&fe.IS_DETECTED),n=!!(t&fe.WAS_DETECTED);return s&&n||(!s&&n||!n&&s)&&(this._callback(e,i,s),this.changed=!0),s}promoteCellVisibility(t,e,i){t&fe.IN_FOV&&this.site.hasVisibleLight(e,i)&&(t=this.flags[e][i]|=fe.VISIBLE),this.updateCellVisibility(t,e,i)||this.updateCellDetect(t,e,i)}updateFor(t){return this.update(t.x,t.y,t.visionDistance)}update(t,e,i){return void 0===t&&this.follow?this.updateFor(this.follow):(void 0===i&&(i=this.site.width+this.site.height),this.changed=!1,this.flags.update(this.demoteCellVisibility.bind(this)),this.site.eachViewport(((t,e,i,s)=>{let n=s&fe.VIEWPORT_TYPES;n||(n=fe.VISIBLE),0!=i?this.fov.calculate(t,e,i,((t,e,i)=>{i&&(this.flags[t][e]|=n)})):this.flags[t][e]|=n})),void 0!==t&&void 0!==e&&this.fov.calculate(t,e,i,((t,e,i)=>{i&&(this.flags[t][e]|=fe.PLAYER)})),this.flags.forEach(this.promoteCellVisibility.bind(this)),this.changed)}}});const be=3e4;function me(t){return{distance:0,cost:0,index:t,left:null,right:null}}function ye(t,e,i){return t.links[e+t.width*i]}const we=c;function Ee(t,e,i){return e<=0||i<=0||(e>=t.length-1||i>=t[0].length-1)}function xe(t,e){let i,s;for(function(t){let e,i,s,n=null,r=null,h=null;i=t.eightWays?8:4;let o=t.front.right;for(t.front.right=null;null!=o;){for(e=0;e<i;e++){if(s=o.index+(we[e][0]+t.width*we[e][1]),s<0||s>=t.width*t.height)continue;if(h=t.links[s],h.cost<0)continue;let i=0;if(e>=4){let s,n,r,h;if(i=.4142,n=o.index+we[e][0],n<0||n>=t.width*t.height)continue;if(h=o.index+t.width*we[e][1],h<0||h>=t.width*t.height)continue;if(s=t.links[n],r=t.links[h],-2==s.cost||-2==r.cost)continue}if(o.distance+h.cost+i<h.distance){for(h.distance=o.distance+h.cost+i,null!=h.right&&(h.right.left=h.left),null!=h.left&&(h.left.right=h.right),n=o,r=o.right;null!=r&&r.distance<h.distance;)n=r,r=r.right;null!=n&&(n.right=h),h.right=r,h.left=n,null!=r&&(r.left=h)}}r=o.right,o.left=null,o.right=null,o=r}}(t),i=0;i<t.width;i++)for(s=0;s<t.height;s++)e[i][s]=ye(t,i,s).distance}var ve;function Ie(t,e,i,s,n=!1){let r,h,o,a;o=0;let l=-1;const u=t[e][i];for(a=0;a<(n?8:4);++a){r=e+c[a][0],h=i+c[a][1];const n=t[r][h];if(n<u){const d=u-n;d>o&&!s(r,h,e,i,t)&&(l=a,o=d)}}return c[l]||null}function Ae(t,e,i,n=s){let r,h,o,a,l,u=-1,d=-1;const c=t.length,f=t[0].length;for(a=1e4,l=1e4,r=1;r<c-1;r++)for(h=1;h<f-1;h++)t[r][h]>=0&&t[r][h]<be&&!n(r,h,r,h,t)&&(o=(r-e)*(r-e)+(h-i)*(h-i),(o<a||o==a&&t[r][h]<l)&&(u=r,d=h,a=o,l=t[r][h]));return u>=0?[u,d]:null}var Te=Object.freeze({__proto__:null,FORBIDDEN:-1,OBSTRUCTION:-2,AVOIDED:10,OK:1,NO_PATH:be,calculateDistances:function(t,e,i,s,n=!1,r=3e4){const h=t.length,o=t[0].length;var a,l;let u,d;for(r<=0&&(r=be),(!ve||ve.width<h||ve.height<o)&&(a=h,l=o,ve={eightWays:!1,front:me(-1),links:$(a*l,(t=>me(t))),width:a,height:l}),ve.width=h,ve.height=o,u=0;u<h;u++)for(d=0;d<o;d++)ye(ve,u,d).cost=Ee(s,u,d)?-2:s[u][d];!function(t,e,i){let s;for(t.eightWays=i,t.front.right=null,s=0;s<t.width*t.height;s++)t.links[s].distance=e,t.links[s].left=t.links[s].right=null}(ve,r,n),function(t,e,i,s){let n,r,h;if(e>0&&i>0&&e<t.width-1&&i<t.height-1&&(h=ye(t,e,i),h.distance>s)){for(h.distance=s,null!=h.right&&(h.right.left=h.left),null!=h.left&&(h.left.right=h.right),n=t.front,r=t.front.right;null!=r&&r.distance<h.distance;)n=r,r=r.right;h.right=r,h.left=n,n.right=h,null!=r&&(r.left=h)}}(ve,e,i,0),xe(ve,t),t.x=e,t.y=i},rescan:function(t,e,i=!1,s=3e4){if(!ve)throw new Error("You must scan the map first.");!function(t,e,i,s=!1,n=3e4){let r,h;t.eightWays=s;let o=null,a=null;for(t.front.right=null,r=0;r<e.width;r++)for(h=0;h<e.height;h++){let s,l=ye(t,r,h);if(e?l.distance=e[r][h]:i&&(l.distance=n),s=0==r||0==h||r==e.width-1||h==e.height-1?-2:i[r][h],l.cost=s,s>0)if(l.distance<n){for((null===a||a.distance>l.distance)&&(o=t.front,a=t.front.right);null!==a&&a.distance<l.distance;)o=a,a=a.right;l.right=a,l.left=o,o.right=l,null!==a&&(a.left=l),o=l}else l.right=null,l.left=null;else l.right=null,l.left=null}}(ve,t,e,i,s),xe(ve,t)},nextStep:Ie,getClosestValidLocation:Ae,getPath:function(t,e,i,s,n=!1){let r=e,h=i;if(t[r][h]<0||t[r][h]>=be||s(r,h,r,h,t)){const e=Ae(t,r,h,s);if(!e)return null;r=e[0],h=e[1]}const o=[];let a;do{a=Ie(t,r,h,s,n),a&&(o.push([r,h]),r+=a[0],h+=a[1])}while(a);return o.length?o:null}});class Se{constructor(t,e,i=!1){this.fn=t,this.context=e||null,this.once=i||!1,this.next=null}matches(t,e,i){return!(this.fn!==t||void 0!==i&&i!=this.once||e&&this.context!==e)}}var Ce=Object.freeze({__proto__:null,EventListener:Se,EventEmitter:class{constructor(){this._events={}}addListener(t,e,i,s=!1){if("function"!=typeof e)throw new TypeError("The listener must be a function");const n=new Se(e,i||null,s);return L(this._events,t,n),this}on(t,e,i,s=!1){return this.addListener(t,e,i,s)}once(t,e,i){return this.addListener(t,e,i,!0)}removeListener(t,e,i,s=!1){return this._events[t]&&e?(C(this._events[t],(n=>{n.matches(e,i,s)&&M(this._events,t,n)})),this):this}off(t,e,i,s=!1){return this.removeListener(t,e,i,s)}clearEvent(t){return this._events[t]&&(this._events[t]=null),this}removeAllListeners(t){return t?this.clearEvent(t):this._events={},this}emit(t,...e){if(!this._events[t])return!1;let i=this._events[t];for(;i;){let s=i.next;i.once&&M(this._events,t,i),i.fn.apply(i.context,e),i=s}return!0}}});var Le=Object.freeze({__proto__:null,make:function(t){if(void 0===t)return()=>100;if(null===t)return()=>0;if("number"==typeof t)return()=>t;if("function"==typeof t)return t;let e={};if("string"==typeof t){const i=t.split(/[,|]/).map((t=>t.trim()));e={},i.forEach((t=>{let[i,s]=t.split(":");e[i]=Number.parseInt(s)||100}))}else e=t;const i=Object.entries(e).map((([t,e])=>{let i=0;if(i="string"==typeof e?Number.parseInt(e):e,t.includes("-")){let[e,s]=t.split("-").map((t=>t.trim())).map((t=>Number.parseInt(t)));return t=>t>=e&&t<=s?i:0}if(t.endsWith("+")){const e=Number.parseInt(t);return t=>t>=e?i:0}{const e=Number.parseInt(t);return t=>t===e?i:0}}));return 1==i.length?i[0]:t=>i.reduce(((e,i)=>e||i(t)),0)}});var Me=Object.freeze({__proto__:null,Scheduler:class{constructor(){this.next=null,this.time=0,this.cache=null}clear(){for(;this.next;){const t=this.next;this.next=t.next,t.next=this.cache,this.cache=t}}push(t,e=1){let i;if(this.cache?(i=this.cache,this.cache=i.next,i.next=null):i={item:null,time:0,next:null},i.item=t,i.time=this.time+e,this.next){let t=this,e=t.next;for(;e&&e.time<=i.time;)t=e,e=t.next;i.next=t.next,t.next=i}else this.next=i;return i}pop(){const t=this.next;return t?(this.next=t.next,t.next=this.cache,this.cache=t,this.time=Math.max(t.time,this.time),t.item):null}remove(t){if(!t||!this.next)return;if(this.next.item===t)return void(this.next=t.next);let e=this.next,i=e.next;for(;i&&i.item!==t;)e=i,i=i.next;i&&i.item===t&&(e.next=i.next)}}});class ke extends Vt{constructor(t,e){super(t.width,t.height),this._parent=null,this._target=t,this._parent=e||null,t.copyTo(this)}toGlyph(t){return this._target.toGlyph(t)}render(){return this._target.draw(this),this}reset(){this._parent?this.copy(this._parent):this.fill(0)}}class Oe{constructor(t={}){this._tileWidth=12,this._tileHeight=16,this.needsUpdate=!0,this._map={},t.font=t.font||"monospace",this._node=document.createElement("canvas"),this._ctx=this.node.getContext("2d"),this._configure(t)}static fromImage(t){if("string"==typeof t){if(t.startsWith("data:"))throw new Error("Glyph: You must load a data string into an image element and use that.");const e=document.getElementById(t);if(!e)throw new Error("Glyph: Failed to find image element with id:"+t);t=e}const e=new this({tileWidth:t.width/16,tileHeight:t.height/16});return e._ctx.drawImage(t,0,0),e}static fromFont(t){"string"==typeof t&&(t={font:t});const e=new this(t),i=t.basicOnly||t.basic||!1;return e._initGlyphs(i),e}get node(){return this._node}get ctx(){return this._ctx}get tileWidth(){return this._tileWidth}get tileHeight(){return this._tileHeight}get pxWidth(){return this._node.width}get pxHeight(){return this._node.height}forChar(t){return t&&t.length&&this._map[t]||-1}_configure(t){this._tileWidth=t.tileWidth||this.tileWidth,this._tileHeight=t.tileHeight||this.tileHeight,this.node.width=16*this.tileWidth,this.node.height=16*this.tileHeight,this._ctx.fillStyle="black",this._ctx.fillRect(0,0,this.pxWidth,this.pxHeight);const e=t.fontSize||t.size||Math.max(this.tileWidth,this.tileHeight);this._ctx.font=e+"px "+t.font,this._ctx.textAlign="center",this._ctx.textBaseline="middle",this._ctx.fillStyle="white"}draw(t,e){if(t>=256)throw new Error("Cannot draw more than 256 glyphs.");const i=t%16*this.tileWidth,s=Math.floor(t/16)*this.tileHeight,n=i+Math.floor(this.tileWidth/2),r=s+Math.floor(this.tileHeight/2);this._ctx.save(),this._ctx.beginPath(),this._ctx.rect(i,s,this.tileWidth,this.tileHeight),this._ctx.clip(),this._ctx.fillStyle="black",this._ctx.fillRect(i,s,this.tileWidth,this.tileHeight),this._ctx.fillStyle="white","function"==typeof e?e(this._ctx,i,s,this.tileWidth,this.tileHeight):(void 0===this._map[e]&&(this._map[e]=t),this._ctx.fillText(e,n,r)),this._ctx.restore(),this.needsUpdate=!0}_initGlyphs(t=!1){for(let t=32;t<127;++t)this.draw(t,String.fromCharCode(t));[" ","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","",""].forEach(((t,e)=>{this.draw(e,t)})),t||["","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","",""].forEach(((t,e)=>{this.draw(e+127,t)}))}}class Re extends Error{constructor(...t){super(...t),Error.captureStackTrace&&Error.captureStackTrace(this,Re),this.name="NotSupportedError"}}class Ne{constructor(t,e,i){this.mouse={x:-1,y:-1},this._renderRequested=!1,this._width=100,this._height=38,this._buffers=[],this._current=0,this.loop=ue,this._node=this._createNode(),this._createContext(),this._configure(t,e,i),this._buffers.push(new ke(this))}get node(){return this._node}get width(){return this._width}get height(){return this._height}get tileWidth(){return this._glyphs.tileWidth}get tileHeight(){return this._glyphs.tileHeight}get pxWidth(){return this.node.clientWidth}get pxHeight(){return this.node.clientHeight}get glyphs(){return this._glyphs}set glyphs(t){this._setGlyphs(t)}toGlyph(t){return"number"==typeof t?t:this._glyphs.forChar(t)}get buffer(){return this._buffers[this._current]}get parentBuffer(){const t=Math.max(0,this._current-1);return this._buffers[t]}get root(){return this._buffers[0]}pushBuffer(){const t=this.buffer;if(++this._current,this._current>=this._buffers.length){const e=new ke(this,t);e.reset(),this._buffers.push(e)}else this.buffer.copy(t);return this.buffer}popBuffer(){this._current=Math.max(0,this._current-1)}_createNode(){return document.createElement("canvas")}_configure(t,e,i){this._width=t,this._height=e,this._setGlyphs(i)}_setGlyphs(t){return t!==this._glyphs&&(this._glyphs=t,this.resize(this._width,this._height),!0)}resize(t,e){this._width=t,this._height=e,this._buffers.forEach((i=>i.resize(t,e)));const i=this.node;i.width=this._width*this.tileWidth,i.height=this._height*this.tileHeight}_requestRender(){this._renderRequested||(this._renderRequested=!0,requestAnimationFrame((()=>this._render())))}copyTo(t){this.buffer&&t.copy(this.buffer)}render(){this.buffer.render()}hasXY(t,e){return t>=0&&e>=0&&t<this.width&&e<this.height}set onclick(t){this.node.onclick=t?e=>{const i=he(e,this._toX(e.offsetX),this._toY(e.offsetY));t(i)}:null}set onmousemove(t){this.node.onmousemove=t?e=>{const i=this._toX(e.offsetX),s=this._toY(e.offsetY);if(i==this.mouse.x&&s==this.mouse.y)return;this.mouse.x=i,this.mouse.y=s;const n=he(e,i,s);t(n)}:null}set onmouseup(t){this.node.onmouseup=t?e=>{const i=he(e,this._toX(e.offsetX),this._toY(e.offsetY));t(i)}:null}set onkeydown(t){this.node.onkeydown=t?e=>{e.stopPropagation();const i=se(e);t(i)}:null}_toX(t){return r(Math.floor(this.width*(t/this.node.clientWidth)),0,this.width-1)}_toY(t){return r(Math.floor(this.height*(t/this.node.clientHeight)),0,this.height-1)}}class De extends Ne{constructor(t,e,i){super(t,e,i)}_createContext(){const t=this.node.getContext("2d");if(!t)throw new Re("2d context not supported!");this._ctx=t}resize(t,e){super.resize(t,e),this._data=new Uint32Array(t*e),this._changed=new Int8Array(t*e)}draw(t){if(t._data.every(((t,e)=>t===this._data[e])))return!1;t.changed=!1;let e=!1;const i=t._data,s=this._data;for(let t=0;t<s.length;++t)s[t]!==i[t]&&(s[t]=i[t],this._changed[t]=1,e=!0);return!!e&&(this.buffer.changed=!0,this._requestRender(),!0)}_render(){this._renderRequested=!1;for(let t=0;t<this._changed.length;++t)this._changed[t]&&this._renderCell(t),this._changed[t]=0;this.buffer.changed=!1}_renderCell(t){const e=t%this.width,i=Math.floor(t/this.width),s=this._data[t],n=s/(1<<24)>>0,r=s>>12&4095,h=4095&s,o=e*this.tileWidth,a=i*this.tileHeight,l=n%16*this.tileWidth,u=Math.floor(n/16)*this.tileHeight,d=this.glyphs.ctx.getImageData(l,u,this.tileWidth,this.tileHeight);for(let t=0;t<d.width*d.height;++t){const e=d.data[4*t]/255,i=1-e;d.data[4*t+0]=e*(17*((3840&h)>>8))+i*(17*((3840&r)>>8)),d.data[4*t+1]=e*(17*((240&h)>>4))+i*(17*((240&r)>>4)),d.data[4*t+2]=e*(17*(15&h))+i*(17*(15&r)),d.data[4*t+3]=255}this._ctx.putImageData(d,o,a)}}const We="\n#version 300 es\nin uvec2 position;\nin uvec2 uv;\nin uint style;\nout vec2 fsUv;\nflat out uint fsStyle;\nuniform highp uvec2 tileSize;\nuniform uvec2 viewportSize;\nvoid main() {\n\tivec2 positionPx = ivec2(position * tileSize);\n\tvec2 positionNdc = (vec2(positionPx * 2) / vec2(viewportSize))-1.0;\n\tpositionNdc.y *= -1.0;\n\tgl_Position = vec4(positionNdc, 0.0, 1.0);\n\tfsUv = vec2(uv);\n\tfsStyle = style;\n}".trim(),Pe="\n#version 300 es\nprecision highp float;\nin vec2 fsUv;\nflat in uint fsStyle;\nout vec4 fragColor;\nuniform sampler2D font;\nuniform highp uvec2 tileSize;\nvoid main() {\n\tuvec2 fontTiles = uvec2(textureSize(font, 0)) / tileSize;\n\n\tuint glyph = (fsStyle & uint(0xFF000000)) >> 24;\n\tuint glyphX = (glyph & uint(0xF));\n\tuint glyphY = (glyph >> 4);\n\tuvec2 fontPosition = uvec2(glyphX, glyphY);\n\n\tuvec2 fontPx = (tileSize * fontPosition) + uvec2(vec2(tileSize) * fsUv);\n\tvec3 texel = texelFetch(font, ivec2(fontPx), 0).rgb;\n\n\tfloat s = 15.0;\n\tuint fr = (fsStyle & uint(0xF00)) >> 8;\n\tuint fg = (fsStyle & uint(0x0F0)) >> 4;\n\tuint fb = (fsStyle & uint(0x00F)) >> 0;\n\tvec3 fgRgb = vec3(fr, fg, fb) / s;\n  \n\tuint br = (fsStyle & uint(0xF00000)) >> 20;\n\tuint bg = (fsStyle & uint(0x0F0000)) >> 16;\n\tuint bb = (fsStyle & uint(0x00F000)) >> 12;\n\tvec3 bgRgb = vec3(br, bg, bb) / s;\n  \n\tfragColor = vec4(mix(bgRgb, fgRgb, texel), 1.0);\n}".trim();class Be extends Ne{constructor(t,e,i){super(t,e,i)}_createContext(){let t=this.node.getContext("webgl2");if(!t)throw new Re("WebGL 2 not supported");this._gl=t,this._glBuffers={},this._attribs={},this._uniforms={};const e=function(t,...e){const i=t.createProgram();if([t.VERTEX_SHADER,t.FRAGMENT_SHADER].forEach(((s,n)=>{const r=t.createShader(s);if(t.shaderSource(r,e[n]),t.compileShader(r),!t.getShaderParameter(r,t.COMPILE_STATUS))throw new Error(t.getShaderInfoLog(r));t.attachShader(i,r)})),t.linkProgram(i),!t.getProgramParameter(i,t.LINK_STATUS))throw new Error(t.getProgramInfoLog(i));return i}(t,We,Pe);t.useProgram(e);const i=t.getProgramParameter(e,t.ACTIVE_ATTRIBUTES);for(let s=0;s<i;s++){t.enableVertexAttribArray(s);let i=t.getActiveAttrib(e,s);this._attribs[i.name]=s}const s=t.getProgramParameter(e,t.ACTIVE_UNIFORMS);for(let i=0;i<s;i++){let s=t.getActiveUniform(e,i);this._uniforms[s.name]=t.getUniformLocation(e,s.name)}t.uniform1i(this._uniforms.font,0),this._texture=function(t){let e=t.createTexture();return t.bindTexture(t.TEXTURE_2D,e),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),e}(t)}_createGeometry(){const t=this._gl;this._glBuffers.position&&t.deleteBuffer(this._glBuffers.position),this._glBuffers.uv&&t.deleteBuffer(this._glBuffers.uv);let e=function(t,e,i,s){let n=i*s,r=new Uint16Array(n*Ve.length),h=new Uint8Array(n*Ve.length),o=0;for(let t=0;t<s;t++)for(let e=0;e<i;e++)Ve.forEach((i=>{r[o]=(o%2?t:e)+i,h[o]=i,o++}));const a=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,a),t.vertexAttribIPointer(e.position,2,t.UNSIGNED_SHORT,0,0),t.bufferData(t.ARRAY_BUFFER,r,t.STATIC_DRAW);const l=t.createBuffer();return t.bindBuffer(t.ARRAY_BUFFER,l),t.vertexAttribIPointer(e.uv,2,t.UNSIGNED_BYTE,0,0),t.bufferData(t.ARRAY_BUFFER,h,t.STATIC_DRAW),{position:a,uv:l}}(t,this._attribs,this.width,this.height);Object.assign(this._glBuffers,e)}_createData(){const t=this._gl,e=this._attribs,i=this.width*this.height;this._glBuffers.style&&t.deleteBuffer(this._glBuffers.style),this._data=new Uint32Array(6*i);const s=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,s),t.vertexAttribIPointer(e.style,1,t.UNSIGNED_INT,0,0),Object.assign(this._glBuffers,{style:s})}_setGlyphs(t){if(!super._setGlyphs(t))return!1;const e=this._gl,i=this._uniforms;return e.uniform2uiv(i.tileSize,[this.tileWidth,this.tileHeight]),this._uploadGlyphs(),!0}_uploadGlyphs(){if(!this._glyphs.needsUpdate)return;const t=this._gl;t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,this._texture),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,this._glyphs.node),this._requestRender(),this._glyphs.needsUpdate=!1}resize(t,e){super.resize(t,e);const i=this._gl,s=this._uniforms;i.viewport(0,0,this.node.width,this.node.height),i.uniform2ui(s.viewportSize,this.node.width,this.node.height),this._createGeometry(),this._createData()}draw(t){return!t._data.every(((t,e)=>{const i=2+6*e;return t===this._data[i]}))&&(t._data.forEach(((t,e)=>{const i=6*e;for(let e=0;e<6;++e)this._data[i+e]=t})),this._requestRender(),t.changed=!1,!0)}copyTo(t){t.changed=!1;const e=this.width*this.height;for(let i=0;i<e;++i){const e=6*i;t._data[i]=this._data[e+0]}}_render(){const t=this._gl;if(this._glyphs.needsUpdate)this._uploadGlyphs();else if(!this._renderRequested)return;this._renderRequested=!1,t.bindBuffer(t.ARRAY_BUFFER,this._glBuffers.style),t.bufferData(t.ARRAY_BUFFER,this._data,t.DYNAMIC_DRAW),t.drawArrays(t.TRIANGLES,0,this._width*this._height*6),this.buffer.changed=!1}}const Ve=[0,0,1,0,0,1,0,1,1,0,1,1];function He(...t){let e,i,s=t[0],n=t[1],r=t[2];1==t.length&&(r=t[0],n=r.height||34,s=r.width||80),r=r||{font:"monospace"},e=r.image?Oe.fromImage(r.image):Oe.fromFont(r);try{i=new Be(s,n,e)}catch(t){if(!(t instanceof Re))throw t}if(void 0===i&&(i=new De(s,n,e)),r.div){let t;"string"==typeof r.div?(t=document.getElementById(r.div),t||console.warn("Failed to find parent element by ID: "+r.div)):t=r.div,t&&t.appendChild&&t.appendChild(i.node)}return r.loop&&(i.loop=r.loop),(r.io||r.loop)&&(i.onclick=t=>i.loop.enqueue(t),i.onmousemove=t=>i.loop.enqueue(t),i.onmouseup=t=>i.loop.enqueue(t)),i}var Fe=Object.freeze({__proto__:null,Buffer:ke,Glyphs:Oe,NotSupportedError:Re,BaseCanvas:Ne,Canvas2D:De,CanvasGL:Be,make:He});class je{constructor(t,e,i,s=100){t||(t=null),this.ch=t,this.fg=pt(e),this.bg=pt(i),this.opacity=r(s,0,100)}clone(){return new je(this.ch,this.fg,this.bg,this.opacity)}toString(){const t=[];return this.ch&&t.push("ch: "+this.ch),this.fg.isNull()||t.push("fg: "+this.fg.toString(!0)),this.bg.isNull()||t.push("bg: "+this.bg.toString(!0)),100!==this.opacity&&t.push("opacity: "+this.opacity),"{ "+t.join(", ")+" }"}}const Ye={};function Ge(...t){let e,i=null,s=-1,n=-1;if(0==t.length)return new je(null,-1,-1);if(1==t.length&&Array.isArray(t[0])&&(t=t[0]),t.length>3?(e=t[3],t.pop()):2==t.length&&"number"==typeof t[1]&&t[0].length>1&&(e=t.pop()),t.length>1)i=t[0]||null,s=t[1],n=t[2];else if("string"==typeof t[0]&&1==t[0].length)i=t[0],s="white";else if("string"==typeof t[0]&&t[0].length>1||"number"==typeof t[0])n=t[0];else if(t[0]instanceof ut)n=t[0];else{const r=t[0];i=r.ch||null,s=r.fg||-1,n=r.bg||-1,e=r.opacity}return"string"==typeof s?s=pt(s):Array.isArray(s)?s=_t(s):null==s&&(s=-1),"string"==typeof n?n=pt(n):Array.isArray(n)?n=_t(n):null==n&&(n=-1),new je(i,s,n,e)}var Ue=Object.freeze({__proto__:null,Sprite:je,sprites:Ye,make:Ge,from:function(t){if("string"==typeof t){const e=Ye[t];if(!e)throw new Error("Failed to find sprite: "+t);return e}return Ge(t)},install:function(t,...e){let i;return i=Ge(...e),i.name=t,Ye[t]=i,i},Mixer:It,makeMixer:function(t){return new It(t)}}),Xe=Object.freeze({__proto__:null});const Ke={},ze={},qe={};function $e(t,e){const i=St(e);return qe[t]=i,i}ze.message=ze.message||{};const Ze=[];function Je(t,e,i,s){const n=qe[i];n?i=n(s):s&&(i=Ct(i,s)),Ze.forEach((s=>s.addMessage.call(s,t,e,i)))}var Qe=Object.freeze({__proto__:null,templates:qe,install:$e,installAll:function(t){Object.entries(t).forEach((([t,e])=>$e(t,e)))},get:function(t){return qe[t]||null},handlers:Ze,add:function(t,e){return Je(-1,-1,t,e)},addAt:Je,addCombat:function(t,e,i,s){const n=qe[i];n?i=n(s):s&&(i=Ct(i,s)),Ze.forEach((s=>s.addCombatMessage.call(s,t,e,i)))},MessageCache:class{constructor(t={}){this.ARCHIVE=[],this.CONFIRMED=[],this.ARCHIVE_LINES=30,this.MSG_WIDTH=80,this.NEXT_WRITE_INDEX=0,this.NEEDS_UPDATE=!0,this.COMBAT_MESSAGE=null,this.matchFn=t.match||i,this.ARCHIVE_LINES=t.length||30,this.MSG_WIDTH=t.width||80,this.clear(),Ze.push(this)}clear(){for(let t=0;t<this.ARCHIVE_LINES;++t)this.ARCHIVE[t]=null,this.CONFIRMED[t]=!1;this.NEXT_WRITE_INDEX=0,this.NEEDS_UPDATE=!0,this.COMBAT_MESSAGE=null}get needsUpdate(){return this.NEEDS_UPDATE}set needsUpdate(t){this.NEEDS_UPDATE=t}_addMessageLine(t){kt(t)&&(this.ARCHIVE[this.NEXT_WRITE_INDEX]=t,this.CONFIRMED[this.NEXT_WRITE_INDEX]=!1,this.NEXT_WRITE_INDEX=(this.NEXT_WRITE_INDEX+1)%this.ARCHIVE_LINES)}addMessage(t,e,i){!1!==this.matchFn(t,e)&&(this.commitCombatMessage(),this._addMessage(i))}_addMessage(t){var e;const i=Pt(t=Nt(t),this.MSG_WIDTH);(null===(e=ze.message)||void 0===e?void 0:e.reverseMultiLine)&&i.reverse(),i.forEach((t=>this._addMessageLine(t))),this.NEEDS_UPDATE=!0}addCombatMessage(t,e,i){this.matchFn(t,e)&&this._addCombatMessage(i)}_addCombatMessage(t){this.COMBAT_MESSAGE?this.COMBAT_MESSAGE+=", "+Nt(t):this.COMBAT_MESSAGE=t,this.NEEDS_UPDATE=!0}commitCombatMessage(){return!!this.COMBAT_MESSAGE&&(this._addMessage(this.COMBAT_MESSAGE+"."),this.COMBAT_MESSAGE=null,!0)}confirmAll(){for(let t=0;t<this.CONFIRMED.length;t++)this.CONFIRMED[t]=!0;this.NEEDS_UPDATE=!0}forEach(t){this.commitCombatMessage();for(let e=0;e<this.ARCHIVE_LINES;++e){const i=(this.ARCHIVE_LINES-e+this.NEXT_WRITE_INDEX-1)%this.ARCHIVE_LINES,s=this.ARCHIVE[i];if(!s)return;if(!1===t(s,this.CONFIRMED[i],e))return}}get length(){let t=0;return this.forEach((()=>++t)),t}}});class ti{constructor(t={}){this.options={rng:V,rounds:5,minWidth:10,minHeight:10,maxWidth:40,maxHeight:20,percentSeeded:50,birthParameters:"ffffffttt",survivalParameters:"ffffttttt"},Object.assign(this.options,t),this.options.birthParameters=this.options.birthParameters.toLowerCase(),this.options.survivalParameters=this.options.survivalParameters.toLowerCase(),this.options.minWidth>=this.options.maxWidth&&(this.options.minWidth=Math.round(.75*this.options.maxWidth),this.options.maxWidth=Math.round(1.25*this.options.maxWidth)),this.options.minHeight>=this.options.maxHeight&&(this.options.minHeight=Math.round(.75*this.options.maxHeight),this.options.maxHeight=Math.round(1.25*this.options.maxHeight))}carve(t,e,i){let s,n,r,h,o,a,l,u=new p(0,0,0,0);const d=it(t,e),c=Math.floor((d.width-this.options.maxWidth)/2),f=Math.floor((d.height-this.options.maxHeight)/2);let g=10;do{for(d.fill(0),s=0;s<this.options.maxWidth;s++)for(n=0;n<this.options.maxHeight;n++)d[s+c][n+f]=this.options.rng.chance(this.options.percentSeeded)?1:0;for(r=0;r<this.options.rounds;r++)this._cellularAutomataRound(d)||(r=this.options.rounds);for(l=0,a=0,h=2,s=0;s<d.width;s++)for(n=0;n<d.height;n++)1==d[s][n]&&(o=d.floodFill(s,n,1,h),o>l&&(l=o,a=h),h++);d.valueBounds(a,u)}while((u.width<this.options.minWidth||u.height<this.options.minHeight||0==a)&&--g);for(s=0;s<d.width;s++)for(n=0;n<d.height;n++)d[s][n]==a&&i(s,n);return st(d),u}_cellularAutomataRound(t){let e,i,s,n,r,h,o;o=it(t.width,t.height),o.copy(t);let a=!1;for(e=0;e<t.width;e++)for(i=0;i<t.height;i++){for(s=0,h=0;h<c.length;h++)n=e+c[h][0],r=i+c[h][1],t.hasXY(n,r)&&o[n][r]&&s++;o[e][i]||"t"!=this.options.birthParameters[s]?o[e][i]&&"t"==this.options.survivalParameters[s]||(t[e][i]=0,a=!0):(t[e][i]=1,a=!0)}return st(o),a}}var ei=Object.freeze({__proto__:null,Blob:ti,fillBlob:function(t,e={}){return new ti(e).carve(t.width,t.height,((e,i)=>t[e][i]=1))},make:function(t={}){return new ti(t)}});const ii=ze.light={INTENSITY_DARK:20,INTENSITY_SHADOW:50};let si=_t();class ni{constructor(t,e=1,i=0,s=!1){this.fadeTo=0,this.passThroughActors=!1,this.id=null,this.color=pt(t),this.radius=Y(e),this.fadeTo=i,this.passThroughActors=s}copy(t){this.color=t.color,this.radius.copy(t.radius),this.fadeTo=t.fadeTo,this.passThroughActors=t.passThroughActors}get intensity(){return ri(this.color)}paint(t,e,i,s=!1,n=!1){if(!t)return!1;let r,h=0,o=this.radius.value(),a=Math.ceil(o);if(a<1)return!1;si=this.color.bake();const l=!n&&!s&&!hi(si),u=this.fadeTo,d=it(t.width,t.height,0);t.calcFov(e,i,a,this.passThroughActors,((t,e)=>{d[t][e]=1}));const c=[0,0,0];return d.forCircle(e,i,a,((s,n,a)=>{if(s){for(h=Math.floor(100-(100-u)*(m(e,i,n,a)/o)),r=0;r<3;++r)c[r]=Math.floor(si._data[r]*h/100);t.addCellLight(n,a,c,l)}})),st(d),!0}}function ri(t){let e=t;return t instanceof ut&&(e=t._data),Math.max(e[0],e[1],e[2])}function hi(t,e=20){return ri(t)<=e}function oi(t,e=40){return ri(t)<=e}function ai(...t){if(1==t.length){const e=t[0];if("string"==typeof e){const t=li[e];if(t)return t;const[i,s,n,r]=e.split(/[,|]/).map((t=>t.trim()));return new ni(pt(i),G(s||1),Number.parseInt(n||"0"),!!r&&"false"!==r)}if(Array.isArray(e)){const[t,i,s,n]=e;return new ni(t,i,s,n)}if(e&&e.color)return new ni(pt(e.color),G(e.radius),Number.parseInt(e.fadeTo||"0"),e.pass);throw new Error("Unknown Light config - "+e)}{const[e,i,s,n]=t;return new ni(e,i,s,n)}}const li={};function ui(...t){1!=t.length&&h("Unknown Light config: "+JSON.stringify(t));const e=t[0];if("string"==typeof e){const t=li[e];if(t)return t}return e&&e.paint?e:ai(e)}function di(t,...e){let i;return i=1==e.length?ai(e[0]):ai(e[0],e[1],e[2],e[3]),li[t]=i,i.id=t,i}var ci;!function(t){t[t.LIT=X(0)]="LIT",t[t.IN_SHADOW=X(1)]="IN_SHADOW",t[t.DARK=X(2)]="DARK",t[t.CHANGED=X(4)]="CHANGED"}(ci||(ci={}));var fi=Object.freeze({__proto__:null,config:ii,Light:ni,intensity:ri,isDarkLight:hi,isShadowLight:oi,make:ai,lights:li,from:ui,install:di,installAll:function(t){Object.entries(t).forEach((([t,e])=>{di(t,e)}))},LightSystem:class{constructor(t,e={}){this.staticLights=null,this.site=t,this.ambient=pt(e.ambient||"white").toLight(),this.changed=!1,this.glowLightChanged=!1,this.dynamicLightChanged=!1,this.light=nt(t.width,t.height,(()=>this.ambient.slice())),this.glowLight=nt(t.width,t.height,(()=>this.ambient.slice())),this.oldLight=nt(t.width,t.height,(()=>this.ambient.slice())),this.flags=nt(t.width,t.height),this.finishLightUpdate()}copy(t){this.setAmbient(t.ambient),this.glowLightChanged=!0,this.dynamicLightChanged=!0,this.changed=!0,this.staticLights=null,C(t.staticLights,(t=>this.addStatic(t.x,t.y,t.light)))}getAmbient(){return this.ambient}setAmbient(t){t instanceof ut?t=t.toLight():Array.isArray(t)||(t=pt(t).toLight());for(let e=0;e<3;++e)this.ambient[e]=t[e];this.glowLightChanged=!0}get needsUpdate(){return this.glowLightChanged||this.dynamicLightChanged}getLight(t,e){return this.light[t][e]}setLight(t,e,i){const s=this.light[t][e];for(let t=0;t<3;++t)s[t]=i[t]}isLit(t,e){return!!(this.flags[t][e]&ci.LIT)}isDark(t,e){return!!(this.flags[t][e]&ci.DARK)}isInShadow(t,e){return!!(this.flags[t][e]&ci.IN_SHADOW)}lightChanged(t,e){return!!(this.flags[t][e]&ci.CHANGED)}get width(){return this.site.width}get height(){return this.site.height}addStatic(t,e,i){const s={x:t,y:e,light:ui(i),next:this.staticLights};return this.staticLights=s,this.glowLightChanged=!0,s}removeStatic(t,e,i){let s=this.staticLights;if(!s)return;function n(s){return s.x==t&&s.y==e&&(!i||i===s.light)}for(this.glowLightChanged=!0;s&&n(s);)s=this.staticLights=s.next;if(!s)return;let r=s.next;for(;r;)n(r)?s.next=r.next:s=r,r=r.next}eachStaticLight(t){C(this.staticLights,(e=>t(e.x,e.y,e.light))),this.site.eachGlowLight(((e,i,s)=>{t(e,i,s)}))}eachDynamicLight(t){this.site.eachDynamicLight(t)}update(t=!1){if(this.changed=!1,!t&&!this.needsUpdate)return!1;this.startLightUpdate(),this.glowLightChanged?(this.eachStaticLight(((t,e,i)=>{i.paint(this,t,e)})),this.recordGlowLights(),this.glowLightChanged=!1):this.restoreGlowLights(),this.eachDynamicLight(((t,e,i)=>i.paint(this,t,e))),this.finishLightUpdate();const e=Ke.player;if(e){const t=li.PLAYERS_LIGHT;t&&t.paint(this,e.x,e.y,!0,!0)}return this.dynamicLightChanged=!1,this.changed=!0,!0}startLightUpdate(){let t=0;const e=oi(this.ambient)?ci.IN_SHADOW:0;this.light.forEach(((i,s,n)=>{for(t=0;t<3;++t)this.oldLight[s][n][t]=i[t],i[t]=this.ambient[t];this.flags[s][n]=e}))}finishLightUpdate(){I(this.width,this.height,((t,e)=>{const i=this.oldLight[t][e],s=this.light[t][e];s.some(((t,e)=>t!==i[e]))&&(this.flags[t][e]|=ci.CHANGED),hi(s)?this.flags[t][e]|=ci.DARK:oi(s)||(this.flags[t][e]|=ci.LIT)}))}recordGlowLights(){let t=0;this.light.forEach(((e,i,s)=>{const n=this.glowLight[i][s];for(t=0;t<3;++t)n[t]=e[t]}))}restoreGlowLights(){let t=0;this.light.forEach(((e,i,s)=>{const n=this.glowLight[i][s];for(t=0;t<3;++t)e[t]=n[t]}))}calcFov(t,e,i,s,n){const r=this.site;new _e({isBlocked:(t,e)=>!(!s&&r.hasActor(t,e))&&r.blocksVision(t,e),hasXY:(t,e)=>r.hasXY(t,e)}).calculate(t,e,i,n)}addCellLight(t,e,i,s){const n=this.light[t][e];for(let t=0;t<3;++t)n[t]+=i[t];s&&!oi(i)&&(this.flags[t][e]&=~ci.IN_SHADOW)}}});class gi{constructor(t){this._repeat=0,this._count=0,this._from=!1,this._duration=0,this._delay=0,this._repeatDelay=-1,this._yoyo=!1,this._time=Number.MAX_SAFE_INTEGER,this._startTime=0,this._goal={},this._start={},this._startCb=null,this._updateCb=null,this._repeatCb=null,this._finishCb=null,this._resolveCb=null,this._easing=pi,this._interpolate=bi,this._obj=t}isRunning(){return this._time<this._duration}onStart(t){return this._startCb=t,this}onUpdate(t){return this._updateCb=t,this}onRepeat(t){return this._repeatCb=t,this}onFinish(t){return this._finishCb=t,this}to(t,e){return this._goal=t,this._from=!1,void 0!==e&&(this._duration=e),this}from(t,e){return this._start=t,this._from=!0,void 0!==e&&(this._duration=e),this}duration(t){return void 0===t?this._duration:(this._duration=t,this)}repeat(t){return void 0===t?this._repeat:(this._repeat=t,this)}delay(t){return void 0===t?this._delay:(this._delay=t,this)}repeatDelay(t){return void 0===t?this._repeatDelay:(this._repeatDelay=t,this)}yoyo(t){return void 0===t?this._yoyo:(this._yoyo=t,this)}start(){this._time=0,this._startTime=this._delay,this._count=0,this._from?(this._goal={},Object.keys(this._start).forEach((t=>this._goal[t]=this._obj[t])),this._updateProperties(this._obj,this._start,this._goal,0)):(this._start={},Object.keys(this._goal).forEach((t=>this._start[t]=this._obj[t])));let t=new Promise((t=>{this._resolveCb=t}));if(this._finishCb){const e=this._finishCb;t=t.then((t=>e.call(this,this._obj,!!t)))}return t}tick(t){if(!this.isRunning())return!1;if(this._time+=t,this._startTime){if(this._startTime>this._time)return!0;this._time-=this._startTime,this._startTime=0,this._count>0&&this._restart()}0===this._count&&this._restart();const e=this._easing(this._time/this._duration);return this._updateProperties(this._obj,this._start,this._goal,e)&&this._updateCb&&this._updateCb.call(this,this._obj,e),this._time>=this._duration&&(this._repeat>this._count?(this._time-=this._duration,this._startTime=this._repeatDelay>-1?this._repeatDelay:this._delay,this._yoyo&&([this._start,this._goal]=[this._goal,this._start]),this._startTime||this._restart()):this.stop(!0)),!0}_restart(){++this._count,Object.entries(this._start).forEach((([t,e])=>{this._obj[t]=e})),1==this._count?this._startCb&&this._startCb.call(this,this._obj,0):this._repeatCb?this._repeatCb.call(this,this._obj,this._count):this._updateCb&&this._updateCb.call(this,this._obj,0)}stop(t=!1){this._time=Number.MAX_SAFE_INTEGER,this._resolveCb&&this._resolveCb(t)}_updateProperties(t,e,i,s){let n=!1;return Object.entries(i).forEach((([i,r])=>{const h=t[i],o=e[i],a=this._interpolate(o,r,s);a!==h&&(t[i]=a,n=!0)})),n}}function _i(t){return new gi(t)}function pi(t){return r(t,0,1)}function bi(t,e,i){return"boolean"==typeof t||"boolean"==typeof e?0==Math.floor(i)?t:e:Math.floor((e-t)*i)+t}var mi=Object.freeze({__proto__:null,Tween:gi,make:_i,linear:pi,interpolate:bi});class yi{constructor(t){this._left=0,this._top=0,this._colWidths=[],this._rowHeights=[],this._col=0,this._row=-1,this.target=t;const e=t.pos();this._left=e.x,this._top=e.y}cols(...t){return 0===t.length?this._colWidths:(2==t.length&&(t[0]=new Array(t[0]).fill(t[1])),Array.isArray(t[0])&&(this._colWidths=t[0]),this)}rows(...t){return 0===t.length?this._rowHeights:("number"==typeof t[0]&&(t[0]=new Array(t[0]).fill(t[1]||1)),Array.isArray(t[0])&&(this._rowHeights=t[0]),this)}col(t){return void 0===t&&(t=this._col),this._col=r(t,0,this._colWidths.length-1),this._setPos()}nextCol(){return this.col(this._col+1)}row(t){return void 0===t&&(t=this._row),this._row=r(t,0,this._rowHeights.length-1),this._setPos()}nextRow(){return this.row(this._row+1).col(0)}endRow(t){return t<=0||(this._rowHeights[this._row]=t),this}_setPos(){let t=this._left;for(let e=0;e<this._col;++e)t+=this._colWidths[e];let e=this._top;for(let t=0;t<this._row;++t)e+=this._rowHeights[t];return this.target.pos(t,e),this}}class wi{constructor(t){this.priority=0,(t.startsWith(":")||t.startsWith("."))&&(t="*"+t),this.text=t,this.matchFn=this._parse(t)}_parse(t){const e=t.split(/ +/g).map((t=>t.trim())),s=[];for(let t=0;t<e.length;++t){let i=e[t];">"===i?(s.push(this._parentMatch()),++t,i=e[t]):t>0&&s.push(this._ancestorMatch()),s.push(this._matchElement(i))}return s.reduce(((t,e)=>e.bind(void 0,t)),i)}_parentMatch(){return function(t,e){return!!e.parent&&t(e.parent)}}_ancestorMatch(){return function(t,e){let i=e.parent;for(;i;)if(t(i))return!0;return!1}}_matchElement(t){const e=[],i=new RegExp(/(?:(\w+|\*|\$)|#(\w+)|\.([^\.: ]+))|(?::(?:(?:not\(\.([^\)]+)\))|(?:not\(:([^\)]+)\))|([^\.: ]+)))/g,"g");let s=i.exec(t);for(;s;){if(s[1]){const t=this._matchTag(s[1]);t&&e.push(t)}else s[2]?e.push(this._matchId(s[2])):s[3]?e.push(this._matchClass(s[3])):s[4]?e.push(this._matchNot(this._matchClass(s[4]))):s[5]?e.push(this._matchNot(this._matchProp(s[5]))):e.push(this._matchProp(s[6]));s=i.exec(t)}return(t,i)=>!!e.every((t=>t(i)))&&t(i)}_matchTag(t){return"*"===t?null:"$"===t?(this.priority+=1e4,null):(this.priority+=10,e=>e.tag===t)}_matchClass(t){return this.priority+=100,e=>e.classes.includes(t)}_matchProp(t){return t.startsWith("first")?this._matchFirst():t.startsWith("last")?this._matchLast():"invalid"===t?this._matchNot(this._matchProp("valid")):"optional"===t?this._matchNot(this._matchProp("required")):"enabled"===t?this._matchNot(this._matchProp("disabled")):"unchecked"===t?this._matchNot(this._matchProp("checked")):(this.priority+=1,e=>!!e.prop(t))}_matchId(t){return this.priority+=1e3,e=>e.attr("id")===t}_matchFirst(){return this.priority+=1,t=>!!t.parent&&!!t.parent.children&&t.parent.children[0]===t}_matchLast(){return this.priority+=1,t=>!!t.parent&&(!!t.parent.children&&t.parent.children[t.parent.children.length-1]===t)}_matchNot(t){return e=>!t(e)}matches(t){return this.matchFn(t)}}class Ei{constructor(t="$",e){this._dirty=!1,this.selector=new wi(t),e&&this.set(e),this._dirty=!1}get dirty(){return this._dirty}set dirty(t){this._dirty=t}get fg(){return this._fg}get bg(){return this._bg}dim(t=25,e=!0,i=!1){return e&&(this._fg=pt(this._fg).darken(t)),i&&(this._bg=pt(this._bg).darken(t)),this}bright(t=25,e=!0,i=!1){return e&&(this._fg=pt(this._fg).lighten(t)),i&&(this._bg=pt(this._bg).lighten(t)),this}invert(){return[this._fg,this._bg]=[this._bg,this._fg],this}get align(){return this._align}get valign(){return this._valign}get(t){return this["_"+t]}set(t,e,i=!0){if("string"==typeof t){const i="_"+t;"string"==typeof e&&(e.match(/^[+-]?\d+$/)?e=Number.parseInt(e):"true"===e?e=!0:"false"===e&&(e=!1)),this[i]=e}else t instanceof Ei?(i=!(!e&&void 0!==e),Object.entries(t).forEach((([t,e])=>{"selector"!==t&&"_dirty"!==t&&(null!=e?this[t]=e:null===e&&this.unset(t))}))):(i=!(!e&&void 0!==e),Object.entries(t).forEach((([t,e])=>{null===e?this.unset(t):this.set(t,e,i)})));return this.dirty||(this.dirty=i),this}unset(t){return delete this[t.startsWith("_")?t:"_"+t],this.dirty=!0,this}clone(){const t=new this.constructor;return t.copy(this),t}copy(t){return Object.assign(this,t),this}}class xi extends Ei{constructor(t,e=100){super(),this.sources=[],this._opacity=100,this._baseFg=null,this._baseBg=null,t&&(t.sort(((t,e)=>t.selector.priority-e.selector.priority)),this.sources=t),this.sources.forEach((t=>super.set(t))),this.opacity=e,this._dirty=!1}get opacity(){return this._opacity}set opacity(t){if(t=r(t,0,100),this._opacity=t,100===t)return this._fg=this._baseFg||this._fg,void(this._bg=this._baseBg||this._bg);void 0!==this._fg&&(this._baseFg=this._baseFg||pt(this._fg),this._fg=this._baseFg.alpha(t)),void 0!==this._bg&&(this._baseBg=this._baseBg||pt(this._bg),this._bg=this._baseBg.alpha(t))}get dirty(){return this._dirty||this.sources.some((t=>t.dirty))}set dirty(t){this._dirty=t}}class vi{constructor(t){this.rules=[],this._dirty=!0,void 0===t&&(t=Ii),t&&(this.rules=t.rules.slice())}get dirty(){return this._dirty}set dirty(t){this._dirty=t,this._dirty||this.rules.forEach((t=>t.dirty=!1))}add(t,e){if(t.includes(","))return t.split(",").map((t=>t.trim())).forEach((t=>this.add(t,e))),this;if(t.includes(" "))throw new Error("Hierarchical selectors not supported.");let i=new Ei(t,e);const s=this.rules.findIndex((t=>t.selector.text===i.selector.text));if(s>-1){const t=this.rules[s];t.set(i),i=t}else this.rules.push(i);return this.dirty=!0,this}get(t){return this.rules.find((e=>e.selector.text===t))||null}remove(t){const e=this.rules.findIndex((e=>e.selector.text===t));e>-1&&(this.rules.splice(e,1),this.dirty=!0)}computeFor(t){const e=this.rules.filter((e=>e.selector.matches(t))),i=t.style();return i&&e.push(i),i.dirty=!1,new xi(e,t.opacity)}}const Ii=new vi(null);class Ai{constructor(t,e={}){this.needsDraw=!0,this.ui=t,this.buffer=t.canvas.pushBuffer(),this.io=new oe(t.loop),t.pushLayer(this)}get width(){return this.buffer.width}get height(){return this.buffer.height}mousemove(t){return!1}click(t){return!1}keypress(t){return!1}dir(t){return!1}tick(t){return!1}draw(){this.buffer.changed&&(console.log("draw"),this.buffer.render())}setTimeout(t,e){return this.io.setTimeout(t,e)}clearTimeout(t){this.io.clearTimeout(t)}addAnimation(t){this.io.addAnimation(t)}removeAnimation(t){this.io.removeAnimation(t)}run(t={},e=-1){return["keypress","dir","click","mousemove","tick","draw"].forEach((e=>{e in t||(t[e]=this[e])})),this.io.run(t,e,this)}finish(t){this.io.finish(t),this.ui.canvas.popBuffer(),this.ui.popLayer(this)}}class Ti{constructor(t={}){this.layers=[],t.loop=t.loop||ue,this.loop=t.loop,this.canvas=t.canvas||He(t),this.buffer=this.canvas.buffer,this.canvas.node&&this.canvas.node.parentElement&&(this.canvas.node.parentElement.onkeydown=this.loop.onkeydown.bind(this.loop),this.canvas.node.parentElement.tabIndex=1),!1!==t.layer&&(this._layer=new Ai(this))}get width(){return this.canvas.width}get height(){return this.canvas.height}finish(){this._layer&&this._layer.finish()}get layer(){return this._layer}pushLayer(t){this.layers.push(t),this._layer=t}popLayer(t){t!==this.layers[0]&&(l(this.layers,t),t===this._layer&&(this._layer=this.layers[this.layers.length-1],this._layer.needsDraw=!0))}alert(...t){return Promise.resolve(!0)}confirm(...t){return Promise.resolve(!0)}inputbox(...t){return Promise.resolve(null)}}Ii.add("*",{fg:"white",bg:-1,align:"left",valign:"top"});class Si{constructor(t,e={}){this.tag="text",this.bounds=new p(0,0,0,1),this._depth=0,this.events={},this.children=[],this._style=new Ei,this._parent=null,this.classes=[],this._props={},this._attrs={},this.layer=t,this.bounds.x=e.x||0,this.bounds.y=e.y||0,this.bounds.width=e.width||0,this.bounds.height=e.height||1,e.tag&&(this.tag=e.tag),e.id&&(this.attr("id",e.id),this.attr("action",e.id)),void 0!==e.depth&&(this._depth=e.depth),this._style.set(e),e.class&&(this.classes=e.class.split(/ +/g).map((t=>t.trim()))),e.tabStop&&this.prop("tabStop",!0),e.action,e.disabled&&this.prop("disabled",!0),e.hidden&&this.prop("hidden",!0),e.action&&this.attr("action",e.action),this.attr("action")&&this.on("click",((t,e,i)=>{const s=this._attrStr("action");return s&&this._bubbleEvent(s,e,i),!1})),this.layer.attach(this),this.updateStyle(),void 0!==e.opacity&&(this._used.opacity=e.opacity)}get depth(){return this._depth}set depth(t){this._depth=t,this.layer.sortWidgets()}get parent(){return this._parent}set parent(t){this.setParent(t)}setParent(t,e={}){this._parent&&this._parent._removeChild(this),this._parent=t,this._parent&&(this.depth=this._depth||this._parent.depth+1,this._parent._addChild(this,e))}pos(t,e){return void 0===t?this.bounds:("number"==typeof t?(this.bounds.x=t,this.bounds.y=e||0):(this.bounds.x=t.x,this.bounds.y=t.y),this.layer.needsDraw=!0,this)}center(t){return this.centerX(t).centerY(t)}centerX(t){t=t||this.layer.body.bounds;const e=this.bounds.width,i=Math.round((t.width-e)/2);return this.bounds.x=t.x+i,this}centerY(t){t=t||this.layer.body.bounds;const e=this.bounds.height,i=Math.round((t.height-e)/2);return this.bounds.y=t.y+i,this}text(t){return void 0===t?this._attrStr("text"):(this.attr("text",t),this)}attr(t,e){return void 0===e?this._attrs[t]:(this._attrs[t]=e,this)}_attrInt(t){const e=this._attrs[t]||0;return"number"==typeof e?e:"string"==typeof e?Number.parseInt(e):e?1:0}_attrStr(t){const e=this._attrs[t]||"";return"string"==typeof e?e:"number"==typeof e?""+e:e?"true":"false"}_attrBool(t){return!!this._attrs[t]}prop(t,e){if(void 0===e)return this._props[t];return this._props[t]!==e&&this._setProp(t,e),this}_setProp(t,e){this._props[t]=e,this.updateStyle()}_propInt(t){const e=this._props[t]||0;return"number"==typeof e?e:"string"==typeof e?Number.parseInt(e):e?1:0}_propStr(t){const e=this._props[t]||"";return"string"==typeof e?e:"number"==typeof e?""+e:e?"true":"false"}_propBool(t){return!!this._props[t]}toggleProp(t){const e=!!this._props[t];return this.prop(t,!e),this}incProp(t,e=1){let i=this.prop(t)||0;return"boolean"==typeof i?i=i?1:0:"string"==typeof i&&(i=Number.parseInt(i)||0),i+=e,this.prop(t,i),this}contains(...t){return this.bounds.contains(t[0],t[1])}style(t){return void 0===t?this._style:(this._style.set(t),this.updateStyle(),this)}addClass(t){return t.split(/ +/g).forEach((t=>{this.classes.includes(t)||this.classes.push(t)})),this}removeClass(t){return t.split(/ +/g).forEach((t=>{l(this.classes,t)})),this}hasClass(t){const e=t.split(/ +/g);return a(this.classes,e)}toggleClass(t){return t.split(/ +/g).forEach((t=>{this.classes.includes(t)?l(this.classes,t):this.classes.push(t)})),this}get focused(){return!!this.prop("focus")}focus(t=!1){return!!this.prop("focus")||(this.prop("focus",!0),this._fireEvent("focus",this,{reverse:t}))}blur(t=!1){return!!this.prop("focus")&&(this.prop("focus",!1),this._fireEvent("blur",this,{reverse:t}))}get hovered(){return!!this.prop("hover")}set hovered(t){this.prop("hover",t)}get hidden(){let t=this;for(;t;){if(t.prop("hidden"))return!0;t=t.parent}return!1}set hidden(t){this.prop("hidden",t),t||0!=this._used.opacity||(this._used.opacity=100)}get opacity(){let t=100,e=this;for(;e;)e._used&&(t=Math.min(t,e._used.opacity)),e=e.parent;return t}set opacity(t){t!==this._used.opacity&&(this._used.opacity=t,this.hidden=0==this._used.opacity,this.layer.needsDraw=!0)}updateStyle(){this._used=this.layer.styles.computeFor(this),this.layer.needsDraw=!0}draw(t){return!this.hidden&&this._draw(t)}fadeIn(t){return this.fadeTo(100,t)}fadeOut(t){return this.fadeTo(0,t)}fadeTo(t,e){const i=_i({pct:this._used.opacity}).to({pct:t}).duration(e).onUpdate((t=>{this.opacity=t.pct}));return this.layer.addAnimation(i),this}fadeToggle(t){return this.fadeTo(this._used.opacity?0:100,t)}slideIn(t,e,i,s){let n={x:t,y:e};return"left"===i?n.x=-this.bounds.width:"right"===i?n.x=this.layer.width+this.bounds.width:"top"===i?n.y=-this.bounds.height:"bottom"===i&&(n.y=this.layer.height+this.bounds.height),this.slide(n,{x:t,y:e},s)}slideOut(t,e){let i={x:this.bounds.x,y:this.bounds.y};return"left"===t?i.x=-this.bounds.width:"right"===t?i.x=this.layer.width+this.bounds.width:"top"===t?i.y=-this.bounds.height:"bottom"===t&&(i.y=this.layer.height+this.bounds.height),this.slide(this.bounds,i,e)}slide(t,e,i){const s=_i({x:g(t),y:_(t)}).to({x:g(e),y:_(e)}).duration(i).onUpdate((t=>{this.pos(t.x,t.y)}));return this.layer.addAnimation(s),this}_draw(t){return this._drawFill(t),!0}_drawFill(t){t.fillRect(this.bounds.x,this.bounds.y,this.bounds.width,this.bounds.height," ",this._used.bg,this._used.bg)}childAt(...t){return this.children.find((e=>e.contains(t[0],t[1])))||null}_addChild(t,e){let i=-1;if(e&&void 0!==e.beforeIndex&&(i=e.beforeIndex),t._parent&&t._parent!==this)throw new Error("Trying to add child that already has a parent.");return this.children.includes(t)||(i<0||i>=this.children.length?this.children.push(t):this.children.splice(i,0,t)),t._parent=this,this}_removeChild(t){if(!t._parent||t._parent!==this)throw new Error("Removing child that does not have this widget as parent.");return t._parent=null,l(this.children,t),this}resize(t,e){return this.bounds.width=t||this.bounds.width,this.bounds.height=e||this.bounds.height,this.layer.needsDraw=!0,this}mouseenter(t,e){this.contains(t)&&(this.hovered||(this.hovered=!0,this._fireEvent("mouseenter",this,t),this._parent&&this._parent.mouseenter(t,e)))}mousemove(t){return!this.contains(t)||t.defaultPrevented||this.hidden?this.mouseleave(t):this._fireEvent("mousemove",this,t),!1}mouseleave(t){this.contains(t)||this.hovered&&(this.hovered=!1,this._fireEvent("mouseleave",this,t))}click(t){return!this.hidden&&this._fireEvent("click",this,t)}keypress(t){return this._fireEvent("keypress",this,t)}dir(t){return this._fireEvent("dir",this,t)}tick(t){return this._fireEvent("tick",this,t)}on(t,e){let i=this.events[t];return i||(i=this.events[t]=[]),i.includes(e)||i.push(e),this}off(t,e){let i=this.events[t];return i?(e?l(i,e):i.length=0,this):this}_fireEvent(t,e,i){const s=this.events[t]||[];let n=!1;for(let r of s)!0===r(t,e||this,i)&&(n=!0);return n}_bubbleEvent(t,e,i){let s=this;for(;s;){if(s._fireEvent(t,e,i))return!0;s=s.parent}return!1}}class Ci extends Si{constructor(t){super(t,{tag:"body",id:"BODY",depth:-1,width:t.width,height:t.height})}_drawFill(t){t.blend(this._used.bg)}}class Li extends Ai{constructor(t,e={}){super(t,e),this._attachOrder=[],this._depthOrder=[],this._focusWidget=null,this._hasTabStop=!1,this._opts={x:0,y:0},this.styles=new vi(e.styles||Ii),this.body=new Ci(this)}reset(){return this._opts={x:0,y:0},this}fg(t){return this._opts.fg=t,this}bg(t){return this._opts.bg=t,this}dim(t=25,e=!0,i=!1){return e&&(this._opts.fg=pt(this._opts.fg||"white").darken(t)),i&&(this._opts.bg=pt(this._opts.bg||"black").darken(t)),this}bright(t=25,e=!0,i=!1){return e&&(this._opts.fg=pt(this._opts.fg||"white").lighten(t)),i&&(this._opts.bg=pt(this._opts.bg||"black").lighten(t)),this}invert(){return[this._opts.fg,this._opts.bg]=[this._opts.bg,this._opts.fg],this}style(t){return Object.assign(this._opts,t),this}class(t){return this._opts.class=this._opts.class||"",this._opts.class+=" "+t,this}pos(t,e){return void 0===t?this._opts:(this._opts.x=r(t,0,this.width),this._opts.y=r(e,0,this.height),this)}moveTo(t,e){return this.pos(t,e)}move(t,e){return this._opts.x=r(this._opts.x+t,0,this.width),this._opts.y=r(this._opts.y+e,0,this.height),this}up(t=1){return this.move(0,-t)}down(t=1){return this.move(0,t)}left(t=1){return this.move(-t,0)}right(t=1){return this.move(t,0)}nextLine(t=1){return this.pos(0,this._opts.y+t)}prevLine(t=1){return this.pos(0,this._opts.y-t)}grid(){return new yi(this)}clear(t){return this.body.children=[],this._depthOrder=[this.body],t?this.body.style().set("bg",t):this.body.style().unset("bg"),this}sortWidgets(){return this._depthOrder.sort(((t,e)=>e.depth-t.depth)),this}attach(t){if(!this._attachOrder.includes(t)){const e=this._depthOrder.findIndex((e=>e.depth<=t.depth));e<0?this._depthOrder.push(t):this._depthOrder.splice(e,0,t),this._attachOrder.push(t),this.needsDraw=!0}return!t.parent&&t!==this.body&&this.body&&(t.setParent(this.body),this.needsDraw=!0),this._hasTabStop=this._hasTabStop||t._propBool("tabStop"),this}detach(t){return t.setParent(null),l(this._depthOrder,t),l(this._attachOrder,t),this._focusWidget===t&&this.nextTabStop(),this.needsDraw=!0,this}widgetAt(...t){return this._depthOrder.find((e=>e.contains(t[0],t[1])&&!e.hidden))||this.body}get focusWidget(){return this._focusWidget}setFocusWidget(t,e=!1){t!==this._focusWidget&&(this._focusWidget&&this._focusWidget.blur(e)||t&&t.focus(e)||(this._focusWidget=t))}getWidget(t){return this._depthOrder.find((e=>e.attr("id")===t))||null}nextTabStop(){if(!this.focusWidget)return this.setFocusWidget(this._attachOrder.find((t=>!!t.prop("tabStop")&&!t.prop("disabled")&&!t.hidden))||null),!!this.focusWidget;const t=u(this._attachOrder,this.focusWidget,(t=>!!t.prop("tabStop")&&!t.prop("disabled")&&!t.hidden));return!!t&&(this.setFocusWidget(t),!0)}prevTabStop(){if(!this.focusWidget)return this.setFocusWidget(this._attachOrder.find((t=>!!t.prop("tabStop")&&!t.prop("disabled")&&!t.hidden))||null),!!this.focusWidget;const t=d(this._attachOrder,this.focusWidget,(t=>!!t.prop("tabStop")&&!t.prop("disabled")&&!t.hidden));return!!t&&(this.setFocusWidget(t,!0),!0)}on(t,e){return this.body.on(t,e),this}off(t,e){return this.body.off(t,e),this}mousemove(t){const e=this.widgetAt(t);return e.mouseenter(t,e),this._depthOrder.forEach((e=>e.mousemove(t))),!1}click(t){let e=this.widgetAt(t),i=!1;for(;e;){if(i||!e.prop("tabStop")||e.prop("disabled")||(this.setFocusWidget(e),i=!0),e.click(t))return!1;e=e.parent}return!1}keypress(t){if(!t.key)return!1;let e=this.focusWidget||this.body;for(;e;){if(e.keypress(t))return!1;e=e.parent}return t.defaultPrevented||("Tab"===t.key?this.nextTabStop():"TAB"===t.key&&this.prevTabStop()),!1}dir(t){let e=this.focusWidget||this.body;for(;e;){if(e.dir(t))return!1;e=e.parent}return!1}tick(t){super.tick(t);for(let e of this._depthOrder)e.tick(t);return!1}draw(){if(this._hasTabStop&&!this._focusWidget&&this.nextTabStop(),this.styles.dirty&&(this.needsDraw=!0,this._depthOrder.forEach((t=>t.updateStyle())),this.styles.dirty=!1),this.needsDraw){this.needsDraw=!1,this.buffer.reset();for(let t=this._depthOrder.length-1;t>=0;--t){this._depthOrder[t].draw(this.buffer)}console.log("draw"),this.buffer.render()}}finish(t){super.finish(t),this.body._fireEvent("finish",this.body,t)}}Ti.prototype.alert=function(...t){let e,i={},s={};"number"==typeof t[0]?(i.duration=t[0],e=t[1],s=t[2]):"string"==typeof t[0]?(e=t[0],s=t[1]):(i=t[0],e=t[1],s=t[2]),s&&(e=Ct(e,s)),i.class=i.class||"alert",i.border=i.border||"ascii",i.pad=i.pad||1;const n=new Li(this),r=void 0!==i.opacity?i.opacity:50;n.body.style().set("bg",Et.alpha(r));const h=n.text(e,{id:"TEXT",class:i.textClass||i.class,width:i.width,height:i.height}).center();Object.assign(i,{width:h.bounds.width,height:h.bounds.height,x:h.bounds.x,y:h.bounds.y,id:"DIALOG"});const o=n.dialog(i);return h.setParent(o),n.on("click",(()=>(n.finish(!0),!0))),n.on("keypress",(()=>(n.finish(!0),!0))),n.setTimeout((()=>{n.finish(!1)}),i.duration||3e3),n.run()},Ti.prototype.confirm=function(...t){let e,i={},s={};"string"==typeof t[0]?(e=t[0],s=t[1]):(i=t[0],e=t[1],s=t[2]),s&&(e=Ct(e,s)),i.class=i.class||"confirm",i.border=i.border||"ascii",i.pad=i.pad||1;const n=new Li(this),r=void 0!==i.opacity?i.opacity:50;n.body.style().set("bg",Et.alpha(r)),void 0===i.cancel||!0===i.cancel?i.cancel="Cancel":i.cancel||(i.cancel=""),i.ok=i.ok||"Ok";let h=i.buttonWidth||0;h||(h=Math.max(i.ok.length,i.cancel.length));const o=Math.max(i.width||0,2*h+2),a=n.text(e,{class:i.textClass||i.class,width:o,height:i.height}).center();Object.assign(i,{width:a.bounds.width,height:a.bounds.height+2,x:a.bounds.x,y:a.bounds.y,tag:"confirm"});const l=n.dialog(i);return a.setParent(l),n.button(i.ok,{class:i.okClass||i.class,width:h,id:"OK",parent:l,x:l._innerLeft+l._innerWidth-h,y:l._innerTop+l._innerHeight-1}).on("click",(()=>(n.finish(!0),!0))),i.cancel.length&&n.button(i.cancel,{class:i.cancelClass||i.class,width:h,id:"CANCEL",parent:l,x:l._innerLeft,y:l._innerTop+l._innerHeight-1}).on("click",(()=>(n.finish(!1),!0))),n.on("keypress",((t,e,i)=>("Escape"===i.key?n.finish(!1):"Enter"===i.key&&n.finish(!0),!0))),n.run()};class Mi extends Si{constructor(t,e){super(t,e),this._text="",this._lines=[],this._fixedWidth=!1,this._fixedHeight=!1,this._fixedHeight=!!e.height,this._fixedWidth=!!e.width,this.bounds.width=e.width||0,this.bounds.height=e.height||1,this.text(e.text)}text(t){if(void 0===t)return this._text;this._text=t;let e=this._fixedWidth?this.bounds.width:100;return this._lines=Pt(this._text,e),this._fixedWidth||(this.bounds.width=this._lines.reduce(((t,e)=>Math.max(t,kt(e))),0)),this._fixedHeight?this._lines.length>this.bounds.height&&(this._lines.length=this.bounds.height):this.bounds.height=Math.max(1,this._lines.length),this.layer.needsDraw=!0,this}resize(t,e){return super.resize(t,e),this._fixedWidth=t>0,this._fixedHeight=e>0,this.text(this._text),this}_draw(t){this._drawFill(t);let e=0;return"bottom"===this._used.valign?e=this.bounds.height-this._lines.length:"middle"===this._used.valign&&(e=Math.floor((this.bounds.height-this._lines.length)/2)),this._lines.forEach(((i,s)=>{t.drawText(this.bounds.x,this.bounds.y+s+e,i,this._used.fg,-1,this.bounds.width,this._used.align)})),!0}}Li.prototype.text=function(t,e={}){const i=Object.assign({},this._opts,e,{text:t}),s=new Mi(this,i);return e.parent&&s.setParent(e.parent,e),this.pos(s.bounds.x,s.bounds.bottom),s};class ki extends Mi{constructor(t,e){super(t,(()=>{if(e.text=e.text||"",e.action=e.action||e.id,e.tag=e.tag||"button",!e.text&&!e.width)throw new Error("Buttons must have text or width.");return e})())}keypress(t){if(!t.key)return!1;if(this._fireEvent("keypress",this,t))return!0;if("Enter"===t.key){const t=this._attrStr("action");return t&&t.length&&this._bubbleEvent(t,this),!0}return!1}click(t){if(!this.contains(t))return!1;if(this._fireEvent("click",this,t))return!0;const e=this._attrStr("action");return!(!e||!e.length)&&this._bubbleEvent(e,this)}}Li.prototype.button=function(t,e){const i=Object.assign({},this._opts,e,{text:t}),s=new ki(this,i);return e.parent&&s.setParent(e.parent,e),this.pos(s.bounds.x,s.bounds.bottom),s},Ti.prototype.inputbox=function(...t){let e,i={},s={};"string"==typeof t[1]?(i.default=t[0],e=t[1],s=t[2]):(e=t[0],s=t[1]),s&&(e=Ct(e,s)),i.class=i.class||"confirm",i.border=i.border||"ascii",i.pad=i.pad||1;const n=new Li(this),r=void 0!==i.opacity?i.opacity:50;n.body.style().set("bg",Et.alpha(r));const h=n.text(e,{class:i.textClass||i.class,width:i.width,height:i.height}).center();Object.assign(i,{width:h.bounds.width,height:h.bounds.height+2,x:h.bounds.x,y:h.bounds.y,tag:"inputbox"});const o=n.dialog(i);h.setParent(o);let a=o._innerWidth,l=o._innerLeft;if(i.label){const t=n.text(i.label,{class:i.labelClass||i.class,tag:"label",parent:o,x:l,y:o._innerTop+o._innerHeight-1});l+=t.bounds.width+1,a-=t.bounds.width+1}return n.input({class:i.inputClass||i.class,width:a,id:"INPUT",parent:o,x:l,y:o._innerTop+o._innerHeight-1}).on("INPUT",((t,e,i)=>(e&&n.finish(e.text()),!0))),n.on("keypress",((t,e,i)=>"Escape"===i.key&&(n.finish(null),!0))),n.run()};var Oi=Object.freeze({__proto__:null,Grid:yi,Selector:wi,compile:function(t){return new wi(t)},Style:Ei,makeStyle:function(t,e="$"){const i={};return t.trim().split(";").map((t=>t.trim())).forEach((t=>{const[e,s]=t.split(":").map((t=>t.trim()));if(!e)return;const n=s.split(/ +/g);1==n.length?i[e]=s:i[e]=n})),new Ei(e,i)},ComputedStyle:xi,Sheet:vi,defaultStyle:Ii,Layer:Ai,UI:Ti,make:function(t){return new Ti(t)}});class Ri extends Si{constructor(t,e){super(t,e),this.ascii=!1,(e.ascii||e.fg&&!1!==e.ascii)&&(this.ascii=!0)}contains(...t){return!1}_draw(t){const e=this.bounds.width,i=this.bounds.height,s=this.bounds.x,n=this.bounds.y,r=this.ascii;return Ni(t,s,n,e,i,this._used,r),!0}}function Ni(t,e,i,s,n,r,h){const o=r.fg,a=r.bg;if(h){for(let r=1;r<s;++r)t.draw(e+r,i,"-",o,a),t.draw(e+r,i+n-1,"-",o,a);for(let r=1;r<n;++r)t.draw(e,i+r,"|",o,a),t.draw(e+s-1,i+r,"|",o,a);t.draw(e,i,"+",o,a),t.draw(e+s-1,i,"+",o,a),t.draw(e,i+n-1,"+",o,a),t.draw(e+s-1,i+n-1,"+",o,a)}else A(e,i,s,n,((e,i)=>{t.draw(e,i," ",a,a)}))}function Di(t){if(!t)return[0,0,0,0];if(!0===t)return[1,1,1,1];if("number"==typeof t)return[t,t,t,t];if(1==t.length){const e=t[0];return[e,e,e,e]}if(2==t.length){const[e,i]=t;return[e,i,e,i]}throw new Error("Invalid pad: "+t)}Li.prototype.border=function(t){const e=Object.assign({},this._opts,t),i=new Ri(this,e);return t.parent&&i.setParent(t.parent,t),i},Ii.add("dialog",{bg:"darkest_gray",fg:"light_gray"});class Wi extends Si{constructor(t,e){super(t,(e.tag=e.tag||Wi.default.tag,e)),this.legend=null;let i=e.border||Wi.default.border;this.attr("border",i);const s=Di(e.pad||Wi.default.pad);if(this.attr("padTop",s[0]),this.attr("padRight",s[1]),this.attr("padBottom",s[2]),this.attr("padLeft",s[3]),"none"!==i)for(let t=0;t<4;++t)s[t]+=1;this._adjustBounds(s),this.attr("legendTag",e.legendTag||Wi.default.legendTag),this.attr("legendClass",e.legendClass||e.class||Wi.default.legendClass),this.attr("legendAlign",e.legendAlign||Wi.default.legendAlign),this._addLegend(e)}_adjustBounds(t){return this.bounds.width+=t[1]+t[3],this.bounds.height+=t[0]+t[2],this.bounds.x-=t[3],this.bounds.y-=t[0],this}get _innerLeft(){const t=this._attrStr("border"),e=this._attrInt("padLeft");return this.bounds.x+e+("none"===t?0:1)}get _innerWidth(){const t=this._attrStr("border"),e=this._attrInt("padLeft")+this._attrInt("padRight");return this.bounds.width-e-("none"===t?0:2)}get _innerTop(){const t=this._attrStr("border"),e=this._attrInt("padTop");return this.bounds.y+e+("none"===t?0:1)}get _innerHeight(){const t=this._attrStr("border"),e=this._attrInt("padTop")+this._attrInt("padBottom");return this.bounds.height-e-("none"===t?0:2)}_addLegend(t){if(!t.legend)return"none"===this._attrStr("border")&&(this.bounds.height=0),this;const e="none"!==this._attrStr("border"),i=kt(t.legend),s=this.bounds.width-(e?4:0),n=this._attrStr("legendAlign");let r=this.bounds.x+(e?2:0);return"center"===n?r+=Math.floor((s-i)/2):"right"===n&&(r+=s-i),this.legend=new Mi(this.layer,{text:t.legend,x:r,y:this.bounds.y,depth:this.depth+1,tag:this._attrStr("legendTag"),class:this._attrStr("legendClass")}),this.legend.setParent(this),this}_draw(t){this._drawFill(t);const e=this._attrStr("border");return"none"!==e&&(Ni(t,this.bounds.x,this.bounds.y,this.bounds.width,this.bounds.height,this._used,"ascii"===e),!0)}}Wi.default={tag:"dialog",border:"none",pad:!1,legendTag:"legend",legendClass:"",legendAlign:"left"},Li.prototype.dialog=function(t){const e=Object.assign({},this._opts,t),i=new Wi(this,e);return t.parent&&i.setParent(t.parent,t),i};class Pi extends Wi{constructor(t,e){super(t,(e.tag=e.tag||Pi.default.tag,e.border=e.border||Pi.default.border,e.legendTag=e.legendTag||Pi.default.legendTag,e.legendClass=e.legendClass||Pi.default.legendClass,e.legendAlign=e.legendAlign||Pi.default.legendAlign,e.width=e.width||0,e.height=e.height||0,e)),this.fields=[],this.attr("separator",e.separator||Pi.default.separator),this.attr("dataTag",e.dataTag||Pi.default.dataTag),this.attr("dataClass",e.dataClass||Pi.default.dataClass),this.attr("dataWidth",e.dataWidth),this.attr("labelTag",e.labelTag||Pi.default.labelTag),this.attr("labelClass",e.labelClass||Pi.default.labelClass),this.attr("labelWidth",this._innerWidth-e.dataWidth),this._addLegend(e)}_adjustBounds(t){return this.bounds.width=Math.max(this.bounds.width,t[1]+t[3]),this.bounds.height=Math.max(this.bounds.height,t[0]+t[2]),this}get _labelLeft(){const t=this._attrStr("border"),e=this._attrInt("padLeft");return this.bounds.x+e+("none"===t?0:1)}get _dataLeft(){return this._labelLeft+this._attrInt("labelWidth")}get _nextY(){const t=this._attrStr("border"),e=this._attrInt("padBottom");return this.bounds.bottom-("none"===t?0:1)-e}add(t,e){const i=this._attrStr("separator"),s=Rt(t,this._attrInt("labelWidth")-i.length," ")+i;this.layer.text(s,{x:this._labelLeft,y:this._nextY,width:this._attrInt("labelWidth"),tag:this._attrStr("labelTag"),class:this._attrStr("labelClass")}),"string"==typeof e&&(e={format:e}),e.x=this._dataLeft,e.y=this._nextY,e.width=this._attrInt("dataWidth"),e.tag=e.tag||this._attrStr("dataTag"),e.class=e.class||this._attrStr("dataClass");const n=new Bi(this.layer,e);return n.setParent(this),this.bounds.height+=1,this.fields.push(n),this}data(t){return this.fields.forEach((e=>e.data(t))),this.layer.needsDraw=!0,this}}Pi.default={tag:"fieldset",border:"none",separator:" : ",pad:!1,legendTag:"legend",legendClass:"legend",legendAlign:"left",labelTag:"label",labelClass:"",dataTag:"field",dataClass:""},Li.prototype.fieldset=function(t){const e=Object.assign({},this._opts,t),i=new Pi(this,e);return t.parent&&i.setParent(t.parent,t),i};class Bi extends Mi{constructor(t,e){super(t,(()=>{const t=e;return t.tag=t.tag||"field",t.text="",t})()),"string"==typeof e.format?this._format=St(e.format):this._format=e.format}data(t){const e=this._format(t)||"";return this.text(e)}}class Vi extends Si{constructor(t,e){super(t,(e.tag=e.tag||"ol",e)),this._fixedWidth=!1,this._fixedHeight=!1,this._fixedHeight=!!e.height,this._fixedWidth=!!e.width,this.prop("pad",e.pad||Vi.default.pad)}_addChild(t,e={}){return t.bounds.x=this.bounds.x+2,this._fixedHeight||(t.bounds.y=this.bounds.bottom-2,this.bounds.height+=t.bounds.height),this._fixedWidth?t.bounds.width=Math.min(t.bounds.width,this.bounds.width-4):t.bounds.width>this.bounds.width-4&&(this.bounds.width=t.bounds.width+4),super._addChild(t,e)}_draw(t){return this._drawFill(t),this.children.forEach(((e,i)=>{this._drawBulletFor(e,t,i)})),!0}_getBullet(t){return""+(t+1)}_drawBulletFor(t,e,i){const s=this._getBullet(i),n=this._attrInt("pad")+s.length,r=t.bounds.x-n,h=t.bounds.y;e.drawText(r,h,s,t._used.fg,t._used.bg,n)}}Vi.default={pad:1};class Hi extends Vi{constructor(t,e){super(t,(e.tag=e.tag||"ul",e)),this.prop("bullet",e.bullet||Hi.default.bullet),this.prop("pad",e.pad||Hi.default.pad)}_getBullet(t){return this._attrStr("bullet")}}Hi.default={bullet:"",pad:1},Li.prototype.ol=function(t={}){const e=Object.assign({},this._opts,t),i=new Vi(this,e);return t.parent&&i.setParent(t.parent,t),i},Li.prototype.ul=function(t={}){const e=Object.assign({},this._opts,t),i=new Hi(this,e);return t.parent&&i.setParent(t.parent,t),i},Ii.add("input",{bg:"light_gray",fg:"black",align:"left",valign:"top"}),Ii.add("input:invalid",{fg:"red"}),Ii.add("input:empty",{fg:"darkest_green"}),Ii.add("input:focus",{bg:"lighter_gray"});class Fi extends Mi{constructor(t,e){super(t,(e.text=e.text||"",e.tag=e.tag||"input",e.tabStop=void 0===e.tabStop||e.tabStop,e.action=e.action||e.id,e.width=e.width||e.maxLength||Math.max(e.minLength||0,10),e)),this.minLength=0,this.maxLength=0,this.numbersOnly=!1,this.min=0,this.max=0,this.attr("default",this._text),this.attr("placeholder",e.placeholder||Fi.default.placeholder),e.numbersOnly?(this.numbersOnly=!0,this.min=e.min||0,this.max=e.max||0):(this.minLength=e.minLength||0,this.maxLength=e.maxLength||0),e.required&&(this.attr("required",!0),this.prop("required",!0)),e.disabled&&(this.attr("disabled",!0),this.prop("disabled",!0)),this.prop("valid",this.isValid()),this.on("blur",(()=>this._fireEvent("change",this))),this.reset()}reset(){this.text(this._attrStr("default"))}_setProp(t,e){super._setProp(t,e),this._props.valid=this.isValid()}isValid(){const t=this._text||"";if(this.numbersOnly){const e=Number.parseInt(t);return!(void 0!==this.min&&e<this.min)&&(!(void 0!==this.max&&e>this.max)&&e>0)}const e=Math.max(this.minLength,this.prop("required")?1:0);return t.length>=e&&(!this.maxLength||t.length<=this.maxLength)}keypress(t){if(!t.key)return!1;const e=this.numbersOnly?["0","9"]:[" ","~"];if("Enter"===t.key&&this.isValid()){const t=this._attrStr("action");return t&&t.length?this._fireEvent(t,this):this.layer.nextTabStop(),!0}return"Delete"==t.key||"Backspace"==t.key?(this._text.length&&(this.text(Dt(this._text,this._text.length-1,1)),this._fireEvent("input",this),this._draw(this.layer.buffer)),!0):!(t.key.length>1)&&(t.key>=e[0]&&t.key<=e[1]&&(!this.maxLength||this._text.length<this.maxLength)&&(this.text(this._text+t.key),this._fireEvent("input",this),this._draw(this.layer.buffer)),!0)}text(t){return void 0===t?this._text:(super.text(t),this.prop("empty",0===this._text.length),this.prop("valid",this.isValid()),this)}_draw(t,e=!1){this._drawFill(t);let i=0;"bottom"===this._used.valign?i=this.bounds.height-this._lines.length:"middle"===this._used.valign&&(i=Math.floor((this.bounds.height-this._lines.length)/2));let s=this._text;return 0==s.length&&(s=this._attrStr("placeholder")),this._text.length>this.bounds.width&&(s=this._text.slice(this._text.length-this.bounds.width)),t.drawText(this.bounds.x,this.bounds.y+i,s,this._used.fg,-1,this.bounds.width,this._used.align),!0}}Fi.default={tag:"input",width:10,placeholder:""},Li.prototype.input=function(t){const e=Object.assign({},this._opts,t),i=new Fi(this,e);return t.parent&&i.setParent(t.parent,t),i};class ji{constructor(t){this.format=n,this.width=t.width||Yi.default.columnWidth,"function"==typeof t.format?this.format=t.format:t.format&&(this.format=St(t.format)),this.header=t.header||"",this.headerTag=t.headerTag||Yi.default.headerTag,this.empty=t.empty||Yi.default.empty,this.dataTag=t.dataTag||Yi.default.dataTag}addHeader(t,e,i,s){const n=new Mi(t.layer,{x:e,y:i,class:t.classes.join(" "),tag:t._attrStr("headerTag"),width:this.width,height:t.rowHeight,depth:t.depth+1,text:this.header});return n.prop("row",-1),n.prop("col",s),n.setParent(t),t.layer.attach(n),n}addData(t,e,i,s,n,r){let h;h=Array.isArray(e)?""+(e[n]||this.empty):"object"!=typeof e?""+e:this.format(e);const o=new Gi(t.layer,{text:h,x:i,y:s,class:t.classes.join(" "),tag:t._attrStr("dataTag"),width:this.width,height:t.rowHeight,depth:t.depth+1});return o.prop(r%2==0?"even":"odd",!0),o.prop("row",r),o.prop("col",n),o.setParent(t),t.layer.attach(o),o}addEmpty(t,e,i,s,n){return this.addData(t,[],e,i,s,n)}}ji.default={select:"row",hover:"select",tag:"datatable",headerTag:"th",dataTag:"td",border:"ascii"};class Yi extends Si{constructor(t,e){super(t,(e.tag=e.tag||Yi.default.tag,e.tabStop=void 0===e.tabStop||e.tabStop,e)),this._data=[],this.columns=[],this.showHeader=!1,this.rowHeight=1,this.selectedRow=-1,this.selectedColumn=0,this.size=e.size||t.height,this.bounds.width=0,e.columns.forEach((t=>{const e=new ji(t);this.columns.push(e),this.bounds.width+=e.width})),e.border?!0===e.border&&(e.border="ascii"):!1===e.border&&(e.border="none"),this.attr("border",e.border||Yi.default.border),this.rowHeight=e.rowHeight||1,this.bounds.height=1,this.attr("wrap",void 0===e.wrap?Yi.default.wrap:e.wrap),this.attr("header",void 0===e.header?Yi.default.header:e.header),this.attr("headerTag",e.headerTag||Yi.default.headerTag),this.attr("dataTag",e.dataTag||Yi.default.dataTag),this.attr("prefix",e.prefix||Yi.default.prefix),this.attr("select",e.select||Yi.default.select),this.attr("hover",e.hover||Yi.default.hover),this.data(e.data||[])}get selectedData(){if(!(this.selectedRow<0))return this._data[this.selectedRow]}select(t,e){if(!this._data||0==this._data.length)return this.selectedRow=this.selectedColumn=0,this;this.attr("wrap")&&((t<0||t>=this.columns.length)&&(t+=this.columns.length,t%=this.columns.length),(e<0||e>=this._data.length)&&(e+=this._data.length,e%=this._data.length)),t=this.selectedColumn=r(t,0,this.columns.length-1),e=this.selectedRow=r(e,0,this._data.length-1);const i=this._attrStr("select");return"none"===i?this.children.forEach((t=>{t.prop("selected",!1)})):"row"===i?this.children.forEach((t=>{const i=e==t.prop("row");t.prop("selected",i)})):"column"===i?this.children.forEach((e=>{const i=t==e.prop("col");e.prop("selected",i)})):"cell"===i&&this.children.forEach((i=>{const s=t==i.prop("col")&&e==i.prop("row");i.prop("selected",s)})),this._bubbleEvent("input",this,{row:e,col:t,data:this.selectedData}),this}selectNextRow(){return this.select(this.selectedColumn,this.selectedRow+1)}selectPrevRow(){return this.select(this.selectedColumn,this.selectedRow-1)}selectNextCol(){return this.select(this.selectedColumn+1,this.selectedRow)}selectPrevCol(){return this.select(this.selectedColumn-1,this.selectedRow)}blur(t){return this._bubbleEvent("change",this,{col:this.selectedColumn,row:this.selectedRow,data:this.selectedData}),super.blur(t)}data(t){if(!t)return this._data;this._data=t;for(let t=this.children.length-1;t>=0;--t){const e=this.children[t];e.tag!==this.attr("headerTag")&&this.layer.detach(e)}const e="none"!==this.attr("border")?1:0;let i=this.bounds.x+e,s=this.bounds.y+e;return this.attr("header")&&(this.columns.forEach(((t,n)=>{t.addHeader(this,i,s,n),i+=t.width+e})),s+=this.rowHeight+e),this._data.forEach(((t,n)=>{n>=this.size||(i=this.bounds.x+e,this.columns.forEach(((r,h)=>{r.addData(this,t,i,s,h,n),i+=r.width+e})),s+=this.rowHeight+e)})),0==this._data.length?(i=this.bounds.x+e,this.columns.forEach(((t,n)=>{t.addEmpty(this,i,s,n,0),i+=t.width+e})),s+=1,this.select(-1,-1)):this.select(0,0),this.bounds.height=s-this.bounds.y,this.bounds.width=i-this.bounds.x,this.updateStyle(),this}_draw(t){return this._drawFill(t),this.children.forEach((e=>{e.prop("row")>=this.size||"none"!==this.attr("border")&&Ni(t,e.bounds.x-1,e.bounds.y-1,e.bounds.width+2,e.bounds.height+2,this._used,"ascii"==this.attr("border"))})),!0}mouseenter(t,e){if(super.mouseenter(t,e),!this.hovered)return;const i=this.children.find((e=>e.contains(t)));if(i){const t=i._propInt("col"),e=i._propInt("row");if(t!==this.selectedColumn||e!==this.selectedRow){this.selectedColumn=t,this.selectedRow=e;let i=!1,s=this._attrStr("hover");"select"===s&&(s=this._attrStr("select"),i=!0),"none"===s?this.children.forEach((t=>{t.hovered=!1,i&&t.prop("selected",!1)})):"row"===s?this.children.forEach((t=>{const s=e==t.prop("row");t.hovered=s,i&&t.prop("selected",s)})):"column"===s?this.children.forEach((e=>{const s=t==e.prop("col");e.hovered=s,i&&e.prop("selected",s)})):"cell"===s&&this.children.forEach((s=>{const n=t==s.prop("col")&&e==s.prop("row");s.hovered=n,i&&s.prop("selected",n)})),this._bubbleEvent("input",this,{row:e,col:t,data:this.selectedData})}}}click(t){return!!this.contains(t)&&(this._bubbleEvent("change",this,{row:this.selectedRow,col:this.selectedColumn,data:this.selectedData}),!1)}keypress(t){return!!t.key&&("Enter"===t.key&&(this._bubbleEvent("change",this,{row:this.selectedRow,col:this.selectedColumn,data:this.selectedData}),!0))}dir(t){return!!t.dir&&(1==t.dir[1]?this.selectNextRow():-1==t.dir[1]&&this.selectPrevRow(),1==t.dir[0]?this.selectNextCol():-1==t.dir[0]&&this.selectPrevCol(),!0)}}Yi.default={columnWidth:10,header:!0,empty:"-",tag:"datatable",headerTag:"th",dataTag:"td",select:"cell",hover:"select",prefix:"none",border:"ascii",wrap:!0};class Gi extends Mi{mouseleave(t){if(super.mouseleave(t),this.parent){const t=this.parent;"row"===t.attr("select")?this.hovered=this._propInt("row")===t.selectedRow:"column"===t.attr("select")&&(this.hovered=this._propInt("col")===t.selectedColumn)}}}Li.prototype.datatable=function(t){const e=Object.assign({},this._opts,t),i=new Yi(this,e);return t.parent&&i.setParent(t.parent,t),i};class Ui extends Yi{constructor(t,e){super(t,(()=>{const t=e;return"none"!==e.border&&e.width&&(e.width-=2),t.columns=[Object.assign({},e)],e.header&&e.header.length||(t.header=!1),t})())}}Li.prototype.datalist=function(t){const e=Object.assign({},this._opts,t),i=new Ui(this,e);return t.parent&&i.setParent(t.parent,t),i};class Xi extends Si{constructor(t,e){super(t,(e.tag=e.tag||Xi.default.tag,e.class=e.class||Xi.default.class,e)),Array.isArray(e.buttonClass)?this.attr("buttonClass",e.buttonClass.join(" ")):this.attr("buttonClass",e.buttonClass||Xi.default.buttonClass),this.attr("buttonTag",e.buttonTag||Xi.default.buttonTag),this.attr("marker",e.marker||Xi.default.marker),this._initButtons(e),this.bounds.height=this.children.length,this.on("mouseenter",((t,e,i)=>(this.children.forEach((t=>{t.contains(i)?t.expand():t.collapse()})),!0)))}_initButtons(t){this.children=[];const e=t.buttons,i=this._attrStr("marker"),s=Object.entries(e);this.bounds.width<=0&&(this.bounds.width=Math.max(t.minWidth||0,s.reduce(((t,[e,s])=>{const n=kt(e)+("string"==typeof s?0:i.length);return Math.max(t,n)}),0))),s.forEach((([t,e],s)=>{const n={x:this.bounds.x,y:this.bounds.y+s,class:this._attrStr("buttonClass"),tag:this._attrStr("buttonTag"),width:this.bounds.width,height:1,depth:this.depth+1,buttons:e,text:t};"string"==typeof e?n.action=e:n.text=Rt(t,this.bounds.width-i.length," ")+i;const r=new Ki(this.layer,n);r.setParent(this),r.on("mouseenter",(()=>(this._bubbleEvent("change",r),!1))),r.setParent(this)}))}collapse(){return this.children.forEach((t=>{t.collapse()})),this}}Xi.default={tag:"menu",class:"",buttonClass:"",buttonTag:"mi",marker:" ",minWidth:4};class Ki extends Mi{constructor(t,e){super(t,(e.tag=e.tag||"mi",e)),this.menu=null,this.tag=e.tag||"mi","string"!=typeof e.buttons&&(this.menu=this._initMenu(e),this.on("mouseenter",(()=>(this.menu.hidden=!1,this.menu._bubbleEvent("change",this),!0))),this.on("mouseleave",((t,e,i)=>{var s;return!!(null===(s=this.parent)||void 0===s?void 0:s.contains(i))&&(this.menu.hidden=!0,!0)})),this.on("click",(()=>!0)))}collapse(){return this.menu&&(this.menu.collapse(),this.menu.hidden=!0),this}expand(){return this.menu&&(this.menu.hidden=!1),this}_setMenuPos(t,e){t.x=this.bounds.x+this.bounds.width,t.y=this.bounds.y;const i=Object.keys(e.buttons).length;t.y+i>=this.layer.height&&(t.y=this.layer.height-i-1)}_initMenu(t){if("string"==typeof t.buttons)return null;const e={x:this.bounds.x+this.bounds.width,y:this.bounds.y,class:t.class,tag:t.tag||"mi",buttons:t.buttons,depth:this.depth+1};this._setMenuPos(e,t);const i=new Xi(this.layer,e);return i.hidden=!0,i.setParent(this),i}}Li.prototype.menu=function(t){const e=Object.assign({},this._opts,t),i=new Xi(this,e);return t.parent&&i.setParent(t.parent,t),i};class zi extends Si{constructor(t,e){super(t,(e.tabStop=!0,e.tag=e.tag||"menu",e)),this._buttons=[],this._selectedIndex=-1,e.buttonClass?Array.isArray(e.buttonClass)?this.attr("buttonClass",e.buttonClass.join(" ")):this.attr("buttonClass",e.buttonClass):this.attr("buttonClass",zi.default.buttonClass),this.attr("buttonTag",e.buttonTag||zi.default.buttonTag),e.menuClass?Array.isArray(e.menuClass)?this.attr("menuClass",e.menuClass.join(" ")):this.attr("menuClass",e.menuClass):this.attr("menuClass",zi.default.menuClass),this.attr("menuTag",e.menuTag||zi.default.menuTag),this.attr("prefix",e.prefix||zi.default.prefix),this.attr("separator",e.separator||zi.default.separator),this._initButtons(e),this.on("click",this._buttonClick.bind(this))}get selectedIndex(){return this._selectedIndex}set selectedIndex(t){this._selectedIndex>=0&&this._buttons[this._selectedIndex].prop("focus",!1).collapse(),this._selectedIndex=t,t>=0&&t<this._buttons.length?this._buttons[t].prop("focus",!0).expand():this._selectedIndex=-1}get selectedButton(){return this._buttons[this._selectedIndex]}focus(t=!1){return this.selectedIndex=t?this._buttons.length-1:0,super.focus(t)}blur(t=!1){return this.selectedIndex=-1,super.blur(t)}collapse(){return this._buttons.reduce(((t,e)=>e.collapse()||t),!1)}keypress(t){return!!t.key&&(!!this.focused&&("Tab"===t.key?(this.selectedIndex+=1,this._selectedIndex>=0):"TAB"===t.key&&(this.selectedIndex-=1,this._selectedIndex>=0)))}mousemove(t){if(!this.contains(t)||!this.focused)return super.mousemove(t);const e=this._buttons.findIndex((e=>e.contains(t)));return!(e<0||e===this._selectedIndex)&&(this.selectedIndex=e,!0)}_initButtons(t){this._config=t.buttons;const e=Object.entries(this._config),i=this._attrStr("buttonTag"),s=this._attrStr("buttonClass");let n=this.bounds.x;const r=this.bounds.y;e.forEach((([t,e],h)=>{const o=0==h?this._attrStr("prefix"):this._attrStr("separator");this.layer.text(o,{x:n,y:r,parent:this}),n+=o.length;const a=new qi(this.layer,{text:t,x:n,y:r,tag:i,class:s,depth:this.depth+1,buttons:e});a.setParent(this),this._buttons.push(a),n+=a.bounds.width}))}_buttonClick(t,e){if(!e)return!1;this.layer.setFocusWidget(this),console.log("clicked = "+e.text(),e._attrStr("action"));const i=e;return this.selectedIndex=this._buttons.indexOf(i),i.menu?i.expand():this.collapse(),!0}}zi.default={buttonClass:"",buttonTag:"mi",menuClass:"",menuTag:"mi",prefix:" ",separator:" | "};class qi extends Mi{constructor(t,e){super(t,(e.tag=e.tag||"mi","string"==typeof e.buttons&&(e.action=e.buttons),e)),this.menu=null,this.tag=e.tag||"mi","string"!=typeof e.buttons&&(this.menu=this._initMenu(e),this.on("mouseenter",(()=>(this.menu.hidden=!1,this.menu._bubbleEvent("change",this),!0))),this.on("mouseleave",((t,e,i)=>{var s;return!!(null===(s=this.parent)||void 0===s?void 0:s.contains(i))&&(this.menu.hidden=!0,!0)})),this.on("click",(()=>!0)))}collapse(){return!(!this.menu||this.menu.hidden)&&(this.menu.collapse(),this.menu.hidden=!0,!0)}expand(){return this.menu&&(this.menu.hidden=!1),this}_setMenuPos(t,e){t.x=this.bounds.x;const i=e.height||Object.keys(e.buttons).length;this.bounds.y<i?t.y=this.bounds.y+1:t.y=this.bounds.top-i}_initMenu(t){if("string"==typeof t.buttons)return null;const e={x:this.bounds.x,y:this.bounds.y,class:t.class,tag:t.tag||"mi",height:t.height,buttons:t.buttons,depth:this.depth+1};this._setMenuPos(e,t);const i=new Xi(this.layer,e);return i.hidden=!0,i.setParent(this),i}}Li.prototype.menubar=function(t){const e=Object.assign({},this._opts,t),i=new zi(this,e);return t.parent&&i.setParent(t.parent,t),i};class $i extends Si{constructor(t,e){super(t,e),this.tag=e.tag||"select",this._initText(e),this._initMenu(e),this.bounds.height=1}_initText(t){this.dropdown=new Mi(this.layer,{text:t.text+" ",x:this.bounds.x,y:this.bounds.y,class:t.class,tag:t.tag||"select",width:this.bounds.width,height:1,depth:this.depth+1}).on("click",(()=>(this.menu.toggleProp("hidden"),!1))),this.dropdown.setParent(this,{beforeIndex:0})}_initMenu(t){this.menu=new Xi(this.layer,{x:this.bounds.x,y:this.bounds.y+1,class:t.buttonClass,tag:t.buttonTag||"select",width:t.width,minWidth:this.dropdown.bounds.width,height:t.height,buttons:t.buttons,depth:this.depth+1}).on("click",(()=>(this.menu.hidden=!0,!1))),this.menu.hidden=!0,this.menu.setParent(this)}}Li.prototype.select=function(t){const e=Object.assign({},this._opts,t),i=new $i(this,e);return t.parent&&i.setParent(t.parent,t),i};class Zi extends Si{constructor(t,e){super(t,(e.tag=e.tag||Zi.default.tag,e)),this._prompt=null,this._done=null,this.choiceWidth=e.choiceWidth,this.attr("border",e.border||Zi.default.border),this.attr("promptTag",e.promptTag||Zi.default.promptTag),this.attr("promptClass",e.promptClass||Zi.default.promptClass),this.attr("choiceTag",e.choiceTag||Zi.default.choiceTag),this.attr("choiceClass",e.choiceClass||Zi.default.choiceClass),this.attr("infoTag",e.infoTag||Zi.default.infoTag),this.attr("infoClass",e.infoClass||Zi.default.infoClass),this._addLegend(),this._addList(),this._addInfo(),e.prompt&&this.showPrompt(e.prompt)}showPrompt(t,e){return this._prompt=t,t.choose(0),this.prompt.text(t.prompt(e)),this.list.data(t.choices()),this.info.text(t.info(e)),this._bubbleEvent("input",this,this._prompt),new Promise((t=>this._done=t))}_addList(){return this.list=new Ui(this.layer,{height:this.bounds.height-2,x:this.bounds.x+1,width:this.choiceWidth,y:this.bounds.y+1,dataTag:this._attrStr("choiceTag"),dataClass:this._attrStr("choiceClass"),tabStop:!0,border:"none",hover:"select"}),this.list.setParent(this),this.list.on("input",(()=>{if(!this._prompt)return!1;const t=this._prompt,e=this.list.selectedRow;return t.choose(e),this.info.text(t.info()),this._bubbleEvent("input",this,t),!0})),this.list.on("change",(()=>{if(!this._prompt)return!1;const t=this._prompt;return t.choose(this.list.selectedRow),this._bubbleEvent("change",this,t),this._done(t.value()),!0})),this}_addInfo(){return this.info=new Mi(this.layer,{text:"",x:this.bounds.x+this.choiceWidth+2,y:this.bounds.y+1,width:this.bounds.width-this.choiceWidth-3,height:this.bounds.height-2,tag:this._attrStr("infoTag"),class:this._attrStr("infoClass")}),this.info.setParent(this),this}_addLegend(){return this.prompt=new Mi(this.layer,{text:"",width:this.bounds.width-4,x:this.bounds.x+2,y:this.bounds.y,tag:this._attrStr("promptTag"),class:this._attrStr("promptClass")}),this.prompt.setParent(this),this}_draw(t){let e=this.choiceWidth+2;const i=this.bounds.height;let s=this.bounds.x;const n=this.bounds.y,r="ascii"===this.attr("border");return Ni(t,s,n,e,i,this._used,r),e=this.bounds.width-this.choiceWidth-1,s=this.bounds.x+this.choiceWidth+1,Ni(t,s,n,e,i,this._used,r),!0}}Zi.default={tag:"choice",border:"ascii",promptTag:"prompt",promptClass:"",choiceTag:"ci",choiceClass:"",infoTag:"info",infoClass:""},Li.prototype.choice=function(t){const e=Object.assign({},this._opts,t),i=new Zi(this,e);return t.parent&&i.setParent(t.parent,t),i};var Ji=Object.freeze({__proto__:null,Widget:Si,WidgetLayer:Li,Body:Ci,Text:Mi,Border:Ri,drawBorder:Ni,Button:ki,toPadArray:Di,Dialog:Wi,Fieldset:Pi,Field:Bi,OrderedList:Vi,UnorderedList:Hi,Input:Fi,Column:ji,DataTable:Yi,TD:Gi,DataList:Ui,Menu:Xi,MenuButton:Ki,Menubar:zi,MenubarButton:qi,MenuViewer:class extends Si{constructor(t,e){super(t.layer,{tabStop:!0,x:0,y:0,width:t.layer.width,height:t.layer.height,tag:t.attr("menuTag"),class:t.attr("menuClass")}),this.menubar=t,this.mainMenu=this._initMenu(e)}contains(){return!0}finish(){this.layer.finish()}_initMenu(t){return new Xi(this.layer,{buttonTag:this.menubar._attrStr("buttonTag"),buttonClass:this.menubar._attrStr("buttonClass"),minWidth:this.menubar.selectedButton.bounds.width,buttons:t})}keypress(t){return!!t.key&&("Escape"===t.key?(this.finish(),!0):("Tab"===t.key||"TAB"===t.key)&&(this.finish(),this.menubar.keypress(t),!0))}},Select:$i,Prompt:class{constructor(t,e={}){this._id=null,this._defaultNext=null,this.selection=-1,"string"==typeof e&&(e={field:e}),this._prompt=t,this._field=e.field||"",this._choices=[],this._infos=[],this._values=[],this._next=[],this._defaultNext=e.next||null,this._id=e.id||e.field||""}reset(){this.selection=-1}field(t){return void 0===t?this._field:(this._field=t,this)}id(t){return void 0===t?this._id:(this._id=t,this)}prompt(t){return"string"==typeof this._prompt?this._prompt:this._prompt(t)}next(t){return void 0===t?this._next[this.selection]||this._defaultNext:(this._defaultNext=t,this)}choices(t,e){if(void 0===t)return this._choices;if(Array.isArray(t)?Array.isArray(e)||(e=new Array(t.length).fill("")):(e=Object.values(t),t=Object.keys(t)),e=e.map((t=>"string"==typeof t?{info:t}:t)),t.length!==e.length)throw new Error("Choices and Infos must have same length.");return t.forEach(((t,i)=>{this.choice(t,e[i])})),this}choice(t,e={}){return"string"==typeof e&&(e={info:e}),this._choices.push(t),this._infos.push(e.info||""),this._next.push(e.next||null),this._values.push(e.value||t),this}info(t){const e=this._infos[this.selection]||"";return"string"==typeof e?e:e(t)}choose(t){return this.selection=t,this}value(){return this._values[this.selection]}updateResult(t){return this.selection<0||(t[this._field]=this.value()),this}},Choice:Zi,Inquiry:class{constructor(t){this._prompts=[],this.events={},this._result={},this._stack=[],this._current=null,this.widget=t,this._keypress=this._keypress.bind(this),this._change=this._change.bind(this)}prompts(t,...e){return Array.isArray(t)?this._prompts=t.slice():(e.unshift(t),this._prompts=e),this}_finish(){this.widget.off("keypress",this._keypress),this.widget.off("change",this._change),this._fireEvent("finish",this.widget,this._result)}_cancel(){this.widget.off("keypress",this._keypress),this.widget.off("change",this._change),this._fireEvent("cancel",this.widget)}start(){this._current=this._prompts[0],this._result={},this.widget.on("keypress",this._keypress),this.widget.on("change",this._change),this.widget.showPrompt(this._current,this._result)}back(){this._current.reset(),this._current=this._stack.pop()||null,this._current?(this._current.reset(),this._result={},this._prompts.forEach((t=>t.updateResult(this._result))),this.widget.showPrompt(this._current,this._result)):this._cancel()}restart(){this._prompts.forEach((t=>t.reset())),this._result={},this._current=this._prompts[0],this.widget.showPrompt(this._current,this._result)}quit(){this._cancel()}_keypress(t,e,i){return!!i.key&&("Escape"===i.key?(this.back(),!0):"R"===i.key?(this.restart(),!0):"Q"===i.key&&(this.quit(),!0))}_change(t,e,i){i.updateResult(this._result);const s=i.next();return s&&(this._current=this._prompts.find((t=>t.id()===s))||null,this._current)?(this._stack.push(i),this.widget.showPrompt(this._current,this._result),this._fireEvent("step",this.widget,{prompt:this._current,data:this._result}),!0):(this._finish(),!0)}on(t,e){let i=this.events[t];return i||(i=this.events[t]=[]),i.includes(e)||i.push(e),this}off(t,e){let i=this.events[t];return i?(e?l(i,e):i.length=0,this):this}_fireEvent(t,e,i){const s=this.events[t]||[];let n=!1;for(let r of s)n=r(t,e||this.widget,i)||n;return n||(n=this.widget._bubbleEvent(t,e||this.widget,i)),n}}});t.ERROR=h,t.FALSE=s,t.IDENTITY=n,t.IS_NONZERO=function(t){return 0!=t},t.IS_ZERO=function(t){return 0==t},t.NOOP=e,t.ONE=function(){return 1},t.TRUE=i,t.WARN=function(...t){console.warn(...t)},t.ZERO=function(){return 0},t.arrayDelete=l,t.arrayFindRight=function(t,e){for(let i=t.length-1;i>=0;--i){const s=t[i];if(e(s))return s}},t.arrayIncludesAll=a,t.arrayInsert=function(t,e,i){if(!i)return void t.push(e);const s=t.findIndex(i);s<0?t.push(e):t.splice(s,0,e)},t.arrayNext=u,t.arrayNullify=function(t,e){const i=t.indexOf(e);return!(i<0)&&(t[i]=null,!0)},t.arrayPrev=d,t.arraysIntersect=function(t,e){return t.some((t=>e.includes(t)))},t.blob=ei,t.buffer=Ht,t.canvas=Fe,t.clamp=r,t.color=vt,t.colors=lt,t.config=ze,t.cosmetic=H,t.data=Ke,t.events=Ce,t.first=o,t.flag=z,t.fov=pe,t.frequency=Le,t.grid=rt,t.io=ge,t.lerp=function(t,e,i){return i>1&&(i=1),i<0&&(i=0),Math.floor(t+(e-t)*i)},t.light=fi,t.list=k,t.message=Qe,t.nextIndex=function(t,e,i=!0){return++t>=e?i?t%e:-1:t},t.object=N,t.path=Te,t.prevIndex=function(t,e,i=!0){return t<0?e-1:--t<0?i?e-1:-1:t},t.queue=ot,t.random=V,t.range=U,t.rng=F,t.scheduler=Me,t.sprite=Ue,t.sprites=Ye,t.sum=function(t){return t.reduce(((t,e)=>t+e))},t.text=Bt,t.tween=mi,t.types=Xe,t.ui=Oi,t.widget=Ji,t.xy=S,Object.defineProperty(t,"__esModule",{value:!0})}));
//# sourceMappingURL=gw-utils.min.js.map
