!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).GWU={})}(this,(function(t){"use strict";function e(){}function i(){return!0}function n(t,e,i){return t<e?e:t>i?i:t}function s(t){throw new Error(t)}function r(...t){return t.find((t=>void 0!==t))}function h(t,e,i,n=!0,s=!0){const r=t.length;if(r<=1)return;const h=t.indexOf(e);if(h<0)return;const o=s?1:-1;let a=n?h:s?r:-1;for(let e=n?(r+h+o)%r:h+o;e!==a;e=n?(r+e+o)%r:e+o){const n=t[e];if(i(n))return n}}const o=[[0,-1],[1,0],[0,1],[-1,0],[1,-1],[1,1],[-1,1],[-1,-1]],a=[[0,1],[1,1],[1,0],[1,-1],[0,-1],[-1,-1],[-1,0],[-1,1]];function l(t){return t.x||t[0]||0}function u(t){return t.y||t[1]||0}class c{constructor(t=0,e=0,i=0,n=0){this.x=t,this.y=e,this.width=i,this.height=n}get left(){return this.x}set left(t){this.x=t}get right(){return this.x+this.width}set right(t){this.x=t-this.width}get top(){return this.y}set top(t){this.y=t}get bottom(){return this.y+this.height}set bottom(t){this.y=t-this.height}clone(){return new c(this.x,this.y,this.width,this.height)}contains(...t){let e=t[0],i=t[1];return"number"!=typeof e&&(i=u(e),e=l(e)),this.x<=e&&this.y<=i&&this.x+this.width>e&&this.y+this.height>i}toString(){return`[${this.x},${this.y} -> ${this.right},${this.bottom}]`}}function f(t,e,i,n=!1){const s=n?4:8;for(let n=0;n<s;++n){const s=o[n];i(t+s[0],e+s[1])}}function d(t,e,i,n){const s=Math.abs(t-i),r=Math.abs(e-n);return s+r-.6*Math.min(s,r)}function g(t,e){return d(0,0,t,e)}function _(t,e,i,n){let s=i-t,r=n-e;if(s&&r){const t=Math.abs(s),e=Math.abs(r);t>=2*e?r=0:e>=2*t&&(s=0)}return[Math.sign(s),Math.sign(r)]}const p=65536;function E(t,e,i,n,s){let r,h,o=[],a=[],l=[],u=[],c=[],f=[-1,-1],d=[-1,-1];if(t==i&&e==n)return!0;const g=[t,e],_=[i,n];for(h=0;h<=1;h++)o[h]=_[h]-g[h]<<16,o[h]<0?(o[h]*=-1,c[h]=-1):c[h]=1,l[h]=u[h]=a[h]=0,f[h]=g[h];for(r=Math.max(o[0],o[1]),o[0]=Math.floor(o[0]*p/r),o[1]=Math.floor(o[1]*p/r);;){for(h=0;h<=1;h++)d[h]=f[h],l[h]+=o[h]>>16,a[h]+=o[h]==p?0:o[h],a[h]>=Math.floor(32768)&&(l[h]++,a[h]-=p),f[h]=Math.floor(c[h]*l[h]+g[h]);if(!1===s(...f))return!1;if(f[0]===i&&f[1]===n)return!0}}function m(t,e,i,n){let s,r;for(s=t-i-1;s<t+i+1;s++)for(r=e-i-1;r<e+i+1;r++)(s-t)*(s-t)+(r-e)*(r-e)<i*i+i&&n(s,r)}function y(...t){let e=0,i=0;arguments.length>3&&(e=t.shift(),i=t.shift());const n=e+t[0],s=i+t[1],r=t[2];for(let t=e;t<n;++t)for(let e=i;e<s;++e)r(t,e)}function b(t,e,i){let n,s,r,h,o=0,l=0;for(let u=0;u<a.length;u++){n=t+a[(u+7)%8][0],s=e+a[(u+7)%8][1],r=t+a[u][0],h=e+a[u][1];const c=i(r,h);c&&++l,c!=i(n,s)&&o++}return 0==o&&l?1:Math.floor(o/2)}var I=Object.freeze({__proto__:null,DIRS:o,NO_DIRECTION:-1,UP:0,RIGHT:1,DOWN:2,LEFT:3,RIGHT_UP:4,RIGHT_DOWN:5,LEFT_DOWN:6,LEFT_UP:7,CLOCK_DIRS:a,x:l,y:u,contains:function(t,e,i){return e>=0&&i>=0&&e<t.width&&i<t.height},Bounds:c,copyXY:function(t,e){t.x=l(e),t.y=u(e)},addXY:function(t,e){t.x+=l(e),t.y+=u(e)},equalsXY:function(t,e){return!t&&!e||!(!t||!e)&&(l(t)==l(e)&&u(t)==u(e))},lerpXY:function(t,e,i){i>1&&(i/=100),i=n(i,0,1);const s=l(e)-l(t),r=u(e)-u(t);return[l(t)+Math.floor(s*i),u(t)+Math.floor(r*i)]},eachNeighbor:f,eachNeighborAsync:async function(t,e,i,n=!1){const s=n?4:8;for(let n=0;n<s;++n){const s=o[n],r=t+s[0],h=e+s[1];await i(r,h)}},matchingNeighbor:function(t,e,i,n=!1){const s=n?4:8;for(let n=0;n<s;++n){const s=o[n],r=t+s[0],h=e+s[1];if(i(r,h))return[r,h]}return[-1,-1]},straightDistanceBetween:function(t,e,i,n){return Math.abs(t-i)+Math.abs(e-n)},distanceBetween:d,distanceFromTo:function(t,e){return d(l(t),u(t),l(e),u(e))},calcRadius:g,dirBetween:_,dirFromTo:function(t,e){return _(l(t),u(t),l(e),u(e))},dirIndex:function(t){const e=l(t),i=u(t);return o.findIndex((t=>t[0]==e&&t[1]==i))},isOppositeDir:function(t,e){return Math.sign(t[0])+Math.sign(e[0])==0&&Math.sign(t[1])+Math.sign(e[1])==0},isSameDir:function(t,e){return Math.sign(t[0])==Math.sign(e[0])&&Math.sign(t[1])==Math.sign(e[1])},dirSpread:function(t){const e=[t];return 0==t[0]?(e.push([1,t[1]]),e.push([-1,t[1]])):0==t[1]?(e.push([t[0],1]),e.push([t[0],-1])):(e.push([t[0],0]),e.push([0,t[1]])),e},stepFromTo:function(t,e,i){const n=l(t),s=u(t),r=[l(e)-n,u(e)-s],h=Math.abs(r[0])+Math.abs(r[1]),o=[0,0],a=[99999,99999];for(let t=0;t<=h;++t)o[0]=n+Math.floor(r[0]*t/h),o[1]=s+Math.floor(r[1]*t/h),o[0]==a[0]&&o[1]==a[1]||i(o[0],o[1]),a[0]=o[0],a[1]=o[1]},forLine:function(t,e,i,n,s){for(let r=0;r<n;++r)s(t+r*i[0],e+r*i[1])},forLineBetween:E,getLine:function(t,e,i,n){const s=[];return E(t,e,i,n,((t,e)=>{s.push([t,e])})),s},getLineThru:function(t,e,i,n,s,r){const h=[];return E(t,e,i,n,((t,e)=>{if(t<0||e<0||t>=s||e>=r)return!1;h.push([t,e])})),h},forCircle:m,forRect:y,forBorder:function(...t){let e=0,i=0;arguments.length>3&&(e=t.shift(),i=t.shift());const n=e+t[0]-1,s=i+t[1]-1,r=t[2];for(let t=e;t<=n;++t)r(t,i),r(t,s);for(let t=i;t<=s;++t)r(e,t),r(n,t)},arcCount:b});function A(t,e){let i=0;for(;t;){const n=t.next;e(t,i++),t=n}return i}function w(t,e,i){return i.next=t[e]||null,t[e]=i,!0}function S(t,e,i){const n=t[e];if(n===i)return t[e]=i.next||null,i.next=null,!0;if(!n)return!1;{let t=n,e=t.next;for(;e&&e!==i;)t=e,e=t.next;if(e===i)return t.next=e.next,i.next=null,!0}return!1}var T=Object.freeze({__proto__:null,length:function(t){let e=0;for(;t;)e+=1,t=t.next;return e},at:function(t,e){for(;t&&e;)t=t.next,--e;return t},includes:function(t,e){for(;t&&t!==e;)t=t.next;return t===e},forEach:A,push:w,remove:S,find:function(t,e){for(;t&&!e(t);)t=t.next;return t},insert:function(t,e,i,n){let s=t[e];if(n=n||(()=>-1),!s||n(s,i)<0)return i.next=s,t[e]=i,!0;let r=s,h=s.next;for(;h&&n(h,i)>0;)r=h,h=h.next;return i.next=h,r.next=i,!0},reduce:function(t,e,i){let n=t;if(void 0===i){if(!n)throw new TypeError("Empty list reduce without initial value not allowed.");i=n,n=n.next}for(;n;)i=e(i,n),n=n.next;return i},some:function(t,e){let i=t;for(;i;){if(e(i))return!0;i=i.next}return!1},every:function(t,e){let i=t;for(;i;){if(!e(i))return!1;i=i.next}return!0}});function v(t,e,i){const n=t[i],s=e[i];n&&n.copy&&s?n.copy(s):n&&n.clear&&!s?n.clear():n&&n.nullify&&!s?n.nullify():s&&s.clone?t[i]=s.clone():s&&Array.isArray(s)?t[i]=s.slice():n&&Array.isArray(n)?n.length=0:t[i]=s}function x(t,e,i=null){let n;e&&Object.keys(e).forEach((r=>{const h=r;let o=e[r];n=t;const a=r.split(".");for(;a.length>1;)r=a.shift(),void 0===n[r]?n=n[r]={}:"object"!=typeof n[r]?s("Trying to set default member on non-object config item: "+h):n=n[r];r=a.shift();let l=n[r];i&&i(n,r,l,o)||void 0===l&&(null===o?n[r]=null:Array.isArray(o)?n[r]=o.slice():n[r]=o)}))}var C=Object.freeze({__proto__:null,copyObject:function(t,e){Object.keys(t).forEach((i=>{v(t,e,i)}))},assignObject:function(t,e){Object.keys(e).forEach((i=>{v(t,e,i)}))},assignOmitting:function(t,e,i){"string"==typeof t&&(t=t.split(/[,|]/g).map((t=>t.trim()))),Object.keys(i).forEach((n=>{t.includes(n)||v(e,i,n)}))},setDefault:function(t,e,i){void 0===t[e]&&(t[e]=i)},setDefaults:x,setOptions:function(t,e){x(t,e,((t,e,i,n)=>(null===n?t[e]=null:Array.isArray(n)?t[e]=n.slice():t[e]=n,!0)))},kindDefaults:function(t,e){return x(t,e,(function(t,e,i,n){return!(e.search(/[fF]lags$/)<0)&&(i?"string"==typeof i?i=i.split(/[,|]/).map((t=>t.trim())):Array.isArray(i)||(i=[i]):i=[],"string"==typeof n?n=n.split(/[,|]/).map((t=>t.trim())):Array.isArray(n)||(n=[n]),t[e]=n.concat(i),!0)}))},pick:function(t,...e){const i={};return e.forEach((e=>{const n=t[e];void 0!==n&&(i[e]=n)})),i},clearObject:function(t){Object.keys(t).forEach((e=>t[e]=void 0))},getOpt:function(t,e,i){const n=t[e];return void 0===n?i:n},firstOpt:function(t,...e){for(let i of e){if("object"!=typeof i||Array.isArray(i))return i;if(void 0!==i[t])return i[t]}}});function L(t){t=Math.abs(t||Date.now());const e=2.3283064365386963e-10;let i=0,n=0,s=0,r=0;return i=((t=t<1?1/t:t)>>>0)*e,n=(t=69069*t+1>>>0)*e,s=(t=69069*t+1>>>0)*e,r=1,function(){let t=2091639*i+r*e;return i=n,n=s,r=0|t,s=t-r,s}}const R={make:L};function N(t,e){let i,n,s;for(n=0,i=0;i<e.length;i++)n+=e[i];if(n<=0)return-1;for(s=t.range(0,n-1),i=0;i<e.length;i++){if(e[i]>s)return i;s-=e[i]}return console.warn("Lottery Draw failed.",e,e.length),0}class D{constructor(t){this._fn=R.make(t)}seed(t){t=t||Date.now(),this._fn=R.make(t)}value(){return this._fn()}float(){return this.value()}number(t=Number.MAX_SAFE_INTEGER){return t<=0?0:Math.floor(this.value()*t)}int(t=0){return this.number(t)}range(t,e){if(e<=t)return e;const i=e-t+1;return t+this.number(i)}dice(t,e,i=0){let n=0,s=1;t<0&&(t=-t,s=-1),i=i||0;for(let i=0;i<t;++i)n+=this.range(1,e);return n*=s,n+i}weighted(t){return Array.isArray(t)?N(this,t):function(t,e){const i=Object.entries(e),n=N(t,i.map((([t,e])=>e)));return n<0?-1:i[n][0]}(this,t)}item(t){return Array.isArray(t)||(t=Object.values(t)),t[this.range(0,t.length-1)]}key(t){return this.item(Object.keys(t))}shuffle(t,e=0,i=0){let n,s,r;for(2==arguments.length&&(i=e,e=0),i=i||t.length,n=e=e||0;n<i;n++)s=this.range(e,i-1),n!=s&&(r=t[s],t[s]=t[n],t[n]=r);return t}sequence(t){const e=[];for(let i=0;i<t;i++)e[i]=i;return this.shuffle(e)}chance(t,e=100){return!(t<=0)&&(t>=e||this.number(e)<t)}clumped(t,e,i){if(e<=t)return t;if(i<=1)return this.range(t,e);let n,s=0,r=Math.floor((e-t)/i);for(n=0;n<(e-t)%i;n++)s+=this.range(0,r+1);for(;n<i;n++)s+=this.range(0,r);return s+t}matchingLoc(t,e,i){let n,s,r,h=0;if(h=0,y(t,e,((t,e)=>{i(t,e)&&h++})),0==h)return[-1,-1];for(r=this.range(0,h-1),n=0;n<t&&r>=0;n++)for(s=0;s<e&&r>=0;s++)if(i(n,s)){if(0==r)return[n,s];r--}return[-1,-1]}matchingLocNear(t,e,i){let n,s,r,h,o,a=[-1,-1];for(h=0,r=0;r<50&&!h;r++)for(n=t-r;n<=t+r;n++)for(s=e-r;s<=e+r;s++)n!=t-r&&n!=t+r&&s!=e-r&&s!=e+r||!i(n,s)||h++;if(0==h)return[-1,-1];for(o=1+this.number(h),r=0;r<50;r++)for(n=t-r;n<=t+r;n++)for(s=e-r;s<=e+r;s++)if((n==t-r||n==t+r||s==e-r||s==e+r)&&i(n,s)&&0==--o)return a[0]=n,a[1]=s,a;return[-1,-1]}}const M=new D,O=new D;var V=Object.freeze({__proto__:null,Alea:L,configure:function(t={}){t.make&&(R.make=t.make,M.seed(),O.seed())},Random:D,random:M,cosmetic:O,make:function(t){return new D(t)}});class k{constructor(t,e=0,i=1){Array.isArray(t)&&(i=t[2],e=t[1],t=t[0]),e<t&&([e,t]=[t,e]),this.lo=t||0,this.hi=e||this.lo,this.clumps=i||1}value(t){return(t=t||M).clumped(this.lo,this.hi,this.clumps)}contains(t){return this.lo<=t&&this.hi>=t}copy(t){return this.lo=t.lo,this.hi=t.hi,this.clumps=t.clumps,this}toString(){return this.lo>=this.hi?""+this.lo:`${this.lo}-${this.hi}`}}function B(t){if(!t)return new k(0,0,0);if(t instanceof k)return t;if("function"==typeof t)throw new Error("Custom range functions not supported - extend Range");if(null==t)return new k(0,0,0);if("number"==typeof t)return new k(t,t,1);if(!0===t||!1===t)throw new Error("Invalid random config: "+t);if(Array.isArray(t))return new k(t[0],t[1],t[2]);if("string"!=typeof t)throw new Error("Calculations must be strings.  Received: "+JSON.stringify(t));if(0==t.length)return new k(0,0,0);const e=/^(?:([+-]?\d*)[Dd](\d+)([+-]?\d*)|([+-]?\d+)-(\d+):?(\d+)?|([+-]?\d+)~(\d+)|([+-]?\d+)\+|([+-]?\d+))$/g;let i;for(;null!==(i=e.exec(t));){if(i[2]){let t=Number.parseInt(i[1])||1;const e=Number.parseInt(i[2]),n=Number.parseInt(i[3])||0;return new k(n+t,n+t*e,t)}if(i[4]&&i[5]){const t=Number.parseInt(i[4]),e=Number.parseInt(i[5]),n=Number.parseInt(i[6]);return new k(t,e,n)}if(i[7]&&i[8]){const t=Number.parseInt(i[7]),e=Number.parseInt(i[8]);return new k(t-2*e,t+2*e,3)}if(i[9]){const t=Number.parseInt(i[9]);return new k(t,Number.MAX_SAFE_INTEGER,1)}if(i[10]){const t=Number.parseInt(i[10]);return new k(t,t,1)}}throw new Error("Not a valid range - "+t)}const H=B;var W=Object.freeze({__proto__:null,Range:k,make:B,from:H,asFn:function(t){const e=B(t);return()=>e.value()}});function F(t){return 1<<t}function P(t,...e){let i=0;for(let n=0;n<e.length;++n){let s=e[n];void 0!==s&&("number"!=typeof s?("string"==typeof s&&(s=s.split(/[,|]/).map((t=>t.trim())).map((t=>{const e=Number.parseInt(t);return e>=0?e:t}))),Array.isArray(s)&&s.forEach((e=>{if("string"==typeof e){const n=(e=e.trim()).split(/[,|]/);if(n.length>1)i=P(t,i,n);else if(e.startsWith("!")){const n=t[e.substring(1)];i&=~n}else{const n=Number.parseInt(e);if(n>=0)return void(i|=n);const s=t[e];s&&(i|=s)}}else 0===e?i=0:i|=e}))):i|=s)}return i}var Y=Object.freeze({__proto__:null,fl:F,toString:function(t,e){const i=Object.entries(t).reduce(((t,e)=>{const[i,n]=e;return"number"==typeof n&&(t[n]?t[n]+=" | "+i:t[n]=i),t}),[]),n=[];for(let t=0;t<32;++t){const s=1<<t;e&s&&n.push(i[s])}return n.join(" | ")},from:P,make:function(t){const e={};return Object.entries(t).forEach((([t,i])=>{e[t]=P(e,i)})),e}});const U=o;function G(t,e){if(void 0===e)return new Array(t).fill(0);let i;i="function"!=typeof e?()=>e:e;const n=new Array(t);for(let e=0;e<t;++e)n[e]=i(e);return n}function X(t){return!1===t?" ":!0===t?"T":t<10?""+t:t<36?String.fromCharCode("a".charCodeAt(0)+t-10):t<62?String.fromCharCode("A".charCodeAt(0)+t-10-26):"string"==typeof t?t[0]:"#"}class K extends Array{constructor(t,e,i){super(t);const n=this;for(let s=0;s<t;++s)this[s]="function"==typeof i?new Array(e).fill(0).map(((t,e)=>i(s,e,n))):new Array(e).fill(i);this._width=t,this._height=e}get width(){return this._width}get height(){return this._height}get(t,e){if(this.hasXY(t,e))return this[t][e]}set(t,e,i){return!!this.hasXY(t,e)&&(this[t][e]=i,!0)}forEach(t){let e,i;for(e=0;e<this.width;e++)for(i=0;i<this.height;i++)t(this[e][i],e,i,this)}async forEachAsync(t){let e,i;for(e=0;e<this.width;e++)for(i=0;i<this.height;i++)await t(this[e][i],e,i,this)}eachNeighbor(t,e,i,n=!1){f(t,e,((t,e)=>{this.hasXY(t,e)&&i(this[t][e],t,e,this)}),n)}async eachNeighborAsync(t,e,i,n=!1){const s=n?4:8;for(let n=0;n<s;++n){const s=U[n],r=t+s[0],h=e+s[1];this.hasXY(r,h)&&await i(this[r][h],r,h,this)}}forRect(t,e,i,n,s){y(t,e,i,n,((t,e)=>{this.hasXY(t,e)&&s(this[t][e],t,e,this)}))}randomEach(t){const e=M.sequence(this.width*this.height);for(let i=0;i<e.length;++i){const n=e[i],s=n%this.width,r=Math.floor(n/this.width);if(!0===t(this[s][r],s,r,this))return!0}return!1}map(t){const e=new this.constructor(this.width,this.height);return e.copy(this),e.update(t),e}some(t){return super.some(((e,i)=>e.some(((e,n)=>t(e,i,n,this)))))}forCircle(t,e,i,n){m(t,e,i,((t,e)=>{this.hasXY(t,e)&&n(this[t][e],t,e,this)}))}hasXY(t,e){return t>=0&&e>=0&&t<this.width&&e<this.height}isBoundaryXY(t,e){return this.hasXY(t,e)&&(0==t||t==this.width-1||0==e||e==this.height-1)}calcBounds(){const t={left:this.width,top:this.height,right:0,bottom:0};return this.forEach(((e,i,n)=>{e&&(t.left>i&&(t.left=i),t.right<i&&(t.right=i),t.top>n&&(t.top=n),t.bottom<n&&(t.bottom=n))})),t}update(t){y(this.width,this.height,((e,i)=>{this[e][i]=t(this[e][i],e,i,this)}))}updateRect(t,e,i,n,s){y(t,e,i,n,((t,e)=>{this.hasXY(t,e)&&(this[t][e]=s(this[t][e],t,e,this))}))}updateCircle(t,e,i,n){m(t,e,i,((t,e)=>{this.hasXY(t,e)&&(this[t][e]=n(this[t][e],t,e,this))}))}fill(t){const e="function"==typeof t?t:()=>t;this.update(e)}fillRect(t,e,i,n,s){const r="function"==typeof s?s:()=>s;this.updateRect(t,e,i,n,r)}fillCircle(t,e,i,n){const s="function"==typeof n?n:()=>n;this.updateCircle(t,e,i,s)}replace(t,e){this.update((i=>i==t?e:i))}copy(t){this.update(((e,i,n)=>t[i][n]))}count(t){const e="function"==typeof t?t:e=>e==t;let i=0;return this.forEach(((t,n,s)=>{e(t,n,s,this)&&++i})),i}find(t){const e="function"==typeof t?t:e=>e==t;for(let t=0;t<this.width;++t)for(let i=0;i<this.height;++i){if(e(this[t][i],t,i,this))return[t,i]}return null}dump(t,e=console.log){this.dumpRect(0,0,this.width,this.height,t,e)}dumpRect(t,e,i,s,r,h=console.log){let o,a;r=r||X,t=n(t,0,this.width-2),e=n(e,0,this.height-2);const l=n(t+i,1,this.width-1),u=n(e+s,1,this.height-1);let c=[];for(a=e;a<=u;a++){let e=(a+"]").padStart(3," ");for(o=t;o<=l;o++){o%10==0&&(e+=" ");e+=r(this[o][a],o,a)[0]}c.push(e)}h(c.join("\n"))}dumpAround(t,e,i,n,s=console.log){this.dumpRect(t-i,e-i,2*i,2*i,n,s)}closestMatchingLoc(t,e,i){let n=[-1,-1],s=100*(this.width+this.height);const r="function"==typeof i?i:t=>t==i;return this.forEach(((i,h,o)=>{if(r(i,h,o,this)){const i=Math.floor(100*d(t,e,h,o));i<s?(n[0]=h,n[1]=o,s=i):i==s&&M.chance(50)&&(n[0]=h,n[1]=o)}})),n}firstMatchingLoc(t){const e="function"==typeof t?t:e=>e==t;for(let t=0;t<this.width;++t)for(let i=0;i<this.height;++i)if(e(this[t][i],t,i,this))return[t,i];return[-1,-1]}randomMatchingLoc(t){const e="function"==typeof t?(e,i)=>t(this[e][i],e,i,this):(e,i)=>this.get(e,i)===t;return M.matchingLoc(this.width,this.height,e)}matchingLocNear(t,e,i){const n="function"==typeof i?(t,e)=>i(this[t][e],t,e,this):(t,e)=>this.get(t,e)===i;return M.matchingLocNear(t,e,n)}arcCount(t,e,i){return b(t,e,((t,e)=>this.hasXY(t,e)&&i(this[t][e],t,e,this)))}}const j=[],z={active:0,alloc:0,create:0,free:0};class $ extends K{constructor(t,e,i=0){super(t,e,i)}static alloc(...t){let e=t[0]||0,i=t[1]||0,n=t[2]||0;if(1==t.length&&(e=t[0].width,i=t[0].height,n=t[0].get.bind(t[0])),!e||!i)throw new Error("Grid alloc requires width and height parameters.");++z.active,++z.alloc;let s=j.pop();return s?(s._resize(e,i,n),s):(++z.create,new $(e,i,n))}static free(t){if(t){if(j.indexOf(t)>=0)return;j.push(t),++z.free,--z.active}}_resize(t,e,i){const n="function"==typeof i?i:()=>i;for(;this.length<t;)this.push([]);this.length=t;let s=0,r=0;for(s=0;s<t;++s){const t=this[s];for(r=0;r<e;++r)t[r]=n(s,r,this);t.length=e}this._width=t,this._height=e,void 0!==this.x&&(this.x=void 0,this.y=void 0)}findReplaceRange(t,e,i){this.update((n=>n>=t&&n<=e?i:n))}floodFillRange(t,e,i,n,s){let r,h,o,a=1;if(s>=i&&s<=n)throw new Error("Invalid grid flood fill");const l=(t,e)=>this.hasXY(t,e)&&this[t][e]>=i&&this[t][e]<=n;if(!l(t,e))return 0;for(this[t][e]=s,r=0;r<4;r++)h=t+U[r][0],o=e+U[r][1],l(h,o)&&(a+=this.floodFillRange(h,o,i,n,s));return a}invert(){this.update((t=>t?0:1))}leastPositiveValue(){let t=Number.MAX_SAFE_INTEGER;return this.forEach((e=>{e>0&&e<t&&(t=e)})),t}randomLeastPositiveLoc(){const t=this.leastPositiveValue();return this.randomMatchingLoc(t)}valueBounds(t,e){let i,n,s=!1,r=this.width-1,h=0,o=this.height-1,a=0;for(i=0;i<this.width;i++){for(s=!1,n=0;n<this.height;n++)if(this[i][n]==t){s=!0;break}s&&(i<r&&(r=i),i>h&&(h=i))}for(n=0;n<this.height;n++){for(s=!1,i=0;i<this.width;i++)if(this[i][n]==t){s=!0;break}s&&(n<o&&(o=n),n>a&&(a=n))}return(e=e||new c(0,0,0,0)).x=r,e.y=o,e.width=h-r+1,e.height=a-o+1,e}floodFill(t,e,i,n){const s="function"==typeof i?i:t=>t==i,r="function"==typeof n?n:()=>n;let h,o,a=$.alloc(this.width,this.height);const l=[[t,e]],u=[];let c=1;for(;l.length;){const i=l.pop();if([t,e]=i,u.push(i),this.hasXY(t,e)&&!a[t][e]&&s(this[t][e],t,e,this)){this[t][e]=r(this[t][e],t,e,this),a[t][e]=1,++c;for(let i=0;i<4;i++){h=t+U[i][0],o=e+U[i][1];const n=u.pop()||[-1,-1];n[0]=h,n[1]=o,l.push(n)}}}return $.free(a),c}}const q=$.alloc.bind($),Z=$.free.bind($);function J(t,e,i){return void 0===i?new $(t,e,0):"number"==typeof i?new $(t,e,i):new K(t,e,i)}var Q=Object.freeze({__proto__:null,makeArray:G,Grid:K,stats:z,NumGrid:$,alloc:q,free:Z,make:J,offsetZip:function(t,e,i,n,s){const r="function"==typeof s?s:(e,i,n,r)=>t[n][r]=s;e.forEach(((s,h,o)=>{const a=h+i,l=o+n;t.hasXY(a,l)&&s&&r(t[a][l],s,a,l,h,o,t,e)}))},intersection:function(t,e,i){i=i||t,t.update(((t,n,s)=>e[n][s]&&i[n][s]||0))},unite:function(t,e,i){i=i||t,t.update(((t,n,s)=>i[n][s]||e[n][s]))}});function tt(t,e,i,n){return n?((t=Math.max(0,Math.min(255,Math.round(2.550001*t))))<<16)+((e=Math.max(0,Math.min(255,Math.round(2.550001*e))))<<8)+(i=Math.max(0,Math.min(255,Math.round(2.550001*i)))):((t=Math.max(0,Math.min(15,Math.round(t/100*15))))<<8)+((e=Math.max(0,Math.min(15,Math.round(e/100*15))))<<4)+(i=Math.max(0,Math.min(15,Math.round(i/100*15))))}const et={};class it{constructor(t=-1,e=0,i=0,n=0,s=0,r=0,h=0,o=!1){this.dances=!1,this._const=!1,this._data=new Int16Array([t,e,i,n,s,r,h]),this.dances=o}get r(){return Math.round(2.550001*this._data[0])}get _r(){return this._data[0]}set _r(t){this._data[0]=t}get g(){return Math.round(2.550001*this._data[1])}get _g(){return this._data[1]}set _g(t){this._data[1]=t}get b(){return Math.round(2.550001*this._data[2])}get _b(){return this._data[2]}set _b(t){this._data[2]=t}get _rand(){return this._data[3]}get _redRand(){return this._data[4]}get _greenRand(){return this._data[5]}get _blueRand(){return this._data[6]}get l(){return Math.round(.5*(Math.min(this._r,this._g,this._b)+Math.max(this._r,this._g,this._b)))}get s(){return this.l>=100?0:Math.round((Math.max(this._r,this._g,this._b)-Math.min(this._r,this._g,this._b))*(100-Math.abs(2*this.l-100))/100)}get h(){let t=0,e=this.r,i=this.g,n=this.b;return t=e>=i&&i>=n?(i-n)/(e-n)*60:i>e&&e>=n?60*(2-(e-n)/(i-n)):i>=n&&n>e?60*(2+(n-e)/(i-e)):n>i&&i>e?60*(4-(i-e)/(n-e)):n>e&&e>=i?60*(4+(e-i)/(n-i)):60*(6-(n-i)/(e-i)),Math.round(t)}isNull(){return this._r<0}isConst(){return this._const}equals(t){if("string"==typeof t)return t.startsWith("#")?this.css(t.length>4)==t:this.name==t;if("number"==typeof t)return this.toInt()==t||this.toInt(!0)==t;const e=at(t);return this.isNull()?e.isNull():this._data.every(((t,i)=>t==e._data[i]))}copy(t){if(this.isConst())return this.clone().copy(t);if(t instanceof it?this.dances=t.dances:Array.isArray(t)?8===t.length&&(this.dances=t[7]):(t=at(t),this.dances=t.dances),t instanceof it){this.name=t.name;for(let e=0;e<this._data.length;++e)this._data[e]=t._data[e]||0}else{for(let e=0;e<this._data.length;++e)this._data[e]=t[e]||0;this._changed()}return this}set(t){return this.isConst()?this.clone().set(t):this.copy(t)}_changed(){return this.name=void 0,this}clone(){const t=new this.constructor;return t.copy(this),t}assign(t=-1,e=0,i=0,n=0,s=0,r=0,h=0,o){if(this.isConst())return this.clone().assign(...arguments);for(let t=0;t<this._data.length;++t)this._data[t]=arguments[t]||0;return void 0!==o&&(this.dances=o),this._changed()}assignRGB(t=-1,e=0,i=0,n=0,s=0,r=0,h=0,o){if(this.isConst())return this.clone().assignRGB(...arguments);for(let t=0;t<this._data.length;++t)this._data[t]=Math.round((arguments[t]||0)/2.55);return void 0!==o&&(this.dances=o),this._changed()}nullify(){return this.isConst()?this.clone().nullify():(this._data[0]=-1,this.dances=!1,this._changed())}blackOut(){if(this.isConst())return this.clone().blackOut();for(let t=0;t<this._data.length;++t)this._data[t]=0;return this.dances=!1,this._changed()}toInt(t=!1){if(this.isNull())return-1;if(!this.dances)return tt(this._r,this._g,this._b,t);const e=O.number(this._rand),i=O.number(this._redRand),n=O.number(this._greenRand),s=O.number(this._blueRand);return tt(this._r+e+i,this._g+e+n,this._b+e+s,t)}toLight(){return[this._r,this._g,this._b]}clamp(){return this.isNull()?this:this.isConst()?this.clone().clamp():(this._r=Math.min(100,Math.max(0,this._r)),this._g=Math.min(100,Math.max(0,this._g)),this._b=Math.min(100,Math.max(0,this._b)),this._changed())}mix(t,e){if(this.isConst())return this.clone().mix(t,e);const i=at(t);if(i.isNull())return this;this.isNull()&&this.blackOut();const n=100-(e=Math.min(100,Math.max(0,e)));for(let t=0;t<this._data.length;++t)this._data[t]=Math.round((this._data[t]*n+i._data[t]*e)/100);return this.dances=this.dances||i.dances,this._changed()}lighten(t){if(this.isNull())return this;if(this.isConst())return this.clone().lighten(t);if((t=Math.min(100,Math.max(0,t)))<=0)return this;const e=100-t;for(let i=0;i<3;++i)this._data[i]=Math.round((this._data[i]*e+100*t)/100);return this._changed()}darken(t){if(this.isNull())return this;if(this.isConst())return this.clone().darken(t);if((t=Math.min(100,Math.max(0,t)))<=0)return this;const e=100-t;for(let i=0;i<3;++i)this._data[i]=Math.round((this._data[i]*e+0*t)/100);return this._changed()}bake(t=!1){if(this.isNull())return this;if(this.isConst())return this.clone().bake(t);if(this.dances&&!t)return this;this.dances=!1;const e=this._data;if(e[3]+e[4]+e[5]+e[6]){const t=O.number(this._rand),i=O.number(this._redRand),n=O.number(this._greenRand),s=O.number(this._blueRand);this._r+=t+i,this._g+=t+n,this._b+=t+s;for(let t=3;t<e.length;++t)e[t]=0;return this._changed()}return this}add(t,e=100){if(this.isConst())return this.clone().add(t,e);const i=at(t);if(i.isNull())return this;this.isNull()&&this.blackOut();for(let t=0;t<this._data.length;++t)this._data[t]+=Math.round(i._data[t]*e/100);return this.dances=this.dances||i.dances,this._changed()}scale(t){if(this.isNull()||100==t)return this;if(this.isConst())return this.clone().scale(t);t=Math.max(0,t);for(let e=0;e<this._data.length;++e)this._data[e]=Math.round(this._data[e]*t/100);return this._changed()}multiply(t){if(this.isNull())return this;if(this.isConst())return this.clone().multiply(t);let e;if(Array.isArray(t))e=t;else{if(t.isNull())return this;e=t._data}const i=Math.max(3,Math.min(this._data.length,e.length));for(let t=0;t<i;++t)this._data[t]=Math.round(this._data[t]*(e[t]||0)/100);return this._changed()}normalize(){if(this.isNull())return this;if(this.isConst())return this.clone().normalize();const t=Math.max(this._r,this._g,this._b);return t<=100?this:(this._r=Math.round(100*this._r/t),this._g=Math.round(100*this._g/t),this._b=Math.round(100*this._b/t),this._changed())}css(t=!1){const e=this.toInt(t);return e<0?"transparent":"#"+e.toString(16).padStart(t?6:3,"0")}toString(t=!1){return this.name?this.name:this.isNull()?"null color":this.css(t)}}function nt(t,e=!1){for(;t.length<3;)t.push(0);if(e)for(let e=0;e<7;++e)t[e]=Math.round(100*(t[e]||0)/255);return new it(...t)}function st(t){if(!t.startsWith("#"))throw new Error('Color CSS strings must be of form "#abc" or "#abcdef" - received: ['+t+"]");const e=Number.parseInt(t.substring(1),16);let i,n,s;return 4==t.length?(i=Math.round((e>>8)/15*100),n=Math.round(((240&e)>>4)/15*100),s=Math.round((15&e)/15*100)):(i=Math.round((e>>16)/255*100),n=Math.round(((65280&e)>>8)/255*100),s=Math.round((255&e)/255*100)),new it(i,n,s)}function rt(t){const e=et[t];if(!e)throw new Error("Unknown color name: "+t);return e}function ht(t,e=!1){const i=new it(0,0,0);return t<0?i.assign(-1):e||t>4095?i.assign(Math.round(100*((16711680&t)>>16)/255),Math.round(100*((65280&t)>>8)/255),Math.round(100*(255&t)/255)):i.assign(Math.round(100*((3840&t)>>8)/15),Math.round(100*((240&t)>>4)/15),Math.round(100*(15&t)/15)),i}function ot(...t){let e=t[0],i=t[1];if(0==t.length)return new it;if(t.length>2&&(e=t,i=!1),null==e)return new it(-1);if(e instanceof it)return e.clone();if("string"==typeof e)return e.startsWith("#")?st(e):rt(e).clone();if(Array.isArray(e))return nt(e,i);if("number"==typeof e)return ht(e,i);throw new Error("Failed to make color - unknown argument: "+JSON.stringify(e))}function at(...t){const e=t[0];return e instanceof it?e:void 0===e?new it(-1):"string"!=typeof e||e.startsWith("#")?ot(e,t[1]):rt(e)}function lt(t,e){if(t.isNull()||e.isNull())return;const i=t.clone().clamp(),n=e.clone().clamp();let s=Math.abs(i.h-n.h);if(s>180&&(s=360-s),s>45)return;if(Math.abs(i.l-n.l)>=40)return;const[r,h]=[i,n].sort(((t,e)=>t.s-e.s));for(;h.l-r.l<40;)h.mix(gt,5),r.mix(dt,5);t.copy(i),e.copy(n)}function ut(t,...e){let i=e;1==e.length&&(i=e[0]);const n=i instanceof it?i:ot(i);return n._const=!0,et[t]=n,n.name=t,n}function ct(t,...e){let i;return i=1==e.length?ut(t,e[0]):ut(t,...e),ut("light_"+t,i.clone().lighten(25)),ut("lighter_"+t,i.clone().lighten(50)),ut("lightest_"+t,i.clone().lighten(75)),ut("dark_"+t,i.clone().darken(25)),ut("darker_"+t,i.clone().darken(50)),ut("darkest_"+t,i.clone().darken(75)),i}const ft=ut("NONE",-1),dt=ut("black",0),gt=ut("white",4095);ct("teal",[30,100,100]),ct("brown",[60,40,0]),ct("tan",[80,70,55]),ct("pink",[100,60,66]),ct("gray",[50,50,50]),ct("yellow",[100,100,0]),ct("purple",[100,0,100]),ct("green",[0,100,0]),ct("orange",[100,50,0]),ct("blue",[0,0,100]),ct("red",[100,0,0]),ct("amber",[100,75,0]),ct("flame",[100,25,0]),ct("fuchsia",[100,0,100]),ct("magenta",[100,0,75]),ct("crimson",[100,0,25]),ct("lime",[75,100,0]),ct("chartreuse",[50,100,0]),ct("sepia",[50,40,25]),ct("violet",[50,0,100]),ct("han",[25,0,100]),ct("cyan",[0,100,100]),ct("turquoise",[0,100,75]),ct("sea",[0,100,50]),ct("sky",[0,75,100]),ct("azure",[0,50,100]),ct("silver",[75,75,75]),ct("gold",[100,85,0]);var _t=Object.freeze({__proto__:null,colors:et,Color:it,fromArray:nt,fromCss:st,fromName:rt,fromNumber:ht,make:ot,from:at,separate:lt,swap:function(t,e){const i=t.clone();t.copy(e),e.copy(i)},relativeLuminance:function(t,e){return Math.round(100*((t.r-e.r)*(t.r-e.r)*.2126+(t.g-e.g)*(t.g-e.g)*.7152+(t.b-e.b)*(t.b-e.b)*.0722)/65025)},distance:function(t,e){return Math.round(100*((t.r-e.r)*(t.r-e.r)*.3333+(t.g-e.g)*(t.g-e.g)*.3333+(t.b-e.b)*(t.b-e.b)*.3333)/65025)},smoothScalar:function(t,e=255){return Math.floor(100*Math.sin(Math.PI*t/e))},install:ut,installSpread:ct,NONE:ft});class pt{constructor(t){this.ch=r(null==t?void 0:t.ch,-1),this.fg=ot(null==t?void 0:t.fg),this.bg=ot(null==t?void 0:t.bg)}_changed(){return this}copy(t){return this.ch=t.ch||-1,this.fg.copy(t.fg||-1),this.bg.copy(t.bg||-1),this._changed()}clone(){const t=new pt;return t.copy(this),t}equals(t){return this.ch==t.ch&&this.fg.equals(t.fg)&&this.bg.equals(t.bg)}get dances(){return this.fg.dances||this.bg.dances}nullify(){return this.ch=-1,this.fg.nullify(),this.bg.nullify(),this._changed()}blackOut(){return this.ch=-1,this.fg.blackOut(),this.bg.blackOut(),this._changed()}draw(t=-1,e=-1,i=-1){return t&&-1!==t&&(this.ch=t),-1!==e&&null!==e&&(e=at(e),this.fg.copy(e)),-1!==i&&null!==i&&(i=at(i),this.bg.copy(i)),this._changed()}drawSprite(t,e){return t===this?this:(void 0===e&&(e=t.opacity),void 0===e&&(e=100),e<=0?void 0:(t.ch&&(this.ch=t.ch),(t.fg&&-1!==t.fg||0===t.fg)&&this.fg.mix(t.fg,e),(t.bg&&-1!==t.bg||0===t.bg)&&this.bg.mix(t.bg,e),this._changed()))}invert(){return[this.bg,this.fg]=[this.fg,this.bg],this._changed()}multiply(t,e=!0,i=!0){return t=at(t),e&&this.fg.multiply(t),i&&this.bg.multiply(t),this._changed()}scale(t,e=!0,i=!0){return e&&this.fg.scale(t),i&&this.bg.scale(t),this._changed()}mix(t,e=50,i=e){return t=at(t),e>0&&this.fg.mix(t,e),i>0&&this.bg.mix(t,i),this._changed()}add(t,e=100,i=e){return t=at(t),e>0&&this.fg.add(t,e),i>0&&this.bg.add(t,i),this._changed()}separate(){return lt(this.fg,this.bg),this._changed()}bake(t=!1){return this.fg.bake(t),this.bg.bake(t),this._changed(),{ch:this.ch,fg:this.fg.toInt(),bg:this.bg.toInt()}}toString(){return`{ ch: ${this.ch}, fg: ${this.fg.toString(!0)}, bg: ${this.bg.toString(!0)} }`}}var Et={colorStart:"Ω",colorEnd:"∆",field:"§",defaultFg:null,defaultBg:null},mt={default:(t,e,i)=>"",debug:(t,e,i)=>void 0!==i?`${i}.!!${t}!!`:`!!${t}!!`};function yt(t,e={}){const i=e.field||Et.field,n=t.split(i).map(((t,n)=>n%2==0?It(t):0==t.length?It(i):function(t,e={}){const i=/((\w+) )?(\w+)(\.(\w+))?(%[\+\.\-\d]*[dsf])?/.exec(t)||[],n=i[2],s=i[3],r=i[5],h=i[6];let o=function(t,e=!1){return function(i){let n=mt[t];if(n)return n(t,i);const s=i[t];return void 0!==s?s:(n=e?mt.debug:mt.default,n(t,i))}}(s,e.debug);r&&r.length&&(o=function(t,e,i=!1){const n=i?mt.debug:mt.default;return function(i){const s=e(i);if(!s)return n(t,i,s);const r=s[t];return void 0===r?n(t,i,s):r}}(r,o,e.debug));n&&n.length&&(o=function(t,e,i=!1){const n=mt[t]||(i?mt.debug:mt.default);return function(i){const s=e(i);return n(t,i,s)}}(n,o,e.debug));h&&h.length&&(o=h.endsWith("s")?function(t,e){const i=/%(-?\d*)s/.exec(t)||[],n=Number.parseInt(i[1]||"0");return function(t){let i=""+e(t);return n<0?i=i.padEnd(-n):n&&(i=i.padStart(n)),i}}(h,o):h.endsWith("d")?function(t,e){const i=/%([\+-]*)(\d*)d/.exec(t)||["","","0"];let n=Number.parseInt(i[2]||"0");const s=i[1].includes("+"),r=i[1].includes("-");return function(t){const i=Number.parseInt(e(t)||0);let h=""+i;return i>0&&s&&(h="+"+h),n&&r?h.padEnd(n):n?h.padStart(n):h}}(h,o):function(t,e){const i=/%([\+-]*)(\d*)(\.(\d+))?f/.exec(t)||["","","0"];let n=Number.parseInt(i[2]||"0");const s=i[1].includes("+"),r=i[1].includes("-"),h=Number.parseInt(i[4])||0;return function(t){const i=Number.parseFloat(e(t)||0);let o;return o=h?i.toFixed(h):""+i,i>0&&s&&(o="+"+o),n&&r?o.padEnd(n):n?o.padStart(n):o}}(h,o));return o}(t,e)));return function(t={}){return"string"==typeof t&&(t={value:t}),n.map((e=>e(t))).join("")}}function bt(t,e={}){return yt(t)(e)}function It(t){return()=>t}function At(t,i,n={}){if(null==t)return;if(!i)return;if(!(t=""+t).length)return;const s=[],r=n.eachColor||e;let h=n.fg||Et.defaultFg,o=n.bg||Et.defaultBg;const a={fg:h,bg:o},l=n.colorStart||Et.colorStart,u=n.colorEnd||Et.colorEnd;r(a);let c=0;for(let e=0;e<t.length;++e){const n=t[e];if(n==l){let i=e+1;for(;i<t.length&&t[i]!=l;)++i;if(i==t.length)return void console.warn(`Reached end of string while seeking end of color start section.\n- text: ${t}\n- start @: ${e}`);if(i!=e+1){s.push([a.fg,a.bg]);const n=t.substring(e+1,i).split("|");a.fg=n[0]||a.fg,a.bg=n[1]||a.bg,r(a),e=i;continue}++e}else if(n==u){if(t[e+1]!=u){const t=s.pop();[a.fg,a.bg]=t||[h,o];continue}++e}i(n,a.fg,a.bg,c,e),++c}}function wt(t){if(!t||0==t.length)return 0;let e=0;const i=Et.colorStart,n=Et.colorEnd;for(let s=0;s<t.length;++s){const r=t[s];if(r==i){s=t.indexOf(i,s+1)}else r==n||++e}return e}let St=!1;function Tt(t,e,i){const n=Et.colorStart,s=Et.colorEnd;St=!1;let r=e;for(;i>0&&r<t.length;){const e=t[r];if(e===n){if(++r,t[r]===n)--i;else{for(;t[r]!==n;)++r;St=!0}++r}else e===s?(t[r+1]===s?(--i,++r):St=!1,++r):(--i,++r)}return r}function vt(t){const e=Et.colorStart,i=Et.colorEnd;let n=0;for(;n<t.length;){const s=t[n];if(s==e){for(++n;t[n]!=e&&n<t.length;)++n;++n}else if(s==i)for(++n;t[n]==i&&n<t.length;)++n;else{if(/[A-Za-z]/.test(s))return t.substring(0,n)+s.toUpperCase()+t.substring(n+1);++n}}return t}function xt(t,e){const i=Et.colorStart,n=Et.colorEnd;let s=e,r=0,h=!0;for(;s<t.length;){const e=t[s];if(" "==e){for(;" "==t[s+1];)++s,++r;return[s,r]}if("-"==e)return[s,r];if("\n"==e)return[s,r];if(e!=i)e!=n?(r+=h?1:0,++s):(t[s+1]==n&&(r+=1,++s),s++);else{if(t[s+1]==i&&h){r+=1,s+=2;continue}h=!h,++s}}return[s,r]}function Ct(t,e,i,n=""){return t.substring(0,e)+n+t.substring(e+i)}function Lt(t,e,i,n,s,r){for(;i<n;){if(r>=s)return[t,n];if(r<4&&s<=e)return[t=Ct(t,i-1,1,"\n"),n+1];if(s<r+e){return[t=Ct(t,Tt(t,i,r-1),0,"-\n"),n+2]}if(r<5){t=Ct(t,i-1,1,"\n"),r=e;continue}const h=Math.min(r-1,Math.floor(s/2)),o=Tt(t,i,h);t=Ct(t,o,0,"-\n"),i=o+2,n+=2,s-=h}return[t,n]}function Rt(t,e,i=0){if(!e)throw new Error("Need string and width");if(t.length<e)return t;if(wt(t)<e)return t;if(-1==t.indexOf("\n"))return Nt(t,e,i);return t.split("\n").map(((t,n)=>Nt(t,e,n?i:0))).join("\n")}function Nt(t,e,i){if(t.length<e)return t;if(wt(t)<e)return t;let n=e;e-=i;let s=t,r=!0,h=-1;for(;h<s.length;){let[t,i]=xt(s,h+(r?1:0)),o=!1;if("-"==s[t]&&(t++,i++,o=!0),i>e)[s,t]=Lt(s,e,h+1,t,i,n);else if(i==n){const i=o?0:1;s=Ct(s,t,i,t<s.length?"\n":""),t+=1-i,n=e}else if(i>n){const a=r?1:0;s=Ct(s,h,a,"\n"),t+=1-a;n=e-i-(o?0:1)}else{n-=i+(o?0:1)}r=!o,h=t}return s}function Dt(t,e=200,i=0){const n=Et.colorStart,s=[];if(!t)return s;e<=0&&(e=200);let r=Rt(t,e,i),h=0,o=null,a=null;At(r,((t,e,i,l,u)=>{if("\n"==t){let t=o||a?`${n}${o||""}${a?"|"+a:""}${n}`:"";s.push(t+r.substring(h,u)),h=u+1,o=e,a=i}}));let l=o||a?`${n}${o||""}${a?"|"+a:""}${n}`:"";return h<r.length&&s.push(l+r.substring(h)),s}var Mt=Object.freeze({__proto__:null,configure:function(t={}){void 0!==t.fg&&(Et.defaultFg=t.fg),void 0!==t.bg&&(Et.defaultBg=t.bg),t.colorStart&&(Et.colorStart=t.colorStart),t.colorEnd&&(Et.colorEnd=t.colorEnd),t.field&&(Et.field=t.field)},compile:yt,apply:bt,eachChar:At,wordWrap:Rt,splitIntoLines:Dt,addHelper:function(t,e){mt[t]=e},options:Et,length:wt,advanceChars:Tt,firstChar:function(t){const e=Et.colorStart,i=Et.colorEnd;let n=0;for(;n<t.length;){const s=t[n];if(s===e){if(t[n+1]===e)return e;for(++n;t[n]!==e;)++n;++n}else{if(s!==i)return s;if(t[n+1]===i)return i;++n}}return null},padStart:function(t,e,i=" "){const n=wt(t);if(n>=e)return t;const s=t.length-n;return t.padStart(e+s,i)},padEnd:function(t,e,i=" "){const n=wt(t);if(n>=e)return t;const s=t.length-n;return t.padEnd(e+s,i)},center:function(t,e,i=" "){const n=t.length,s=e-wt(t);if(s<=0)return t;const r=Math.floor(s/2);return t.padStart(n+r,i).padEnd(n+s,i)},truncate:function(t,e){if(wt(t)<=e)return t;const i=Tt(t,0,e);if(!St)return t.substring(0,i);const n=Et.colorEnd;return t.substring(0,i)+n},capitalize:vt,removeColors:function(t){const e=Et.colorStart,i=Et.colorEnd;let n="",s=0;for(let r=0;r<t.length;++r){const h=t[r];if(h===e){if(t[r+1]==e){++r;continue}for(n+=t.substring(s,r),++r;t[r]!=e&&r<t.length;)++r;s=r+1}else if(h===i){if(t[r+1]==i){++r;continue}n+=t.substring(s,r),s=r+1}}return 0==s?t:(n+=t.substring(s),n)},spliceRaw:function(t,e,i,n=""){const s=t.length;if(e>=s)return t;const r=t.substring(0,e);return e+i>=s?r:r+n+t.substring(e+i)},hash:function(t){let e=0;const i=t.length;for(let n=0;n<i;n++)e=(e<<5)-e+t.charCodeAt(n),e|=0;return e}});class Ot{constructor(t,e){this.changed=!1,this._width=t,this._height=e,this._data=this._makeData()}_makeData(){return new Uint32Array(this.width*this.height)}get width(){return this._width}get height(){return this._height}hasXY(t,e){return t>=0&&e>=0&&t<this.width&&e<this.height}clone(){const t=new Ot(this._width,this._height);return t.copy(this),t}resize(t,e){const i=this._data;this._width=t,this._height=e,i.length<t*e?(this._data=new Uint32Array(t*e),this._data.set(i,0)):this._data=i.slice(t*e),this.changed=!0}_index(t,e){return e*this.width+t}get(t,e){if(!this.hasXY(t,e))return 0;let i=this._index(t,e);return this._data[i]||0}info(t,e){const i=this.get(t,e);return{glyph:i>>24,fg:4095&i,bg:i>>12&4095}}set(t,e,i){if(!this.hasXY(t,e))return;let n=this._index(t,e);return this._data[n]!==i&&(this._data[n]=i,!0)}toGlyph(t){return"number"==typeof t?t:t&&t.length?t.charCodeAt(0):-1}draw(t,e,i=-1,n=-1,s=-1){if(!this.hasXY(t,e))return this;const r=this.get(t,e);"number"!=typeof i&&(i=this.toGlyph(i)),"number"!=typeof n&&(n=at(n).toInt()),"number"!=typeof s&&(s=at(s).toInt());const h=((i=i>=0?255&i:r>>24)<<24)+((s=s>=0?4095&s:r>>12&4095)<<12)+(n=n>=0?4095&n:4095&r);return this.set(t,e,h),h!==r&&(this.changed=!0),this}drawSprite(t,e,i){const n=null===i.ch?-1:i.ch,s=null===i.fg?-1:i.fg,r=null===i.bg?-1:i.bg;return this.draw(t,e,n,s,r)}blackOut(...t){return 0==t.length?this.fill(0,0,0):this.draw(t[0],t[1],0,0,0)}fill(t=0,e=4095,i=0){if(1==arguments.length)i=at(t).toInt(),t=0,e=0;else{if("number"!=typeof t){if("string"!=typeof t)throw new Error("glyph must be number or char");t=this.toGlyph(t)}"number"!=typeof e&&(e=at(e).toInt()),"number"!=typeof i&&(i=at(i).toInt())}const n=((t&=255)<<24)+((i&=4095)<<12)+(e&=4095);return this._data.fill(n),this.changed=!0,this}copy(t){return this._width=t._width,this._height=t._height,this._data.set(t._data),this.changed=!0,this}drawText(t,e,i,n=4095,s=-1,r=0,h="left"){if(!this.hasXY(t,e))return 0;if("number"!=typeof n&&(n=at(n)),"number"!=typeof s&&(s=at(s)),r=Math.min(r||this.width,this.width-t),"right"==h){const e=wt(i);t+=r-e}else if("center"==h){const e=wt(i);t+=Math.floor((r-e)/2)}return At(i,((i,n,s,h)=>{t+h>=this.width||h>=r||this.draw(h+t,e,i,n,s)}),{fg:n,bg:s}),1}wrapText(t,e,i,n,s=4095,r=-1,h=0){if(!this.hasXY(t,e))return 0;"number"!=typeof s&&(s=at(s)),"number"!=typeof r&&(r=at(r)),n=Rt(n,i=Math.min(i,this.width-t),h);let o=0,a=t;for(At(n,((n,s,r)=>{if("\n"==n){for(;a<t+i;)this.draw(a++,e+o,0,0,r);return++o,void(a=t+h)}this.draw(a++,e+o,n,s,r)}),{fg:s,bg:r});a<t+i;)this.draw(a++,e+o,0,0,r);return o+1}fillRect(t,e,i,n,s=-1,r=-1,h=-1){null===s&&(s=-1),"number"!=typeof s&&(s=this.toGlyph(s)),"number"!=typeof r&&(r=at(r).toInt()),"number"!=typeof h&&(h=at(h).toInt());const o=Math.min(t+i,this.width),a=Math.min(e+n,this.height);for(let i=t;i<o;++i)for(let t=e;t<a;++t)this.draw(i,t,s,r,h);return this}blackOutRect(t,e,i,n,s=0){return"number"!=typeof s&&(s=at(s)),this.fillRect(t,e,i,n,0,s,s)}highlight(t,e,i,n){if(!this.hasXY(t,e))return this;"number"!=typeof i&&(i=at(i));const s=new pt,r=this.info(t,e);return s.drawSprite(r),s.fg.add(i,n),s.bg.add(i,n),this.drawSprite(t,e,s),this}mix(t,e,i=0,n=0,s=0,r=0){t=at(t);const h=new pt;s||(s=i?1:this.width),r||(r=n?1:this.height);const o=Math.min(s+i,this.width),a=Math.min(r+n,this.height);for(let s=i;s<o;++s)for(let i=n;i<a;++i){const n=this.info(s,i);h.drawSprite(n),h.fg.mix(t,e),h.bg.mix(t,e),this.drawSprite(s,i,h)}return this}dump(){const t=[];let e="    ";for(let t=0;t<this.width;++t)t%10==0&&(e+=" "),e+=t%10;t.push(e),t.push("");for(let e=0;e<this.height;++e){let i=`${(""+e).padStart(2)}] `;for(let t=0;t<this.width;++t){t%10==0&&(i+=" ");const n=this.info(t,e).glyph;i+=String.fromCharCode(n||32)}t.push(i)}console.log(t.join("\n"))}}var Vt=Object.freeze({__proto__:null,Buffer:Ot,make:function(t,e){return new Ot(t,e)}});class kt{constructor(t,e){this.target=null,this.defaultPrevented=!1,this.propagationStopped=!1,this.immediatePropagationStopped=!1,this.key="",this.code="",this.shiftKey=!1,this.ctrlKey=!1,this.altKey=!1,this.metaKey=!1,this.dir=null,this.x=-1,this.y=-1,this.clientX=-1,this.clientY=-1,this.dt=0,this.reset(t,e)}preventDefault(){this.defaultPrevented=!0}stopPropagation(){this.propagationStopped=!0}stopImmediatePropagation(){this.immediatePropagationStopped=!0}reset(t,e){this.type=t,this.target=null,this.defaultPrevented=!1,this.shiftKey=!1,this.ctrlKey=!1,this.altKey=!1,this.metaKey=!1,this.key="",this.code="",this.x=-1,this.y=-1,this.dir=null,this.dt=0,this.target=null,e&&Object.assign(this,e)}}let Bt={};const Ht=[],Wt="keypress",Ft="mousemove",Pt="click",Yt="tick",Ut="mouseup",Gt="stop",Xt=["ShiftLeft","ShiftRight","ControlLeft","ControlRight","AltLeft","AltRight","MetaLeft","MetaRight"];function Kt(t,e){let i;return t.dir?i=e.dir||e.keypress:t.type===Wt?i=e[t.key]||e[t.code]||e.keypress:e[t.type]&&(i=e[t.type]),i||(i=e.dispatch),i||null}async function jt(t,e){let i;if(e=e||Bt,t.type===Gt)return zt(t),!0;const n=Kt(t,e);return n&&(i=await n.call(e,t)),zt(t),i}function zt(t){Ht.push(t)}function $t(){return qt(Gt)}function qt(t,e){const i=Ht.pop()||null;return i?(i.reset(t,e),i):new kt(t,e)}function Zt(t){const e=qt(Yt);return e.dt=t,e}function Jt(t){let e=t.key,i=t.code.toLowerCase();t.shiftKey&&(e=e.toUpperCase(),i=i.toUpperCase()),t.ctrlKey&&(e="^"+e,i="^"+i),t.metaKey&&(e="#"+e,i="#"+i),t.altKey&&(i="/"+i);const n=Ht.pop()||new kt(Wt);return n.shiftKey=t.shiftKey,n.ctrlKey=t.ctrlKey,n.altKey=t.altKey,n.metaKey=t.metaKey,n.type=Wt,n.defaultPrevented=!1,n.key=e,n.code=i,n.x=-1,n.y=-1,n.clientX=-1,n.clientY=-1,n.dir=Qt(t.code),n.dt=0,n.target=null,n}function Qt(t){const e=t.toLowerCase();return"arrowup"===e?[0,-1]:"arrowdown"===e?[0,1]:"arrowleft"===e?[-1,0]:"arrowright"===e?[1,0]:null}function te(t){return Xt.includes(t.code)}function ee(t,e,i){const n=Ht.pop()||new kt(t.type);return n.shiftKey=t.shiftKey,n.ctrlKey=t.ctrlKey,n.altKey=t.altKey,n.metaKey=t.metaKey,n.type=t.type,t.buttons&&"mouseup"!==t.type&&(n.type=Pt),n.defaultPrevented=!1,n.key="",n.code="",n.x=e,n.y=i,n.clientX=t.clientX,n.clientY=t.clientY,n.dir=null,n.dt=0,n.target=null,n}class ie{constructor(){this.running=!0,this.events=[],this.mouse={x:-1,y:-1},this.CURRENT_HANDLER=null,this.PAUSED=null,this.LAST_CLICK={x:-1,y:-1},this.interval=0,this.intervalCount=0,this.ended=!1}hasEvents(){return this.events.length}clearEvents(){for(;this.events.length;){const t=this.events.shift();Ht.push(t)}}_startTicks(){++this.intervalCount,this.interval||(this.interval=setInterval((()=>{const t=Zt(16);this.pushEvent(t)}),16))}_stopTicks(){this.intervalCount&&(--this.intervalCount,this.intervalCount||(clearInterval(this.interval),this.interval=0))}pushEvent(t){if(!this.ended){if(this.PAUSED&&console.log("PAUSED EVENT",t.type),this.events.length){const e=this.events[this.events.length-1];if(e.type===t.type&&e.type===Ft)return e.x=t.x,e.y=t.y,void zt(t)}if(t.type===Pt){if(this.LAST_CLICK.x==t.x&&this.LAST_CLICK.y==t.y)return void zt(t);this.LAST_CLICK.x=t.x,this.LAST_CLICK.y=t.y}else if(t.type==Ut)return this.LAST_CLICK.x=-1,this.LAST_CLICK.y=-1,void zt(t);if(this.CURRENT_HANDLER)this.CURRENT_HANDLER(t);else if(t.type===Yt){const e=this.events[0];if(e&&e.type===Yt)return e.dt+=t.dt,void zt(t);this.events.unshift(t)}else this.events.push(t)}}nextEvent(t=-1,e){e=e||i;let n,s=0;for(;this.events.length;){const t=this.events.shift();if(t.type===Ft&&(this.mouse.x=t.x,this.mouse.y=t.y),e(t))return Promise.resolve(t);zt(t)}if(0==t||this.ended)return Promise.resolve(null);if(this.CURRENT_HANDLER)throw new Error("OVERWRITE HANDLER -- Check for a missing await around Loop function calls.");return this.events.length&&console.warn("SET HANDLER WITH QUEUED EVENTS - nextEvent"),this.CURRENT_HANDLER=i=>{if(i.type===Ft&&(this.mouse.x=i.x,this.mouse.y=i.y),i.type===Yt&&t>0){if(s+=i.dt,s<t)return;i.dt=s}else if(!e(i))return;this.CURRENT_HANDLER=null,n(i)},new Promise((t=>n=t))}async run(t,e=-1){if(this.ended)return;this.running=!0,this.clearEvents(),this._startTicks(),t.start&&"function"==typeof t.start&&await t.start();let i=!0;for(;this.running&&i;){t.draw&&"function"==typeof t.draw&&t.draw();const n=await this.nextEvent(e);n&&await jt(n,t)&&(i=!1)}t.stop&&"function"==typeof t.stop&&await t.stop(),this._stopTicks()}stop(){this.clearEvents(),this.running=!1,this.interval&&(clearInterval(this.interval),this.interval=0),this.CURRENT_HANDLER&&this.pushEvent($t()),this.CURRENT_HANDLER=null}end(){this.stop(),this.ended=!0}start(){this.ended=!1}pauseEvents(){this.PAUSED||(this.PAUSED=this.CURRENT_HANDLER,this.CURRENT_HANDLER=null)}resumeEvents(){if(this.PAUSED&&(this.CURRENT_HANDLER&&console.warn("overwrite CURRENT HANDLER!"),this.CURRENT_HANDLER=this.PAUSED,this.PAUSED=null,this.events.length&&this.CURRENT_HANDLER)){const t=this.events.shift();this.CURRENT_HANDLER(t)}}async tickMs(t=1){let e;return setTimeout((()=>e()),t),new Promise((t=>e=t))}async nextKeyPress(t,e){return void 0===t&&(t=-1),e=e||i,this.nextEvent(t,(function(t){return t.type===Wt&&e(t)}))}async nextKeyOrClick(t,e){return void 0===t&&(t=-1),e=e||i,this.nextEvent(t,(function(t){return(t.type===Wt||t.type===Pt)&&e(t)}))}async pause(t){const e=await this.nextKeyOrClick(t);return e&&e.type!==Yt}waitForAck(){return this.pause(3e5)}onkeydown(t){if(te(t))return;"Escape"===t.code&&this.clearEvents();const e=Jt(t);this.pushEvent(e),t.preventDefault()}}function ne(){return new ie}const se=ne();var re,he=Object.freeze({__proto__:null,Event:kt,KEYPRESS:Wt,MOUSEMOVE:Ft,CLICK:Pt,TICK:Yt,MOUSEUP:Ut,STOP:Gt,setKeymap:function(t){Bt=t},handlerFor:Kt,dispatchEvent:jt,makeStopEvent:$t,makeCustomEvent:qt,makeTickEvent:Zt,makeKeyEvent:Jt,keyCodeDirection:Qt,ignoreKeyEvent:te,makeMouseEvent:ee,Loop:ie,make:ne,loop:se});!function(t){t[t.VISIBLE=F(0)]="VISIBLE",t[t.WAS_VISIBLE=F(1)]="WAS_VISIBLE",t[t.CLAIRVOYANT_VISIBLE=F(2)]="CLAIRVOYANT_VISIBLE",t[t.WAS_CLAIRVOYANT_VISIBLE=F(3)]="WAS_CLAIRVOYANT_VISIBLE",t[t.TELEPATHIC_VISIBLE=F(4)]="TELEPATHIC_VISIBLE",t[t.WAS_TELEPATHIC_VISIBLE=F(5)]="WAS_TELEPATHIC_VISIBLE",t[t.ITEM_DETECTED=F(6)]="ITEM_DETECTED",t[t.WAS_ITEM_DETECTED=F(7)]="WAS_ITEM_DETECTED",t[t.ACTOR_DETECTED=F(8)]="ACTOR_DETECTED",t[t.WAS_ACTOR_DETECTED=F(9)]="WAS_ACTOR_DETECTED",t[t.REVEALED=F(10)]="REVEALED",t[t.MAGIC_MAPPED=F(11)]="MAGIC_MAPPED",t[t.IN_FOV=F(12)]="IN_FOV",t[t.WAS_IN_FOV=F(13)]="WAS_IN_FOV",t[t.ALWAYS_VISIBLE=F(14)]="ALWAYS_VISIBLE",t[t.IS_CURSOR=F(15)]="IS_CURSOR",t[t.IS_HIGHLIGHTED=F(16)]="IS_HIGHLIGHTED",t[t.ANY_KIND_OF_VISIBLE=t.VISIBLE|t.CLAIRVOYANT_VISIBLE|t.TELEPATHIC_VISIBLE]="ANY_KIND_OF_VISIBLE",t[t.IS_WAS_ANY_KIND_OF_VISIBLE=t.VISIBLE|t.WAS_VISIBLE|t.CLAIRVOYANT_VISIBLE|t.WAS_CLAIRVOYANT_VISIBLE|t.TELEPATHIC_VISIBLE|t.WAS_TELEPATHIC_VISIBLE]="IS_WAS_ANY_KIND_OF_VISIBLE",t[t.WAS_ANY_KIND_OF_VISIBLE=t.WAS_VISIBLE|t.WAS_CLAIRVOYANT_VISIBLE|t.WAS_TELEPATHIC_VISIBLE]="WAS_ANY_KIND_OF_VISIBLE",t[t.WAS_DETECTED=t.WAS_ITEM_DETECTED|t.WAS_ACTOR_DETECTED]="WAS_DETECTED",t[t.IS_DETECTED=t.ITEM_DETECTED|t.ACTOR_DETECTED]="IS_DETECTED",t[t.PLAYER=t.IN_FOV]="PLAYER",t[t.CLAIRVOYANT=t.CLAIRVOYANT_VISIBLE]="CLAIRVOYANT",t[t.TELEPATHIC=t.TELEPATHIC_VISIBLE]="TELEPATHIC",t[t.VIEWPORT_TYPES=t.PLAYER|t.VISIBLE|t.CLAIRVOYANT|t.TELEPATHIC|t.ITEM_DETECTED|t.ACTOR_DETECTED]="VIEWPORT_TYPES"}(re||(re={}));class oe{constructor(t){this._setVisible=null,this._startX=-1,this._startY=-1,this._maxRadius=100,this._isBlocked=t.isBlocked,this._calcRadius=t.calcRadius||g,this._hasXY=t.hasXY||i,this._debug=t.debug||e}calculate(t,e,i,n){this._setVisible=n,this._setVisible(t,e,1),this._startX=t,this._startY=e,this._maxRadius=i+1;for(let t=4;t<8;++t){const e=o[t];this.castLight(1,1,0,0,e[0],e[1],0),this.castLight(1,1,0,e[0],0,0,e[1])}}castLight(t,e,i,n,s,r,h){if(t>=this._maxRadius)return void this._debug("CAST: row=%d, start=%d, end=%d, row >= maxRadius => cancel",t,e.toFixed(2),i.toFixed(2));if(e<i)return void this._debug("CAST: row=%d, start=%d, end=%d, start < end => cancel",t,e.toFixed(2),i.toFixed(2));this._debug("CAST: row=%d, start=%d, end=%d, x=%d,%d, y=%d,%d",t,e.toFixed(2),i.toFixed(2),n,s,r,h);let o,a,l,u,c,f=e,d=!1,g=-t,_=0;for(let p=-t;p<=0;p++){if(o=Math.floor(this._startX+p*n+g*s),a=Math.floor(this._startY+p*r+g*h),l=(p-.5)/(g+.5),u=(p+.5)/(g-.5),c=p/(g+.5),_=(p+.5)/g,!this._hasXY(o,a)){d=!0;continue}if(this._debug("- test %d,%d ... start=%d, min=%d, max=%d, end=%d, dx=%d, dy=%d",o,a,e.toFixed(2),c.toFixed(2),_.toFixed(2),i.toFixed(2),p,g),e<_){d=this._isBlocked(o,a);continue}if(i>c)break;const E=this._calcRadius(p,g);if(E<this._maxRadius){const t=1-E/this._maxRadius;this._setVisible(o,a,t),this._debug("       - visible")}if(d){if(this._isBlocked(o,a)){this._debug("       - blocked ... nextStart: %d",u.toFixed(2)),f=u;continue}d=!1}else this._isBlocked(o,a)&&t<this._maxRadius&&(this._debug("       - blocked ... start:%d, end:%d, nextStart: %d",f.toFixed(2),l.toFixed(2),u.toFixed(2)),d=!0,this.castLight(t+1,f,l,n,s,r,h),f=u)}d||this.castLight(t+1,f,i,n,s,r,h)}}var ae=Object.freeze({__proto__:null,get FovFlags(){return re},FOV:oe,FovSystem:class{constructor(t,i={}){this.changed=!0,this._callback=e,this.follow=null,this.site=t;let n=0;const s=i.visible||i.alwaysVisible;(i.revealed||s&&!1!==i.revealed)&&(n|=re.REVEALED),s&&(n|=re.VISIBLE),this.flags=J(t.width,t.height,n),i.callback&&(this.callback=i.callback),this.fov=new oe({isBlocked:(t,e)=>this.site.blocksVision(t,e),hasXY:(t,e)=>t>=0&&e>=0&&t<this.site.width&&e<this.site.height}),i.alwaysVisible&&this.makeAlwaysVisible(),(i.visible||i.alwaysVisible)&&y(t.width,t.height,((t,e)=>this._callback(t,e,!0)))}get callback(){return this._callback}set callback(t){this._callback=t?"function"==typeof t?t:t.onFovChange.bind(t):e}getFlag(t,e){return this.flags[t][e]}isVisible(t,e){return!!((this.flags.get(t,e)||0)&re.VISIBLE)}isAnyKindOfVisible(t,e){return!!((this.flags.get(t,e)||0)&re.ANY_KIND_OF_VISIBLE)}isClairvoyantVisible(t,e){return!!((this.flags.get(t,e)||0)&re.CLAIRVOYANT_VISIBLE)}isTelepathicVisible(t,e){return!!((this.flags.get(t,e)||0)&re.TELEPATHIC_VISIBLE)}isInFov(t,e){return!!((this.flags.get(t,e)||0)&re.IN_FOV)}isDirectlyVisible(t,e){const i=re.VISIBLE|re.IN_FOV;return((this.flags.get(t,e)||0)&i)===i}isActorDetected(t,e){return!!((this.flags.get(t,e)||0)&re.ACTOR_DETECTED)}isItemDetected(t,e){return!!((this.flags.get(t,e)||0)&re.ITEM_DETECTED)}isMagicMapped(t,e){return!!((this.flags.get(t,e)||0)&re.MAGIC_MAPPED)}isRevealed(t,e){return!!((this.flags.get(t,e)||0)&re.REVEALED)}fovChanged(t,e){const i=this.flags.get(t,e)||0;return!!(i&re.ANY_KIND_OF_VISIBLE)!==!!(i&re.WAS_ANY_KIND_OF_VISIBLE)}wasAnyKindOfVisible(t,e){return!!((this.flags.get(t,e)||0)&re.WAS_ANY_KIND_OF_VISIBLE)}makeAlwaysVisible(){this.flags.update((t=>t|re.ALWAYS_VISIBLE|re.REVEALED|re.VISIBLE)),this.changed=!0}makeCellAlwaysVisible(t,e){this.flags[t][e]|=re.ALWAYS_VISIBLE|re.REVEALED|re.VISIBLE,this.changed=!0}revealAll(t=!0){const e=re.REVEALED|(t?re.VISIBLE:0);this.flags.update((t=>t|e)),this.changed=!0}revealCell(t,e,i=!0){const n=re.REVEALED|(i?re.VISIBLE:0);this.flags[t][e]|=n,this.changed=!0}hideCell(t,e){this.flags[t][e]&=~(re.MAGIC_MAPPED|re.REVEALED|re.ALWAYS_VISIBLE),this.flags[t][e]=this.demoteCellVisibility(this.flags[t][e]),this.changed=!0}magicMapCell(t,e){this.flags[t][e]|=re.MAGIC_MAPPED,this.changed=!0}reset(){this.flags.fill(0),this.changed=!0}setCursor(t,e,i=!1){i||this.flags.update((t=>t&~re.IS_CURSOR)),this.flags[t][e]|=re.IS_CURSOR,this.changed=!0}clearCursor(t,e){void 0===t||void 0===e?this.flags.update((t=>t&~re.IS_CURSOR)):this.flags[t][e]&=~re.IS_CURSOR,this.changed=!0}isCursor(t,e){return!!(this.flags[t][e]&re.IS_CURSOR)}setHighlight(t,e,i=!1){i||this.flags.update((t=>t&~re.IS_HIGHLIGHTED)),this.flags[t][e]|=re.IS_HIGHLIGHTED,this.changed=!0}clearHighlight(t,e){void 0===t||void 0===e?this.flags.update((t=>t&~re.IS_HIGHLIGHTED)):this.flags[t][e]&=~re.IS_HIGHLIGHTED,this.changed=!0}isHighlight(t,e){return!!(this.flags[t][e]&re.IS_HIGHLIGHTED)}demoteCellVisibility(t){return(t&=~(re.WAS_ANY_KIND_OF_VISIBLE|re.WAS_IN_FOV|re.WAS_DETECTED))&re.IN_FOV&&(t&=~re.IN_FOV,t|=re.WAS_IN_FOV),t&re.VISIBLE&&(t&=~re.VISIBLE,t|=re.WAS_VISIBLE),t&re.CLAIRVOYANT_VISIBLE&&(t&=~re.CLAIRVOYANT_VISIBLE,t|=re.WAS_CLAIRVOYANT_VISIBLE),t&re.TELEPATHIC_VISIBLE&&(t&=~re.TELEPATHIC_VISIBLE,t|=re.WAS_TELEPATHIC_VISIBLE),t&re.ALWAYS_VISIBLE&&(t|=re.VISIBLE),t&re.ITEM_DETECTED&&(t&=~re.ITEM_DETECTED,t|=re.WAS_ITEM_DETECTED),t&re.ACTOR_DETECTED&&(t&=~re.ACTOR_DETECTED,t|=re.WAS_ACTOR_DETECTED),t}updateCellVisibility(t,e,i){const n=!!(t&re.ANY_KIND_OF_VISIBLE),s=!!(t&re.WAS_ANY_KIND_OF_VISIBLE);return n&&s||(n&&!s?(this.flags[e][i]|=re.REVEALED,this._callback(e,i,n)):!n&&s&&this._callback(e,i,n)),n}updateCellDetect(t,e,i){const n=!!(t&re.IS_DETECTED),s=!!(t&re.WAS_DETECTED);return n&&s||(!n&&s||!s&&n)&&this._callback(e,i,n),n}promoteCellVisibility(t,e,i){t&re.IN_FOV&&this.site.hasVisibleLight(e,i)&&(t=this.flags[e][i]|=re.VISIBLE),this.updateCellVisibility(t,e,i)||this.updateCellDetect(t,e,i)}updateFor(t){return this.update(t.x,t.y,t.visionDistance)}update(t,e,i){return void 0===t&&this.follow?this.updateFor(this.follow):(void 0===i&&(i=this.site.width+this.site.height),this.changed=!0,this.flags.update(this.demoteCellVisibility.bind(this)),this.site.eachViewport(((t,e,i,n)=>{let s=n&re.VIEWPORT_TYPES;s||(s=re.VISIBLE),0!=i?this.fov.calculate(t,e,i,((t,e,i)=>{i&&(this.flags[t][e]|=s)})):this.flags[t][e]|=s})),void 0!==t&&void 0!==e&&this.fov.calculate(t,e,i,((t,e,i)=>{i&&(this.flags[t][e]|=re.PLAYER)})),this.flags.forEach(this.promoteCellVisibility.bind(this)),!0)}}});const le=3e4;function ue(t){return{distance:0,cost:0,index:t,left:null,right:null}}function ce(t,e,i){return t.links[e+t.width*i]}const fe=o;function de(t,e,i){return e<=0||i<=0||(e>=t.length-1||i>=t[0].length-1)}function ge(t,e){let i,n;for(function(t){let e,i,n,s=null,r=null,h=null;i=t.eightWays?8:4;let o=t.front.right;for(t.front.right=null;null!=o;){for(e=0;e<i;e++){if(n=o.index+(fe[e][0]+t.width*fe[e][1]),n<0||n>=t.width*t.height)continue;if(h=t.links[n],h.cost<0)continue;let i=0;if(e>=4){let n,s,r,h;if(i=.4142,s=o.index+fe[e][0],s<0||s>=t.width*t.height)continue;if(h=o.index+t.width*fe[e][1],h<0||h>=t.width*t.height)continue;if(n=t.links[s],r=t.links[h],-2==n.cost||-2==r.cost)continue}if(o.distance+h.cost+i<h.distance){for(h.distance=o.distance+h.cost+i,null!=h.right&&(h.right.left=h.left),null!=h.left&&(h.left.right=h.right),s=o,r=o.right;null!=r&&r.distance<h.distance;)s=r,r=r.right;null!=s&&(s.right=h),h.right=r,h.left=s,null!=r&&(r.left=h)}}r=o.right,o.left=null,o.right=null,o=r}}(t),i=0;i<t.width;i++)for(n=0;n<t.height;n++)e[i][n]=ce(t,i,n).distance}var _e;function pe(t,e,i,n,s=!1){let r,h,a,l,u,c;for(a=0,u=-1,l=0;l<(s?8:4);++l)r=e+o[l][0],h=i+o[l][1],c=n(r,h,e,i,t),!c&&t[e][i]-t[r][h]>a&&(u=l,a=t[e][i]-t[r][h]);return o[u]||null}var Ee=Object.freeze({__proto__:null,FORBIDDEN:-1,OBSTRUCTION:-2,AVOIDED:10,NO_PATH:le,calculateDistances:function(t,e,i,n,s=!1,r=3e4){const h=t.length,o=t[0].length;var a,l;let u,c;for(r<=0&&(r=le),(!_e||_e.width<h||_e.height<o)&&(a=h,l=o,_e={eightWays:!1,front:ue(-1),links:G(a*l,(t=>ue(t))),width:a,height:l}),_e.width=h,_e.height=o,u=0;u<h;u++)for(c=0;c<o;c++)ce(_e,u,c).cost=de(n,u,c)?-2:n[u][c];!function(t,e,i){let n;for(t.eightWays=i,t.front.right=null,n=0;n<t.width*t.height;n++)t.links[n].distance=e,t.links[n].left=t.links[n].right=null}(_e,r,s),function(t,e,i,n){let s,r,h;if(e>0&&i>0&&e<t.width-1&&i<t.height-1&&(h=ce(t,e,i),h.distance>n)){for(h.distance=n,null!=h.right&&(h.right.left=h.left),null!=h.left&&(h.left.right=h.right),s=t.front,r=t.front.right;null!=r&&r.distance<h.distance;)s=r,r=r.right;h.right=r,h.left=s,s.right=h,null!=r&&(r.left=h)}}(_e,e,i,0),ge(_e,t)},nextStep:pe,getPath:function(t,e,i,n,s=!1){let r=e,h=i,o=0;if(t[r][h]<0||t[r][h]>=le){const e=function(t,e,i){let n,s,r,h,o,a=-1,l=-1;const u=t.length,c=t[0].length;for(h=1e4,o=1e4,n=1;n<u-1;n++)for(s=1;s<c-1;s++)t[n][s]>=0&&t[n][s]<le&&(r=(n-e)*(n-e)+(s-i)*(s-i),(r<h||r==h&&t[n][s]<o)&&(a=n,l=s,h=r,o=t[n][s]));return a>=0?[a,l]:null}(t,r,h);e&&(r=e[0],h=e[1])}const a=[[r,h]];let l;do{l=pe(t,r,h,n,s),l&&(r+=l[0],h+=l[1],a.push([r,h]),o++)}while(l);return o?a:null}});class me{constructor(t,e,i=!1){this.fn=t,this.context=e||null,this.once=i||!1,this.next=null}matches(t,e,i){return!(this.fn!==t||void 0!==i&&i!=this.once||e&&this.context!==e)}}var ye={};function be(t,e,i,n=!1){if("function"!=typeof e)throw new TypeError("The listener must be a function");const s=new me(e,i||null,n);return w(ye,t,s),s}function Ie(t,e,i,n=!1){if(!ye[t])return!1;if(!e)return!1;let s=!1;return A(ye[t],(r=>{r.matches(e,i,n)&&(S(ye,t,r),s=!0)})),s}function Ae(t){ye[t]&&(ye[t]=null)}var we=Object.freeze({__proto__:null,Listener:me,addListener:be,on:function(t,e,i,n=!1){return be(t,e,i,n)},once:function(t,e,i){return be(t,e,i,!0)},removeListener:Ie,off:function(t,e,i,n=!1){return Ie(t,e,i,n)},clearEvent:Ae,removeAllListeners:function(t){t?Ae(t):ye={}},emit:async function(...t){const e=t[0];if(!ye[e])return!1;let i=ye[e];for(;i;){let n=i.next;i.once&&S(ye,e,i),await i.fn.apply(i.context,t),i=n}return!0}});var Se=Object.freeze({__proto__:null,make:function(t){if(void 0===t)return()=>100;if(null===t)return()=>0;if("number"==typeof t)return()=>t;if("function"==typeof t)return t;let e={};if("string"==typeof t){const i=t.split(/[,|]/).map((t=>t.trim()));e={},i.forEach((t=>{let[i,n]=t.split(":");e[i]=Number.parseInt(n)||100}))}else e=t;const i=Object.entries(e).map((([t,e])=>{let i=0;if(i="string"==typeof e?Number.parseInt(e):e,t.includes("-")){let[e,n]=t.split("-").map((t=>t.trim())).map((t=>Number.parseInt(t)));return t=>t>=e&&t<=n?i:0}if(t.endsWith("+")){const e=Number.parseInt(t);return t=>t>=e?i:0}{const e=Number.parseInt(t);return t=>t===e?i:0}}));return 1==i.length?i[0]:t=>i.reduce(((e,i)=>e||i(t)),0)}});var Te=Object.freeze({__proto__:null,Scheduler:class{constructor(){this.next=null,this.time=0,this.cache=null}clear(){for(;this.next;){const t=this.next;this.next=t.next,t.next=this.cache,this.cache=t}}push(t,e=1){let i;if(this.cache?(i=this.cache,this.cache=i.next,i.next=null):i={fn:null,time:0,next:null},i.fn=t,i.time=this.time+e,this.next){let t=this,e=t.next;for(;e&&e.time<=i.time;)t=e,e=t.next;i.next=t.next,t.next=i}else this.next=i;return i}pop(){const t=this.next;return t?(this.next=t.next,t.next=this.cache,this.cache=t,this.time=Math.max(t.time,this.time),t.fn):null}remove(t){if(!t||!this.next)return;if(this.next===t)return void(this.next=t.next);let e=this.next,i=e.next;for(;i&&i!==t;)e=i,i=i.next;i===t&&(e.next=i.next)}}});class ve extends Ot{constructor(t){super(t.width,t.height),this._target=t,t.copyTo(this)}clone(){const t=new this.constructor(this._target);return t.copy(this),t}toGlyph(t){return this._target.toGlyph(t)}render(){return this._target.draw(this),this}load(){return this._target.copyTo(this),this}}class xe{constructor(t={}){this._tileWidth=12,this._tileHeight=16,this.needsUpdate=!0,this._map={},t.font=t.font||"monospace",this._node=document.createElement("canvas"),this._ctx=this.node.getContext("2d"),this._configure(t)}static fromImage(t){if("string"==typeof t){if(t.startsWith("data:"))throw new Error("Glyph: You must load a data string into an image element and use that.");const e=document.getElementById(t);if(!e)throw new Error("Glyph: Failed to find image element with id:"+t);t=e}const e=new this({tileWidth:t.width/16,tileHeight:t.height/16});return e._ctx.drawImage(t,0,0),e}static fromFont(t){"string"==typeof t&&(t={font:t});const e=new this(t),i=t.basicOnly||t.basic||!1;return e._initGlyphs(i),e}get node(){return this._node}get ctx(){return this._ctx}get tileWidth(){return this._tileWidth}get tileHeight(){return this._tileHeight}get pxWidth(){return this._node.width}get pxHeight(){return this._node.height}forChar(t){return t&&t.length&&this._map[t]||-1}_configure(t){this._tileWidth=t.tileWidth||this.tileWidth,this._tileHeight=t.tileHeight||this.tileHeight,this.node.width=16*this.tileWidth,this.node.height=16*this.tileHeight,this._ctx.fillStyle="black",this._ctx.fillRect(0,0,this.pxWidth,this.pxHeight);const e=t.fontSize||t.size||Math.max(this.tileWidth,this.tileHeight);this._ctx.font=e+"px "+t.font,this._ctx.textAlign="center",this._ctx.textBaseline="middle",this._ctx.fillStyle="white"}draw(t,e){if(t>=256)throw new Error("Cannot draw more than 256 glyphs.");const i=t%16*this.tileWidth,n=Math.floor(t/16)*this.tileHeight,s=i+Math.floor(this.tileWidth/2),r=n+Math.floor(this.tileHeight/2);this._ctx.save(),this._ctx.beginPath(),this._ctx.rect(i,n,this.tileWidth,this.tileHeight),this._ctx.clip(),this._ctx.fillStyle="black",this._ctx.fillRect(i,n,this.tileWidth,this.tileHeight),this._ctx.fillStyle="white","function"==typeof e?e(this._ctx,i,n,this.tileWidth,this.tileHeight):(void 0===this._map[e]&&(this._map[e]=t),this._ctx.fillText(e,s,r)),this._ctx.restore(),this.needsUpdate=!0}_initGlyphs(t=!1){for(let t=32;t<127;++t)this.draw(t,String.fromCharCode(t));[" ","☺","☻","♥","♦","♣","♠","☼","☀","☆","★","‣","∙","⁃","•","⚐","⚑","☐","☑","☒","⚬","⦿","↑","→","↓","←","↔","↕","▲","▶","▼","◀"].forEach(((t,e)=>{this.draw(e,t)})),t||["⌂","Ç","ü","é","â","ä","à","å","ç","ê","ë","è","ï","î","ì","Ä","Å","É","æ","Æ","ô","ö","ò","û","ù","ÿ","Ö","Ü","¢","£","¥","₧","ƒ","á","í","ó","ú","ñ","Ñ","ª","º","¿","⌐","¬","½","¼","¡","«","»","░","▒","▓","│","┤","╡","╢","╖","╕","╣","║","╗","╝","╜","╛","┐","└","┴","┬","├","─","┼","╞","╟","╚","╔","╩","╦","╠","═","╬","╧","╨","╤","╥","╙","╘","╒","╓","╫","╪","┘","┌","█","▄","▌","▐","▀","α","ß","Γ","π","Σ","σ","µ","τ","Φ","Θ","Ω","δ","∞","φ","ε","∩","≡","±","≥","≤","⌠","⌡","÷","≈","°","∙","·","√","ⁿ","²","■"," "].forEach(((t,e)=>{this.draw(e+127,t)}))}}class Ce extends Error{constructor(...t){super(...t),Error.captureStackTrace&&Error.captureStackTrace(this,Ce),this.name="NotSupportedError"}}class Le{constructor(t,e,i){this.mouse={x:-1,y:-1},this._renderRequested=!1,this._width=50,this._height=25,this._node=this._createNode(),this._createContext(),this._configure(t,e,i),this._buffer=new ve(this)}get node(){return this._node}get width(){return this._width}get height(){return this._height}get tileWidth(){return this._glyphs.tileWidth}get tileHeight(){return this._glyphs.tileHeight}get pxWidth(){return this.node.clientWidth}get pxHeight(){return this.node.clientHeight}get glyphs(){return this._glyphs}set glyphs(t){this._setGlyphs(t)}toGlyph(t){return"number"==typeof t?t:this._glyphs.forChar(t)}get buffer(){return this._buffer}_createNode(){return document.createElement("canvas")}_configure(t,e,i){this._width=t,this._height=e,this._setGlyphs(i)}_setGlyphs(t){return t!==this._glyphs&&(this._glyphs=t,this.resize(this._width,this._height),!0)}resize(t,e){this._width=t,this._height=e,this._buffer&&this._buffer.resize(t,e);const i=this.node;i.width=this._width*this.tileWidth,i.height=this._height*this.tileHeight}_requestRender(){this._renderRequested||(this._renderRequested=!0,requestAnimationFrame((()=>this._render())))}copyTo(t){this.buffer&&t.copy(this.buffer)}render(){this.buffer.render()}hasXY(t,e){return t>=0&&e>=0&&t<this.width&&e<this.height}set onclick(t){this.node.onclick=t?e=>{const i=ee(e,this._toX(e.offsetX),this._toY(e.offsetY));t(i)}:null}set onmousemove(t){this.node.onmousemove=t?e=>{const i=this._toX(e.offsetX),n=this._toY(e.offsetY);if(i==this.mouse.x&&n==this.mouse.y)return;this.mouse.x=i,this.mouse.y=n;const s=ee(e,i,n);t(s)}:null}set onmouseup(t){this.node.onmouseup=t?e=>{const i=ee(e,this._toX(e.offsetX),this._toY(e.offsetY));t(i)}:null}set onkeydown(t){this.node.onkeydown=t?e=>{e.stopPropagation();const i=Jt(e);t(i)}:null}_toX(t){return n(Math.floor(this.width*(t/this.node.clientWidth)),0,this.width-1)}_toY(t){return n(Math.floor(this.height*(t/this.node.clientHeight)),0,this.height-1)}}class Re extends Le{constructor(t,e,i){super(t,e,i)}_createContext(){const t=this.node.getContext("2d");if(!t)throw new Ce("2d context not supported!");this._ctx=t}resize(t,e){super.resize(t,e),this._data=new Uint32Array(t*e),this._changed=new Int8Array(t*e)}draw(t){if(t._data.every(((t,e)=>t===this._data[e])))return!1;t.changed=!1;let e=!1;const i=t._data,n=this._data;for(let t=0;t<n.length;++t)n[t]!==i[t]&&(n[t]=i[t],this._changed[t]=1,e=!0);return!!e&&(this.buffer.changed=!0,this._requestRender(),!0)}_render(){this._renderRequested=!1;for(let t=0;t<this._changed.length;++t)this._changed[t]&&this._renderCell(t),this._changed[t]=0;this.buffer.changed=!1}_renderCell(t){const e=t%this.width,i=Math.floor(t/this.width),n=this._data[t],s=n/(1<<24)>>0,r=n>>12&4095,h=4095&n,o=e*this.tileWidth,a=i*this.tileHeight,l=s%16*this.tileWidth,u=Math.floor(s/16)*this.tileHeight,c=this.glyphs.ctx.getImageData(l,u,this.tileWidth,this.tileHeight);for(let t=0;t<c.width*c.height;++t){const e=c.data[4*t]/255,i=1-e;c.data[4*t+0]=e*(17*((3840&h)>>8))+i*(17*((3840&r)>>8)),c.data[4*t+1]=e*(17*((240&h)>>4))+i*(17*((240&r)>>4)),c.data[4*t+2]=e*(17*(15&h))+i*(17*(15&r)),c.data[4*t+3]=255}this._ctx.putImageData(c,o,a)}}const Ne="\n#version 300 es\nin uvec2 position;\nin uvec2 uv;\nin uint style;\nout vec2 fsUv;\nflat out uint fsStyle;\nuniform highp uvec2 tileSize;\nuniform uvec2 viewportSize;\nvoid main() {\n\tivec2 positionPx = ivec2(position * tileSize);\n\tvec2 positionNdc = (vec2(positionPx * 2) / vec2(viewportSize))-1.0;\n\tpositionNdc.y *= -1.0;\n\tgl_Position = vec4(positionNdc, 0.0, 1.0);\n\tfsUv = vec2(uv);\n\tfsStyle = style;\n}".trim(),De="\n#version 300 es\nprecision highp float;\nin vec2 fsUv;\nflat in uint fsStyle;\nout vec4 fragColor;\nuniform sampler2D font;\nuniform highp uvec2 tileSize;\nvoid main() {\n\tuvec2 fontTiles = uvec2(textureSize(font, 0)) / tileSize;\n\n\tuint glyph = (fsStyle & uint(0xFF000000)) >> 24;\n\tuint glyphX = (glyph & uint(0xF));\n\tuint glyphY = (glyph >> 4);\n\tuvec2 fontPosition = uvec2(glyphX, glyphY);\n\n\tuvec2 fontPx = (tileSize * fontPosition) + uvec2(vec2(tileSize) * fsUv);\n\tvec3 texel = texelFetch(font, ivec2(fontPx), 0).rgb;\n\n\tfloat s = 15.0;\n\tuint fr = (fsStyle & uint(0xF00)) >> 8;\n\tuint fg = (fsStyle & uint(0x0F0)) >> 4;\n\tuint fb = (fsStyle & uint(0x00F)) >> 0;\n\tvec3 fgRgb = vec3(fr, fg, fb) / s;\n  \n\tuint br = (fsStyle & uint(0xF00000)) >> 20;\n\tuint bg = (fsStyle & uint(0x0F0000)) >> 16;\n\tuint bb = (fsStyle & uint(0x00F000)) >> 12;\n\tvec3 bgRgb = vec3(br, bg, bb) / s;\n  \n\tfragColor = vec4(mix(bgRgb, fgRgb, texel), 1.0);\n}".trim();class Me extends Le{constructor(t,e,i){super(t,e,i)}_createContext(){let t=this.node.getContext("webgl2");if(!t)throw new Ce("WebGL 2 not supported");this._gl=t,this._buffers={},this._attribs={},this._uniforms={};const e=function(t,...e){const i=t.createProgram();if([t.VERTEX_SHADER,t.FRAGMENT_SHADER].forEach(((n,s)=>{const r=t.createShader(n);if(t.shaderSource(r,e[s]),t.compileShader(r),!t.getShaderParameter(r,t.COMPILE_STATUS))throw new Error(t.getShaderInfoLog(r));t.attachShader(i,r)})),t.linkProgram(i),!t.getProgramParameter(i,t.LINK_STATUS))throw new Error(t.getProgramInfoLog(i));return i}(t,Ne,De);t.useProgram(e);const i=t.getProgramParameter(e,t.ACTIVE_ATTRIBUTES);for(let n=0;n<i;n++){t.enableVertexAttribArray(n);let i=t.getActiveAttrib(e,n);this._attribs[i.name]=n}const n=t.getProgramParameter(e,t.ACTIVE_UNIFORMS);for(let i=0;i<n;i++){let n=t.getActiveUniform(e,i);this._uniforms[n.name]=t.getUniformLocation(e,n.name)}t.uniform1i(this._uniforms.font,0),this._texture=function(t){let e=t.createTexture();return t.bindTexture(t.TEXTURE_2D,e),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),e}(t)}_createGeometry(){const t=this._gl;this._buffers.position&&t.deleteBuffer(this._buffers.position),this._buffers.uv&&t.deleteBuffer(this._buffers.uv);let e=function(t,e,i,n){let s=i*n,r=new Uint16Array(s*Oe.length),h=new Uint8Array(s*Oe.length),o=0;for(let t=0;t<n;t++)for(let e=0;e<i;e++)Oe.forEach((i=>{r[o]=(o%2?t:e)+i,h[o]=i,o++}));const a=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,a),t.vertexAttribIPointer(e.position,2,t.UNSIGNED_SHORT,0,0),t.bufferData(t.ARRAY_BUFFER,r,t.STATIC_DRAW);const l=t.createBuffer();return t.bindBuffer(t.ARRAY_BUFFER,l),t.vertexAttribIPointer(e.uv,2,t.UNSIGNED_BYTE,0,0),t.bufferData(t.ARRAY_BUFFER,h,t.STATIC_DRAW),{position:a,uv:l}}(t,this._attribs,this.width,this.height);Object.assign(this._buffers,e)}_createData(){const t=this._gl,e=this._attribs,i=this.width*this.height;this._buffers.style&&t.deleteBuffer(this._buffers.style),this._data=new Uint32Array(6*i);const n=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,n),t.vertexAttribIPointer(e.style,1,t.UNSIGNED_INT,0,0),Object.assign(this._buffers,{style:n})}_setGlyphs(t){if(!super._setGlyphs(t))return!1;const e=this._gl,i=this._uniforms;return e.uniform2uiv(i.tileSize,[this.tileWidth,this.tileHeight]),this._uploadGlyphs(),!0}_uploadGlyphs(){if(!this._glyphs.needsUpdate)return;const t=this._gl;t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,this._texture),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,this._glyphs.node),this._requestRender(),this._glyphs.needsUpdate=!1}resize(t,e){super.resize(t,e);const i=this._gl,n=this._uniforms;i.viewport(0,0,this.node.width,this.node.height),i.uniform2ui(n.viewportSize,this.node.width,this.node.height),this._createGeometry(),this._createData()}draw(t){return!t._data.every(((t,e)=>{const i=2+6*e;return t===this._data[i]}))&&(t._data.forEach(((t,e)=>{const i=6*e;this._data[i+2]=t,this._data[i+5]=t})),this._requestRender(),t.changed=!1,!0)}copyTo(t){t.changed=!1;const e=this.width*this.height;for(let i=0;i<e;++i){const e=6*i;t._data[i]=this._data[e+2]}}_render(){const t=this._gl;if(this._glyphs.needsUpdate)this._uploadGlyphs();else if(!this._renderRequested)return;this._renderRequested=!1,t.bindBuffer(t.ARRAY_BUFFER,this._buffers.style),t.bufferData(t.ARRAY_BUFFER,this._data,t.DYNAMIC_DRAW),t.drawArrays(t.TRIANGLES,0,this._width*this._height*6),this.buffer.changed=!1}}const Oe=[0,0,1,0,0,1,0,1,1,0,1,1];var Ve=Object.freeze({__proto__:null,Buffer:ve,Glyphs:xe,NotSupportedError:Ce,BaseCanvas:Le,Canvas2D:Re,CanvasGL:Me,make:function(...t){let e,i,n=t[0],s=t[1],r=t[2];1==t.length&&(r=t[0],s=r.height||34,n=r.width||80),r=r||{font:"monospace"},e=r.image?xe.fromImage(r.image):xe.fromFont(r);try{i=new Me(n,s,e)}catch(t){if(!(t instanceof Ce))throw t}if(i||(i=new Re(n,s,e)),r.div){let t;"string"==typeof r.div?(t=document.getElementById(r.div),t||console.warn("Failed to find parent element by ID: "+r.div)):t=r.div,t&&t.appendChild&&t.appendChild(i.node)}if(r.io||r.loop){let t=r.loop||se;i.onclick=e=>t.pushEvent(e),i.onmousemove=e=>t.pushEvent(e),i.onmouseup=e=>t.pushEvent(e)}return i}});class ke{constructor(t,e,i,s=100){t||(t=null),this.ch=t,this.fg=at(e),this.bg=at(i),this.opacity=n(s,0,100)}clone(){return new ke(this.ch,this.fg,this.bg,this.opacity)}toString(){const t=[];return this.ch&&t.push("ch: "+this.ch),this.fg.isNull()||t.push("fg: "+this.fg.toString(!0)),this.bg.isNull()||t.push("bg: "+this.bg.toString(!0)),100!==this.opacity&&t.push("opacity: "+this.opacity),"{ "+t.join(", ")+" }"}}const Be={};function He(...t){let e,i=null,n=-1,s=-1;if(0==t.length)return new ke(null,-1,-1);if(1==t.length&&Array.isArray(t[0])&&(t=t[0]),t.length>3?(e=t[3],t.pop()):2==t.length&&"number"==typeof t[1]&&t[0].length>1&&(e=t.pop()),t.length>1)i=t[0]||null,n=t[1],s=t[2];else if("string"==typeof t[0]&&1==t[0].length)i=t[0],n="white";else if("string"==typeof t[0]&&t[0].length>1||"number"==typeof t[0])s=t[0];else if(t[0]instanceof it)s=t[0];else{const r=t[0];i=r.ch||null,n=r.fg||-1,s=r.bg||-1,e=r.opacity}return"string"==typeof n?n=at(n):Array.isArray(n)?n=ot(n):null==n&&(n=-1),"string"==typeof s?s=at(s):Array.isArray(s)?s=ot(s):null==s&&(s=-1),new ke(i,n,s,e)}var We=Object.freeze({__proto__:null,Sprite:ke,sprites:Be,make:He,from:function(...t){if(1==t.length&&"string"==typeof t[0]){const e=Be[t[0]];if(!e)throw new Error("Failed to find sprite: "+t[0]);return e}return He(t)},install:function(t,...e){let i;return i=He(...e),i.name=t,Be[t]=i,i},Mixer:pt,makeMixer:function(t){return new pt(t)}}),Fe=Object.freeze({__proto__:null});const Pe={},Ye={},Ue={};function Ge(t,e){const i=yt(e);return Ue[t]=i,i}Ye.message=Ye.message||{};const Xe=[];function Ke(t,e,i,n){const s=Ue[i];s?i=s(n):n&&(i=bt(i,n)),Xe.forEach((n=>n.addMessage(t,e,i)))}var je=Object.freeze({__proto__:null,templates:Ue,install:Ge,installAll:function(t){Object.entries(t).forEach((([t,e])=>Ge(t,e)))},get:function(t){return Ue[t]||null},handlers:Xe,add:function(t,e){return Ke(-1,-1,t,e)},addAt:Ke,addCombat:function(t,e,i,n){const s=Ue[i];s?i=s(n):n&&(i=bt(i,n)),Xe.forEach((n=>n.addCombatMessage(t,e,i)))},MessageCache:class{constructor(t={}){this.ARCHIVE=[],this.CONFIRMED=[],this.ARCHIVE_LINES=30,this.MSG_WIDTH=80,this.NEXT_WRITE_INDEX=0,this.NEEDS_UPDATE=!0,this.COMBAT_MESSAGE=null,this.matchFn=t.match||i,this.ARCHIVE_LINES=t.length||30,this.MSG_WIDTH=t.width||80;for(let t=0;t<this.ARCHIVE_LINES;++t)this.ARCHIVE[t]=null,this.CONFIRMED[t]=!1;Xe.push(this)}get needsUpdate(){return this.NEEDS_UPDATE}set needsUpdate(t){this.NEEDS_UPDATE=t}_addMessageLine(t){wt(t)&&(this.ARCHIVE[this.NEXT_WRITE_INDEX]=t,this.CONFIRMED[this.NEXT_WRITE_INDEX]=!1,this.NEXT_WRITE_INDEX=(this.NEXT_WRITE_INDEX+1)%this.ARCHIVE_LINES)}addMessage(t,e,i){this.matchFn(t,e)&&(this.commitCombatMessage(),this._addMessage(i))}_addMessage(t){var e;const i=Dt(t=vt(t),this.MSG_WIDTH);(null===(e=Ye.message)||void 0===e?void 0:e.reverseMultiLine)&&i.reverse(),i.forEach((t=>this._addMessageLine(t))),this.NEEDS_UPDATE=!0}addCombatMessage(t,e,i){this.matchFn(t,e)&&this._addCombatMessage(i)}_addCombatMessage(t){this.COMBAT_MESSAGE?this.COMBAT_MESSAGE+=", "+vt(t):this.COMBAT_MESSAGE=t,this.NEEDS_UPDATE=!0}commitCombatMessage(){return!!this.COMBAT_MESSAGE&&(this._addMessage(this.COMBAT_MESSAGE+"."),this.COMBAT_MESSAGE=null,!0)}confirmAll(){for(let t=0;t<this.CONFIRMED.length;t++)this.CONFIRMED[t]=!0;this.NEEDS_UPDATE=!0}forEach(t){this.commitCombatMessage();for(let e=0;e<this.ARCHIVE_LINES;++e){const i=(this.ARCHIVE_LINES-e+this.NEXT_WRITE_INDEX-1)%this.ARCHIVE_LINES,n=this.ARCHIVE[i];if(!n)return;if(!1===t(n,this.CONFIRMED[i],e))return}}get length(){let t=0;return this.forEach((()=>++t)),t}}});class ze{constructor(t={}){this.options={rng:M,rounds:5,minWidth:10,minHeight:10,maxWidth:40,maxHeight:20,percentSeeded:50,birthParameters:"ffffffttt",survivalParameters:"ffffttttt"},Object.assign(this.options,t),this.options.birthParameters=this.options.birthParameters.toLowerCase(),this.options.survivalParameters=this.options.survivalParameters.toLowerCase(),this.options.minWidth>=this.options.maxWidth&&(this.options.minWidth=Math.round(.75*this.options.maxWidth),this.options.maxWidth=Math.round(1.25*this.options.maxWidth)),this.options.minHeight>=this.options.maxHeight&&(this.options.minHeight=Math.round(.75*this.options.maxHeight),this.options.maxHeight=Math.round(1.25*this.options.maxHeight))}carve(t,e,i){let n,s,r,h,o,a,l,u=new c(0,0,0,0);const f=q(t,e),d=Math.floor((f.width-this.options.maxWidth)/2),g=Math.floor((f.height-this.options.maxHeight)/2);let _=10;do{for(f.fill(0),n=0;n<this.options.maxWidth;n++)for(s=0;s<this.options.maxHeight;s++)f[n+d][s+g]=this.options.rng.chance(this.options.percentSeeded)?1:0;for(r=0;r<this.options.rounds;r++)this._cellularAutomataRound(f)||(r=this.options.rounds);for(l=0,a=0,h=2,n=0;n<f.width;n++)for(s=0;s<f.height;s++)1==f[n][s]&&(o=f.floodFill(n,s,1,h),o>l&&(l=o,a=h),h++);f.valueBounds(a,u)}while((u.width<this.options.minWidth||u.height<this.options.minHeight||0==a)&&--_);for(n=0;n<f.width;n++)for(s=0;s<f.height;s++)f[n][s]==a&&i(n,s);return Z(f),u}_cellularAutomataRound(t){let e,i,n,s,r,h,a;a=q(t.width,t.height),a.copy(t);let l=!1;for(e=0;e<t.width;e++)for(i=0;i<t.height;i++){for(n=0,h=0;h<o.length;h++)s=e+o[h][0],r=i+o[h][1],t.hasXY(s,r)&&a[s][r]&&n++;a[e][i]||"t"!=this.options.birthParameters[n]?a[e][i]&&"t"==this.options.survivalParameters[n]||(t[e][i]=0,l=!0):(t[e][i]=1,l=!0)}return Z(a),l}}var $e=Object.freeze({__proto__:null,Blob:ze,fillBlob:function(t,e={}){return new ze(e).carve(t.width,t.height,((e,i)=>t[e][i]=1))},make:function(t={}){return new ze(t)}});const qe=Ye.light={INTENSITY_DARK:20,INTENSITY_SHADOW:50},Ze=ot();class Je{constructor(t,e=1,i=0,n=!1){this.fadeTo=0,this.passThroughActors=!1,this.id=null,this.color=at(t),this.radius=B(e),this.fadeTo=i,this.passThroughActors=n}copy(t){this.color=t.color,this.radius.copy(t.radius),this.fadeTo=t.fadeTo,this.passThroughActors=t.passThroughActors}get intensity(){return Qe(this.color)}paint(t,e,i,n=!1,s=!1){if(!t)return!1;let r,h=0,o=this.radius.value(),a=Math.ceil(o);if(a<1)return!1;Ze.copy(this.color).bake();const l=!s&&!n&&!ti(Ze),u=this.fadeTo,c=q(t.width,t.height,0);t.calcFov(e,i,a,this.passThroughActors,((t,e)=>{c[t][e]=1}));const f=[0,0,0];return c.forCircle(e,i,a,((n,s,a)=>{if(n){for(h=Math.floor(100-(100-u)*(d(e,i,s,a)/o)),r=0;r<3;++r)f[r]=Math.floor(Ze._data[r]*h/100);t.addCellLight(s,a,f,l)}})),Z(c),!0}}function Qe(t){let e=t;return t instanceof it&&(e=t._data),Math.max(e[0],e[1],e[2])}function ti(t,e=20){return Qe(t)<=e}function ei(t,e=40){return Qe(t)<=e}function ii(...t){if(1==t.length){const e=t[0];if("string"==typeof e){const t=ni[e];if(t)return t;const[i,n,s,r]=e.split(/[,|]/).map((t=>t.trim()));return new Je(at(i),H(n||1),Number.parseInt(s||"0"),!!r&&"false"!==r)}if(Array.isArray(e)){const[t,i,n,s]=e;return new Je(t,i,n,s)}if(e&&e.color)return new Je(at(e.color),H(e.radius),Number.parseInt(e.fadeTo||"0"),e.pass);throw new Error("Unknown Light config - "+e)}{const[e,i,n,s]=t;return new Je(e,i,n,s)}}const ni={};function si(...t){1!=t.length&&s("Unknown Light config: "+JSON.stringify(t));const e=t[0];if("string"==typeof e){const t=ni[e];if(t)return t}return e&&e.paint?e:ii(e)}function ri(t,...e){let i;return i=1==e.length?ii(e[0]):ii(e[0],e[1],e[2],e[3]),ni[t]=i,i.id=t,i}var hi;!function(t){t[t.LIT=F(0)]="LIT",t[t.IN_SHADOW=F(1)]="IN_SHADOW",t[t.DARK=F(2)]="DARK",t[t.CHANGED=F(4)]="CHANGED"}(hi||(hi={}));var oi=Object.freeze({__proto__:null,config:qe,Light:Je,intensity:Qe,isDarkLight:ti,isShadowLight:ei,make:ii,lights:ni,from:si,install:ri,installAll:function(t){Object.entries(t).forEach((([t,e])=>{ri(t,e)}))},LightSystem:class{constructor(t,e={}){this.staticLights=null,this.site=t,this.ambient=at(e.ambient||"white").toLight(),this.changed=!1,this.glowLightChanged=!1,this.dynamicLightChanged=!1,this.light=J(t.width,t.height,(()=>this.ambient.slice())),this.glowLight=J(t.width,t.height,(()=>this.ambient.slice())),this.oldLight=J(t.width,t.height,(()=>this.ambient.slice())),this.flags=J(t.width,t.height),this.finishLightUpdate()}copy(t){this.setAmbient(t.ambient),this.glowLightChanged=!0,this.dynamicLightChanged=!0,this.changed=!0,this.staticLights=null,A(t.staticLights,(t=>this.addStatic(t.x,t.y,t.light)))}getAmbient(){return this.ambient}setAmbient(t){t instanceof it?t=t.toLight():Array.isArray(t)||(t=at(t).toLight());for(let e=0;e<3;++e)this.ambient[e]=t[e];this.glowLightChanged=!0}get needsUpdate(){return this.glowLightChanged||this.dynamicLightChanged}getLight(t,e){return this.light[t][e]}setLight(t,e,i){const n=this.light[t][e];for(let t=0;t<3;++t)n[t]=i[t]}isLit(t,e){return!!(this.flags[t][e]&hi.LIT)}isDark(t,e){return!!(this.flags[t][e]&hi.DARK)}isInShadow(t,e){return!!(this.flags[t][e]&hi.IN_SHADOW)}lightChanged(t,e){return!!(this.flags[t][e]&hi.CHANGED)}get width(){return this.site.width}get height(){return this.site.height}addStatic(t,e,i){const n={x:t,y:e,light:si(i),next:this.staticLights};return this.staticLights=n,this.glowLightChanged=!0,n}removeStatic(t,e,i){let n=this.staticLights;if(!n)return;function s(n){return n.x==t&&n.y==e&&(!i||i===n.light)}for(this.glowLightChanged=!0;n&&s(n);)n=this.staticLights=n.next;if(!n)return;let r=n.next;for(;r;)s(r)?n.next=r.next:n=r,r=r.next}eachStaticLight(t){A(this.staticLights,(e=>t(e.x,e.y,e.light))),this.site.eachGlowLight(((e,i,n)=>{t(e,i,n)}))}eachDynamicLight(t){this.site.eachDynamicLight(t)}update(t=!1){if(this.changed=!1,!t&&!this.needsUpdate)return!1;this.startLightUpdate(),this.glowLightChanged?(this.eachStaticLight(((t,e,i)=>{i.paint(this,t,e)})),this.recordGlowLights(),this.glowLightChanged=!1):this.restoreGlowLights(),this.eachDynamicLight(((t,e,i)=>i.paint(this,t,e))),this.finishLightUpdate();const e=Pe.player;if(e){const t=ni.PLAYERS_LIGHT;t&&t.paint(this,e.x,e.y,!0,!0)}return this.dynamicLightChanged=!1,this.changed=!0,!0}startLightUpdate(){let t=0;const e=ei(this.ambient)?hi.IN_SHADOW:0;this.light.forEach(((i,n,s)=>{for(t=0;t<3;++t)this.oldLight[n][s][t]=i[t],i[t]=this.ambient[t];this.flags[n][s]=e}))}finishLightUpdate(){y(this.width,this.height,((t,e)=>{const i=this.oldLight[t][e],n=this.light[t][e];n.some(((t,e)=>t!==i[e]))&&(this.flags[t][e]|=hi.CHANGED),ti(n)?this.flags[t][e]|=hi.DARK:ei(n)||(this.flags[t][e]|=hi.LIT)}))}recordGlowLights(){let t=0;this.light.forEach(((e,i,n)=>{const s=this.glowLight[i][n];for(t=0;t<3;++t)s[t]=e[t]}))}restoreGlowLights(){let t=0;this.light.forEach(((e,i,n)=>{const s=this.glowLight[i][n];for(t=0;t<3;++t)e[t]=s[t]}))}calcFov(t,e,i,n,s){const r=this.site;new oe({isBlocked:(t,e)=>!(!n&&r.hasActor(t,e))&&r.blocksVision(t,e),hasXY:(t,e)=>r.hasXY(t,e)}).calculate(t,e,i,s)}addCellLight(t,e,i,n){const s=this.light[t][e];for(let t=0;t<3;++t)s[t]+=i[t];n&&!ei(i)&&(this.flags[t][e]&=~hi.IN_SHADOW)}}});t.ERROR=s,t.FALSE=function(){return!1},t.IDENTITY=function(t){return t},t.IS_NONZERO=function(t){return 0!=t},t.IS_ZERO=function(t){return 0==t},t.NOOP=e,t.ONE=function(){return 1},t.TRUE=i,t.WARN=function(...t){console.warn(...t)},t.ZERO=function(){return 0},t.arrayDelete=function(t,e){const i=t.indexOf(e);return!(i<0)&&(t.splice(i,1),!0)},t.arrayFindRight=function(t,e){for(let i=t.length-1;i>=0;--i){const n=t[i];if(e(n))return n}},t.arrayIncludesAll=function(t,e){return e.every((e=>t.includes(e)))},t.arrayInsert=function(t,e,i){if(!i)return void t.push(e);const n=t.findIndex(i);n<0?t.push(e):t.splice(n,0,e)},t.arrayNext=h,t.arrayPrev=function(t,e,i,n=!0){return h(t,e,i,n,!1)},t.arraysIntersect=function(t,e){return t.some((t=>e.includes(t)))},t.blob=$e,t.buffer=Vt,t.canvas=Ve,t.clamp=n,t.color=_t,t.colors=et,t.config=Ye,t.data=Pe,t.events=we,t.first=r,t.flag=Y,t.fov=ae,t.frequency=Se,t.grid=Q,t.io=he,t.light=oi,t.list=T,t.loop=se,t.message=je,t.nextIndex=function(t,e,i=!0){return++t>=e?i?t%e:-1:t},t.object=C,t.path=Ee,t.prevIndex=function(t,e,i=!0){return t<0?e-1:--t<0?i?e-1:-1:t},t.range=W,t.rng=V,t.scheduler=Te,t.sprite=We,t.sprites=Be,t.sum=function(t){return t.reduce(((t,e)=>t+e))},t.text=Mt,t.types=Fe,t.xy=I,Object.defineProperty(t,"__esModule",{value:!0})}));
//# sourceMappingURL=gw-utils.min.js.map
