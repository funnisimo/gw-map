!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).GW=t.GW||{})}(this,(function(t){"use strict";const e=[[0,-1],[1,0],[0,1],[-1,0],[1,-1],[1,1],[-1,1],[-1,-1]],i=[[0,1],[1,1],[1,0],[1,-1],[0,-1],[-1,-1],[-1,0],[-1,1]];function n(){return!0}function r(t){return 0!=t}function s(t,e,i){return t<e?e:t>i?i:t}function h(t){return t.x||t[0]||0}function o(t){return t.y||t[1]||0}class u{constructor(t,e,i,n){this.x=t,this.y=e,this.width=i,this.height=n}contains(...t){let e=t[0],i=t[1];return"number"!=typeof e&&(i=i(e),e=e(e)),this.x<=e&&this.y<=i&&this.x+this.width>e&&this.y+this.height>i}}function l(t,i,n,r=!1){const s=r?4:8;for(let r=0;r<s;++r){const s=e[r];n(t+s[0],i+s[1])}}function a(t,e,i,n){const r=Math.abs(t-i),s=Math.abs(e-n);return r+s-.6*Math.min(r,s)}function c(t,e){return a(0,0,t,e)}function f(t,e,i,n){let r=i-t,s=n-e;if(r&&s){const t=Math.abs(r),e=Math.abs(s);t>=2*e?s=0:e>=2*t&&(r=0)}return[Math.sign(r),Math.sign(s)]}function d(t,e,i){const n=t[i],r=e[i];n&&n.copy&&r?n.copy(r):n&&n.clear&&!r?n.clear():n&&n.nullify&&!r?n.nullify():r&&r.clone?t[i]=r.clone():r&&Array.isArray(r)?t[i]=r.slice():n&&Array.isArray(n)?n.length=0:t[i]=r}function g(t,e,i=null){let n;Object.keys(e).forEach((r=>{const s=r;let h=e[r];n=t;const o=r.split(".");for(;o.length>1;)r=o.shift(),void 0===n[r]?n=n[r]={}:"object"!=typeof n[r]?_("Trying to set default member on non-object config item: "+s):n=n[r];r=o.shift();let u=n[r];i&&i(n,r,u,h)||void 0===u&&(null===h?n[r]=null:Array.isArray(h)?n[r]=h.slice():n[r]=h)}))}function _(t){throw new Error(t)}function p(...t){console.warn(...t)}function m(...t){return t.find((t=>void 0!==t))}function y(t,e){let i=0;for(;t;){const n=t.next;e(t,i++),t=n}return i}function E(t,e,i){return i.next=t[e]||null,t[e]=i,!0}function b(t,e,i){const n=t[e];if(n===i)return t[e]=i.next||null,i.next=null,!0;if(!n)return!1;{let t=n,e=t.next;for(;e&&e!==i;)t=e,e=t.next;if(e===i)return t.next=e.next||null,i.next=null,!0}return!1}const w=65536;function R(t,e,i,n,r){let s,h,o=[],u=[],l=[],a=[],c=[],f=[-1,-1],d=[-1,-1];if(t==i&&e==n)return;const g=[t,e],_=[i,n];for(h=0;h<=1;h++)o[h]=_[h]-g[h]<<16,o[h]<0?(o[h]*=-1,c[h]=-1):c[h]=1,l[h]=a[h]=u[h]=0,f[h]=g[h];for(s=Math.max(o[0],o[1]),o[0]=Math.floor(o[0]*w/s),o[1]=Math.floor(o[1]*w/s);;){for(h=0;h<=1;h++)d[h]=f[h],l[h]+=o[h]>>16,u[h]+=o[h]==w?0:o[h],u[h]>=Math.floor(32768)&&(l[h]++,u[h]-=w),f[h]=Math.floor(c[h]*l[h]+g[h]);if(r(...f))break}}function x(t,e,i,n){let r,s;for(r=t-i-1;r<t+i+1;r++)for(s=e-i-1;s<e+i+1;s++)(r-t)*(r-t)+(s-e)*(s-e)<i*i+i&&n(r,s)}function A(...t){let e=0,i=0;arguments.length>3&&(e=t.shift(),i=t.shift());const n=e+t[0],r=i+t[1],s=t[2];for(let t=e;t<n;++t)for(let e=i;e<r;++e)s(t,e)}var v={__proto__:null,DIRS:e,NO_DIRECTION:-1,UP:0,RIGHT:1,DOWN:2,LEFT:3,RIGHT_UP:4,RIGHT_DOWN:5,LEFT_DOWN:6,LEFT_UP:7,CLOCK_DIRS:i,NOOP:function(){},TRUE:n,FALSE:function(){return!1},ONE:function(){return 1},ZERO:function(){return 0},IDENTITY:function(t){return t},IS_ZERO:function(t){return 0==t},IS_NONZERO:r,clamp:s,x:h,y:o,Bounds:u,copyXY:function(t,e){t.x=h(e),t.y=o(e)},addXY:function(t,e){t.x+=h(e),t.y+=o(e)},equalsXY:function(t,e){return t.x==h(e)&&t.y==o(e)},lerpXY:function(t,e,i){i>1&&(i/=100),i=s(i,0,1);const n=h(e)-h(t),r=o(e)-o(t);return[h(t)+Math.floor(n*i),o(t)+Math.floor(r*i)]},eachNeighbor:l,matchingNeighbor:function(t,i,n,r=!1){const s=r?4:8;for(let r=0;r<s;++r){const s=e[r],h=t+s[0],o=i+s[1];if(n(h,o))return[h,o]}return[-1,-1]},distanceBetween:a,distanceFromTo:function(t,e){return a(h(t),o(t),h(e),o(e))},calcRadius:c,dirBetween:f,dirFromTo:function(t,e){return f(h(t),o(t),h(e),o(e))},dirIndex:function(t){const i=h(t),n=o(t);return e.findIndex((t=>t[0]==i&&t[1]==n))},isOppositeDir:function(t,e){return t[0]+e[0]==0&&t[1]+e[1]==0},isSameDir:function(t,e){return t[0]==e[0]&&t[1]==e[1]},dirSpread:function(t){const e=[t];return 0==t[0]?(e.push([1,t[1]]),e.push([-1,t[1]])):0==t[1]?(e.push([t[0],1]),e.push([t[0],-1])):(e.push([t[0],0]),e.push([0,t[1]])),e},stepFromTo:function(t,e,i){const n=h(t),r=o(t),s=[h(e)-n,o(e)-r],u=Math.abs(s[0])+Math.abs(s[1]),l=[0,0],a=[99999,99999];for(let t=0;t<=u;++t)l[0]=n+Math.floor(s[0]*t/u),l[1]=r+Math.floor(s[1]*t/u),l[0]==a[0]&&l[1]==a[1]||i(l[0],l[1]),a[0]=l[0],a[1]=l[1]},smoothHiliteGradient:function(t,e){return Math.floor(100*Math.sin(Math.PI*t/e))},copyObject:function(t,e){Object.keys(t).forEach((i=>{d(t,e,i)}))},assignObject:function(t,e){Object.keys(e).forEach((i=>{d(t,e,i)}))},assignOmitting:function(t,e,i){"string"==typeof t&&(t=t.split(/[,|]/g).map((t=>t.trim()))),Object.keys(i).forEach((n=>{t.includes(n)||d(e,i,n)}))},setDefault:function(t,e,i){void 0===t[e]&&(t[e]=i)},setDefaults:g,kindDefaults:function(t,e){return g(t,e,(function(t,e,i,n){return!(e.search(/[fF]lags$/)<0)&&(i?"string"==typeof i?i=i.split(/[,|]/).map((t=>t.trim())):Array.isArray(i)||(i=[i]):i=[],"string"==typeof n?n=n.split(/[,|]/).map((t=>t.trim())):Array.isArray(n)||(n=[n]),t[e]=n.concat(i),!0)}))},pick:function(t,...e){const i={};return e.forEach((e=>{const n=t[e];void 0!==n&&(i[e]=n)})),i},clearObject:function(t){Object.keys(t).forEach((e=>t[e]=void 0))},ERROR:_,WARN:p,first:m,getOpt:function(t,e,i){const n=t[e];return void 0===n?i:n},firstOpt:function(t,...e){for(let i of e){if("object"!=typeof i||Array.isArray(i))return i;if(void 0!==i[t])return i[t]}},arraysIntersect:function(t,e){return t.some((t=>e.includes(t)))},sum:function(t){return t.reduce(((t,e)=>t+e))},chainLength:function(t){let e=0;for(;t;)e+=1,t=t.next;return e},chainIncludes:function(t,e){for(;t&&t!==e;)t=t.next;return t===e},eachChain:y,addToChain:E,removeFromChain:b,forLine:R,getLine:function(t,e,i,n){const r=[];return R(t,e,i,n,((t,e)=>(r.push([t,e]),t==i&&e==n))),r},getLineThru:function(t,e,i,n,r,s){const h=[];return R(t,e,i,n,((t,e)=>t<0||e<0||t>=r||e>=s||(h.push([t,e]),!1))),h},forCircle:x,forRect:A};const S={make:()=>Math.random.bind(Math)};function T(t,e){let i,n,r;for(n=0,i=0;i<e.length;i++)n+=e[i];if(n<=0)return-1;for(r=t.range(0,n-1),i=0;i<e.length;i++){if(e[i]>r)return i;r-=e[i]}return console.warn("Lottery Draw failed.",e,e.length),0}class M{constructor(){this._fn=S.make()}static configure(t){if(t.make){if("function"!=typeof t.make)throw new Error("Random make parameter must be a function.");if("function"!=typeof t.make(12345))throw new Error("Random make function must accept a numeric seed and return a random function.");S.make=t.make,C.seed(),N.seed()}}seed(t){this._fn=S.make(t)}value(){return this._fn()}float(){return this.value()}number(t){return t<=0?0:(t=t||Number.MAX_SAFE_INTEGER,Math.floor(this._fn()*t))}int(t=0){return this.number(t)}range(t,e){if(e<=t)return e;const i=e-t+1;return t+this.number(i)}dice(t,e,i=0){let n=0,r=1;t<0&&(t=-t,r=-1),i=i||0;for(let i=0;i<t;++i)n+=this.range(1,e);return n*=r,n+i}weighted(t){return Array.isArray(t)?T(this,t):function(t,e){const i=Object.entries(e),n=i.map((([t,e])=>e));return i[T(t,n)][0]}(this,t)}item(t){return Array.isArray(t)||(t=Object.values(t)),t[this.range(0,t.length-1)]}key(t){return this.item(Object.keys(t))}shuffle(t,e=0,i=0){let n,r,s;for(2==arguments.length&&(i=e,e=0),i=i||t.length,n=e=e||0;n<i;n++)r=this.range(e,i-1),n!=r&&(s=t[r],t[r]=t[n],t[n]=s);return t}sequence(t){const e=[];for(let i=0;i<t;i++)e[i]=i;return this.shuffle(e)}chance(t,e=100){return!(t<=0)&&(t>=e||this.number(e)<t)}clumped(t,e,i){if(e<=t)return t;if(i<=1)return this.range(t,e);let n,r=0,s=Math.floor((e-t)/i);for(n=0;n<(e-t)%i;n++)r+=this.range(0,s+1);for(;n<i;n++)r+=this.range(0,s);return r+t}matchingXY(t,e,i){let n,r,s,h=0;if(h=0,A(t,e,((t,e)=>{i(t,e)&&h++})),0==h)return[-1,-1];for(s=this.range(0,h-1),n=0;n<t&&s>=0;n++)for(r=0;r<e&&s>=0;r++)if(i(n,r)){if(0==s)return[n,r];s--}return[-1,-1]}matchingXYNear(t,e,i){let n,r,s,h,o,u=[-1,-1];for(h=0,s=0;s<50&&!h;s++)for(n=t-s;n<=t+s;n++)for(r=e-s;r<=e+s;r++)n!=t-s&&n!=t+s&&r!=e-s&&r!=e+s||!i(n,r)||h++;if(0==h)return[-1,-1];for(o=1+C.number(h),s=0;s<50;s++)for(n=t-s;n<=t+s;n++)for(r=e-s;r<=e+s;r++)if((n==t-s||n==t+s||r==e-s||r==e+s)&&i(n,r)&&0==--o)return u[0]=n,u[1]=r,u;return[-1,-1]}}const C=new M,N=new M,I={},L={},O={};class k{constructor(t,e=0,i=1,n){this._rng=n||C,Array.isArray(t)&&(i=t[2],e=t[1],t=t[0]),e<t&&([e,t]=[t,e]),this.lo=t||0,this.hi=e||this.lo,this.clumps=i||1}value(){return this._rng.clumped(this.lo,this.hi,this.clumps)}copy(t){return this.lo=t.lo,this.hi=t.hi,this.clumps=t.clumps,this._rng=t._rng,this}toString(){return this.lo>=this.hi?""+this.lo:`${this.lo}-${this.hi}`}}function D(t,e){if(!t)return new k(0,0,0,e);if(t instanceof k)return t;if("function"==typeof t)throw new Error("Custom range functions not supported - extend Range");if(null==t)return new k(0,0,0,e);if("number"==typeof t)return new k(t,t,1,e);if(!0===t||!1===t)throw new Error("Invalid random config: "+t);if(Array.isArray(t))return new k(t[0],t[1],t[2],e);if("string"!=typeof t)throw new Error("Calculations must be strings.  Received: "+JSON.stringify(t));if(0==t.length)return new k(0,0,0,e);const i=/^(?:([+-]?\d*)[Dd](\d+)([+-]?\d*)|([+-]?\d+)-(\d+):?(\d+)?|([+-]?\d+)~(\d+)|([+-]?\d+\.?\d*))/g;let n;for(;null!==(n=i.exec(t));){if(n[2]){let t=Number.parseInt(n[1])||1;const i=Number.parseInt(n[2]),r=Number.parseInt(n[3])||0;return new k(r+t,r+t*i,t,e)}if(n[4]&&n[5]){const t=Number.parseInt(n[4]),i=Number.parseInt(n[5]),r=Number.parseInt(n[6]);return new k(t,i,r,e)}if(n[7]&&n[8]){const t=Number.parseInt(n[7]),i=Number.parseInt(n[8]);return new k(t-2*i,t+2*i,3,e)}if(n[9]){const t=Number.parseFloat(n[9]);return new k(t,t,1,e)}}throw new Error("Not a valid range - "+t)}O.range=D;var U={__proto__:null,Range:k,make:D,from:D,asFn:function(t,e){const i=D(t,e);return()=>i.value()}};function Y(t){return 1<<t}function F(t,...e){let i=0;for(let n=0;n<e.length;++n){let r=e[n];void 0!==r&&("number"!=typeof r?("string"==typeof r&&(r=r.split(/[,|]/).map((t=>t.trim())).map((t=>{const e=Number.parseInt(t);return e>=0?e:t}))),Array.isArray(r)&&r.forEach((e=>{if("string"==typeof e)if((e=e.trim()).startsWith("!")){const n=t[e.substring(1)];i&=~n}else{const n=t[e];n&&(i|=n)}else 0===e?i=0:i|=e}))):i|=r)}return i}var B={__proto__:null,fl:Y,toString:function(t,e){const i=Object.entries(t).reduce(((t,e)=>{const[i,n]=e;return"number"==typeof n&&(t[n]=i),t}),[]),n=[];for(let t=0;t<32;++t){const r=1<<t;e&r&&n.push(i[r])}return n.join(" | ")},from:F};const P=e,G=i;function W(t,e){if(void 0===e)return new Array(t).fill(0);e=e||(()=>0);const i=new Array(t);for(let n=0;n<t;++n)i[n]=e(n);return i}function H(t){return!1===t?" ":!0===t?"T":t<10?""+t:t<36?String.fromCharCode("a".charCodeAt(0)+t-10):t<62?String.fromCharCode("A".charCodeAt(0)+t-10-26):"string"==typeof t?t[0]:"#"}class X extends Array{constructor(t,e,i){super(t);for(let n=0;n<t;++n)this[n]="function"==typeof i?new Array(e).fill(0).map(((t,e)=>i(n,e))):new Array(e).fill(i);this._width=t,this._height=e}get width(){return this._width}get height(){return this._height}get(t,e){if(this.hasXY(t,e))return this[t][e]}set(t,e,i){return!!this.hasXY(t,e)&&(this[t][e]=i,!0)}forEach(t){let e,i;for(e=0;e<this.width;e++)for(i=0;i<this.height;i++)t(this[e][i],e,i,this)}async forEachAsync(t){let e,i;for(e=0;e<this.width;e++)for(i=0;i<this.height;i++)await t(this[e][i],e,i,this)}eachNeighbor(t,e,i,n=!1){l(t,e,((t,e)=>{this.hasXY(t,e)&&i(this[t][e],t,e,this)}),n)}async eachNeighborAsync(t,e,i,n=!1){const r=n?4:8;for(let n=0;n<r;++n){const r=P[n],s=t+r[0],h=e+r[1];this.hasXY(s,h)&&await i(this[s][h],s,h,this)}}forRect(t,e,i,n,r){A(t,e,i,n,((t,e)=>{this.hasXY(t,e)&&r(this[t][e],t,e,this)}))}randomEach(t){C.sequence(this.width*this.height).forEach((e=>{const i=e%this.width,n=Math.floor(e/this.width);t(this[i][n],i,n,this)}))}map(t){const e=new this.constructor(this.width,this.height);return e.copy(this),e.update(t),e}forCircle(t,e,i,n){x(t,e,i,((t,e)=>{this.hasXY(t,e)&&n(this[t][e],t,e,this)}))}hasXY(t,e){return t>=0&&e>=0&&t<this.width&&e<this.height}isBoundaryXY(t,e){return this.hasXY(t,e)&&(0==t||t==this.width-1||0==e||e==this.height-1)}calcBounds(){const t={left:this.width,top:this.height,right:0,bottom:0};return this.forEach(((e,i,n)=>{e&&(t.left>i&&(t.left=i),t.right<i&&(t.right=i),t.top>n&&(t.top=n),t.bottom<n&&(t.bottom=n))})),t}update(t){A(this.width,this.height,((e,i)=>{this.hasXY(e,i)&&(this[e][i]=t(this[e][i],e,i,this))}))}updateRect(t,e,i,n,r){A(t,e,i,n,((t,e)=>{this.hasXY(t,e)&&(this[t][e]=r(this[t][e],t,e,this))}))}updateCircle(t,e,i,n){x(t,e,i,((t,e)=>{this.hasXY(t,e)&&(this[t][e]=n(this[t][e],t,e,this))}))}fill(t){const e="function"==typeof t?t:()=>t;this.update(e)}fillRect(t,e,i,n,r){const s="function"==typeof r?r:()=>r;this.updateRect(t,e,i,n,s)}fillCircle(t,e,i,n){const r="function"==typeof n?n:()=>n;this.updateCircle(t,e,i,r)}replace(t,e){this.update((i=>i==t?e:i))}copy(t){this.update(((e,i,n)=>t[i][n]))}count(t){const e="function"==typeof t?t:e=>e==t;let i=0;return this.forEach(((t,n,r)=>{e(t,n,r,this)&&++i})),i}dump(t){this.dumpRect(0,0,this.width,this.height,t)}dumpRect(t,e,i,n,r){let h,o;r=r||H,t=s(t,0,this.width-2),e=s(e,0,this.height-2);const u=s(t+i,1,this.width-1),l=s(e+n,1,this.height-1);let a=[];for(o=e;o<=l;o++){let e=(o+"]").padStart(3," ");for(h=t;h<=u;h++){h%10==0&&(e+=" ");e+=r(this[h][o],h,o)[0]}a.push(e)}console.log(a.join("\n"))}dumpAround(t,e,i){this.dumpRect(t-i,e-i,2*i,2*i)}closestMatchingLoc(t,e,i){let n=[-1,-1],r=100*(this.width+this.height);const s="function"==typeof i?i:t=>t==i;return this.forEach(((i,h,o)=>{if(s(i,h,o,this)){const i=Math.floor(100*a(t,e,h,o));i<r?(n[0]=h,n[1]=o,r=i):i==r&&C.chance(50)&&(n[0]=h,n[1]=o)}})),n}firstMatchingLoc(t){const e="function"==typeof t?t:e=>e==t;for(let t=0;t<this.width;++t)for(let i=0;i<this.height;++i)if(e(this[t][i],t,i,this))return[t,i];return[-1,-1]}randomMatchingLoc(t){const e="function"==typeof t?(e,i)=>t(this[e][i],e,i,this):(e,i)=>this.get(e,i)===t;return C.matchingXY(this.width,this.height,e)}matchingLocNear(t,e,i){const n="function"==typeof i?(t,e)=>i(this[t][e],t,e,this):(t,e)=>this.get(t,e)===i;return C.matchingXYNear(t,e,n)}arcCount(t,e,i){let n,s,h,o;i=i||r;let u=0,l=0;for(let r=0;r<G.length;r++){n=t+G[(r+7)%8][0],s=e+G[(r+7)%8][1],h=t+G[r][0],o=e+G[r][1];const a=this.hasXY(h,o)&&i(this[h][o],h,o,this);a&&++l,a!=(this.hasXY(n,s)&&i(this[n][s],n,s,this))&&u++}return 0==u&&l?1:Math.floor(u/2)}}const K=[];class j extends X{constructor(t,e,i=0){super(t,e,i)}static alloc(t,e,i=0){if(!t||!e)throw new Error("Grid alloc requires width and height parameters.");let n=K.pop();return n?(n._resize(t,e,i),n):new j(t,e,i)}static free(t){if(t){if(K.indexOf(t)>=0)return;K.push(t)}}_resize(t,e,i=0){const n="function"==typeof i?i:()=>i;for(;this.length<t;)this.push([]);this.length=t;let r=0,s=0;for(r=0;r<t;++r){const t=this[r];for(s=0;s<e;++s)t[s]=n(r,s);t.length=e}this._width=t,this._height=e,void 0!==this.x&&(this.x=void 0,this.y=void 0)}findReplaceRange(t,e,i){this.update((n=>n>=t&&n<=e?i:n))}floodFillRange(t,e,i=0,n=0,r=0){let s,h,o,u=1;if(r>=i&&r<=n)throw new Error("Invalid grid flood fill");const l=(t,e)=>this.hasXY(t,e)&&this[t][e]>=i&&this[t][e]<=n;if(!l(t,e))return 0;for(this[t][e]=r,s=0;s<4;s++)h=t+P[s][0],o=e+P[s][1],l(h,o)&&(u+=this.floodFillRange(h,o,i,n,r));return u}invert(){this.update((t=>t?0:1))}leastPositiveValue(){let t=Number.MAX_SAFE_INTEGER;return this.forEach((e=>{e>0&&e<t&&(t=e)})),t}randomLeastPositiveLoc(){const t=this.leastPositiveValue();return this.randomMatchingLoc(t)}valueBounds(t){let e,i,n=!1,r=this.width-1,s=0,h=this.height-1,o=0;for(e=0;e<this.width;e++){for(n=!1,i=0;i<this.height;i++)if(this[e][i]==t){n=!0;break}n&&(e<r&&(r=e),e>s&&(s=e))}for(i=0;i<this.height;i++){for(n=!1,e=0;e<this.width;e++)if(this[e][i]==t){n=!0;break}n&&(i<h&&(h=i),i>o&&(o=i))}return new u(r,h,s-r+1,o-h+1)}floodFill(t,e,i,n){let r,s,h,o=1;const u="function"==typeof i?i:t=>t==i,l="function"==typeof n?n:()=>n;for(this[t][e]=l(this[t][e],t,e,this),r=0;r<4;r++)s=t+P[r][0],h=e+P[r][1],this.hasXY(s,h)&&u(this[s][h],s,h,this)&&(o+=this.floodFill(s,h,u,l));return o}_cellularAutomataRound(t,e){let i,n,r,s,h,o,u;u=j.alloc(this.width,this.height),u.copy(this);let l=!1;for(i=0;i<this.width;i++)for(n=0;n<this.height;n++){for(r=0,o=0;o<P.length;o++)s=i+P[o][0],h=n+P[o][1],this.hasXY(s,h)&&u[s][h]&&r++;u[i][n]||"t"!=t[r]?u[i][n]&&"t"==e[r]||(this[i][n]=0,l=!0):(this[i][n]=1,l=!0)}return j.free(u),l}fillBlob(t,e,i,n,r,s=50,h="ffffffttt",o="ffffttttt"){let u,l,a,c,f,d,g,_;h=h.toLowerCase(),o=o.toLowerCase(),e>=n&&(e=Math.round(.75*n),n=Math.round(1.25*n)),i>=r&&(i=Math.round(.75*r),r=Math.round(1.25*r));const p=Math.floor((this.width-n)/2),m=Math.floor((this.height-r)/2);let y=10;do{for(this.fill(0),u=0;u<n;u++)for(l=0;l<r;l++)this[u+p][l+m]=C.chance(s)?1:0;for(a=0;a<t;a++)this._cellularAutomataRound(h,o)||(a=t);for(g=0,d=0,c=2,u=0;u<this.width;u++)for(l=0;l<this.height;l++)1==this[u][l]&&(f=this.floodFill(u,l,1,c),f>g&&(g=f,d=c),c++);_=this.valueBounds(d)}while((_.width<e||_.height<i||0==d)&&--y);for(u=0;u<this.width;u++)for(l=0;l<this.height;l++)this[u][l]==d?this[u][l]=1:this[u][l]=0;return _}}const V=j.alloc.bind(j),q=j.free.bind(j);function z(t,e,i){return void 0===i?new j(t,e,0):"number"==typeof i?new j(t,e,i):new X(t,e,i)}O.grid=z;var $={__proto__:null,makeArray:W,Grid:X,NumGrid:j,alloc:V,free:q,make:z,offsetZip:function(t,e,i,n,r){const s="function"==typeof r?r:(e,i,n,s)=>t[n][s]=r;e.forEach(((r,h,o)=>{const u=h+i,l=o+n;t.hasXY(u,l)&&r&&s(t[u][l],r,u,l,h,o,t,e)}))},intersection:function(t,e,i){i=i||t,t.update(((t,n,r)=>e[n][r]&&i[n][r]||0))},unite:function(t,e,i){i=i||t,t.update(((t,n,r)=>i[n][r]||e[n][r]))}},Z={};let Q={};const J=[],tt="keypress",et="mousemove",it="click",nt="tick",rt="mouseup",st=["ShiftLeft","ShiftRight","ControlLeft","ControlRight","AltLeft","AltRight","MetaLeft","MetaRight"];async function ht(t,e){let i,n;return"function"==typeof(e=e||Q)?n=e:t.dir?n=e.dir:t.type===tt?n=e[t.key]||e[t.code]||e.keypress:e[t.type]&&(n=e[t.type]),n&&("function"==typeof n?i=await n.call(e,t):Z[n]?i=await Z[n](t):p("No command found: "+n)),"next"in e&&!1===e.next&&(i=!1),ot(t),i}function ot(t){J.push(t)}function ut(t){const e=J.pop()||{};return e.shiftKey=!1,e.ctrlKey=!1,e.altKey=!1,e.metaKey=!1,e.type=nt,e.key=null,e.code=null,e.x=-1,e.y=-1,e.dir=null,e.dt=t,e}function lt(t){const e=t.toLowerCase();return"arrowup"===e?[0,-1]:"arrowdown"===e?[0,1]:"arrowleft"===e?[-1,0]:"arrowright"===e?[1,0]:null}function at(t,e,i){const n=J.pop()||{};return n.shiftKey=t.shiftKey,n.ctrlKey=t.ctrlKey,n.altKey=t.altKey,n.metaKey=t.metaKey,n.type=t.type,t.buttons&&"mouseup"!==t.type&&(n.type=it),n.key=null,n.code=null,n.x=e,n.y=i,n.clientX=t.clientX,n.clientY=t.clientY,n.dir=null,n.dt=0,n}class ct{constructor(){this.running=!1,this.events=[],this.mouse={x:-1,y:-1},this.CURRENT_HANDLER=null,this.PAUSED=null,this.LAST_CLICK={x:-1,y:-1}}hasEvents(){return this.events.length}clearEvents(){for(;this.events.length;){const t=this.events.shift();J.push(t)}}pushEvent(t){if(this.PAUSED&&console.log("PAUSED EVENT",t.type),this.events.length){const e=this.events[this.events.length-1];if(e.type===t.type&&e.type===et)return e.x=t.x,e.y=t.y,void ot(t)}if(t.type===it){if(this.LAST_CLICK.x==t.x&&this.LAST_CLICK.y==t.y)return void ot(t);this.LAST_CLICK.x=t.x,this.LAST_CLICK.y=t.y}else if(t.type==rt)return this.LAST_CLICK.x=-1,this.LAST_CLICK.y=-1,void ot(t);if(this.CURRENT_HANDLER)this.CURRENT_HANDLER(t);else if(t.type===nt){const e=this.events[0];if(e&&e.type===nt)return e.dt+=t.dt,void ot(t);this.events.unshift(t)}else this.events.push(t)}nextEvent(t,e){e=e||n;let i,r=0;for(;this.events.length;){const t=this.events.shift();if(t.type===et&&(this.mouse.x=t.x,this.mouse.y=t.y),e(t))return Promise.resolve(t);ot(t)}return void 0===t&&(t=-1),0==t?Promise.resolve(null):(this.CURRENT_HANDLER?console.warn("OVERWRITE HANDLER - nextEvent"):this.events.length&&console.warn("SET HANDLER WITH QUEUED EVENTS - nextEvent"),this.CURRENT_HANDLER=n=>{if(n.type===et&&(this.mouse.x=n.x,this.mouse.y=n.y),n.type===nt&&t>0){if(r+=n.dt,r<t)return}else if(!e(n))return;this.CURRENT_HANDLER=null,n.dt=r,i(n)},new Promise((t=>i=t)))}async run(t,e=-1){const i=setInterval((()=>{const t=ut(16);this.pushEvent(t)}),16);for(this.running=!0;this.running;){const i=await this.nextEvent(e);i&&await ht(i,t)&&(this.running=!1),t.draw&&"function"==typeof t.draw&&t.draw()}clearInterval(i)}stop(){this.running=!1}pauseEvents(){this.PAUSED||(this.PAUSED=this.CURRENT_HANDLER,this.CURRENT_HANDLER=null)}resumeEvents(){if(this.PAUSED&&(this.CURRENT_HANDLER&&console.warn("overwrite CURRENT HANDLER!"),this.CURRENT_HANDLER=this.PAUSED,this.PAUSED=null,this.events.length&&this.CURRENT_HANDLER)){const t=this.events.shift();this.CURRENT_HANDLER(t)}}async tickMs(t=1){let e;return setTimeout((()=>e()),t),new Promise((t=>e=t))}async nextKeyPress(t,e){return void 0===t&&(t=-1),e=e||n,this.nextEvent(t,(function(t){return t.type===tt&&e(t)}))}async nextKeyOrClick(t,e){return void 0===t&&(t=-1),e=e||n,this.nextEvent(t,(function(t){return(t.type===tt||t.type===it)&&e(t)}))}async pause(t){const e=await this.nextKeyOrClick(t);return e&&e.type!==nt}waitForAck(){return this.pause(3e5)}}function ft(){return new ct}O.loop=ft;const dt=ft();var gt={__proto__:null,commands:Z,addCommand:function(t,e){Z[t]=e},KEYPRESS:tt,MOUSEMOVE:et,CLICK:it,TICK:nt,MOUSEUP:rt,setKeymap:function(t){Q=t},dispatchEvent:ht,makeTickEvent:ut,makeKeyEvent:function(t){let e=t.key,i=t.code.toLowerCase();t.shiftKey&&(e=e.toUpperCase(),i=i.toUpperCase()),t.ctrlKey&&(e="^"+e,i="^"+i),t.metaKey&&(e="#"+e,i="#"+i),t.altKey&&(i="/"+i);const n=J.pop()||{};return n.shiftKey=t.shiftKey,n.ctrlKey=t.ctrlKey,n.altKey=t.altKey,n.metaKey=t.metaKey,n.type=tt,n.key=e,n.code=i,n.x=-1,n.y=-1,n.clientX=-1,n.clientY=-1,n.dir=lt(t.code),n.dt=0,n},keyCodeDirection:lt,ignoreKeyEvent:function(t){return st.includes(t.code)},makeMouseEvent:at,Loop:ct,make:ft,loop:dt};var _t={__proto__:null,FOV:class{constructor(t){this._startX=-1,this._startY=-1,this._maxRadius=100,this._isBlocked=t.isBlocked,this._calcRadius=t.calcRadius||c,this._setVisible=t.setVisible,this._hasXY=t.hasXY||n}calculate(t,i,n){this._setVisible(t,i,1),this._startX=t,this._startY=i,this._maxRadius=n+1;for(let t=4;t<8;++t){const i=e[t];this.castLight(1,1,0,0,i[0],i[1],0),this.castLight(1,1,0,i[0],0,0,i[1])}}castLight(t,e,i,n,r,s,h){if(t>=this._maxRadius)return;if(e<i)return;let o,u,l,a,c,f=e,d=!1,g=-t,_=0;for(let p=-t;p<=0;p++){if(o=Math.floor(this._startX+p*n+g*r),u=Math.floor(this._startY+p*s+g*h),l=(p-.5)/(g+.5),a=(p+.5)/(g-.5),c=p/(g+.5),_=(p+.5)/g,!this._hasXY(o,u)){d=!0;continue}if(e<_){d=this._isBlocked(o,u);continue}if(i>c)break;const m=this._calcRadius(p,g);if(m<this._maxRadius){const t=1-m/this._maxRadius;this._setVisible(o,u,t)}if(d){if(this._isBlocked(o,u)){f=a;continue}d=!1}else this._isBlocked(o,u)&&t<this._maxRadius&&(d=!0,this.castLight(t+1,f,l,n,r,s,h),f=a)}d||this.castLight(t+1,f,i,n,r,s,h)}}};const pt=3e4;function mt(t){return{distance:0,cost:0,index:t,left:null,right:null}}function yt(t,e,i){return t.links[e+t.width*i]}const Et=e;function bt(t,e,i){return e<=0||i<=0||(e>=t.length-1||i>=t[0].length-1)}function wt(t,e){let i,n;for(function(t){let e,i,n,r=null,s=null,h=null;i=t.eightWays?8:4;let o=t.front.right;for(t.front.right=null;null!=o;){for(e=0;e<i;e++){if(n=o.index+(Et[e][0]+t.width*Et[e][1]),n<0||n>=t.width*t.height)continue;if(h=t.links[n],h.cost<0)continue;let i=0;if(e>=4){let n,r,s,h;if(i=.4142,r=o.index+Et[e][0],r<0||r>=t.width*t.height)continue;if(h=o.index+t.width*Et[e][1],h<0||h>=t.width*t.height)continue;if(n=t.links[r],s=t.links[h],-2==n.cost||-2==s.cost)continue}if(o.distance+h.cost+i<h.distance){for(h.distance=o.distance+h.cost+i,null!=h.right&&(h.right.left=h.left),null!=h.left&&(h.left.right=h.right),r=o,s=o.right;null!=s&&s.distance<h.distance;)r=s,s=s.right;null!=r&&(r.right=h),h.right=s,h.left=r,null!=s&&(s.left=h)}}s=o.right,o.left=null,o.right=null,o=s}}(t),i=0;i<t.width;i++)for(n=0;n<t.height;n++)e[i][n]=yt(t,i,n).distance}var Rt;function xt(t,i,n,r,s=!1){let h,o,u,l,a,c;for(u=0,a=-1,l=0;l<(s?8:4);++l)h=i+e[l][0],o=n+e[l][1],c=r(h,o,i,n,t),!c&&t[i][n]-t[h][o]>u&&(a=l,u=t[i][n]-t[h][o]);return e[a]||null}var At={__proto__:null,FORBIDDEN:-1,OBSTRUCTION:-2,AVOIDED:10,NO_PATH:pt,calculateDistances:function(t,e,i,n,r=!1){const s=t.length,h=t[0].length;var o,u;let l,a;for((!Rt||Rt.width<s||Rt.height<h)&&(o=s,u=h,Rt={eightWays:!1,front:mt(-1),links:W(o*u,(t=>mt(t))),width:o,height:u}),Rt.width=s,Rt.height=h,l=0;l<s;l++)for(a=0;a<h;a++)yt(Rt,l,a).cost=bt(n,l,a)?-2:n[l][a];!function(t,e,i){let n;for(t.eightWays=i,t.front.right=null,n=0;n<t.width*t.height;n++)t.links[n].distance=e,t.links[n].left=t.links[n].right=null}(Rt,pt,r),function(t,e,i,n){let r,s,h;if(e>0&&i>0&&e<t.width-1&&i<t.height-1&&(h=yt(t,e,i),h.distance>n)){for(h.distance=n,null!=h.right&&(h.right.left=h.left),null!=h.left&&(h.left.right=h.right),r=t.front,s=t.front.right;null!=s&&s.distance<h.distance;)r=s,s=s.right;h.right=s,h.left=r,r.right=h,null!=s&&(s.left=h)}}(Rt,e,i,0),wt(Rt,t)},nextStep:xt,getPath:function(t,e,i,n){let r=e,s=i,h=0;if(t[r][s]<0||t[r][s]>=pt){const e=function(t,e,i){let n,r,s,h,o,u=-1,l=-1;const a=t.length,c=t[0].length;for(h=1e4,o=1e4,n=1;n<a-1;n++)for(r=1;r<c-1;r++)t[n][r]>=0&&t[n][r]<pt&&(s=(n-e)*(n-e)+(r-i)*(r-i),(s<h||s==h&&t[n][r]<o)&&(u=n,l=r,h=s,o=t[n][r]));return u>=0?[u,l]:null}(t,r,s);e&&(r=e[0],s=e[1])}const o=[[r,s]];let u;do{u=xt(t,r,s,n,!0),u&&(r+=u[0],s+=u[1],o.push([r,s]),h++)}while(u);return h?o:null}};class vt{constructor(t,e,i=!1){this.fn=t,this.context=e||null,this.once=i||!1,this.next=null}matches(t,e,i){return!(this.fn!==t||void 0!==i&&i!=this.once||e&&this.context!==e)}}var St={};function Tt(t,e,i,n=!1){if("function"!=typeof e)throw new TypeError("The listener must be a function");const r=new vt(e,i||null,n);return E(St,t,r),r}function Mt(t,e,i,n=!1){if(!St[t])return!1;if(!e)return!1;let r=!1;return y(St[t],(s=>{s.matches(e,i,n)&&(b(St,t,s),r=!0)})),r}function Ct(t){St[t]&&(St[t]=null)}async function Nt(...t){const e=t[0];if(!St[e])return!1;let i=St[e];for(;i;){let n=i.next;i.once&&b(St,e,i),await i.fn.apply(i.context,t),i=n}return!0}var It={__proto__:null,Listener:vt,addListener:Tt,on:function(t,e,i,n=!1){return Tt(t,e,i,n)},once:function(t,e,i){return Tt(t,e,i,!0)},removeListener:Mt,off:function(t,e,i,n=!1){return Mt(t,e,i,n)},clearEvent:Ct,removeAllListeners:function(t){t?Ct(t):St={}},emit:Nt};var Lt={__proto__:null,make:function(t){if(void 0===t)return()=>100;if(null===t)return()=>0;if("number"==typeof t)return()=>t;if("function"==typeof t)return t;let e={};if("string"==typeof t){const i=t.split(/[,|]/).map((t=>t.trim()));e={},i.forEach((t=>{let[i,n]=t.split(":");e[i]=Number.parseInt(n)||100}))}else e=t;const i=Object.entries(e).map((([t,e])=>{if(e=Number.parseInt(e),t.includes("-")){let[i,n]=t.split("-").map((t=>t.trim())).map((t=>Number.parseInt(t)));return t=>t>=i&&t<=n?e:0}if(t.endsWith("+")){const i=Number.parseInt(t);return t=>t>=i?e:0}{const i=Number.parseInt(t);return t=>t===i?e:0}}));return 1==i.length?i[0]:t=>i.reduce(((e,i)=>e||i(t)),0)}};var Ot={__proto__:null,Scheduler:class{constructor(){this.next=null,this.time=0,this.cache=null}clear(){for(;this.next;){const t=this.next;this.next=t.next,t.next=this.cache,this.cache=t}}push(t,e=1){let i;if(this.cache?(i=this.cache,this.cache=i.next,i.next=null):i={fn:null,time:0,next:null},i.fn=t,i.time=this.time+e,this.next){let t=this,e=t.next;for(;e&&e.time<=i.time;)t=e,e=t.next;i.next=t.next,t.next=i}else this.next=i;return i}pop(){const t=this.next;return t?(this.next=t.next,t.next=this.cache,this.cache=t,this.time=Math.max(t.time,this.time),t.fn):null}remove(t){if(!t||!this.next)return;if(this.next===t)return void(this.next=t.next);let e=this.next,i=e.next;for(;i&&i!==t;)e=i,i=i.next;i===t&&(e.next=i.next)}}};const kt="\n#version 300 es\nin uvec2 position;\nin uvec2 uv;\nin uint style;\nout vec2 fsUv;\nflat out uint fsStyle;\nuniform highp uvec2 tileSize;\nuniform uvec2 viewportSize;\nvoid main() {\n\tivec2 positionPx = ivec2(position * tileSize);\n\tvec2 positionNdc = (vec2(positionPx * 2) / vec2(viewportSize))-1.0;\n\tpositionNdc.y *= -1.0;\n\tgl_Position = vec4(positionNdc, 0.0, 1.0);\n\tfsUv = vec2(uv);\n\tfsStyle = style;\n}".trim(),Dt="\n#version 300 es\nprecision highp float;\nin vec2 fsUv;\nflat in uint fsStyle;\nout vec4 fragColor;\nuniform sampler2D font;\nuniform highp uvec2 tileSize;\nvoid main() {\n\tuvec2 fontTiles = uvec2(textureSize(font, 0)) / tileSize;\n\n\tuint glyph = (fsStyle & uint(0xFF000000)) >> 24;\n\tuint glyphX = (glyph & uint(0xF));\n\tuint glyphY = (glyph >> 4);\n\tuvec2 fontPosition = uvec2(glyphX, glyphY);\n\n\tuvec2 fontPx = (tileSize * fontPosition) + uvec2(vec2(tileSize) * fsUv);\n\tvec3 texel = texelFetch(font, ivec2(fontPx), 0).rgb;\n\n\tfloat s = 15.0;\n\tuint fr = (fsStyle & uint(0xF00)) >> 8;\n\tuint fg = (fsStyle & uint(0x0F0)) >> 4;\n\tuint fb = (fsStyle & uint(0x00F)) >> 0;\n\tvec3 fgRgb = vec3(fr, fg, fb) / s;\n  \n\tuint br = (fsStyle & uint(0xF00000)) >> 20;\n\tuint bg = (fsStyle & uint(0x0F0000)) >> 16;\n\tuint bb = (fsStyle & uint(0x00F000)) >> 12;\n\tvec3 bgRgb = vec3(br, bg, bb) / s;\n  \n\tfragColor = vec4(mix(bgRgb, fgRgb, texel), 1.0);\n}".trim();class Ut{constructor(t={}){this._tileWidth=12,this._tileHeight=16,this.needsUpdate=!0,this._map={},t.font=t.font||"monospace",this._node=document.createElement("canvas"),this._ctx=this.node.getContext("2d"),this._configure(t)}static fromImage(t){if("string"==typeof t){if(t.startsWith("data:"))throw new Error("Glyph: You must load a data string into an image element and use that.");const e=document.getElementById(t);if(!e)throw new Error("Glyph: Failed to find image element with id:"+t);t=e}const e=new this({tileWidth:t.width/16,tileHeight:t.height/16});return e._ctx.drawImage(t,0,0),e}static fromFont(t){"string"==typeof t&&(t={font:t});const e=new this(t),i=t.basicOnly||t.basic||!1;return e._initGlyphs(i),e}get node(){return this._node}get ctx(){return this._ctx}get tileWidth(){return this._tileWidth}get tileHeight(){return this._tileHeight}get pxWidth(){return this._node.width}get pxHeight(){return this._node.height}forChar(t){return t&&t.length&&this._map[t]||-1}_configure(t){this._tileWidth=t.tileWidth||this.tileWidth,this._tileHeight=t.tileHeight||this.tileHeight,this.node.width=16*this.tileWidth,this.node.height=16*this.tileHeight,this._ctx.fillStyle="black",this._ctx.fillRect(0,0,this.pxWidth,this.pxHeight);const e=t.fontSize||t.size||Math.max(this.tileWidth,this.tileHeight);this._ctx.font=e+"px "+t.font,this._ctx.textAlign="center",this._ctx.textBaseline="middle",this._ctx.fillStyle="white"}draw(t,e){if(t>256)throw new Error("Cannot draw more than 256 glyphs.");const i=t%16*this.tileWidth,n=Math.floor(t/16)*this.tileHeight,r=i+Math.floor(this.tileWidth/2),s=n+Math.floor(this.tileHeight/2);this._ctx.save(),this._ctx.beginPath(),this._ctx.rect(i,n,this.tileWidth,this.tileHeight),this._ctx.clip(),this._ctx.fillStyle="black",this._ctx.fillRect(i,n,this.tileWidth,this.tileHeight),this._ctx.fillStyle="white","function"==typeof e?e(this._ctx,i,n,this.tileWidth,this.tileHeight):(void 0===this._map[e]&&(this._map[e]=t),this._ctx.fillText(e,r,s)),this._ctx.restore(),this.needsUpdate=!0}_initGlyphs(t=!1){for(let t=32;t<127;++t)this.draw(t,String.fromCharCode(t));[" ","☺","☻","♥","♦","♣","♠","☼","☀","★","☆","♂","♀","♪","♫","☸","▶","◀","↕","‼","⁋","☯","⌘","☖","↑","↓","→","←","Ω","↔","▲","▼"].forEach(((t,e)=>{this.draw(e,t)})),t||["⌂","Ç","ü","é","â","ä","à","å","ç","ê","ë","è","ï","î","ì","Ä","Å","É","æ","Æ","ô","ö","ò","û","ù","ÿ","Ö","Ü","¢","£","¥","₧","ƒ","á","í","ó","ú","ñ","Ñ","ª","º","¿","⌐","¬","½","¼","¡","«","»","░","▒","▓","│","┤","╡","╢","╖","╕","╣","║","╗","╝","╜","╛","┐","└","┴","┬","├","─","┼","╞","╟","╚","╔","╩","╦","╠","═","╬","╧","╨","╤","╥","╙","╘","╒","╓","╫","╪","┘","┌","█","▄","▌","▐","▀","α","ß","Γ","π","Σ","σ","µ","τ","Φ","Θ","Ω","δ","∞","φ","ε","∩","≡","±","≥","≤","⌠","⌡","÷","≈","°","∙","·","√","ⁿ","²","■"," "].forEach(((t,e)=>{this.draw(e+127,t)}))}}class Yt extends Error{constructor(...t){super(...t),Error.captureStackTrace&&Error.captureStackTrace(this,Yt),this.name="NotSupportedError"}}class Ft{constructor(t){if(this.mouse={x:-1,y:-1},this._renderRequested=!1,this._autoRender=!0,this._width=50,this._height=25,!t.glyphs)throw new Error("You must supply glyphs for the canvas.");this._node=this._createNode(),this._createContext(),this._configure(t);const e=t.io||t.loop;e&&(this.onclick=t=>e.pushEvent(t),this.onmousemove=t=>e.pushEvent(t),this.onmouseup=t=>e.pushEvent(t))}get node(){return this._node}get width(){return this._width}get height(){return this._height}get tileWidth(){return this._glyphs.tileWidth}get tileHeight(){return this._glyphs.tileHeight}get pxWidth(){return this.node.clientWidth}get pxHeight(){return this.node.clientHeight}get glyphs(){return this._glyphs}set glyphs(t){this._setGlyphs(t)}toGlyph(t){return"number"==typeof t?t:this._glyphs.forChar(t)}_createNode(){return document.createElement("canvas")}_configure(t){if(this._width=t.width||this._width,this._height=t.height||this._height,this._autoRender=!1!==t.render,this._setGlyphs(t.glyphs),t.div){let e;"string"==typeof t.div?(e=document.getElementById(t.div),e||console.warn("Failed to find parent element by ID: "+t.div)):e=t.div,e&&e.appendChild&&e.appendChild(this.node)}}_setGlyphs(t){return t!==this._glyphs&&(this._glyphs=t,this.resize(this._width,this._height),!0)}resize(t,e){this._width=t,this._height=e;const i=this.node;i.width=this._width*this.tileWidth,i.height=this._height*this.tileHeight}draw(t,e,i,n,r){const s=(i&=255)*(1<<24)+4096*(r&=4095)+(n&=4095);return this._set(t,e,s),this}fill(...t){let e=0,i=0,n=0;1==t.length?n=t[0]:3==t.length&&([e,i,n]=t);for(let t=0;t<this._width;++t)for(let r=0;r<this._height;++r)this.draw(t,r,e,i,n);return this}_requestRender(){this._renderRequested||(this._renderRequested=!0,this._autoRender&&requestAnimationFrame((()=>this.render())))}_set(t,e,i){let n=e*this.width+t;return this._data[n]!==i&&(this._data[n]=i,this._requestRender(),!0)}copy(t){this._data.set(t),this._requestRender()}copyTo(t){t.set(this._data)}hasXY(t,e){return t>=0&&e>=0&&t<this.width&&e<this.height}set onclick(t){this.node.onclick=t?e=>{const i=at(e,this.toX(e.offsetX),this.toY(e.offsetY));t(i)}:null}set onmousemove(t){this.node.onmousemove=t?e=>{const i=this.toX(e.offsetX),n=this.toY(e.offsetY);if(i==this.mouse.x&&n==this.mouse.y)return;this.mouse.x=i,this.mouse.y=n;const r=at(e,i,n);t(r)}:null}set onmouseup(t){t?this.node.onmouseup=e=>{const i=at(e,this.toX(e.offsetX),this.toY(e.offsetY));t(i)}:this.node.onmousemove=null}toX(t){return s(Math.floor(this.width*(t/this.node.clientWidth)),0,this.width-1)}toY(t){return s(Math.floor(this.height*(t/this.node.clientHeight)),0,this.height-1)}}class Bt extends Ft{constructor(t){super(t)}_createContext(){let t=this.node.getContext("webgl2");if(!t)throw new Yt("WebGL 2 not supported");this._gl=t,this._buffers={},this._attribs={},this._uniforms={};const e=function(t,...e){const i=t.createProgram();if([t.VERTEX_SHADER,t.FRAGMENT_SHADER].forEach(((n,r)=>{const s=t.createShader(n);if(t.shaderSource(s,e[r]),t.compileShader(s),!t.getShaderParameter(s,t.COMPILE_STATUS))throw new Error(t.getShaderInfoLog(s));t.attachShader(i,s)})),t.linkProgram(i),!t.getProgramParameter(i,t.LINK_STATUS))throw new Error(t.getProgramInfoLog(i));return i}(t,kt,Dt);t.useProgram(e);const i=t.getProgramParameter(e,t.ACTIVE_ATTRIBUTES);for(let n=0;n<i;n++){t.enableVertexAttribArray(n);let i=t.getActiveAttrib(e,n);this._attribs[i.name]=n}const n=t.getProgramParameter(e,t.ACTIVE_UNIFORMS);for(let i=0;i<n;i++){let n=t.getActiveUniform(e,i);this._uniforms[n.name]=t.getUniformLocation(e,n.name)}t.uniform1i(this._uniforms.font,0),this._texture=function(t){let e=t.createTexture();return t.bindTexture(t.TEXTURE_2D,e),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),e}(t)}_createGeometry(){const t=this._gl;this._buffers.position&&t.deleteBuffer(this._buffers.position),this._buffers.uv&&t.deleteBuffer(this._buffers.uv);let e=function(t,e,i,n){let r=i*n,s=new Uint16Array(r*Gt.length),h=new Uint8Array(r*Gt.length),o=0;for(let t=0;t<n;t++)for(let e=0;e<i;e++)Gt.forEach((i=>{s[o]=(o%2?t:e)+i,h[o]=i,o++}));const u=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,u),t.vertexAttribIPointer(e.position,2,t.UNSIGNED_SHORT,0,0),t.bufferData(t.ARRAY_BUFFER,s,t.STATIC_DRAW);const l=t.createBuffer();return t.bindBuffer(t.ARRAY_BUFFER,l),t.vertexAttribIPointer(e.uv,2,t.UNSIGNED_BYTE,0,0),t.bufferData(t.ARRAY_BUFFER,h,t.STATIC_DRAW),{position:u,uv:l}}(t,this._attribs,this.width,this.height);Object.assign(this._buffers,e)}_createData(){const t=this._gl,e=this._attribs,i=this.width*this.height;this._buffers.style&&t.deleteBuffer(this._buffers.style),this._data=new Uint32Array(6*i);const n=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,n),t.vertexAttribIPointer(e.style,1,t.UNSIGNED_INT,0,0),Object.assign(this._buffers,{style:n})}_setGlyphs(t){if(!super._setGlyphs(t))return!1;const e=this._gl,i=this._uniforms;return e.uniform2uiv(i.tileSize,[this.tileWidth,this.tileHeight]),this._uploadGlyphs(),!0}_uploadGlyphs(){if(!this._glyphs.needsUpdate)return;const t=this._gl;t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,this._texture),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,this._glyphs.node),this._requestRender(),this._glyphs.needsUpdate=!1}resize(t,e){super.resize(t,e);const i=this._gl,n=this._uniforms;i.viewport(0,0,this.node.width,this.node.height),i.uniform2ui(n.viewportSize,this.node.width,this.node.height),this._createGeometry(),this._createData()}_set(t,e,i){let n=e*this.width+t;n*=6;return this._data[n+2]!==i&&(this._data[n+2]=i,this._data[n+5]=i,this._requestRender(),!0)}copy(t){t.forEach(((t,e)=>{const i=6*e;this._data[i+2]=t,this._data[i+5]=t})),this._requestRender()}copyTo(t){const e=this.width*this.height;for(let i=0;i<e;++i){const e=6*i;t[i]=this._data[e+2]}}render(){const t=this._gl;if(this._glyphs.needsUpdate)this._uploadGlyphs();else if(!this._renderRequested)return;this._renderRequested=!1,t.bindBuffer(t.ARRAY_BUFFER,this._buffers.style),t.bufferData(t.ARRAY_BUFFER,this._data,t.DYNAMIC_DRAW),t.drawArrays(t.TRIANGLES,0,this._width*this._height*6)}}class Pt extends Ft{constructor(t){super(t)}_createContext(){const t=this.node.getContext("2d");if(!t)throw new Yt("2d context not supported!");this._ctx=t}_set(t,e,i){const n=super._set(t,e,i);return n&&(this._changed[e*this.width+t]=1),n}resize(t,e){super.resize(t,e),this._data=new Uint32Array(t*e),this._changed=new Int8Array(t*e)}copy(t){for(let e=0;e<this._data.length;++e)this._data[e]!==t[e]&&(this._data[e]=t[e],this._changed[e]=1);this._requestRender()}render(){this._renderRequested=!1;for(let t=0;t<this._changed.length;++t)this._changed[t]&&this._renderCell(t),this._changed[t]=0}_renderCell(t){const e=t%this.width,i=Math.floor(t/this.width),n=this._data[t],r=n/(1<<24)>>0,s=n>>12&4095,h=4095&n,o=e*this.tileWidth,u=i*this.tileHeight,l=r%16*this.tileWidth,a=Math.floor(r/16)*this.tileHeight,c=this.glyphs.ctx.getImageData(l,a,this.tileWidth,this.tileHeight);for(let t=0;t<c.width*c.height;++t){const e=c.data[4*t]/255,i=1-e;c.data[4*t+0]=e*(17*((3840&h)>>8))+i*(17*((3840&s)>>8)),c.data[4*t+1]=e*(17*((240&h)>>4))+i*(17*((240&s)>>4)),c.data[4*t+2]=e*(17*(15&h))+i*(17*(15&s)),c.data[4*t+3]=255}this._ctx.putImageData(c,o,u)}}const Gt=[0,0,1,0,0,1,0,1,1,0,1,1];function Wt(t,e,i,n){return n?((t=Math.max(0,Math.min(255,Math.round(2.550001*t))))<<16)+((e=Math.max(0,Math.min(255,Math.round(2.550001*e))))<<8)+(i=Math.max(0,Math.min(255,Math.round(2.550001*i)))):((t=Math.max(0,Math.min(15,Math.round(t/100*15))))<<8)+((e=Math.max(0,Math.min(15,Math.round(e/100*15))))<<4)+(i=Math.max(0,Math.min(15,Math.round(i/100*15))))}const Ht={};class Xt extends Int16Array{constructor(t=-1,e=0,i=0,n=0,r=0,s=0,h=0,o=!1){super(7),this.dances=!1,this.set([t,e,i,n,r,s,h]),this.dances=o}get r(){return Math.round(2.550001*this[0])}get _r(){return this[0]}set _r(t){this[0]=t}get g(){return Math.round(2.550001*this[1])}get _g(){return this[1]}set _g(t){this[1]=t}get b(){return Math.round(2.550001*this[2])}get _b(){return this[2]}set _b(t){this[2]=t}get _rand(){return this[3]}get _redRand(){return this[4]}get _greenRand(){return this[5]}get _blueRand(){return this[6]}get l(){return Math.round(.5*(Math.min(this._r,this._g,this._b)+Math.max(this._r,this._g,this._b)))}get s(){return this.l>=100?0:Math.round((Math.max(this._r,this._g,this._b)-Math.min(this._r,this._g,this._b))*(100-Math.abs(2*this.l-100))/100)}get h(){let t=0,e=this.r,i=this.g,n=this.b;return t=e>=i&&i>=n?(i-n)/(e-n)*60:i>e&&e>=n?60*(2-(e-n)/(i-n)):i>=n&&n>e?60*(2+(n-e)/(i-e)):n>i&&i>e?60*(4-(i-e)/(n-e)):n>e&&e>=i?60*(4+(e-i)/(n-i)):60*(6-(n-i)/(e-i)),Math.round(t)}isNull(){return this._r<0}equals(t){if("string"==typeof t)return t.startsWith("#")?this.css(t.length>4)==t:this.name==t;if("number"==typeof t)return this.toInt()==t||this.toInt(!0)==t;const e=$t(t);return this.isNull()?e.isNull():this.every(((t,i)=>t==e[i]))}copy(t){Array.isArray(t)?8===t.length&&(this.dances=t[7]):(t=$t(t),this.dances=t.dances);for(let e=0;e<this.length;++e)this[e]=t[e]||0;return t instanceof Xt?this.name=t.name:this._changed(),this}_changed(){return this.name=void 0,this}clone(){const t=new this.constructor;return t.copy(this),t}assign(t=-1,e=0,i=0,n=0,r=0,s=0,h=0,o){for(let t=0;t<this.length;++t)this[t]=arguments[t]||0;return void 0!==o&&(this.dances=o),this._changed()}assignRGB(t=-1,e=0,i=0,n=0,r=0,s=0,h=0,o){for(let t=0;t<this.length;++t)this[t]=Math.round((arguments[t]||0)/2.55);return void 0!==o&&(this.dances=o),this._changed()}nullify(){return this[0]=-1,this.dances=!1,this._changed()}blackOut(){for(let t=0;t<this.length;++t)this[t]=0;return this.dances=!1,this._changed()}toInt(t=!1){if(this.isNull())return-1;if(!this.dances)return Wt(this._r,this._g,this._b,t);const e=N.number(this._rand),i=N.number(this._redRand),n=N.number(this._greenRand),r=N.number(this._blueRand);return Wt(this._r+e+i,this._g+e+n,this._b+e+r,t)}clamp(){return this.isNull()?this:(this._r=Math.min(100,Math.max(0,this._r)),this._g=Math.min(100,Math.max(0,this._g)),this._b=Math.min(100,Math.max(0,this._b)),this._changed())}mix(t,e){const i=$t(t);if(i.isNull())return this;this.isNull()&&this.blackOut();const n=100-(e=Math.min(100,Math.max(0,e)));for(let t=0;t<this.length;++t)this[t]=Math.round((this[t]*n+i[t]*e)/100);return this.dances=this.dances||i.dances,this._changed()}lighten(t){if(this.isNull())return this;if((t=Math.min(100,Math.max(0,t)))<=0)return;const e=100-t;for(let i=0;i<3;++i)this[i]=Math.round((this[i]*e+100*t)/100);return this._changed()}darken(t){if(this.isNull())return this;if((t=Math.min(100,Math.max(0,t)))<=0)return;const e=100-t;for(let i=0;i<3;++i)this[i]=Math.round((this[i]*e+0*t)/100);return this._changed()}bake(t=!1){if(this.isNull())return this;if(this.dances&&!t)return;this.dances=!1;const e=this;if(e[3]+e[4]+e[5]+e[6]){const t=N.number(this._rand),e=N.number(this._redRand),i=N.number(this._greenRand),n=N.number(this._blueRand);this._r+=t+e,this._g+=t+i,this._b+=t+n;for(let t=3;t<this.length;++t)this[t]=0;return this._changed()}return this}add(t,e=100){const i=$t(t);if(i.isNull())return this;this.isNull()&&this.blackOut();for(let t=0;t<this.length;++t)this[t]+=Math.round(i[t]*e/100);return this.dances=this.dances||i.dances,this._changed()}scale(t){if(this.isNull()||100==t)return this;t=Math.max(0,t);for(let e=0;e<this.length;++e)this[e]=Math.round(this[e]*t/100);return this._changed()}multiply(t){if(this.isNull())return this;let e=t;if(!Array.isArray(t)){if(t.isNull())return this;e=t}const i=Math.max(3,Math.min(this.length,e.length));for(let t=0;t<i;++t)this[t]=Math.round(this[t]*(e[t]||0)/100);return this._changed()}normalize(){if(this.isNull())return this;const t=Math.max(this._r,this._g,this._b);return t<=100?this:(this._r=Math.round(100*this._r/t),this._g=Math.round(100*this._g/t),this._b=Math.round(100*this._b/t),this._changed())}css(t=!1){return"#"+this.toInt(t).toString(16).padStart(t?6:3,"0")}toString(t=!1){return this.name?this.name:this.isNull()?"null color":this.css(t)}}function Kt(t,e=!1){for(;t.length<3;)t.push(0);if(e)for(let e=0;e<7;++e)t[e]=Math.round(100*(t[e]||0)/255);return new Xt(...t)}function jt(t){if(!t.startsWith("#"))throw new Error('Color CSS strings must be of form "#abc" or "#abcdef" - received: ['+t+"]");const e=Number.parseInt(t.substring(1),16);let i,n,r;return 4==t.length?(i=Math.round((e>>8)/15*100),n=Math.round(((240&e)>>4)/15*100),r=Math.round((15&e)/15*100)):(i=Math.round((e>>16)/255*100),n=Math.round(((65280&e)>>8)/255*100),r=Math.round((255&e)/255*100)),new Xt(i,n,r)}function Vt(t){const e=Ht[t];if(!e)throw new Error("Unknown color name: "+t);return e}function qt(t,e=!1){const i=new Xt;for(let t=0;t<i.length;++t)i[t]=0;return t<0?i.assign(-1):e||t>4095?i.assign(Math.round(100*((16711680&t)>>16)/255),Math.round(100*((65280&t)>>8)/255),Math.round(100*(255&t)/255)):i.assign(Math.round(100*((3840&t)>>8)/15),Math.round(100*((240&t)>>4)/15),Math.round(100*(15&t)/15)),i}function zt(...t){let e=t[0],i=t[1];if(0==t.length)return new Xt;if(t.length>2&&(e=t,i=!1),null==e)return new Xt(-1);if(e instanceof Xt)return e.clone();if("string"==typeof e)return e.startsWith("#")?jt(e):Vt(e).clone();if(Array.isArray(e))return Kt(e,i);if("number"==typeof e)return qt(e,i);throw new Error("Failed to make color - unknown argument: "+JSON.stringify(e))}function $t(...t){const e=t[0];return e instanceof Xt?e:void 0===e?new Xt(-1):"string"!=typeof e||e.startsWith("#")?zt(e,t[1]):Vt(e)}function Zt(t,e){if(t.isNull()||e.isNull())return;const i=t.clone().clamp(),n=e.clone().clamp();let r=Math.abs(i.h-n.h);if(r>180&&(r=360-r),r>45)return;if(Math.abs(i.l-n.l)>=40)return;const[s,h]=[i,n].sort(((t,e)=>t.s-e.s));for(;h.l-s.l<40;)h.mix(ee,5),s.mix(te,5);t.copy(i),e.copy(n)}function Qt(t,...e){let i=e;1==e.length&&(i=e[0]);const n=i instanceof Xt?i:zt(i);return Ht[t]=n,n.name=t,n}function Jt(t,...e){let i;return i=1==e.length?Qt(t,e[0]):Qt(t,...e),Qt("light_"+t,i.clone().lighten(25)),Qt("lighter_"+t,i.clone().lighten(50)),Qt("lightest_"+t,i.clone().lighten(75)),Qt("dark_"+t,i.clone().darken(25)),Qt("darker_"+t,i.clone().darken(50)),Qt("darkest_"+t,i.clone().darken(75)),i}O.color=zt;const te=Qt("black",0),ee=Qt("white",4095);Jt("teal",[30,100,100]),Jt("brown",[60,40,0]),Jt("tan",[80,70,55]),Jt("pink",[100,60,66]),Jt("gray",[50,50,50]),Jt("yellow",[100,100,0]),Jt("purple",[100,0,100]),Jt("green",[0,100,0]),Jt("orange",[100,50,0]),Jt("blue",[0,0,100]),Jt("red",[100,0,0]),Jt("amber",[100,75,0]),Jt("flame",[100,25,0]),Jt("fuchsia",[100,0,100]),Jt("magenta",[100,0,75]),Jt("crimson",[100,0,25]),Jt("lime",[75,100,0]),Jt("chartreuse",[50,100,0]),Jt("sepia",[50,40,25]),Jt("violet",[50,0,100]),Jt("han",[25,0,100]),Jt("cyan",[0,100,100]),Jt("turquoise",[0,100,75]),Jt("sea",[0,100,50]),Jt("sky",[0,75,100]),Jt("azure",[0,50,100]),Jt("silver",[75,75,75]),Jt("gold",[100,85,0]);var ie={__proto__:null,colors:Ht,Color:Xt,fromArray:Kt,fromCss:jt,fromName:Vt,fromNumber:qt,make:zt,from:$t,separate:Zt,swap:function(t,e){const i=t.clone();t.copy(e),e.copy(i)},relativeLuminance:function(t,e){return Math.round(100*((t.r-e.r)*(t.r-e.r)*.2126+(t.g-e.g)*(t.g-e.g)*.7152+(t.b-e.b)*(t.b-e.b)*.0722)/65025)},distance:function(t,e){return Math.round(100*((t.r-e.r)*(t.r-e.r)*.3333+(t.g-e.g)*(t.g-e.g)*.3333+(t.b-e.b)*(t.b-e.b)*.3333)/65025)},install:Qt,installSpread:Jt};class ne{constructor(t){this.ch=m(null==t?void 0:t.ch,-1),this.fg=$t(null==t?void 0:t.fg),this.bg=$t(null==t?void 0:t.bg)}_changed(){return this}copy(t){return this.ch=t.ch,this.fg.copy(t.fg),this.bg.copy(t.bg),this._changed()}clone(){const t=new ne;return t.copy(this),t}equals(t){return this.ch==t.ch&&this.fg.equals(t.fg)&&this.bg.equals(t.bg)}get dances(){return this.fg.dances||this.bg.dances}nullify(){return this.ch=-1,this.fg.nullify(),this.bg.nullify(),this._changed()}blackOut(){return this.ch=0,this.fg.blackOut(),this.bg.blackOut(),this._changed()}draw(t=-1,e=-1,i=-1){return t&&-1!==t&&(this.ch=t),-1!==e&&null!==e&&(e=$t(e),this.fg.copy(e)),-1!==i&&null!==i&&(i=$t(i),this.bg.copy(i)),this._changed()}drawSprite(t,e){return t===this?this:(void 0===e&&(e=t.opacity),void 0===e&&(e=100),e<=0?void 0:(t.ch&&(this.ch=t.ch),(t.fg&&-1!==t.fg||0===t.fg)&&this.fg.mix(t.fg,e),(t.bg&&-1!==t.bg||0===t.bg)&&this.bg.mix(t.bg,e),this._changed()))}invert(){return[this.bg,this.fg]=[this.fg,this.bg],this._changed()}multiply(t,e=!0,i=!0){return t=$t(t),e&&this.fg.multiply(t),i&&this.bg.multiply(t),this._changed()}mix(t,e=50,i=e){return t=$t(t),e>0&&this.fg.mix(t,e),i>0&&this.bg.mix(t,i),this._changed()}add(t,e=100,i=e){return t=$t(t),e>0&&this.fg.add(t,e),i>0&&this.bg.add(t,i),this._changed()}separate(){return Zt(this.fg,this.bg),this._changed()}bake(t=!1){return this.fg.bake(t),this.bg.bake(t),this._changed(),{ch:this.ch,fg:this.fg.toInt(),bg:this.bg.toInt()}}toString(){return`{ ch: ${this.ch}, fg: ${this.fg.toString(!0)}, bg: ${this.bg.toString(!0)} }`}}O.mixer=function(t){return new ne(t)};var re={colorStart:"Ω",colorEnd:"∆",field:"§",defaultFg:null,defaultBg:null},se={eachColor:()=>{},default:(t,e,i)=>void 0!==i?`${i}.!!${t}!!`:`!!${t}!!`};function he(t){const e=re.field,i=t.split(e).map(((t,i)=>i%2==0?ue(t):0==t.length?ue(e):function(t){const e=/((\w+) )?(\w+)(\.(\w+))?(%[\+\.\-\d]*[dsf])?/.exec(t)||[],i=e[2],n=e[3],r=e[5],s=e[6];let h=(o=n,function(t){const e=se[o];if(e)return e(o,t);const i=t[o];return void 0!==i?i:se.default(o,t)});var o;r&&r.length&&(h=function(t,e){return function(i){const n=e(i);if(!n)return se.default(t,i,n);const r=n[t];return void 0===r?se.default(t,i,n):r}}(r,h));i&&i.length&&(h=function(t,e){const i=se[t]||se.default;return function(n){const r=e(n);return i(t,n,r)}}(i,h));s&&s.length&&(h=s.endsWith("s")?function(t,e){const i=/%(-?\d*)s/.exec(t)||[],n=Number.parseInt(i[1]||"0");return function(t){let i=""+e(t);return n<0?i=i.padEnd(-n):n&&(i=i.padStart(n)),i}}(s,h):s.endsWith("d")?function(t,e){const i=/%([\+-]*)(\d*)d/.exec(t)||["","","0"];let n=Number.parseInt(i[2]||"0");const r=i[1].includes("+"),s=i[1].includes("-");return function(t){const i=Number.parseInt(e(t)||0);let h=""+i;return i>0&&r&&(h="+"+h),n&&s?h.padEnd(n):n?h.padStart(n):h}}(s,h):function(t,e){const i=/%([\+-]*)(\d*)(\.(\d+))?f/.exec(t)||["","","0"];let n=Number.parseInt(i[2]||"0");const r=i[1].includes("+"),s=i[1].includes("-"),h=Number.parseInt(i[4])||0;return function(t){const i=Number.parseFloat(e(t)||0);let o;return o=h?i.toFixed(h):""+i,i>0&&r&&(o="+"+o),n&&s?o.padEnd(n):n?o.padStart(n):o}}(s,h));return h}(t)));return function(t={}){return i.map((e=>e(t))).join("")}}function oe(t,e={}){return he(t)(e)}function ue(t){return()=>t}function le(t,e,i,n){if(null==t)return;if(!e)return;if(!(t=""+t).length)return;const r=[],s=se.eachColor;void 0===i&&(i=re.defaultFg),void 0===n&&(n=re.defaultBg);const h={fg:i,bg:n},o=re.colorStart,u=re.colorEnd;s(h);let l=0;for(let a=0;a<t.length;++a){const c=t[a];if(c==o){let e=a+1;for(;e<t.length&&t[e]!=o;)++e;if(e==t.length)return void console.warn(`Reached end of string while seeking end of color start section.\n- text: ${t}\n- start @: ${a}`);if(e!=a+1){r.push([h.fg,h.bg]);const i=t.substring(a+1,e).split("|");h.fg=i[0]||h.fg,h.bg=i[1]||h.bg,s(h),a=e;continue}++a}else if(c==u){if(t[a+1]!=u){const t=r.pop();[h.fg,h.bg]=t||[i,n];continue}++a}e(c,h.fg,h.bg,l,a),++l}}function ae(t){if(!t||0==t.length)return 0;let e=0;const i=re.colorStart,n=re.colorEnd;for(let r=0;r<t.length;++r){const s=t[r];if(s==i){r=t.indexOf(i,r+1)}else s==n||++e}return e}function ce(t){const e=re.colorStart,i=re.colorEnd;let n=0;for(;n<t.length;){const r=t[n];if(r==e){for(++n;t[n]!=e&&n<t.length;)++n;++n}else if(r==i)for(++n;t[n]==i&&n<t.length;)++n;else{if(/[A-Za-z]/.test(r))return t.substring(0,n)+r.toUpperCase()+t.substring(n+1);++n}}return t}function fe(t,e){const i=re.colorStart,n=re.colorEnd;let r=e,s=0,h=!0;for(;r<t.length;){const e=t[r];if(" "==e){for(;" "==t[r+1];)++r,++s;return[r,s]}if("-"==e)return[r,s];if("\n"==e)return[r,s];if(e!=i)e!=n?(s+=h?1:0,++r):(t[r+1]==n&&(s+=1,++r),r++);else{if(t[r+1]==i&&h){s+=1,r+=2;continue}h=!h,++r}}return[r,s]}function de(t,e,i,n=""){return t.substring(0,e)+n+t.substring(e+i)}function ge(t,e,i,n,r,s){if(s>=r)return[t,n];if(r+1>2*e)throw new Error("Cannot hyphenate - word length > 2 * width");if(s<4&&r<=e)return[t=de(t,i-1,1,"\n"),n+1];s+e<=r&&(t=de(t,i-1,1,"\n"),s=e);return[t=de(t,function(t,e,i){const n=re.colorStart,r=re.colorEnd;let s=e;for(;i>0;){const e=t[s];if(e===n){if(++s,t[s]===n)--i;else for(;t[s]!==n;)++s;++s}else e===r?(t[s+1]===r&&(--i,++s),++s):(--i,++s)}return s}(t,i,Math.min(Math.floor(r/2),s-1)),0,"-\n"),n+2]}function _e(t,e,i=0){if(!e)throw new Error("Need string and width");if(t.length<e)return t;if(ae(t)<e)return t;if(-1==t.indexOf("\n"))return pe(t,e,i);return t.split("\n").map(((t,n)=>pe(t,e,n?i:0))).join("\n")}function pe(t,e,i){if(t.length<e)return t;if(ae(t)<e)return t;let n=e;e-=i;let r=t,s=!0,h=-1;for(;h<r.length;){let[t,i]=fe(r,h+(s?1:0)),o=!1;if("-"==r[t]&&(t++,i++,o=!0),i>e)[r,t]=ge(r,e,h+1,t,i,n);else if(i==n){const i=o?0:1;r=de(r,t,i,t<r.length?"\n":""),t+=1-i,n=e}else if(i>n){const u=s?1:0;r=de(r,h,u,"\n"),t+=1-u;n=e-i-(o?0:1)}else{n-=i+(o?0:1)}s=!o,h=t}return r}function me(t,e,i=0){const n=re.colorStart,r=[];let s=_e(t,e,i),h=0,o=null,u=null;le(s,((t,e,i,l,a)=>{if("\n"==t){let t=o||u?`${n}${o||""}${u?"|"+u:""}${n}`:"";r.push(t+s.substring(h,a)),h=a+1,o=e,u=i}}));let l=o||u?`${n}${o||""}${u?"|"+u:""}${n}`:"";return r.push(l+s.substring(h)),r}var ye={__proto__:null,compile:he,apply:oe,eachChar:le,length:ae,padStart:function(t,e,i=" "){const n=t.length-ae(t);return t.padStart(e+n,i)},padEnd:function(t,e,i=" "){const n=t.length-ae(t);return t.padEnd(e+n,i)},center:function(t,e,i=" "){const n=t.length,r=e-ae(t);if(r<=0)return t;const s=Math.floor(r/2);return t.padStart(n+s,i).padEnd(n+r,i)},firstChar:function(t){const e=re.colorStart,i=re.colorEnd;let n=0;for(;n<t.length;){const r=t[n];if(r===e){if(t[n+1]===e)return e;for(++n;t[n]!==e;)++n;++n}else{if(r!==i)return r;if(t[n+1]===i)return i;++n}}return null},capitalize:ce,removeColors:function(t){const e=re.colorStart,i=re.colorEnd;let n="",r=0;for(let s=0;s<t.length;++s){const h=t[s];if(h===e){if(t[s+1]==e){++s;continue}for(n+=t.substring(r,s),++s;t[s]!=e&&s<t.length;)++s;r=s+1}else if(h===i){if(t[s+1]==i){++s;continue}n+=t.substring(r,s),r=s+1}}return 0==r?t:(n+=t.substring(r),n)},wordWrap:_e,splitIntoLines:me,configure:function(t={}){void 0!==t.fg&&(re.defaultFg=t.fg),void 0!==t.bg&&(re.defaultBg=t.bg),t.colorStart&&(re.colorStart=t.colorStart),t.colorEnd&&(re.colorEnd=t.colorEnd),t.field&&(re.field=t.field)},addHelper:function(t,e){se[t]=e},options:re};class Ee{constructor(t,e){this._width=t,this._height=e,this._data=new Uint32Array(t*e)}get width(){return this._width}get height(){return this._height}get(t,e){let i=e*this.width+t;const n=this._data[i]||0;return{glyph:n>>24,fg:4095&n,bg:n>>12&4095}}toGlyph(t){return"number"==typeof t?t:t&&t.length?t.charCodeAt(0):-1}draw(t,e,i=-1,n=-1,r=-1){let s=e*this.width+t;const h=this._data[s]||0;"number"!=typeof i&&(i=this.toGlyph(i)),"number"!=typeof n&&(n=$t(n).toInt()),"number"!=typeof r&&(r=$t(r).toInt());const o=((i=i>=0?255&i:h>>24)<<24)+((r=r>=0?4095&r:h>>12&4095)<<12)+(n=n>=0?4095&n:4095&h);return this._data[s]=o,this}drawSprite(t,e,i){const n=null===i.ch?-1:i.ch,r=null===i.fg?-1:i.fg,s=null===i.bg?-1:i.bg;return this.draw(t,e,n,r,s)}blackOut(...t){return 0==t.length?this.fill(0,0,0):this.draw(t[0],t[1],0,0,0)}fill(t=0,e=4095,i=0){"string"==typeof t&&(t=this.toGlyph(t));const n=((t&=255)<<24)+((i&=4095)<<12)+(e&=4095);return this._data.fill(n),this}copy(t){return this._data.set(t._data),this}drawText(t,e,i,n=4095,r=-1){return"number"!=typeof n&&(n=$t(n)),"number"!=typeof r&&(r=$t(r)),le(i,((i,n,r,s)=>{t+s>=this.width||this.draw(s+t,e,i,n,r)}),n,r),++e}wrapText(t,e,i,n,r=4095,s=-1,h=0){"number"!=typeof r&&(r=$t(r)),"number"!=typeof s&&(s=$t(s)),n=_e(n,i=Math.min(i,this.width-t),h);let o=t;for(le(n,((n,r,s)=>{if("\n"==n){for(;o<t+i;)this.draw(o++,e,0,0,s);return++e,void(o=t+h)}this.draw(o++,e,n,r,s)}),r,s);o<t+i;)this.draw(o++,e,0,0,s);return++e}fillRect(t,e,i,n,r=-1,s=-1,h=-1){null===r&&(r=-1),"number"!=typeof r&&(r=this.toGlyph(r)),"number"!=typeof s&&(s=$t(s).toInt()),"number"!=typeof h&&(h=$t(h).toInt());for(let o=t;o<t+i;++o)for(let t=e;t<e+n;++t)this.draw(o,t,r,s,h);return this}blackOutRect(t,e,i,n,r=0){return"number"!=typeof r&&(r=$t(r)),this.fillRect(t,e,i,n,0,0,r)}highlight(t,e,i,n){"number"!=typeof i&&(i=$t(i));const r=new ne,s=this.get(t,e);return r.drawSprite(s),r.fg.add(i,n),r.bg.add(i,n),this.drawSprite(t,e,r),this}mix(t,e){"number"!=typeof t&&(t=$t(t));const i=new ne;for(let n=0;n<this.width;++n)for(let r=0;r<this.height;++r){const s=this.get(n,r);i.drawSprite(s),i.fg.mix(t,e),i.bg.mix(t,e),this.drawSprite(n,r,i)}return this}dump(){const t=[];let e="    ";for(let t=0;t<this.width;++t)t%10==0&&(e+=" "),e+=t%10;t.push(e),t.push("");for(let e=0;e<this.height;++e){let i=`${(""+e).padStart(2)}] `;for(let t=0;t<this.width;++t){t%10==0&&(i+=" ");const n=this.get(t,e).glyph;i+=String.fromCharCode(n||32)}t.push(i)}console.log(t.join("\n"))}}O.dataBuffer=function(t,e){return new Ee(t,e)};class be extends Ee{constructor(t){super(t.width,t.height),this._target=t,t.copyTo(this._data)}toGlyph(t){return this._target.toGlyph(t)}render(){return this._target.copy(this._data),this}load(){return this._target.copyTo(this._data),this}}O.buffer=function(t){return new be(t)};class we{constructor(t,e){this._data=[],this._width=t,this._height=e,this._data=new Array(t*e).fill(0).map((()=>({glyph:0,fg:0,bg:0})))}get width(){return this._width}get height(){return this._height}get(t,e){let i=e*this.width+t;return this._data[i]}toGlyph(t){return"number"==typeof t?t:t&&t.length?t.charCodeAt(0):-1}draw(t,e,i=-1,n=-1,r=-1){let s=e*this.width+t;const h=this._data[s];if(h)return"number"!=typeof i&&(i=this.toGlyph(i)),-1!==i&&(h.glyph=i),"number"!=typeof n&&(n=$t(n).toInt()),"number"!=typeof r&&(r=$t(r).toInt()),-1!==n&&(h.fg=n),-1!==r&&(h.bg=r),this}drawSprite(t,e,i){return this.draw(t,e,i.ch||-1,i.fg||-1,i.bg||-1)}blackOut(...t){return 0==t.length?this.fill(0,0,0):this.draw(t[0],t[1],0,0,0)}fill(t=0,e=4095,i=0){return"number"!=typeof t&&(t=this.toGlyph(t)),this._data.forEach((n=>{n.glyph=t,n.fg=e,n.bg=i})),this}copy(t){return t instanceof Ee?this._data.forEach(((e,i)=>{const n=i%this.width,r=Math.floor(i/this.width);Object.assign(e,t.get(n,r))})):this._data.forEach(((e,i)=>{Object.assign(e,t._data[i])})),this}drawText(t,e,i,n=4095,r=-1){return"number"!=typeof n&&(n=$t(n)),"number"!=typeof r&&(r=$t(r)),le(i,((i,n,r,s)=>{t+s>=this.width||this.draw(s+t,e,i,n,r)}),n,r),++e}wrapText(t,e,i,n,r=4095,s=-1,h=0){"number"!=typeof r&&(r=$t(r)),"number"!=typeof s&&(s=$t(s)),n=_e(n,i=Math.min(i,this.width-t),h);let o=t;for(le(n,((n,r,s)=>{if("\n"==n){for(;o<t+i;)this.draw(o++,e,0,0,s);return++e,void(o=t+h)}this.draw(o++,e,n,r,s)}),r,s);o<t+i;)this.draw(o++,e,0,0,s);return++e}fillRect(t,e,i,n,r=-1,s=-1,h=-1){null===r&&(r=-1),"number"!=typeof r&&(r=this.toGlyph(r)),"number"!=typeof s&&(s=$t(s).toInt()),"number"!=typeof h&&(h=$t(h).toInt());for(let o=t;o<t+i;++o)for(let t=e;t<e+n;++t)this.draw(o,t,r,s,h);return this}blackOutRect(t,e,i,n,r=0){return"number"!=typeof r&&(r=$t(r)),this.fillRect(t,e,i,n,0,0,r)}highlight(t,e,i,n){"number"!=typeof i&&(i=$t(i));const r=this.get(t,e);return r.fg=$t(r.fg).add(i,n).toInt(),r.bg=$t(r.bg).add(i,n).toInt(),this}mix(t,e){"number"!=typeof t&&(t=$t(t));for(let i=0;i<this.width;++i)for(let n=0;n<this.height;++n){const r=this.get(i,n);r.fg=$t(r.fg).mix(t,e).toInt(),r.bg=$t(r.bg).mix(t,e).toInt()}return this}dump(){const t=[];let e="    ";for(let t=0;t<this.width;++t)t%10==0&&(e+=" "),e+=t%10;t.push(e),t.push("");for(let e=0;e<this.height;++e){let i=`${(""+e).padStart(2)}] `;for(let t=0;t<this.width;++t){t%10==0&&(i+=" ");const n=this.get(t,e);i+=String.fromCharCode(n.glyph||32)[0]}t.push(i)}console.log(t.join("\n"))}}var Re={__proto__:null,NotSupportedError:Yt,BaseCanvas:Ft,Canvas:Bt,Canvas2D:Pt,withImage:function(t){let e,i={};if("string"==typeof t)i.glyphs=Ut.fromImage(t);else if(t instanceof HTMLImageElement)i.glyphs=Ut.fromImage(t);else{if(!t.image)throw new Error("You must supply the image.");Object.assign(i,t),i.glyphs=Ut.fromImage(t.image)}try{e=new Bt(i)}catch(t){if(!(t instanceof Yt))throw t}return e||(e=new Pt(i)),e},withFont:function(t){let e;"string"==typeof t&&(t={font:t}),t.glyphs=Ut.fromFont(t);try{e=new Bt(t)}catch(t){if(!(t instanceof Yt))throw t}return e||(e=new Pt(t)),e},Glyphs:Ut,DataBuffer:Ee,Buffer:be,make:function(...t){return 1==t.length?new be(t[0]):new Ee(t[0],t[1])},DancingData:we,DancingBuffer:class extends we{constructor(t){super(t.width,t.height),this._target=t,this.load()}toGlyph(t){return this._target.toGlyph(t)}render(){return this._data.forEach(((t,e)=>{const i=e%this.width,n=Math.floor(e/this.width);this._target.draw(i,n,t.glyph,t.fg,t.bg)})),this}load(){const t=new Uint32Array(this.width*this.height);return this._target.copyTo(t),t.forEach(((t,e)=>{const i=this._data[e]||0;i.glyph=t>>24,i.bg=t>>12&4095,i.fg=4095&t})),this}}};class xe{constructor(t,e,i,n=100){t||(t=null),"number"!=typeof e&&(e=$t(e)),"number"!=typeof i&&(i=$t(i)),this.ch=t,this.fg=e,this.bg=i,this.opacity=n>=0?n:100}clone(){return new xe(this.ch,this.fg,this.bg,this.opacity)}}const Ae={};function ve(...t){let e,i=null,n=-1,r=-1;if(0==t.length)return new xe(null,-1,-1);if(1==t.length&&Array.isArray(t[0])&&(t=t[0]),t.length>3?(e=t[3],t.pop()):2==t.length&&"number"==typeof t[1]&&t[0].length>1&&(e=t.pop()),t.length>1)i=t[0]||null,n=t[1],r=t[2];else if("string"==typeof t[0]&&1==t[0].length)i=t[0],n="white";else if("string"==typeof t[0]&&t[0].length>1||"number"==typeof t[0])r=t[0];else if(t[0]instanceof Xt)r=t[0];else{const s=t[0];i=s.ch||null,n=s.fg||-1,r=s.bg||-1,e=s.opacity}return"string"==typeof n?n=$t(n):Array.isArray(n)?n=zt(n):null==n&&(n=-1),"string"==typeof r?r=$t(r):Array.isArray(r)?r=zt(r):null==r&&(r=-1),new xe(i,n,r,e)}O.sprite=ve;var Se={__proto__:null,Sprite:xe,sprites:Ae,make:ve,install:function(t,...e){let i;return i=ve(...e),i.name=t,Ae[t]=i,i},Mixer:ne};const Te={};function Me(t,e){const i=he(e);Te[t]=i}L.message=L.message||{};const Ce=[],Ne=[];var Ie=30,Le=80,Oe=0,ke=!1;let De=null;function Ue(t,e){const i=Te[t];i?t=i(e):e&&(t=oe(t,e)),Fe(),Ye(t)}function Ye(t){var e;const i=me(t=ce(t),Le);(null===(e=L.message)||void 0===e?void 0:e.reverseMultiLine)&&i.reverse(),i.forEach((t=>function(t){ae(t)&&(Ce[Oe]=t,Ne[Oe]=!1,Oe=(Oe+1)%Ie)}(t))),ke=!0}function Fe(){return!!De&&(Ye(De+"."),De=null,!0)}var Be,Pe={__proto__:null,templates:Te,install:Me,installAll:function(t){Object.entries(t).forEach((([t,e])=>Me(t,e)))},needsUpdate:function(t){return t&&(ke=!0),ke},configure:function(t){t||(t={}),Ie=t.length||30,Le=t.width||80;for(let t=0;t<Ie;++t)Ce[t]=null,Ne[t]=!1},add:Ue,fromActor:function(t,e,i){(t.isPlayer()||t.isVisible())&&Ue(e,i)},forPlayer:function(t,e,i){t.isPlayer()&&Ue(e,i)},addCombat:function(t,e,i){if(t.isPlayer()||t.isVisible()){const t=Te[e];t?e=t(i):i&&(e=oe(e,i)),function(t){De?De+=", "+ce(t):De=t;ke=!0}(e)}},confirmAll:function(){for(let t=0;t<Ne.length;t++)Ne[t]=!0;ke=!0},forEach:function(t){Fe();for(let e=0;e<Ie;++e){const i=(Ie-e+Oe-1)%Ie,n=Ce[i];if(!n)return;if(!1===t(n,Ne[i],e))return}}};!function(t){t[t.E_NEXT_ALWAYS=Y(0)]="E_NEXT_ALWAYS",t[t.E_NEXT_EVERYWHERE=Y(1)]="E_NEXT_EVERYWHERE",t[t.E_TREAT_AS_BLOCKING=Y(3)]="E_TREAT_AS_BLOCKING",t[t.E_PERMIT_BLOCKING=Y(4)]="E_PERMIT_BLOCKING",t[t.E_ABORT_IF_BLOCKS_MAP=Y(5)]="E_ABORT_IF_BLOCKS_MAP",t[t.E_BLOCKED_BY_ITEMS=Y(6)]="E_BLOCKED_BY_ITEMS",t[t.E_BLOCKED_BY_ACTORS=Y(7)]="E_BLOCKED_BY_ACTORS",t[t.E_BLOCKED_BY_OTHER_LAYERS=Y(8)]="E_BLOCKED_BY_OTHER_LAYERS",t[t.E_SUPERPRIORITY=Y(9)]="E_SUPERPRIORITY",t[t.E_NO_MARK_FIRED=Y(11)]="E_NO_MARK_FIRED",t[t.E_PROTECTED=Y(12)]="E_PROTECTED",t[t.E_SPREAD_CIRCLE=Y(13)]="E_SPREAD_CIRCLE",t[t.E_SPREAD_LINE=Y(14)]="E_SPREAD_LINE",t[t.E_EVACUATE_CREATURES=Y(18)]="E_EVACUATE_CREATURES",t[t.E_EVACUATE_ITEMS=Y(19)]="E_EVACUATE_ITEMS",t[t.E_BUILD_IN_WALLS=Y(20)]="E_BUILD_IN_WALLS",t[t.E_MUST_TOUCH_WALLS=Y(21)]="E_MUST_TOUCH_WALLS",t[t.E_NO_TOUCH_WALLS=Y(22)]="E_NO_TOUCH_WALLS",t[t.E_FIRED=Y(23)]="E_FIRED",t[t.E_CLEAR_GROUND=Y(17)]="E_CLEAR_GROUND",t[t.E_CLEAR_SURFACE=Y(24)]="E_CLEAR_SURFACE",t[t.E_CLEAR_LIQUID=Y(25)]="E_CLEAR_LIQUID",t[t.E_CLEAR_GAS=Y(26)]="E_CLEAR_GAS",t[t.E_CLEAR_CELL=t.E_CLEAR_GROUND|t.E_CLEAR_SURFACE|t.E_CLEAR_LIQUID|t.E_CLEAR_GAS]="E_CLEAR_CELL",t[t.E_ONLY_IF_EMPTY=t.E_BLOCKED_BY_ITEMS|t.E_BLOCKED_BY_ACTORS]="E_ONLY_IF_EMPTY",t[t.E_ACTIVATE_DORMANT_MONSTER=Y(27)]="E_ACTIVATE_DORMANT_MONSTER",t[t.E_AGGRAVATES_MONSTERS=Y(28)]="E_AGGRAVATES_MONSTERS",t[t.E_RESURRECT_ALLY=Y(29)]="E_RESURRECT_ALLY",t[t.E_EMIT_EVENT=Y(30)]="E_EMIT_EVENT"}(Be||(Be={}));class Ge{constructor(t,e=null){this.map=null,this.ctx={},this.effects=[],this.flags=0,this.chance=0,this.next=null,this.id=null,this._grid=null,Array.isArray(t)||(t=[t]),this.effects=t.slice(),this.next=e}get grid(){return this._grid||(this._grid=V(this.map.width,this.map.height)),this._grid}async fire(t,e,i,n={}){let r=!1;if(this.map=t,this.ctx=n,this.chance&&!C.chance(this.chance))return!1;for(let t=0;t<this.effects.length;++t){const n=this.effects[t];r=await n(this,e,i)||r}if(!r||!t.isVisible(e,i)||this.flags&Be.E_NO_MARK_FIRED||(this.flags|=Be.E_FIRED),this.next&&(r||this.flags&Be.E_NEXT_ALWAYS)&&!I.gameHasEnded){let n=this.next;"string"==typeof n&&(n=He[n]||null),n?this._grid&&this.flags&Be.E_NEXT_EVERYWHERE?await this.grid.forEachAsync((async(e,i,s)=>{e&&(r=await n.fire(t,i,s)||r)})):r=await n.fire(t,e,i)||r:_("Unknown next effect - "+this.next)}return this._grid&&(q(this._grid),this._grid=null),r}reset(){this.flags&=~Be.E_FIRED}}function We(t){const e=[];return Object.entries(t).forEach((([t,i])=>{if("fn"===t)e.push(i);else{const n=Ve[t];if(!n)return;const r=n(i);r&&e.push(r)}})),e}const He={};function Xe(t){if(t||_("opts required to make effect."),"string"==typeof t){const e=He[t];if(e)return e;_("string effect config must be id of installed effect.")}else"function"==typeof t&&(t={fn:t});const e=We(t);let i=t.next;i&&"string"!=typeof i&&(i=Ke(i));const n=new Ge(e,i);return n.flags=F(Be,t.flags),n.chance=t.chance||0,n}function Ke(t){if(!t)return null;if("string"==typeof t){const e=He[t];if(e)return e;_("Unknown effect - "+t)}else if(t instanceof Ge)return t;return Xe(t)}function je(t,e){return e instanceof Ge||(e=Xe(e)),He[t]=e,e.id=t,e}O.effect=Xe;const Ve={};function qe(t,e){Ve[t]=e}async function ze(t,e,i){return!!this.emit&&(await Nt(this.emit,e,i,t),!0)}function $e(t){return"string"!=typeof t&&_("Emit must be configured with name of event to emit"),ze.bind({emit:t})}async function Ze(t,e,i){const n=t.map,r=!!(t.flags&Be.E_FIRED),s=t.ctx;return s.actor=s.actor||n.actorAt(e,i),s.item=s.item||n.itemAt(e,i),!(!this.message||!this.message.length||r||!n.isVisible(e,i))&&(Ue(this.message,t.ctx),!0)}function Qe(t){return"string"!=typeof t&&_("Emit must be configured with name of event to emit"),Ze.bind({message:t})}qe("emit",$e),qe("message",Qe);var Je={__proto__:null,get Flags(){return Be},Effect:Ge,makeEffects:We,effects:He,make:Xe,from:Ke,install:je,installAll:function(t){Object.entries(t).forEach((([t,e])=>{je(t,e)}))},resetAll:function(){Object.values(He).forEach((t=>t.reset()))},effectTypes:Ve,installType:qe,fire:async function(t,e,i,n,r={}){const s=Ke(t);return!!s&&s.fire(e,i,n,r)},effectEmit:ze,makeEmit:$e,effectMessage:Ze,makeMessage:Qe};t.Random=M,t.canvas=Re,t.color=ie,t.colors=Ht,t.config=L,t.cosmetic=N,t.data=I,t.effect=Je,t.events=It,t.flag=B,t.flags={},t.fov=_t,t.frequency=Lt,t.grid=$,t.io=gt,t.loop=dt,t.make=O,t.message=Pe,t.path=At,t.random=C,t.range=U,t.scheduler=Ot,t.sprite=Se,t.sprites=Ae,t.text=ye,t.types={__proto__:null},t.utils=v,Object.defineProperty(t,"__esModule",{value:!0})}));
//# sourceMappingURL=gw-utils.min.js.map
