!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("gw-utils")):"function"==typeof define&&define.amd?define(["exports","gw-utils"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).GW=t.GW||{},t.GW)}(this,(function(t,e){"use strict";var i;!function(t){t[t.ALL_LAYERS=-1]="ALL_LAYERS",t[t.GROUND=0]="GROUND",t[t.LIQUID=1]="LIQUID",t[t.SURFACE=2]="SURFACE",t[t.GAS=3]="GAS",t[t.ITEM=4]="ITEM",t[t.ACTOR=5]="ACTOR",t[t.PLAYER=6]="PLAYER",t[t.FX=7]="FX",t[t.UI=8]="UI"}(i||(i={}));const l=e.flag.fl;var s,a,r,_,h,n,o;!function(t){t[t.L_SUPERPRIORITY=l(1)]="L_SUPERPRIORITY",t[t.L_SECRETLY_PASSABLE=l(2)]="L_SECRETLY_PASSABLE",t[t.L_BLOCKS_MOVE=l(3)]="L_BLOCKS_MOVE",t[t.L_BLOCKS_VISION=l(4)]="L_BLOCKS_VISION",t[t.L_BLOCKS_SURFACE=l(6)]="L_BLOCKS_SURFACE",t[t.L_BLOCKS_LIQUID=l(8)]="L_BLOCKS_LIQUID",t[t.L_BLOCKS_GAS=l(7)]="L_BLOCKS_GAS",t[t.L_BLOCKS_ITEMS=l(5)]="L_BLOCKS_ITEMS",t[t.L_BLOCKS_ACTORS=l(11)]="L_BLOCKS_ACTORS",t[t.L_BLOCKS_EFFECTS=l(9)]="L_BLOCKS_EFFECTS",t[t.L_BLOCKS_DIAGONAL=l(10)]="L_BLOCKS_DIAGONAL",t[t.L_INTERRUPT_WHEN_SEEN=l(11)]="L_INTERRUPT_WHEN_SEEN",t[t.L_LIST_IN_SIDEBAR=l(12)]="L_LIST_IN_SIDEBAR",t[t.L_VISUALLY_DISTINCT=l(13)]="L_VISUALLY_DISTINCT",t[t.L_BRIGHT_MEMORY=l(14)]="L_BRIGHT_MEMORY",t[t.L_INVERT_WHEN_HIGHLIGHTED=l(15)]="L_INVERT_WHEN_HIGHLIGHTED",t[t.L_BLOCKED_BY_STAIRS=t.L_BLOCKS_ITEMS|t.L_BLOCKS_SURFACE|t.L_BLOCKS_GAS|t.L_BLOCKS_LIQUID|t.L_BLOCKS_EFFECTS|t.L_BLOCKS_ACTORS]="L_BLOCKED_BY_STAIRS",t[t.L_BLOCKS_SCENT=t.L_BLOCKS_MOVE|t.L_BLOCKS_VISION]="L_BLOCKS_SCENT",t[t.L_DIVIDES_LEVEL=t.L_BLOCKS_MOVE]="L_DIVIDES_LEVEL",t[t.L_WAYPOINT_BLOCKER=t.L_BLOCKS_MOVE]="L_WAYPOINT_BLOCKER",t[t.L_IS_WALL=t.L_BLOCKS_MOVE|t.L_BLOCKS_VISION|t.L_BLOCKS_LIQUID|t.L_BLOCKS_GAS|t.L_BLOCKS_EFFECTS|t.L_BLOCKS_DIAGONAL]="L_IS_WALL",t[t.L_BLOCKS_EVERYTHING=t.L_IS_WALL|t.L_BLOCKS_ITEMS|t.L_BLOCKS_ACTORS|t.L_BLOCKS_SURFACE]="L_BLOCKS_EVERYTHING"}(s||(s={})),function(t){t[t.DFF_SUBSEQ_ALWAYS=l(0)]="DFF_SUBSEQ_ALWAYS",t[t.DFF_SUBSEQ_EVERYWHERE=l(1)]="DFF_SUBSEQ_EVERYWHERE",t[t.DFF_TREAT_AS_BLOCKING=l(2)]="DFF_TREAT_AS_BLOCKING",t[t.DFF_PERMIT_BLOCKING=l(3)]="DFF_PERMIT_BLOCKING",t[t.DFF_ACTIVATE_DORMANT_MONSTER=l(4)]="DFF_ACTIVATE_DORMANT_MONSTER",t[t.DFF_BLOCKED_BY_OTHER_LAYERS=l(6)]="DFF_BLOCKED_BY_OTHER_LAYERS",t[t.DFF_SUPERPRIORITY=l(7)]="DFF_SUPERPRIORITY",t[t.DFF_AGGRAVATES_MONSTERS=l(8)]="DFF_AGGRAVATES_MONSTERS",t[t.DFF_RESURRECT_ALLY=l(9)]="DFF_RESURRECT_ALLY",t[t.DFF_EMIT_EVENT=l(10)]="DFF_EMIT_EVENT",t[t.DFF_NO_REDRAW_CELL=l(11)]="DFF_NO_REDRAW_CELL",t[t.DFF_ABORT_IF_BLOCKS_MAP=l(12)]="DFF_ABORT_IF_BLOCKS_MAP",t[t.DFF_BLOCKED_BY_ITEMS=l(13)]="DFF_BLOCKED_BY_ITEMS",t[t.DFF_BLOCKED_BY_ACTORS=l(14)]="DFF_BLOCKED_BY_ACTORS",t[t.DFF_ALWAYS_FIRE=l(15)]="DFF_ALWAYS_FIRE",t[t.DFF_NO_MARK_FIRED=l(16)]="DFF_NO_MARK_FIRED",t[t.DFF_PROTECTED=l(19)]="DFF_PROTECTED",t[t.DFF_SPREAD_CIRCLE=l(20)]="DFF_SPREAD_CIRCLE",t[t.DFF_SPREAD_LINE=l(21)]="DFF_SPREAD_LINE",t[t.DFF_NULL_SURFACE=l(22)]="DFF_NULL_SURFACE",t[t.DFF_NULL_LIQUID=l(23)]="DFF_NULL_LIQUID",t[t.DFF_NULL_GAS=l(24)]="DFF_NULL_GAS",t[t.DFF_EVACUATE_CREATURES=l(25)]="DFF_EVACUATE_CREATURES",t[t.DFF_EVACUATE_ITEMS=l(26)]="DFF_EVACUATE_ITEMS",t[t.DFF_BUILD_IN_WALLS=l(27)]="DFF_BUILD_IN_WALLS",t[t.DFF_MUST_TOUCH_WALLS=l(28)]="DFF_MUST_TOUCH_WALLS",t[t.DFF_NO_TOUCH_WALLS=l(29)]="DFF_NO_TOUCH_WALLS",t[t.DFF_ONLY_IF_EMPTY=t.DFF_BLOCKED_BY_ITEMS|t.DFF_BLOCKED_BY_ACTORS]="DFF_ONLY_IF_EMPTY",t[t.DFF_NULLIFY_CELL=t.DFF_NULL_SURFACE|t.DFF_NULL_LIQUID|t.DFF_NULL_GAS]="DFF_NULLIFY_CELL"}(a||(a={})),function(t){t[t.T_BRIDGE=l(0)]="T_BRIDGE",t[t.T_AUTO_DESCENT=l(1)]="T_AUTO_DESCENT",t[t.T_LAVA=l(2)]="T_LAVA",t[t.T_DEEP_WATER=l(3)]="T_DEEP_WATER",t[t.T_IS_FLAMMABLE=l(4)]="T_IS_FLAMMABLE",t[t.T_SPONTANEOUSLY_IGNITES=l(5)]="T_SPONTANEOUSLY_IGNITES",t[t.T_IS_FIRE=l(6)]="T_IS_FIRE",t[t.T_EXTINGUISHES_FIRE=l(7)]="T_EXTINGUISHES_FIRE",t[t.T_IS_SECRET=l(8)]="T_IS_SECRET",t[t.T_IS_TRAP=l(9)]="T_IS_TRAP",t[t.T_SACRED=l(10)]="T_SACRED",t[t.T_UP_STAIRS=l(11)]="T_UP_STAIRS",t[t.T_DOWN_STAIRS=l(12)]="T_DOWN_STAIRS",t[t.T_PORTAL=l(13)]="T_PORTAL",t[t.T_IS_DOOR=l(14)]="T_IS_DOOR",t[t.T_ALLOWS_SUBMERGING=l(15)]="T_ALLOWS_SUBMERGING",t[t.T_ENTANGLES=l(16)]="T_ENTANGLES",t[t.T_REFLECTS=l(17)]="T_REFLECTS",t[t.T_STAND_IN_TILE=l(18)]="T_STAND_IN_TILE",t[t.T_CONNECTS_LEVEL=l(19)]="T_CONNECTS_LEVEL",t[t.T_HAS_STAIRS=t.T_UP_STAIRS|t.T_DOWN_STAIRS|t.T_PORTAL]="T_HAS_STAIRS",t[t.T_OBSTRUCTS_SCENT=t.T_AUTO_DESCENT|t.T_LAVA|t.T_DEEP_WATER|t.T_SPONTANEOUSLY_IGNITES|t.T_HAS_STAIRS]="T_OBSTRUCTS_SCENT",t[t.T_PATHING_BLOCKER=t.T_AUTO_DESCENT|t.T_IS_TRAP|t.T_LAVA|t.T_DEEP_WATER|t.T_IS_FIRE|t.T_SPONTANEOUSLY_IGNITES|t.T_ENTANGLES]="T_PATHING_BLOCKER",t[t.T_DIVIDES_LEVEL=t.T_AUTO_DESCENT|t.T_IS_TRAP|t.T_LAVA|t.T_DEEP_WATER]="T_DIVIDES_LEVEL",t[t.T_LAKE_PATHING_BLOCKER=t.T_AUTO_DESCENT|t.T_LAVA|t.T_DEEP_WATER|t.T_SPONTANEOUSLY_IGNITES]="T_LAKE_PATHING_BLOCKER",t[t.T_WAYPOINT_BLOCKER=t.T_AUTO_DESCENT|t.T_IS_TRAP|t.T_LAVA|t.T_DEEP_WATER|t.T_SPONTANEOUSLY_IGNITES]="T_WAYPOINT_BLOCKER",t[t.T_MOVES_ITEMS=t.T_DEEP_WATER|t.T_LAVA]="T_MOVES_ITEMS",t[t.T_CAN_BE_BRIDGED=t.T_AUTO_DESCENT|t.T_LAVA|t.T_DEEP_WATER]="T_CAN_BE_BRIDGED",t[t.T_IS_DEEP_LIQUID=t.T_LAVA|t.T_AUTO_DESCENT|t.T_DEEP_WATER]="T_IS_DEEP_LIQUID"}(r||(r={})),function(t){t[t.TM_IS_WIRED=l(9)]="TM_IS_WIRED",t[t.TM_IS_CIRCUIT_BREAKER=l(10)]="TM_IS_CIRCUIT_BREAKER",t[t.TM_VANISHES_UPON_PROMOTION=l(15)]="TM_VANISHES_UPON_PROMOTION",t[t.TM_EXPLOSIVE_PROMOTE=l(21)]="TM_EXPLOSIVE_PROMOTE",t[t.TM_SWAP_ENCHANTS_ACTIVATION=l(25)]="TM_SWAP_ENCHANTS_ACTIVATION"}(_||(_={})),function(t){t[t.VISIBLE=l(0)]="VISIBLE",t[t.WAS_VISIBLE=l(1)]="WAS_VISIBLE",t[t.CLAIRVOYANT_VISIBLE=l(2)]="CLAIRVOYANT_VISIBLE",t[t.WAS_CLAIRVOYANT_VISIBLE=l(3)]="WAS_CLAIRVOYANT_VISIBLE",t[t.TELEPATHIC_VISIBLE=l(4)]="TELEPATHIC_VISIBLE",t[t.WAS_TELEPATHIC_VISIBLE=l(5)]="WAS_TELEPATHIC_VISIBLE",t[t.ITEM_DETECTED=l(6)]="ITEM_DETECTED",t[t.WAS_ITEM_DETECTED=l(7)]="WAS_ITEM_DETECTED",t[t.MONSTER_DETECTED=l(8)]="MONSTER_DETECTED",t[t.WAS_MONSTER_DETECTED=l(9)]="WAS_MONSTER_DETECTED",t[t.REVEALED=l(10)]="REVEALED",t[t.MAGIC_MAPPED=l(11)]="MAGIC_MAPPED",t[t.IN_FOV=l(12)]="IN_FOV",t[t.WAS_IN_FOV=l(13)]="WAS_IN_FOV",t[t.NEEDS_REDRAW=l(14)]="NEEDS_REDRAW",t[t.CELL_CHANGED=l(15)]="CELL_CHANGED",t[t.HAS_SURFACE=l(16)]="HAS_SURFACE",t[t.HAS_LIQUID=l(17)]="HAS_LIQUID",t[t.HAS_GAS=l(18)]="HAS_GAS",t[t.HAS_PLAYER=l(19)]="HAS_PLAYER",t[t.HAS_ACTOR=l(20)]="HAS_ACTOR",t[t.HAS_DORMANT_MONSTER=l(21)]="HAS_DORMANT_MONSTER",t[t.HAS_ITEM=l(22)]="HAS_ITEM",t[t.IS_IN_PATH=l(23)]="IS_IN_PATH",t[t.IS_CURSOR=l(24)]="IS_CURSOR",t[t.STABLE_MEMORY=l(25)]="STABLE_MEMORY",t[t.LIGHT_CHANGED=l(26)]="LIGHT_CHANGED",t[t.CELL_LIT=l(27)]="CELL_LIT",t[t.IS_IN_SHADOW=l(28)]="IS_IN_SHADOW",t[t.CELL_DARK=l(29)]="CELL_DARK",t[t.PERMANENT_CELL_FLAGS=t.REVEALED|t.MAGIC_MAPPED|t.ITEM_DETECTED|t.HAS_ITEM|t.HAS_DORMANT_MONSTER|t.STABLE_MEMORY]="PERMANENT_CELL_FLAGS",t[t.ANY_KIND_OF_VISIBLE=t.VISIBLE|t.CLAIRVOYANT_VISIBLE|t.TELEPATHIC_VISIBLE]="ANY_KIND_OF_VISIBLE",t[t.HAS_ANY_ACTOR=t.HAS_PLAYER|t.HAS_ACTOR]="HAS_ANY_ACTOR",t[t.IS_WAS_ANY_KIND_OF_VISIBLE=t.VISIBLE|t.WAS_VISIBLE|t.CLAIRVOYANT_VISIBLE|t.WAS_CLAIRVOYANT_VISIBLE|t.TELEPATHIC_VISIBLE|t.WAS_TELEPATHIC_VISIBLE]="IS_WAS_ANY_KIND_OF_VISIBLE",t[t.WAS_ANY_KIND_OF_VISIBLE=t.WAS_VISIBLE|t.WAS_CLAIRVOYANT_VISIBLE|t.WAS_TELEPATHIC_VISIBLE]="WAS_ANY_KIND_OF_VISIBLE",t[t.CELL_DEFAULT=t.VISIBLE|t.IN_FOV|t.NEEDS_REDRAW|t.CELL_CHANGED]="CELL_DEFAULT"}(h||(h={})),function(t){t[t.SEARCHED_FROM_HERE=l(0)]="SEARCHED_FROM_HERE",t[t.PRESSURE_PLATE_DEPRESSED=l(1)]="PRESSURE_PLATE_DEPRESSED",t[t.KNOWN_TO_BE_TRAP_FREE=l(2)]="KNOWN_TO_BE_TRAP_FREE",t[t.CAUGHT_FIRE_THIS_TURN=l(4)]="CAUGHT_FIRE_THIS_TURN",t[t.EVENT_FIRED_THIS_TURN=l(5)]="EVENT_FIRED_THIS_TURN",t[t.EVENT_PROTECTED=l(6)]="EVENT_PROTECTED",t[t.IS_IN_LOOP=l(10)]="IS_IN_LOOP",t[t.IS_CHOKEPOINT=l(11)]="IS_CHOKEPOINT",t[t.IS_GATE_SITE=l(12)]="IS_GATE_SITE",t[t.IS_IN_ROOM_MACHINE=l(13)]="IS_IN_ROOM_MACHINE",t[t.IS_IN_AREA_MACHINE=l(14)]="IS_IN_AREA_MACHINE",t[t.IS_POWERED=l(15)]="IS_POWERED",t[t.IMPREGNABLE=l(20)]="IMPREGNABLE",t[t.DARKENED=l(19)]="DARKENED",t[t.IS_IN_MACHINE=t.IS_IN_ROOM_MACHINE|t.IS_IN_AREA_MACHINE]="IS_IN_MACHINE",t[t.PERMANENT_MECH_FLAGS=t.SEARCHED_FROM_HERE|t.PRESSURE_PLATE_DEPRESSED|t.KNOWN_TO_BE_TRAP_FREE|t.IS_IN_LOOP|t.IS_CHOKEPOINT|t.IS_GATE_SITE|t.IS_IN_MACHINE|t.IMPREGNABLE]="PERMANENT_MECH_FLAGS"}(n||(n={})),function(t){t[t.MAP_CHANGED=l(0)]="MAP_CHANGED",t[t.MAP_STABLE_GLOW_LIGHTS=l(1)]="MAP_STABLE_GLOW_LIGHTS",t[t.MAP_STABLE_LIGHTS=l(2)]="MAP_STABLE_LIGHTS",t[t.MAP_ALWAYS_LIT=l(3)]="MAP_ALWAYS_LIT",t[t.MAP_SAW_WELCOME=l(4)]="MAP_SAW_WELCOME",t[t.MAP_NO_LIQUID=l(5)]="MAP_NO_LIQUID",t[t.MAP_NO_GAS=l(6)]="MAP_NO_GAS",t[t.MAP_CALC_FOV=l(7)]="MAP_CALC_FOV",t[t.MAP_FOV_CHANGED=l(8)]="MAP_FOV_CHANGED",t[t.MAP_DEFAULT=t.MAP_STABLE_LIGHTS|t.MAP_STABLE_GLOW_LIGHTS]="MAP_DEFAULT"}(o||(o={}));const E=e.config.light={INTENSITY_DARK:20},c=e.color.make();class L{constructor(t,i,l,s=!1){this.fadeTo=0,this.passThroughActors=!1,this.id=null,this.color=e.color.from(t)||null,this.radius=e.range.make(i||1),this.fadeTo=l||0,this.passThroughActors=s}copy(t){this.color=t.color,this.radius.copy(t.radius),this.fadeTo=t.fadeTo,this.passThroughActors=t.passThroughActors}get intensity(){return g(this.color)}paint(t,i,l,a=!1,r=!1){if(!t)return!1;let _,n,o=this.radius.value(),L=Math.ceil(o);c.copy(this.color).bake();const A=!r&&!a&&g(c)>E.INTENSITY_DARK,T=this.fadeTo,S=e.grid.alloc(t.width,t.height,0);t.calcFov(S,i,l,L,this.passThroughActors?0:h.HAS_ANY_ACTOR,s.L_BLOCKS_VISION);let I=!1;if(S.forCircle(i,l,L,((s,a,r)=>{if(!s)return;const E=t.cell(a,r);for(n=Math.floor(100-(100-T)*(e.utils.distanceBetween(i,l,a,r)/o)),_=0;_<3;_++)E.light[_]+=Math.floor(c[_]*n/100);A&&(E.flags&=~h.IS_IN_SHADOW),E.flags&(h.IN_FOV|h.ANY_KIND_OF_VISIBLE)&&(I=!0)})),A){t.cell(i,l).flags&=~h.IS_IN_SHADOW}return e.grid.free(S),I}}function g(t){return Math.max(t[0],t[1],t[2])}function A(...t){if(1==t.length){const i=t[0];if("string"==typeof i){const t=T[i];if(t)return t;const[l,s,a,r]=i.split(/[,|]/).map((t=>t.trim()));return new L(e.color.from(l),e.range.from(s||1),Number.parseInt(a||"0"),!!r&&"false"!==r)}if(Array.isArray(i)){const[t,e,l,s]=i;return new L(t,e,l,s)}if(i&&i.color)return new L(e.color.from(i.color),e.range.from(i.radius),Number.parseInt(i.fadeTo||"0"),i.pass);throw new Error("Unknown Light config - "+i)}{const[e,i,l,s]=t;return new L(e,i,l,s)}}e.make.light=A;const T={};function S(t,...e){let i;return i=1==e.length?A(e[0]):A(e[0],e[1],e[2],e[3]),T[t]=i,i&&(i.id=t),i}function I(t){let e;t.eachCell((t=>{for(e=0;e<3;e++)t.oldLight[e]=t.light[e],t.lightChanged=!1}))}function f(t){let e;const i=t.ambientLight?t.ambientLight:[0,0,0];t.eachCell(((t,l,s)=>{for(e=0;e<3;e++)t.light[e]=i[e];t.flags|=h.IS_IN_SHADOW}))}function u(t){let e;t.eachCell((t=>{for(e=0;e<3;e++)t.glowLight[e]=t.light[e]}))}function O(t){let e;t.eachCell((t=>{for(e=0;e<3;e++)t.light[e]=t.glowLight[e]}))}function C(t){if(!t.anyLightChanged)return!1;I(t),f(t),t.staticLightChanged?(t.eachStaticLight(((e,i,l)=>{e&&e.paint(t,i,l)})),u(t),t.staticLightChanged=!1):O(t),t.eachDynamicLight(((e,i,l)=>{e.paint(t,i,l)})),function(t){t.eachCell(((t,e,i)=>{t.flags&=~(h.CELL_LIT|h.CELL_DARK),t.light.some(((e,i)=>e!==t.oldLight[i]))&&(t.lightChanged=!0),t.isDark()?t.flags|=h.CELL_DARK:t.flags&h.IS_IN_SHADOW||(t.flags|=h.CELL_LIT)}))}(t);const i=e.data.player;if(i){const e=T.PLAYERS_LIGHT;e&&e.radius&&e.paint(t,i.x,i.y,!0,!0)}return t.anyLightChanged=!1,!0}var F={__proto__:null,config:E,Light:L,intensity:g,make:A,lights:T,from:function(...t){1!=t.length&&e.utils.ERROR("Unknown Light config: "+JSON.stringify(t));const i=t[0];if("string"==typeof i){const t=T[i];if(t)return t}return A(i)},install:S,installAll:function(t={}){Object.entries(t).forEach((([t,e])=>{S(t,e)}))},recordOldLights:I,zeroOutLights:f,recordGlowLights:u,restoreGlowLights:O,updateLighting:C,playerInDarkness:function(t,e,i){return t.cell(e.x,e.y).isDark(i)}};class R{constructor(t){this.priority=50,this.layer=0,this.light=null,this.flags={layer:0},this.sprite=e.make.sprite(t.sprite||t),this.light=t.light?A(t.light):null,this.priority=e.utils.first(t.priority,50),this.layer=(t.layer&&"number"!=typeof t.layer?i[t.layer]:t.layer)||0,this.flags.layer=e.flag.from(s,t.layerFlags,t.flags,0)}hasLayerFlag(t){return(this.flags.layer&t)>0}}function d(t){return new R(t)}e.make.layer=d;var N={__proto__:null,get Flags(){return s},get Depth(){return i},Entity:R,make:d};class D{constructor(t={}){"function"==typeof t&&(t={fn:t}),this.tile=t.tile||null,this.fn=t.fn||null,this.item=t.item||null,this.chance=t.chance||0,this.volume=t.volume||0,this.spread=t.spread||0,this.radius=t.radius||0,this.decrement=t.decrement||0,this.flags=e.flag.from(a,t.flags),this.matchTile=t.matchTile||t.needs||0,this.next=t.next||null,this.message=t.message||null,this.lightFlare=t.flare||null,this.flashColor=t.flash?e.color.from(t.flash):null,this.messageDisplayed=!1,this.emit=t.emit||null,this.id=t.id||null}}function m(t){if(!t)return null;"string"==typeof t&&(t={tile:t});return new D(t)}e.make.tileEvent=m;const y={};function M(t,e){return e instanceof D||(e=m(e)),y[t]=e,e&&(e.id=t),e}async function V(t,i={}){let l,s,_;if(t||e.utils.ERROR("No activation."),i||e.utils.ERROR("Context required - and must include map, x, y"),"string"==typeof t)_=y[t],_||e.utils.ERROR("Unknown tile Event: "+t);else{if("function"==typeof t)return t(i);_=t}const h=i.map,o=i.x,E=i.y;if(void 0!==o&&void 0!==E&&h||e.utils.ERROR("MAP, x, y are required in context."),i.safe&&h.hasCellMechFlag(o,E,n.EVENT_FIRED_THIS_TURN)&&!(_.flags&a.DFF_ALWAYS_FIRE))return!1;i.refreshCell=i.refreshCell||!(_.flags&a.DFF_NO_REDRAW_CELL);const c=i.abortIfBlocking=i.abortIfBlocking||_.flags&a.DFF_ABORT_IF_BLOCKS_MAP;_.message&&_.message.length&&!_.messageDisplayed&&h.isVisible(o,E)&&(_.messageDisplayed=!0,e.message.add(_.message));let L=null;_.tile&&(L=Y[_.tile]||null,L||e.utils.ERROR("Unknown tile: "+_.tile));let g=null;_.item&&"item"in e.make&&(g=e.make.item(_.item),g||e.utils.ERROR("Unknown item: "+_.item));const A=i.blocking=!(!c||_.flags&a.DFF_PERMIT_BLOCKING||!(L&&L.blocksPathing()||g&&g.blocksMove()||_.flags&a.DFF_TREAT_AS_BLOCKING)),T=e.grid.alloc(h.width,h.height);let S=!1;if(P(_,T,i),A&&h.gridDisruptsPassability(T,{bounds:i.bounds})||(_.flags&a.DFF_EVACUATE_CREATURES&&H(h,T)&&(S=!0),_.flags&a.DFF_EVACUATE_ITEMS&&G(h,T)&&(S=!0),_.flags&a.DFF_NULLIFY_CELL&&U(h,T,_.flags)&&(S=!0),(L||g||_.fn)&&await p(_,T,i,L,g)&&(S=!0)),g&&g.delete(),S&&_.flags&a.DFF_PROTECTED&&T.forEach(((t,e,i)=>{if(!t)return;h.cell(e,i).mechFlags|=n.EVENT_PROTECTED})),S)for(let t=0;t<T.width;++t)for(let i=0;i<T.height;++i){if(!T[t][i]||e.data.gameHasEnded)continue;const l=h.cell(t,i);(l.actor||l.item)&&await l.activate("enter",{map:h,x:t,y:i,cell:l})}if(_.emit&&(await e.events.emit(_.emit,i),S=!0),e.data.gameHasEnded)return e.grid.free(T),S;if(_.next&&(S||_.flags&a.DFF_SUBSEQ_ALWAYS))if(_.flags&a.DFF_SUBSEQ_EVERYWHERE){for(l=0;l<h.width;l++)for(s=0;s<h.height;s++)T[l][s]&&(i.x=l,i.y=s,await V(_.next,i));i.x=o,i.y=E}else await V(_.next,i);return S&&L&&L.flags.tile&(r.T_DEEP_WATER|r.T_LAVA|r.T_AUTO_DESCENT)&&(e.data.updateMapToShoreThisTurn=!1),S&&(T.forEach(((t,e,i)=>{t&&h.redrawXY(e,i)})),h.changed=!0,_.flags&a.DFF_NO_MARK_FIRED||T.forEach(((t,e,i)=>{t&&h.setCellFlags(e,i,0,n.EVENT_FIRED_THIS_TURN)}))),e.grid.free(T),S}function B(t,e,i,l={}){const r=l.map;if(!r.hasXY(e,i))return!1;const _=r.cell(e,i);if(t.flags&a.DFF_BUILD_IN_WALLS){if(!_.isWall())return!1}else if(t.flags&a.DFF_MUST_TOUCH_WALLS){let t=!1;if(r.eachNeighbor(e,i,(e=>{e.isWall()&&(t=!0)})),!t)return!1}else if(t.flags&a.DFF_NO_TOUCH_WALLS){let t=!0;if(_.isWall())return!1;if(r.eachNeighbor(e,i,(e=>{e.isWall()&&(t=!1)})),!t)return!1}return!(l.bounds&&!l.bounds.containsXY(e,i))&&(!(t.matchTile&&!_.hasTile(t.matchTile))&&!(_.hasLayerFlag(s.L_BLOCKS_EFFECTS)&&!t.matchTile&&(l.x!=e||l.y!=i)))}function P(t,i,l={}){let s,r,_,h,n,o,E;const c=l.map,L=l.x,g=l.y;l.bounds;let A=t.spread||0,T=t.decrement||0;if(t.matchTile&&"string"==typeof t.matchTile){const i=t.matchTile,l=Y[i];l||e.utils.ERROR("Failed to find match tile with name:"+i),t.matchTile=l.id}i.fill(0),i[L][g]=h=1;let S=t.radius||0;if(t.flags&a.DFF_SPREAD_CIRCLE){for(S=0,A=A||100,A>=100&&(T=T||100);e.random.chance(A);)A-=T,++S;A=100,T=0}if(S)A=A||100,i.updateCircle(L,g,S,((i,s,a)=>{if(!B(t,s,a,l))return 0;const r=Math.floor(e.utils.distanceBetween(L,g,s,a)),_=A-r*T;return e.random.chance(_)?1:0})),i[L][g]=1;else if(A)if(E=!0,A>=100&&(T=T||100),t.flags&a.DFF_SPREAD_LINE){n=L,o=g;const s=e.utils.DIRS[e.random.number(4)];for(;E;)E=!1,n+=s[0],o+=s[1],i.hasXY(n,o)&&!i[n][o]&&B(t,n,o,l)&&e.random.chance(A)&&(i[n][o]=1,E=!0,A-=T)}else for(T<=0&&(T=A);E&&A>0;){for(E=!1,h++,s=0;s<c.width;s++)for(r=0;r<c.height;r++)if(i[s][r]==h-1)for(_=0;_<4;_++)n=s+e.utils.DIRS[_][0],o=r+e.utils.DIRS[_][1],i.hasXY(n,o)&&!i[n][o]&&B(t,n,o,l)&&e.random.chance(A)&&(i[n][o]=h,E=!0);A-=T}B(t,L,g,l)||(i[L][g]=0)}async function p(t,e,l,r,_){let h,o,E;E=!1;const c=t.flags&a.DFF_BLOCKED_BY_OTHER_LAYERS,L=t.flags&a.DFF_SUPERPRIORITY,g=(l.refreshCell,l.map),A=l.volume||t.volume||0;for(h=0;h<e.width;h++)for(o=0;o<e.height;o++){if(!e[h][o])continue;e[h][o]=0;const T=g.cell(h,o);if(!(T.mechFlags&n.EVENT_PROTECTED)){if(r&&(T.tile(r.layer)===r?r.layer==i.GAS?(e[h][o]=1,T.gasVolume+=A):r.layer==i.LIQUID&&(e[h][o]=1,T.liquidVolume+=A):!(L||T.tile(r.layer).priority<r.priority)||T.obstructsLayer(r.layer)||T.item&&t.flags&a.DFF_BLOCKED_BY_ITEMS||T.actor&&t.flags&a.DFF_BLOCKED_BY_ACTORS||c&&!(T.topmostTile().priority<r.priority)||(e[h][o]=1,g.setTile(h,o,r,A),E=!0)),_&&(L||!T.item)&&!T.hasLayerFlag(s.L_BLOCKS_ITEMS)){e[h][o]=1,T.item&&g.removeItem(T.item);const t=_.clone();g.addItem(h,o,t),E=!0}t.fn&&(l.spawnMap=e,await t.fn(h,o,l)&&(e[h][o]=1,E=!0))}}return E&&(g.changed=!0),E}function U(t,e,i){let l=!1;const s=i&a.DFF_NULL_SURFACE,r=i&a.DFF_NULL_LIQUID,_=i&a.DFF_NULL_GAS;return e.forEach(((e,i,a)=>{e&&(t.clearCellLayers(i,a,!!r,!!s,!!_),l=!0)})),l}function H(t,e){let i,l,s=!1;for(i=0;i<t.width;i++)for(l=0;l<t.height;l++){if(!e[i][l])continue;const a=t.cell(i,l);if(!a.actor)continue;const r=a.actor,_=t.matchingLocNear(i,l,(t=>!r.forbidsCell(t)),{hallways:!0,blockingMap:e});_&&_[0]>=0&&_[1]>=0&&(t.moveActor(_[0],_[1],r),s=!0)}return s}function G(t,e){let i=!1;return e.forEach(((l,s,a)=>{if(!l)return;const r=t.cell(s,a);if(!r.item)return;const _=r.item,h=t.matchingLocNear(s,a,(t=>!_.forbidsCell(t)),{hallways:!0,blockingMap:e});h&&h[0]>=0&&h[1]>=0&&(t.removeItem(_),t.addItem(h[0],h[1],_),i=!0)})),i}var b={__proto__:null,get Flags(){return a},TileEvent:D,make:m,activations:y,install:M,installAll:function(t){Object.entries(t).forEach((([t,e])=>{M(t,e)}))},resetAllMessages:function(){Object.values(y).forEach((t=>{t instanceof D&&(t.messageDisplayed=!1)}))},spawn:V,computeSpawnMap:P,spawnTiles:p,nullifyCells:U,evacuateCreatures:H,evacuateItems:G};class W extends R{constructor(t){super((()=>{if(!t.Extends)return t;if("string"==typeof t.Extends&&(t.Extends=Y[t.Extends],!t.Extends))throw new Error("Unknown tile base - "+t.Extends);const i=t.Extends;return t.ch=e.utils.first(t.ch,i.sprite.ch,-1),t.fg=e.utils.first(t.fg,i.sprite.fg,-1),t.bg=e.utils.first(t.bg,i.sprite.bg,-1),t.layer=e.utils.first(t.layer,i.layer),t.priority=e.utils.first(t.priority,i.priority),t.opacity=e.utils.first(t.opacity,i.sprite.opacity),t.light=e.utils.first(t.light,i.light),t})()),this.flags={layer:0,tile:0,tileMech:0},this.activates={},this.flavor=null,this.desc=null,this.article=null,this.dissipate=2e3,this.defaultGround=null;let i=t.Extends;i&&(e.utils.assignOmitting(["sprite","depth","priority","activates","flags","light"],this,i),i.activates&&Object.assign(this.activates,i.activates),Object.assign(this.flags,i.flags)),e.utils.assignOmitting(["Extends","extends","flags","layerFlags","mechFlags","sprite","activates","ch","fg","bg","opacity","light","layer","priority","flags","ground","light"],this,t),this.name=t.name||(i?i.name:t.id),this.id=t.id,t.ground&&(this.defaultGround=t.ground),this.flags.tile=e.flag.from(r,this.flags.tile,t.flags),this.flags.layer=e.flag.from(s,this.flags.layer,t.layerFlags||t.flags),this.flags.tileMech=e.flag.from(_,this.flags.tileMech,t.mechFlags||t.flags),t.activates&&Object.entries(t.activates).forEach((([t,e])=>{if(e){const i=m(e);this.activates[t]=i}else delete this.activates[t]}))}hasAllFlags(t){return(this.flags.tile&t)===t}hasAllLayerFlags(t){return(this.flags.layer&t)===t}hasAllMechFlags(t){return(this.flags.tileMech&t)===t}blocksPathing(){return this.flags.layer&s.L_BLOCKS_MOVE||this.flags.tile&r.T_PATHING_BLOCKER}activatesOn(t){return!!this.activates[t]}getName(t){let i={};if(!0===t||!1===t||"string"==typeof t?i.article=t:t&&(i=t),!i.article&&!i.color)return this.name;let l=this.name;if(i.color){let t=i.color;!0===i.color&&(t=this.sprite.fg||"white"),"string"!=typeof t&&(t=e.color.from(t).toString()),l=`Ω${t}Ω${this.name}∆`}if(i.article){l=("string"==typeof i.article?i.article:this.article||"a")+" "+l}return l}getDescription(t={}){return this.getName(t)}}function K(t){return new W(t)}e.make.tile=K;const Y={};function w(...t){let i=t[0],l=t[1],s=t[2];1==arguments.length?(s=t[0],l=s.Extends||null,i=s.id):2==arguments.length&&(s=l),"string"==typeof l&&(s.Extends=Y[l]||e.utils.ERROR("Unknown base tile: "+l)),s.id=i;const a=K(s);return Y[i]=a,a}var v={__proto__:null,get Flags(){return r},get MechFlags(){return _},Tile:W,make:K,tiles:Y,install:w,installAll:function(t){Object.entries(t).forEach((([t,e])=>{e.id=t,w(t,e)}))}};e.color.install("cursorColor",25,100,150),e.config.cursorPathIntensity=50;class x{constructor(){this.mixer=new e.sprite.Mixer,this.item=null,this.itemQuantity=0,this.actor=null,this.tile=null,this.cellFlags=0,this.cellMechFlags=0,this.layerFlags=0,this.tileFlags=0,this.tileMechFlags=0}clear(){this.mixer.nullify(),this.item=null,this.itemQuantity=0,this.actor=null,this.tile=null,this.cellFlags=0,this.cellMechFlags=0,this.layerFlags=0,this.tileFlags=0,this.tileMechFlags=0}copy(t){const e=this.mixer;Object.assign(this,t),this.mixer=e,this.mixer.copy(t.mixer)}}class k{constructor(){this._tiles=[],this.layers=null,this._actor=null,this._item=null,this.data={},this.flags=h.CELL_DEFAULT,this.mechFlags=0,this.gasVolume=0,this.liquidVolume=0,this.machineNumber=0,this.memory=new x,this.light=[100,100,100],this.oldLight=[100,100,100],this.glowLight=[100,100,100]}copy(t){e.utils.copyObject(this,t)}clear(){for(let t=0;t<this._tiles.length;++t)this._tiles[t]=null;this.layers=null,this._actor=null,this._item=null,this.data={},this.flags=h.CELL_DEFAULT,this.mechFlags=0,this.gasVolume=0,this.liquidVolume=0,this.machineNumber=0,this.memory.clear(),this.light=[100,100,100],this.oldLight=[100,100,100],this.glowLight=[100,100,100]}clearLayers(t=!1,e=!1,i=!1){t&&(this._tiles[1]=null,this.liquidVolume=0),e&&(this._tiles[2]=null),i&&(this._tiles[3]=null,this.gasVolume=0),this.flags|=h.CELL_CHANGED}get ground(){var t;return(null===(t=this._tiles[i.GROUND])||void 0===t?void 0:t.id)||null}get liquid(){var t;return(null===(t=this._tiles[i.LIQUID])||void 0===t?void 0:t.id)||null}get surface(){var t;return(null===(t=this._tiles[i.SURFACE])||void 0===t?void 0:t.id)||null}get gas(){var t;return(null===(t=this._tiles[i.GAS])||void 0===t?void 0:t.id)||null}get groundTile(){return this._tiles[i.GROUND]||Y.NULL}get liquidTile(){return this._tiles[i.LIQUID]||Y.NULL}get surfaceTile(){return this._tiles[i.SURFACE]||Y.NULL}get gasTile(){return this._tiles[i.GAS]||Y.NULL}dump(){if(this.actor)return this.actor.sprite.ch;if(this.item)return this.item.sprite.ch;for(let t=this._tiles.length-1;t>=0;--t){if(!this._tiles[t])continue;const e=this._tiles[t]||Y.NULL;if(e.sprite.ch)return e.sprite.ch}return Y.NULL.sprite.ch}get changed(){return(this.flags&h.CELL_CHANGED)>0}set changed(t){t?this.flags|=h.CELL_CHANGED:this.flags&=~h.CELL_CHANGED}isVisible(){return this.flags&h.VISIBLE}isAnyKindOfVisible(){return this.flags&h.ANY_KIND_OF_VISIBLE}isOrWasAnyKindOfVisible(){return this.flags&h.IS_WAS_ANY_KIND_OF_VISIBLE}isRevealed(t=!1){const e=h.REVEALED|(t?h.MAGIC_MAPPED:0);return(this.flags&e)>0}listInSidebar(){return this.hasLayerFlag(s.L_LIST_IN_SIDEBAR,!0)}get needsRedraw(){return(this.flags&h.NEEDS_REDRAW)>0}set needsRedraw(t){t?this.flags|=h.NEEDS_REDRAW:this.flags&=~h.NEEDS_REDRAW}hasVisibleLight(){return g(this.light)>e.config.light.INTENSITY_DARK}isDark(t){const i=t?g(t):e.config.light.INTENSITY_DARK;return g(this.light)<=i}get lightChanged(){return(this.flags&h.LIGHT_CHANGED)>0}set lightChanged(t){t?this.flags|=h.LIGHT_CHANGED|h.NEEDS_REDRAW:this.flags&=~h.LIGHT_CHANGED}tile(t=i.GROUND){return this._tiles[t]||Y.NULL}*tiles(){for(let t of this._tiles)t&&(yield t)}layerFlags(t=!1){if(t&&!this.isVisible())return this.memory.layerFlags;let e=0;for(let t of this.tiles())e|=t.flags.layer;return e}tileFlags(t=!1){if(t&&!this.isVisible())return this.memory.tileFlags;let e=0;for(let t of this.tiles())e|=t.flags.tile;return e}tileMechFlags(t=!1){if(t&&!this.isVisible())return this.memory.tileMechFlags;let e=0;for(let t of this.tiles())e|=t.flags.tileMech;return e}hasLayerFlag(t,e=!1){return!!(t&this.layerFlags(e))}hasAllLayerFlags(t,e=!1){return(t&this.layerFlags(e))===t}hasTileFlag(t,e=!1){return!!(t&this.tileFlags(e))}hasAllTileFlags(t,e=!1){return(t&this.tileFlags(e))===t}hasTileMechFlag(t,e=!1){return!!(t&this.tileMechFlags(e))}hasAllTileMechFlags(t,e=!1){return(t&this.tileMechFlags(e))===t}setFlags(t=0,e=0){this.flags|=t,this.mechFlags|=e}clearFlags(t=0,e=0){this.flags&=~t,this.mechFlags&=~e}hasFlag(t,e=!1){return(t&(e&&!this.isAnyKindOfVisible()?this.memory.cellFlags:this.flags))>0}hasMechFlag(t,e=!1){return(t&(e&&!this.isAnyKindOfVisible()?this.memory.cellMechFlags:this.mechFlags))>0}hasTile(t){let e;return e=t instanceof W?t.id:t,this._tiles.some((t=>t&&t.id===e))}topmostTile(t=!1){let e=Y.NULL,l=-1e4;for(let s=i.GROUND;s<=(t?i.LIQUID:i.GAS);++s){const t=this._tiles[s];t&&(t.priority>l&&(e=t,l=t.priority))}return e}tileWithLayerFlag(t){for(let e of this.tiles())if(e.flags.layer&t)return e;return null}tileWithFlag(t){for(let e of this.tiles())if(e.flags.tile&t)return e;return null}tileWithMechFlag(t){for(let e of this.tiles())if(e.flags.tileMech&t)return e;return null}tileDesc(){return this.topmostTile().desc}tileFlavor(){return this.topmostTile().flavor}getName(t={}){return this.topmostTile().getName(t)}isClear(){return null==this.ground}isEmpty(){return!(this._actor||this._item)}isMoveableNow(t=!1){return 0==((t&&!this.isAnyKindOfVisible()?this.memory.layerFlags:this.layerFlags(!1))&s.L_BLOCKS_MOVE)}isWalkableNow(t=!1){const e=t&&!this.isAnyKindOfVisible();if((e?this.memory.layerFlags:this.layerFlags(!1))&s.L_BLOCKS_MOVE)return!1;const i=e?this.memory.tileFlags:this.tileFlags();return!(i&r.T_IS_DEEP_LIQUID)||(i&r.T_BRIDGE)>0}canBeWalked(t=!1){if(this.isWalkableNow(t))return!0;return((t&&!this.isAnyKindOfVisible()?this.memory.layerFlags:this.layerFlags(!1))&s.L_SECRETLY_PASSABLE)>0}isWall(t=!1){return((t&&!this.isAnyKindOfVisible()?this.memory.layerFlags:this.layerFlags())&s.L_IS_WALL)===s.L_IS_WALL}isObstruction(t=!1){return!!((t&&!this.isAnyKindOfVisible()?this.memory.layerFlags:this.layerFlags())&s.L_BLOCKS_DIAGONAL)}isDoorway(t=!1){let e=t&&!this.isAnyKindOfVisible()?this.memory.layerFlags:this.layerFlags();return(e&s.L_BLOCKS_VISION)>0&&0==(e&s.L_BLOCKS_MOVE)}isSecretDoorway(t=!1){if(t)return!1;return(this.layerFlags(t)&s.L_SECRETLY_PASSABLE)>0}blocksPathing(t=!1){const e=t&&!this.isAnyKindOfVisible();if(!this.isWalkableNow(t))return!0;return!!((e?this.memory.tileFlags:this.tileFlags())&r.T_PATHING_BLOCKER)}blocksVision(){return!!(this.layerFlags()&s.L_BLOCKS_VISION)}isLiquid(t=!1){return!!((t&&!this.isAnyKindOfVisible()?this.memory.tileFlags:this.tileFlags())&r.T_IS_DEEP_LIQUID)}hasGas(t=!1){return!!((t&&!this.isAnyKindOfVisible()?this.memory.cellFlags:this.flags)&h.HAS_GAS)}markRevealed(){return this.flags&=~h.STABLE_MEMORY,!(this.flags&h.REVEALED)&&(this.flags|=h.REVEALED,!this.isWall())}obstructsLayer(t){return t===i.SURFACE&&this.hasLayerFlag(s.L_BLOCKS_SURFACE)}setTile(t=null,l=0,a){let _;if(a=a||e.data.map,null===t?(_=Y.NULL,t=null):"string"==typeof t?_=Y[t]:t instanceof W&&(_=t,t=_.id),!_)return e.utils.ERROR("Unknown tile - "+t);_.layer>0&&!this._tiles[0]&&this.setTile(_.defaultGround||Y.FLOOR,0,a);const E=this._tiles[_.layer]||Y.NULL,c=E===Y.NULL?null:E.id;E.blocksPathing()!=_.blocksPathing()&&(e.data.staleLoopMap=!0),_.flags.tile&r.T_IS_FIRE&&!(E.flags.tile&r.T_IS_FIRE)&&(this.mechFlags|=n.CAUGHT_FIRE_THIS_TURN);const L=_.flags.layer&s.L_BLOCKS_VISION,g=E.flags.layer&s.L_BLOCKS_VISION;a&&this.isAnyKindOfVisible()&&L!=g&&a.setFlag(o.MAP_FOV_CHANGED),null!==c&&this.removeLayer(E),this._tiles[_.layer]=null===t?null:_,null!==t&&this.addLayer(_);let A=0;return _.layer==i.LIQUID?(A=h.HAS_LIQUID,this.liquidVolume=l+(t==c?this.liquidVolume:0),a&&a.clearFlag(o.MAP_NO_LIQUID)):_.layer==i.GAS?(A=h.HAS_GAS,this.gasVolume=l+(t==c?this.gasVolume:0),a&&a.clearFlag(o.MAP_NO_GAS)):_.layer===i.SURFACE&&(A=h.HAS_SURFACE),t?this.flags|=A:this.flags&=~A,this.flags|=h.CELL_CHANGED|h.NEEDS_REDRAW,a&&E.light!==_.light&&a.clearFlag(o.MAP_STABLE_GLOW_LIGHTS|o.MAP_STABLE_LIGHTS),!0}clearLayer(t){"string"==typeof t&&(t=N[t]);const e=this._tiles[t];e&&(this.flags|=h.CELL_CHANGED,this.removeLayer(e)),this._tiles[t]=null;let l=0;t==i.LIQUID?(l=h.HAS_LIQUID,this.liquidVolume=0):t==i.GAS?(l=h.HAS_GAS,this.gasVolume=0):t==i.SURFACE&&(l=h.HAS_SURFACE),this.flags&=~l}clearLayersExcept(t=i.GROUND,e){const l=e?Y[e]:this.groundTile;for(let e=0;e<this._tiles.length;e++)e!=t&&e!=i.GAS&&(e===i.GROUND?l!==this.groundTile&&this.setTile(l):this.clearLayer(e));this.flags|=h.CELL_CHANGED}clearLayersWithFlags(t,e=0){for(let i=0;i<this._tiles.length;++i){const l=this._tiles[i];l&&(t&&e?l.flags.tile&t&&l.flags.tileMech&e&&this.clearLayer(i):t?l.flags.tile&t&&this.clearLayer(i):e&&l.flags.tileMech&e&&this.clearLayer(i))}}async activate(t,i={}){i.cell=this;let l=!1;for(let s of this.tiles()){if(!s.activates)continue;const a=s.activates[t];if(a){if(a.chance&&!e.random.chance(a.chance,1e4))continue;if(i.tile=s,l=await V(a,i)||l,l)break}}return l}activatesOn(t){for(let e of this.tiles())if(e.activatesOn(t))return!0;return!1}get item(){return this._item}set item(t){this.item&&this.removeLayer(this.item),this._item=t,t?(this.flags|=h.HAS_ITEM,this.addLayer(t)):this.flags&=~h.HAS_ITEM}get actor(){return this._actor}set actor(t){this.actor&&this.removeLayer(this.actor),this._actor=t,t?(this.flags|=h.HAS_ANY_ACTOR,this.addLayer(t)):this.flags&=~h.HAS_ANY_ACTOR}addLayer(t){if(!t)return;this.flags|=h.CELL_CHANGED;let e=this.layers;if(!e||e.layer.layer>t.layer||e.layer.layer==t.layer&&e.layer.priority>t.priority)return void(this.layers={layer:t,next:e});for(;e.next&&(e.layer.layer<t.layer||e.layer.layer==t.layer&&e.layer.priority<=t.priority);)e=e.next;const i={layer:t,next:e.next};e.next=i}removeLayer(t){if(!t)return!1;if(!this.layers)return!1;if(this.flags|=h.CELL_CHANGED,this.layers&&this.layers.layer===t)return this.layers=this.layers.next,!0;let e=this.layers,i=this.layers.next;for(;i;){if(i.layer===t)return e.next=i.next,!0;e=i,i=i.next}return!1}storeMemory(){const t=this.memory;t.tileFlags=this.tileFlags(),t.tileMechFlags=this.tileMechFlags(),t.layerFlags=this.layerFlags(),t.cellFlags=this.flags,t.cellMechFlags=this.mechFlags,t.tile=this.topmostTile(),this.item?(t.item=this.item,t.itemQuantity=this.item.quantity):(t.item=null,t.itemQuantity=0),t.actor=this.actor,X(this,t.mixer),this.actor&&this.isOrWasAnyKindOfVisible()&&(this.actor.rememberedInCell&&this.actor.rememberedInCell!==this&&(this.actor.rememberedInCell.storeMemory(),this.actor.rememberedInCell.flags|=h.NEEDS_REDRAW),this.actor.rememberedInCell=this)}}function Q(t){const e=new k;return t&&e.setTile(t),e}function X(t,l){const a=t.memory.mixer;a.blackOut();let r=t.layerFlags()&s.L_VISUALLY_DISTINCT,_=t.layers;for(;_;){const l=_.layer;let s=l.sprite.opacity||100;l.layer==i.LIQUID?s=e.utils.clamp(34*t.liquidVolume,20,100):l.layer==i.GAS&&(s=e.utils.clamp(34*t.gasVolume,20,100)),a.drawSprite(l.sprite,s),_=_.next}return a.fg.multiply(t.light),a.bg.multiply(t.light),a.bake(!t.isAnyKindOfVisible()),r&&e.color.separate(a.fg,a.bg),l.drawSprite(a),!0}e.make.cell=Q;var q={__proto__:null,get Flags(){return h},get MechFlags(){return n},CellMemory:x,Cell:k,make:Q,getAppearance:X};function j(t){t.flags&=~(h.WAS_ANY_KIND_OF_VISIBLE|h.IN_FOV),t.flags&h.VISIBLE&&(t.flags&=~h.VISIBLE,t.flags|=h.WAS_VISIBLE),t.flags&h.CLAIRVOYANT_VISIBLE&&(t.flags&=~h.CLAIRVOYANT_VISIBLE,t.flags|=h.WAS_CLAIRVOYANT_VISIBLE),t.flags&h.TELEPATHIC_VISIBLE&&(t.flags&=~h.TELEPATHIC_VISIBLE,t.flags|=h.WAS_TELEPATHIC_VISIBLE)}function $(t,i,l,a){t.flags&h.IN_FOV&&a.hasVisibleLight(i,l)&&!(t.mechFlags&n.DARKENED)&&(t.flags|=h.VISIBLE),function(t,i,l,a){const r=t.flags&h.VISIBLE,_=t.flags&h.WAS_VISIBLE;if(r&&_)t.lightChanged&&a.redrawCell(t);else if(r&&!_){if(!(t.flags&h.REVEALED)&&e.data.automationActive){if(t.item){const i=t.item;i.hasLayerFlag(s.L_INTERRUPT_WHEN_SEEN)&&e.message.add("§you§ §see§ ΩitemMessageColorΩ§item§∆.",{item:i,actor:e.data.player})}if(!(t.flags&h.MAGIC_MAPPED)&&t.hasLayerFlag(s.L_INTERRUPT_WHEN_SEEN)){const i=t.tileWithLayerFlag(s.L_INTERRUPT_WHEN_SEEN);i&&e.message.add("§you§ §see§ ΩbackgroundMessageColorΩ§item§∆.",{actor:e.data.player,item:i.name})}}a.markRevealed(i,l),a.redrawCell(t)}else!r&&_&&(t.storeMemory(),a.redrawCell(t));return r}(t,i,l,a)||function(t,e,i,l){const s=t.flags&h.CLAIRVOYANT_VISIBLE,a=t.flags&h.WAS_CLAIRVOYANT_VISIBLE;return s&&a?t.lightChanged&&l.redrawCell(t):!s&&a?(t.storeMemory(),l.redrawCell(t)):!a&&s&&(t.flags&=~h.STABLE_MEMORY,l.redrawCell(t)),s}(t,0,0,a)||function(t,i,l,s){const a=t.flags&h.TELEPATHIC_VISIBLE,_=t.flags&h.WAS_TELEPATHIC_VISIBLE;return a&&_?t.lightChanged&&s.redrawCell(t):!a&&_?(t.storeMemory(),s.redrawCell(t)):!_&&a&&(t.flags&h.REVEALED||t.hasTileFlag(r.T_PATHING_BLOCKER)||e.data.xpxpThisTurn++,t.flags&=~h.STABLE_MEMORY,s.redrawCell(t)),a}(t,0,0,a)||function(t,e,i,l){const s=t.flags&h.MONSTER_DETECTED,a=t.flags&h.WAS_MONSTER_DETECTED;s&&a?t.lightChanged&&l.redrawCell(t):(!s&&a||!a&&s)&&(t.flags&=~h.STABLE_MEMORY,l.redrawCell(t),t.storeMemory())}(t,0,0,a)}function z(t){t.flags&o.MAP_CALC_FOV?t.clearFlags(0,h.IS_WAS_ANY_KIND_OF_VISIBLE):t.forEach((t=>t.flags|=h.REVEALED))}var J={__proto__:null,initMap:z,update:function(t,i,l,s){if(!(t.flags&o.MAP_CALC_FOV&&t.fov))return!1;if(i==t.fov.x&&l==t.fov.y&&!(t.flags&o.MAP_FOV_CHANGED))return!1;t.flags&=~o.MAP_FOV_CHANGED,t.fov.x=i,t.fov.y=l,t.forEach(j);const a=e.grid.alloc(t.width,t.height,0);return t.calcFov(a,i,l,s),a.forEach(((e,i,l)=>{e&&t.setCellFlags(i,l,h.IN_FOV)})),e.grid.free(a),t.setCellFlags(i,l,h.IN_FOV|h.VISIBLE),t.forEach($),!0}};e.utils.setDefaults(e.config,{"map.deepestLevel":99});class Z{constructor(t,i,l={}){this.locations={},this.config={},this._actors=null,this._items=null,this.flags=0,this.lights=null,this.fov=null,this._width=t,this._height=i,this.cells=e.grid.make(t,i,(()=>new k)),this.locations=l.locations||{},this.config=Object.assign({},l),this.config.tick=this.config.tick||100,this._actors=null,this._items=null,this.flags=e.flag.from(o,o.MAP_DEFAULT,l.flags);const s=l.ambient||l.ambientLight||l.light||"white";this.ambientLight=e.color.make(s),(l.ambient||l.ambientLight||l.light)&&(this.ambientLightChanged=!0),this.lights=null,this.id=l.id,this.config.fov&&(this.flags|=o.MAP_CALC_FOV,this.fov={x:-1,y:-1}),C(this),z(this)}get width(){return this._width}get height(){return this._height}async start(){}clear(){this.cells.forEach((t=>t.clear())),this.changed=!0}dump(t){this.cells.dump(t||(t=>t.dump()))}cell(t,e){return this.cells[t][e]}eachCell(t){this.cells.forEach(((e,i,l)=>t(e,i,l,this)))}forEach(t){this.cells.forEach(((e,i,l)=>t(e,i,l,this)))}forRect(t,e,i,l,s){this.cells.forRect(t,e,i,l,((t,e,i)=>s(t,e,i,this)))}eachNeighbor(t,e,i,l=!1){this.cells.eachNeighbor(t,e,((t,e,l)=>i(t,e,l,this)),l)}randomEach(t){this.cells.randomEach(((e,i,l)=>t(e,i,l,this)))}count(t){let e=0;return this.forEach(((i,l,s,a)=>{t(i,l,s,a)&&++e})),e}hasXY(t,e){return this.cells.hasXY(t,e)}isBoundaryXY(t,e){return this.cells.isBoundaryXY(t,e)}get changed(){return(this.flags&o.MAP_CHANGED)>0}set changed(t){!0===t?this.flags|=o.MAP_CHANGED:!1===t&&(this.flags&=~o.MAP_CHANGED)}hasCellFlag(t,e,i){return this.cell(t,e).flags&i}hasCellMechFlag(t,e,i){return this.cell(t,e).mechFlags&i}hasLayerFlag(t,e,i){return this.cell(t,e).hasLayerFlag(i)}hasTileFlag(t,e,i){return this.cell(t,e).hasTileFlag(i)}hasTileMechFlag(t,e,i){return this.cell(t,e).hasTileMechFlag(i)}redrawCell(t){t.needsRedraw=!0,this.flags|=o.MAP_CHANGED}redrawXY(t,e){const i=this.cell(t,e);this.redrawCell(i)}redrawAll(){this.forEach((t=>{t.needsRedraw=!0})),this.changed=!0}drawInto(t,i={}){C(this),"boolean"==typeof i&&(i={force:i});const l=new e.sprite.Mixer;for(let e=0;e<t.width;++e)for(let s=0;s<t.height;++s){const a=this.cell(e,s);if(a.needsRedraw||i.force){et(this,e,s,l);const i="number"==typeof l.ch?l.ch:t.toGlyph(l.ch);t.draw(e,s,i,l.fg.toInt(),l.bg.toInt()),a.needsRedraw=!1}}}revealAll(){this.forEach((t=>{t.markRevealed(),t.storeMemory()})),e.data.player&&e.data.player.invalidateCostMap()}markRevealed(t,i){this.cell(t,i).markRevealed()&&e.data.player&&e.data.player.invalidateCostMap()}makeVisible(t=!0){t?this.setFlags(0,h.VISIBLE):this.clearFlags(0,h.ANY_KIND_OF_VISIBLE)}isVisible(t,e){return this.cell(t,e).isVisible()}isAnyKindOfVisible(t,e){return this.cell(t,e).isAnyKindOfVisible()}isOrWasAnyKindOfVisible(t,e){return this.cell(t,e).isOrWasAnyKindOfVisible()}isRevealed(t,e){return this.cell(t,e).isRevealed()}get anyLightChanged(){return 0==(this.flags&o.MAP_STABLE_LIGHTS)}set anyLightChanged(t){t?this.flags&=~o.MAP_STABLE_LIGHTS:this.flags|=o.MAP_STABLE_LIGHTS}get ambientLightChanged(){return this.staticLightChanged}set ambientLightChanged(t){this.staticLightChanged=t}get staticLightChanged(){return 0==(this.flags&o.MAP_STABLE_GLOW_LIGHTS)}set staticLightChanged(t){t?this.flags&=~(o.MAP_STABLE_GLOW_LIGHTS|o.MAP_STABLE_LIGHTS):this.flags|=o.MAP_STABLE_GLOW_LIGHTS}setFlag(t){this.flags|=t,this.changed=!0}setFlags(t=0,e=0,i=0){t&&(this.flags|=t),(e||i)&&this.forEach((t=>t.setFlags(e,i))),this.changed=!0}clearFlag(t){this.flags&=~t,this.changed=!0}clearFlags(t=0,e=0,i=0){t&&(this.flags&=~t),(e||i)&&this.forEach((t=>t.clearFlags(e,i))),this.changed=!0}setCellFlags(t,e,i=0,l=0){this.cell(t,e).setFlags(i,l),this.flags|=o.MAP_CHANGED}clearCellFlags(t,e,i=0,l=0){this.cell(t,e).clearFlags(i,l),this.changed=!0}hasTile(t,e,i){return this.cells[t][e].hasTile(i)}layerFlags(t,e,i=!1){return this.cells[t][e].layerFlags(i)}tileFlags(t,e,i=!1){return this.cells[t][e].tileFlags(i)}tileMechFlags(t,e,i=!1){return this.cells[t][e].tileMechFlags(i)}tileWithLayerFlag(t,e,i=0){return this.cells[t][e].tileWithLayerFlag(i)}tileWithFlag(t,e,i=0){return this.cells[t][e].tileWithFlag(i)}tileWithMechFlag(t,e,i=0){return this.cells[t][e].tileWithMechFlag(i)}hasKnownTileFlag(t,e,i=0){return this.cells[t][e].memory.tileFlags&i}isClear(t,e){return this.cells[t][e].isClear()}isEmpty(t,e){return this.cells[t][e].isEmpty()}isObstruction(t,e,i=!1){return this.cells[t][e].isObstruction(i)}isDoorway(t,e,i=!1){return this.cells[t][e].isDoorway(i)}isSecretDoorway(t,e,i=!1){return this.cells[t][e].isSecretDoorway(i)}isLiquid(t,e,i=!1){return this.cells[t][e].isLiquid(i)}hasGas(t,e,i=!1){return this.cells[t][e].hasGas(i)}blocksPathing(t,e,i=!1){return this.cells[t][e].blocksPathing(i)}blocksVision(t,e){return this.cells[t][e].blocksVision()}isMoveableNow(t,e,i=!1){return this.cells[t][e].isMoveableNow(i)}isWalkableNow(t,e,i=!1){return this.cells[t][e].isWalkableNow(i)}canBeWalked(t,e,i=!1){return this.cells[t][e].canBeWalked(i)}topmostTile(t,e,i=!1){return this.cells[t][e].topmostTile(i)}tileFlavor(t,e){return this.cells[t][e].tileFlavor()}setTile(t,e,i,l=0){return this.cell(t,e).setTile(i,l,this)}clearCell(t,e){this.cell(t,e).clear()}clearCellLayersWithFlags(t,e,i,l=0){this.cell(t,e).clearLayersWithFlags(i,l)}clearCellLayers(t,e,i=!0,l=!0,s=!0){return this.changed=!0,this.cell(t,e).clearLayers(i,l,s)}fill(t,e){let i,l;for(void 0===e&&(e=t),i=0;i<this.width;++i)for(l=0;l<this.height;++l)this.isBoundaryXY(i,l)?this.setTile(i,l,e):this.setTile(i,l,t)}neighborCount(t,e,i,l=!1){let s=0;return this.eachNeighbor(t,e,((...t)=>{i(...t)&&++s}),l),s}walkableArcCount(t,e){return this.hasXY(t,e)?this.cells.arcCount(t,e,(t=>t.isWalkableNow())):-1}diagonalBlocked(t,e,i,l,s=!1){return t!=i&&e!=l&&(!!this.isObstruction(t,l,s)||!!this.isObstruction(i,e,s))}fillCostGrid(t,i){i=i||(t=>t.isWalkableNow()?1:e.path.OBSTRUCTION),this.cells.forEach(((l,s,a)=>{l.isClear()?t[s][a]=e.path.OBSTRUCTION:t[s][a]=i(l,s,a,this)}))}matchingNeighbor(t,i,l,s=!1){const a=s?4:8;for(let s=0;s<a;++s){const a=e.utils.DIRS[s],r=t+a[0],_=i+a[1];if(this.hasXY(r,_)&&l(this.cells[r][_],r,_,this))return[r,_]}return[-1,-1]}matchingLocNear(t,i,...l){let s,a,r,_=l[0],h=l[1]||{};const n=l[0];"function"!=typeof n&&(h=n||l[1],_=h.match||e.utils.TRUE);const o=h.hallways||!1,E=h.blockingMap||null,c=!1===h.liquids,L=h.deterministic||!1,g=[];for(r=0;r<Math.max(this.width,this.height)&&!g.length;r++)for(s=t-r;s<=t+r;s++)for(a=i-r;a<=i+r;a++){if(!this.hasXY(s,a))continue;const l=this.cell(s,a);Math.ceil(e.utils.distanceBetween(t,i,s,a))!=r||E&&E[s][a]||!_(l,s,a,this)||c&&l.liquid||!(o||this.walkableArcCount(s,a)<2)||g.push([s,a])}if(0==g.length)return[-1,-1];let A=0;return A=L?Math.floor(g.length/2):e.random.number(g.length),g[A]}randomMatchingLoc(t={}){let i,l,s;"function"==typeof t&&(t={match:t});const a=e.random.sequence(this.width*this.height),r=t.hallways||!1,_=t.blockingMap||null,h=!1===t.liquids,n=t.match||e.utils.TRUE,o=t.forbidCellFlags||0,E=t.forbidTileFlags||0,c=t.forbidTileMechFlags||0,L=t.tile||null;let g=!1,A=0;for(;!g&&A<a.length;){const t=a[A];i=t%this.width,l=Math.floor(t/this.width),s=this.cell(i,l),_&&_[i][l]||L&&!s.hasTile(L)||h&&s.liquid||o&&s.flags&o||E&&s.hasTileFlag(E)||c&&s.hasTileMechFlag(c)||!(r||this.walkableArcCount(i,l)<2)||!n(s,i,l,this)||(g=!0),++A}return g?[i,l]:[-1,-1]}hasVisibleLight(t,e){return this.cell(t,e).hasVisibleLight()}addStaticLight(t,e,i){const l={x:t,y:e,light:i,next:this.lights};return this.lights=l,this.staticLightChanged=!0,l}removeStaticLight(t,e,i){let l=this.lights;if(!l)return;function s(l){return l.x==t&&l.y==e&&(!i||i===l.light)}for(this.staticLightChanged=!0;l&&s(l);)l=this.lights=l.next;if(!l)return;let a=l.next;for(;a;)s(a)?l.next=a.next:l=a,a=a.next}eachStaticLight(t){e.utils.eachChain(this.lights,(e=>t(e.light,e.x,e.y))),this.eachCell(((e,i,l)=>{for(let s of e.tiles())s.light&&t(s.light,i,l)}))}eachDynamicLight(t){e.utils.eachChain(this._actors,(e=>{e.light&&t(e.light,e.x,e.y)}))}addFx(t,e,i){if(!this.hasXY(t,e))return!1;const l=this.cell(t,e);return l.addLayer(i),i.x=t,i.y=e,this.redrawCell(l),!0}moveFx(t,e,i){if(!this.hasXY(t,e))return!1;const l=this.cell(t,e),s=this.cell(i.x,i.y);return s.removeLayer(i),this.redrawCell(s),l.addLayer(i),this.redrawCell(l),i.x=t,i.y=e,!0}removeFx(t){const e=this.cell(t.x,t.y);return e.removeLayer(t),this.redrawCell(e),this.flags|=o.MAP_CHANGED,!0}actorAt(t,e){if(!this.hasXY(t,e))return null;return this.cell(t,e).actor}addActor(t,i,l){if(!this.hasXY(t,i))return!1;const s=this.cell(t,i);if(s.actor)return!1;s.actor=l,l.next=this._actors,this._actors=l;const a=l===e.data.player?h.HAS_PLAYER:h.HAS_ANY_ACTOR;return s.flags|=a,l.light&&(this.anyLightChanged=!0),(l.isPlayer()||s.isAnyKindOfVisible()&&l.blocksVision())&&(this.flags|=o.MAP_FOV_CHANGED),l.x=t,l.y=i,this.redrawCell(s),!0}addActorNear(t,e,i){const l=this.matchingLocNear(t,e,(t=>!i.avoidsCell(t)));return!(!l||l[0]<0)&&this.addActor(l[0],l[1],i)}moveActor(t,e,i){return!!this.hasXY(t,e)&&(this.removeActor(i),this.addActor(t,e,i)?(i.light&&(this.anyLightChanged=!0),!0):(this.addActor(i.x,i.y,i),!1))}removeActor(t){if(!this.hasXY(t.x,t.y))return!1;const i=this.cell(t.x,t.y);return i.actor===t&&(i.actor=null,e.utils.removeFromChain(this,"actors",t),t.light&&(this.anyLightChanged=!0),(t.isPlayer()||i.isAnyKindOfVisible()&&t.blocksVision())&&(this.flags|=o.MAP_FOV_CHANGED),this.redrawCell(i),!0)}deleteActorAt(t,e){const i=this.actorAt(t,e);return!!i&&(this.removeActor(i),i.delete(),!0)}itemAt(t,e){return this.cell(t,e).item}addItem(t,i,l){if(!this.hasXY(t,i))return!1;const s=this.cell(t,i);return!s.item&&(l.x=t,l.y=i,s.item=l,l.next=this._items,this._items=l,l.light&&(this.anyLightChanged=!0),this.redrawCell(s),(l.isDetected()||e.config.D_ITEM_OMNISCIENCE)&&(s.flags|=h.ITEM_DETECTED),!0)}addItemNear(t,e,i){const l=this.matchingLocNear(t,e,(t=>!i.forbidsCell(t)));return!(!l||l[0]<0)&&this.addItem(l[0],l[1],i)}removeItem(t){const i=t.x,l=t.y;if(!this.hasXY(i,l))return!1;const s=this.cell(i,l);return s.item===t&&(s.item=null,e.utils.removeFromChain(this,"items",t),t.light&&(this.anyLightChanged=!0),s.flags&=~(h.HAS_ITEM|h.ITEM_DETECTED),this.redrawCell(s),!0)}gridDisruptsWalkability(t,i={}){const l=e.grid.alloc(this.width,this.height);let s=!1;const a=i.gridOffsetX||0,_=i.gridOffsetY||0,h=i.bounds||null;this.cells.forEach(((e,i,n)=>{if(h&&!h.contains(i,n))return;const o=i+a,E=n+_;if(!e.isClear())if(e.hasTileFlag(r.T_HAS_STAIRS))t.get(o,E)?s=!0:l[i][n]=1;else if(e.canBeWalked()){if(t.get(o,E))return;l[i][n]=1}}));let n=!0;for(let t=0;t<l.width&&!s;++t)for(let e=0;e<l.height&&!s;++e)1==l[t][e]&&(n?(l.floodFill(t,e,1,2),n=!1):s=!0);return e.grid.free(l),s}calcFov(t,i,l,a,r=0,_=s.L_BLOCKS_VISION){a=a||this.width+this.height,t.fill(0);const h=this;return new e.fov.FOV({isBlocked:(e,i)=>!(t.hasXY(e,i)&&!h.hasCellFlag(e,i,r)&&!h.hasLayerFlag(e,i,_)),calcRadius:(t,e)=>Math.sqrt(t**2+e**2),setVisible(e,i){t[e][i]=1},hasXY:(e,i)=>t.hasXY(e,i)}).calculate(i,l,a)}losFromTo(t,i){if(e.utils.equalsXY(t,i))return!0;const l=e.utils.getLine(t.x,t.y,i.x,i.y);return!!l.length&&!l.some((t=>this.blocksVision(t[0],t[1])))}storeMemory(t,e){this.cell(t,e).storeMemory()}storeMemories(){let t,e;for(t=0;t<this.width;++t)for(e=0;e<this.height;++e){const i=this.cell(t,e);i.flags&h.ANY_KIND_OF_VISIBLE&&i.storeMemory()}}async activateCell(t,e,i){const l=this.cell(t,e);return await l.activate(i,{map:this,x:t,y:e,cell:l})}async tick(){this.resetCellEvents();for(let t=0;t<this.width;++t)for(let e=0;e<this.height;++e){const i=this.cells[t][e];await i.activate("tick",{map:this,x:t,y:e,cell:i,safe:!0})}lt(this),it(this)}resetCellEvents(){this.forEach((t=>t.mechFlags&=~(n.EVENT_FIRED_THIS_TURN|n.EVENT_PROTECTED)))}}function tt(t,i,l={},s){"string"==typeof l&&(l={tile:l},s&&(l.wall=s));const a=new Z(t,i,l);let r=l.tile||l.floor||l.floorTile;!0===r&&(r="FLOOR");let _=l.boundary||l.wall||l.wallTile;return!0===_&&(_="WALL"),r&&a.fill(r,_),(l.visible||l.revealed)&&(a.makeVisible(),a.revealAll()),l.revealed&&!l.visible&&a.makeVisible(!1),e.data.map||(e.data.map=a),a}function et(t,i,l,a){if(a.blackOut(),!t.hasXY(i,l))return;const r=t.cell(i,l);r.isAnyKindOfVisible()&&r.flags&(h.CELL_CHANGED|h.NEEDS_REDRAW)?X(r,a):a.drawSprite(r.memory.mixer),r.isVisible()||(r.isRevealed()?r.isAnyKindOfVisible()||(a.bg.mix(e.colors.black,30),a.fg.mix(e.colors.black,30)):r.isAnyKindOfVisible()||a.blackOut());let _=!1;if(r.flags&(h.IS_CURSOR|h.IS_IN_PATH)){const t=r.flags&h.IS_CURSOR?e.colors.cursor:e.colors.path;r.hasLayerFlag(s.L_INVERT_WHEN_HIGHLIGHTED)?e.color.swap(a.fg,a.bg):a.bg.mix(t,e.config.cursorPathIntensity||20),_=!0}_&&e.color.separate(a.fg,a.bg)}function it(t){if(t.flags&o.MAP_NO_GAS)return;const l=e.grid.alloc(t.width,t.height);let s=!1,a=!1;if(t.forEach(((i,r,_)=>{let h=i.gasVolume;const n=i.gasTile;let o=h,E=n;t.eachNeighbor(r,_,(t=>{t.gasVolume>o&&(o=t.gasVolume,E=t.gasTile)})),E!==n&&i.setTile(E,0,t),h&&(n.dissipate&&(n.dissipate>1e4?(h-=Math.floor(n.dissipate/1e4),e.random.chance(n.dissipate%1e4,1e4)&&(h-=1)):e.random.chance(n.dissipate,1e4)&&(h-=1)),h>0&&(l[r][_]=h,s=!0,h>1&&(a=!0)))})),s&&a){const i=e.random.sequence(4).map((t=>e.utils.DIRS[t])),s=e.grid.alloc(t.width,t.height);l.forEach(((t,e,a)=>{if(!t)return;let r=t;if(t>1){let _=1;l.eachNeighbor(e,a,(()=>{++_}),!0);let h=Math.floor(t/_),n=t-h*_;s[e][a]+=h,n>0&&(s[e][a]+=1,n-=1);for(let t=0;t<i.length;++t){const l=i[t],_=e+l[0],o=a+l[1];s.hasXY(_,o)&&(r=h,n>0&&(--n,++r),s[_][o]+=r)}}else s[e][a]+=t})),l.copy(s),e.grid.free(s)}l.forEach(((e,l,a)=>{const r=t.cell(l,a);e>0?(s=!0,r.gasVolume!==e&&(r.gasVolume=e,t.redrawCell(r))):r.gas&&(r.clearLayer(i.GAS),t.redrawCell(r))})),s?t.flags&=~o.MAP_NO_GAS:t.flags|=o.MAP_NO_GAS,t.changed=!0,e.grid.free(l)}function lt(t){if(t.flags&o.MAP_NO_LIQUID)return;const l=e.grid.alloc(t.width,t.height);let a=!1,r=!1;t.forEach(((s,_,h)=>{let n=s.liquidVolume;if(!n)return;const o=s.liquidTile;o.dissipate&&(o.dissipate>1e4?(n-=Math.floor(o.dissipate/1e4),e.random.chance(o.dissipate%1e4,1e4)&&(n-=1)):e.random.chance(o.dissipate,1e4)&&(n-=1)),n>0?(l[_][h]=n,a=!0,n>1&&(r=!0)):(s.clearLayer(i.LIQUID),t.redrawCell(s))})),a&&(r&&t.randomEach(((e,i,a)=>{if(e.hasLayerFlag(s.L_BLOCKS_LIQUID))return;let r=0,_=-1,h=-1,n=null,o=l[i][a];if(t.eachNeighbor(i,a,((t,e,i)=>{l[e][i]<=o||l[e][i]<=r||(r=l[e][i],_=e,h=i,n=t.liquidTile)})),r>1){t.setTile(i,a,n,0);const e=Math.floor((r-o)/9)+1;l[i][a]+=e,l[_][h]-=e}})),l.forEach(((e,l,s)=>{const a=t.cell(l,s);e>0?a.liquid&&a.liquidVolume!==e&&(a.liquidVolume=e,t.redrawCell(a)):a.liquidVolume&&(a.clearLayer(i.LIQUID),t.redrawCell(a))}))),a?t.flags&=~o.MAP_NO_LIQUID:t.flags|=o.MAP_NO_LIQUID,t.changed=!0,e.grid.free(l)}e.make.map=tt,e.colors.cursor||e.color.install("cursor",e.colors.yellow),e.colors.path||e.color.install("path",e.colors.gold);var st={__proto__:null,get Flags(){return o},Map:Z,make:tt,from:function(t,e,i={}){Array.isArray(t)||(t=t.split("\n"));const l=t.length,s=t.reduce(((t,e)=>Math.max(t,e.length)),0),a=tt(s,l,i);return t.forEach(((t,i)=>{for(let l=0;l<s;++l){const s=t[l]||".",r=e[s]||"FLOOR";a.setTile(l,i,r)}})),(i.visible||i.revealed)&&(a.makeVisible(),a.revealAll()),i.revealed&&!i.visible&&a.makeVisible(!1),a},getCellAppearance:et,addText:function(t,e,l,s,a,r,_){for(let h of s){const s=d({ch:h,fg:a,bg:r,layer:_||i.GROUND,priority:200});t.cell(e++,l).addLayer(s)}},updateGas:it,updateLiquid:lt};w("NULL",{ch:"∅",fg:"white",bg:"black",flags:"L_BLOCKS_MOVE",name:"eerie nothingness",article:"an",priority:0}),w("FLOOR",{ch:"·",fg:[30,30,30,20,0,0,0],bg:[2,2,10,0,2,2,0],priority:10,article:"the"}),w("DOOR",{ch:"+",fg:[100,40,40],bg:[30,60,60],priority:30,flags:"T_IS_DOOR, L_BLOCKS_EFFECTS, L_BLOCKS_ITEMS, L_BLOCKS_VISION, L_VISUALLY_DISTINCT",article:"a",activates:{enter:{tile:"DOOR_OPEN"},open:{tile:"DOOR_OPEN_ALWAYS"}}}),w("DOOR_OPEN","DOOR",{ch:"'",fg:[100,40,40],bg:[30,60,60],priority:40,flags:"!L_BLOCKS_ITEMS, !L_BLOCKS_VISION",name:"open door",article:"an",activates:{tick:{chance:1e4,tile:"DOOR",flags:"DFF_SUPERPRIORITY, DFF_ONLY_IF_EMPTY"},enter:null,open:null,close:{tile:"DOOR",flags:"DFF_SUPERPRIORITY, DFF_ONLY_IF_EMPTY"}}}),w("DOOR_OPEN_ALWAYS","DOOR_OPEN",{activates:{tick:null,close:{tile:"DOOR",flags:"DFF_SUPERPRIORITY, DFF_ONLY_IF_EMPTY"}}}),w("UP_STAIRS",{ch:"<",fg:[100,50,50],bg:[40,20,20],priority:200,flags:"T_UP_STAIRS, L_BLOCKED_BY_STAIRS, L_VISUALLY_DISTINCT, L_LIST_IN_SIDEBAR",name:"upward staircase",article:"an"}),w("DOWN_STAIRS",{ch:">",fg:[100,50,50],bg:[40,20,20],priority:200,flags:"T_DOWN_STAIRS, L_BLOCKED_BY_STAIRS, L_VISUALLY_DISTINCT, L_LIST_IN_SIDEBAR",name:"downward staircase",article:"a"}),w("WALL",{ch:"#",fg:[7,7,7,0,3,3,3],bg:[40,40,40,10,10,0,5],priority:100,flags:"L_BLOCKS_EVERYTHING",article:"a",name:"stone wall",desc:"A wall made from rough cut stone.",flavor:"a rough stone wall"}),w("LAKE",{ch:"~",fg:[5,8,20,10,0,4,15,!0],bg:[10,15,41,6,5,5,5,!0],priority:50,flags:"T_DEEP_WATER",name:"deep water",article:"the"}),w("BRIDGE",{ch:"=",fg:[100,40,40],priority:40,layer:"SURFACE",flags:"T_BRIDGE, L_VISUALLY_DISTINCT",article:"a",ground:"LAKE"}),t.cell=q,t.layer=N,t.light=F,t.lights=T,t.map=st,t.tile=v,t.tileEvent=b,t.tiles=Y,t.visibility=J,Object.defineProperty(t,"__esModule",{value:!0})}));
//# sourceMappingURL=gw-map.min.js.map
