!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("gw-utils")):"function"==typeof define&&define.amd?define(["exports","gw-utils"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).GW=t.GW||{},t.GW)}(this,(function(t,e){"use strict";var i;!function(t){t[t.ALL_LAYERS=-1]="ALL_LAYERS",t[t.GROUND=0]="GROUND",t[t.LIQUID=1]="LIQUID",t[t.SURFACE=2]="SURFACE",t[t.GAS=3]="GAS",t[t.ITEM=4]="ITEM",t[t.ACTOR=5]="ACTOR",t[t.PLAYER=6]="PLAYER",t[t.FX=7]="FX",t[t.UI=8]="UI"}(i||(i={}));const l=e.flag.fl;var s,a,r,_,h,n,o;!function(t){t[t.L_SUPERPRIORITY=l(1)]="L_SUPERPRIORITY",t[t.L_SECRETLY_PASSABLE=l(2)]="L_SECRETLY_PASSABLE",t[t.L_BLOCKS_MOVE=l(3)]="L_BLOCKS_MOVE",t[t.L_BLOCKS_VISION=l(4)]="L_BLOCKS_VISION",t[t.L_BLOCKS_SURFACE=l(6)]="L_BLOCKS_SURFACE",t[t.L_BLOCKS_LIQUID=l(8)]="L_BLOCKS_LIQUID",t[t.L_BLOCKS_GAS=l(7)]="L_BLOCKS_GAS",t[t.L_BLOCKS_ITEMS=l(5)]="L_BLOCKS_ITEMS",t[t.L_BLOCKS_ACTORS=l(11)]="L_BLOCKS_ACTORS",t[t.L_BLOCKS_EFFECTS=l(9)]="L_BLOCKS_EFFECTS",t[t.L_BLOCKS_DIAGONAL=l(10)]="L_BLOCKS_DIAGONAL",t[t.L_INTERRUPT_WHEN_SEEN=l(11)]="L_INTERRUPT_WHEN_SEEN",t[t.L_LIST_IN_SIDEBAR=l(12)]="L_LIST_IN_SIDEBAR",t[t.L_VISUALLY_DISTINCT=l(13)]="L_VISUALLY_DISTINCT",t[t.L_BRIGHT_MEMORY=l(14)]="L_BRIGHT_MEMORY",t[t.L_INVERT_WHEN_HIGHLIGHTED=l(15)]="L_INVERT_WHEN_HIGHLIGHTED",t[t.L_BLOCKED_BY_STAIRS=t.L_BLOCKS_ITEMS|t.L_BLOCKS_SURFACE|t.L_BLOCKS_GAS|t.L_BLOCKS_LIQUID|t.L_BLOCKS_EFFECTS|t.L_BLOCKS_ACTORS]="L_BLOCKED_BY_STAIRS",t[t.L_BLOCKS_SCENT=t.L_BLOCKS_MOVE|t.L_BLOCKS_VISION]="L_BLOCKS_SCENT",t[t.L_DIVIDES_LEVEL=t.L_BLOCKS_MOVE]="L_DIVIDES_LEVEL",t[t.L_WAYPOINT_BLOCKER=t.L_BLOCKS_MOVE]="L_WAYPOINT_BLOCKER",t[t.L_IS_WALL=t.L_BLOCKS_MOVE|t.L_BLOCKS_VISION|t.L_BLOCKS_LIQUID|t.L_BLOCKS_GAS|t.L_BLOCKS_EFFECTS|t.L_BLOCKS_DIAGONAL]="L_IS_WALL",t[t.L_BLOCKS_EVERYTHING=t.L_IS_WALL|t.L_BLOCKS_ITEMS|t.L_BLOCKS_ACTORS|t.L_BLOCKS_SURFACE]="L_BLOCKS_EVERYTHING"}(s||(s={})),function(t){t[t.DFF_SUBSEQ_ALWAYS=l(0)]="DFF_SUBSEQ_ALWAYS",t[t.DFF_SUBSEQ_EVERYWHERE=l(1)]="DFF_SUBSEQ_EVERYWHERE",t[t.DFF_TREAT_AS_BLOCKING=l(2)]="DFF_TREAT_AS_BLOCKING",t[t.DFF_PERMIT_BLOCKING=l(3)]="DFF_PERMIT_BLOCKING",t[t.DFF_BLOCKED_BY_OTHER_LAYERS=l(4)]="DFF_BLOCKED_BY_OTHER_LAYERS",t[t.DFF_SUPERPRIORITY=l(5)]="DFF_SUPERPRIORITY",t[t.DFF_NO_REDRAW_CELL=l(6)]="DFF_NO_REDRAW_CELL",t[t.DFF_ABORT_IF_BLOCKS_MAP=l(7)]="DFF_ABORT_IF_BLOCKS_MAP",t[t.DFF_BLOCKED_BY_ITEMS=l(8)]="DFF_BLOCKED_BY_ITEMS",t[t.DFF_BLOCKED_BY_ACTORS=l(9)]="DFF_BLOCKED_BY_ACTORS",t[t.DFF_ALWAYS_FIRE=l(10)]="DFF_ALWAYS_FIRE",t[t.DFF_NO_MARK_FIRED=l(11)]="DFF_NO_MARK_FIRED",t[t.DFF_PROTECTED=l(12)]="DFF_PROTECTED",t[t.DFF_SPREAD_CIRCLE=l(13)]="DFF_SPREAD_CIRCLE",t[t.DFF_SPREAD_LINE=l(14)]="DFF_SPREAD_LINE",t[t.DFF_NULL_SURFACE=l(15)]="DFF_NULL_SURFACE",t[t.DFF_NULL_LIQUID=l(16)]="DFF_NULL_LIQUID",t[t.DFF_NULL_GAS=l(17)]="DFF_NULL_GAS",t[t.DFF_EVACUATE_CREATURES=l(18)]="DFF_EVACUATE_CREATURES",t[t.DFF_EVACUATE_ITEMS=l(19)]="DFF_EVACUATE_ITEMS",t[t.DFF_BUILD_IN_WALLS=l(20)]="DFF_BUILD_IN_WALLS",t[t.DFF_MUST_TOUCH_WALLS=l(21)]="DFF_MUST_TOUCH_WALLS",t[t.DFF_NO_TOUCH_WALLS=l(22)]="DFF_NO_TOUCH_WALLS",t[t.DFF_ACTIVATE_DORMANT_MONSTER=l(23)]="DFF_ACTIVATE_DORMANT_MONSTER",t[t.DFF_AGGRAVATES_MONSTERS=l(24)]="DFF_AGGRAVATES_MONSTERS",t[t.DFF_RESURRECT_ALLY=l(25)]="DFF_RESURRECT_ALLY",t[t.DFF_EMIT_EVENT=l(26)]="DFF_EMIT_EVENT",t[t.DFF_ONLY_IF_EMPTY=t.DFF_BLOCKED_BY_ITEMS|t.DFF_BLOCKED_BY_ACTORS]="DFF_ONLY_IF_EMPTY",t[t.DFF_NULLIFY_CELL=t.DFF_NULL_SURFACE|t.DFF_NULL_LIQUID|t.DFF_NULL_GAS]="DFF_NULLIFY_CELL"}(a||(a={})),function(t){t[t.T_BRIDGE=l(0)]="T_BRIDGE",t[t.T_AUTO_DESCENT=l(1)]="T_AUTO_DESCENT",t[t.T_LAVA=l(2)]="T_LAVA",t[t.T_DEEP_WATER=l(3)]="T_DEEP_WATER",t[t.T_IS_FLAMMABLE=l(4)]="T_IS_FLAMMABLE",t[t.T_SPONTANEOUSLY_IGNITES=l(5)]="T_SPONTANEOUSLY_IGNITES",t[t.T_IS_FIRE=l(6)]="T_IS_FIRE",t[t.T_EXTINGUISHES_FIRE=l(7)]="T_EXTINGUISHES_FIRE",t[t.T_IS_SECRET=l(8)]="T_IS_SECRET",t[t.T_IS_TRAP=l(9)]="T_IS_TRAP",t[t.T_SACRED=l(10)]="T_SACRED",t[t.T_UP_STAIRS=l(11)]="T_UP_STAIRS",t[t.T_DOWN_STAIRS=l(12)]="T_DOWN_STAIRS",t[t.T_PORTAL=l(13)]="T_PORTAL",t[t.T_IS_DOOR=l(14)]="T_IS_DOOR",t[t.T_ALLOWS_SUBMERGING=l(15)]="T_ALLOWS_SUBMERGING",t[t.T_ENTANGLES=l(16)]="T_ENTANGLES",t[t.T_REFLECTS=l(17)]="T_REFLECTS",t[t.T_STAND_IN_TILE=l(18)]="T_STAND_IN_TILE",t[t.T_CONNECTS_LEVEL=l(19)]="T_CONNECTS_LEVEL",t[t.T_HAS_STAIRS=t.T_UP_STAIRS|t.T_DOWN_STAIRS|t.T_PORTAL]="T_HAS_STAIRS",t[t.T_OBSTRUCTS_SCENT=t.T_AUTO_DESCENT|t.T_LAVA|t.T_DEEP_WATER|t.T_SPONTANEOUSLY_IGNITES|t.T_HAS_STAIRS]="T_OBSTRUCTS_SCENT",t[t.T_PATHING_BLOCKER=t.T_AUTO_DESCENT|t.T_IS_TRAP|t.T_LAVA|t.T_DEEP_WATER|t.T_IS_FIRE|t.T_SPONTANEOUSLY_IGNITES|t.T_ENTANGLES]="T_PATHING_BLOCKER",t[t.T_DIVIDES_LEVEL=t.T_AUTO_DESCENT|t.T_IS_TRAP|t.T_LAVA|t.T_DEEP_WATER]="T_DIVIDES_LEVEL",t[t.T_LAKE_PATHING_BLOCKER=t.T_AUTO_DESCENT|t.T_LAVA|t.T_DEEP_WATER|t.T_SPONTANEOUSLY_IGNITES]="T_LAKE_PATHING_BLOCKER",t[t.T_WAYPOINT_BLOCKER=t.T_AUTO_DESCENT|t.T_IS_TRAP|t.T_LAVA|t.T_DEEP_WATER|t.T_SPONTANEOUSLY_IGNITES]="T_WAYPOINT_BLOCKER",t[t.T_MOVES_ITEMS=t.T_DEEP_WATER|t.T_LAVA]="T_MOVES_ITEMS",t[t.T_CAN_BE_BRIDGED=t.T_AUTO_DESCENT|t.T_LAVA|t.T_DEEP_WATER]="T_CAN_BE_BRIDGED",t[t.T_IS_DEEP_LIQUID=t.T_LAVA|t.T_AUTO_DESCENT|t.T_DEEP_WATER]="T_IS_DEEP_LIQUID"}(r||(r={})),function(t){t[t.TM_IS_WIRED=l(9)]="TM_IS_WIRED",t[t.TM_IS_CIRCUIT_BREAKER=l(10)]="TM_IS_CIRCUIT_BREAKER",t[t.TM_VANISHES_UPON_PROMOTION=l(15)]="TM_VANISHES_UPON_PROMOTION",t[t.TM_EXPLOSIVE_PROMOTE=l(21)]="TM_EXPLOSIVE_PROMOTE",t[t.TM_SWAP_ENCHANTS_ACTIVATION=l(25)]="TM_SWAP_ENCHANTS_ACTIVATION"}(_||(_={})),function(t){t[t.VISIBLE=l(0)]="VISIBLE",t[t.WAS_VISIBLE=l(1)]="WAS_VISIBLE",t[t.CLAIRVOYANT_VISIBLE=l(2)]="CLAIRVOYANT_VISIBLE",t[t.WAS_CLAIRVOYANT_VISIBLE=l(3)]="WAS_CLAIRVOYANT_VISIBLE",t[t.TELEPATHIC_VISIBLE=l(4)]="TELEPATHIC_VISIBLE",t[t.WAS_TELEPATHIC_VISIBLE=l(5)]="WAS_TELEPATHIC_VISIBLE",t[t.ITEM_DETECTED=l(6)]="ITEM_DETECTED",t[t.WAS_ITEM_DETECTED=l(7)]="WAS_ITEM_DETECTED",t[t.MONSTER_DETECTED=l(8)]="MONSTER_DETECTED",t[t.WAS_MONSTER_DETECTED=l(9)]="WAS_MONSTER_DETECTED",t[t.REVEALED=l(10)]="REVEALED",t[t.MAGIC_MAPPED=l(11)]="MAGIC_MAPPED",t[t.IN_FOV=l(12)]="IN_FOV",t[t.WAS_IN_FOV=l(13)]="WAS_IN_FOV",t[t.NEEDS_REDRAW=l(14)]="NEEDS_REDRAW",t[t.CELL_CHANGED=l(15)]="CELL_CHANGED",t[t.HAS_SURFACE=l(16)]="HAS_SURFACE",t[t.HAS_LIQUID=l(17)]="HAS_LIQUID",t[t.HAS_GAS=l(18)]="HAS_GAS",t[t.HAS_PLAYER=l(19)]="HAS_PLAYER",t[t.HAS_ACTOR=l(20)]="HAS_ACTOR",t[t.HAS_DORMANT_MONSTER=l(21)]="HAS_DORMANT_MONSTER",t[t.HAS_ITEM=l(22)]="HAS_ITEM",t[t.IS_IN_PATH=l(23)]="IS_IN_PATH",t[t.IS_CURSOR=l(24)]="IS_CURSOR",t[t.STABLE_MEMORY=l(25)]="STABLE_MEMORY",t[t.LIGHT_CHANGED=l(26)]="LIGHT_CHANGED",t[t.CELL_LIT=l(27)]="CELL_LIT",t[t.IS_IN_SHADOW=l(28)]="IS_IN_SHADOW",t[t.CELL_DARK=l(29)]="CELL_DARK",t[t.PERMANENT_CELL_FLAGS=t.REVEALED|t.MAGIC_MAPPED|t.ITEM_DETECTED|t.HAS_ITEM|t.HAS_DORMANT_MONSTER|t.STABLE_MEMORY]="PERMANENT_CELL_FLAGS",t[t.ANY_KIND_OF_VISIBLE=t.VISIBLE|t.CLAIRVOYANT_VISIBLE|t.TELEPATHIC_VISIBLE]="ANY_KIND_OF_VISIBLE",t[t.HAS_ANY_ACTOR=t.HAS_PLAYER|t.HAS_ACTOR]="HAS_ANY_ACTOR",t[t.IS_WAS_ANY_KIND_OF_VISIBLE=t.VISIBLE|t.WAS_VISIBLE|t.CLAIRVOYANT_VISIBLE|t.WAS_CLAIRVOYANT_VISIBLE|t.TELEPATHIC_VISIBLE|t.WAS_TELEPATHIC_VISIBLE]="IS_WAS_ANY_KIND_OF_VISIBLE",t[t.WAS_ANY_KIND_OF_VISIBLE=t.WAS_VISIBLE|t.WAS_CLAIRVOYANT_VISIBLE|t.WAS_TELEPATHIC_VISIBLE]="WAS_ANY_KIND_OF_VISIBLE",t[t.CELL_DEFAULT=t.VISIBLE|t.IN_FOV|t.NEEDS_REDRAW|t.CELL_CHANGED]="CELL_DEFAULT"}(h||(h={})),function(t){t[t.SEARCHED_FROM_HERE=l(0)]="SEARCHED_FROM_HERE",t[t.PRESSURE_PLATE_DEPRESSED=l(1)]="PRESSURE_PLATE_DEPRESSED",t[t.KNOWN_TO_BE_TRAP_FREE=l(2)]="KNOWN_TO_BE_TRAP_FREE",t[t.CAUGHT_FIRE_THIS_TURN=l(4)]="CAUGHT_FIRE_THIS_TURN",t[t.EVENT_FIRED_THIS_TURN=l(5)]="EVENT_FIRED_THIS_TURN",t[t.EVENT_PROTECTED=l(6)]="EVENT_PROTECTED",t[t.IS_IN_LOOP=l(10)]="IS_IN_LOOP",t[t.IS_CHOKEPOINT=l(11)]="IS_CHOKEPOINT",t[t.IS_GATE_SITE=l(12)]="IS_GATE_SITE",t[t.IS_IN_ROOM_MACHINE=l(13)]="IS_IN_ROOM_MACHINE",t[t.IS_IN_AREA_MACHINE=l(14)]="IS_IN_AREA_MACHINE",t[t.IS_POWERED=l(15)]="IS_POWERED",t[t.IMPREGNABLE=l(20)]="IMPREGNABLE",t[t.DARKENED=l(19)]="DARKENED",t[t.IS_IN_MACHINE=t.IS_IN_ROOM_MACHINE|t.IS_IN_AREA_MACHINE]="IS_IN_MACHINE",t[t.PERMANENT_MECH_FLAGS=t.SEARCHED_FROM_HERE|t.PRESSURE_PLATE_DEPRESSED|t.KNOWN_TO_BE_TRAP_FREE|t.IS_IN_LOOP|t.IS_CHOKEPOINT|t.IS_GATE_SITE|t.IS_IN_MACHINE|t.IMPREGNABLE]="PERMANENT_MECH_FLAGS"}(n||(n={})),function(t){t[t.MAP_CHANGED=l(0)]="MAP_CHANGED",t[t.MAP_STABLE_GLOW_LIGHTS=l(1)]="MAP_STABLE_GLOW_LIGHTS",t[t.MAP_STABLE_LIGHTS=l(2)]="MAP_STABLE_LIGHTS",t[t.MAP_ALWAYS_LIT=l(3)]="MAP_ALWAYS_LIT",t[t.MAP_SAW_WELCOME=l(4)]="MAP_SAW_WELCOME",t[t.MAP_NO_LIQUID=l(5)]="MAP_NO_LIQUID",t[t.MAP_NO_GAS=l(6)]="MAP_NO_GAS",t[t.MAP_CALC_FOV=l(7)]="MAP_CALC_FOV",t[t.MAP_FOV_CHANGED=l(8)]="MAP_FOV_CHANGED",t[t.MAP_DEFAULT=t.MAP_STABLE_LIGHTS|t.MAP_STABLE_GLOW_LIGHTS]="MAP_DEFAULT"}(o||(o={}));const E=e.config.light={INTENSITY_DARK:20},c=e.color.make();class L{constructor(t,i,l,s=!1){this.fadeTo=0,this.passThroughActors=!1,this.id=null,this.color=e.color.from(t)||null,this.radius=e.range.make(i||1),this.fadeTo=l||0,this.passThroughActors=s}copy(t){this.color=t.color,this.radius.copy(t.radius),this.fadeTo=t.fadeTo,this.passThroughActors=t.passThroughActors}get intensity(){return g(this.color)}paint(t,i,l,a=!1,r=!1){if(!t)return!1;let _,n,o=this.radius.value(),L=Math.ceil(o);c.copy(this.color).bake();const A=!r&&!a&&g(c)>E.INTENSITY_DARK,I=this.fadeTo,S=e.grid.alloc(t.width,t.height,0);t.calcFov(S,i,l,L,this.passThroughActors?0:h.HAS_ANY_ACTOR,s.L_BLOCKS_VISION);let T=!1;if(S.forCircle(i,l,L,((s,a,r)=>{if(!s)return;const E=t.cell(a,r);for(n=Math.floor(100-(100-I)*(e.utils.distanceBetween(i,l,a,r)/o)),_=0;_<3;_++)E.light[_]+=Math.floor(c[_]*n/100);A&&(E.flags&=~h.IS_IN_SHADOW),E.flags&(h.IN_FOV|h.ANY_KIND_OF_VISIBLE)&&(T=!0)})),A){t.cell(i,l).flags&=~h.IS_IN_SHADOW}return e.grid.free(S),T}}function g(t){return Math.max(t[0],t[1],t[2])}function A(...t){if(1==t.length){const i=t[0];if("string"==typeof i){const t=I[i];if(t)return t;const[l,s,a,r]=i.split(/[,|]/).map((t=>t.trim()));return new L(e.color.from(l),e.range.from(s||1),Number.parseInt(a||"0"),!!r&&"false"!==r)}if(Array.isArray(i)){const[t,e,l,s]=i;return new L(t,e,l,s)}if(i&&i.color)return new L(e.color.from(i.color),e.range.from(i.radius),Number.parseInt(i.fadeTo||"0"),i.pass);throw new Error("Unknown Light config - "+i)}{const[e,i,l,s]=t;return new L(e,i,l,s)}}e.make.light=A;const I={};function S(t,...e){let i;return i=1==e.length?A(e[0]):A(e[0],e[1],e[2],e[3]),I[t]=i,i&&(i.id=t),i}function T(t){let e;t.eachCell((t=>{for(e=0;e<3;e++)t.oldLight[e]=t.light[e],t.lightChanged=!1}))}function f(t){let e;const i=t.ambientLight?t.ambientLight:[0,0,0];t.eachCell(((t,l,s)=>{for(e=0;e<3;e++)t.light[e]=i[e];t.flags|=h.IS_IN_SHADOW}))}function u(t){let e;t.eachCell((t=>{for(e=0;e<3;e++)t.glowLight[e]=t.light[e]}))}function O(t){let e;t.eachCell((t=>{for(e=0;e<3;e++)t.light[e]=t.glowLight[e]}))}function C(t){if(!t.anyLightChanged)return!1;T(t),f(t),t.staticLightChanged?(t.eachStaticLight(((e,i,l)=>{e&&e.paint(t,i,l)})),u(t),t.staticLightChanged=!1):O(t),t.eachDynamicLight(((e,i,l)=>{e.paint(t,i,l)})),function(t){t.eachCell(((t,e,i)=>{t.flags&=~(h.CELL_LIT|h.CELL_DARK),t.light.some(((e,i)=>e!==t.oldLight[i]))&&(t.lightChanged=!0),t.isDark()?t.flags|=h.CELL_DARK:t.flags&h.IS_IN_SHADOW||(t.flags|=h.CELL_LIT)}))}(t);const i=e.data.player;if(i){const e=I.PLAYERS_LIGHT;e&&e.radius&&e.paint(t,i.x,i.y,!0,!0)}return t.anyLightChanged=!1,!0}var R={__proto__:null,config:E,Light:L,intensity:g,make:A,lights:I,from:function(...t){1!=t.length&&e.utils.ERROR("Unknown Light config: "+JSON.stringify(t));const i=t[0];if("string"==typeof i){const t=I[i];if(t)return t}return A(i)},install:S,installAll:function(t={}){Object.entries(t).forEach((([t,e])=>{S(t,e)}))},recordOldLights:T,zeroOutLights:f,recordGlowLights:u,restoreGlowLights:O,updateLighting:C,playerInDarkness:function(t,e,i){return t.cell(e.x,e.y).isDark(i)}};class N{constructor(t){this.priority=50,this.layer=0,this.light=null,this.flags={layer:0},this.sprite=e.make.sprite(t.sprite||t),this.light=t.light?A(t.light):null,this.priority=e.utils.first(t.priority,50),this.layer=(t.layer&&"number"!=typeof t.layer?i[t.layer]:t.layer)||0,this.flags.layer=e.flag.from(s,t.layerFlags,t.flags,0)}hasLayerFlag(t){return(this.flags.layer&t)>0}}function d(t){return new N(t)}e.make.layer=d;var F={__proto__:null,get Flags(){return s},get Layer(){return i},Entity:N,make:d};class D extends N{constructor(t){super((()=>{if(!t.Extends)return t;if("string"==typeof t.Extends&&(t.Extends=m[t.Extends],!t.Extends))throw new Error("Unknown tile base - "+t.Extends);const i=t.Extends;return t.ch=e.utils.first(t.ch,i.sprite.ch,-1),t.fg=e.utils.first(t.fg,i.sprite.fg,-1),t.bg=e.utils.first(t.bg,i.sprite.bg,-1),t.layer=e.utils.first(t.layer,i.layer),t.priority=e.utils.first(t.priority,i.priority),t.opacity=e.utils.first(t.opacity,i.sprite.opacity),t.light=e.utils.first(t.light,i.light),t})()),this.flags={layer:0,tile:0,tileMech:0},this.activates={},this.flavor=null,this.desc=null,this.article=null,this.dissipate=2e3,this.defaultGround=null;let i=t.Extends;i&&(e.utils.assignOmitting(["sprite","depth","priority","activates","flags","light"],this,i),i.activates&&Object.assign(this.activates,i.activates),Object.assign(this.flags,i.flags)),e.utils.assignOmitting(["Extends","extends","flags","layerFlags","mechFlags","sprite","activates","ch","fg","bg","opacity","light","layer","priority","flags","ground","light"],this,t),this.name=t.name||(i?i.name:t.id),this.id=t.id,t.ground&&(this.defaultGround=t.ground),this.flags.tile=e.flag.from(r,this.flags.tile,t.flags),this.flags.layer=e.flag.from(s,this.flags.layer,t.layerFlags||t.flags),this.flags.tileMech=e.flag.from(_,this.flags.tileMech,t.mechFlags||t.flags),t.activates&&Object.entries(t.activates).forEach((([t,i])=>{if(i){if("string"==typeof i){if(!m[i])return void(this.activates[t]=i);i={tile:i}}const l=e.effect.make(i);this.activates[t]=l}else delete this.activates[t]}))}hasAllFlags(t){return(this.flags.tile&t)===t}hasAllLayerFlags(t){return(this.flags.layer&t)===t}hasAllMechFlags(t){return(this.flags.tileMech&t)===t}blocksPathing(){return this.flags.layer&s.L_BLOCKS_MOVE||this.flags.tile&r.T_PATHING_BLOCKER}activatesOn(t){return!!this.activates[t]}getName(t){let i={};if(!0===t||!1===t||"string"==typeof t?i.article=t:t&&(i=t),!i.article&&!i.color)return this.name;let l=this.name;if(i.color){let t=i.color;!0===i.color&&(t=this.sprite.fg||"white"),"string"!=typeof t&&(t=e.color.from(t).toString()),l=`Ω${t}Ω${this.name}∆`}if(i.article){l=("string"==typeof i.article?i.article:this.article||"a")+" "+l}return l}getDescription(t={}){return this.getName(t)}}function y(t){return new D(t)}e.make.tile=y;const m={};function M(...t){let i=t[0],l=t[1],s=t[2];1==arguments.length?(s=t[0],l=s.Extends||null,i=s.id):2==arguments.length&&(s=l),"string"==typeof l&&(s.Extends=m[l]||e.utils.ERROR("Unknown base tile: "+l)),s.id=i;const a=y(s);return m[i]=a,a}var P={__proto__:null,get Flags(){return r},get MechFlags(){return _},Tile:D,make:y,tiles:m,install:M,installAll:function(t){Object.entries(t).forEach((([t,e])=>{e.id=t,M(t,e)}))}};e.color.install("cursorColor",25,100,150),e.config.cursorPathIntensity=50;class V{constructor(){this.mixer=new e.sprite.Mixer,this.item=null,this.itemQuantity=0,this.actor=null,this.tile=null,this.cellFlags=0,this.cellMechFlags=0,this.layerFlags=0,this.tileFlags=0,this.tileMechFlags=0}clear(){this.mixer.nullify(),this.item=null,this.itemQuantity=0,this.actor=null,this.tile=null,this.cellFlags=0,this.cellMechFlags=0,this.layerFlags=0,this.tileFlags=0,this.tileMechFlags=0}copy(t){const e=this.mixer;Object.assign(this,t),this.mixer=e,this.mixer.copy(t.mixer)}}class B{constructor(){this._tiles=[],this.layers=null,this._actor=null,this._item=null,this.data={},this.flags=h.CELL_DEFAULT,this.mechFlags=0,this.gasVolume=0,this.liquidVolume=0,this.machineNumber=0,this.memory=new V,this.light=[100,100,100],this.oldLight=[100,100,100],this.glowLight=[100,100,100],this.chokeCount=0}copy(t){e.utils.copyObject(this,t)}nullify(){for(let t=0;t<this._tiles.length;++t)this._tiles[t]=null;this.layers=null,this._actor=null,this._item=null,this.data={},this.flags=h.CELL_DEFAULT,this.mechFlags=0,this.gasVolume=0,this.liquidVolume=0,this.machineNumber=0,this.memory.clear(),this.light=[100,100,100],this.oldLight=[100,100,100],this.glowLight=[100,100,100],this.chokeCount=0}clear(t="FLOOR"){this.nullify(),"string"==typeof t&&(t=m[t]),t&&(this._tiles[0]=t)}get ground(){var t;return(null===(t=this._tiles[i.GROUND])||void 0===t?void 0:t.id)||null}get liquid(){var t;return(null===(t=this._tiles[i.LIQUID])||void 0===t?void 0:t.id)||null}get surface(){var t;return(null===(t=this._tiles[i.SURFACE])||void 0===t?void 0:t.id)||null}get gas(){var t;return(null===(t=this._tiles[i.GAS])||void 0===t?void 0:t.id)||null}get groundTile(){return this._tiles[i.GROUND]||m.NULL}get liquidTile(){return this._tiles[i.LIQUID]||m.NULL}get surfaceTile(){return this._tiles[i.SURFACE]||m.NULL}get gasTile(){return this._tiles[i.GAS]||m.NULL}dump(){if(this.actor)return this.actor.sprite.ch;if(this.item)return this.item.sprite.ch;for(let t=this._tiles.length-1;t>=0;--t){if(!this._tiles[t])continue;const e=this._tiles[t]||m.NULL;if(e.sprite.ch)return e.sprite.ch}return m.NULL.sprite.ch}get changed(){return(this.flags&h.CELL_CHANGED)>0}set changed(t){t?this.flags|=h.CELL_CHANGED:this.flags&=~h.CELL_CHANGED}isVisible(){return!!(this.flags&h.VISIBLE)}isAnyKindOfVisible(){return this.flags&h.ANY_KIND_OF_VISIBLE}isOrWasAnyKindOfVisible(){return this.flags&h.IS_WAS_ANY_KIND_OF_VISIBLE}isRevealed(t=!1){const e=h.REVEALED|(t?h.MAGIC_MAPPED:0);return(this.flags&e)>0}listInSidebar(){return this.hasLayerFlag(s.L_LIST_IN_SIDEBAR,!0)}get needsRedraw(){return(this.flags&h.NEEDS_REDRAW)>0}set needsRedraw(t){t?this.flags|=h.NEEDS_REDRAW:this.flags&=~h.NEEDS_REDRAW}hasVisibleLight(){return g(this.light)>e.config.light.INTENSITY_DARK}isDark(t){const i=t?g(t):e.config.light.INTENSITY_DARK;return g(this.light)<=i}get lightChanged(){return(this.flags&h.LIGHT_CHANGED)>0}set lightChanged(t){t?this.flags|=h.LIGHT_CHANGED|h.NEEDS_REDRAW:this.flags&=~h.LIGHT_CHANGED}tile(t=i.GROUND){return this._tiles[t]||m.NULL}tileId(t=i.GROUND){var e;return(null===(e=this._tiles[t])||void 0===e?void 0:e.id)||null}volume(t=i.GAS){return t===i.GAS?this.gasVolume:t===i.LIQUID?this.liquidVolume:0}setVolume(t,e=0){t===i.GAS?this.gasVolume=e:t===i.LIQUID&&(this.liquidVolume=e)}*tiles(){for(let t of this._tiles)t&&(yield t)}layerFlags(t=!1){if(t&&!this.isVisible())return this.memory.layerFlags;let e=0;for(let t of this.tiles())e|=t.flags.layer;return e}tileFlags(t=!1){if(t&&!this.isVisible())return this.memory.tileFlags;let e=0;for(let t of this.tiles())e|=t.flags.tile;return e}tileMechFlags(t=!1){if(t&&!this.isVisible())return this.memory.tileMechFlags;let e=0;for(let t of this.tiles())e|=t.flags.tileMech;return e}hasLayerFlag(t,e=!1){return!!(t&this.layerFlags(e))}hasAllLayerFlags(t,e=!1){return(t&this.layerFlags(e))===t}hasTileFlag(t,e=!1){return!!(t&this.tileFlags(e))}hasAllTileFlags(t,e=!1){return(t&this.tileFlags(e))===t}hasTileMechFlag(t,e=!1){return!!(t&this.tileMechFlags(e))}hasAllTileMechFlags(t,e=!1){return(t&this.tileMechFlags(e))===t}setFlags(t=0,e=0){this.flags|=t,this.mechFlags|=e}clearFlags(t=0,e=0){this.flags&=~t,this.mechFlags&=~e}hasFlag(t,e=!1){return(t&(e&&!this.isAnyKindOfVisible()?this.memory.cellFlags:this.flags))>0}hasMechFlag(t,e=!1){return(t&(e&&!this.isAnyKindOfVisible()?this.memory.cellMechFlags:this.mechFlags))>0}hasTile(t){let e;return e="string"==typeof t?t:t.id,this._tiles.some((t=>t&&t.id===e))}topmostTile(t=!1){let e=m.NULL,l=-1e4;for(let s=i.GROUND;s<=(t?i.LIQUID:i.GAS);++s){const t=this._tiles[s];t&&(t.priority>l&&(e=t,l=t.priority))}return e}tileWithLayerFlag(t){for(let e of this.tiles())if(e.flags.layer&t)return e;return null}tileWithFlag(t){for(let e of this.tiles())if(e.flags.tile&t)return e;return null}tileWithMechFlag(t){for(let e of this.tiles())if(e.flags.tileMech&t)return e;return null}tileDesc(){return this.topmostTile().desc}tileFlavor(){return this.topmostTile().flavor}getName(t={}){return this.topmostTile().getName(t)}isNull(){return null===this.ground}isClear(){return null===this.liquid&&null===this.gas&&null===this.surface}isEmpty(){return!(this._actor||this._item)}isMoveableNow(t=!1){return 0==((t&&!this.isAnyKindOfVisible()?this.memory.layerFlags:this.layerFlags(!1))&s.L_BLOCKS_MOVE)}isWalkableNow(t=!1){const e=t&&!this.isAnyKindOfVisible();if((e?this.memory.layerFlags:this.layerFlags(!1))&s.L_BLOCKS_MOVE)return!1;const i=e?this.memory.tileFlags:this.tileFlags();return!(i&r.T_IS_DEEP_LIQUID)||(i&r.T_BRIDGE)>0}canBeWalked(t=!1){if(this.isWalkableNow(t))return!0;return((t&&!this.isAnyKindOfVisible()?this.memory.layerFlags:this.layerFlags(!1))&s.L_SECRETLY_PASSABLE)>0}isWall(t=!1){return((t&&!this.isAnyKindOfVisible()?this.memory.layerFlags:this.layerFlags())&s.L_IS_WALL)===s.L_IS_WALL}isObstruction(t=!1){return!!((t&&!this.isAnyKindOfVisible()?this.memory.layerFlags:this.layerFlags())&s.L_BLOCKS_DIAGONAL)}isDoorway(t=!1){let e=t&&!this.isAnyKindOfVisible()?this.memory.layerFlags:this.layerFlags();return(e&s.L_BLOCKS_VISION)>0&&0==(e&s.L_BLOCKS_MOVE)}isSecretDoorway(t=!1){if(t)return!1;return(this.layerFlags(t)&s.L_SECRETLY_PASSABLE)>0}blocksPathing(t=!1){const e=t&&!this.isAnyKindOfVisible();if(!this.isWalkableNow(t))return!0;return!!((e?this.memory.tileFlags:this.tileFlags())&r.T_PATHING_BLOCKER)}blocksVision(){return!!(this.layerFlags()&s.L_BLOCKS_VISION)}blocksEffects(){return!!(this.layerFlags()&s.L_BLOCKS_EFFECTS)}isLiquid(t=!1){return!!((t&&!this.isAnyKindOfVisible()?this.memory.tileFlags:this.tileFlags())&r.T_IS_DEEP_LIQUID)}hasGas(t=!1){return!!((t&&!this.isAnyKindOfVisible()?this.memory.cellFlags:this.flags)&h.HAS_GAS)}hasKey(){return!1}markRevealed(){return this.flags&=~h.STABLE_MEMORY,!(this.flags&h.REVEALED)&&(this.flags|=h.REVEALED,!this.isWall())}obstructsLayer(t){return t===i.SURFACE&&this.hasLayerFlag(s.L_BLOCKS_SURFACE)}setTile(t=null,l=0,a){let _;if(a=a||e.data.map,null===t?(_=m.NULL,t=null):"string"==typeof t?_=m[t]:t instanceof D&&(_=t,t=_.id),!_)return e.utils.ERROR("Unknown tile - "+t);_.layer>0&&!this._tiles[0]&&this.setTile(_.defaultGround||m.FLOOR,0,a);const E=this._tiles[_.layer]||m.NULL,c=E===m.NULL?null:E.id;E.blocksPathing()!=_.blocksPathing()&&(e.data.staleLoopMap=!0),_.flags.tile&r.T_IS_FIRE&&!(E.flags.tile&r.T_IS_FIRE)&&(this.mechFlags|=n.CAUGHT_FIRE_THIS_TURN);const L=_.flags.layer&s.L_BLOCKS_VISION,g=E.flags.layer&s.L_BLOCKS_VISION;a&&this.isAnyKindOfVisible()&&L!=g&&a.setFlag(o.MAP_FOV_CHANGED),null!==c&&this.removeLayer(E),this._tiles[_.layer]=null===t?null:_,null!==t&&this.addLayer(_);let A=0;return _.layer==i.LIQUID?(A=h.HAS_LIQUID,this.liquidVolume=l+(t==c?this.liquidVolume:0),a&&a.clearFlag(o.MAP_NO_LIQUID)):_.layer==i.GAS?(A=h.HAS_GAS,this.gasVolume=l+(t==c?this.gasVolume:0),a&&a.clearFlag(o.MAP_NO_GAS)):_.layer===i.SURFACE&&(A=h.HAS_SURFACE),t?this.flags|=A:this.flags&=~A,this.flags|=h.CELL_CHANGED|h.NEEDS_REDRAW,a&&E.light!==_.light&&a.clearFlag(o.MAP_STABLE_GLOW_LIGHTS|o.MAP_STABLE_LIGHTS),!0}clearLayer(t){"string"==typeof t&&(t=i[t]);const e=this._tiles[t];e&&(this.flags|=h.CELL_CHANGED,this.removeLayer(e)),this._tiles[t]=null;let l=0;t==i.LIQUID?(l=h.HAS_LIQUID,this.liquidVolume=0):t==i.GAS?(l=h.HAS_GAS,this.gasVolume=0):t==i.SURFACE?l=h.HAS_SURFACE:t==i.GROUND&&(this._tiles[i.GROUND]=m.FLOOR),this.flags&=~l}clearLayersExcept(t=i.GROUND,e){const l=e?m[e]:this.groundTile;for(let e=0;e<this._tiles.length;e++)e!=t&&e!=i.GAS&&(e===i.GROUND?l!==this.groundTile&&this.setTile(l):this.clearLayer(e));this.flags|=h.CELL_CHANGED}clearLayersWithFlags(t,e=0){for(let i=0;i<this._tiles.length;++i){const l=this._tiles[i];l&&(t&&e?l.flags.tile&t&&l.flags.tileMech&e&&this.clearLayer(i):t?l.flags.tile&t&&this.clearLayer(i):e&&l.flags.tileMech&e&&this.clearLayer(i))}}async activate(t,i,l,s,a={}){a.cell=this;let r=!1;if(void 0!==a.layer){const _=this.tile(a.layer);if(_&&_.activates){const h=_.activates[t];let n;n="string"==typeof h?e.effect.effects[h]:h,n&&(a.force||!n.chance||e.random.chance(n.chance,1e4))&&(a.tile=_,r=await n.fire(i,l,s,a))}}else for(let _ of this.tiles()){if(!_.activates)continue;const h=_.activates[t];let n;if(n="string"==typeof h?e.effect.effects[h]:h,n&&(a.force||!n.chance||e.random.chance(n.chance,1e4))&&(a.tile=_,r=await n.fire(i,l,s,a)||r,r))break}return r}activatesOn(t){for(let e of this.tiles())if(e.activatesOn(t))return!0;return!1}get item(){return this._item}set item(t){this.item&&this.removeLayer(this.item),this._item=t,t?(this.flags|=h.HAS_ITEM,this.addLayer(t)):this.flags&=~h.HAS_ITEM}get actor(){return this._actor}set actor(t){this.actor&&this.removeLayer(this.actor),this._actor=t,t?(this.flags|=h.HAS_ANY_ACTOR,this.addLayer(t)):this.flags&=~h.HAS_ANY_ACTOR}addLayer(t){if(!t)return;this.flags|=h.CELL_CHANGED;let e=this.layers;if(!e||e.layer.layer>t.layer||e.layer.layer==t.layer&&e.layer.priority>t.priority)return void(this.layers={layer:t,next:e});for(;e.next&&(e.layer.layer<t.layer||e.layer.layer==t.layer&&e.layer.priority<=t.priority);)e=e.next;const i={layer:t,next:e.next};e.next=i}removeLayer(t){if(!t)return!1;if(!this.layers)return!1;if(this.flags|=h.CELL_CHANGED,this.layers&&this.layers.layer===t)return this.layers=this.layers.next,!0;let e=this.layers,i=this.layers.next;for(;i;){if(i.layer===t)return e.next=i.next,!0;e=i,i=i.next}return!1}storeMemory(){const t=this.memory;t.tileFlags=this.tileFlags(),t.tileMechFlags=this.tileMechFlags(),t.layerFlags=this.layerFlags(),t.cellFlags=this.flags,t.cellMechFlags=this.mechFlags,t.tile=this.topmostTile(),this.item?(t.item=this.item,t.itemQuantity=this.item.quantity):(t.item=null,t.itemQuantity=0),t.actor=this.actor,U(this,t.mixer),this.actor&&this.isOrWasAnyKindOfVisible()&&(this.actor.rememberedInCell&&this.actor.rememberedInCell!==this&&(this.actor.rememberedInCell.storeMemory(),this.actor.rememberedInCell.flags|=h.NEEDS_REDRAW),this.actor.rememberedInCell=this)}}function p(t){const e=new B;return t&&e.setTile(t),e}function U(t,l){const a=t.memory.mixer;a.blackOut();let r=t.layerFlags()&s.L_VISUALLY_DISTINCT,_=t.layers;for(;_;){const l=_.layer;let s=l.sprite.opacity||100;l.layer==i.LIQUID?s=e.utils.clamp(34*t.liquidVolume,20,100):l.layer==i.GAS&&(s=e.utils.clamp(34*t.gasVolume,20,100)),a.drawSprite(l.sprite,s),_=_.next}return a.fg.multiply(t.light),a.bg.multiply(t.light),a.bake(!t.isAnyKindOfVisible()),r&&e.color.separate(a.fg,a.bg),l.drawSprite(a),!0}e.make.cell=p;var H={__proto__:null,get Flags(){return h},get MechFlags(){return n},CellMemory:V,Cell:B,make:p,getAppearance:U};function G(t){t.flags&=~(h.WAS_ANY_KIND_OF_VISIBLE|h.IN_FOV),t.flags&h.VISIBLE&&(t.flags&=~h.VISIBLE,t.flags|=h.WAS_VISIBLE),t.flags&h.CLAIRVOYANT_VISIBLE&&(t.flags&=~h.CLAIRVOYANT_VISIBLE,t.flags|=h.WAS_CLAIRVOYANT_VISIBLE),t.flags&h.TELEPATHIC_VISIBLE&&(t.flags&=~h.TELEPATHIC_VISIBLE,t.flags|=h.WAS_TELEPATHIC_VISIBLE)}function K(t,i,l,a){t.flags&h.IN_FOV&&a.hasVisibleLight(i,l)&&!(t.mechFlags&n.DARKENED)&&(t.flags|=h.VISIBLE),function(t,i,l,a){const r=t.flags&h.VISIBLE,_=t.flags&h.WAS_VISIBLE;if(r&&_)t.lightChanged&&a.redrawCell(t);else if(r&&!_){if(!(t.flags&h.REVEALED)&&e.data.automationActive){if(t.item){const i=t.item;i.hasLayerFlag(s.L_INTERRUPT_WHEN_SEEN)&&e.message.add("§you§ §see§ ΩitemMessageColorΩ§item§∆.",{item:i,actor:e.data.player})}if(!(t.flags&h.MAGIC_MAPPED)&&t.hasLayerFlag(s.L_INTERRUPT_WHEN_SEEN)){const i=t.tileWithLayerFlag(s.L_INTERRUPT_WHEN_SEEN);i&&e.message.add("§you§ §see§ ΩbackgroundMessageColorΩ§item§∆.",{actor:e.data.player,item:i.name})}}a.markRevealed(i,l),a.redrawCell(t)}else!r&&_&&(t.storeMemory(),a.redrawCell(t));return r}(t,i,l,a)||function(t,e,i,l){const s=t.flags&h.CLAIRVOYANT_VISIBLE,a=t.flags&h.WAS_CLAIRVOYANT_VISIBLE;return s&&a?t.lightChanged&&l.redrawCell(t):!s&&a?(t.storeMemory(),l.redrawCell(t)):!a&&s&&(t.flags&=~h.STABLE_MEMORY,l.redrawCell(t)),s}(t,0,0,a)||function(t,i,l,s){const a=t.flags&h.TELEPATHIC_VISIBLE,_=t.flags&h.WAS_TELEPATHIC_VISIBLE;return a&&_?t.lightChanged&&s.redrawCell(t):!a&&_?(t.storeMemory(),s.redrawCell(t)):!_&&a&&(t.flags&h.REVEALED||t.hasTileFlag(r.T_PATHING_BLOCKER)||e.data.xpxpThisTurn++,t.flags&=~h.STABLE_MEMORY,s.redrawCell(t)),a}(t,0,0,a)||function(t,e,i,l){const s=t.flags&h.MONSTER_DETECTED,a=t.flags&h.WAS_MONSTER_DETECTED;s&&a?t.lightChanged&&l.redrawCell(t):(!s&&a||!a&&s)&&(t.flags&=~h.STABLE_MEMORY,l.redrawCell(t),t.storeMemory())}(t,0,0,a)}function b(t){t.flags&o.MAP_CALC_FOV?t.clearFlags(0,h.IS_WAS_ANY_KIND_OF_VISIBLE):t.forEach((t=>t.flags|=h.REVEALED))}var W={__proto__:null,initMap:b,update:function(t,i,l,s){if(!(t.flags&o.MAP_CALC_FOV&&t.fov))return!1;if(i==t.fov.x&&l==t.fov.y&&!(t.flags&o.MAP_FOV_CHANGED))return!1;t.flags&=~o.MAP_FOV_CHANGED,t.fov.x=i,t.fov.y=l,t.forEach(G);const a=e.grid.alloc(t.width,t.height,0);return t.calcFov(a,i,l,s),a.forEach(((e,i,l)=>{e&&t.setCellFlags(i,l,h.IN_FOV)})),e.grid.free(a),t.setCellFlags(i,l,h.IN_FOV|h.VISIBLE),t.forEach(K),!0}};const Y=e.effect.Flags;async function w(t,l,s){const a=this.id,r=m[a]||null;if(!r)return!1;const _=!!(t.flags&Y.E_ABORT_IF_BLOCKS_MAP),h=!(!_||t.flags&Y.E_PERMIT_BLOCKING||!(r.blocksPathing()||t.flags&Y.E_TREAT_AS_BLOCKING));let o=!1;const E=t.map;if(o=function(t,i,l,s){let a,r,_,h,n,o,E;const c=i.map,L=i.flags,g=i.grid;let A=t.spread||0,I=t.decrement||0;const S=g;S.fill(0),S[l][s]=h=1;let T=1;if(A)for(E=!0,A>=100&&(I=I||100),I<=0&&(I=A);E&&A>0;){for(E=!1,h++,a=0;a<c.width;a++)for(r=0;r<c.height;r++)if(S[a][r]==h-1)for(_=0;_<4;_++)n=a+e.utils.DIRS[_][0],o=r+e.utils.DIRS[_][1],S.hasXY(n,o)&&!S[n][o]&&k(t,c,n,o,L,!1)&&e.random.chance(A)&&(S[n][o]=h,E=!0,++T);A-=I}k(t,c,l,s,L,!0)||(S[l][s]=0,--T);return T>0}(this,t,l,s),!o)return!1;if(_&&h&&E.gridDisruptsWalkability(t.grid))return!1;t.flags&Y.E_EVACUATE_CREATURES&&function(t,e){let i,l,s=!1;for(i=0;i<t.width;i++)for(l=0;l<t.height;l++){if(!e[i][l])continue;const a=t.cell(i,l);if(!a.actor)continue;const r=a.actor,_=t.matchingLocNear(i,l,(t=>!r.forbidsCell(t)),{hallways:!0,blockingMap:e});_&&_[0]>=0&&_[1]>=0&&(t.moveActor(_[0],_[1],r),s=!0)}return s}(E,t.grid)&&(o=!0),t.flags&Y.E_EVACUATE_ITEMS&&function(t,e){let i=!1;return e.forEach(((l,s,a)=>{if(!l)return;const r=t.cell(s,a);if(!r.item)return;const _=r.item,h=t.matchingLocNear(s,a,(t=>!_.forbidsCell(t)),{hallways:!0,blockingMap:e});h&&h[0]>=0&&h[1]>=0&&(t.removeItem(_),t.addItem(h[0],h[1],_),i=!0)})),i}(E,t.grid)&&(o=!0),t.flags&Y.E_CLEAR_CELL&&function(t,e){let i=!1;return e.forEach(((e,l,s)=>{e&&(t.clearCell(l,s),i=!0)})),i}(E,t.grid)&&(o=!0);return function(t,e,l,s,a=0){let r,_,h;h=!1;const o=t&Y.E_BLOCKED_BY_OTHER_LAYERS,E=t&Y.E_SUPERPRIORITY;for(a=a||0,r=0;r<e.width;r++)for(_=0;_<e.height;_++){if(!e[r][_])continue;const c=1===e[r][_];e[r][_]=0;const L=l.cell(r,_);L.mechFlags&n.EVENT_FIRED_THIS_TURN&&!c||(L.tile(s.layer)===s?s.layer==i.GAS?(e[r][_]=1,L.gasVolume+=a):s.layer==i.LIQUID&&(e[r][_]=1,L.liquidVolume+=a):!(E||L.tile(s.layer).priority<s.priority)||L.obstructsLayer(s.layer)||L.item&&t&Y.E_BLOCKED_BY_ITEMS||L.actor&&t&Y.E_BLOCKED_BY_ACTORS||o&&!(L.topmostTile().priority<s.priority)||(e[r][_]=1,l.setTile(r,_,s,a),h=!0))}h&&(l.changed=!0);return h}(t.flags,t.grid,t.map,r,this.volume)&&(o=!0),o}async function v(t,l){const a=e.grid.alloc(t.width,t.height);t.forEach(((i,r,_)=>{i.clearFlags(0,n.EVENT_FIRED_THIS_TURN);for(let h of i.tiles()){const o=e.effect.from(h.activates[l]);if(!o)continue;let E=0;o.chance<0?(E=0,t.eachNeighbor(r,_,((t,e,l)=>{t.hasLayerFlag(s.L_BLOCKS_EFFECTS)||t.tileId(h.layer)==i.tileId(h.layer)||t.mechFlags&n.CAUGHT_FIRE_THIS_TURN||(E+=-1*o.chance)}),!0)):E=o.chance||1e4,i.mechFlags&n.CAUGHT_FIRE_THIS_TURN||!e.random.chance(E,1e4)||(a[r][_]|=e.flag.fl(h.layer),i.mechFlags|=n.EVENT_FIRED_THIS_TURN)}})),await a.forEachAsync((async(s,a,r)=>{if(!s)return;const _=t.cell(a,r);for(let h=0;h<=i.GAS;++h)s&e.flag.fl(h)&&await _.activate(l,t,a,r,{force:!0,layer:h})})),e.grid.free(a)}function k(t,e,i,l,s,a){if(!e.hasXY(i,l))return!1;const r=e.cell(i,l);if(s&Y.E_BUILD_IN_WALLS){if(!r.isWall())return!1}else if(s&Y.E_MUST_TOUCH_WALLS){let t=!1;if(e.eachNeighbor(i,l,(e=>{e.isWall()&&(t=!0)})),!t)return!1}else if(s&Y.E_NO_TOUCH_WALLS){let t=!0;if(r.isWall())return!1;if(e.eachNeighbor(i,l,(e=>{e.isWall()&&(t=!1)})),!t)return!1}else if(r.blocksEffects()&&!t.matchTile&&!a)return!1;return!(t.matchTile&&!r.hasTile(t.matchTile))}function x(t,i){const l=e.grid.alloc(t.width,t.height),a=e.grid.alloc(t.width,t.height);for(let e=0;e<t.width;e++)for(let i=0;i<t.height;i++){const a=t.get(e,i);!a.hasTileFlag(r.T_PATHING_BLOCKER)&&!a.hasLayerFlag(s.L_BLOCKS_MOVE)||a.hasLayerFlag(s.L_SECRETLY_PASSABLE)?l[e][i]=1:l[e][i]=0}let _;for(let i=1;i<l.width-1;i++)for(let s=1;s<l.height-1;s++)if(t.cells[i][s].mechFlags&=~n.IS_CHOKEPOINT,l[i][s]&&!(t.cells[i][s].mechFlags&n.IS_IN_LOOP)){_=0;for(let a=0;a<8;a++){const r=i+e.utils.CLOCK_DIRS[(a+7)%8][0],h=s+e.utils.CLOCK_DIRS[(a+7)%8][1],o=i+e.utils.CLOCK_DIRS[a][0],E=s+e.utils.CLOCK_DIRS[a][1];if((t.hasXY(o,E)&&l[o][E])!=(t.hasXY(r,h)&&l[r][h])&&++_>2){(l[i-1][s]||l[i+1][s])&&(l[i][s-1]||l[i][s+1])||(t.cells[i][s].mechFlags|=n.IS_CHOKEPOINT);break}}}if(i){for(let e=0;e<t.width;e++)for(let i=0;i<t.height;i++)t.cells[e][i].chokeCount=3e4,t.cells[e][i].mechFlags&n.IS_IN_ROOM_MACHINE&&(l[e][i]=0);for(let i=0;i<t.width;i++)for(let s=0;s<t.height;s++){const r=t.cells[i][s];if(l[i][s]&&r.mechFlags&n.IS_CHOKEPOINT)for(let _=0;_<4;_++){const h=i+e.utils.DIRS[_][0],o=s+e.utils.DIRS[_][1];if(t.hasXY(h,o)&&l[h][o]&&!(t.cells[h][o].mechFlags&n.IS_CHOKEPOINT)){a.fill(0),l[i][s]=0;let e=Q(t,a,l,h,o);if(l[i][s]=1,e>=4){for(let i=0;i<a.width;i++)for(let l=0;l<a.height;l++)a[i][l]&&e<t.cells[i][l].chokeCount&&(t.cells[i][l].chokeCount=e,t.cells[i][l].mechFlags&=~n.IS_GATE_SITE);e<r.chokeCount&&(r.chokeCount=e,r.mechFlags|=n.IS_GATE_SITE)}}}}}e.grid.free(l),e.grid.free(a)}function Q(t,i,l,s,a){let r=2==l[s][a]?5e3:1;t.cells[s][a].mechFlags&n.IS_IN_AREA_MACHINE&&(r=1e4),i[s][a]=1;for(let _=0;_<4;_++){const h=s+e.utils.DIRS[_][0],n=a+e.utils.DIRS[_][1];t.hasXY(h,n)&&l[h][n]&&!i[h][n]&&(r+=Q(t,i,l,h,n))}return Math.min(r,1e4)}function X(t){t.forEach(q),t.forEach(j),$(t)}function q(t,e,i,l){!t.hasTileFlag(r.T_PATHING_BLOCKER)&&!t.hasLayerFlag(s.L_BLOCKS_MOVE)||t.hasLayerFlag(s.L_SECRETLY_PASSABLE)?t.mechFlags|=n.IS_IN_LOOP:t.mechFlags&=~n.IS_IN_LOOP}function j(t,i,l,s){let a,r,_,h,o,E,c,L;if(!(t&&t.mechFlags&n.IS_IN_LOOP))return!1;for(o=0;o<8;o++){if(r=i+e.utils.CLOCK_DIRS[o][0],_=l+e.utils.CLOCK_DIRS[o][1],!s.hasXY(r,_))continue;const t=s.get(r,_);if(!(t&&t.mechFlags&n.IS_IN_LOOP))break}if(8==o)return!1;for(E=c=L=0,a=!1,h=o;h<o+8;h++){if(r=i+e.utils.CLOCK_DIRS[h%8][0],_=l+e.utils.CLOCK_DIRS[h%8][1],!s.hasXY(r,_))continue;const t=s.get(r,_);if(t&&t.mechFlags&n.IS_IN_LOOP){if(L++,!a){if(E>0)return!1;E++,a=!0}}else a&&(L>c&&(c=L),L=0,a=!1)}if(a&&L>c&&(c=L),1==E&&c<=4){for(t.mechFlags&=~n.IS_IN_LOOP,h=0;h<8;h++){const t=i+e.utils.CLOCK_DIRS[h][0],a=l+e.utils.CLOCK_DIRS[h][1];if(s.hasXY(t,a)){j(s.get(t,a),t,a,s)}}return!0}return!1}function z(t,e){for(let i=0;i<t.width;++i)for(let l=0;l<t.height;++l){if(t.cells[i][l].mechFlags&n.IS_IN_LOOP)e[i][l]=1;else if(i>0&&l>0){const s=t.cells[i][l-1],a=t.cells[i-1][l];s.mechFlags&n.IS_IN_LOOP&&a.mechFlags&n.IS_IN_LOOP&&(e[i][l]=1)}}}function $(t){const i=e.grid.alloc(t.width,t.height);let l;z(t,i);for(let s=0;s<i.width;s++)for(let a=0;a<i.height;a++){if(t.get(s,a).mechFlags&n.IS_IN_LOOP){l=!1;for(let r=0;r<8;r++){let _=s+e.utils.CLOCK_DIRS[r][0],h=a+e.utils.CLOCK_DIRS[r][1];if(t.hasXY(_,h)&&!i[_][h]&&!(t.cells[_][h].mechFlags&n.IS_IN_LOOP)){l=!0;break}}l||(i[s][a]=1,t.cells[s][a].mechFlags&=~n.IS_IN_LOOP)}}e.grid.free(i)}e.effect.installType("tile",(function(t){return t?("string"==typeof t&&(t=t.split(/[,|]/).map((t=>t.trim()))),Array.isArray(t)&&(t={id:t[0],spread:t[1]||0,decrement:t[2]||0}),t.id=t.id||t.tile,t.spread=t.spread||0,t.decrement=t.decrement||0,t.spread>=100&&t.decrement<=0&&(t.decrement=100),t.matchTile=t.matchTile||t.match||t.needs||null,t.volume=t.volume||0,t.id||e.utils.ERROR("id required to make tile effect."),w.bind(t)):(e.utils.ERROR("Config required to make tile effect."),null)})),e.utils.setDefaults(e.config,{"map.deepestLevel":99});class J{constructor(t,i,l={}){this.locations={},this.config={},this._actors=null,this._items=null,this.flags=0,this.lights=null,this.fov=null,this._width=t,this._height=i,this.cells=e.grid.make(t,i,(()=>new B)),this.locations=l.locations||{},this.config=Object.assign({},l),this.config.tick=this.config.tick||100,this._actors=null,this._items=null,this.flags=e.flag.from(o,o.MAP_DEFAULT,l.flags);const s=l.ambient||l.ambientLight||l.light||"white";this.ambientLight=e.color.make(s),(l.ambient||l.ambientLight||l.light)&&(this.ambientLightChanged=!0),this.lights=null,this.id=l.id,this.config.fov&&(this.flags|=o.MAP_CALC_FOV,this.fov={x:-1,y:-1}),l.updateLiquid&&"function"==typeof l.updateLiquid&&(this.updateLiquid=l.updateLiquid.bind(this)),l.updateGas&&"function"==typeof l.updateGas&&(this.updateGas=l.updateGas.bind(this)),C(this),b(this)}get width(){return this._width}get height(){return this._height}async start(){}clear(t="FLOOR"){this.cells.forEach((e=>e.clear(t))),this.changed=!0}dump(t){this.cells.dump(t||(t=>t.dump()))}cell(t,e){return this.cells[t][e]}get(t,e){return this.cells[t][e]}eachCell(t){this.cells.forEach(((e,i,l)=>t(e,i,l,this)))}forEach(t){this.cells.forEach(((e,i,l)=>t(e,i,l,this)))}async forEachAsync(t){return this.cells.forEachAsync(((e,i,l)=>t(e,i,l,this)))}forRect(t,e,i,l,s){this.cells.forRect(t,e,i,l,((t,e,i)=>s(t,e,i,this)))}eachNeighbor(t,e,i,l=!1){this.cells.eachNeighbor(t,e,((t,e,l)=>i(t,e,l,this)),l)}eachNeighborAsync(t,e,i,l=!1){return this.cells.eachNeighborAsync(t,e,((t,e,l)=>i(t,e,l,this)),l)}randomEach(t){this.cells.randomEach(((e,i,l)=>t(e,i,l,this)))}count(t){let e=0;return this.forEach(((i,l,s,a)=>{t(i,l,s,a)&&++e})),e}hasXY(t,e){return this.cells.hasXY(t,e)}isBoundaryXY(t,e){return this.cells.isBoundaryXY(t,e)}get changed(){return(this.flags&o.MAP_CHANGED)>0}set changed(t){!0===t?this.flags|=o.MAP_CHANGED:!1===t&&(this.flags&=~o.MAP_CHANGED)}hasCellFlag(t,e,i){return this.cell(t,e).flags&i}hasCellMechFlag(t,e,i){return this.cell(t,e).mechFlags&i}hasLayerFlag(t,e,i){return this.cell(t,e).hasLayerFlag(i)}hasTileFlag(t,e,i){return this.cell(t,e).hasTileFlag(i)}hasTileMechFlag(t,e,i){return this.cell(t,e).hasTileMechFlag(i)}redrawCell(t){t.needsRedraw=!0,this.flags|=o.MAP_CHANGED}redrawXY(t,e){const i=this.cell(t,e);this.redrawCell(i)}redrawAll(){this.forEach((t=>{t.needsRedraw=!0})),this.changed=!0}drawInto(t,i={}){C(this),"boolean"==typeof i&&(i={force:i});const l=new e.sprite.Mixer;for(let e=0;e<t.width;++e)for(let s=0;s<t.height;++s){const a=this.cell(e,s);if(a.needsRedraw||i.force){tt(this,e,s,l);const i="number"==typeof l.ch?l.ch:t.toGlyph(l.ch);t.draw(e,s,i,l.fg.toInt(),l.bg.toInt()),a.needsRedraw=!1}}}revealAll(){this.forEach((t=>{t.markRevealed(),t.storeMemory()})),e.data.player&&e.data.player.invalidateCostMap()}markRevealed(t,i){this.cell(t,i).markRevealed()&&e.data.player&&e.data.player.invalidateCostMap()}makeVisible(t=!0){t?this.setFlags(0,h.VISIBLE):this.clearFlags(0,h.ANY_KIND_OF_VISIBLE)}isVisible(t,e){return this.cell(t,e).isVisible()}isAnyKindOfVisible(t,e){return this.cell(t,e).isAnyKindOfVisible()}isOrWasAnyKindOfVisible(t,e){return this.cell(t,e).isOrWasAnyKindOfVisible()}isRevealed(t,e){return this.cell(t,e).isRevealed()}get anyLightChanged(){return 0==(this.flags&o.MAP_STABLE_LIGHTS)}set anyLightChanged(t){t?this.flags&=~o.MAP_STABLE_LIGHTS:this.flags|=o.MAP_STABLE_LIGHTS}get ambientLightChanged(){return this.staticLightChanged}set ambientLightChanged(t){this.staticLightChanged=t}get staticLightChanged(){return 0==(this.flags&o.MAP_STABLE_GLOW_LIGHTS)}set staticLightChanged(t){t?this.flags&=~(o.MAP_STABLE_GLOW_LIGHTS|o.MAP_STABLE_LIGHTS):this.flags|=o.MAP_STABLE_GLOW_LIGHTS}setFlag(t){this.flags|=t,this.changed=!0}setFlags(t=0,e=0,i=0){t&&(this.flags|=t),(e||i)&&this.forEach((t=>t.setFlags(e,i))),this.changed=!0}clearFlag(t){this.flags&=~t,this.changed=!0}clearFlags(t=0,e=0,i=0){t&&(this.flags&=~t),(e||i)&&this.forEach((t=>t.clearFlags(e,i))),this.changed=!0}setCellFlags(t,e,i=0,l=0){this.cell(t,e).setFlags(i,l),this.flags|=o.MAP_CHANGED}clearCellFlags(t,e,i=0,l=0){this.cell(t,e).clearFlags(i,l),this.changed=!0}hasTile(t,e,i){return this.cells[t][e].hasTile(i)}layerFlags(t,e,i=!1){return this.cells[t][e].layerFlags(i)}tileFlags(t,e,i=!1){return this.cells[t][e].tileFlags(i)}tileMechFlags(t,e,i=!1){return this.cells[t][e].tileMechFlags(i)}tileWithLayerFlag(t,e,i=0){return this.cells[t][e].tileWithLayerFlag(i)}tileWithFlag(t,e,i=0){return this.cells[t][e].tileWithFlag(i)}tileWithMechFlag(t,e,i=0){return this.cells[t][e].tileWithMechFlag(i)}hasKnownTileFlag(t,e,i=0){return this.cells[t][e].memory.tileFlags&i}isClear(t,e){return this.cells[t][e].isClear()}isEmpty(t,e){return this.cells[t][e].isEmpty()}isObstruction(t,e,i=!1){return this.cells[t][e].isObstruction(i)}isDoorway(t,e,i=!1){return this.cells[t][e].isDoorway(i)}isSecretDoorway(t,e,i=!1){return this.cells[t][e].isSecretDoorway(i)}isLiquid(t,e,i=!1){return this.cells[t][e].isLiquid(i)}hasGas(t,e,i=!1){return this.cells[t][e].hasGas(i)}blocksPathing(t,e,i=!1){return this.cells[t][e].blocksPathing(i)}blocksVision(t,e){return this.cells[t][e].blocksVision()}isMoveableNow(t,e,i=!1){return this.cells[t][e].isMoveableNow(i)}isWalkableNow(t,e,i=!1){return this.cells[t][e].isWalkableNow(i)}canBeWalked(t,e,i=!1){return this.cells[t][e].canBeWalked(i)}topmostTile(t,e,i=!1){return this.cells[t][e].topmostTile(i)}tileFlavor(t,e){return this.cells[t][e].tileFlavor()}setTile(t,e,i,l=0){return this.cell(t,e).setTile(i,l,this)}nullifyCell(t,e){this.cell(t,e).nullify()}clearCell(t,e){this.cell(t,e).clear()}clearCellLayersWithFlags(t,e,i,l=0){this.cell(t,e).clearLayersWithFlags(i,l)}fill(t,e){let i,l;for(void 0===e&&(e=t),i=0;i<this.width;++i)for(l=0;l<this.height;++l)this.isBoundaryXY(i,l)?this.setTile(i,l,e):this.setTile(i,l,t)}neighborCount(t,e,i,l=!1){let s=0;return this.eachNeighbor(t,e,((...t)=>{i(...t)&&++s}),l),s}walkableArcCount(t,e){return this.hasXY(t,e)?this.cells.arcCount(t,e,(t=>t.isWalkableNow())):-1}diagonalBlocked(t,e,i,l,s=!1){return t!=i&&e!=l&&(!!this.isObstruction(t,l,s)||!!this.isObstruction(i,e,s))}fillCostGrid(t,i){i=i||(t=>t.isWalkableNow()?1:e.path.OBSTRUCTION),this.cells.forEach(((l,s,a)=>{l.isNull()?t[s][a]=e.path.OBSTRUCTION:t[s][a]=i(l,s,a,this)}))}matchingNeighbor(t,i,l,s=!1){const a=s?4:8;for(let s=0;s<a;++s){const a=e.utils.DIRS[s],r=t+a[0],_=i+a[1];if(this.hasXY(r,_)&&l(this.cells[r][_],r,_,this))return[r,_]}return[-1,-1]}matchingLocNear(t,i,...l){let s,a,r,_=l[0],h=l[1]||{};const n=l[0];"function"!=typeof n&&(h=n||l[1],_=h.match||e.utils.TRUE);const o=h.hallways||!1,E=h.blockingMap||null,c=!1===h.liquids,L=h.deterministic||!1,g=[];for(r=0;r<Math.max(this.width,this.height)&&!g.length;r++)for(s=t-r;s<=t+r;s++)for(a=i-r;a<=i+r;a++){if(!this.hasXY(s,a))continue;const l=this.cell(s,a);Math.ceil(e.utils.distanceBetween(t,i,s,a))!=r||E&&E[s][a]||!_(l,s,a,this)||c&&l.liquid||!(o||this.walkableArcCount(s,a)<2)||g.push([s,a])}if(0==g.length)return[-1,-1];let A=0;return A=L?Math.floor(g.length/2):e.random.number(g.length),g[A]}randomMatchingLoc(t={}){let i,l,s;"function"==typeof t&&(t={match:t});const a=e.random.sequence(this.width*this.height),r=t.hallways||!1,_=t.blockingMap||null,h=!1===t.liquids,n=t.match||e.utils.TRUE,o=t.forbidCellFlags||0,E=t.forbidTileFlags||0,c=t.forbidTileMechFlags||0,L=t.tile||null;let g=!1,A=0;for(;!g&&A<a.length;){const t=a[A];i=t%this.width,l=Math.floor(t/this.width),s=this.cell(i,l),_&&_[i][l]||L&&!s.hasTile(L)||h&&s.liquid||o&&s.flags&o||E&&s.hasTileFlag(E)||c&&s.hasTileMechFlag(c)||!(r||this.walkableArcCount(i,l)<2)||!n(s,i,l,this)||(g=!0),++A}return g?[i,l]:[-1,-1]}hasVisibleLight(t,e){return this.cell(t,e).hasVisibleLight()}addStaticLight(t,e,i){const l={x:t,y:e,light:i,next:this.lights};return this.lights=l,this.staticLightChanged=!0,l}removeStaticLight(t,e,i){let l=this.lights;if(!l)return;function s(l){return l.x==t&&l.y==e&&(!i||i===l.light)}for(this.staticLightChanged=!0;l&&s(l);)l=this.lights=l.next;if(!l)return;let a=l.next;for(;a;)s(a)?l.next=a.next:l=a,a=a.next}eachStaticLight(t){e.utils.eachChain(this.lights,(e=>t(e.light,e.x,e.y))),this.eachCell(((e,i,l)=>{for(let s of e.tiles())s.light&&t(s.light,i,l)}))}eachDynamicLight(t){e.utils.eachChain(this._actors,(e=>{e.light&&t(e.light,e.x,e.y)}))}addFx(t,e,i){if(!this.hasXY(t,e))return!1;const l=this.cell(t,e);return l.addLayer(i),i.x=t,i.y=e,this.redrawCell(l),!0}moveFx(t,e,i){if(!this.hasXY(t,e))return!1;const l=this.cell(t,e),s=this.cell(i.x,i.y);return s.removeLayer(i),this.redrawCell(s),l.addLayer(i),this.redrawCell(l),i.x=t,i.y=e,!0}removeFx(t){const e=this.cell(t.x,t.y);return e.removeLayer(t),this.redrawCell(e),this.flags|=o.MAP_CHANGED,!0}actorAt(t,e){if(!this.hasXY(t,e))return null;return this.cell(t,e).actor}addActor(t,i,l){if(!this.hasXY(t,i))return!1;const s=this.cell(t,i);if(s.actor)return!1;s.actor=l,l.next=this._actors,this._actors=l;const a=l===e.data.player?h.HAS_PLAYER:h.HAS_ANY_ACTOR;return s.flags|=a,l.light&&(this.anyLightChanged=!0),(l.isPlayer()||s.isAnyKindOfVisible()&&l.blocksVision())&&(this.flags|=o.MAP_FOV_CHANGED),l.x=t,l.y=i,this.redrawCell(s),!0}addActorNear(t,e,i){const l=this.matchingLocNear(t,e,(t=>!i.avoidsCell(t)));return!(!l||l[0]<0)&&this.addActor(l[0],l[1],i)}moveActor(t,e,i){return!!this.hasXY(t,e)&&(this.removeActor(i),this.addActor(t,e,i)?(i.light&&(this.anyLightChanged=!0),!0):(this.addActor(i.x,i.y,i),!1))}removeActor(t){if(!this.hasXY(t.x,t.y))return!1;const i=this.cell(t.x,t.y);return i.actor===t&&(i.actor=null,e.utils.removeFromChain(this,"actors",t),t.light&&(this.anyLightChanged=!0),(t.isPlayer()||i.isAnyKindOfVisible()&&t.blocksVision())&&(this.flags|=o.MAP_FOV_CHANGED),this.redrawCell(i),!0)}deleteActorAt(t,e){const i=this.actorAt(t,e);return!!i&&(this.removeActor(i),i.delete(),!0)}itemAt(t,e){return this.cell(t,e).item}addItem(t,i,l){if(!this.hasXY(t,i))return!1;const s=this.cell(t,i);return!s.item&&(l.x=t,l.y=i,s.item=l,l.next=this._items,this._items=l,l.light&&(this.anyLightChanged=!0),this.redrawCell(s),(l.isDetected()||e.config.D_ITEM_OMNISCIENCE)&&(s.flags|=h.ITEM_DETECTED),!0)}addItemNear(t,e,i){const l=this.matchingLocNear(t,e,(t=>!i.forbidsCell(t)));return!(!l||l[0]<0)&&this.addItem(l[0],l[1],i)}removeItem(t){const i=t.x,l=t.y;if(!this.hasXY(i,l))return!1;const s=this.cell(i,l);return s.item===t&&(s.item=null,e.utils.removeFromChain(this,"items",t),t.light&&(this.anyLightChanged=!0),s.flags&=~(h.HAS_ITEM|h.ITEM_DETECTED),this.redrawCell(s),!0)}gridDisruptsWalkability(t,i={}){const l=e.grid.alloc(this.width,this.height);let s=!1;const a=i.gridOffsetX||0,_=i.gridOffsetY||0,h=i.bounds||null;this.cells.forEach(((e,i,n)=>{if(h&&!h.contains(i,n))return;const o=i+a,E=n+_;if(!e.isNull())if(e.hasTileFlag(r.T_HAS_STAIRS))t.get(o,E)?s=!0:l[i][n]=1;else if(e.canBeWalked()){if(t.get(o,E))return;l[i][n]=1}}));let n=!0;for(let t=0;t<l.width&&!s;++t)for(let e=0;e<l.height&&!s;++e)1==l[t][e]&&(n?(l.floodFill(t,e,1,2),n=!1):s=!0);return e.grid.free(l),s}calcFov(t,i,l,a,r=0,_=s.L_BLOCKS_VISION){a=a||this.width+this.height,t.fill(0);const h=this;return new e.fov.FOV({isBlocked:(e,i)=>!(t.hasXY(e,i)&&!h.hasCellFlag(e,i,r)&&!h.hasLayerFlag(e,i,_)),calcRadius:(t,e)=>Math.sqrt(t**2+e**2),setVisible(e,i){t[e][i]=1},hasXY:(e,i)=>t.hasXY(e,i)}).calculate(i,l,a)}losFromTo(t,i){if(e.utils.equalsXY(t,i))return!0;const l=e.utils.getLine(t.x,t.y,i.x,i.y);return!!l.length&&!l.some((t=>this.blocksVision(t[0],t[1])))}storeMemory(t,e){this.cell(t,e).storeMemory()}storeMemories(){let t,e;for(t=0;t<this.width;++t)for(e=0;e<this.height;++e){const i=this.cell(t,e);i.flags&h.ANY_KIND_OF_VISIBLE&&i.storeMemory()}}async activateCell(t,e,i){const l=this.cell(t,e);return await l.activate(i,this,t,e,{cell:l})}async activateAll(t){return v(this,t)}async tick(){if(await v(this,"tick"),await this.forEachAsync((async(t,e,i)=>{t.mechFlags&=~n.CAUGHT_FIRE_THIS_TURN,!(t.flags&(h.HAS_ANY_ACTOR|h.HAS_ITEM))&&t.mechFlags&n.PRESSURE_PLATE_DEPRESSED&&(t.mechFlags&=~n.PRESSURE_PLATE_DEPRESSED),t.activatesOn("noKey")&&!t.hasKey()&&await t.activate("noKey",this,e,i)})),await this.forEachAsync((async(t,e,i)=>{!t.hasTileFlag(r.T_IS_FIRE)||t.mechFlags&n.CAUGHT_FIRE_THIS_TURN||(await this.exposeToFire(e,i,!1),await this.eachNeighborAsync(e,i,((t,e,i)=>this.exposeToFire(e,i)),!0))})),!(this.flags&o.MAP_NO_LIQUID)){const t=e.grid.alloc(this.width,this.height),l=it(this,i.LIQUID,t);l===et.CALC&&this.updateLiquid(t),l!=et.NONE?(lt(this,i.LIQUID,t),this.flags&=~o.MAP_NO_LIQUID):this.flags|=o.MAP_NO_LIQUID,this.changed=!0,e.grid.free(t)}if(!(this.flags&o.MAP_NO_GAS)){const t=e.grid.alloc(this.width,this.height),l=it(this,i.GAS,t);l===et.CALC&&this.updateGas(t),l!=et.NONE?(lt(this,i.GAS,t),this.flags&=~o.MAP_NO_GAS):this.flags|=o.MAP_NO_GAS,this.changed=!0,e.grid.free(t)}}async exposeToFire(t,l,a=!1){let h=0,n=0,o=0,E=!1,c=!1;const L=this.cell(t,l);if(!L.hasTileFlag(r.T_IS_FLAMMABLE))return!1;for(let t of L.tiles())t.flags.tile&r.T_EXTINGUISHES_FIRE&&t.priority>n&&(n=t.priority);for(let t of L.tiles())if(t.flags.tile&r.T_IS_FLAMMABLE&&(t.layer===i.GAS||t.priority>=n)){const i=e.effect.from(t.activates.fire);i&&i.chance>h&&(h=i.chance)}if(a||h&&e.random.chance(h,1e4)){E=!0,L.hasTileMechFlag(_.TM_EXPLOSIVE_PROMOTE)&&(this.eachNeighbor(t,l,(t=>{(t.hasLayerFlag(s.L_BLOCKS_GAS)||t.hasTileFlag(r.T_IS_FIRE)||t.hasTileMechFlag(_.TM_EXPLOSIVE_PROMOTE))&&++o})),o>=8&&(c=!0));let e="fire";c&&L.activatesOn("explode")&&(e="explode");for(let t of L.tiles())t.flags.tile&r.T_IS_FLAMMABLE&&(t.layer===i.GAS?L.gasVolume=0:t.layer===i.LIQUID&&(L.liquidVolume=0));await L.activate(e,this,t,l,{force:!0}),this.redrawCell(L)}return E}updateLiquid(t){this.randomEach(((e,i,l)=>{if(e.hasLayerFlag(s.L_BLOCKS_LIQUID))return;let a=0,r=-1,_=-1,h=e.liquidTile,n=t[i][l];if(t.eachNeighbor(i,l,((t,e,i)=>{t<=n||t<=a||(a=t,r=e,_=i,h=this.cell(e,i).liquidTile)})),a>1){this.setTile(i,l,h,0);const e=Math.floor((a-n)/9)+1;t[i][l]+=e,t[r][_]-=e}}))}updateGas(t){const i=e.random.sequence(4).map((t=>e.utils.DIRS[t])),l=e.grid.alloc(this.width,this.height);t.forEach(((e,s,a)=>{if(!e)return;let r=e;if(e>1){let _=1;t.eachNeighbor(s,a,(()=>{++_}),!0);let h=Math.floor(e/_),n=e-h*_;l[s][a]+=h,n>0&&(l[s][a]+=1,n-=1);for(let t=0;t<i.length;++t){const e=i[t],_=s+e[0],o=a+e[1];l.hasXY(_,o)&&(r=h,n>0&&(--n,++r),l[_][o]+=r)}}else l[s][a]+=e})),t.copy(l),e.grid.free(l)}resetCellEvents(){this.forEach((t=>t.mechFlags&=~(n.EVENT_FIRED_THIS_TURN|n.EVENT_PROTECTED)))}}function Z(t,i,l={},s){"string"==typeof l&&(l={tile:l},s&&(l.wall=s));const a=new J(t,i,l);let r=l.tile||l.floor||l.floorTile;!0===r&&(r="FLOOR");let _=l.boundary||l.wall||l.wallTile;return!0===_&&(_="WALL"),r&&a.fill(r,_),(l.visible||l.revealed)&&(a.makeVisible(),a.revealAll()),l.revealed&&!l.visible&&a.makeVisible(!1),e.data.map||(e.data.map=a),a}function tt(t,i,l,a){if(a.blackOut(),!t.hasXY(i,l))return;const r=t.cell(i,l);r.isAnyKindOfVisible()&&r.flags&(h.CELL_CHANGED|h.NEEDS_REDRAW)?U(r,a):a.drawSprite(r.memory.mixer),r.isVisible()||(r.isRevealed()?r.isAnyKindOfVisible()||(a.bg.mix(e.colors.black,30),a.fg.mix(e.colors.black,30)):r.isAnyKindOfVisible()||a.blackOut());let _=!1;if(r.flags&(h.IS_CURSOR|h.IS_IN_PATH)){const t=r.flags&h.IS_CURSOR?e.colors.cursor:e.colors.path;r.hasLayerFlag(s.L_INVERT_WHEN_HIGHLIGHTED)?e.color.swap(a.fg,a.bg):a.bg.mix(t,e.config.cursorPathIntensity||20),_=!0}_&&e.color.separate(a.fg,a.bg)}var et;function it(t,i,l){let s=!1,a=!1;return t.forEach(((r,_,h)=>{let n=r.volume(i);const o=r.tile(i);n&&o.dissipate&&(o.dissipate>1e4?(n-=Math.floor(o.dissipate/1e4),e.random.chance(o.dissipate%1e4,1e4)&&(n-=1)):e.random.chance(o.dissipate,1e4)&&(n-=1)),n>0?(l[_][h]=n,s=!0,n>1&&(a=!0)):o!==m.NULL&&(r.clearLayer(i),t.redrawCell(r))})),a?et.CALC:s?et.UPDATE:et.NONE}function lt(t,e,i){i.forEach(((i,l,s)=>{const a=t.cell(l,s),r=a.volume(e),_=a.tile(e);if(i>0){if(r!==i||!_){let h=r,n=_;t.eachNeighbor(l,s,(t=>{t.volume(e)>h&&(h=t.volume(e),n=t.tile(e))})),n!==_&&a.setTile(n,0,t),a.setVolume(e,i),t.redrawCell(a)}}else(r||_!==m.NULL)&&(a.clearLayer(e),t.redrawCell(a))}))}e.make.map=Z,e.colors.cursor||e.color.install("cursor",e.colors.yellow),e.colors.path||e.color.install("path",e.colors.gold),function(t){t[t.NONE=0]="NONE",t[t.UPDATE=1]="UPDATE",t[t.CALC=2]="CALC"}(et||(et={}));var st={__proto__:null,get Flags(){return o},Map:J,make:Z,from:function(t,e,i={}){let l,s=0,a=0;return"string"==typeof t&&(t=t.split("\n")),!function(t){return Array.isArray(t)&&"string"==typeof t[0]}(t)?(s=t.height,a=t.width,l=Z(a,s,i),t.forEach(((t,i,s)=>{const a=e[t]||"FLOOR";l.setTile(i,s,a)}))):(s=t.length,a=t.reduce(((t,e)=>Math.max(t,e.length)),0),l=Z(a,s,i),t.forEach(((t,i)=>{for(let s=0;s<a;++s){const a=t[s]||".",r=e[a]||"FLOOR";l.setTile(s,i,r)}}))),(i.visible||i.revealed)&&(l.makeVisible(),l.revealAll()),i.revealed&&!i.visible&&l.makeVisible(!1),l},getCellAppearance:tt,addText:function(t,e,l,s,a,r,_){for(let h of s){const s=d({ch:h,fg:a,bg:r,layer:_||i.GROUND,priority:200});t.cell(e++,l).addLayer(s)}},analyze:function(t,e=!0){X(t),x(t,e)},updateChokepoints:x,floodFillCount:Q,updateLoopiness:X,resetLoopiness:q,checkLoopiness:j,fillInnerLoopGrid:z,cleanLoopiness:$};M("NULL",{ch:"∅",fg:"white",bg:"black",flags:"L_BLOCKS_MOVE",name:"eerie nothingness",article:"an",priority:0}),M("FLOOR",{ch:"·",fg:[30,30,30,20,0,0,0],bg:[2,2,10,0,2,2,0],priority:10,article:"the"}),M("DOOR",{ch:"+",fg:[100,40,40],bg:[30,60,60],priority:30,flags:"T_IS_DOOR, L_BLOCKS_EFFECTS, L_BLOCKS_ITEMS, L_BLOCKS_VISION, L_VISUALLY_DISTINCT",article:"a",activates:{enter:{tile:"DOOR_OPEN"},open:{tile:"DOOR_OPEN_ALWAYS"}}}),M("DOOR_OPEN","DOOR",{ch:"'",fg:[100,40,40],bg:[30,60,60],priority:40,flags:"!L_BLOCKS_ITEMS, !L_BLOCKS_VISION",name:"open door",article:"an",activates:{tick:{chance:1e4,tile:"DOOR",flags:"E_SUPERPRIORITY, E_ONLY_IF_EMPTY"},enter:null,open:null,close:{tile:"DOOR",flags:"E_SUPERPRIORITY, E_ONLY_IF_EMPTY"}}}),M("DOOR_OPEN_ALWAYS","DOOR_OPEN",{activates:{tick:null,close:{tile:"DOOR",flags:"E_SUPERPRIORITY, E_ONLY_IF_EMPTY"}}}),M("UP_STAIRS",{ch:"<",fg:[100,50,50],bg:[40,20,20],priority:200,flags:"T_UP_STAIRS, L_BLOCKED_BY_STAIRS, L_VISUALLY_DISTINCT, L_LIST_IN_SIDEBAR",name:"upward staircase",article:"an"}),M("DOWN_STAIRS",{ch:">",fg:[100,50,50],bg:[40,20,20],priority:200,flags:"T_DOWN_STAIRS, L_BLOCKED_BY_STAIRS, L_VISUALLY_DISTINCT, L_LIST_IN_SIDEBAR",name:"downward staircase",article:"a"}),M("WALL",{ch:"#",fg:[7,7,7,0,3,3,3],bg:[40,40,40,10,10,0,5],priority:100,flags:"L_BLOCKS_EVERYTHING",article:"a",name:"stone wall",desc:"A wall made from rough cut stone.",flavor:"a rough stone wall"}),M("LAKE",{ch:"~",fg:[5,8,20,10,0,4,15,!0],bg:[10,15,41,6,5,5,5,!0],priority:50,flags:"T_DEEP_WATER",name:"deep water",article:"the"}),M("SHALLOW",{ch:"·",fg:[5,8,10,10,0,4,15,!0],bg:[10,15,21,6,5,5,5,!0],priority:20,name:"shallow water",article:"the"}),M("BRIDGE",{ch:"=",fg:[100,40,40],priority:40,layer:"SURFACE",flags:"T_BRIDGE, L_VISUALLY_DISTINCT",article:"a",ground:"LAKE"}),t.cell=H,t.entity=F,t.light=R,t.lights=I,t.map=st,t.tile=P,t.tiles=m,t.visibility=W,Object.defineProperty(t,"__esModule",{value:!0})}));
//# sourceMappingURL=gw-map.min.js.map
