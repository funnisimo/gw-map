!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("gw-utils")):"function"==typeof define&&define.amd?define(["exports","gw-utils"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).GW=t.GW||{},t.GW)}(this,(function(t,e){"use strict";var i;!function(t){t[t.ALL_LAYERS=-1]="ALL_LAYERS",t[t.GROUND=0]="GROUND",t[t.LIQUID=1]="LIQUID",t[t.SURFACE=2]="SURFACE",t[t.GAS=3]="GAS",t[t.ITEM=4]="ITEM",t[t.ACTOR=5]="ACTOR",t[t.PLAYER=6]="PLAYER",t[t.FX=7]="FX",t[t.UI=8]="UI"}(i||(i={}));const s=e.flag.fl;var l,a,r,_,h,n,E;!function(t){t[t.L_DYNAMIC=s(0)]="L_DYNAMIC",t[t.L_SUPERPRIORITY=s(1)]="L_SUPERPRIORITY",t[t.L_SECRETLY_PASSABLE=s(2)]="L_SECRETLY_PASSABLE",t[t.L_BLOCKS_MOVE=s(3)]="L_BLOCKS_MOVE",t[t.L_BLOCKS_VISION=s(4)]="L_BLOCKS_VISION",t[t.L_BLOCKS_SURFACE=s(6)]="L_BLOCKS_SURFACE",t[t.L_BLOCKS_LIQUID=s(8)]="L_BLOCKS_LIQUID",t[t.L_BLOCKS_GAS=s(7)]="L_BLOCKS_GAS",t[t.L_BLOCKS_ITEMS=s(5)]="L_BLOCKS_ITEMS",t[t.L_BLOCKS_ACTORS=s(11)]="L_BLOCKS_ACTORS",t[t.L_BLOCKS_EFFECTS=s(9)]="L_BLOCKS_EFFECTS",t[t.L_BLOCKS_DIAGONAL=s(10)]="L_BLOCKS_DIAGONAL",t[t.L_BLOCKED_BY_STAIRS=t.L_BLOCKS_ITEMS|t.L_BLOCKS_SURFACE|t.L_BLOCKS_GAS|t.L_BLOCKS_LIQUID|t.L_BLOCKS_EFFECTS|t.L_BLOCKS_ACTORS]="L_BLOCKED_BY_STAIRS",t[t.L_BLOCKS_SCENT=t.L_BLOCKS_MOVE|t.L_BLOCKS_VISION]="L_BLOCKS_SCENT",t[t.L_DIVIDES_LEVEL=t.L_BLOCKS_MOVE]="L_DIVIDES_LEVEL",t[t.L_WAYPOINT_BLOCKER=t.L_BLOCKS_MOVE]="L_WAYPOINT_BLOCKER",t[t.L_IS_WALL=t.L_BLOCKS_MOVE|t.L_BLOCKS_VISION|t.L_BLOCKS_LIQUID|t.L_BLOCKS_GAS|t.L_BLOCKS_EFFECTS|t.L_BLOCKS_DIAGONAL]="L_IS_WALL",t[t.L_BLOCKS_EVERYTHING=t.L_IS_WALL|t.L_BLOCKS_ITEMS|t.L_BLOCKS_ACTORS|t.L_BLOCKS_SURFACE]="L_BLOCKS_EVERYTHING"}(l||(l={})),function(t){t[t.DFF_SUBSEQ_ALWAYS=s(0)]="DFF_SUBSEQ_ALWAYS",t[t.DFF_SUBSEQ_EVERYWHERE=s(1)]="DFF_SUBSEQ_EVERYWHERE",t[t.DFF_TREAT_AS_BLOCKING=s(2)]="DFF_TREAT_AS_BLOCKING",t[t.DFF_PERMIT_BLOCKING=s(3)]="DFF_PERMIT_BLOCKING",t[t.DFF_ACTIVATE_DORMANT_MONSTER=s(4)]="DFF_ACTIVATE_DORMANT_MONSTER",t[t.DFF_BLOCKED_BY_OTHER_LAYERS=s(6)]="DFF_BLOCKED_BY_OTHER_LAYERS",t[t.DFF_SUPERPRIORITY=s(7)]="DFF_SUPERPRIORITY",t[t.DFF_AGGRAVATES_MONSTERS=s(8)]="DFF_AGGRAVATES_MONSTERS",t[t.DFF_RESURRECT_ALLY=s(9)]="DFF_RESURRECT_ALLY",t[t.DFF_EMIT_EVENT=s(10)]="DFF_EMIT_EVENT",t[t.DFF_NO_REDRAW_CELL=s(11)]="DFF_NO_REDRAW_CELL",t[t.DFF_ABORT_IF_BLOCKS_MAP=s(12)]="DFF_ABORT_IF_BLOCKS_MAP",t[t.DFF_BLOCKED_BY_ITEMS=s(13)]="DFF_BLOCKED_BY_ITEMS",t[t.DFF_BLOCKED_BY_ACTORS=s(14)]="DFF_BLOCKED_BY_ACTORS",t[t.DFF_ALWAYS_FIRE=s(15)]="DFF_ALWAYS_FIRE",t[t.DFF_NO_MARK_FIRED=s(16)]="DFF_NO_MARK_FIRED",t[t.DFF_PROTECTED=s(19)]="DFF_PROTECTED",t[t.DFF_SPREAD_CIRCLE=s(20)]="DFF_SPREAD_CIRCLE",t[t.DFF_SPREAD_LINE=s(21)]="DFF_SPREAD_LINE",t[t.DFF_NULL_SURFACE=s(22)]="DFF_NULL_SURFACE",t[t.DFF_NULL_LIQUID=s(23)]="DFF_NULL_LIQUID",t[t.DFF_NULL_GAS=s(24)]="DFF_NULL_GAS",t[t.DFF_EVACUATE_CREATURES=s(25)]="DFF_EVACUATE_CREATURES",t[t.DFF_EVACUATE_ITEMS=s(26)]="DFF_EVACUATE_ITEMS",t[t.DFF_BUILD_IN_WALLS=s(27)]="DFF_BUILD_IN_WALLS",t[t.DFF_MUST_TOUCH_WALLS=s(28)]="DFF_MUST_TOUCH_WALLS",t[t.DFF_NO_TOUCH_WALLS=s(29)]="DFF_NO_TOUCH_WALLS",t[t.DFF_ONLY_IF_EMPTY=t.DFF_BLOCKED_BY_ITEMS|t.DFF_BLOCKED_BY_ACTORS]="DFF_ONLY_IF_EMPTY",t[t.DFF_NULLIFY_CELL=t.DFF_NULL_SURFACE|t.DFF_NULL_LIQUID|t.DFF_NULL_GAS]="DFF_NULLIFY_CELL"}(a||(a={})),function(t){t[t.T_LIQUID=s(0)]="T_LIQUID",t[t.T_SURFACE=s(1)]="T_SURFACE",t[t.T_GAS=s(2)]="T_GAS",t[t.T_BRIDGE=s(11)]="T_BRIDGE",t[t.T_AUTO_DESCENT=s(12)]="T_AUTO_DESCENT",t[t.T_LAVA=s(13)]="T_LAVA",t[t.T_DEEP_WATER=s(14)]="T_DEEP_WATER",t[t.T_SPONTANEOUSLY_IGNITES=s(15)]="T_SPONTANEOUSLY_IGNITES",t[t.T_IS_FLAMMABLE=s(16)]="T_IS_FLAMMABLE",t[t.T_IS_FIRE=s(17)]="T_IS_FIRE",t[t.T_ENTANGLES=s(18)]="T_ENTANGLES",t[t.T_IS_TRAP=s(24)]="T_IS_TRAP",t[t.T_SACRED=s(26)]="T_SACRED",t[t.T_UP_STAIRS=s(27)]="T_UP_STAIRS",t[t.T_DOWN_STAIRS=s(28)]="T_DOWN_STAIRS",t[t.T_PORTAL=s(29)]="T_PORTAL",t[t.T_IS_DOOR=s(30)]="T_IS_DOOR",t[t.T_HAS_STAIRS=t.T_UP_STAIRS|t.T_DOWN_STAIRS|t.T_PORTAL]="T_HAS_STAIRS",t[t.T_OBSTRUCTS_SCENT=t.T_AUTO_DESCENT|t.T_LAVA|t.T_DEEP_WATER|t.T_SPONTANEOUSLY_IGNITES|t.T_HAS_STAIRS]="T_OBSTRUCTS_SCENT",t[t.T_PATHING_BLOCKER=t.T_AUTO_DESCENT|t.T_IS_TRAP|t.T_LAVA|t.T_DEEP_WATER|t.T_IS_FIRE|t.T_SPONTANEOUSLY_IGNITES|t.T_ENTANGLES]="T_PATHING_BLOCKER",t[t.T_DIVIDES_LEVEL=t.T_AUTO_DESCENT|t.T_IS_TRAP|t.T_LAVA|t.T_DEEP_WATER]="T_DIVIDES_LEVEL",t[t.T_LAKE_PATHING_BLOCKER=t.T_AUTO_DESCENT|t.T_LAVA|t.T_DEEP_WATER|t.T_SPONTANEOUSLY_IGNITES]="T_LAKE_PATHING_BLOCKER",t[t.T_WAYPOINT_BLOCKER=t.T_AUTO_DESCENT|t.T_IS_TRAP|t.T_LAVA|t.T_DEEP_WATER|t.T_SPONTANEOUSLY_IGNITES]="T_WAYPOINT_BLOCKER",t[t.T_MOVES_ITEMS=t.T_DEEP_WATER|t.T_LAVA]="T_MOVES_ITEMS",t[t.T_CAN_BE_BRIDGED=t.T_AUTO_DESCENT|t.T_LAVA|t.T_DEEP_WATER]="T_CAN_BE_BRIDGED",t[t.T_IS_DEEP_LIQUID=t.T_LAVA|t.T_AUTO_DESCENT|t.T_DEEP_WATER]="T_IS_DEEP_LIQUID"}(r||(r={})),function(t){t[t.TM_IS_SECRET=s(0)]="TM_IS_SECRET",t[t.TM_PROMOTES_WITH_KEY=s(1)]="TM_PROMOTES_WITH_KEY",t[t.TM_PROMOTES_WITHOUT_KEY=s(2)]="TM_PROMOTES_WITHOUT_KEY",t[t.TM_PROMOTES_ON_STEP=s(3)]="TM_PROMOTES_ON_STEP",t[t.TM_PROMOTES_ON_ITEM_REMOVE=s(4)]="TM_PROMOTES_ON_ITEM_REMOVE",t[t.TM_PROMOTES_ON_PLAYER_ENTRY=s(5)]="TM_PROMOTES_ON_PLAYER_ENTRY",t[t.TM_PROMOTES_ON_SACRIFICE_ENTRY=s(6)]="TM_PROMOTES_ON_SACRIFICE_ENTRY",t[t.TM_PROMOTES_ON_ELECTRICITY=s(7)]="TM_PROMOTES_ON_ELECTRICITY",t[t.TM_ALLOWS_SUBMERGING=s(8)]="TM_ALLOWS_SUBMERGING",t[t.TM_IS_WIRED=s(9)]="TM_IS_WIRED",t[t.TM_IS_CIRCUIT_BREAKER=s(10)]="TM_IS_CIRCUIT_BREAKER",t[t.TM_EXTINGUISHES_FIRE=s(14)]="TM_EXTINGUISHES_FIRE",t[t.TM_VANISHES_UPON_PROMOTION=s(15)]="TM_VANISHES_UPON_PROMOTION",t[t.TM_REFLECTS_BOLTS=s(16)]="TM_REFLECTS_BOLTS",t[t.TM_STAND_IN_TILE=s(17)]="TM_STAND_IN_TILE",t[t.TM_LIST_IN_SIDEBAR=s(18)]="TM_LIST_IN_SIDEBAR",t[t.TM_VISUALLY_DISTINCT=s(19)]="TM_VISUALLY_DISTINCT",t[t.TM_BRIGHT_MEMORY=s(20)]="TM_BRIGHT_MEMORY",t[t.TM_EXPLOSIVE_PROMOTE=s(21)]="TM_EXPLOSIVE_PROMOTE",t[t.TM_CONNECTS_LEVEL=s(22)]="TM_CONNECTS_LEVEL",t[t.TM_INTERRUPT_EXPLORATION_WHEN_SEEN=s(23)]="TM_INTERRUPT_EXPLORATION_WHEN_SEEN",t[t.TM_INVERT_WHEN_HIGHLIGHTED=s(24)]="TM_INVERT_WHEN_HIGHLIGHTED",t[t.TM_SWAP_ENCHANTS_ACTIVATION=s(25)]="TM_SWAP_ENCHANTS_ACTIVATION",t[t.TM_PROMOTES=t.TM_PROMOTES_WITH_KEY|t.TM_PROMOTES_WITHOUT_KEY|t.TM_PROMOTES_ON_STEP|t.TM_PROMOTES_ON_ITEM_REMOVE|t.TM_PROMOTES_ON_SACRIFICE_ENTRY|t.TM_PROMOTES_ON_ELECTRICITY|t.TM_PROMOTES_ON_PLAYER_ENTRY]="TM_PROMOTES"}(_||(_={})),function(t){t[t.REVEALED=s(0)]="REVEALED",t[t.VISIBLE=s(1)]="VISIBLE",t[t.WAS_VISIBLE=s(2)]="WAS_VISIBLE",t[t.IN_FOV=s(3)]="IN_FOV",t[t.HAS_PLAYER=s(4)]="HAS_PLAYER",t[t.HAS_MONSTER=s(5)]="HAS_MONSTER",t[t.HAS_DORMANT_MONSTER=s(6)]="HAS_DORMANT_MONSTER",t[t.HAS_ITEM=s(7)]="HAS_ITEM",t[t.HAS_STAIRS=s(8)]="HAS_STAIRS",t[t.NEEDS_REDRAW=s(9)]="NEEDS_REDRAW",t[t.CELL_CHANGED=s(10)]="CELL_CHANGED",t[t.IS_IN_PATH=s(12)]="IS_IN_PATH",t[t.IS_CURSOR=s(13)]="IS_CURSOR",t[t.MAGIC_MAPPED=s(14)]="MAGIC_MAPPED",t[t.ITEM_DETECTED=s(15)]="ITEM_DETECTED",t[t.STABLE_MEMORY=s(16)]="STABLE_MEMORY",t[t.CLAIRVOYANT_VISIBLE=s(17)]="CLAIRVOYANT_VISIBLE",t[t.WAS_CLAIRVOYANT_VISIBLE=s(18)]="WAS_CLAIRVOYANT_VISIBLE",t[t.CLAIRVOYANT_DARKENED=s(19)]="CLAIRVOYANT_DARKENED",t[t.IMPREGNABLE=s(20)]="IMPREGNABLE",t[t.TELEPATHIC_VISIBLE=s(22)]="TELEPATHIC_VISIBLE",t[t.WAS_TELEPATHIC_VISIBLE=s(23)]="WAS_TELEPATHIC_VISIBLE",t[t.MONSTER_DETECTED=s(24)]="MONSTER_DETECTED",t[t.WAS_MONSTER_DETECTED=s(25)]="WAS_MONSTER_DETECTED",t[t.LIGHT_CHANGED=s(27)]="LIGHT_CHANGED",t[t.CELL_LIT=s(28)]="CELL_LIT",t[t.IS_IN_SHADOW=s(29)]="IS_IN_SHADOW",t[t.CELL_DARK=s(30)]="CELL_DARK",t[t.PERMANENT_CELL_FLAGS=t.REVEALED|t.MAGIC_MAPPED|t.ITEM_DETECTED|t.HAS_ITEM|t.HAS_DORMANT_MONSTER|t.HAS_STAIRS|t.STABLE_MEMORY|t.IMPREGNABLE]="PERMANENT_CELL_FLAGS",t[t.ANY_KIND_OF_VISIBLE=t.VISIBLE|t.CLAIRVOYANT_VISIBLE|t.TELEPATHIC_VISIBLE]="ANY_KIND_OF_VISIBLE",t[t.HAS_ACTOR=t.HAS_PLAYER|t.HAS_MONSTER]="HAS_ACTOR",t[t.IS_WAS_ANY_KIND_OF_VISIBLE=t.VISIBLE|t.WAS_VISIBLE|t.CLAIRVOYANT_VISIBLE|t.WAS_CLAIRVOYANT_VISIBLE|t.TELEPATHIC_VISIBLE|t.WAS_TELEPATHIC_VISIBLE]="IS_WAS_ANY_KIND_OF_VISIBLE",t[t.CELL_DEFAULT=t.VISIBLE|t.IN_FOV|t.NEEDS_REDRAW|t.CELL_CHANGED]="CELL_DEFAULT"}(h||(h={})),function(t){t[t.SEARCHED_FROM_HERE=s(0)]="SEARCHED_FROM_HERE",t[t.PRESSURE_PLATE_DEPRESSED=s(1)]="PRESSURE_PLATE_DEPRESSED",t[t.KNOWN_TO_BE_TRAP_FREE=s(2)]="KNOWN_TO_BE_TRAP_FREE",t[t.CAUGHT_FIRE_THIS_TURN=s(4)]="CAUGHT_FIRE_THIS_TURN",t[t.EVENT_FIRED_THIS_TURN=s(5)]="EVENT_FIRED_THIS_TURN",t[t.EVENT_PROTECTED=s(6)]="EVENT_PROTECTED",t[t.IS_IN_LOOP=s(10)]="IS_IN_LOOP",t[t.IS_CHOKEPOINT=s(11)]="IS_CHOKEPOINT",t[t.IS_GATE_SITE=s(12)]="IS_GATE_SITE",t[t.IS_IN_ROOM_MACHINE=s(13)]="IS_IN_ROOM_MACHINE",t[t.IS_IN_AREA_MACHINE=s(14)]="IS_IN_AREA_MACHINE",t[t.IS_POWERED=s(15)]="IS_POWERED",t[t.IS_IN_MACHINE=t.IS_IN_ROOM_MACHINE|t.IS_IN_AREA_MACHINE]="IS_IN_MACHINE",t[t.PERMANENT_MECH_FLAGS=t.SEARCHED_FROM_HERE|t.PRESSURE_PLATE_DEPRESSED|t.KNOWN_TO_BE_TRAP_FREE|t.IS_IN_LOOP|t.IS_CHOKEPOINT|t.IS_GATE_SITE|t.IS_IN_MACHINE]="PERMANENT_MECH_FLAGS"}(n||(n={})),function(t){t[t.MAP_CHANGED=s(0)]="MAP_CHANGED",t[t.MAP_STABLE_GLOW_LIGHTS=s(1)]="MAP_STABLE_GLOW_LIGHTS",t[t.MAP_STABLE_LIGHTS=s(2)]="MAP_STABLE_LIGHTS",t[t.MAP_ALWAYS_LIT=s(3)]="MAP_ALWAYS_LIT",t[t.MAP_SAW_WELCOME=s(4)]="MAP_SAW_WELCOME",t[t.MAP_NO_LIQUID=s(5)]="MAP_NO_LIQUID",t[t.MAP_NO_GAS=s(6)]="MAP_NO_GAS",t[t.MAP_FOV_CHANGED=s(7)]="MAP_FOV_CHANGED",t[t.MAP_DEFAULT=t.MAP_STABLE_LIGHTS|t.MAP_STABLE_GLOW_LIGHTS|t.MAP_FOV_CHANGED]="MAP_DEFAULT"}(E||(E={}));const o=e.config.light={INTENSITY_DARK:20},c=e.color.make();class T{constructor(t,i,s,l=!1){this.fadeTo=0,this.passThroughActors=!1,this.id=null,this.color=e.color.from(t)||null,this.radius=e.range.make(i||1),this.fadeTo=s||0,this.passThroughActors=l}copy(t){this.color=t.color,this.radius.copy(t.radius),this.fadeTo=t.fadeTo,this.passThroughActors=t.passThroughActors}get intensity(){return L(this.color)}paint(t,i,s,a=!1,r=!1){if(!t)return!1;let _,n,E=this.radius.value(),T=Math.ceil(E);c.copy(this.color).bake();const g=!r&&!a&&L(c)>o.INTENSITY_DARK,S=this.fadeTo,A=e.grid.alloc(t.width,t.height,0);t.calcFov(A,i,s,T,this.passThroughActors?0:h.HAS_ACTOR,l.L_BLOCKS_VISION);let I=!1;if(A.forCircle(i,s,T,((l,a,r)=>{if(!l)return;const o=t.cell(a,r);for(n=Math.floor(100-(100-S)*(e.utils.distanceBetween(i,s,a,r)/E)),_=0;_<3;_++)o.light[_]+=Math.floor(c[_]*n/100);g&&(o.flags&=~h.IS_IN_SHADOW),o.flags&(h.IN_FOV|h.ANY_KIND_OF_VISIBLE)&&(I=!0)})),g){t.cell(i,s).flags&=~h.IS_IN_SHADOW}return e.grid.free(A),I}}function L(t){return Math.max(t[0],t[1],t[2])}function g(...t){if(1==t.length){const i=t[0];if("string"==typeof i){const t=S[i];if(t)return t;const[s,l,a,r]=i.split(/[,|]/).map((t=>t.trim()));return new T(e.color.from(s),e.range.from(l||1),Number.parseInt(a||"0"),!!r&&"false"!==r)}if(Array.isArray(i)){const[t,e,s,l]=i;return new T(t,e,s,l)}if(i&&i.color)return new T(e.color.from(i.color),e.range.from(i.radius),Number.parseInt(i.fadeTo||"0"),i.pass);throw new Error("Unknown Light config - "+i)}{const[e,i,s,l]=t;return new T(e,i,s,l)}}e.make.light=g;const S={};function A(t,...e){let i;return i=1==e.length?g(e[0]):g(e[0],e[1],e[2],e[3]),S[t]=i,i&&(i.id=t),i}function I(t){let e;t.eachCell((t=>{for(e=0;e<3;e++)t.oldLight[e]=t.light[e],t.lightChanged=!1}))}function u(t){let e;const i=t.ambientLight?t.ambientLight:[0,0,0];t.eachCell(((t,s,l)=>{for(e=0;e<3;e++)t.light[e]=i[e];t.flags|=h.IS_IN_SHADOW}))}function f(t){let e;t.eachCell((t=>{for(e=0;e<3;e++)t.glowLight[e]=t.light[e]}))}function O(t){let e;t.eachCell((t=>{for(e=0;e<3;e++)t.light[e]=t.glowLight[e]}))}var R={__proto__:null,config:o,Light:T,intensity:L,make:g,lights:S,from:function(...t){1!=t.length&&e.utils.ERROR("Unknown Light config: "+JSON.stringify(t));const i=t[0];if("string"==typeof i){const t=S[i];if(t)return t}return g(i)},install:A,installAll:function(t={}){Object.entries(t).forEach((([t,e])=>{A(t,e)}))},recordOldLights:I,zeroOutLights:u,recordGlowLights:f,restoreGlowLights:O,updateLighting:function(t){if(I(t),!t.lightChanged)return!1;u(t),t.glowLightChanged?(t.eachStaticLight(((e,i,s)=>{e&&e.paint(t,i,s)})),f(t),t.glowLightChanged=!1):O(t),t.eachDynamicLight(((e,i,s)=>{e.paint(t,i,s)})),function(t){t.eachCell(((t,e,i)=>{t.flags&=~(h.CELL_LIT|h.CELL_DARK),t.light.some(((e,i)=>e!==t.oldLight[i]))&&(t.lightChanged=!0),t.isDark()?t.flags|=h.CELL_DARK:t.flags&h.IS_IN_SHADOW||(t.flags|=h.CELL_LIT)}))}(t);const i=e.data.player;if(i){const e=S.PLAYERS_LIGHT;e&&e.radius&&e.paint(t,i.x,i.y,!0,!0)}return t.lightChanged=!1,!0},playerInDarkness:function(t,e,i){return t.cell(e.x,e.y).isDark(i)}};class F{constructor(t){this.priority=50,this.depth=0,this.light=null,this.flags={layer:0},this.sprite=e.make.sprite(t.sprite||t),this.light=t.light?g(t.light):null,this.priority=e.utils.first(t.priority,50),this.depth=(t.depth&&"number"!=typeof t.depth?i[t.depth]:t.depth)||0,this.flags.layer=e.flag.from(l,t.layerFlags,t.flags,0)}}function d(t){return new F(t)}e.make.layer=d;var C={__proto__:null,get Flags(){return l},get Depth(){return i},Layer:F,make:d};class N{constructor(t={}){"function"==typeof t&&(t={fn:t}),this.tile=t.tile||null,this.fn=t.fn||null,this.item=t.item||null,this.chance=t.chance||0,this.volume=t.volume||0,this.spread=t.spread||0,this.radius=t.radius||0,this.decrement=t.decrement||0,this.flags=e.flag.from(a,t.flags),this.matchTile=t.matchTile||t.needs||0,this.next=t.next||null,this.message=t.message||null,this.lightFlare=t.flare||null,this.flashColor=t.flash?e.color.from(t.flash):null,this.messageDisplayed=!1,this.emit=t.emit||null,this.id=t.id||null}}function D(t){if(!t)return null;"string"==typeof t&&(t={tile:t});return new N(t)}e.make.tileEvent=D;const m={};function M(t,e){return e instanceof N||(e=D(e)),m[t]=e,e&&(e.id=t),e}async function y(t,i={}){let s,l,_;if(t||e.utils.ERROR("No activation."),i||e.utils.ERROR("Context required - and must include map, x, y"),"string"==typeof t)_=m[t],_||e.utils.ERROR("Unknown tile Event: "+t);else{if("function"==typeof t)return t(i);_=t}const h=i.map,E=i.x,o=i.y;if(void 0!==E&&void 0!==o&&h||e.utils.ERROR("MAP, x, y are required in context."),i.safe&&h.hasCellMechFlag(E,o,n.EVENT_FIRED_THIS_TURN)&&!(_.flags&a.DFF_ALWAYS_FIRE))return!1;i.refreshCell=i.refreshCell||!(_.flags&a.DFF_NO_REDRAW_CELL);const c=i.abortIfBlocking=i.abortIfBlocking||_.flags&a.DFF_ABORT_IF_BLOCKS_MAP;_.message&&_.message.length&&!_.messageDisplayed&&h.isVisible(E,o)&&(_.messageDisplayed=!0,e.message.add(_.message));let T=null;_.tile&&(T=Y[_.tile]||null,T||e.utils.ERROR("Unknown tile: "+_.tile));let L=null;_.item&&"item"in e.make&&(L=e.make.item(_.item),L||e.utils.ERROR("Unknown item: "+_.item));const g=i.blocking=!(!c||_.flags&a.DFF_PERMIT_BLOCKING||!(T&&T.blocksPathing()||L&&L.blocksMove()||_.flags&a.DFF_TREAT_AS_BLOCKING)),S=e.grid.alloc(h.width,h.height);let A=!1;if(p(_,S,i),g&&h.gridDisruptsPassability(S,{bounds:i.bounds})||(_.flags&a.DFF_EVACUATE_CREATURES&&U(h,S)&&(A=!0),_.flags&a.DFF_EVACUATE_ITEMS&&G(h,S)&&(A=!0),_.flags&a.DFF_NULLIFY_CELL&&V(h,S,_.flags)&&(A=!0),(T||L||_.fn)&&await B(_,S,i,T,L)&&(A=!0)),L&&L.delete(),A&&_.flags&a.DFF_PROTECTED&&S.forEach(((t,e,i)=>{if(!t)return;h.cell(e,i).mechFlags|=n.EVENT_PROTECTED})),A)for(let t=0;t<S.width;++t)for(let i=0;i<S.height;++i){if(!S[t][i]||e.data.gameHasEnded)continue;const s=h.cell(t,i);(s.actor||s.item)&&await s.activate("enter",{map:h,x:t,y:i,cell:s})}if(_.emit&&(await e.events.emit(_.emit,i),A=!0),e.data.gameHasEnded)return e.grid.free(S),A;if(_.next&&(A||_.flags&a.DFF_SUBSEQ_ALWAYS))if(_.flags&a.DFF_SUBSEQ_EVERYWHERE){for(s=0;s<h.width;s++)for(l=0;l<h.height;l++)S[s][l]&&(i.x=s,i.y=l,await y(_.next,i));i.x=E,i.y=o}else await y(_.next,i);return A&&T&&T.flags.tile&(r.T_DEEP_WATER|r.T_LAVA|r.T_AUTO_DESCENT)&&(e.data.updateMapToShoreThisTurn=!1),A&&(S.forEach(((t,e,i)=>{t&&h.redrawXY(e,i)})),h.changed=!0,_.flags&a.DFF_NO_MARK_FIRED||S.forEach(((t,e,i)=>{t&&h.setCellFlags(e,i,0,n.EVENT_FIRED_THIS_TURN)}))),e.grid.free(S),A}function P(t,e,i,s={}){const r=s.map;if(!r.hasXY(e,i))return!1;const _=r.cell(e,i);if(t.flags&a.DFF_BUILD_IN_WALLS){if(!_.isWall())return!1}else if(t.flags&a.DFF_MUST_TOUCH_WALLS){let t=!1;if(r.eachNeighbor(e,i,(e=>{e.isWall()&&(t=!0)})),!t)return!1}else if(t.flags&a.DFF_NO_TOUCH_WALLS){let t=!0;if(_.isWall())return!1;if(r.eachNeighbor(e,i,(e=>{e.isWall()&&(t=!1)})),!t)return!1}return!(s.bounds&&!s.bounds.containsXY(e,i))&&(!(t.matchTile&&!_.hasTile(t.matchTile))&&!(_.hasLayerFlag(l.L_BLOCKS_EFFECTS)&&!t.matchTile&&(s.x!=e||s.y!=i)))}function p(t,i,s={}){let l,r,_,h,n,E,o;const c=s.map,T=s.x,L=s.y;s.bounds;let g=t.spread||0,S=t.decrement||0;if(t.matchTile&&"string"==typeof t.matchTile){const i=t.matchTile,s=Y[i];s||e.utils.ERROR("Failed to find match tile with name:"+i),t.matchTile=s.id}i.fill(0),i[T][L]=h=1;let A=t.radius||0;if(t.flags&a.DFF_SPREAD_CIRCLE){for(A=0,g=g||100,g>=100&&(S=S||100);e.random.chance(g);)g-=S,++A;g=100,S=0}if(A)g=g||100,i.updateCircle(T,L,A,((i,l,a)=>{if(!P(t,l,a,s))return 0;const r=Math.floor(e.utils.distanceBetween(T,L,l,a)),_=g-r*S;return e.random.chance(_)?1:0})),i[T][L]=1;else if(g)if(o=!0,g>=100&&(S=S||100),t.flags&a.DFF_SPREAD_LINE){n=T,E=L;const l=e.utils.DIRS[e.random.number(4)];for(;o;)o=!1,n+=l[0],E+=l[1],i.hasXY(n,E)&&!i[n][E]&&P(t,n,E,s)&&e.random.chance(g)&&(i[n][E]=1,o=!0,g-=S)}else for(S<=0&&(S=g);o&&g>0;){for(o=!1,h++,l=0;l<c.width;l++)for(r=0;r<c.height;r++)if(i[l][r]==h-1)for(_=0;_<4;_++)n=l+e.utils.DIRS[_][0],E=r+e.utils.DIRS[_][1],i.hasXY(n,E)&&!i[n][E]&&P(t,n,E,s)&&e.random.chance(g)&&(i[n][E]=h,o=!0);g-=S}P(t,T,L,s)||(i[T][L]=0)}async function B(t,e,s,r,_){let h,E,o;o=!1;const c=t.flags&a.DFF_BLOCKED_BY_OTHER_LAYERS,T=t.flags&a.DFF_SUPERPRIORITY,L=(s.refreshCell,s.map),g=s.volume||t.volume||0;for(h=0;h<e.width;h++)for(E=0;E<e.height;E++){if(!e[h][E])continue;e[h][E]=0;const S=L.cell(h,E);if(!(S.mechFlags&n.EVENT_PROTECTED)){if(r&&(S.tile(r.depth)===r?r.depth==i.GAS?(e[h][E]=1,S.gasVolume+=g):r.depth==i.LIQUID&&(e[h][E]=1,S.liquidVolume+=g):!(T||S.tile(r.depth).priority<r.priority)||S.obstructsLayer(r.depth)||S.item&&t.flags&a.DFF_BLOCKED_BY_ITEMS||S.actor&&t.flags&a.DFF_BLOCKED_BY_ACTORS||c&&!(S.topmostTile().priority<r.priority)||(e[h][E]=1,L.setTile(h,E,r,g),o=!0)),_&&(T||!S.item)&&!S.hasLayerFlag(l.L_BLOCKS_ITEMS)){e[h][E]=1,S.item&&L.removeItem(S.item);const t=_.clone();L.addItem(h,E,t),o=!0}t.fn&&(s.spawnMap=e,await t.fn(h,E,s)&&(e[h][E]=1,o=!0))}}return o&&(L.changed=!0),o}function V(t,e,i){let s=!1;const l=i&a.DFF_NULL_SURFACE,r=i&a.DFF_NULL_LIQUID,_=i&a.DFF_NULL_GAS;return e.forEach(((e,i,a)=>{e&&(t.clearCellLayers(i,a,!!r,!!l,!!_),s=!0)})),s}function U(t,e){let i,s,l=!1;for(i=0;i<t.width;i++)for(s=0;s<t.height;s++){if(!e[i][s])continue;const a=t.cell(i,s);if(!a.actor)continue;const r=a.actor,_=t.matchingLocNear(i,s,(t=>!r.forbidsCell(t)),{hallways:!0,blockingMap:e});_&&_[0]>=0&&_[1]>=0&&(t.moveActor(_[0],_[1],r),l=!0)}return l}function G(t,e){let i=!1;return e.forEach(((s,l,a)=>{if(!s)return;const r=t.cell(l,a);if(!r.item)return;const _=r.item,h=t.matchingLocNear(l,a,(t=>!_.forbidsCell(t)),{hallways:!0,blockingMap:e});h&&h[0]>=0&&h[1]>=0&&(t.removeItem(_),t.addItem(h[0],h[1],_),i=!0)})),i}var H={__proto__:null,get Flags(){return a},TileEvent:N,make:D,activations:m,install:M,installAll:function(t){Object.entries(t).forEach((([t,e])=>{M(t,e)}))},resetAllMessages:function(){Object.values(m).forEach((t=>{t instanceof N&&(t.messageDisplayed=!1)}))},spawn:y,computeSpawnMap:p,spawnTiles:B,nullifyCells:V,evacuateCreatures:U,evacuateItems:G};class b extends F{constructor(t){super((()=>{if(!t.Extends)return t;if("string"==typeof t.Extends&&(t.Extends=Y[t.Extends],!t.Extends))throw new Error("Unknown tile base - "+t.Extends);const i=t.Extends;return t.ch=e.utils.first(t.ch,i.sprite.ch,-1),t.fg=e.utils.first(t.fg,i.sprite.fg,-1),t.bg=e.utils.first(t.bg,i.sprite.bg,-1),t.depth=e.utils.first(t.depth,i.depth),t.priority=e.utils.first(t.priority,i.priority),t.opacity=e.utils.first(t.opacity,i.sprite.opacity),t})()),this.flags={layer:0,tile:0,tileMech:0},this.activates={},this.flavor=null,this.desc=null,this.article=null,this.dissipate=2e3;let i=t.Extends;i&&(e.utils.assignOmitting(["sprite","depth","priority","activates","flags"],this,i),i.activates&&Object.assign(this.activates,i.activates),Object.assign(this.flags,i.flags)),e.utils.assignOmitting(["Extends","extends","flags","layerFlags","mechFlags","sprite","activates","ch","fg","bg","opacity","light","depth","priority","flags"],this,t),this.name=t.name||(i?i.name:t.id),this.id=t.id,this.flags.tile=e.flag.from(r,this.flags.tile,t.flags),this.flags.layer=e.flag.from(l,this.flags.layer,t.layerFlags||t.flags),this.flags.tileMech=e.flag.from(_,this.flags.tileMech,t.mechFlags||t.flags),t.activates&&Object.entries(t.activates).forEach((([t,e])=>{if(e){const i=D(e);this.activates[t]=i}else delete this.activates[t]}))}hasAllFlags(t){return(this.flags.tile&t)===t}hasAllLayerFlags(t){return(this.flags.layer&t)===t}hasAllMechFlags(t){return(this.flags.tileMech&t)===t}blocksPathing(){return this.flags.layer&l.L_BLOCKS_MOVE||this.flags.tile&r.T_PATHING_BLOCKER}activatesOn(t){return!!this.activates[t]}getName(t){let i={};if(!0===t||!1===t||"string"==typeof t?i.article=t:t&&(i=t),!i.article&&!i.color)return this.name;let s=this.name;if(i.color){let t=i.color;!0===i.color&&(t=this.sprite.fg||"white"),"string"!=typeof t&&(t=e.color.from(t).toString()),s=`Ω${t}Ω${this.name}∆`}if(i.article){s=("string"==typeof i.article?i.article:this.article||"a")+" "+s}return s}getDescription(t={}){return this.getName(t)}}function K(t){return new b(t)}e.make.tile=K;const Y={};function W(...t){let i=t[0],s=t[1],l=t[2];1==arguments.length?(l=t[0],l.Extends=l.Extends||null,i=l.id):2==arguments.length&&(l=s),"string"==typeof s&&(l.Extends=Y[s]||e.utils.ERROR("Unknown base tile: "+s)),l.id=i;const a=K(l);return Y[i]=a,a}var w={__proto__:null,get Flags(){return r},get MechFlags(){return _},Tile:b,make:K,tiles:Y,install:W,installAll:function(t){Object.entries(t).forEach((([t,e])=>{e.id=t,W(t,e)}))}};e.color.install("cursorColor",25,100,150),e.config.cursorPathIntensity=50;class v{constructor(){this.mixer=new e.canvas.Mixer,this.item=null,this.itemQuantity=0,this.actor=null,this.tile=null,this.cellFlags=0,this.cellMechFlags=0,this.layerFlags=0,this.tileFlags=0,this.tileMechFlags=0}clear(){this.mixer.nullify(),this.item=null,this.itemQuantity=0,this.actor=null,this.tile=null,this.cellFlags=0,this.cellMechFlags=0,this.layerFlags=0,this.tileFlags=0,this.tileMechFlags=0}copy(t){const e=this.mixer;Object.assign(this,t),this.mixer=e,this.mixer.copy(t.mixer)}}class x{constructor(){this._tiles=[],this.layers=null,this._actor=null,this._item=null,this.data={},this.flags=h.CELL_DEFAULT,this.mechFlags=0,this.gasVolume=0,this.liquidVolume=0,this.machineNumber=0,this.memory=new v,this.light=[100,100,100],this.oldLight=[100,100,100],this.glowLight=[100,100,100]}copy(t){e.utils.copyObject(this,t)}clear(){for(let t=0;t<this._tiles.length;++t)this._tiles[t]=null;this.layers=null,this._actor=null,this._item=null,this.data={},this.flags=h.CELL_DEFAULT,this.mechFlags=0,this.gasVolume=0,this.liquidVolume=0,this.machineNumber=0,this.memory.clear(),this.light=[100,100,100],this.oldLight=[100,100,100],this.glowLight=[100,100,100]}clearLayers(t=!1,e=!1,i=!1){t&&(this._tiles[1]=null,this.liquidVolume=0),e&&(this._tiles[2]=null),i&&(this._tiles[3]=null,this.gasVolume=0),this.flags|=h.CELL_CHANGED}get ground(){var t;return(null===(t=this._tiles[i.GROUND])||void 0===t?void 0:t.id)||null}get liquid(){var t;return(null===(t=this._tiles[i.LIQUID])||void 0===t?void 0:t.id)||null}get surface(){var t;return(null===(t=this._tiles[i.SURFACE])||void 0===t?void 0:t.id)||null}get gas(){var t;return(null===(t=this._tiles[i.GAS])||void 0===t?void 0:t.id)||null}get groundTile(){return this._tiles[i.GROUND]||Y.NULL}get liquidTile(){return this._tiles[i.LIQUID]||Y.NULL}get surfaceTile(){return this._tiles[i.SURFACE]||Y.NULL}get gasTile(){return this._tiles[i.GAS]||Y.NULL}dump(){if(this.actor)return this.actor.sprite.ch;if(this.item)return this.item.sprite.ch;for(let t=this._tiles.length-1;t>=0;--t){if(!this._tiles[t])continue;const e=this._tiles[t]||Y.NULL;if(e.sprite.ch)return e.sprite.ch}return Y.NULL.sprite.ch}get changed(){return(this.flags&h.CELL_CHANGED)>0}set changed(t){t?this.flags|=h.CELL_CHANGED:this.flags&=~h.CELL_CHANGED}isVisible(){return this.flags&h.VISIBLE}isAnyKindOfVisible(){return this.flags&h.ANY_KIND_OF_VISIBLE}isOrWasAnyKindOfVisible(){return this.flags&h.IS_WAS_ANY_KIND_OF_VISIBLE}isRevealed(t=!1){const e=h.REVEALED|(t?h.MAGIC_MAPPED:0);return(this.flags&e)>0}listInSidebar(){return this.hasTileMechFlag(_.TM_LIST_IN_SIDEBAR,!0)}get needsRedraw(){return(this.flags&h.NEEDS_REDRAW)>0}set needsRedraw(t){t?this.flags|=h.NEEDS_REDRAW:this.flags&=~h.NEEDS_REDRAW}hasVisibleLight(){return L(this.light)>e.config.light.INTENSITY_DARK}isDark(t){const i=t?L(t):e.config.light.INTENSITY_DARK;return L(this.light)<=i}get lightChanged(){return(this.flags&h.LIGHT_CHANGED)>0}set lightChanged(t){t?this.flags|=h.LIGHT_CHANGED:this.flags&=~h.LIGHT_CHANGED}tile(t=i.GROUND){return this._tiles[t]||Y.NULL}*tiles(){for(let t of this._tiles)t&&(yield t)}layerFlags(t=!1){if(t&&!this.isVisible())return this.memory.layerFlags;let e=0;for(let t of this.tiles())e|=t.flags.layer;return e}tileFlags(t=!1){if(t&&!this.isVisible())return this.memory.tileFlags;let e=0;for(let t of this.tiles())e|=t.flags.tile;return e}tileMechFlags(t=!1){if(t&&!this.isVisible())return this.memory.tileMechFlags;let e=0;for(let t of this.tiles())e|=t.flags.tileMech;return e}hasLayerFlag(t,e=!1){return!!(t&this.layerFlags(e))}hasAllLayerFlags(t,e=!1){return(t&this.layerFlags(e))===t}hasTileFlag(t,e=!1){return!!(t&this.tileFlags(e))}hasAllTileFlags(t,e=!1){return(t&this.tileFlags(e))===t}hasTileMechFlag(t,e=!1){return!!(t&this.tileMechFlags(e))}hasAllTileMechFlags(t,e=!1){return(t&this.tileMechFlags(e))===t}setFlags(t=0,e=0){this.flags|=t,this.mechFlags|=e}clearFlags(t=0,e=0){this.flags&=~t,this.mechFlags&=~e}hasFlag(t,e=!1){return(t&(e&&!this.isAnyKindOfVisible()?this.memory.cellFlags:this.flags))>0}hasMechFlag(t,e=!1){return(t&(e&&!this.isAnyKindOfVisible()?this.memory.cellMechFlags:this.mechFlags))>0}hasTile(t){let e;return e=t instanceof b?t.id:t,this._tiles.some((t=>t&&t.id===e))}topmostTile(t=!1){let e=Y.NULL,s=-1e4;for(let l=i.GROUND;l<=(t?i.LIQUID:i.GAS);++l){const t=this._tiles[l];t&&(t.priority>s&&(e=t,s=t.priority))}return e}tileWithFlag(t){for(let e of this.tiles())if(e.flags.tile&t)return e;return null}tileWithMechFlag(t){for(let e of this.tiles())if(e.flags.tileMech&t)return e;return null}tileDesc(){return this.topmostTile().desc}tileFlavor(){return this.topmostTile().flavor}getName(t={}){return this.topmostTile().getName(t)}isClear(){return null==this.ground}isEmpty(){return!(this._actor||this._item)}isMoveableNow(t=!1){return 0==((t&&!this.isAnyKindOfVisible()?this.memory.layerFlags:this.layerFlags(!1))&l.L_BLOCKS_MOVE)}isWalkableNow(t=!1){const e=t&&!this.isAnyKindOfVisible();if((e?this.memory.layerFlags:this.layerFlags(!1))&l.L_BLOCKS_MOVE)return!1;const i=e?this.memory.tileFlags:this.tileFlags();return!(i&r.T_IS_DEEP_LIQUID)||(i&r.T_BRIDGE)>0}canBeWalked(t=!1){if(this.isWalkableNow(t))return!0;return((t&&!this.isAnyKindOfVisible()?this.memory.layerFlags:this.layerFlags(!1))&l.L_SECRETLY_PASSABLE)>0}isWall(t=!1){return((t&&!this.isAnyKindOfVisible()?this.memory.layerFlags:this.layerFlags())&l.L_IS_WALL)===l.L_IS_WALL}isObstruction(t=!1){return!!((t&&!this.isAnyKindOfVisible()?this.memory.layerFlags:this.layerFlags())&l.L_BLOCKS_DIAGONAL)}isDoorway(t=!1){let e=t&&!this.isAnyKindOfVisible()?this.memory.layerFlags:this.layerFlags();return(e&l.L_BLOCKS_VISION)>0&&0==(e&l.L_BLOCKS_MOVE)}isSecretDoorway(t=!1){if(t)return!1;return(this.layerFlags(t)&l.L_SECRETLY_PASSABLE)>0}blocksPathing(t=!1){const e=t&&!this.isAnyKindOfVisible();if(!this.isWalkableNow(t))return!0;return!!((e?this.memory.tileFlags:this.tileFlags())&r.T_PATHING_BLOCKER)}blocksVision(){return!!(this.layerFlags()&l.L_BLOCKS_VISION)}isLiquid(t=!1){return!!((t&&!this.isAnyKindOfVisible()?this.memory.tileFlags:this.tileFlags())&r.T_IS_DEEP_LIQUID)}hasGas(t=!1){return!!((t&&!this.isAnyKindOfVisible()?this.memory.tileFlags:this.tileFlags())&r.T_GAS)}markRevealed(){return this.flags&=~h.STABLE_MEMORY,!(this.flags&h.REVEALED)&&(this.flags|=h.REVEALED,!this.isWall())}obstructsLayer(t){return t===i.SURFACE&&this.hasLayerFlag(l.L_BLOCKS_SURFACE)}setTile(t=null,s=0,a){let _;if(a=a||e.data.map,null===t?(_=Y.NULL,t=null):"string"==typeof t?_=Y[t]:t instanceof b&&(_=t,t=_.id),!_)return e.utils.ERROR("Unknown tile - "+t);const o=this._tiles[_.depth]||Y.NULL,c=o===Y.NULL?null:o.id;o.blocksPathing()!=_.blocksPathing()&&(e.data.staleLoopMap=!0),_.flags.tile&r.T_IS_FIRE&&!(o.flags.tile&r.T_IS_FIRE)&&(this.mechFlags|=n.CAUGHT_FIRE_THIS_TURN);const T=_.flags.layer&l.L_BLOCKS_VISION,L=o.flags.layer&l.L_BLOCKS_VISION;return a&&this.isAnyKindOfVisible()&&T!=L&&a.setFlag(E.MAP_FOV_CHANGED),null!==c&&this.removeLayer(o),this._tiles[_.depth]=null===t?null:_,null!==t&&this.addLayer(_),_.depth==i.LIQUID?(this.liquidVolume=s+(t==c?this.liquidVolume:0),a&&a.clearFlag(E.MAP_NO_LIQUID)):_.depth==i.GAS&&(this.gasVolume=s+(t==c?this.gasVolume:0),a&&a.clearFlag(E.MAP_NO_GAS)),_.depth>0&&!this._tiles[0]&&(this._tiles[0]=Y.FLOOR),this.flags|=h.CELL_CHANGED,a&&o.light!==_.light&&a.clearFlag(E.MAP_STABLE_GLOW_LIGHTS|E.MAP_STABLE_LIGHTS),!0}clearLayer(t){"string"==typeof t&&(t=C[t]);const e=this._tiles[t];e&&(this.flags|=h.CELL_CHANGED,this.removeLayer(e)),this._tiles[t]=null,t==i.LIQUID?this.liquidVolume=0:t==i.GAS&&(this.gasVolume=0)}clearLayersExcept(t=i.GROUND,e){const s=e?Y[e]:this.groundTile;for(let e=0;e<this._tiles.length;e++)e!=t&&e!=i.GAS&&(e===i.GROUND?s!==this.groundTile&&this.setTile(s):this.clearLayer(e));this.flags|=h.CELL_CHANGED}clearLayersWithFlags(t,e=0){for(let i=0;i<this._tiles.length;++i){const s=this._tiles[i];s&&(t&&e?s.flags.tile&t&&s.flags.tileMech&e&&this.clearLayer(i):t?s.flags.tile&t&&this.clearLayer(i):e&&s.flags.tileMech&e&&this.clearLayer(i))}}async activate(t,i={}){i.cell=this;let s=!1;for(let l of this.tiles()){if(!l.activates)continue;const a=l.activates[t];if(a){if(a.chance&&!e.random.chance(a.chance,1e4))continue;if(i.tile=l,s=await y(a,i)||s,s)break}}return s}activatesOn(t){for(let e of this.tiles())if(e.activatesOn(t))return!0;return!1}get item(){return this._item}set item(t){this.item&&this.removeLayer(this.item),this._item=t,t?(this.flags|=h.HAS_ITEM,this.addLayer(t)):this.flags&=~h.HAS_ITEM}get actor(){return this._actor}set actor(t){this.actor&&this.removeLayer(this.actor),this._actor=t,t?(this.flags|=h.HAS_ACTOR,this.addLayer(t)):this.flags&=~h.HAS_ACTOR}addLayer(t){if(!t)return;this.flags|=h.CELL_CHANGED;let e=this.layers;if(!e||e.layer.depth>t.depth||e.layer.depth==t.depth&&e.layer.priority>t.priority)return void(this.layers={layer:t,next:e});for(;e.next&&(e.layer.depth<t.depth||e.layer.depth==t.depth&&e.layer.priority<=t.priority);)e=e.next;const i={layer:t,next:e.next};e.next=i}removeLayer(t){if(!t)return!1;if(!this.layers)return!1;if(this.flags|=h.CELL_CHANGED,this.layers&&this.layers.layer===t)return this.layers=this.layers.next,!0;let e=this.layers,i=this.layers.next;for(;i;){if(i.layer===t)return e.next=i.next,!0;e=i,i=i.next}return!1}storeMemory(){const t=this.memory;t.tileFlags=this.tileFlags(),t.tileMechFlags=this.tileMechFlags(),t.layerFlags=this.layerFlags(),t.cellFlags=this.flags,t.cellMechFlags=this.mechFlags,t.tile=this.topmostTile(),this.item?(t.item=this.item,t.itemQuantity=this.item.quantity):(t.item=null,t.itemQuantity=0),t.actor=this.actor,Q(this,t.mixer),this.actor&&this.isOrWasAnyKindOfVisible()&&(this.actor.rememberedInCell&&this.actor.rememberedInCell!==this&&(this.actor.rememberedInCell.storeMemory(),this.actor.rememberedInCell.flags|=h.NEEDS_REDRAW),this.actor.rememberedInCell=this)}}function k(t){const e=new x;return t&&e.setTile(t),e}function Q(t,s){const l=t.memory.mixer;l.blackOut();let a=t.tileMechFlags()&_.TM_VISUALLY_DISTINCT,r=t.layers;for(;r;){const s=r.layer;let a=s.sprite.opacity||100;s.depth==i.LIQUID?a=e.utils.clamp(t.liquidVolume||0,20,100):s.depth==i.GAS&&(a=e.utils.clamp(t.gasVolume||0,20,100)),l.drawSprite(s.sprite,a),r=r.next}return l.fg.multiply(t.light),l.bg.multiply(t.light),l.bake(!t.isAnyKindOfVisible()),a&&e.color.separate(l.fg,l.bg),s.drawSprite(l),!0}e.make.cell=k;var q={__proto__:null,get Flags(){return h},get MechFlags(){return n},CellMemory:v,Cell:x,make:k,getAppearance:Q};e.utils.setDefaults(e.config,{"map.deepestLevel":99});class X{constructor(t,i,s={}){this.locations={},this.config={},this._actors=null,this._items=null,this.flags=0,this.ambientLight=null,this.lights=null,this.events={},this._width=t,this._height=i,this.cells=e.grid.make(t,i,(()=>new x)),this.locations=s.locations||{},this.config=Object.assign({},s),this.config.tick=this.config.tick||100,this._actors=null,this._items=null,this.flags=e.flag.from(E,E.MAP_DEFAULT,s.flags),this.ambientLight=null;const l=s.ambient||s.ambientLight||s.light;l&&(this.ambientLight=e.color.make(l)),this.lights=null,this.id=s.id,this.events=s.events||{}}get width(){return this._width}get height(){return this._height}async start(){}clear(){this.cells.forEach((t=>t.clear())),this.changed=!0}dump(t){this.cells.dump(t||(t=>t.dump()))}cell(t,e){return this.cells[t][e]}eachCell(t){this.cells.forEach(((e,i,s)=>t(e,i,s,this)))}forEach(t){this.cells.forEach(((e,i,s)=>t(e,i,s,this)))}forRect(t,e,i,s,l){this.cells.forRect(t,e,i,s,((t,e,i)=>l(t,e,i,this)))}eachNeighbor(t,e,i,s=!1){this.cells.eachNeighbor(t,e,((t,e,s)=>i(t,e,s,this)),s)}count(t){let e=0;return this.forEach(((i,s,l,a)=>{t(i,s,l,a)&&++e})),e}hasXY(t,e){return this.cells.hasXY(t,e)}isBoundaryXY(t,e){return this.cells.isBoundaryXY(t,e)}get changed(){return(this.flags&E.MAP_CHANGED)>0}set changed(t){!0===t?this.flags|=E.MAP_CHANGED:!1===t&&(this.flags&=~E.MAP_CHANGED)}hasCellFlag(t,e,i){return this.cell(t,e).flags&i}hasCellMechFlag(t,e,i){return this.cell(t,e).mechFlags&i}hasLayerFlag(t,e,i){return this.cell(t,e).hasLayerFlag(i)}hasTileFlag(t,e,i){return this.cell(t,e).hasTileFlag(i)}hasTileMechFlag(t,e,i){return this.cell(t,e).hasTileMechFlag(i)}redrawCell(t){t.needsRedraw=!0,this.flags|=E.MAP_CHANGED}redrawXY(t,e){const i=this.cell(t,e);this.redrawCell(i)}redrawAll(){this.forEach((t=>{t.needsRedraw=!0})),this.changed=!0}drawInto(t,i={}){const s=new e.canvas.Mixer;for(let e=0;e<t.width;++e)for(let i=0;i<t.height;++i){$(this,e,i,s);const l="number"==typeof s.ch?s.ch:t.toGlyph(s.ch);t.draw(e,i,l,s.fg.toInt(),s.bg.toInt())}}revealAll(){this.forEach((t=>{t.markRevealed(),t.storeMemory()})),e.data.player&&e.data.player.invalidateCostMap()}markRevealed(t,i){this.cell(t,i).markRevealed()&&e.data.player&&e.data.player.invalidateCostMap()}isVisible(t,e){return this.cell(t,e).isVisible()}isAnyKindOfVisible(t,e){return this.cell(t,e).isAnyKindOfVisible()}isOrWasAnyKindOfVisible(t,e){return this.cell(t,e).isOrWasAnyKindOfVisible()}get lightChanged(){return 0==(this.flags&E.MAP_STABLE_LIGHTS)}set lightChanged(t){t?this.flags&=~E.MAP_STABLE_LIGHTS:this.flags|=E.MAP_STABLE_LIGHTS}get glowLightChanged(){return 0==(this.flags&E.MAP_STABLE_GLOW_LIGHTS)}set glowLightChanged(t){t?this.flags&=~(E.MAP_STABLE_GLOW_LIGHTS|E.MAP_STABLE_LIGHTS):this.flags|=E.MAP_STABLE_GLOW_LIGHTS}setFlag(t){this.flags|=t,this.changed=!0}setFlags(t=0,e=0,i=0){t&&(this.flags|=t),(e||i)&&this.forEach((t=>t.setFlags(e,i))),this.changed=!0}clearFlag(t){this.flags&=~t,this.changed=!0}clearFlags(t=0,e=0,i=0){t&&(this.flags&=~t),(e||i)&&this.forEach((t=>t.clearFlags(e,i))),this.changed=!0}setCellFlags(t,e,i=0,s=0){this.cell(t,e).setFlags(i,s),this.flags|=E.MAP_CHANGED}clearCellFlags(t,e,i=0,s=0){this.cell(t,e).clearFlags(i,s),this.changed=!0}hasTile(t,e,i){return this.cells[t][e].hasTile(i)}layerFlags(t,e,i=!1){return this.cells[t][e].layerFlags(i)}tileFlags(t,e,i=!1){return this.cells[t][e].tileFlags(i)}tileMechFlags(t,e,i=!1){return this.cells[t][e].tileMechFlags(i)}tileWithFlag(t,e,i=0){return this.cells[t][e].tileWithFlag(i)}tileWithMechFlag(t,e,i=0){return this.cells[t][e].tileWithMechFlag(i)}hasKnownTileFlag(t,e,i=0){return this.cells[t][e].memory.tileFlags&i}isClear(t,e){return this.cells[t][e].isClear()}isEmpty(t,e){return this.cells[t][e].isEmpty()}isObstruction(t,e,i=!1){return this.cells[t][e].isObstruction(i)}isDoorway(t,e,i=!1){return this.cells[t][e].isDoorway(i)}isSecretDoorway(t,e,i=!1){return this.cells[t][e].isSecretDoorway(i)}isLiquid(t,e,i=!1){return this.cells[t][e].isLiquid(i)}hasGas(t,e,i=!1){return this.cells[t][e].hasGas(i)}blocksPathing(t,e,i=!1){return this.cells[t][e].blocksPathing(i)}blocksVision(t,e){return this.cells[t][e].blocksVision()}isMoveableNow(t,e,i=!1){return this.cells[t][e].isMoveableNow(i)}isWalkableNow(t,e,i=!1){return this.cells[t][e].isWalkableNow(i)}canBeWalked(t,e,i=!1){return this.cells[t][e].canBeWalked(i)}topmostTile(t,e,i=!1){return this.cells[t][e].topmostTile(i)}tileFlavor(t,e){return this.cells[t][e].tileFlavor()}setTile(t,e,i,s=0){return this.cell(t,e).setTile(i,s,this)}clearCell(t,e){this.cell(t,e).clear()}clearCellLayersWithFlags(t,e,i,s=0){this.cell(t,e).clearLayersWithFlags(i,s)}clearCellLayers(t,e,i=!0,s=!0,l=!0){return this.changed=!0,this.cell(t,e).clearLayers(i,s,l)}fill(t,e){let i,s;for(void 0===e&&(e=t),i=0;i<this.width;++i)for(s=0;s<this.height;++s)this.isBoundaryXY(i,s)?this.setTile(i,s,e):this.setTile(i,s,t)}neighborCount(t,e,i,s=!1){let l=0;return this.eachNeighbor(t,e,((...t)=>{i(...t)&&++l}),s),l}walkableArcCount(t,e){return this.hasXY(t,e)?this.cells.arcCount(t,e,(t=>t.isWalkableNow())):-1}diagonalBlocked(t,e,i,s,l=!1){return t!=i&&e!=s&&(!!this.isObstruction(t,s,l)||!!this.isObstruction(i,e,l))}fillCostGrid(t,i){i=i||(t=>t.isWalkableNow()?1:e.path.OBSTRUCTION),this.cells.forEach(((s,l,a)=>{s.isClear()?t[l][a]=e.path.OBSTRUCTION:t[l][a]=i(s,l,a,this)}))}matchingNeighbor(t,i,s,l=!1){const a=l?4:8;for(let l=0;l<a;++l){const a=e.utils.DIRS[l],r=t+a[0],_=i+a[1];if(this.hasXY(r,_)&&s(this.cells[r][_],r,_,this))return[r,_]}return[-1,-1]}matchingLocNear(t,i,...s){let l,a,r,_=s[0],h=s[1]||{};const n=s[0];"function"!=typeof n&&(h=n||s[1],_=h.match||e.utils.TRUE);const E=h.hallways||!1,o=h.blockingMap||null,c=!1===h.liquids,T=h.deterministic||!1,L=[];for(r=0;r<Math.max(this.width,this.height)&&!L.length;r++)for(l=t-r;l<=t+r;l++)for(a=i-r;a<=i+r;a++){if(!this.hasXY(l,a))continue;const s=this.cell(l,a);Math.ceil(e.utils.distanceBetween(t,i,l,a))!=r||o&&o[l][a]||!_(s,l,a,this)||c&&s.liquid||!(E||this.walkableArcCount(l,a)<2)||L.push([l,a])}if(0==L.length)return[-1,-1];let g=0;return g=T?Math.floor(L.length/2):e.random.number(L.length),L[g]}randomMatchingLoc(t={}){let i,s,l;"function"==typeof t&&(t={match:t});const a=e.random.sequence(this.width*this.height),r=t.hallways||!1,_=t.blockingMap||null,h=!1===t.liquids,n=t.match||e.utils.TRUE,E=t.forbidCellFlags||0,o=t.forbidTileFlags||0,c=t.forbidTileMechFlags||0,T=t.tile||null;let L=!1,g=0;for(;!L&&g<a.length;){const t=a[g];i=t%this.width,s=Math.floor(t/this.width),l=this.cell(i,s),_&&_[i][s]||T&&!l.hasTile(T)||h&&l.liquid||E&&l.flags&E||o&&l.hasTileFlag(o)||c&&l.hasTileMechFlag(c)||!(r||this.walkableArcCount(i,s)<2)||!n(l,i,s,this)||(L=!0),++g}return L?[i,s]:[-1,-1]}hasVisibleLight(t,e){return this.cell(t,e).hasVisibleLight()}addStaticLight(t,e,i){const s={x:t,y:e,light:i,next:this.lights};return this.lights=s,this.glowLightChanged=!0,s}removeStaticLight(t,e,i){let s=this.lights;if(!s)return;function l(s){return s.x==t&&s.y==e&&(!i||i===s.light)}for(this.glowLightChanged=!0;s&&l(s);)s=this.lights=s.next;if(!s)return;let a=s.next;for(;a;)l(a)?s.next=a.next:s=a,a=a.next}eachStaticLight(t){e.utils.eachChain(this.lights,(e=>t(e.light,e.x,e.y))),this.eachCell(((e,i,s)=>{for(let l of e.tiles())l.light&&t(l.light,i,s)}))}eachDynamicLight(t){e.utils.eachChain(this._actors,(e=>{e.light&&t(e.light,e.x,e.y)}))}addFx(t,e,i){if(!this.hasXY(t,e))return!1;const s=this.cell(t,e);return s.addLayer(i),i.x=t,i.y=e,this.redrawCell(s),!0}moveFx(t,e,i){if(!this.hasXY(t,e))return!1;const s=this.cell(t,e),l=this.cell(i.x,i.y);return l.removeLayer(i),this.redrawCell(l),s.addLayer(i),this.redrawCell(s),i.x=t,i.y=e,!0}removeFx(t){const e=this.cell(t.x,t.y);return e.removeLayer(t),this.redrawCell(e),this.flags|=E.MAP_CHANGED,!0}actorAt(t,e){if(!this.hasXY(t,e))return null;return this.cell(t,e).actor}addActor(t,i,s){if(!this.hasXY(t,i))return!1;const l=this.cell(t,i);if(l.actor)return!1;l.actor=s,s.next=this._actors,this._actors=s;const a=s===e.data.player?h.HAS_PLAYER:h.HAS_MONSTER;return l.flags|=a,s.light&&(this.lightChanged=!0),(s.isPlayer()||l.isAnyKindOfVisible()&&s.blocksVision())&&(this.flags|=E.MAP_FOV_CHANGED),s.x=t,s.y=i,this.redrawCell(l),!0}addActorNear(t,e,i){const s=this.matchingLocNear(t,e,(t=>!i.avoidsCell(t)));return!(!s||s[0]<0)&&this.addActor(s[0],s[1],i)}moveActor(t,e,i){return!!this.hasXY(t,e)&&(this.removeActor(i),this.addActor(t,e,i)?(i.light&&(this.lightChanged=!0),!0):(this.addActor(i.x,i.y,i),!1))}removeActor(t){if(!this.hasXY(t.x,t.y))return!1;const i=this.cell(t.x,t.y);return i.actor===t&&(i.actor=null,e.utils.removeFromChain(this,"actors",t),t.light&&(this.lightChanged=!0),(t.isPlayer()||i.isAnyKindOfVisible()&&t.blocksVision())&&(this.flags|=E.MAP_FOV_CHANGED),this.redrawCell(i),!0)}deleteActorAt(t,e){const i=this.actorAt(t,e);return!!i&&(this.removeActor(i),i.delete(),!0)}itemAt(t,e){return this.cell(t,e).item}addItem(t,i,s){if(!this.hasXY(t,i))return!1;const l=this.cell(t,i);return!l.item&&(s.x=t,s.y=i,l.item=s,s.next=this._items,this._items=s,s.light&&(this.lightChanged=!0),this.redrawCell(l),(s.isDetected()||e.config.D_ITEM_OMNISCIENCE)&&(l.flags|=h.ITEM_DETECTED),!0)}addItemNear(t,e,i){const s=this.matchingLocNear(t,e,(t=>!i.forbidsCell(t)));return!(!s||s[0]<0)&&this.addItem(s[0],s[1],i)}removeItem(t){const i=t.x,s=t.y;if(!this.hasXY(i,s))return!1;const l=this.cell(i,s);return l.item===t&&(l.item=null,e.utils.removeFromChain(this,"items",t),t.light&&(this.lightChanged=!0),l.flags&=~(h.HAS_ITEM|h.ITEM_DETECTED),this.redrawCell(l),!0)}gridDisruptsWalkability(t,i={}){const s=e.grid.alloc(this.width,this.height);let l=!1;const a=i.gridOffsetX||0,_=i.gridOffsetY||0,h=i.bounds||null;this.cells.forEach(((e,i,n)=>{if(h&&!h.contains(i,n))return;const E=i+a,o=n+_;if(!e.isClear())if(e.hasTileFlag(r.T_HAS_STAIRS))t.get(E,o)?l=!0:s[i][n]=1;else if(e.canBeWalked()){if(t.get(E,o))return;s[i][n]=1}}));let n=!0;for(let t=0;t<s.width&&!l;++t)for(let e=0;e<s.height&&!l;++e)1==s[t][e]&&(n?(s.floodFill(t,e,1,2),n=!1):l=!0);return e.grid.free(s),l}calcFov(t,i,s,a,r=0,_=l.L_BLOCKS_VISION){a=a||this.width+this.height,t.fill(0);const h=this;return new e.fov.FOV({isBlocked:(e,i)=>!(t.hasXY(e,i)&&!h.hasCellFlag(e,i,r)&&!h.hasLayerFlag(e,i,_)),calcRadius:(t,e)=>Math.sqrt(t**2+e**2),setVisible(e,i){t[e][i]=1},hasXY:(e,i)=>t.hasXY(e,i)}).calculate(i,s,a)}losFromTo(t,i){if(e.utils.equalsXY(t,i))return!0;const s=e.utils.getLine(t.x,t.y,i.x,i.y);return!!s.length&&!s.some((t=>this.blocksVision(t[0],t[1])))}storeMemory(t,e){this.cell(t,e).storeMemory()}storeMemories(){let t,e;for(t=0;t<this.width;++t)for(e=0;e<this.height;++e){const i=this.cell(t,e);i.flags&h.ANY_KIND_OF_VISIBLE&&this.storeMemory(t,e),i.flags&=h.PERMANENT_CELL_FLAGS,i.mechFlags&=n.PERMANENT_MECH_FLAGS}}async tick(){this.resetCellEvents();for(let t=0;t<this.width;++t)for(let e=0;e<this.height;++e){const i=this.cells[t][e];await i.activate("tick",{map:this,x:t,y:e,cell:i,safe:!0})}J(this),z(this)}resetCellEvents(){this.forEach((t=>t.mechFlags&=~(n.EVENT_FIRED_THIS_TURN|n.EVENT_PROTECTED)))}}function j(t,i,s={},l){"string"==typeof s&&(s={tile:s},l&&(s.wall=l));const a=new X(t,i,s),r=s.tile||s.floor||s.floorTile,_=s.boundary||s.wall||s.wallTile;return r&&a.fill(r,_),e.data.map||(e.data.map=a),a}function $(t,i,s,l){if(l.blackOut(),!t.hasXY(i,s))return;const a=t.cell(i,s);a.isAnyKindOfVisible()&&a.flags&(h.CELL_CHANGED|h.NEEDS_REDRAW)?Q(a,l):l.drawSprite(a.memory.mixer),a.isVisible()||(a.isRevealed()?a.isAnyKindOfVisible()||(l.bg.mix(e.colors.black,30),l.fg.mix(e.colors.black,30)):a.isAnyKindOfVisible()||l.blackOut());let r=!1;if(a.flags&(h.IS_CURSOR|h.IS_IN_PATH)){const t=a.flags&h.IS_CURSOR?e.colors.cursor:e.colors.path;a.hasTileMechFlag(_.TM_INVERT_WHEN_HIGHLIGHTED)?e.color.swap(l.fg,l.bg):l.bg.mix(t,e.config.cursorPathIntensity||20),r=!0}r&&e.color.separate(l.fg,l.bg)}function z(t){if(t.flags&E.MAP_NO_GAS)return;const s=e.grid.alloc(t.width,t.height);t.forEach(((i,a,r)=>{if(i.hasLayerFlag(l.L_BLOCKS_GAS))return;let _=i.gasTile,h=i.gasVolume,n=i.gasVolume||0,E=1;if(t.eachNeighbor(a,r,((t,e,i)=>{t.hasLayerFlag(l.L_BLOCKS_GAS)||(++E,n+=t.gasVolume,t.gasVolume>h&&(_=t.gasTile,h=t.gasVolume))})),n<=0)return;const o=Math.floor(n/E);i.gasTile!=_&&i.setTile(_,0,t),s[a][r]+=o;const c=n-E*Math.floor(n/E);c&&e.random.number(E)<c&&(s[a][r]+=1),s[a][r]>0&&_.dissipate&&(_.dissipate>1e4?(s[a][r]-=Math.floor(_.dissipate/1e4),e.random.chance(_.dissipate%1e4,1e4)&&(s[a][r]-=1)):e.random.chance(_.dissipate,1e4)&&(s[a][r]-=1))}));let a=!1;s.forEach(((e,s,l)=>{const r=t.cell(s,l);e>0?(a=!0,r.gas&&r.gasVolume!==e&&(r.gasVolume=e,t.redrawCell(r))):r.gas&&(r.clearLayer(i.GAS),t.redrawCell(r))})),a?t.flags&=~E.MAP_NO_GAS:t.flags|=E.MAP_NO_GAS,t.changed=!0,e.grid.free(s)}function J(t){if(t.flags&E.MAP_NO_LIQUID)return;const s=e.grid.alloc(t.width,t.height);t.forEach(((i,a,r)=>{if(i.hasLayerFlag(l.L_BLOCKS_LIQUID))return;let _=i.liquidTile,h=i.liquidVolume,n=i.liquidVolume||0,E=1;if(t.eachNeighbor(a,r,((t,e,i)=>{t.hasLayerFlag(l.L_BLOCKS_LIQUID)||(++E,n+=t.liquidVolume,t.liquidVolume>h&&(_=t.liquidTile,h=t.liquidVolume))})),n<=0)return;const o=Math.floor(n/E);i.liquidTile!=_&&i.setTile(_,0,t),s[a][r]+=o;const c=n-E*Math.floor(n/E);c&&e.random.number(E)<c&&(s[a][r]+=1),s[a][r]>0&&_.dissipate&&(_.dissipate>1e4?(s[a][r]-=Math.floor(_.dissipate/1e4),e.random.chance(_.dissipate%1e4,1e4)&&(s[a][r]-=1)):e.random.chance(_.dissipate,1e4)&&(s[a][r]-=1))}));let a=!1;s.forEach(((e,s,l)=>{const r=t.cell(s,l);e>0?(a=!0,r.liquid&&r.liquidVolume!==e&&(r.liquidVolume=e,t.redrawCell(r))):r.liquid&&(r.clearLayer(i.LIQUID),t.redrawCell(r))})),a?t.flags&=~E.MAP_NO_LIQUID:t.flags|=E.MAP_NO_LIQUID,t.changed=!0,e.grid.free(s)}e.make.map=j,e.colors.cursor||e.color.install("cursor",e.colors.yellow),e.colors.path||e.color.install("path",e.colors.gold);var Z={__proto__:null,get Flags(){return E},Map:X,make:j,getCellAppearance:$,addText:function(t,e,s,l,a,r,_){for(let h of l){const l=d({ch:h,fg:a,bg:r,depth:_||i.GROUND,priority:200});t.cell(e++,s).addLayer(l)}},updateGas:z,updateLiquid:J};W("NULL",{ch:"∅",fg:"white",bg:"black",flags:"T_OBSTRUCTS_PASSABILITY",name:"eerie nothingness",article:"an",priority:0}),W("FLOOR",{ch:"·",fg:[30,30,30,20,0,0,0],bg:[2,2,10,0,2,2,0],priority:10,article:"the"}),W("DOOR",{ch:"+",fg:[100,40,40],bg:[30,60,60],priority:30,flags:"T_IS_DOOR, L_BLOCKS_EFFECTS, L_BLOCKS_ITEMS, L_BLOCKS_VISION, TM_VISUALLY_DISTINCT",article:"a",activates:{enter:{tile:"DOOR_OPEN"},open:{tile:"DOOR_OPEN_ALWAYS"}}}),W("DOOR_OPEN","DOOR",{ch:"'",fg:[100,40,40],bg:[30,60,60],priority:40,flags:"!L_BLOCKS_ITEMS, !L_BLOCKS_VISION",name:"open door",article:"an",activates:{tick:{tile:"DOOR",flags:"DFF_SUPERPRIORITY, DFF_ONLY_IF_EMPTY"},enter:null,open:null,close:{tile:"DOOR",flags:"DFF_SUPERPRIORITY, DFF_ONLY_IF_EMPTY"}}}),W("DOOR_OPEN_ALWAYS","DOOR_OPEN",{activates:{tick:null,close:{tile:"DOOR",flags:"DFF_SUPERPRIORITY, DFF_ONLY_IF_EMPTY"}}}),W("BRIDGE",{ch:"=",fg:[100,40,40],priority:40,depth:"SURFACE",flags:"T_BRIDGE, TM_VISUALLY_DISTINCT",article:"a"}),W("UP_STAIRS",{ch:"<",fg:[100,50,50],bg:[40,20,20],priority:200,flags:"T_UP_STAIRS, L_BLOCKED_BY_STAIRS, TM_VISUALLY_DISTINCT, TM_LIST_IN_SIDEBAR",name:"upward staircase",article:"an"}),W("DOWN_STAIRS",{ch:">",fg:[100,50,50],bg:[40,20,20],priority:200,flags:"T_DOWN_STAIRS, L_BLOCKED_BY_STAIRS, TM_VISUALLY_DISTINCT, TM_LIST_IN_SIDEBAR",name:"downward staircase",article:"a"}),W("WALL",{ch:"#",fg:[7,7,7,0,3,3,3],bg:[40,40,40,10,10,0,5],priority:100,flags:"L_BLOCKS_EVERYTHING",article:"a",name:"stone wall",desc:"A wall made from rough cut stone.",flavor:"a rough stone wall"}),W("LAKE",{ch:"~",fg:[5,8,20,10,0,4,15,!0],bg:[10,15,41,6,5,5,5,!0],priority:50,flags:"T_DEEP_WATER",name:"deep water",article:"the"}),t.cell=q,t.layer=C,t.light=R,t.lights=S,t.map=Z,t.tile=w,t.tileEvent=H,t.tiles=Y,Object.defineProperty(t,"__esModule",{value:!0})}));
//# sourceMappingURL=gw-map.min.js.map
