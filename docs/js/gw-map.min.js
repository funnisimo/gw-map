!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("gw-utils")):"function"==typeof define&&define.amd?define(["exports","gw-utils"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).GW=t.GW||{},t.GW)}(this,(function(t,e){"use strict";var i;!function(t){t[t.GROUND=0]="GROUND",t[t.LIQUID=1]="LIQUID",t[t.SURFACE=2]="SURFACE",t[t.GAS=3]="GAS",t[t.ITEM=4]="ITEM",t[t.ACTOR=5]="ACTOR",t[t.PLAYER=6]="PLAYER",t[t.FX=7]="FX",t[t.UI=8]="UI"}(i||(i={}));const s=e.flag.fl;var l,_,r,a,T,h;!function(t){t[t.DFF_SUBSEQ_ALWAYS=s(0)]="DFF_SUBSEQ_ALWAYS",t[t.DFF_SUBSEQ_EVERYWHERE=s(1)]="DFF_SUBSEQ_EVERYWHERE",t[t.DFF_TREAT_AS_BLOCKING=s(2)]="DFF_TREAT_AS_BLOCKING",t[t.DFF_PERMIT_BLOCKING=s(3)]="DFF_PERMIT_BLOCKING",t[t.DFF_ACTIVATE_DORMANT_MONSTER=s(4)]="DFF_ACTIVATE_DORMANT_MONSTER",t[t.DFF_BLOCKED_BY_OTHER_LAYERS=s(6)]="DFF_BLOCKED_BY_OTHER_LAYERS",t[t.DFF_SUPERPRIORITY=s(7)]="DFF_SUPERPRIORITY",t[t.DFF_AGGRAVATES_MONSTERS=s(8)]="DFF_AGGRAVATES_MONSTERS",t[t.DFF_RESURRECT_ALLY=s(9)]="DFF_RESURRECT_ALLY",t[t.DFF_EMIT_EVENT=s(10)]="DFF_EMIT_EVENT",t[t.DFF_NO_REDRAW_CELL=s(11)]="DFF_NO_REDRAW_CELL",t[t.DFF_ABORT_IF_BLOCKS_MAP=s(12)]="DFF_ABORT_IF_BLOCKS_MAP",t[t.DFF_BLOCKED_BY_ITEMS=s(13)]="DFF_BLOCKED_BY_ITEMS",t[t.DFF_BLOCKED_BY_ACTORS=s(14)]="DFF_BLOCKED_BY_ACTORS",t[t.DFF_ALWAYS_FIRE=s(15)]="DFF_ALWAYS_FIRE",t[t.DFF_NO_MARK_FIRED=s(16)]="DFF_NO_MARK_FIRED",t[t.DFF_PROTECTED=s(19)]="DFF_PROTECTED",t[t.DFF_SPREAD_CIRCLE=s(20)]="DFF_SPREAD_CIRCLE",t[t.DFF_SPREAD_LINE=s(21)]="DFF_SPREAD_LINE",t[t.DFF_NULL_SURFACE=s(22)]="DFF_NULL_SURFACE",t[t.DFF_NULL_LIQUID=s(23)]="DFF_NULL_LIQUID",t[t.DFF_NULL_GAS=s(24)]="DFF_NULL_GAS",t[t.DFF_EVACUATE_CREATURES=s(25)]="DFF_EVACUATE_CREATURES",t[t.DFF_EVACUATE_ITEMS=s(26)]="DFF_EVACUATE_ITEMS",t[t.DFF_BUILD_IN_WALLS=s(27)]="DFF_BUILD_IN_WALLS",t[t.DFF_MUST_TOUCH_WALLS=s(28)]="DFF_MUST_TOUCH_WALLS",t[t.DFF_NO_TOUCH_WALLS=s(29)]="DFF_NO_TOUCH_WALLS",t[t.DFF_ONLY_IF_EMPTY=t.DFF_BLOCKED_BY_ITEMS|t.DFF_BLOCKED_BY_ACTORS]="DFF_ONLY_IF_EMPTY",t[t.DFF_NULLIFY_CELL=t.DFF_NULL_SURFACE|t.DFF_NULL_LIQUID|t.DFF_NULL_GAS]="DFF_NULLIFY_CELL"}(l||(l={})),function(t){t[t.T_OBSTRUCTS_PASSABILITY=s(0)]="T_OBSTRUCTS_PASSABILITY",t[t.T_OBSTRUCTS_VISION=s(1)]="T_OBSTRUCTS_VISION",t[t.T_OBSTRUCTS_ITEMS=s(2)]="T_OBSTRUCTS_ITEMS",t[t.T_OBSTRUCTS_SURFACE=s(3)]="T_OBSTRUCTS_SURFACE",t[t.T_OBSTRUCTS_GAS=s(4)]="T_OBSTRUCTS_GAS",t[t.T_OBSTRUCTS_LIQUID=s(5)]="T_OBSTRUCTS_LIQUID",t[t.T_OBSTRUCTS_TILE_EFFECTS=s(6)]="T_OBSTRUCTS_TILE_EFFECTS",t[t.T_OBSTRUCTS_DIAGONAL_MOVEMENT=s(7)]="T_OBSTRUCTS_DIAGONAL_MOVEMENT",t[t.T_GAS=s(9)]="T_GAS",t[t.T_BRIDGE=s(10)]="T_BRIDGE",t[t.T_AUTO_DESCENT=s(11)]="T_AUTO_DESCENT",t[t.T_LAVA=s(12)]="T_LAVA",t[t.T_DEEP_WATER=s(13)]="T_DEEP_WATER",t[t.T_SPONTANEOUSLY_IGNITES=s(14)]="T_SPONTANEOUSLY_IGNITES",t[t.T_IS_FLAMMABLE=s(15)]="T_IS_FLAMMABLE",t[t.T_IS_FIRE=s(16)]="T_IS_FIRE",t[t.T_ENTANGLES=s(17)]="T_ENTANGLES",t[t.T_CAUSES_POISON=s(18)]="T_CAUSES_POISON",t[t.T_CAUSES_DAMAGE=s(19)]="T_CAUSES_DAMAGE",t[t.T_CAUSES_NAUSEA=s(20)]="T_CAUSES_NAUSEA",t[t.T_CAUSES_PARALYSIS=s(21)]="T_CAUSES_PARALYSIS",t[t.T_CAUSES_CONFUSION=s(22)]="T_CAUSES_CONFUSION",t[t.T_CAUSES_HEALING=s(23)]="T_CAUSES_HEALING",t[t.T_IS_TRAP=s(24)]="T_IS_TRAP",t[t.T_CAUSES_EXPLOSIVE_DAMAGE=s(25)]="T_CAUSES_EXPLOSIVE_DAMAGE",t[t.T_SACRED=s(26)]="T_SACRED",t[t.T_UP_STAIRS=s(27)]="T_UP_STAIRS",t[t.T_DOWN_STAIRS=s(28)]="T_DOWN_STAIRS",t[t.T_PORTAL=s(29)]="T_PORTAL",t[t.T_IS_DOOR=s(30)]="T_IS_DOOR",t[t.T_HAS_STAIRS=t.T_UP_STAIRS|t.T_DOWN_STAIRS|t.T_PORTAL]="T_HAS_STAIRS",t[t.T_OBSTRUCTS_SCENT=t.T_OBSTRUCTS_PASSABILITY|t.T_OBSTRUCTS_VISION|t.T_AUTO_DESCENT|t.T_LAVA|t.T_DEEP_WATER|t.T_SPONTANEOUSLY_IGNITES|t.T_HAS_STAIRS]="T_OBSTRUCTS_SCENT",t[t.T_PATHING_BLOCKER=t.T_OBSTRUCTS_PASSABILITY|t.T_AUTO_DESCENT|t.T_IS_TRAP|t.T_LAVA|t.T_DEEP_WATER|t.T_IS_FIRE|t.T_SPONTANEOUSLY_IGNITES|t.T_ENTANGLES]="T_PATHING_BLOCKER",t[t.T_DIVIDES_LEVEL=t.T_OBSTRUCTS_PASSABILITY|t.T_AUTO_DESCENT|t.T_IS_TRAP|t.T_LAVA|t.T_DEEP_WATER]="T_DIVIDES_LEVEL",t[t.T_LAKE_PATHING_BLOCKER=t.T_AUTO_DESCENT|t.T_LAVA|t.T_DEEP_WATER|t.T_SPONTANEOUSLY_IGNITES]="T_LAKE_PATHING_BLOCKER",t[t.T_WAYPOINT_BLOCKER=t.T_OBSTRUCTS_PASSABILITY|t.T_AUTO_DESCENT|t.T_IS_TRAP|t.T_LAVA|t.T_DEEP_WATER|t.T_SPONTANEOUSLY_IGNITES]="T_WAYPOINT_BLOCKER",t[t.T_MOVES_ITEMS=t.T_DEEP_WATER|t.T_LAVA]="T_MOVES_ITEMS",t[t.T_CAN_BE_BRIDGED=t.T_AUTO_DESCENT|t.T_LAVA|t.T_DEEP_WATER]="T_CAN_BE_BRIDGED",t[t.T_OBSTRUCTS_EVERYTHING=t.T_OBSTRUCTS_PASSABILITY|t.T_OBSTRUCTS_VISION|t.T_OBSTRUCTS_ITEMS|t.T_OBSTRUCTS_GAS|t.T_OBSTRUCTS_SURFACE|t.T_OBSTRUCTS_LIQUID|t.T_OBSTRUCTS_DIAGONAL_MOVEMENT]="T_OBSTRUCTS_EVERYTHING",t[t.T_HARMFUL_TERRAIN=t.T_CAUSES_POISON|t.T_IS_FIRE|t.T_CAUSES_DAMAGE|t.T_CAUSES_PARALYSIS|t.T_CAUSES_CONFUSION|t.T_CAUSES_EXPLOSIVE_DAMAGE]="T_HARMFUL_TERRAIN",t[t.T_RESPIRATION_IMMUNITIES=t.T_CAUSES_DAMAGE|t.T_CAUSES_CONFUSION|t.T_CAUSES_PARALYSIS|t.T_CAUSES_NAUSEA]="T_RESPIRATION_IMMUNITIES",t[t.T_IS_LIQUID=t.T_LAVA|t.T_AUTO_DESCENT|t.T_DEEP_WATER]="T_IS_LIQUID",t[t.T_STAIR_BLOCKERS=t.T_OBSTRUCTS_ITEMS|t.T_OBSTRUCTS_SURFACE|t.T_OBSTRUCTS_GAS|t.T_OBSTRUCTS_LIQUID|t.T_OBSTRUCTS_TILE_EFFECTS]="T_STAIR_BLOCKERS"}(_||(_={})),function(t){t[t.TM_IS_SECRET=s(0)]="TM_IS_SECRET",t[t.TM_PROMOTES_WITH_KEY=s(1)]="TM_PROMOTES_WITH_KEY",t[t.TM_PROMOTES_WITHOUT_KEY=s(2)]="TM_PROMOTES_WITHOUT_KEY",t[t.TM_PROMOTES_ON_STEP=s(3)]="TM_PROMOTES_ON_STEP",t[t.TM_PROMOTES_ON_ITEM_REMOVE=s(4)]="TM_PROMOTES_ON_ITEM_REMOVE",t[t.TM_PROMOTES_ON_PLAYER_ENTRY=s(5)]="TM_PROMOTES_ON_PLAYER_ENTRY",t[t.TM_PROMOTES_ON_SACRIFICE_ENTRY=s(6)]="TM_PROMOTES_ON_SACRIFICE_ENTRY",t[t.TM_PROMOTES_ON_ELECTRICITY=s(7)]="TM_PROMOTES_ON_ELECTRICITY",t[t.TM_ALLOWS_SUBMERGING=s(8)]="TM_ALLOWS_SUBMERGING",t[t.TM_IS_WIRED=s(9)]="TM_IS_WIRED",t[t.TM_IS_CIRCUIT_BREAKER=s(10)]="TM_IS_CIRCUIT_BREAKER",t[t.TM_EXTINGUISHES_FIRE=s(14)]="TM_EXTINGUISHES_FIRE",t[t.TM_VANISHES_UPON_PROMOTION=s(15)]="TM_VANISHES_UPON_PROMOTION",t[t.TM_REFLECTS_BOLTS=s(16)]="TM_REFLECTS_BOLTS",t[t.TM_STAND_IN_TILE=s(17)]="TM_STAND_IN_TILE",t[t.TM_LIST_IN_SIDEBAR=s(18)]="TM_LIST_IN_SIDEBAR",t[t.TM_VISUALLY_DISTINCT=s(19)]="TM_VISUALLY_DISTINCT",t[t.TM_BRIGHT_MEMORY=s(20)]="TM_BRIGHT_MEMORY",t[t.TM_EXPLOSIVE_PROMOTE=s(21)]="TM_EXPLOSIVE_PROMOTE",t[t.TM_CONNECTS_LEVEL=s(22)]="TM_CONNECTS_LEVEL",t[t.TM_INTERRUPT_EXPLORATION_WHEN_SEEN=s(23)]="TM_INTERRUPT_EXPLORATION_WHEN_SEEN",t[t.TM_INVERT_WHEN_HIGHLIGHTED=s(24)]="TM_INVERT_WHEN_HIGHLIGHTED",t[t.TM_SWAP_ENCHANTS_ACTIVATION=s(25)]="TM_SWAP_ENCHANTS_ACTIVATION",t[t.TM_PROMOTES=t.TM_PROMOTES_WITH_KEY|t.TM_PROMOTES_WITHOUT_KEY|t.TM_PROMOTES_ON_STEP|t.TM_PROMOTES_ON_ITEM_REMOVE|t.TM_PROMOTES_ON_SACRIFICE_ENTRY|t.TM_PROMOTES_ON_ELECTRICITY|t.TM_PROMOTES_ON_PLAYER_ENTRY]="TM_PROMOTES"}(r||(r={})),function(t){t[t.REVEALED=s(0)]="REVEALED",t[t.VISIBLE=s(1)]="VISIBLE",t[t.WAS_VISIBLE=s(2)]="WAS_VISIBLE",t[t.IN_FOV=s(3)]="IN_FOV",t[t.HAS_PLAYER=s(4)]="HAS_PLAYER",t[t.HAS_MONSTER=s(5)]="HAS_MONSTER",t[t.HAS_DORMANT_MONSTER=s(6)]="HAS_DORMANT_MONSTER",t[t.HAS_ITEM=s(7)]="HAS_ITEM",t[t.HAS_STAIRS=s(8)]="HAS_STAIRS",t[t.NEEDS_REDRAW=s(9)]="NEEDS_REDRAW",t[t.CELL_CHANGED=s(10)]="CELL_CHANGED",t[t.IS_IN_PATH=s(12)]="IS_IN_PATH",t[t.IS_CURSOR=s(13)]="IS_CURSOR",t[t.MAGIC_MAPPED=s(14)]="MAGIC_MAPPED",t[t.ITEM_DETECTED=s(15)]="ITEM_DETECTED",t[t.STABLE_MEMORY=s(16)]="STABLE_MEMORY",t[t.CLAIRVOYANT_VISIBLE=s(17)]="CLAIRVOYANT_VISIBLE",t[t.WAS_CLAIRVOYANT_VISIBLE=s(18)]="WAS_CLAIRVOYANT_VISIBLE",t[t.CLAIRVOYANT_DARKENED=s(19)]="CLAIRVOYANT_DARKENED",t[t.IMPREGNABLE=s(20)]="IMPREGNABLE",t[t.TELEPATHIC_VISIBLE=s(22)]="TELEPATHIC_VISIBLE",t[t.WAS_TELEPATHIC_VISIBLE=s(23)]="WAS_TELEPATHIC_VISIBLE",t[t.MONSTER_DETECTED=s(24)]="MONSTER_DETECTED",t[t.WAS_MONSTER_DETECTED=s(25)]="WAS_MONSTER_DETECTED",t[t.LIGHT_CHANGED=s(27)]="LIGHT_CHANGED",t[t.CELL_LIT=s(28)]="CELL_LIT",t[t.IS_IN_SHADOW=s(29)]="IS_IN_SHADOW",t[t.CELL_DARK=s(30)]="CELL_DARK",t[t.PERMANENT_CELL_FLAGS=t.REVEALED|t.MAGIC_MAPPED|t.ITEM_DETECTED|t.HAS_ITEM|t.HAS_DORMANT_MONSTER|t.HAS_STAIRS|t.STABLE_MEMORY|t.IMPREGNABLE]="PERMANENT_CELL_FLAGS",t[t.ANY_KIND_OF_VISIBLE=t.VISIBLE|t.CLAIRVOYANT_VISIBLE|t.TELEPATHIC_VISIBLE]="ANY_KIND_OF_VISIBLE",t[t.HAS_ACTOR=t.HAS_PLAYER|t.HAS_MONSTER]="HAS_ACTOR",t[t.IS_WAS_ANY_KIND_OF_VISIBLE=t.VISIBLE|t.WAS_VISIBLE|t.CLAIRVOYANT_VISIBLE|t.WAS_CLAIRVOYANT_VISIBLE|t.TELEPATHIC_VISIBLE|t.WAS_TELEPATHIC_VISIBLE]="IS_WAS_ANY_KIND_OF_VISIBLE",t[t.CELL_DEFAULT=t.VISIBLE|t.IN_FOV|t.NEEDS_REDRAW|t.CELL_CHANGED|t.IS_IN_SHADOW]="CELL_DEFAULT"}(a||(a={})),function(t){t[t.SEARCHED_FROM_HERE=s(0)]="SEARCHED_FROM_HERE",t[t.PRESSURE_PLATE_DEPRESSED=s(1)]="PRESSURE_PLATE_DEPRESSED",t[t.KNOWN_TO_BE_TRAP_FREE=s(2)]="KNOWN_TO_BE_TRAP_FREE",t[t.CAUGHT_FIRE_THIS_TURN=s(4)]="CAUGHT_FIRE_THIS_TURN",t[t.EVENT_FIRED_THIS_TURN=s(5)]="EVENT_FIRED_THIS_TURN",t[t.EVENT_PROTECTED=s(6)]="EVENT_PROTECTED",t[t.IS_IN_LOOP=s(10)]="IS_IN_LOOP",t[t.IS_CHOKEPOINT=s(11)]="IS_CHOKEPOINT",t[t.IS_GATE_SITE=s(12)]="IS_GATE_SITE",t[t.IS_IN_ROOM_MACHINE=s(13)]="IS_IN_ROOM_MACHINE",t[t.IS_IN_AREA_MACHINE=s(14)]="IS_IN_AREA_MACHINE",t[t.IS_POWERED=s(15)]="IS_POWERED",t[t.IS_IN_MACHINE=t.IS_IN_ROOM_MACHINE|t.IS_IN_AREA_MACHINE]="IS_IN_MACHINE",t[t.PERMANENT_MECH_FLAGS=t.SEARCHED_FROM_HERE|t.PRESSURE_PLATE_DEPRESSED|t.KNOWN_TO_BE_TRAP_FREE|t.IS_IN_LOOP|t.IS_CHOKEPOINT|t.IS_GATE_SITE|t.IS_IN_MACHINE]="PERMANENT_MECH_FLAGS"}(T||(T={})),function(t){t[t.MAP_CHANGED=s(0)]="MAP_CHANGED",t[t.MAP_STABLE_GLOW_LIGHTS=s(1)]="MAP_STABLE_GLOW_LIGHTS",t[t.MAP_STABLE_LIGHTS=s(2)]="MAP_STABLE_LIGHTS",t[t.MAP_ALWAYS_LIT=s(3)]="MAP_ALWAYS_LIT",t[t.MAP_SAW_WELCOME=s(4)]="MAP_SAW_WELCOME",t[t.MAP_NO_LIQUID=s(5)]="MAP_NO_LIQUID",t[t.MAP_NO_GAS=s(6)]="MAP_NO_GAS",t[t.MAP_FOV_CHANGED=s(7)]="MAP_FOV_CHANGED",t[t.MAP_DEFAULT=t.MAP_STABLE_LIGHTS|t.MAP_STABLE_GLOW_LIGHTS|t.MAP_FOV_CHANGED]="MAP_DEFAULT"}(h||(h={}));class E{constructor(t={}){"function"==typeof t&&(t={fn:t}),this.tile=t.tile||null,this.fn=t.fn||null,this.item=t.item||null,this.chance=t.chance||0,this.volume=t.volume||0,this.spread=t.spread||0,this.radius=t.radius||0,this.decrement=t.decrement||0,this.flags=e.flag.from(l,t.flags),this.matchTile=t.matchTile||t.needs||0,this.next=t.next||null,this.message=t.message||null,this.lightFlare=t.flare||null,this.flashColor=t.flash?e.color.from(t.flash):null,this.messageDisplayed=!1,this.emit=t.emit||null,this.id=t.id||null}}function n(t){if(!t)return null;"string"==typeof t&&(t={tile:t});return new E(t)}e.make.activation=n;const S={DF_NONE:null};async function o(t,i={}){let s,r,a;if(!t)return!1;if(!i)return!1;if("string"==typeof t)a=S[t],a||e.utils.ERROR("Unknown tile Event: "+t);else{if("function"==typeof t)return t(i);a=t}const h=i.map,E=i.x,n=i.y;if(h&&void 0!==E&&void 0!==n||e.utils.ERROR("MAP, x, y are required in context."),i.safe&&h.hasCellMechFlag(E,n,T.EVENT_FIRED_THIS_TURN)&&!(a.flags&l.DFF_ALWAYS_FIRE))return!1;const c=i.abortIfBlocking=i.abortIfBlocking||a.flags&l.DFF_ABORT_IF_BLOCKS_MAP;a.message&&a.message.length&&!a.messageDisplayed&&h.isVisible(E,n)&&(a.messageDisplayed=!0,e.message.add(a.message));let O=null;a.tile&&(O=d[a.tile]||null,O||e.utils.ERROR("Unknown tile: "+a.tile));let f=null;a.item&&"item"in e.make&&(f=e.make.item(a.item),f||e.utils.ERROR("Unknown item: "+a.item));const L=i.blocking=!(!c||a.flags&l.DFF_PERMIT_BLOCKING||!(O&&O.flags&_.T_PATHING_BLOCKER||f&&f.blocksMove()||a.flags&l.DFF_TREAT_AS_BLOCKING)),F=e.grid.alloc(h.width,h.height);let N=!1;if(A(a,F,i),L&&h.gridDisruptsPassability(F,{bounds:i.bounds})||(a.flags&l.DFF_EVACUATE_CREATURES&&u(h,F)&&(N=!0),a.flags&l.DFF_EVACUATE_ITEMS&&R(h,F)&&(N=!0),a.flags&l.DFF_NULLIFY_CELL&&g(h,F,a.flags)&&(N=!0),(O||f||a.fn)&&await I(a,F,i,O,f)&&(N=!0)),f&&f.delete(),N&&a.flags&l.DFF_PROTECTED&&F.forEach(((t,e,i)=>{if(!t)return;h.cell(e,i).mechFlags|=T.EVENT_PROTECTED})),N)for(let t=0;t<F.width;++t)for(let i=0;i<F.height;++i){if(!F[t][i]||e.data.gameHasEnded)continue;const s=h.cell(t,i);if(s.actor||s.item)for(let l of s.tiles())if(await l.applyInstantEffects(h,t,i,s),e.data.gameHasEnded)return!0}if(a.emit&&(await e.events.emit(a.emit,i),N=!0),e.data.gameHasEnded)return e.grid.free(F),N;if(a.next&&(N||a.flags&l.DFF_SUBSEQ_ALWAYS))if(a.flags&l.DFF_SUBSEQ_EVERYWHERE){for(s=0;s<h.width;s++)for(r=0;r<h.height;r++)F[s][r]&&(i.x=s,i.y=r,await o(a.next,i));i.x=E,i.y=n}else await o(a.next,i);return N&&O&&O.flags&(_.T_DEEP_WATER|_.T_LAVA|_.T_AUTO_DESCENT)&&(e.data.updateMapToShoreThisTurn=!1),N&&(F.forEach(((t,e,i)=>{t&&h.redrawXY(e,i)})),h.changed(!0),a.flags&l.DFF_NO_MARK_FIRED||F.forEach(((t,e,i)=>{t&&h.setCellFlags(e,i,0,T.EVENT_FIRED_THIS_TURN)}))),e.grid.free(F),N}function c(t,e,i,s={}){const r=s.map;if(!r.hasXY(e,i))return!1;const a=r.cell(e,i);if(t.flags&l.DFF_BUILD_IN_WALLS){if(!a.isWall())return!1}else if(t.flags&l.DFF_MUST_TOUCH_WALLS){let t=!1;if(r.eachNeighbor(e,i,(e=>{e.isWall()&&(t=!0)})),!t)return!1}else if(t.flags&l.DFF_NO_TOUCH_WALLS){let t=!0;if(r.eachNeighbor(e,i,(e=>{e.isWall()&&(t=!1)})),!t)return!1}return!(s.bounds&&!s.bounds.containsXY(e,i))&&(!(t.matchTile&&!a.hasTile(t.matchTile))&&!(a.hasTileFlag(_.T_OBSTRUCTS_TILE_EFFECTS)&&!t.matchTile&&(s.x!=e||s.y!=i)))}function A(t,i,s={}){let _,r,a,T,h,E,n;const S=s.map,o=s.x,A=s.y;s.bounds;let I=t.spread||0,g=t.decrement||0;if(t.matchTile&&"string"==typeof t.matchTile){const i=t.matchTile,s=d[i];s||e.utils.ERROR("Failed to find match tile with name:"+i),t.matchTile=s.id}i[o][A]=T=1;let u=t.radius||0;if(t.flags&l.DFF_SPREAD_CIRCLE){for(u=0,I=I||100,I>=100&&(g=g||100);e.random.chance(I);)I-=g,++u;I=100,g=0}if(u)I=I||100,i.updateCircle(o,A,u,((i,l,_)=>{if(!c(t,l,_,s))return 0;const r=Math.floor(e.utils.distanceBetween(o,A,l,_)),a=I-r*g;return e.random.chance(a)?1:0})),i[o][A]=1;else if(I)if(n=!0,I>=100&&(g=g||100),t.flags&l.DFF_SPREAD_LINE){h=o,E=A;const l=e.utils.DIRS[e.random.number(4)];for(;n;)n=!1,h+=l[0],E+=l[1],i.hasXY(h,E)&&!i[h][E]&&c(t,h,E,s)&&e.random.chance(I)&&(i[h][E]=1,n=!0,I-=g)}else for(g<=0&&(g=I);n&&I>0;){for(n=!1,T++,_=0;_<S.width;_++)for(r=0;r<S.height;r++)if(i[_][r]==T-1)for(a=0;a<4;a++)h=_+e.utils.DIRS[a][0],E=r+e.utils.DIRS[a][1],i.hasXY(h,E)&&!i[h][E]&&c(t,h,E,s)&&e.random.chance(I)&&(i[h][E]=T,n=!0);I-=g}c(t,o,A,s)||(i[o][A]=0)}async function I(t,e,s,r,a){let h,E,n;n=!1;const S=t.flags&l.DFF_BLOCKED_BY_OTHER_LAYERS,o=t.flags&l.DFF_SUPERPRIORITY,c=(s.refreshCell,s.map),A=s.volume||t.volume||0;for(h=0;h<e.width;h++)for(E=0;E<e.height;E++){if(!e[h][E])continue;e[h][E]=0;const I=c.cell(h,E);if(!(I.mechFlags&T.EVENT_PROTECTED)){if(r&&(I.layers[r.layer]===r.id?r.layer==i.GAS?(e[h][E]=1,I.gasVolume+=A):r.layer==i.LIQUID&&(e[h][E]=1,I.liquidVolume+=A):!(o||I.tile(r.layer).priority<r.priority)||I.obstructsLayer(r.layer)||I.item&&t.flags&l.DFF_BLOCKED_BY_ITEMS||I.actor&&t.flags&l.DFF_BLOCKED_BY_ACTORS||S&&!(I.highestPriorityTile().priority<r.priority)||(e[h][E]=1,c.setTile(h,E,r,A),n=!0)),a&&(o||!I.item)&&!I.hasTileFlag(_.T_OBSTRUCTS_ITEMS)){e[h][E]=1,I.item&&c.removeItem(I.item);const t=a.clone();c.addItem(h,E,t),n=!0}t.fn&&await t.fn(h,E,s)&&(e[h][E]=1,n=!0)}}return n&&c.changed(!0),n}function g(t,e,i){let s=!1;const _=i&l.DFF_NULL_SURFACE,r=i&l.DFF_NULL_LIQUID,a=i&l.DFF_NULL_GAS;return e.forEach(((e,i,l)=>{e&&(t.nullifyCellLayers(i,l,!!r,!!_,!!a),s=!0)})),s}function u(t,e){let i,s,l,_=!1;for(i=0;i<t.width;i++)for(s=0;s<t.height;s++)if(e[i][s]&&t.hasCellFlag(i,s,a.HAS_ACTOR)){if(l=t.actorAt(i,s),null===l)continue;const r=t.matchingLocNear(i,s,(t=>!(null==l?void 0:l.forbidsCell(t))),{hallways:!0,blockingMap:e});t.moveActor(r[0],r[1],l),t.redrawXY(r[0],r[1]),_=!0}return _}function R(t,e){let i=!1;return e.forEach(((s,l,_)=>{if(!s)return;const r=t.cell(l,_);if(!r.item)return;const a=t.matchingLocNear(l,_,(t=>{var e;return!!(null===(e=t.item)||void 0===e?void 0:e.forbidsCell(t))}),{hallways:!0,blockingMap:e});a&&(t.removeItem(r.item),t.addItem(a[0],a[1],r.item),t.redrawXY(a[0],a[1]),i=!0)})),i}var O={__proto__:null,get Flags(){return l},Activation:E,make:n,activations:S,install:function(t,e){return e instanceof E||(e=n(e)),S[t]=e,e&&(e.id=t),e},resetAllMessages:function(){Object.values(S).forEach((t=>{t instanceof E&&(t.messageDisplayed=!1)}))},spawn:o,computeSpawnMap:A,spawnTiles:I,nullifyCells:g,evacuateCreatures:u,evacuateItems:R};const f=e.config.light={INTENSITY_DARK:20},L=e.color.make();class F{constructor(t,i,s,l=!1){this.fadeTo=0,this.passThroughActors=!1,this.id=null,this.color=e.color.from(t)||null,this.radius=e.range.make(i||1),this.fadeTo=s||0,this.passThroughActors=l}copy(t){this.color=t.color,this.radius.copy(t.radius),this.fadeTo=t.fadeTo,this.passThroughActors=t.passThroughActors}get intensity(){return N(this.color)}paint(t,i,s,l=!1,r=!1){if(!t)return;let T,h,E=this.radius.value(),n=Math.ceil(E);L.copy(this.color).bake();const S=!r&&!l&&N(L)>f.INTENSITY_DARK,o=this.fadeTo,c=e.grid.alloc(t.width,t.height,0);t.calcFov(c,i,s,n,this.passThroughActors?0:a.HAS_ACTOR,_.T_OBSTRUCTS_VISION);let A=!1;if(c.forCircle(i,s,n,((l,_,r)=>{if(!l)return;const n=t.cell(_,r);for(h=Math.floor(100-(100-o)*(e.utils.distanceBetween(i,s,_,r)/E)),T=0;T<3;T++)n.light[T]+=Math.floor(L[T]*h/100);S&&(n.flags&=~a.IS_IN_SHADOW),n.flags&(a.IN_FOV|a.ANY_KIND_OF_VISIBLE)&&(A=!0)})),S){t.cell(i,s).flags&=~a.IS_IN_SHADOW}return e.grid.free(c),A}}function N(t){return Math.max(t[0],t[1],t[2])}function C(...t){if(1==t.length){const i=t[0];if("string"==typeof i){const t=D[i];if(t)return t;const[s,l,_,r]=i.split(/[,|]/).map((t=>t.trim()));return new F(e.color.from(s),e.range.from(l||1),Number.parseInt(_||"0"),!!r&&"false"!==r)}if(Array.isArray(i)){const[t,e,s,l]=i;return new F(t,e,s,l)}if(i&&i.color)return new F(e.color.from(i.color),e.range.from(i.radius),Number.parseInt(i.fadeTo||"0"),i.pass);throw new Error("Unknown Light config - "+i)}{const[e,i,s,l]=t;return new F(e,i,s,l)}}e.make.light=C;const D={};class M{constructor(t,s){this.flags=0,this.mechFlags=0,this.layer=i.GROUND,this.priority=-1,this.sprite={},this.activates={},this.light=null,this.flavor=null,this.desc=null,this.article=null,this.dissipate=2e3,void 0!==s&&e.utils.assignOmitting(["activates"],this,s),e.utils.assignOmitting(["Extends","extends","flags","mechFlags","sprite","activates","ch","fg","bg","light"],this,t),this.name=t.name||(s?s.name:t.id),this.id=t.id,this.layer=this.layer||i.GROUND,"string"==typeof this.layer&&(this.layer=i[this.layer]),this.priority<0&&(this.priority=50),this.flags=e.flag.from(_,this.flags,t.flags),this.mechFlags=e.flag.from(r,this.mechFlags,t.mechFlags||t.flags),t.light&&(this.light=function(...t){1!=t.length&&e.utils.ERROR("Unknown Light config: "+JSON.stringify(t));const i=t[0];if("string"==typeof i){const t=D[i];if(t)return t}return C(i)}(t.light)),t.sprite?this.sprite=e.canvas.makeSprite(t.sprite):(t.ch||t.fg||t.bg)&&(this.sprite=e.canvas.makeSprite(t.ch||null,t.fg||null,t.bg||null,t.opacity)),s&&s.activates&&Object.assign(this.activates,s.activates),t.activates&&Object.entries(t.activates).forEach((([t,e])=>{if(e){const i=n(e);this.activates[t]=i}else delete this.activates[t]}))}successorFlags(t){const e=this.activates[t];if(!e)return 0;const i=e.tile;if(!i)return 0;const s=d[i];return s?s.flags:0}hasFlag(t){return(this.flags&t)>0}hasMechFlag(t){return(this.mechFlags&t)>0}hasFlags(t,e){return(!t||this.flags&t)&&(!e||this.mechFlags&e)}activatesOn(t){return!!this.activates[t]}getName(t){let i={};if(!0===t||!1===t||"string"==typeof t?i.article=t:t&&(i=t),!i.article&&!i.color)return this.name;let s=this.name;if(i.color){let t=i.color;!0===i.color&&(t=this.sprite.fg),"string"!=typeof t&&(t=e.color.from(t).toString()),s=`Ω${t}Ω${this.name}∆`}if(i.article){s=("string"==typeof i.article?i.article:this.article||"a")+" "+s}return s}getDescription(t={}){return this.getName(t)}}const d={};function m(...t){let i=t[0],s=t[1],l=t[2];1==arguments.length?(l=t[0],s=l.Extends||{},i=l.id):2==arguments.length&&(l=s,s=l.Extends||l.extends||{}),"string"==typeof s&&(s=d[s]||e.utils.ERROR("Unknown base tile: "+s)),l.id=i;const _=new M(l,s);return d[i]=_,_}var P={__proto__:null,get Flags(){return _},get MechFlags(){return r},get Layer(){return i},Tile:M,tiles:d,install:m,installAll:function(t){Object.entries(t).forEach((([t,e])=>{e.id=t,m(t,e)}))}};e.color.install("cursorColor",25,100,150),e.config.cursorPathIntensity=50;class U{constructor(){this.mixer=new e.canvas.Mixer,this.item=null,this.itemQuantity=0,this.actor=null,this.tile=null,this.cellFlags=0,this.cellMechFlags=0,this.tileFlags=0,this.tileMechFlags=0}nullify(){this.mixer.nullify(),this.item=null,this.itemQuantity=0,this.actor=null,this.tile=null,this.cellFlags=0,this.cellMechFlags=0,this.tileFlags=0,this.tileMechFlags=0}copy(t){const e=this.mixer;Object.assign(this,t),this.mixer=e,this.mixer.copy(t.mixer)}}class y{constructor(){this.layers=[null,null,null,null],this.sprites=null,this.actor=null,this.item=null,this.data={},this.flags=a.CELL_DEFAULT,this.mechFlags=0,this.gasVolume=0,this.liquidVolume=0,this.machineNumber=0,this.memory=new U,this.light=[100,100,100],this.oldLight=[100,100,100],this.glowLight=[100,100,100]}copy(t){e.utils.copyObject(this,t)}nullify(){for(let t=0;t<this.layers.length;++t)this.layers[t]=null;this.sprites=null,this.actor=null,this.item=null,this.data={},this.flags=a.CELL_DEFAULT,this.mechFlags=0,this.gasVolume=0,this.liquidVolume=0,this.machineNumber=0,this.memory.nullify(),this.light=[100,100,100],this.oldLight=[100,100,100],this.glowLight=[100,100,100]}nullifyLayers(t=!1,e=!1,i=!1){t&&(this.layers[1]=null,this.liquidVolume=0),e&&(this.layers[2]=null),i&&(this.layers[3]=null,this.gasVolume=0),this.flags|=a.CELL_CHANGED}get ground(){return this.layers[i.GROUND]}get liquid(){return this.layers[i.LIQUID]}get surface(){return this.layers[i.SURFACE]}get gas(){return this.layers[i.GAS]}get groundTile(){return d[this.layers[i.GROUND]||"0"]}get liquidTile(){return d[this.layers[i.LIQUID]||"0"]}get surfaceTile(){return d[this.layers[i.SURFACE]||"0"]}get gasTile(){return d[this.layers[i.GAS]||"0"]}dump(){if(this.actor)return this.actor.sprite.ch;if(this.item)return this.item.sprite.ch;for(let t=this.layers.length-1;t>=0;--t){if(!this.layers[t])continue;const e=d[this.layers[t]||"0"];if(e.sprite.ch)return e.sprite.ch}return d[0].sprite.ch}changed(){return this.flags&a.CELL_CHANGED}isVisible(){return this.flags&a.VISIBLE}isAnyKindOfVisible(){return this.flags&a.ANY_KIND_OF_VISIBLE}isOrWasAnyKindOfVisible(){return this.flags&a.IS_WAS_ANY_KIND_OF_VISIBLE}isRevealed(t=!1){const e=a.REVEALED|(t?a.MAGIC_MAPPED:0);return this.flags&e}listInSidebar(){return this.hasTileMechFlag(r.TM_LIST_IN_SIDEBAR,!0)}_needsRedraw(){this.flags|=a.NEEDS_REDRAW}hasVisibleLight(){return N(this.light)>e.config.light.INTENSITY_DARK}isDark(){return N(this.light)<=e.config.light.INTENSITY_DARK}lightChanged(){return this.flags&a.LIGHT_CHANGED}tile(t=0){const e=this.layers[t]||0;return d[e]}*tiles(){for(let t of this.layers)t&&(yield d[t])}tileFlags(t=!1){if(t&&!this.isVisible())return this.memory.tileFlags;let e=0;for(let t of this.tiles())e|=t.flags;return e}tileMechFlags(t=!1){if(t&&!this.isVisible())return this.memory.tileMechFlags;let e=0;for(let t of this.tiles())e|=t.mechFlags;return e}hasTileFlag(t=0,e=!1){return!!(t&this.tileFlags(e))}hasAllTileFlags(t=0){return(t&this.tileFlags())===t}hasTileMechFlag(t=0,e=!1){return!!(t&this.tileMechFlags(e))}hasAllTileMechFlags(t=0){return(t&this.tileMechFlags())===t}setFlags(t=0,e=0){this.flags|=t,this.mechFlags|=e}clearFlags(t=0,e=0){this.flags&=~t,this.mechFlags&=~e}hasFlag(t=0,e=!1){return!!(t&(e&&!this.isAnyKindOfVisible()?this.memory.cellFlags:this.flags))}hasMechFlag(t=0,e=!1){return!!(t&(e&&!this.isAnyKindOfVisible()?this.memory.cellMechFlags:this.mechFlags))}hasTile(t){let e;return e=t instanceof M?t.id:t,this.layers.includes(e)}successorTileFlags(t){let e=0;for(let i of this.tiles())e|=i.successorFlags(t);return e}promotedTileFlags(){return this.successorTileFlags("promote")}discoveredTileFlags(){return this.successorTileFlags("discover")}hasDiscoveredTileFlag(t){return this.discoveredTileFlags()&t}highestPriorityTile(t=!1){let e=d[0],s=-1e4;for(let l=i.GROUND;l<=(t?i.LIQUID:i.GAS);++l){const t=this.layers[l];if(!t)continue;const i=d[t];i.priority>s&&(e=i,s=i.priority)}return e}tileWithFlag(t){for(let e of this.tiles())if(e.flags&t)return e;return null}tileWithMechFlag(t){for(let e of this.tiles())if(e.mechFlags&t)return e;return null}tileDesc(){return this.highestPriorityTile().desc}tileFlavor(){return this.highestPriorityTile().flavor}getName(t={}){return this.highestPriorityTile().getName(t)}isNull(){return null==this.ground}isEmpty(){return!(this.actor||this.item)}isPassableNow(t=!1){const e=t&&!this.isAnyKindOfVisible()?this.memory.tileFlags:this.tileFlags();return!(e&_.T_PATHING_BLOCKER)||(!!(e&_.T_BRIDGE)||!t&&this.isSecretDoor(t))}canBePassed(t=!1){if(this.isPassableNow(t))return!0;let e=t&&!this.isAnyKindOfVisible()?this.memory.tileMechFlags:this.tileMechFlags();return!!(e&r.TM_CONNECTS_LEVEL)||!(!(e&r.TM_PROMOTES)||this.promotedTileFlags()&_.T_PATHING_BLOCKER)}isWall(t=!1){return!!((t&&!this.isAnyKindOfVisible()?this.memory.tileFlags:this.tileFlags())&_.T_OBSTRUCTS_EVERYTHING)}isObstruction(t=!1){return!!((t&&!this.isAnyKindOfVisible()?this.memory.tileFlags:this.tileFlags())&_.T_OBSTRUCTS_DIAGONAL_MOVEMENT)}isDoor(t=!1){return!!((t&&!this.isAnyKindOfVisible()?this.memory.tileFlags:this.tileFlags())&_.T_IS_DOOR)}isSecretDoor(t=!1){if(t)return!1;return!(!(this.tileMechFlags()&r.TM_IS_SECRET)||this.discoveredTileFlags()&_.T_PATHING_BLOCKER)}blocksPathing(t=!1){return!!((t&&!this.isAnyKindOfVisible()?this.memory.tileFlags:this.tileFlags())&_.T_PATHING_BLOCKER)}blocksVision(){return!!(this.tileFlags()&_.T_OBSTRUCTS_VISION)}isLiquid(t=!1){return!!((t&&!this.isAnyKindOfVisible()?this.memory.tileFlags:this.tileFlags())&_.T_IS_LIQUID)}hasGas(t=!1){return!!((t&&!this.isAnyKindOfVisible()?this.memory.tileFlags:this.tileFlags())&_.T_GAS)}markRevealed(){return this.flags&=~a.STABLE_MEMORY,!(this.flags&a.REVEALED)&&(this.flags|=a.REVEALED,this.hasTileFlag(_.T_PATHING_BLOCKER)||e.data.xpxpThisTurn++,!0)}obstructsLayer(t){return t==i.SURFACE&&this.hasTileFlag(_.T_OBSTRUCTS_SURFACE)}_setTile(t=null,s=0,l){let r;l=l||e.data.map,null===t?r=d[0]:"string"==typeof t?r=d[t]:t instanceof M?(r=t,t=r.id):t&&e.utils.ERROR("Unknown tile: "+t),r||(e.utils.WARN("Unknown tile - "+t),r=d[0],t=null);const E=this.layers[r.layer]||null,n=d[E]||d[0];(n.flags&_.T_PATHING_BLOCKER)!=(r.flags&_.T_PATHING_BLOCKER)&&(e.data.staleLoopMap=!0),r.flags&_.T_IS_FIRE&&!(n.flags&_.T_IS_FIRE)&&this.setFlags(0,T.CAUGHT_FIRE_THIS_TURN);const S=r.flags&_.T_OBSTRUCTS_VISION,o=n.flags&_.T_OBSTRUCTS_VISION;return l&&this.isAnyKindOfVisible()&&S!=o&&l.setFlag(h.MAP_FOV_CHANGED),this.layers[r.layer]=t,r.layer==i.LIQUID?(this.liquidVolume=s+(t==E?this.liquidVolume:0),l&&l.clearFlag(h.MAP_NO_LIQUID)):r.layer==i.GAS&&(this.gasVolume=s+(t==E?this.gasVolume:0),l&&l.clearFlag(h.MAP_NO_GAS)),r.layer>0&&null===this.layers[0]&&(this.layers[0]="FLOOR"),this.flags|=a.CELL_CHANGED,l&&n.light!==r.light&&l.clearFlag(h.MAP_STABLE_GLOW_LIGHTS|h.MAP_STABLE_LIGHTS),!0}clearLayer(t){"string"==typeof t&&(t=i[t]),this.layers[t]&&(this.flags|=a.CELL_CHANGED),this.layers[t]=null,t==i.LIQUID?this.liquidVolume=0:t==i.GAS&&(this.gasVolume=0)}clearLayers(t,e){e=e||this.layers[0];for(let s=0;s<this.layers.length;s++)s!=t&&s!=i.GAS&&(this.layers[s]=s?null:e);this.flags|=a.CELL_CHANGED}nullifyTileWithFlags(t,e=0){for(let i=0;i<this.layers.length;++i){const s=this.layers[i];if(!s)continue;const l=d[s];t&&e?l.flags&t&&l.mechFlags&e&&(this.layers[i]=null):t?l.flags&t&&(this.layers[i]=null):e&&l.flags&e&&(this.layers[i]=null)}this.flags|=a.CELL_CHANGED}async activate(t,i={}){i.cell=this;let s=!1;for(let l of this.tiles()){if(!l.activates)continue;const _=l.activates[t];if(_){if(_.chance&&!e.random.chance(_.chance,1e4))continue;if(i.tile=l,s=await o(_,i)||s,s)break}}return s}activatesOn(t){for(let e of this.tiles())if(e.activatesOn(t))return!0;return!1}addSprite(t,e,i=50){if(!e)return;if(this.flags|=a.CELL_CHANGED,!this.sprites||this.sprites.layer>t||this.sprites.layer==t&&this.sprites.priority>i)return void(this.sprites={layer:t,priority:i,sprite:e,next:this.sprites});let s=this.sprites;for(;s.next&&(s.layer<t||s.layer==t&&s.priority<=i);)s=s.next;const l={layer:t,priority:i,sprite:e,next:s.next};s.next=l}removeSprite(t){if(!t)return!1;if(!this.sprites)return!1;if(this.flags|=a.CELL_CHANGED,this.sprites&&this.sprites.sprite===t)return this.sprites=this.sprites.next,!0;let e=this.sprites,i=this.sprites.next;for(;i;){if(i.sprite===t)return e.next=i.next,!0;i=i.next}return!1}storeMemory(){const t=this.memory;t.tileFlags=this.tileFlags(),t.tileMechFlags=this.tileMechFlags(),t.cellFlags=this.flags,t.cellMechFlags=this.mechFlags,t.tile=this.highestPriorityTile(),this.item?(t.item=this.item,t.itemQuantity=this.item.quantity||1):(t.item=null,t.itemQuantity=0),t.actor=this.actor,p(this,t.mixer),this.actor&&this.isOrWasAnyKindOfVisible()&&(this.actor.rememberedInCell&&this.actor.rememberedInCell!==this&&(console.log("remembered in cell change"),this.actor.rememberedInCell.storeMemory(),this.actor.rememberedInCell.flags|=a.NEEDS_REDRAW),this.actor.rememberedInCell=this)}}function B(){return new y}function p(t,s){const l=t.memory.mixer;l.blackOut();let _=!1;for(let s of t.tiles()){let a=100;s.layer==i.LIQUID?a=e.utils.clamp(t.liquidVolume||0,20,100):s.layer==i.GAS&&(a=e.utils.clamp(t.gasVolume||0,20,100)),l.drawSprite(s.sprite,a),s.mechFlags&r.TM_VISUALLY_DISTINCT&&(_=!0)}let a=t.sprites;for(;a;)l.drawSprite(a.sprite),a=a.next;return l.fg.multiply(t.light),l.bg.multiply(t.light),l.bake(!t.isAnyKindOfVisible()),_&&e.color.separate(l.fg,l.bg),s.drawSprite(l),!0}e.make.cell=B;var V={__proto__:null,get Flags(){return a},get MechFlags(){return T},CellMemory:U,Cell:y,make:B,getAppearance:p};e.utils.setDefaults(e.config,{"map.deepestLevel":99});class G{constructor(t,i,s={}){this.locations={},this.config={},this._actors=null,this._items=null,this.flags=0,this.ambientLight=null,this.lights=null,this.events={},this._width=t,this._height=i,this.cells=e.grid.make(t,i,(()=>new y)),this.locations=s.locations||{},this.config=Object.assign({},s),this.config.tick=this.config.tick||100,this._actors=null,this._items=null,this.flags=e.flag.from(h,h.MAP_DEFAULT,s.flags),this.ambientLight=null;const l=s.ambient||s.ambientLight||s.light;l&&(this.ambientLight=e.color.make(l)),this.lights=null,this.id=s.id,this.events=s.events||{}}get width(){return this._width}get height(){return this._height}async start(){}nullify(){this.cells.forEach((t=>t.nullify()))}dump(t){this.cells.dump(t||(t=>t.dump()))}cell(t,e){return this.cells[t][e]}eachCell(t){this.cells.forEach(((e,i,s)=>t(e,i,s,this)))}forEach(t){this.cells.forEach(((e,i,s)=>t(e,i,s,this)))}forRect(t,e,i,s,l){this.cells.forRect(t,e,i,s,((t,e,i)=>l(t,e,i,this)))}eachNeighbor(t,e,i,s=!1){this.cells.eachNeighbor(t,e,((t,e,s)=>i(t,e,s,this)),s)}hasXY(t,e){return this.cells.hasXY(t,e)}isBoundaryXY(t,e){return this.cells.isBoundaryXY(t,e)}changed(t){return!0===t?this.flags|=h.MAP_CHANGED:!1===t&&(this.flags&=~h.MAP_CHANGED),this.flags&h.MAP_CHANGED}hasCellFlag(t,e,i){return this.cell(t,e).flags&i}hasCellMechFlag(t,e,i){return this.cell(t,e).mechFlags&i}hasTileFlag(t,e,i){return this.cell(t,e).hasTileFlag(i)}hasTileMechFlag(t,e,i){return this.cell(t,e).hasTileMechFlag(i)}setCellFlag(t,e,i){this.cell(t,e).flags|=i}redrawCell(t){t._needsRedraw(),this.flags|=h.MAP_CHANGED}redrawXY(t,e){const i=this.cell(t,e);this.redrawCell(i)}redrawAll(){this.forEach((t=>{t.flags|=a.NEEDS_REDRAW})),this.flags|=h.MAP_CHANGED}revealAll(){this.forEach((t=>{t.markRevealed(),t.storeMemory()}))}markRevealed(t,i){this.cell(t,i).markRevealed()&&e.data.player&&e.data.player.invalidateCostMap()}isVisible(t,e){return this.cell(t,e).isVisible()}isAnyKindOfVisible(t,e){return this.cell(t,e).isAnyKindOfVisible()}isOrWasAnyKindOfVisible(t,e){return this.cell(t,e).isOrWasAnyKindOfVisible()}hasVisibleLight(t,e){return this.cell(t,e).hasVisibleLight()}setFlag(t){this.flags|=t,this.changed(!0)}setFlags(t=0,e=0,i=0){t&&(this.flags|=t),(e||i)&&this.forEach((t=>t.setFlags(e,i))),this.changed(!0)}clearFlag(t){this.flags&=~t,this.changed(!0)}clearFlags(t=0,e=0,i=0){t&&(this.flags&=~t),(e||i)&&this.forEach((t=>t.clearFlags(e,i))),this.changed(!0)}setCellFlags(t,e,i=0,s=0){this.cell(t,e).setFlags(i,s),this.flags|=h.MAP_CHANGED}clearCellFlags(t,e,i=0,s=0){this.cell(t,e).clearFlags(i,s),this.changed(!0)}hasTile(t,e,i){return this.cells[t][e].hasTile(i)}tileFlags(t,e,i=!1){return this.cells[t][e].tileFlags(i)}tileMechFlags(t,e,i=!1){return this.cells[t][e].tileMechFlags(i)}tileWithFlag(t,e,i=0){return this.cells[t][e].tileWithFlag(i)}tileWithMechFlag(t,e,i=0){return this.cells[t][e].tileWithMechFlag(i)}hasKnownTileFlag(t,e,i=0){return this.cells[t][e].memory.tileFlags&i}discoveredTileFlags(t,e){return this.cells[t][e].discoveredTileFlags()}hasDiscoveredTileFlag(t,e,i=0){return this.cells[t][e].hasDiscoveredTileFlag(i)}canBePassed(t,e,i=!1){return this.cells[t][e].canBePassed(i)}isPassableNow(t,e,i=!1){return this.cells[t][e].isPassableNow(i)}isNull(t,e){return this.cells[t][e].isNull()}isEmpty(t,e){return this.cells[t][e].isEmpty()}isObstruction(t,e,i=!1){return this.cells[t][e].isObstruction(i)}isDoor(t,e,i=!1){return this.cells[t][e].isDoor(i)}isLiquid(t,e,i=!1){return this.cells[t][e].isLiquid(i)}hasGas(t,e,i=!1){return this.cells[t][e].hasGas(i)}blocksPathing(t,e,i=!1){return this.cells[t][e].blocksPathing(i)}blocksVision(t,e){return this.cells[t][e].blocksVision()}highestPriorityTile(t,e,i=!1){return this.cells[t][e].highestPriorityTile(i)}tileFlavor(t,e){return this.cells[t][e].tileFlavor()}setTile(t,e,i,s=0){return this.cell(t,e)._setTile(i,s,this)}nullifyTileWithFlags(t,e,i,s=0){this.cell(t,e).nullifyTileWithFlags(i,s)}nullifyCellLayers(t,e,i=!0,s=!0,l=!0){return this.changed(!0),this.cell(t,e).nullifyLayers(i,s,l)}fill(t,e){let i,s;for(void 0===e&&(e=t),i=0;i<this.width;++i)for(s=0;s<this.height;++s)this.isBoundaryXY(i,s)?this.setTile(i,s,e):this.setTile(i,s,t)}neighborCount(t,e,i,s=!1){let l=0;return this.eachNeighbor(t,e,((...t)=>{i(...t)&&++l}),s),l}passableArcCount(t,e){return this.hasXY(t,e)?this.cells.arcCount(t,e,(t=>t.isPassableNow())):-1}diagonalBlocked(t,e,i,s,l=!1){if(t==i||e==s)return!1;if(this.tileFlags(t,s,l)&_.T_OBSTRUCTS_DIAGONAL_MOVEMENT)return!0;return!!(this.tileFlags(i,e,l)&_.T_OBSTRUCTS_DIAGONAL_MOVEMENT)}fillCostGrid(t,i){i=i||e.utils.ONE,this.cells.forEach(((s,l,_)=>{s.isNull()?t[l][_]=e.path.OBSTRUCTION:t[l][_]=s.canBePassed()?i(s,l,_,this):e.path.OBSTRUCTION}))}matchingNeighbor(t,i,s,l=!1){const _=l?4:8;for(let l=0;l<_;++l){const _=e.utils.DIRS[l],r=t+_[0],a=i+_[1];if(this.hasXY(r,a)&&s(this.cells[r][a],r,a,this))return[r,a]}return null}matchingLocNear(t,i,...s){let l,_,r,a=s[0],T=s[1]||{};const h=s[0];"function"!=typeof h&&(T=h||s[1],a=T.match||e.utils.TRUE);const E=T.hallways||!1,n=T.blockingMap||null,S=!1===T.liquids,o=T.deterministic||!1,c=[];for(r=0;r<Math.max(this.width,this.height)&&!c.length;r++)for(l=t-r;l<=t+r;l++)for(_=i-r;_<=i+r;_++){if(!this.hasXY(l,_))continue;const s=this.cell(l,_);Math.ceil(e.utils.distanceBetween(t,i,l,_))!=r||n&&n[l][_]||!a(s,l,_,this)||S&&s.liquid||!(E||this.passableArcCount(l,_)<2)||c.push([l,_])}if(0==c.length)return[-1,-1];let A=0;return A=o?Math.floor(c.length/2):e.random.number(c.length),c[A]}randomMatchingLoc(t={}){let i,s,l;"function"==typeof t&&(t={match:t});const _=t.hallways||!1,r=t.blockingMap||null,a=!1===t.liquids,T=t.match||e.utils.TRUE,h=t.forbidCellFlags||0,E=t.forbidTileFlags||0,n=t.forbidTileMechFlags||0,S=t.tile||null;let o=t.tries||500,c=!0;for(;c&&(o--,o);)i=e.random.range(0,this.width-1),s=e.random.range(0,this.height-1),l=this.cell(i,s),r&&r[i][s]||S&&!l.hasTile(S)||a&&l.liquid||h&&l.flags&h||E&&l.hasTileFlag(E)||n&&l.hasTileMechFlag(n)||!(_||this.passableArcCount(i,s)<2)||!T(l,i,s,this)||(c=!1);return!!o&&[i,s]}addLight(t,e,i){const s={x:t,y:e,light:i,next:this.lights};return this.lights=s,this.flags&=~(h.MAP_STABLE_LIGHTS|h.MAP_STABLE_GLOW_LIGHTS),s}removeLight(t){e.utils.removeFromChain(this,"lights",t),this.flags&=~(h.MAP_STABLE_LIGHTS|h.MAP_STABLE_GLOW_LIGHTS)}eachGlowLight(t){e.utils.eachChain(this.lights,(e=>t(e.light,e.x,e.y))),this.eachCell(((e,i,s)=>{for(let l of e.tiles())l.light&&t(l.light,i,s)}))}eachDynamicLight(t){e.utils.eachChain(this._actors,(e=>{e.light&&t(e.light,e.x,e.y)}))}addFx(t,e,s){if(!this.hasXY(t,e))return!1;const l=this.cell(t,e);return l.addSprite(i.FX,s.sprite),s.x=t,s.y=e,this.redrawCell(l),!0}moveFx(t,e,s){if(!this.hasXY(t,e))return!1;const l=this.cell(t,e),_=this.cell(s.x,s.y);return _.removeSprite(s.sprite),this.redrawCell(_),l.addSprite(i.FX,s.sprite),this.redrawCell(l),s.x=t,s.y=e,!0}removeFx(t){const e=this.cell(t.x,t.y);return e.removeSprite(t.sprite),this.redrawCell(e),this.flags|=h.MAP_CHANGED,!0}actorAt(t,e){if(!this.hasXY(t,e))return null;return this.cell(t,e).actor}addActor(t,s,l){if(!this.hasXY(t,s))return!1;const _=this.cell(t,s);if(_.actor)return!1;_.actor=l,l.next=this._actors,this._actors=l;const r=l===e.data.player?i.PLAYER:i.ACTOR;_.addSprite(r,l.sprite);const T=l===e.data.player?a.HAS_PLAYER:a.HAS_MONSTER;return _.flags|=T,l.light&&(this.flags&=~h.MAP_STABLE_LIGHTS),(l.isPlayer()||_.isAnyKindOfVisible()&&l.blocksVision())&&(this.flags|=h.MAP_FOV_CHANGED),l.x=t,l.y=s,this.redrawCell(_),!0}addActorNear(t,e,i){const s=this.matchingLocNear(t,e,(t=>i.avoidsCell(t)));return!(!s||s[0]<0)&&this.addActor(s[0],s[1],i)}moveActor(t,e,i){return!!this.hasXY(t,e)&&(this.removeActor(i),this.addActor(t,e,i)?(i.light&&(this.flags&=~h.MAP_STABLE_LIGHTS),!0):(this.addActor(i.x,i.y,i),!1))}removeActor(t){if(!this.hasXY(t.x,t.y))return!1;const i=this.cell(t.x,t.y);return i.actor===t&&(i.actor=null,e.utils.removeFromChain(this,"actors",t),i.flags&=~a.HAS_ACTOR,i.removeSprite(t.sprite),t.light&&(this.flags&=~h.MAP_STABLE_LIGHTS),(t.isPlayer()||i.isAnyKindOfVisible()&&t.blocksVision())&&(this.flags|=h.MAP_FOV_CHANGED),this.redrawCell(i),!0)}deleteActorAt(t,e){const i=this.actorAt(t,e);return!!i&&(this.removeActor(i),i.delete(),!0)}itemAt(t,e){return this.cell(t,e).item}addItem(t,s,l){if(!this.hasXY(t,s))return!1;const _=this.cell(t,s);return!(_.flags&a.HAS_ITEM)&&(l.x=t,l.y=s,_.item=l,l.next=this._items,this._items=l,_.addSprite(i.ITEM,l.sprite),_.flags|=a.HAS_ITEM,l.light&&(this.flags&=~h.MAP_STABLE_LIGHTS),this.redrawCell(_),(l.isDetected()||e.config.D_ITEM_OMNISCIENCE)&&(_.flags|=a.ITEM_DETECTED),!0)}addItemNear(t,e,i){const s=this.matchingLocNear(t,e,(t=>i.forbidsCell(t)));return!(!s||s[0]<0)&&this.addItem(s[0],s[1],i)}removeItem(t){const i=t.x,s=t.y;if(!this.hasXY(i,s))return!1;const l=this.cell(i,s);return l.item===t&&(l.removeSprite(t.sprite),l.item=null,e.utils.removeFromChain(this,"items",t),t.light&&(this.flags&=~h.MAP_STABLE_LIGHTS),l.flags&=~(a.HAS_ITEM|a.ITEM_DETECTED),this.redrawCell(l),!0)}gridDisruptsPassability(t,i={}){const s=e.grid.alloc(this.width,this.height);let l=!1;const r=i.gridOffsetX||0,a=i.gridOffsetY||0,T=i.bounds||null;this.cells.forEach(((e,i,h)=>{if(T&&!T.contains(i,h))return;const E=i+r,n=h+a;if(!e.isNull())if(e.canBePassed()){if(t.hasXY(E,n)&&t[E][n])return;s[i][h]=1}else e.hasTileFlag(_.T_HAS_STAIRS)&&(t.hasXY(E,n)&&t[E][n]?l=!0:s[i][h]=1)}));let h=!0;for(let t=0;t<s.width&&!l;++t)for(let e=0;e<s.height&&!l;++e)1==s[t][e]&&(h?(s.floodFill(t,e,1,2),h=!1):l=!0);return e.grid.free(s),l}calcFov(t,i,s,l,r=0,a=_.T_OBSTRUCTS_VISION){l=l||this.width+this.height,t.fill(0);const T=this;return new e.fov.FOV({isBlocked:(e,i)=>!(t.hasXY(e,i)&&!T.hasCellFlag(e,i,r)&&!T.hasTileFlag(e,i,a)),calcRadius:(t,e)=>Math.sqrt(t**2+e**2),setVisible(e,i){t[e][i]=1},hasXY:(e,i)=>t.hasXY(e,i)}).calculate(i,s,l)}losFromTo(t,i){const s=e.utils.getLine(t.x,t.y,i.x,i.y);return!(!s||!s.length)&&!s.some((t=>this.blocksVision(t[0],t[1])))}storeMemory(t,e){this.cell(t,e).storeMemory()}storeMemories(){let t,e;for(t=0;t<this.width;++t)for(e=0;e<this.height;++e){const i=this.cell(t,e);i.flags&a.ANY_KIND_OF_VISIBLE&&this.storeMemory(t,e),i.flags&=a.PERMANENT_CELL_FLAGS,i.mechFlags&=T.PERMANENT_MECH_FLAGS}}async tick(){this.forEach((t=>t.mechFlags&=~(T.EVENT_FIRED_THIS_TURN|T.EVENT_PROTECTED)));for(let t=0;t<this.width;++t)for(let e=0;e<this.height;++e){const i=this.cells[t][e];await i.activate("tick",{map:this,x:t,y:e,cell:i,safe:!0})}Y(this)}resetEvents(){this.forEach((t=>t.mechFlags&=~(T.EVENT_FIRED_THIS_TURN|T.EVENT_PROTECTED)))}}function H(t,i,s={},l){"string"==typeof s&&(s={tile:s},l&&(s.wall=l));const _=new G(t,i,s),r=s.tile||s.floor||s.floorTile,a=s.boundary||s.wall||s.wallTile;return r&&_.fill(r,a),e.data.map||(e.data.map=_),_}function Y(t){if(t.flags&h.MAP_NO_LIQUID)return;const s=e.grid.alloc(t.width,t.height);t.forEach(((i,l,r)=>{if(i.hasTileFlag(_.T_OBSTRUCTS_LIQUID))return;let a=i.liquid,T=i.liquidVolume,h=1;t.eachNeighbor(l,r,(t=>{t.hasTileFlag(_.T_OBSTRUCTS_LIQUID)||(++h,t.liquidVolume>T&&(a=t.liquid,T=t.liquidVolume))}));let E=i.liquidVolume;if(E>10&&h>1){let e=Math.round(.2*i.liquidVolume);e>5&&(E-=e,i.liquid!=a&&i._setTile(a,E,t),e&&s.eachNeighbor(l,r,((t,i,l)=>{s[i][l]=t+e})))}s[l][r]+=E;const n=i.liquidTile;s[l][r]>0&&e.random.chance(n.dissipate,1e4)&&(s[l][r]-=1)}));let l=!1;s.forEach(((e,s,_)=>{const r=t.cell(s,_);e?(l=!0,r.liquid&&r.liquidVolume!==e&&(r.liquidVolume=e,t.redrawCell(r))):r.liquid&&(r.clearLayer(i.LIQUID),t.redrawCell(r))})),l?t.flags&=~h.MAP_NO_LIQUID:t.flags|=h.MAP_NO_LIQUID,t.changed(!0),e.grid.free(s)}e.make.map=H;var b={__proto__:null,get Flags(){return h},Map:G,make:H,getCellAppearance:function(t,i,s,l){if(l.blackOut(),!t.hasXY(i,s))return;const _=t.cell(i,s);_.isAnyKindOfVisible()&&_.flags&(a.CELL_CHANGED|a.NEEDS_REDRAW)?p(_,l):_.isRevealed()&&l.drawSprite(_.memory.mixer),_.isVisible()||(_.isRevealed()?_.isAnyKindOfVisible()||(l.bg.mix(e.colors.black,30),l.fg.mix(e.colors.black,30)):l.blackOut());let T=!1;if(_.flags&(a.IS_CURSOR|a.IS_IN_PATH)){const t=_.flags&a.IS_CURSOR?e.colors.cursorColor:e.colors.yellow;_.hasTileMechFlag(r.TM_INVERT_WHEN_HIGHLIGHTED)?e.color.swap(l.fg,l.bg):l.bg.mix(t,e.config.cursorPathIntensity||20),T=!0}T&&e.color.separate(l.fg,l.bg)},addText:function(t,s,l,_,r,a,T){for(let h of _){const _=e.canvas.makeSprite(h,r,a);t.cell(s++,l).addSprite(T||i.GROUND,_)}},updateGas:function(t){if(t.flags&h.MAP_NO_GAS)return;const s=e.grid.alloc(t.width,t.height);t.forEach(((i,l,r)=>{if(i.hasTileFlag(_.T_OBSTRUCTS_GAS))return;let a=i.gas,T=i.gasVolume,h=i.gasVolume,E=1;if(t.eachNeighbor(l,r,(t=>{t.hasTileFlag(_.T_OBSTRUCTS_GAS)||(++E,h+=t.gasVolume,t.gasVolume>T&&(a=t.gas,T=t.gasVolume))})),!h)return;const n=Math.floor(h/E);i.gas!=a&&i._setTile(a,n,t),s[l][r]+=n;const S=h-E*Math.floor(h/E);S&&e.random.number(E)<S&&(s[l][r]+=1)}));let l=!1;s.forEach(((e,s,_)=>{const r=t.cell(s,_);e?(l=!0,r.gas&&r.gasVolume!==e&&(r.gasVolume=e,t.redrawCell(r))):r.gas&&(r.clearLayer(i.GAS),t.redrawCell(r))})),l?t.flags&=~h.MAP_NO_GAS:t.flags|=h.MAP_NO_GAS,t.changed(!0),e.grid.free(s)},updateLiquid:Y};m("0",{sprite:{ch:"∅",fg:"white",bg:"black"},flags:"T_OBSTRUCTS_PASSABILITY",name:"eerie nothingness",article:"an",priority:0}),m("FLOOR",{sprite:{ch:"·",fg:[30,30,30,20,0,0,0],bg:[2,2,10,0,2,2,0]},priority:10,article:"the"}),m("DOOR",{sprite:{ch:"+",fg:[100,40,40],bg:[30,60,60]},priority:30,flags:"T_IS_DOOR, T_OBSTRUCTS_TILE_EFFECTS, T_OBSTRUCTS_ITEMS, T_OBSTRUCTS_VISION, TM_VISUALLY_DISTINCT",article:"a",activates:{enter:{tile:"DOOR_OPEN"},open:{tile:"DOOR_OPEN_ALWAYS"}}}),m("DOOR_OPEN","DOOR",{sprite:{ch:"'",fg:[100,40,40],bg:[30,60,60]},priority:40,flags:"!T_OBSTRUCTS_ITEMS, !T_OBSTRUCTS_VISION",name:"open door",article:"an",activates:{tick:{tile:"DOOR",flags:"DFF_SUPERPRIORITY, DFF_ONLY_IF_EMPTY"},enter:null,open:null,close:{tile:"DOOR",flags:"DFF_SUPERPRIORITY, DFF_ONLY_IF_EMPTY"}}}),m("DOOR_OPEN_ALWAYS","DOOR_OPEN",{activates:{tick:null,close:{tile:"DOOR",flags:"DFF_SUPERPRIORITY, DFF_ONLY_IF_EMPTY"}}}),m("BRIDGE",{sprite:{ch:"=",fg:[100,40,40]},priority:40,layer:"SURFACE",flags:"T_BRIDGE, TM_VISUALLY_DISTINCT",article:"a"}),m("UP_STAIRS",{sprite:{ch:"<",fg:[100,40,40],bg:[100,60,20]},priority:200,flags:"T_UP_STAIRS, T_STAIR_BLOCKERS, TM_VISUALLY_DISTINCT, TM_LIST_IN_SIDEBAR",name:"upward staircase",article:"an"}),m("DOWN_STAIRS",{sprite:{ch:">",fg:[100,40,40],bg:[100,60,20]},priority:200,flags:"T_DOWN_STAIRS, T_STAIR_BLOCKERS, TM_VISUALLY_DISTINCT, TM_LIST_IN_SIDEBAR",name:"downward staircase",article:"a"}),m("WALL",{sprite:{ch:"#",fg:[7,7,7,0,3,3,3],bg:[40,40,40,10,10,0,5]},priority:100,flags:"T_OBSTRUCTS_EVERYTHING",article:"a"}),m("LAKE",{sprite:{ch:"~",fg:[5,8,20,10,0,4,15,!0],bg:[10,15,41,6,5,5,5,!0]},priority:50,flags:"T_DEEP_WATER",name:"deep water",article:"the"}),t.activation=O,t.cell=V,t.map=b,t.tile=P,Object.defineProperty(t,"__esModule",{value:!0})}));
//# sourceMappingURL=gw-map.min.js.map
